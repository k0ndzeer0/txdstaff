<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TXD Staff System - Painel Completo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Paleta de cores TXD */
            --black-deep: #0B0B0C;
            --black-dark: #1A1B1D;
            --gray-dark: #2A2C2F;
            --gray-darker: #202225;
            --gray-medium: #3A3D41;
            --gray-border: #55585C;
            --gray-text: #6F7276;
            --gray-light: #9A9A9A;
            --gray-very-light: #CFCFCF;
            --white-soft: #F2F2F2;
            
            /* Cores de destaque - usando tons da paleta */
            --primary: #00A8FF;
            --accent-primary: var(--gray-very-light);
            --accent-hover: var(--white-soft);
            --success: #00ff88;
            --danger: #ff3366;
            --warning: #ffaa00;

            /* Branding / imagens (configurável via Configurações > Geral) */
            --app-bg-image: url('https://tdatgzjwcuatpqhfococ.supabase.co/storage/v1/object/public/logos/Design%20sem%20nome%20(1).jpg');
            --login-bg-image: url('https://tdatgzjwcuatpqhfococ.supabase.co/storage/v1/object/public/logos/Design%20sem%20nome%20(3).jpg');
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--black-deep);
            color: var(--white-soft);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Background com imagem */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--app-bg-image);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            z-index: -2;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(11, 11, 12, 0.75);
            z-index: -1;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: var(--black-dark);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--gray-border);
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-text);
        }

        .hidden {
            display: none !important;
        }

        /* ========== LOGIN SCREEN ========== */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background-image: var(--login-bg-image);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            position: relative;
        }
        
        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(11, 11, 12, 0.6);
            z-index: 0;
        }
        
        .login-container > * {
            position: relative;
            z-index: 1;
        }

        .login-box {
            background: rgba(26, 27, 29, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid var(--gray-border);
            border-radius: 24px;
            padding: 48px;
            max-width: 420px;
            width: 100%;
            text-align: center;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(0, 168, 255, 0.12),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-image {
            max-width: 200px;
            height: auto;
            display: block;
            margin: 0 auto 20px;
        }

        .subtitle {
            color: var(--gray-light);
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 40px;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--gray-medium);
            color: var(--white-soft);
            border: 1px solid var(--gray-border);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            background: var(--gray-border);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.4);
        }

        .btn-secondary {
            background: transparent;
            color: var(--gray-very-light);
            border: 1px solid var(--gray-border);
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: var(--gray-dark);
            border-color: var(--gray-text);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        }

        /* ========== MODALS ========== */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: rgba(26, 27, 29, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid var(--gray-border);
            border-radius: 24px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-lg {
            max-width: 900px;
        }

        .close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: var(--gray-text);
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            transition: all 0.3s ease;
        }

        .close:hover {
            background: var(--gray-medium);
            border-color: var(--gray-text);
            color: var(--white-soft);
        }

        .modal-header {
            margin-bottom: 24px;
            padding-right: 40px;
        }

        .modal-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--white-soft);
            margin-bottom: 8px;
        }

        .confidential-badge {
            background: rgba(255, 51, 102, 0.2);
            color: var(--danger);
            padding: 8px 16px;
            border-radius: 8px;
            display: inline-block;
            margin-bottom: 20px;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid rgba(255, 51, 102, 0.3);
        }

        .term-section {
            text-align: left;
            margin: 20px 0;
        }

        .term-section h4 {
            color: var(--gray-very-light);
            margin: 20px 0 12px;
            font-size: 16px;
            font-weight: 700;
        }

        .term-section p {
            line-height: 1.8;
            color: var(--gray-light);
            margin-bottom: 16px;
        }

        .term-section strong {
            color: var(--white-soft);
        }

        .highlight-danger {
            color: var(--danger);
            font-weight: 700;
        }

        /* ========== INPUTS ========== */
        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--white-soft);
            font-weight: 600;
            font-size: 14px;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 12px 16px;
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 12px;
            color: var(--white-soft);
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .input-group input:focus,
        .input-group textarea:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--gray-text);
            background: var(--gray-medium);
            box-shadow: 0 0 0 3px rgba(111, 114, 118, 0.1);
        }

        .input-group input::placeholder,
        .input-group textarea::placeholder {
            color: var(--gray-text);
        }

        .input-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* ========== DASHBOARD ========== */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .navbar {
            background: rgba(26, 27, 29, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--gray-border);
            height: 80px;
            padding: 0 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
            position: sticky;
            top: 0;
            z-index: 100;
            gap: 24px;
        }

        .navbar-logo {
            height: 44px !important;
            width: auto !important;
            display: block;
            object-fit: contain;
            flex-shrink: 0;
        }

        .nav-menu {
            display: flex;
            align-items: center;
            gap: 6px;
            list-style: none;
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: visible;
            white-space: nowrap;
            flex: 1;
            min-width: 0;
            margin: 0;
            padding: 0;
            height: 100%;
        }

        .navbar .btn {
            flex-shrink: 0;
        }

        .nav-menu::-webkit-scrollbar {
            height: 6px;
            display: none;
        }

        .nav-menu::-webkit-scrollbar-track {
            background: transparent;
        }

        .nav-menu li {
            display: flex;
            align-items: center;
            position: relative;
            height: 100%;
        }

        .nav-menu::-webkit-scrollbar-thumb {
            background: var(--gray-border);
            border-radius: 6px;
        }

        .nav-menu li a {
            color: var(--gray-light);
            text-decoration: none;
            font-weight: 500;
            padding: 0 16px;
            height: 40px;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
            line-height: 1;
        }

        .nav-menu li a:hover {
            color: var(--white-soft);
            background: var(--gray-dark);
        }

        .nav-menu li a.active {
            color: var(--white-soft);
            background: var(--gray-medium);
            border-bottom: 2px solid var(--gray-very-light);
        }

        .nav-menu > li {
            position: relative;
        }

        .navbar .btn {
            margin: 0;
            height: 40px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            flex-shrink: 0;
            width: auto;
        }

        .navbar-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .navbar-context {
            color: var(--gray-light);
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        .dev-menu-trigger,
        .stats-menu-trigger {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dev-submenu,
        .stats-submenu {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            background: rgba(26, 27, 29, 0.95);
            border: 1px solid var(--gray-border);
            border-radius: 10px;
            padding: 8px;
            display: none;
            flex-direction: column;
            gap: 6px;
            min-width: 200px;
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.35);
            z-index: 120;
        }

        /* Stats submenu precisa escapar do container com overflow-x (senão fica "invisível") */
        .stats-submenu {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 5000;
        }

        .dev-submenu a,
        .stats-submenu a {
            padding: 8px 12px;
            border-radius: 8px;
            color: var(--gray-light);
            font-size: 13px;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .dev-submenu a:hover,
        .stats-submenu a:hover {
            color: var(--white-soft);
            background: var(--gray-dark);
        }

        .dev-menu-item:hover .dev-submenu,
        .dev-menu-item.open .dev-submenu {
            display: flex;
        }

        .stats-menu-item.open .stats-submenu {
            display: flex;
        }

        .content-card {
            background: rgba(26, 27, 29, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid var(--gray-border);
            border-radius: 16px;
            padding: 32px;
            margin: 24px;
            transition: all 0.3s ease;
        }

        .content-card:hover {
            border-color: var(--gray-text);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .content-card h1 {
            color: var(--white-soft);
            margin-bottom: 12px;
            font-size: 32px;
            font-weight: 700;
        }

        .content-card p {
            color: var(--gray-light);
            margin-bottom: 24px;
        }

        .btn-modal {
            background: var(--gray-medium);
            color: var(--white-soft);
            border: 1px solid var(--gray-border);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .btn-modal:hover {
            transform: translateY(-2px);
            background: var(--gray-border);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #cc0000 100%);
        }

        .btn-danger:hover {
            box-shadow: 0 4px 16px rgba(255, 51, 102, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #00cc66 100%);
        }

        .btn-success:hover {
            box-shadow: 0 4px 16px rgba(0, 255, 136, 0.4);
        }

        /* Checkbox customizado */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--gray-dark);
            border: 1px dashed var(--gray-border);
            border-radius: 8px;
            margin: 20px 0;
        }

        .checkbox-container input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: var(--gray-text);
        }

        .checkbox-container label {
            color: var(--white-soft);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 0;
        }

        /* Kanban Styles */
        .kanban-column {
            transition: all 0.3s ease;
        }

        .kanban-column:hover {
            border-color: var(--gray-text);
        }

        .kanban-card {
            user-select: none;
        }

        .kanban-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .kanban-cards {
            transition: background-color 0.2s ease;
        }

        .kanban-cards.drag-over {
            background: rgba(111, 114, 118, 0.1);
            border-radius: 8px;
        }

        /* ========== CHAT INTERNO ========== */
        .chat-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: calc(100vh - 200px);
            max-height: 700px;
        }

        .chat-sidebar {
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 16px;
            padding: 20px;
            overflow-y: auto;
        }

        .chat-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 8px;
            border: 1px solid transparent;
        }

        .chat-list-item:hover {
            background: var(--gray-medium);
            border-color: var(--gray-border);
        }

        .chat-list-item.active {
            background: var(--gray-medium);
            border-color: var(--gray-text);
        }

        .chat-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gray-medium), var(--gray-border));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 600;
            color: var(--white-soft);
            font-size: 14px;
            margin-bottom: 2px;
        }

        .chat-last-message {
            color: var(--gray-text);
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-badge {
            background: var(--success);
            color: var(--black-deep);
            font-size: 11px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        .chat-main {
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray-border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-info h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--white-soft);
            margin-bottom: 2px;
        }

        .chat-header-status {
            font-size: 12px;
            color: var(--success);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-message {
            display: flex;
            gap: 12px;
            max-width: 70%;
        }

        .chat-message.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .chat-message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gray-medium), var(--gray-border));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }

        .chat-message-content {
            flex: 1;
        }

        .chat-message-bubble {
            background: var(--gray-medium);
            border: 1px solid var(--gray-border);
            padding: 12px 16px;
            border-radius: 16px;
            color: var(--white-soft);
            line-height: 1.5;
            word-wrap: break-word;
        }

        .chat-message.sent .chat-message-bubble {
            background: rgba(207, 207, 207, 0.15);
            border-color: rgba(207, 207, 207, 0.3);
        }

        .chat-message-time {
            font-size: 11px;
            color: var(--gray-text);
            margin-top: 4px;
            padding: 0 8px;
        }

        .chat-input-area {
            padding: 20px;
            border-top: 1px solid var(--gray-border);
            display: flex;
            gap: 12px;
        }

        .chat-input {
            flex: 1;
            background: var(--gray-medium);
            border: 1px solid var(--gray-border);
            border-radius: 12px;
            padding: 12px 16px;
            color: var(--white-soft);
            font-size: 14px;
            font-family: inherit;
            resize: none;
            max-height: 100px;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--gray-text);
        }

        .chat-send-btn {
            background: var(--gray-very-light);
            color: var(--black-deep);
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .chat-send-btn:hover {
            background: var(--white-soft);
            transform: scale(1.05);
        }

        /* ========== RANKING E ESTATÍSTICAS ========== */
        .ranking-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .ranking-card {
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .ranking-card:hover {
            border-color: var(--gray-text);
            transform: translateY(-4px);
        }

        .ranking-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .ranking-card-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--white-soft);
        }

        .ranking-card-icon {
            font-size: 24px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px;
            background: var(--gray-medium);
            border: 1px solid var(--gray-border);
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .ranking-item:hover {
            border-color: var(--gray-text);
            transform: translateX(4px);
        }

        .ranking-position {
            font-size: 18px;
            font-weight: 800;
            min-width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
        }

        .ranking-position.gold {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: var(--black-deep);
            border: none;
        }

        .ranking-position.silver {
            background: linear-gradient(135deg, #C0C0C0, #A8A8A8);
            color: var(--black-deep);
            border: none;
        }

        .ranking-position.bronze {
            background: linear-gradient(135deg, #CD7F32, #A0522D);
            color: var(--white-soft);
            border: none;
        }

        .ranking-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gray-medium), var(--gray-border));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .ranking-info {
            flex: 1;
        }

        .ranking-name {
            font-weight: 600;
            color: var(--white-soft);
            margin-bottom: 2px;
        }

        .ranking-role {
            font-size: 12px;
            color: var(--gray-text);
        }

        .ranking-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--success);
        }

        .stats-chart {
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .stats-chart-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--white-soft);
            margin-bottom: 20px;
        }

        .chart-bar {
            margin-bottom: 16px;
        }

        .chart-bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .chart-bar-name {
            color: var(--gray-light);
        }

        .chart-bar-value {
            color: var(--white-soft);
            font-weight: 600;
        }

        .chart-bar-bg {
            height: 12px;
            background: var(--gray-medium);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--gray-border);
        }

        .chart-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--gray-very-light));
            border-radius: 6px;
            transition: width 1s ease;
        }

        /* ========== SISTEMA DE COMANDOS ========== */
        .commands-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            gap: 16px;
            flex-wrap: wrap;
        }

        .commands-search-bar {
            display: flex;
            gap: 12px;
            flex: 1;
            min-width: 300px;
        }

        .command-search-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 12px;
            color: var(--white-soft);
            font-size: 14px;
        }

        .command-search-input:focus {
            outline: none;
            border-color: var(--gray-text);
        }

        .commands-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .filter-chip {
            padding: 8px 16px;
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 20px;
            color: var(--gray-light);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-chip:hover {
            background: var(--gray-medium);
            border-color: var(--gray-text);
        }

        .filter-chip.active {
            background: var(--gray-very-light);
            color: var(--black-deep);
            border-color: var(--gray-very-light);
        }

        .commands-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .command-card {
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .command-card:hover {
            border-color: var(--gray-text);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .command-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .command-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--white-soft);
            font-family: 'Courier New', monospace;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .command-category-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .category-admin {
            background: rgba(255, 51, 102, 0.2);
            color: var(--danger);
            border: 1px solid rgba(255, 51, 102, 0.3);
        }

        .category-moderacao {
            background: rgba(255, 170, 0, 0.2);
            color: var(--warning);
            border: 1px solid rgba(255, 170, 0, 0.3);
        }

        .category-utilidade {
            background: rgba(0, 255, 136, 0.2);
            color: var(--success);
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .category-jogador {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .command-description {
            color: var(--gray-light);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .command-syntax {
            background: var(--black-dark);
            border: 1px solid var(--gray-border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: var(--gray-very-light);
            position: relative;
        }

        .command-syntax-label {
            font-size: 10px;
            color: var(--gray-text);
            text-transform: uppercase;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .command-example {
            color: var(--success);
        }

        .command-permission {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--gray-medium);
            border-radius: 6px;
            font-size: 12px;
            color: var(--gray-light);
            margin-bottom: 12px;
        }

        .command-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .command-action-btn {
            flex: 1;
            padding: 8px;
            background: var(--gray-medium);
            border: 1px solid var(--gray-border);
            border-radius: 8px;
            color: var(--white-soft);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .command-action-btn:hover {
            background: var(--gray-border);
            border-color: var(--gray-text);
        }

        .command-action-btn.favorite.active {
            background: rgba(255, 170, 0, 0.2);
            border-color: var(--warning);
            color: var(--warning);
        }

        .command-stats {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--gray-border);
        }

        .command-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--gray-text);
        }

        .commands-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-text);
        }

        .commands-empty i {
            font-size: 64px;
            opacity: 0.3;
            margin-bottom: 16px;
        }

        /* ========== INTEGRAÇÃO DISCORD ========== */
        .discord-section {
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .discord-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .discord-icon {
            width: 48px;
            height: 48px;
            background: #5865F2;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .discord-title {
            flex: 1;
        }

        .discord-title h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--white-soft);
            margin-bottom: 4px;
        }

        .discord-title p {
            font-size: 13px;
            color: var(--gray-light);
        }

        .discord-status {
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .discord-status.active {
            background: rgba(0, 255, 136, 0.2);
            color: var(--success);
        }

        .discord-status.inactive {
            background: rgba(255, 51, 102, 0.2);
            color: var(--danger);
        }

        .webhook-item {
            background: var(--gray-medium);
            border: 1px solid var(--gray-border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .webhook-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .webhook-name {
            font-weight: 600;
            color: var(--white-soft);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .webhook-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--gray-border);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: var(--success);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: left 0.3s ease;
        }

        .toggle-switch.active::after {
            left: 23px;
        }

        .webhook-url {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--gray-light);
            background: var(--black-dark);
            padding: 8px 12px;
            border-radius: 8px;
            word-break: break-all;
            margin-bottom: 12px;
        }

        .webhook-actions {
            display: flex;
            gap: 8px;
        }

        .webhook-btn {
            flex: 1;
            padding: 8px 12px;
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 8px;
            color: var(--white-soft);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .webhook-btn:hover {
            background: var(--gray-border);
            border-color: var(--gray-text);
        }

        .webhook-btn.test {
            background: rgba(88, 101, 242, 0.2);
            border-color: #5865F2;
            color: #5865F2;
        }

        .webhook-btn.test:hover {
            background: rgba(88, 101, 242, 0.3);
        }

        .notification-types {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .notification-type {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--gray-medium);
            border: 1px solid var(--gray-border);
            border-radius: 10px;
        }

        .notification-type-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--gray-light);
        }

        .discord-preview {
            background: #2f3136;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            border-left: 4px solid #5865F2;
        }

        .discord-preview-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .discord-preview-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gray-very-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--black-deep);
        }

        .discord-preview-name {
            font-weight: 600;
            color: #ffffff;
            font-size: 14px;
        }

        .discord-preview-content {
            color: #dcddde;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Notificação no menu */
        .nav-menu li a {
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -8px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* ========== CHAT EM GRUPO ========== */
        .group-indicator {
            background: var(--success);
            color: var(--black-deep);
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 6px;
            margin-left: 8px;
        }

        .group-members {
            display: flex;
            align-items: center;
            gap: -8px;
            margin-left: 8px;
        }

        .group-member-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gray-medium), var(--gray-border));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            border: 2px solid var(--gray-dark);
            margin-left: -8px;
        }

        .group-member-avatar:first-child {
            margin-left: 0;
        }

        .chat-attachment {
            margin-top: 8px;
            padding: 12px;
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .attachment-icon {
            width: 40px;
            height: 40px;
            background: var(--gray-medium);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .attachment-info {
            flex: 1;
        }

        .attachment-name {
            color: var(--white-soft);
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 2px;
        }

        .attachment-size {
            color: var(--gray-text);
            font-size: 11px;
        }

        .chat-attachment-preview {
            max-width: 300px;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .chat-attachment-preview:hover {
            transform: scale(1.05);
        }

        .attachment-input-wrapper {
            position: relative;
        }

        .attachment-btn {
            background: var(--gray-medium);
            color: var(--gray-light);
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .attachment-btn:hover {
            background: var(--gray-border);
            color: var(--white-soft);
        }

        .attachment-preview-container {
            display: flex;
            gap: 8px;
            padding: 8px;
            background: var(--gray-medium);
            border-radius: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .attachment-preview-thumb {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }

        .remove-attachment-btn {
            background: var(--danger);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
        }

        /* ========== SISTEMA DE CONQUISTAS ========== */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .achievement-card {
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 16px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .achievement-card.unlocked {
            border-color: var(--success);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05), transparent);
        }

        .achievement-card.unlocked::before {
            content: '✓';
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--success);
            color: var(--black-deep);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
        }

        .achievement-card.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .achievement-icon {
            font-size: 64px;
            margin-bottom: 16px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        .achievement-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--white-soft);
            margin-bottom: 8px;
        }

        .achievement-description {
            font-size: 13px;
            color: var(--gray-light);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .achievement-progress {
            width: 100%;
            background: var(--gray-medium);
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
            margin-top: 12px;
        }

        .achievement-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--gray-very-light));
            transition: width 0.5s ease;
        }

        .achievement-progress-text {
            font-size: 11px;
            color: var(--gray-text);
            margin-top: 6px;
        }

        .achievement-reward {
            background: rgba(255, 170, 0, 0.15);
            color: var(--warning);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 12px;
        }

        .user-achievements-summary {
            display: flex;
            gap: 16px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .achievement-stat {
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 12px;
            padding: 20px;
            flex: 1;
            min-width: 200px;
            text-align: center;
        }

        .achievement-stat-value {
            font-size: 42px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--success), var(--gray-very-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .achievement-stat-label {
            color: var(--gray-light);
            font-size: 14px;
            margin-top: 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-menu {
                display: none;
            }

            .content-card {
                margin: 16px;
                padding: 24px;
            }

            .modal-content {
                padding: 24px;
                width: 95%;
            }

            .chat-container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .chat-sidebar {
                max-height: 200px;
            }

            .chat-main {
                height: 500px;
            }
        }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <img src="https://tdatgzjwcuatpqhfococ.supabase.co/storage/v1/object/public/logos/sem-fundo-txd.png" alt="TXD Staff" class="logo-image" style="max-width: 200px; height: auto; margin-bottom: 20px;">
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="input-group" style="margin-top: 0;">
                    <label>Usuário</label>
                    <input type="text" id="loginUsername" placeholder="Digite seu usuário" required>
                </div>
                <div class="input-group">
                    <label>Senha</label>
                    <input type="password" id="loginPassword" placeholder="Digite sua senha" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i>
                    Conectar
                </button>
            </form>
            <button class="btn btn-secondary" onclick="showRegister()">
                <i class="fas fa-user-plus"></i>
                Registre-se
            </button>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('registerModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> Criar Conta</h2>
            </div>
            <form id="registerForm">
                <div class="input-group">
                    <label>Usuário de Login</label>
                    <input type="text" placeholder="Ex: romanov.dev" required>
                </div>
                <div class="input-group">
                    <label>Nome de Exibição</label>
                    <input type="text" placeholder="Ex: Romanov" required>
                </div>
                <div class="input-group">
                    <label>Senha</label>
                    <input type="password" placeholder="••••••••" required>
                </div>
                <div class="input-group">
                    <label>Repetir Senha</label>
                    <input type="password" placeholder="••••••••" required>
                </div>
                <button type="button" class="btn btn-primary" onclick="showTerms()">Prosseguir</button>
            </form>
        </div>
    </div>

    <!-- Terms Modal -->
    <div id="termsModal" class="modal">
        <div class="modal-content modal-lg">
            <span class="close" onclick="closeModal('termsModal')">&times;</span>
            <div style="text-align: center; margin-bottom: 30px;">
                <span class="confidential-badge">CONFIDENCIAL</span>
                <h2 style="color: var(--white-soft); margin: 20px 0 10px;">TERMO DE CONFIDENCIALIDADE E SIGILO</h2>
                <p style="color: var(--gray-light); font-size: 14px; letter-spacing: 2px;">STAFF ACCESS</p>
            </div>

            <div class="term-section">
                <p>Este documento formaliza o acordo entre a <strong>TXD RP</strong> e o solicitante <strong>CANDIDATO</strong>. Ao prosseguir, você assume responsabilidade legal e administrativa sobre os dados acessados.</p>

                <h4>1. NATUREZA DAS INFORMAÇÕES</h4>
                <p>Todas as informações, logs, ferramentas, estratégias, dados de usuários (IP, IDs, Histórico) e discussões internas visualizadas neste painel são classificadas como <strong>ESTRITAMENTE CONFIDENCIAIS</strong>.</p>

                <h4>2. VEDAÇÃO TOTAL DE COMPARTILHAMENTO</h4>
                <p>É terminantemente proibido capturar tela (print), gravar, transmitir (stream) ou compartilhar verbalmente qualquer informação interna com jogadores, outras staffs ou terceiros. <span class="highlight-danger">A violação desta cláusula resultará em BANIMENTO PERMANENTE (Blacklist) e remoção imediata de todos os cargos.</span></p>

                <h4>3. SEGURANÇA DA CONTA</h4>
                <p>O acesso é <strong>INTRANSFERÍVEL</strong>. O titular da conta é o único responsável por qualquer ação realizada através de suas credenciais. O compartilhamento de senha caracteriza quebra de segurança grave.</p>

                <h4>4. DECLARAÇÃO DE CIÊNCIA</h4>
                <p>Declaro estar ciente de que minhas ações no painel são monitoradas e registradas (LOGS). O uso das ferramentas administrativas para benefício próprio ou de terceiros (Abuso de Poder) acarretará nas sanções máximas previstas nas regras da cidade.</p>

                <div class="checkbox-container">
                    <input type="checkbox" id="termAgree" onchange="toggleConfirmButton()">
                    <label for="termAgree">Li, compreendi e concordo integralmente com os termos deste documento oficial.</label>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button class="btn btn-secondary" onclick="closeModal('termsModal')" style="flex: 1;">RECUSAR</button>
                <button class="btn btn-primary" id="confirmTermBtn" onclick="acceptTerms()" disabled style="flex: 1;">CONFIRMAR REGISTRO</button>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <nav class="navbar">
            <img src="https://tdatgzjwcuatpqhfococ.supabase.co/storage/v1/object/public/logos/sem-fundo-txd.png" alt="TXD Staff" class="navbar-logo" style="cursor: pointer;" onclick="showSection('inicio'); return false;" title="Voltar ao início">
            <ul class="nav-menu">
                <li><a href="#" onclick="showSection('agenda'); return false;">Agenda</a></li>
                <li><a href="#" onclick="showSection('pendencias'); return false;">📋 Pendências</a></li>
                <li><a href="#" onclick="showSection('tarefas'); return false;">Tarefas</a></li>
                <li><a href="#" onclick="showSection('comandos'); return false;">Comandos</a></li>
                <li><a href="#" onclick="showSection('votacoes'); return false;">🗳️ Votações</a></li>
                <li><a href="#" onclick="showSection('estatisticas'); return false;">📊 Estatísticas</a></li>
                <li><a href="#" onclick="showSection('relatorios'); return false;">Relatórios</a></li>
                <li><a href="#" onclick="showSection('conquistas'); return false;">🏆 Conquistas</a></li>
                <li><a href="#" onclick="showSection('perfil'); return false;">👤 Perfil</a></li>
                <li><a href="#" onclick="showSection('areas'); return false;">Áreas</a></li>
                <li><a href="#" onclick="showSection('controle'); return false;">Controle</a></li>
                <li><a href="#" onclick="showSection('config'); return false;">Configurações</a></li>
            </ul>
            <div class="navbar-actions">
                <span id="navbarContextLabel" class="navbar-context hidden"></span>
                <button class="btn btn-secondary" id="notificationsNavBtn" onclick="openNotificationsModal()" title="Notificações" style="position: relative;">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge hidden" id="notificationsNavBadge">0</span>
                </button>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </nav>

        <div class="content-card" id="mainContent">
            <h1 id="sectionTitle">Bem-vindo ao Painel TXD Staff</h1>
            <p style="color: var(--gray-light);">Selecione uma opção no menu para começar.</p>
        </div>
    </div>

    <!-- DEV anchors (alvos do submenu) -->
    <section id="dev-documentacao" class="hidden"></section>
    <section id="dev-bugs" class="hidden"></section>
    <section id="dev-pendencias" class="hidden"></section>
    <section id="dev-desenvolvimento" class="hidden"></section>
    <section id="dev-melhorias" class="hidden"></section>

    <!-- Modal: Novo Evento -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('eventModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-calendar-plus"></i> <span id="eventModalTitle">Novo Evento</span></h2>
            </div>
            <form id="eventForm" onsubmit="saveEvent(event)">
                <input type="hidden" id="eventId">
                <div class="input-group">
                    <label>Tipo</label>
                    <select id="eventType" required>
                        <option value="">Selecione...</option>
                        <option value="event">Evento</option>
                        <option value="meeting">Reunião</option>
                        <option value="training">Treinamento</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Título</label>
                    <input type="text" id="eventTitle" placeholder="Ex: Reunião Geral Mensal" required>
                </div>
                <div class="input-group">
                    <label>Data e Hora</label>
                    <input type="datetime-local" id="eventDateTime" required>
                </div>
                <div class="input-group">
                    <label>Descrição</label>
                    <textarea id="eventDescription" rows="4" placeholder="Descrição do evento..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('eventModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Adicionar/Editar Comando -->
    <div id="commandModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('commandModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-terminal"></i> <span id="commandModalTitle">Novo Comando</span></h2>
            </div>
            <form id="commandForm" onsubmit="saveCommand(event)">
                <input type="hidden" id="commandId">
                <div class="input-group">
                    <label>Nome do Comando</label>
                    <input type="text" id="commandName" placeholder="Ex: /ban" required>
                </div>
                <div class="input-group">
                    <label>Categoria</label>
                    <select id="commandCategory" required>
                        <option value="">Selecione...</option>
                        <option value="admin">Administração</option>
                        <option value="moderacao">Moderação</option>
                        <option value="utilidade">Utilidade</option>
                        <option value="jogador">Jogador</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Descrição</label>
                    <textarea id="commandDescription" rows="2" placeholder="Descreva o que o comando faz..." required></textarea>
                </div>
                <div class="input-group">
                    <label>Sintaxe</label>
                    <input type="text" id="commandSyntax" placeholder="Ex: /ban [id] [motivo] [tempo]" required>
                </div>
                <div class="input-group">
                    <label>Exemplo de Uso</label>
                    <input type="text" id="commandExample" placeholder="Ex: /ban 123 Anti-RP 7d">
                </div>
                <div class="input-group">
                    <label>Permissão Necessária</label>
                    <input type="text" id="commandPermission" placeholder="Ex: admin.ban" required>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('commandModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;"><i class="fas fa-save"></i> Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Criar Grupo de Chat -->
    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('createGroupModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-users"></i> Criar Grupo de Chat</h2>
            </div>
            <form id="createGroupForm" onsubmit="saveGroup(event)">
                <div class="input-group">
                    <label>Nome do Grupo</label>
                    <input type="text" id="groupName" placeholder="Ex: Equipe de Moderação" required>
                </div>
                <div class="input-group">
                    <label>Descrição</label>
                    <textarea id="groupDescription" rows="2" placeholder="Breve descrição do grupo..."></textarea>
                </div>
                <div class="input-group">
                    <label>Membros</label>
                    <div id="groupMembersSelection" style="max-height: 200px; overflow-y: auto; padding: 12px; background: var(--gray-medium); border-radius: 8px; border: 1px solid var(--gray-border);">
                        <!-- Será preenchido dinamicamente -->
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createGroupModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;"><i class="fas fa-check"></i> Criar Grupo</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Enviar Aviso -->
    <div id="announcementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('announcementModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-bullhorn"></i> Enviar Aviso</h2>
            </div>
            <form id="announcementForm" onsubmit="saveAnnouncement(event)">
                <div class="input-group">
                    <label>Título do Aviso</label>
                    <input type="text" id="announcementTitle" placeholder="Ex: Reunião Geral Obrigatória" required>
                </div>
                <div class="input-group">
                    <label>Prioridade</label>
                    <select id="announcementPriority" required>
                        <option value="normal">Normal</option>
                        <option value="high">Alta</option>
                        <option value="urgent">Urgente</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Mensagem</label>
                    <textarea id="announcementMessage" rows="6" placeholder="Digite o conteúdo do aviso..." required></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('announcementModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Enviar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Adicionar/Editar Membro -->
    <div id="staffModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('staffModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> <span id="staffModalTitle">Adicionar Membro</span></h2>
            </div>
            <form id="staffForm" onsubmit="saveStaff(event)">
                <input type="hidden" id="staffId">
                <div class="input-group">
                    <label>Nome Completo *</label>
                    <input type="text" id="staffName" placeholder="Ex: João Silva" required>
                </div>
                <div class="input-group" id="staffLoginGroup">
                    <label>Login *</label>
                    <input type="text" id="staffLogin" placeholder="Ex: joaosilva" required>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 4px; display: block;">Usado para fazer login no sistema</small>
                </div>
                <div class="input-group" id="staffPasswordGroup">
                    <label>Senha *</label>
                    <input type="password" id="staffPassword" placeholder="Mínimo 4 caracteres" required>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 4px; display: block;">Mínimo 4 caracteres</small>
                </div>
                <div class="input-group">
                    <label>Cargo principal</label>
                    <select id="staffRole" required onchange="checkPermissions()">
                        <option value="">Selecione...</option>
                        <option value="Owner">Owner</option>
                        <option value="CEO">CEO</option>
                        <option value="COO">COO</option>
                        <option value="CMO">CMO</option>
                        <option value="CCO">CCO</option>
                        <option value="CIO">CIO</option>
                        <option value="Diretor">Diretor</option>
                        <option value="Head Staff">Head Staff</option>
                        <option value="Coordenador">Coordenador</option>
                        <option value="Admin">Admin</option>
                        <option value="Moderador">Moderador</option>
                        <option value="Suporte">Suporte</option>
                        <option value="Helper">Helper</option>
                        <option value="Dev">Dev</option>
                    </select>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 4px; display: block;">
                        Este é o cargo usado como padrão em telas/relatórios. Você pode adicionar cargos extras abaixo.
                    </small>
                </div>
                <div class="input-group">
                    <label>Cargos adicionais (opcional)</label>
                    <select id="staffExtraRoles" multiple size="6" onchange="checkPermissions()">
                        <option value="Owner">Owner</option>
                        <option value="CEO">CEO</option>
                        <option value="COO">COO</option>
                        <option value="CMO">CMO</option>
                        <option value="CCO">CCO</option>
                        <option value="CIO">CIO</option>
                        <option value="Diretor">Diretor</option>
                        <option value="Head Staff">Head Staff</option>
                        <option value="Coordenador">Coordenador</option>
                        <option value="Admin">Admin</option>
                        <option value="Moderador">Moderador</option>
                        <option value="Suporte">Suporte</option>
                        <option value="Helper">Helper</option>
                        <option value="Dev">Dev</option>
                    </select>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 6px; display: block;">
                        Dica: segure Ctrl (Windows) ou Cmd (Mac) para selecionar mais de 1.
                    </small>
                </div>
                <div class="input-group">
                    <label>Área de Responsabilidade</label>
                    <select id="staffArea" required>
                        <option value="">Selecione...</option>
                        <option value="Responsável Staff">Responsável Staff</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Creator">Creator</option>
                        <option value="Eventos">Eventos</option>
                        <option value="Peds">Peds</option>
                        <option value="Polícia">Polícia</option>
                        <option value="Ilegal">Ilegal</option>
                        <option value="Mecânica">Mecânica</option>
                        <option value="Legal">Legal</option>
                        <option value="Hospital">Hospital</option>
                        <option value="Restaurante">Restaurante</option>
                        <option value="Var">Var</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Status</label>
                    <select id="staffStatus" required>
                        <option value="Ativo">Ativo</option>
                        <option value="Ausente">Ausente</option>
                        <option value="Inativo">Inativo</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="staffEmail" placeholder="exemplo@email.com">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('staffModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Perfil do Usuário -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('profileModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-user-circle"></i> Meu Perfil</h2>
            </div>
            <form id="profileForm" onsubmit="saveProfile(event)">
                <div class="input-group">
                    <label>Nome *</label>
                    <input type="text" id="profileName" placeholder="Seu nome completo" required>
                </div>
                <div class="input-group">
                    <label>Login *</label>
                    <input type="text" id="profileLogin" placeholder="Seu login de acesso" required>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 4px; display: block;">Usado para fazer login no sistema</small>
                </div>
                <div class="input-group">
                    <label>Senha *</label>
                    <input type="password" id="profilePassword" placeholder="Mínimo 4 caracteres" required>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 4px; display: block;">Mínimo 4 caracteres</small>
                </div>
                <div class="input-group">
                    <label>ID Game</label>
                    <input type="text" id="profileGameId" placeholder="Ex: 12345">
                </div>
                <div class="input-group">
                    <label>ID Discord</label>
                    <input type="text" id="profileDiscordId" placeholder="Ex: 123456789012345678">
                </div>
                <div class="input-group">
                    <label>Área de Interesse</label>
                    <select id="profileArea">
                        <option value="">Selecione...</option>
                        <option value="Responsável Staff">Responsável Staff</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Creator">Creator</option>
                        <option value="Eventos">Eventos</option>
                        <option value="Peds">Peds</option>
                        <option value="Polícia">Polícia</option>
                        <option value="Ilegal">Ilegal</option>
                        <option value="Mecânica">Mecânica</option>
                        <option value="Legal">Legal</option>
                        <option value="Hospital">Hospital</option>
                        <option value="Restaurante">Restaurante</option>
                        <option value="Var">Var</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('profileModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Solicitar Licença -->
    <div id="licenseRequestModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('licenseRequestModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-calendar-times"></i> Solicitar Licença</h2>
            </div>
            <form id="licenseRequestForm" onsubmit="saveLicenseRequest(event)">
                <div class="input-group">
                    <label>Data de Início *</label>
                    <input type="date" id="licenseStartDate" required>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 4px; display: block;">Data em que a licença terá início</small>
                </div>
                <div class="input-group">
                    <label>Data de Término *</label>
                    <input type="date" id="licenseEndDate" required>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 4px; display: block;">Data em que a licença terminará</small>
                </div>
                <div class="input-group">
                    <label>Motivo *</label>
                    <textarea id="licenseReason" placeholder="Descreva o motivo da licença..." rows="4" required style="resize: vertical; min-height: 100px;"></textarea>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 4px; display: block;">Seja específico sobre o motivo da sua solicitação</small>
                </div>
                <div class="input-group">
                    <label>Tipo de Licença</label>
                    <select id="licenseType">
                        <option value="ferias">Férias</option>
                        <option value="medica">Licença Médica</option>
                        <option value="pessoal">Assunto Pessoal</option>
                        <option value="estudo">Estudos</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
                <div style="background: var(--gray-darker); border-radius: 8px; padding: 16px; margin: 16px 0; border: 1px solid var(--gray-border);">
                    <p style="color: var(--gray-light); font-size: 13px; margin: 0; line-height: 1.6;">
                        <i class="fas fa-info-circle" style="color: var(--primary); margin-right: 8px;"></i>
                        Sua solicitação será enviada para aprovação. Você receberá uma notificação quando houver uma resposta.
                    </p>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('licenseRequestModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-paper-plane"></i> Enviar Solicitação
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Aplicar Advertência -->
    <div id="warningModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('warningModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-triangle"></i> Aplicar Advertência</h2>
            </div>
            <form id="warningForm" onsubmit="saveWarning(event)">
                <div class="input-group">
                    <label>Usuário *</label>
                    <select id="warningUserId" required>
                        <option value="">Selecione um usuário...</option>
                    </select>
                    <input type="hidden" id="warningUserName">
                </div>
                <div class="input-group">
                    <label>Nível da Advertência *</label>
                    <select id="warningLevel" required>
                        <option value="leve">🟢 Leve - Aviso ou advertência menor</option>
                        <option value="moderada">🟡 Moderada - Infração média, requer atenção</option>
                        <option value="grave">🔴 Grave - Infração séria, medidas disciplinares</option>
                    </select>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 4px; display: block;">
                        Escolha o nível apropriado baseado na gravidade da infração
                    </small>
                </div>
                <div class="input-group">
                    <label>Motivo *</label>
                    <input type="text" id="warningReason" placeholder="Ex: Descumprimento de regras, comportamento inadequado..." required>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 4px; display: block;">
                        Motivo resumido da advertência
                    </small>
                </div>
                <div class="input-group">
                    <label>Descrição Detalhada</label>
                    <textarea id="warningDescription" placeholder="Descreva detalhadamente o ocorrido, contexto e evidências..." rows="5" style="resize: vertical;"></textarea>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 4px; display: block;">
                        Detalhes adicionais sobre a infração (opcional)
                    </small>
                </div>
                <div class="input-group">
                    <label>Data de Expiração (Opcional)</label>
                    <input type="date" id="warningExpiresAt">
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 4px; display: block;">
                        Se deixado em branco, a advertência permanecerá ativa indefinidamente
                    </small>
                </div>
                <div style="background: var(--gray-darker); border-radius: 8px; padding: 16px; margin: 16px 0; border: 1px solid var(--gray-border);">
                    <p style="color: var(--gray-light); font-size: 13px; margin: 0; line-height: 1.6;">
                        <i class="fas fa-info-circle" style="color: var(--primary); margin-right: 8px;"></i>
                        A advertência será registrada no histórico do usuário e poderá ser visualizada por administradores. Advertências graves podem resultar em ações disciplinares.
                    </p>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('warningModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-danger" style="flex: 1;">
                        <i class="fas fa-exclamation-triangle"></i> Aplicar Advertência
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Nova/Editar Pendência -->
    <div id="pendencyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('pendencyModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-clipboard-list"></i> <span id="pendencyModalTitle">Nova Solicitação de Pendência</span></h2>
            </div>
            <form id="pendencyForm" onsubmit="savePendency(event)">
                <input type="hidden" id="pendencyId">
                <div class="input-group">
                    <label>Título *</label>
                    <input type="text" id="pendencyTitle" placeholder="Ex: Solicitação de reembolso" required>
                </div>
                <div class="input-group">
                    <label>Tipo *</label>
                    <select id="pendencyType" required onchange="handlePendencyTypeChange()">
                        <option value="">Selecione...</option>
                        <option value="desenvolvimento">Desenvolvimento</option>
                        <option value="doacoes">Doações</option>
                    </select>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 4px; display: block;">
                        Se selecionar "Desenvolvimento", você poderá escolher o tipo técnico. Doações são financeiras (somente C-Level).
                    </small>
                </div>
                <div class="input-group">
                    <label>Destino *</label>
                    <select id="pendencyDestination" required onchange="handlePendencyDestinationChange()">
                        <option value="geral">Geral</option>
                        <option value="dev">DEV</option>
                        <option value="clevel">C-Level</option>
                    </select>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 4px; display: block;">
                        Define quem deve tratar esta pendência. Doações devem ir para C-Level.
                    </small>
                </div>
                <div class="input-group hidden" id="pendencyAssigneeGroup">
                    <label>Atribuir para (opcional)</label>
                    <select id="pendencyAssignee">
                        <option value="">Sem responsável</option>
                    </select>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 6px; display: block;">
                        A lista é filtrada automaticamente por destino (DEV/C-Level).
                    </small>
                </div>
                <div class="input-group hidden" id="pendencyDevTypeGroup">
                    <label>Tipo de Desenvolvimento *</label>
                    <select id="pendencyDevType">
                        <option value="">Selecione o tipo...</option>
                        <option value="bugs">Bugs</option>
                        <option value="mapas">Mapas</option>
                        <option value="carros">Carros</option>
                        <option value="roupas">Roupas</option>
                        <option value="itens">Itens</option>
                        <option value="coordenadas">Coordenadas</option>
                        <option value="logs">Logs</option>
                        <option value="atualizacoes">Atualizações</option>
                    </select>
                </div>
                <div class="input-group hidden" id="pendencyDonationItemGroup">
                    <label>Item da Doação *</label>
                    <select id="pendencyDonationItem" onchange="handleDonationItemChange()">
                        <option value="">Selecione o item...</option>
                        <option value="vip">VIP</option>
                        <option value="coins">Coins</option>
                        <option value="veiculo">Veículo</option>
                        <option value="casa">Casa</option>
                        <option value="item_exclusivo">Item Exclusivo</option>
                        <option value="pack">Pacote</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
                <div class="input-group hidden" id="pendencyDonationItemOtherGroup">
                    <label>Qual item? *</label>
                    <input type="text" id="pendencyDonationItemOther" placeholder="Descreva o item de doação">
                </div>
                <div class="input-group">
                    <label>Prioridade *</label>
                    <select id="pendencyPriority" required>
                        <option value="low">🟢 Baixa</option>
                        <option value="medium" selected>🟡 Média</option>
                        <option value="high">🟠 Alta</option>
                        <option value="urgent">🔴 Urgente</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Descrição Detalhada *</label>
                    <textarea id="pendencyDescription" rows="6" placeholder="Descreva detalhadamente a pendência que precisa ser resolvida..." required></textarea>
                </div>
                <div class="input-group">
                    <label>Data Limite (Opcional)</label>
                    <input type="date" id="pendencyDueDate">
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 4px; display: block;">
                        Data limite para resolução desta pendência
                    </small>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('pendencyModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Detalhes da Pendência -->
    <div id="pendencyDetailsModal" class="modal">
        <div class="modal-content modal-lg">
            <span class="close" onclick="closeModal('pendencyDetailsModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-clipboard-list"></i> Detalhes da Pendência</h2>
            </div>
            <div id="pendencyDetailsContent">
                <!-- Conteúdo será preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal: Confirmar Exclusão -->
    <div id="deleteModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-triangle"></i> Confirmar Exclusão</h2>
            </div>
            <p style="color: var(--gray-light); margin-bottom: 24px;" id="deleteMessage"></p>
            <div style="display: flex; gap: 10px;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('deleteModal')" style="flex: 1;">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()" style="flex: 1;">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal: Notificações -->
    <div id="notificationsModal" class="modal">
        <div class="modal-content modal-lg">
            <span class="close" onclick="closeModal('notificationsModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-bell"></i> Notificações</h2>
            </div>

            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 14px;">
                <button class="btn btn-secondary" type="button" onclick="setNotificationsFilter('unread')" id="notifFilterUnread" style="width: auto; padding: 10px 14px;">Não lidas</button>
                <button class="btn btn-secondary" type="button" onclick="setNotificationsFilter('all')" id="notifFilterAll" style="width: auto; padding: 10px 14px;">Todas</button>
                <div style="flex: 1;"></div>
                <button class="btn btn-primary" type="button" onclick="markAllNotificationsRead()" style="width: auto; padding: 10px 14px;">
                    <i class="fas fa-check-double"></i> Marcar tudo lido
                </button>
            </div>

            <div id="notificationsStatus" style="color: var(--gray-text); font-size: 12px; margin-bottom: 10px;"></div>
            <div id="notificationsList" style="display: flex; flex-direction: column; gap: 10px;"></div>
        </div>
    </div>

    <!-- Modal: Nova/Editar Card Kanban -->
    <div id="cardModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('cardModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-sticky-note"></i> <span id="cardModalTitle">Nova Tarefa</span></h2>
            </div>
            <form id="cardForm" onsubmit="saveCard(event)">
                <input type="hidden" id="cardId">
                <input type="hidden" id="cardColumnId">
                <div class="input-group">
                    <label>Título da Tarefa</label>
                    <input type="text" id="cardTitle" placeholder="Ex: Implementar sistema de login" required>
                </div>
                <div class="input-group">
                    <label>Descrição</label>
                    <textarea id="cardDescription" rows="4" placeholder="Descreva os detalhes da tarefa..."></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="input-group">
                        <label>Prioridade</label>
                        <select id="cardPriority">
                            <option value="">Sem prioridade</option>
                            <option value="low">Baixa</option>
                            <option value="medium">Média</option>
                            <option value="high">Alta</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Data de Vencimento</label>
                        <input type="date" id="cardDueDate">
                    </div>
                </div>
                <div class="input-group">
                    <label>Responsáveis</label>
                    <select id="cardAssignee" multiple size="4">
                        <option value="">Sem responsável</option>
                    </select>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 6px; display: block;">Dica: segure Ctrl (Windows) ou Cmd (Mac) para selecionar mais de 1.</small>
                </div>
                <div class="input-group">
                    <label>Tags (separadas por vírgula)</label>
                    <input type="text" id="cardTags" placeholder="Ex: urgente, frontend, bug">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('cardModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Criar/Editar Votação -->
    <div id="pollModal" class="modal">
        <div class="modal-content modal-lg">
            <span class="close" onclick="closeModal('pollModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-chart-bar"></i> <span id="pollModalTitle">Nova Votação</span></h2>
            </div>
            <form id="pollForm" onsubmit="savePoll(event)">
                <input type="hidden" id="pollId">

                <div class="input-group">
                    <label>Título *</label>
                    <input type="text" id="pollTitle" placeholder="Ex: Alterar horário da reunião semanal?" required>
                </div>

                <div class="input-group">
                    <label>Descrição</label>
                    <textarea id="pollDescription" rows="3" placeholder="Detalhes (opcional)..."></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="input-group">
                        <label>Encerrar em (opcional)</label>
                        <input type="datetime-local" id="pollEndsAt">
                        <small style="color: var(--gray-text); font-size: 12px; margin-top: 6px; display: block;">Se vazio, a votação fica aberta até ser encerrada manualmente.</small>
                    </div>
                    <div class="input-group">
                        <label>Status</label>
                        <select id="pollStatus">
                            <option value="open">Aberta</option>
                            <option value="closed">Encerrada</option>
                        </select>
                    </div>
                </div>

                <div class="input-group">
                    <label>Quem pode votar? *</label>
                    <div id="pollAllowedRoles" style="padding: 12px; background: var(--gray-medium); border: 1px solid var(--gray-border); border-radius: 12px; max-height: 220px; overflow: auto;"></div>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 6px; display: block;">Se não marcar nenhum cargo, todos os cargos poderão votar.</small>
                </div>

                <div class="input-group">
                    <label>Opções *</label>
                    <div id="pollOptionsList" style="display: flex; flex-direction: column; gap: 10px;"></div>
                    <button type="button" class="btn btn-secondary" onclick="addPollOptionRow()" style="width: auto; padding: 10px 14px; margin-top: 10px;">
                        <i class="fas fa-plus"></i> Adicionar opção
                    </button>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('pollModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-save"></i> Salvar Votação
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Cargos & Permissões -->
    <div id="roleModal" class="modal">
        <div class="modal-content modal-lg">
            <span class="close" onclick="closeModal('roleModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-users-cog"></i> <span id="roleModalTitle">Cargo</span></h2>
            </div>
            <form id="roleForm" onsubmit="saveRoleFromModal(event)">
                <input type="hidden" id="roleModalMode" value="create">
                <input type="hidden" id="roleModalOriginalName" value="">

                <div class="input-group">
                    <label>Nome do Cargo</label>
                    <input type="text" id="roleNameInput" placeholder="Ex: Supervisor" required>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 6px; display:block;">
                        Dica: evite nomes duplicados. Owner/CEO não podem ser alterados.
                    </small>
                </div>

                <div style="background: var(--gray-darker); border-radius: 12px; padding: 16px; border: 1px solid var(--gray-border); margin-bottom: 16px;">
                    <label style="display:flex; align-items:center; gap: 12px; cursor:pointer;">
                        <input type="checkbox" id="permAllToggle" onchange="toggleAllPermissions(this.checked)" style="width: 18px; height: 18px;">
                        <span style="color: var(--white-soft); font-weight: 700;">Acesso total (`*`)</span>
                    </label>
                    <p style="color: var(--gray-text); font-size: 12px; margin: 8px 0 0 30px;">
                        Se marcado, o cargo terá acesso total ao sistema.
                    </p>
                </div>

                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px;" id="permissionsGrid">
                    <!-- preenchido via JS -->
                </div>

                <div style="display:flex; gap: 10px; margin-top: 18px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('roleModal')" style="flex:1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex:1;"><i class="fas fa-save"></i> Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========== CONFIGURAÇÃO SUPABASE ==========
        const SUPABASE_URL = (window.SUPABASE_URL || 'https://tdatgzjwcuatpqhfococ.supabase.co');
        const SUPABASE_ANON_KEY = (window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkYXRnemp3Y3VhdHBxaGZvY29jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNDAzMjUsImV4cCI6MjA4MzkxNjMyNX0.0UujT6QJNDesCWL67GoX-mOLcNf1YIucz8vvxt_gcMg');
        
        // Inicializar Supabase
        // O CDN do Supabase expõe através de window.supabase ou supabase globalmente
        let supabaseClient;
        if (typeof window !== 'undefined' && window.supabase) {
            // CDN expõe via window.supabase
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } else if (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function') {
            // CDN expõe diretamente como supabase
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } else {
            console.error('Supabase não está carregado. Verifique se o script foi incluído corretamente.');
        }
        
        // Cache local para performance com timestamp
        const dataCache = {};
        const cacheTimestamps = {}; // Armazena quando cada dado foi cacheado
        const CACHE_TTL = 30000; // 30 segundos - tempo de vida do cache
        let cacheInitialized = false;
        let realtimeInitialized = false;
        let backupHistoryMemory = [];

        // Debug/logs (deixe false para melhorar performance)
        const DEBUG = false;
        function debugLog(...args) { if (DEBUG) console.log(...args); }
        function debugWarn(...args) { if (DEBUG) console.warn(...args); }

        // Sequência de navegação para evitar renderizações atrasadas
        let activeNavSeq = 0;
        function bumpNavSeq() { activeNavSeq += 1; return activeNavSeq; }
        function nextFrame() {
            return new Promise(resolve => {
                try { requestAnimationFrame(() => resolve()); } catch (e) { setTimeout(resolve, 0); }
            });
        }
        function renderSectionLoading(title = 'Carregando...') {
            const card = document.querySelector('.content-card');
            if (!card) return;
            card.innerHTML = `
                <h1 id="sectionTitle">${escapeHtml(title)}</h1>
                <div style="margin-top: 14px; color: var(--gray-text); font-size: 14px;">
                    <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>
                    Carregando dados…
                </div>
            `;
        }
        const backgroundRefreshInFlight = new Set();
        
        // Função helper para limpar cache e timestamp
        function clearCacheKey(key) {
            delete dataCache[key];
            delete cacheTimestamps[key];
        }
        
        // Função para atualizar dados em background (stale-while-revalidate)
        async function refreshDataInBackground(key) {
            const k = String(key || '').trim();
            if (!k) return;
            if (backgroundRefreshInFlight.has(k)) return;
            backgroundRefreshInFlight.add(k);
            try {
                const tableName = keyToTableMap[key];
                if (!tableName || !supabaseClient) return;

                // Buscar dados atualizados do Supabase em background
                let data = [];

                // Usar a mesma lógica do getData, mas sem retornar (só atualiza cache)
                switch(key) {
                    case 'txd_staff':
                        const { data: staffData, error: staffError } = await supabaseClient
                            .from('staff')
                            .select('*')
                            .order('created_at', { ascending: false });
                        if (!staffError) data = toCamelCase(staffData || []);
                        break;
                    case 'txd_kanban':
                        // Evitar query na tabela "kanban" (não existe); reutilizar getData com forceRefresh
                        data = await getData('txd_kanban', true);
                        break;
                    default:
                        // Para outros casos, usar query genérica
                        const { data: genericData, error: genericError } = await supabaseClient
                            .from(tableName)
                            .select('*');
                        if (!genericError) data = toCamelCase(genericData || []);
                        break;
                }
                
                // Atualizar cache silenciosamente
                if (data.length > 0 || Array.isArray(data)) {
                    dataCache[key] = data;
                    cacheTimestamps[key] = Date.now();
                }
            } catch (error) {
                // Ignorar erros em background
                console.warn(`Erro ao atualizar ${key} em background:`, error);
            } finally {
                backgroundRefreshInFlight.delete(k);
            }
        }
        
        // Subscriptions de real-time
        let realtimeSubscriptions = [];
        const realtimeChannelsByName = new Map();

        // State único em memória (fonte de verdade para renderização)
        const state = {
            kanban: {
                initialized: false,
                columnsById: new Map(),
                cardsById: new Map(),
                assigneesByCardId: new Map()
            },
            pendencies: {
                initialized: false,
                byId: new Map()
            }
        };

        // Locks simples para idempotência (double-click, múltiplos submits)
        const inflightOps = new Set();

        function upsertItem(map, item) {
            if (!map || !item) return;
            const id = item.id;
            if (id === undefined || id === null || id === '') return;
            const key = String(id);
            const existing = map.get(key);
            map.set(key, existing ? { ...existing, ...item } : item);
        }

        function removeItem(map, id) {
            if (!map) return;
            if (id === undefined || id === null || id === '') return;
            map.delete(String(id));
        }

        function withIdempotency(opKey, fn) {
            const key = String(opKey || '');
            if (!key) return fn();
            if (inflightOps.has(key)) {
                console.warn('[idempotency] Operação ignorada (já em andamento):', key);
                return;
            }
            inflightOps.add(key);
            const finalize = () => inflightOps.delete(key);
            try {
                const result = fn();
                if (result && typeof result.then === 'function') {
                    return result.finally(finalize);
                }
                finalize();
                return result;
            } catch (err) {
                finalize();
                throw err;
            }
        }

        function subscribeRealtimeOnce(name, createChannelFn) {
            if (!supabaseClient) return null;
            const channelName = String(name || '').trim();
            if (!channelName) return null;
            if (realtimeChannelsByName.has(channelName)) {
                return realtimeChannelsByName.get(channelName);
            }
            const channel = createChannelFn();
            if (!channel) return null;
            realtimeChannelsByName.set(channelName, channel);
            realtimeSubscriptions.push(channel);
            return channel;
        }

        function resetRealtimeSubscriptions() {
            realtimeSubscriptions.forEach(sub => {
                try {
                    supabaseClient.removeChannel(sub);
                } catch (e) {
                    console.warn('Erro ao remover subscription:', e);
                }
            });
            realtimeSubscriptions = [];
            realtimeChannelsByName.clear();
        }

        // Invalidação + refresh por chave (para UI atualizar sem precisar recarregar a página)
        const realtimeRefreshTimers = new Map();

        async function refreshGlobalsForKey(key) {
            const k = String(key || '');
            if (!k) return;
            try {
                let data;

                // Preferir state em memória quando disponível (evita hits repetidos no banco em mudanças realtime)
                if (k === 'txd_pendencies' && state?.pendencies?.initialized) {
                    data = Array.from(state.pendencies.byId.values());
                    dataCache[k] = data;
                    cacheTimestamps[k] = Date.now();
                } else if (k === 'txd_kanban' && state?.kanban?.initialized) {
                    data = getKanbanSnapshotFromState();
                    dataCache[k] = data;
                    cacheTimestamps[k] = Date.now();
                } else {
                    data = await getData(k, true);
                }

                switch (k) {
                    case 'txd_staff':
                        staffData = Array.isArray(data) ? data : [];
                        break;
                    case 'txd_events':
                        eventsData = Array.isArray(data) ? data : [];
                        break;
                    case 'txd_announcements':
                        announcementsData = Array.isArray(data) ? data : [];
                        break;
                    case 'txd_chat_messages':
                        chatMessages = Array.isArray(data) ? data : [];
                        break;
                    case 'txd_chat_groups':
                        chatGroups = Array.isArray(data) ? data : [];
                        break;
                    case 'txd_commands':
                        commandsData = Array.isArray(data) ? data : [];
                        break;
                    case 'txd_favorite_commands':
                        favoriteCommands = Array.isArray(data) ? data : [];
                        break;
                    case 'txd_command_usage':
                        commandUsageStats = data || {};
                        break;
                    case 'txd_discord_config':
                        discordConfig = data || getDiscordConfig();
                        break;
                }
            } catch (e) {
                console.warn('[realtime] falha ao atualizar globals para', k, e);
            }
        }

        function scheduleSectionRefreshForKey(key, debounceMs = 250) {
            const k = String(key || '');
            if (!k) return;

            const sec = String(currentSection || '');
            const neededKeys = sectionDataMap?.[sec] || [];
            if (!Array.isArray(neededKeys) || !neededKeys.includes(k)) return;

            const timerKey = `${sec}:${k}`;
            if (realtimeRefreshTimers.has(timerKey)) {
                clearTimeout(realtimeRefreshTimers.get(timerKey));
            }

            realtimeRefreshTimers.set(timerKey, setTimeout(async () => {
                try {
                    await refreshGlobalsForKey(k);
                } finally {
                    try {
                        loadSectionContent(sec);
                    } catch (e) {
                        console.warn('[realtime] erro ao recarregar seção', sec, e);
                    }
                }
            }, debounceMs));
        }

        function invalidateKeyAndRefreshSection(key, debounceMs = 250) {
            const k = String(key || '');
            if (!k) return;
            clearCacheKey(k);
            scheduleSectionRefreshForKey(k, debounceMs);
        }

        function normalizePendencyRow(row) {
            const p = toCamelCase(row || {});
            // Derivar destino/area de forma compatível (coluna `area` OU metadata em attachments)
            const meta = p.attachments && typeof p.attachments === 'object' ? (p.attachments._meta || p.attachments.meta || null) : null;
            const area = (p.area || p.destination || meta?.destination || '').toString().toLowerCase().trim();
            const assignedRole = (p.assignedRole || p.assigned_role || meta?.assignedRole || '').toString().toLowerCase().trim();
            const assignedUserId = p.assignedUserId || p.assigned_user_id || meta?.assignedUserId || null;
            const assignedUserName = p.assignedUserName || p.assigned_user_name || meta?.assignedUserName || meta?.assigned_user_name || meta?.assignedUser || null;
            return {
                ...p,
                area: area || null,
                assignedRole: assignedRole || null,
                assignedUserId: assignedUserId || null,
                assignedUserName: assignedUserName || null
            };
        }

        function normalizePendencyStatusValue(statusValue, pendency) {
            const completedAt = pendency?.completedAt ?? pendency?.completed_at ?? null;
            const raw = (statusValue ?? pendency?.status ?? '').toString().trim().toLowerCase();

            // Rejeitada sempre prevalece
            if (raw === 'rejected' || raw === 'rejeitada' || raw === 'rejeitado') return 'rejected';

            // Se já possui completed_at, tratar como concluída (mesmo se status antigo estiver errado)
            if (completedAt) return 'completed';

            if (!raw) return 'pending';
            if (raw === 'pending' || raw === 'pendente') return 'pending';
            if (raw === 'in_progress' || raw === 'in progress' || raw === 'em andamento' || raw === 'andamento') return 'in_progress';
            if (raw === 'approved' || raw === 'aprovada' || raw === 'aprovado') return 'approved';
            if (raw === 'completed' || raw === 'concluida' || raw === 'concluída') return 'completed';

            return raw;
        }

        function inferPendencyAreaFromType(type) {
            const scope = getPendencyScope(type);
            if (scope === 'financial') return 'clevel';
            if (scope === 'dev') return 'dev';
            return 'geral';
        }

        function getEffectivePendencyArea(pendency) {
            const explicit = (pendency?.area || '').toString().toLowerCase().trim();
            if (explicit) return explicit;
            const meta = pendency?.attachments && typeof pendency.attachments === 'object'
                ? (pendency.attachments._meta || pendency.attachments.meta || null)
                : null;
            const metaDest = (meta?.destination || '').toString().toLowerCase().trim();
            if (metaDest) return metaDest;
            return inferPendencyAreaFromType(pendency?.type);
        }

        async function ensurePendenciesLoaded(force = false) {
            if (state.pendencies.initialized && !force) return;
            if (!supabaseClient) {
                console.warn('[pendencies] Supabase indisponível; não foi possível carregar.');
                state.pendencies.initialized = true;
                return;
            }
            try {
                const { data, error } = await supabaseClient
                    .from('pendencies')
                    .select('*')
                    .order('created_at', { ascending: false });
                if (error) {
                    console.error('[pendencies] Erro ao carregar:', error);
                    throw error;
                }
                state.pendencies.byId.clear();
                (data || []).forEach(row => {
                    const normalized = normalizePendencyRow(row);
                    upsertItem(state.pendencies.byId, normalized);
                });
                state.pendencies.initialized = true;
                console.log('[pendencies] State inicializado:', state.pendencies.byId.size);
            } catch (err) {
                console.error('[pendencies] Falha ao inicializar state:', err);
                state.pendencies.initialized = true;
            }
        }

        async function ensureKanbanLoaded(force = false) {
            if (state.kanban.initialized && !force) return;
            try {
                const kanbanData = await getKanbanData();
                state.kanban.columnsById.clear();
                state.kanban.cardsById.clear();
                state.kanban.assigneesByCardId.clear();

                const columns = Array.isArray(kanbanData?.columns) ? kanbanData.columns : [];
                const cards = Array.isArray(kanbanData?.cards) ? kanbanData.cards : [];

                columns.forEach(col => {
                    if (!col || col.id === undefined || col.id === null) return;
                    upsertItem(state.kanban.columnsById, { ...col, id: String(col.id) });
                });

                cards.forEach(card => {
                    if (!card || card.id === undefined || card.id === null) return;
                    const normalizedCard = {
                        ...card,
                        id: Number(card.id),
                        columnId: card.columnId || card.column_id || 'todo',
                        assignees: Array.isArray(card.assignees) ? card.assignees : (card.assignee ? [card.assignee] : [])
                    };
                    upsertItem(state.kanban.cardsById, normalizedCard);
                    state.kanban.assigneesByCardId.set(String(normalizedCard.id), normalizedCard.assignees || []);
                });

                state.kanban.initialized = true;
                console.log('[kanban] State inicializado:', {
                    columns: state.kanban.columnsById.size,
                    cards: state.kanban.cardsById.size
                });
            } catch (err) {
                console.error('[kanban] Falha ao inicializar state:', err);
                state.kanban.initialized = true;
            }
        }

        function getKanbanSnapshotFromState() {
            const columns = Array.from(state.kanban.columnsById.values())
                .sort((a, b) => (a.position ?? 0) - (b.position ?? 0));
            const cards = Array.from(state.kanban.cardsById.values())
                .sort((a, b) => {
                    const aTime = new Date(a.createdAt || a.created_at || 0).getTime();
                    const bTime = new Date(b.createdAt || b.created_at || 0).getTime();
                    return bTime - aTime;
                })
                .map(card => {
                    const assignees = state.kanban.assigneesByCardId.get(String(card.id));
                    return {
                        ...card,
                        assignees: Array.isArray(assignees) ? assignees : (Array.isArray(card.assignees) ? card.assignees : [])
                    };
                });
            return { columns, cards };
        }

        // Renderizações derivadas do state (sem duplicar)
        function renderPendencias() {
            if (currentSection === 'dev_backlog') {
                loadDevBacklog().catch(err => console.error('[dev_backlog] Erro ao renderizar pendências:', err));
                return;
            }
            if (currentSection !== 'pendencias' && currentSection !== 'formularios') return;
            loadPendencies().catch(err => console.error('[pendencies] Erro ao renderizar:', err));
        }

        function renderTarefas() {
            if (currentSection !== 'tarefas') return;
            loadKanban().catch(err => console.error('[kanban] Erro ao renderizar:', err));
        }
        
        // Função para inicializar real-time
        function initializeRealtime() {
            if (!supabaseClient) {
                console.warn('Supabase não inicializado. Real-time não disponível.');
                return;
            }
            
            // Limpar subscriptions antigas
            resetRealtimeSubscriptions();

            const subscribeKeyInvalidation = (channelName, tableName, key, debounceMs = 450) => {
                return subscribeRealtimeOnce(channelName, () => supabaseClient
                    .channel(channelName)
                    .on('postgres_changes',
                        { event: '*', schema: 'public', table: tableName },
                        () => {
                            invalidateKeyAndRefreshSection(key, debounceMs);
                        }
                    )
                    .subscribe());
            };
            
            // Subscription para registration_requests
            subscribeRealtimeOnce('registration_requests_changes', () => supabaseClient
                .channel('registration_requests_changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'registration_requests' },
                    (payload) => {
                        console.log('Mudança em registration_requests:', payload);
                        invalidateKeyAndRefreshSection('txd_registration_requests', 600);
                    }
                )
                .subscribe());

            // Subscription para pendencies (CRUD em tempo real, sem recarregar página)
            subscribeRealtimeOnce('pendencies_changes', () => supabaseClient
                .channel('pendencies_changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'pendencies' },
                    (payload) => {
                        try {
                            console.log('[pendencies][realtime]', payload);
                            if (payload.eventType === 'DELETE') {
                                const id = payload.old?.id;
                                removeItem(state.pendencies.byId, id);
                            } else {
                                const normalized = normalizePendencyRow(payload.new);
                                upsertItem(state.pendencies.byId, normalized);
                            }

                            // Atualiza cache em memória (para ranking/conquistas) e só recarrega UI quando necessário
                            refreshGlobalsForKey('txd_pendencies').catch(() => {});
                            renderPendencias();

                            // Notificações in-app (toasts + badge)
                            // Se o inbox persistente estiver ativo, evitamos duplicar alertas aqui.
                            if (notificationsSupported !== true) try {
                                const evt = payload.eventType;
                                const row = payload.new || payload.old || {};
                                const pid = row.id;
                                const userId = row.user_id ?? row.userId;
                                const normalizedRow = normalizePendencyRow(row);
                                const destination = getEffectivePendencyArea(normalizedRow);

                                // Nova pendência criada (para DEV/C-Level conforme escopo)
                                if (evt === 'INSERT') {
                                    const createdByMe = isCurrentUserId(userId);
                                    if (!createdByMe) {
                                        const canSee = destination === 'dev'
                                            ? isDevRole(currentUser?.roles || currentUser?.role)
                                            : (destination === 'clevel' ? isCLevelRole(currentUser?.roles || currentUser?.role) : true);
                                        if (canSee) {
                                            showToast({
                                                title: '📋 Nova pendência criada',
                                                message: `#${pid || '?'} • ${row.title || 'Sem título'}`,
                                                variant: 'info'
                                            });
                                            bumpSectionBadge('pendencias', 1);
                                        }
                                    }
                                }

                                // Alteração na sua pendência
                                if (evt === 'UPDATE') {
                                    const isMine = isCurrentUserId(userId);
                                    const changedByMe = isCurrentUserName(row.approved_by) || isCurrentUserName(row.approvedBy);
                                    if (isMine && !changedByMe) {
                                        showToast({
                                            title: '✏️ Alteração na sua pendência',
                                            message: `#${pid || '?'} • ${row.title || 'Sem título'}`,
                                            variant: 'warning'
                                        });
                                        bumpSectionBadge('pendencias', 1);
                                    }
                                }
                            } catch (e) {}

                            if (currentSection !== 'pendencias' && currentSection !== 'formularios') {
                                scheduleSectionRefreshForKey('txd_pendencies', 800);
                            }
                        } catch (err) {
                            console.error('[pendencies][realtime] erro:', err, payload);
                        }
                    }
                )
                .subscribe());

            // Subscription para mensagens do chat de pendências (notificar fora do modal)
            subscribeRealtimeOnce('pendency_messages_changes', () => supabaseClient
                .channel('pendency_messages_changes')
                .on('postgres_changes',
                    { event: 'INSERT', schema: 'public', table: 'pendency_messages' },
                    async (payload) => {
                        try {
                            if (notificationsSupported === true) return;
                            const row = payload.new || {};
                            const pendencyId = row.pendency_id ?? row.pendencyId;
                            const senderId = row.sender_id ?? row.senderId;

                            if (!pendencyId) return;
                            if (isCurrentUserId(senderId)) return; // ignora mensagens enviadas por mim

                            if (!state.pendencies.initialized) {
                                await ensurePendenciesLoaded(false);
                            }

                            const pendency = state.pendencies.byId.get(String(pendencyId));
                            if (!pendency) return;

                            const requesterId = pendency.userId ?? pendency.user_id ?? null;
                            const handlerId = pendency?.assignedUserId ?? pendency?.assigned_user_id ?? null;
                            if (!handlerId) return; // sem responsável definido, não notificar

                            const amRequester = isCurrentUserId(requesterId);
                            const amHandler = isCurrentUserId(handlerId);
                            if (!amRequester && !amHandler) return;

                            // Notifica apenas quando a outra pessoa do "par" enviou a mensagem
                            const senderStr = (senderId === undefined || senderId === null) ? '' : String(senderId).trim();
                            if (amRequester && !isSameUserId(senderStr, handlerId)) return;
                            if (amHandler && !isSameUserId(senderStr, requesterId)) return;

                            // Se o modal dessa pendência estiver aberto, não precisa toast
                            const modalOpen = document.getElementById('pendencyDetailsModal')?.classList?.contains('active');
                            const sameChat = Number(currentPendencyChatId || 0) === Number(pendencyId);
                            if (modalOpen && sameChat) return;

                            showToast({
                                title: '💬 Nova mensagem na pendência',
                                message: `#${pendencyId} • ${(pendency.title || 'Sem título')}`,
                                variant: 'info'
                            });
                            bumpSectionBadge('pendencias', 1);
                        } catch (e) {
                            console.warn('[pendency_messages][realtime] erro:', e);
                        }
                    }
                )
                .subscribe());
            
            // Subscription para kanban (com debounce para evitar loops)
            let kanbanReloadTimeout = null;
            const reloadKanbanDebounced = () => {
                if (kanbanReloadTimeout) {
                    clearTimeout(kanbanReloadTimeout);
                }
                kanbanReloadTimeout = setTimeout(() => {
                    if (currentSection === 'tarefas') {
                        loadKanban();
                    }
                }, 1000); // Aguardar 1 segundo antes de recarregar
            };

            let issuesReloadTimeout = null;
            const refreshIssuesRealtimeDebounced = () => {
                if (issuesReloadTimeout) {
                    clearTimeout(issuesReloadTimeout);
                }
                issuesReloadTimeout = setTimeout(async () => {
                    const devSections = ['dev_backlog', 'dev_detail', 'dev_create', 'formularios'];
                    if (!devSections.includes(currentSection)) return;
                    try {
                        if (currentSection === 'dev_detail' && issueUiState?.selectedId) {
                            await loadDevDetail();
                            return;
                        }
                        if (issueUiState?.view === 'board' && currentSection === 'dev_backlog') {
                            await refreshIssuesBoard();
                        } else {
                            await refreshIssuesList();
                        }
                        if (currentSection === 'dev_backlog') {
                            refreshDevStats().catch(() => {});
                        }
                    } catch (error) {
                        console.warn('Erro ao atualizar area DEV em realtime:', error);
                    }
                }, 600);
            };
            
            subscribeRealtimeOnce('kanban_cards_changes', () => supabaseClient
                .channel('kanban_cards_changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'kanban_cards' },
                    (payload) => {
                        try {
                            console.log('[kanban_cards][realtime]', payload);
                            clearCacheKey('txd_kanban');
                            if (payload.eventType === 'DELETE') {
                                const id = payload.old?.id;
                                removeItem(state.kanban.cardsById, id);
                                state.kanban.assigneesByCardId.delete(String(id));
                            } else {
                                const card = toCamelCase(payload.new || {});
                                const normalized = {
                                    ...card,
                                    id: Number(card.id),
                                    columnId: card.columnId || 'todo'
                                };
                                upsertItem(state.kanban.cardsById, normalized);
                            }

                            refreshGlobalsForKey('txd_kanban').catch(() => {});
                            renderTarefas();

                            if (currentSection !== 'tarefas') {
                                scheduleSectionRefreshForKey('txd_kanban', 900);
                            }
                        } catch (err) {
                            console.error('[kanban_cards][realtime] erro:', err, payload);
                            reloadKanbanDebounced();
                        }
                    }
                )
                .subscribe());
            
            subscribeRealtimeOnce('kanban_columns_changes', () => supabaseClient
                .channel('kanban_columns_changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'kanban_columns' },
                    (payload) => {
                        try {
                            console.log('[kanban_columns][realtime]', payload);
                            clearCacheKey('txd_kanban');
                            if (payload.eventType === 'DELETE') {
                                removeItem(state.kanban.columnsById, payload.old?.id);
                            } else {
                                const col = toCamelCase(payload.new || {});
                                upsertItem(state.kanban.columnsById, { ...col, id: String(col.id) });
                            }

                            refreshGlobalsForKey('txd_kanban').catch(() => {});
                            renderTarefas();

                            if (currentSection !== 'tarefas') {
                                scheduleSectionRefreshForKey('txd_kanban', 900);
                            }
                        } catch (err) {
                            console.error('[kanban_columns][realtime] erro:', err, payload);
                            reloadKanbanDebounced();
                        }
                    }
                )
                .subscribe());

            subscribeRealtimeOnce('kanban_assignees_changes', () => supabaseClient
                .channel('kanban_assignees_changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'kanban_card_assignees' },
                    (payload) => {
                        try {
                            clearCacheKey('txd_kanban');
                            if (payload.eventType === 'DELETE') {
                                const cardId = payload.old?.card_id ?? payload.old?.cardId;
                                if (!cardId) return;
                                const existing = state.kanban.assigneesByCardId.get(String(cardId)) || [];
                                const name = payload.old?.assignee_name || payload.old?.assigneeName;
                                if (name) {
                                    state.kanban.assigneesByCardId.set(
                                        String(cardId),
                                        existing.filter(a => String(a).toLowerCase().trim() !== String(name).toLowerCase().trim())
                                    );
                                }
                            } else {
                                const row = toCamelCase(payload.new || {});
                                const cardId = row.cardId ?? row.card_id;
                                const name = row.assigneeName ?? row.assignee_name;
                                if (!cardId) return;
                                const existing = state.kanban.assigneesByCardId.get(String(cardId)) || [];
                                if (name && !existing.some(a => String(a).toLowerCase().trim() === String(name).toLowerCase().trim())) {
                                    state.kanban.assigneesByCardId.set(String(cardId), [...existing, name]);
                                }

                                // Notificação: nova tarefa atribuída ao usuário atual
                                // (fallback; quando inbox persistente estiver ativo, isso vira notificação no banco)
                                if (notificationsSupported !== true) try {
                                    const mine = isCurrentUserName(name);
                                    if (payload.eventType === 'INSERT' && mine) {
                                        showToast({
                                            title: '✅ Nova tarefa atribuída',
                                            message: `Card #${cardId}`,
                                            variant: 'success'
                                        });
                                        bumpSectionBadge('tarefas', 1);
                                    }
                                } catch (e) {}
                            }

                            refreshGlobalsForKey('txd_kanban').catch(() => {});
                            renderTarefas();

                            if (currentSection !== 'tarefas') {
                                scheduleSectionRefreshForKey('txd_kanban', 900);
                            }
                        } catch (err) {
                            console.error('[kanban_assignees][realtime] erro:', err, payload);
                            reloadKanbanDebounced();
                        }
                    }
                )
                .subscribe());
            
            // Subscriptions genéricas (tabelas que alimentam seções e precisam atualizar multiusuário)
            subscribeKeyInvalidation('staff_changes', 'staff', 'txd_staff', 700);
            subscribeKeyInvalidation('events_changes', 'events', 'txd_events', 700);
            subscribeKeyInvalidation('announcements_changes', 'announcements', 'txd_announcements', 700);
            subscribeKeyInvalidation('warnings_changes', 'warnings', 'txd_warnings', 800);
            subscribeKeyInvalidation('license_requests_changes', 'license_requests', 'txd_license_requests', 900);
            subscribeKeyInvalidation('areas_changes', 'areas', 'txd_areas', 900);
            subscribeKeyInvalidation('area_team_members_changes', 'area_team_members', 'txd_areas', 900);
            subscribeKeyInvalidation('chat_messages_changes', 'chat_messages', 'txd_chat_messages', 500);
            subscribeKeyInvalidation('chat_groups_changes', 'chat_groups', 'txd_chat_groups', 700);
            subscribeKeyInvalidation('chat_group_members_changes', 'chat_group_members', 'txd_chat_groups', 700);
            subscribeKeyInvalidation('user_achievements_changes', 'user_achievements', 'txd_user_achievements', 900);
            subscribeKeyInvalidation('commands_changes', 'commands', 'txd_commands', 700);
            subscribeKeyInvalidation('command_usage_changes', 'command_usage', 'txd_command_usage', 900);
            subscribeKeyInvalidation('favorite_commands_changes', 'favorite_commands', 'txd_favorite_commands', 900);
            subscribeKeyInvalidation('discord_config_changes', 'discord_config', 'txd_discord_config', 700);
            subscribeKeyInvalidation('system_logs_changes', 'system_logs', 'txd_system_logs', 900);
            subscribeKeyInvalidation('system_settings_changes', 'system_settings', 'txd_system_settings', 900);
            subscribeKeyInvalidation('security_settings_changes', 'security_settings', 'txd_security_settings', 900);
            subscribeKeyInvalidation('polls_changes', 'polls', 'txd_polls', 900);
            subscribeKeyInvalidation('poll_options_changes', 'poll_options', 'txd_poll_options', 900);
            subscribeKeyInvalidation('poll_votes_changes', 'poll_votes', 'txd_poll_votes', 650);

            const issuesChannel = supabaseClient
                .channel('issues_changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'issues' },
                    () => {
                        refreshIssuesRealtimeDebounced();
                    }
                )
                .subscribe();
            realtimeSubscriptions.push(issuesChannel);

            const issueCommentsChannel = supabaseClient
                .channel('issue_comments_changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'issue_comments' },
                    () => {
                        refreshIssuesRealtimeDebounced();
                    }
                )
                .subscribe();
            realtimeSubscriptions.push(issueCommentsChannel);

            const issueAttachmentsChannel = supabaseClient
                .channel('issue_attachments_changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'issue_attachments' },
                    () => {
                        refreshIssuesRealtimeDebounced();
                    }
                )
                .subscribe();
            realtimeSubscriptions.push(issueAttachmentsChannel);
            
            realtimeInitialized = true;
            console.log('✅ Real-time inicializado com sucesso!');

            // Garantir que inbox de notificações (se existir) tenha subscriptions após resetRealtimeSubscriptions()
            initializeNotificationsSystem().catch(() => {});
        }
        
        // Mapeamento de chaves internas para tabelas Supabase
        const keyToTableMap = {
            'txd_staff': 'staff',
            'txd_commands': 'commands',
            'txd_command_usage': 'command_usage',
            'txd_favorite_commands': 'favorite_commands',
            'txd_areas': 'areas',
            'txd_chat_messages': 'chat_messages',
            'txd_chat_groups': 'chat_groups',
            'txd_user_achievements': 'user_achievements',
            'txd_discord_config': 'discord_config',
            'txd_discord_commands_log': 'discord_commands_log',
            'txd_events': 'events',            'txd_announcements': 'announcements',
            // "kanban" não é uma tabela; usamos kanban_* (cards/columns/assignees)
            'txd_kanban': 'kanban_cards',
            'txd_system_logs': 'system_logs',
            'txd_system_settings': 'system_settings',
            'txd_security_settings': 'security_settings',
            'txd_registration_requests': 'registration_requests',
            'txd_license_requests': 'license_requests',
            'txd_warnings': 'warnings',
            'txd_pendencies': 'pendencies',
            'txd_polls': 'polls',
            'txd_poll_options': 'poll_options',
            'txd_poll_votes': 'poll_votes'
        };
        
        // ========== FUNÇÕES SUPABASE ==========
        
        // Funções helper para conversão camelCase <-> snake_case
        function toSnakeCase(obj) {
            if (Array.isArray(obj)) {
                return obj.map(item => toSnakeCase(item));
            } else if (obj !== null && typeof obj === 'object' && !(obj instanceof Date)) {
                const converted = {};
                for (const key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        // Se já está em snake_case, manter
                        if (key.includes('_')) {
                            converted[key] = toSnakeCase(obj[key]);
                        } else {
                            // Converter camelCase para snake_case
                            const snakeKey = key.replace(/([A-Z])/g, '_$1').toLowerCase().replace(/^_/, '');
                            converted[snakeKey] = toSnakeCase(obj[key]);
                        }
                    }
                }
                return converted;
            }
            return obj;
        }
        
        function toCamelCase(obj) {
            if (Array.isArray(obj)) {
                return obj.map(item => toCamelCase(item));
            } else if (obj !== null && typeof obj === 'object' && !(obj instanceof Date)) {
                const converted = {};
                for (const key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        // Se já está em camelCase (sem underscore), manter
                        if (!key.includes('_')) {
                            converted[key] = toCamelCase(obj[key]);
                        } else {
                            // Converter snake_case para camelCase
                            const camelKey = key.replace(/_([a-z])/g, (g) => g[1].toUpperCase());
                            converted[camelKey] = toCamelCase(obj[key]);
                        }
                    }
                }
                return converted;
            }
            return obj;
        }
        
        async function getData(key, forceRefresh = false) {
            // Verificar cache inteligente (com timestamp)
            if (!forceRefresh && dataCache[key] !== undefined) {
                const cacheTime = cacheTimestamps[key] || 0;
                const now = Date.now();
                const cacheAge = now - cacheTime;
                
                // Se o cache ainda é válido (menos de 30 segundos), retorna imediatamente
                if (cacheAge < CACHE_TTL) {
                    return dataCache[key];
                }
                
                // Cache expirado, mas retorna imediatamente (stale-while-revalidate)
                // Atualiza em background sem bloquear
                const staleData = dataCache[key];
                refreshDataInBackground(key).catch(() => {});
                return staleData;
            }
            
            // Verificar se Supabase está inicializado
            if (!supabaseClient) {
                console.warn('Supabase não está inicializado. Retornando array vazio.');
                return [];
            }
            
            const tableName = keyToTableMap[key];
            if (!tableName) {
                console.warn(`Chave ${key} não mapeada para tabela Supabase`);
                return [];
            }
            
            try {
                let data = [];
                
                switch(key) {
                    case 'txd_staff':
                        const { data: staffData, error: staffError } = await supabaseClient
                            .from('staff')
                            .select('*')
                            .order('created_at', { ascending: false });
                        if (!staffError) data = toCamelCase(staffData || []);
                        break;
                        
                    case 'txd_commands':
                        const { data: commandsData, error: commandsError } = await supabaseClient
                            .from('commands')
                            .select('*')
                            .order('created_at', { ascending: false });
                        if (!commandsError) data = toCamelCase(commandsData || []);
                        break;
                        
                    case 'txd_events':
                        const { data: eventsData, error: eventsError } = await supabaseClient
                            .from('events')
                            .select('*')
                            .order('event_date', { ascending: true });
                        if (!eventsError) data = toCamelCase(eventsData || []);
                        break;
                        
                    case 'txd_announcements':
                        const { data: announcementsData, error: announcementsError } = await supabaseClient
                            .from('announcements')
                            .select('*')
                            .order('created_at', { ascending: false });
                        if (!announcementsError) data = toCamelCase(announcementsData || []);
                        break;
                        
                    case 'txd_areas':
                        const { data: areasData, error: areasError } = await supabaseClient
                            .from('areas')
                            .select('*')
                            .order('name', { ascending: true });
                        if (!areasError) {
                            // Converter snake_case para camelCase manualmente
                            const convertedAreas = (areasData || []).map(area => ({
                                id: area.id,
                                name: area.name,
                                icon: area.icon,
                                description: area.description,
                                hasLeader: area.has_leader || false,
                                leader: area.leader_name || null,
                                team: [],
                                createdAt: area.created_at,
                                updatedAt: area.updated_at
                            }));
                            
                            // Buscar membros das equipes
                            const { data: teamMembers } = await supabaseClient
                                .from('area_team_members')
                                .select('*');
                            
                            data = convertedAreas.map(area => ({
                                ...area,
                                team: (teamMembers || [])
                                    .filter(m => m && m.area_id === area.id)
                                    .map(m => m.member_name)
                            }));
                        }
                        break;
                        
                    case 'txd_chat_messages':
                        const { data: messagesData, error: messagesError } = await supabaseClient
                            .from('chat_messages')
                            .select('*')
                            .order('created_at', { ascending: true });
                        if (!messagesError) {
                            // Converter message para text e created_at para timestamp (compatibilidade com código JavaScript)
                            data = (messagesData || []).map(msg => {
                                const converted = toCamelCase(msg);
                                if (converted.message && !converted.text) {
                                    converted.text = converted.message;
                                    delete converted.message;
                                }
                                if (converted.createdAt && !converted.timestamp) {
                                    converted.timestamp = converted.createdAt;
                                    delete converted.createdAt;
                                }
                                return converted;
                            });
                        }
                        break;
                        
                    case 'txd_chat_groups':
                        const { data: groupsData, error: groupsError } = await supabaseClient
                            .from('chat_groups')
                            .select(`
                                *,
                                chat_group_members (*)
                            `)
                            .order('created_at', { ascending: false });
                        if (!groupsError) {
                            const convertedGroups = toCamelCase(groupsData || []);
                            data = convertedGroups.map(group => ({
                                ...group,
                                members: (group.chatGroupMembers || []).map(m => ({
                                    id: m.memberId,
                                    name: m.memberName,
                                    role: m.memberRole
                                }))
                            }));
                        }
                        break;
                        
                    case 'txd_user_achievements':
                        const { data: achievementsData, error: achievementsError } = await supabaseClient
                            .from('user_achievements')
                            .select('*');
                        if (!achievementsError) data = toCamelCase(achievementsData || []);
                        break;

                    case 'txd_system_settings':
                        try {
                            const { data: settingsRow, error: settingsError } = await supabaseClient
                                .from('system_settings')
                                .select('*')
                                .eq('id', 1)
                                .maybeSingle();
                            if (!settingsError && settingsRow) {
                                data = normalizeSystemSettings(toCamelCase(settingsRow));
                            } else {
                                // Fallback para localStorage (se a tabela/linha não existir)
                                data = getSystemSettingsObject();
                            }
                        } catch (e) {
                            data = getSystemSettingsObject();
                        }
                        break;
                        
                    case 'txd_discord_config':
                        const { data: configData, error: configError } = await supabaseClient
                            .from('discord_config')
                            .select('*')
                            .eq('id', 1)
                            .single();
                        if (!configError && configData) {
                            data = {
                                enabled: configData.enabled || false,
                                webhooks: {
                                    main: configData.webhook_main || '',
                                    logs: configData.webhook_logs || '',
                                    events: configData.webhook_events || '',
                                    pendencias: configData.webhook_tickets || configData.webhook_pendencias || ''
                                },
                                notifications: {
                                    chat: configData.notifications_chat !== false,
                                    tasks: configData.notifications_tasks !== false,
                                    pendencias: (configData.notifications_tickets !== false) && (configData.notifications_pendencias !== false),
                                    events: configData.notifications_events !== false,
                                    achievements: configData.notifications_achievements !== false,
                                    staff: configData.notifications_staff !== false
                                },
                                commandsEnabled: configData.commands_enabled || false,
                                commandsWebhook: configData.commands_webhook || ''
                            };
                        } else {
                            data = {
                                enabled: false,
                                webhooks: { main: '', logs: '', events: '', pendencias: '' },
                                notifications: { chat: true, tasks: true, pendencias: true, events: true, achievements: true, staff: true },
                                commandsEnabled: false,
                                commandsWebhook: ''
                            };
                        }
                        break;
                        
                    case 'txd_discord_commands_log':
                        const { data: logData, error: logError } = await supabaseClient
                            .from('discord_commands_log')
                            .select('*')
                            .order('created_at', { ascending: false })
                            .limit(50);
                        if (!logError) data = toCamelCase(logData || []);
                        break;
                        
                    case 'txd_kanban':
                        // Buscar colunas
                        const { data: columnsData, error: columnsError } = await supabaseClient
                            .from('kanban_columns')
                            .select('*')
                            .order('position', { ascending: true });
                        
                        // Buscar cards (sem join para evitar erro)
                        const { data: cardsData, error: cardsError } = await supabaseClient
                            .from('kanban_cards')
                            .select('*')
                            .order('created_at', { ascending: false });
                        
                        // Buscar assignees separadamente
                        let assigneesData = [];
                        if (!cardsError && cardsData && cardsData.length > 0) {
                            const cardIds = cardsData.map(c => c.id).filter(id => id);
                            if (cardIds.length > 0) {
                                const { data: assigneesRaw, error: assigneesError } = await supabaseClient
                                    .from('kanban_card_assignees')
                                    .select('*')
                                    .in('card_id', cardIds);
                                if (!assigneesError && assigneesRaw) {
                                    assigneesData = assigneesRaw;
                                }
                            }
                        }
                        
                        if (!columnsError && !cardsError) {
                            const convertedColumns = toCamelCase(columnsData || []);
                            const convertedCards = toCamelCase(cardsData || []);
                            
                            // Mapear assignees para cada card
                            data = {
                                columns: convertedColumns,
                                cards: convertedCards.map(card => {
                                    // Buscar assignees deste card
                                    const cardAssignees = assigneesData
                                        .filter(a => a.card_id === card.id)
                                        .map(a => a.assignee_name || a.assigneeName)
                                        .filter(name => name);
                                    
                                    // Garantir que assignees seja um array
                                    let assigneesArray = [];
                                    if (cardAssignees && cardAssignees.length > 0) {
                                        assigneesArray = cardAssignees;
                                    } else if (card.assignees && Array.isArray(card.assignees)) {
                                        assigneesArray = card.assignees;
                                    } else if (card.assignee && typeof card.assignee === 'string' && card.assignee.trim() !== '') {
                                        assigneesArray = [card.assignee];
                                    }
                                    
                                    return {
                                        ...card,
                                        assignees: assigneesArray,
                                        // Garantir que columnId existe
                                        columnId: card.columnId || card.column_id || 'todo'
                                    };
                                })
                            };
                        }
                        break;
                        
                    case 'txd_favorite_commands':
                        const { data: favoritesData, error: favoritesError } = await supabaseClient
                            .from('favorite_commands')
                            .select('command_id');
                        if (!favoritesError) {
                            data = (favoritesData || []).map(f => f.command_id);
                        }
                        break;
                        
                    case 'txd_command_usage':
                        const { data: usageData, error: usageError } = await supabaseClient
                            .from('command_usage')
                            .select('*')
                            .order('used_at', { ascending: false });
                        if (!usageError) data = toCamelCase(usageData || []);
                        break;
                        
                    case 'txd_registration_requests':
                        try {
                            const { data: requestsData, error: requestsError } = await supabaseClient
                                .from('registration_requests')
                                .select('*')
                                .order('requested_at', { ascending: false });
                            if (!requestsError && requestsData) {
                                debugLog('📊 Dados brutos do Supabase:', requestsData);
                                debugLog('📊 Primeira solicitação (exemplo):', requestsData[0]);
                                debugLog('📊 Campos disponíveis:', requestsData[0] ? Object.keys(requestsData[0]) : 'Nenhum dado');
                                
                                // Converter para camelCase e garantir campos necessários
                                // Mapear todos os campos possíveis
                                data = (requestsData || []).map(req => {
                                    // Log para debug
                                    if (requestsData.indexOf(req) === 0) {
                                        debugLog('🔍 Mapeando primeira solicitação:', req);
                                    }
                                    
                                    return {
                                        id: req.id,
                                        username: req.username || req.login || req.name || req.user || '',
                                        displayName: req.display_name || req.displayName || req.display_name || req.name || req.username || '',
                                        password: req.password || '',
                                        status: (req.status || 'pending').toLowerCase().trim(),
                                        requestedAt: req.requested_at || req.requestedAt || req.created_at || req.timestamp || new Date().toISOString(),
                                        requestedBy: req.requested_by || req.requestedBy || req.username || req.name || '',
                                        approvedBy: req.approved_by || req.approvedBy || null,
                                        approvedAt: req.approved_at || req.approvedAt || null,
                                        rejectionReason: req.rejection_reason || req.rejectionReason || null,
                                        gameId: req.game_id || req.gameId || null,
                                        discordId: req.discord_id || req.discordId || null,
                                        area: req.area || null,
                                        // Manter dados originais para debug
                                        _raw: req
                                    };
                                });
                                debugLog('✅ Solicitações mapeadas:', data.length);
                                debugLog('📋 Primeira solicitação mapeada:', data[0]);
                                debugLog('📋 Todas as solicitações:', data);
                                
                                // IMPORTANTE: Garantir que data não seja undefined
                                if (!data || data.length === 0) {
                                    console.warn('⚠️ Nenhuma solicitação foi mapeada!');
                                    data = [];
                                }
                            } else if (requestsError) {
                                // Se a tabela não existir (404), retornar array vazio
                                if (requestsError.code === 'PGRST116' || requestsError.message?.includes('404')) {
                                    console.warn('Tabela registration_requests não existe ainda. Execute o SQL de criação.');
                                    data = [];
                                } else {
                                    console.error('Erro ao buscar registration_requests:', requestsError);
                                    data = [];
                                }
                            }
                        } catch (err) {
                            console.error('Erro ao buscar registration_requests:', err);
                            data = [];
                        }
                        break;
                        
                    case 'txd_license_requests':
                        const { data: licenseData, error: licenseError } = await supabaseClient
                            .from('license_requests')
                            .select('*')
                            .order('created_at', { ascending: false });
                        if (!licenseError) data = toCamelCase(licenseData || []);
                        break;
                        
                    case 'txd_warnings':
                        const { data: warningsData, error: warningsError } = await supabaseClient
                            .from('warnings')
                            .select('*')
                            .order('created_at', { ascending: false });
                        if (!warningsError) data = toCamelCase(warningsData || []);
                        break;
                        
                    case 'txd_pendencies':
                        const { data: pendenciesData, error: pendenciesError } = await supabaseClient
                            .from('pendencies')
                            .select('*')
                            .order('created_at', { ascending: false });
                        if (!pendenciesError) data = toCamelCase(pendenciesData || []);
                        break;

                    case 'txd_polls':
                        const { data: pollsData, error: pollsError } = await supabaseClient
                            .from('polls')
                            .select('*')
                            .order('created_at', { ascending: false });
                        if (!pollsError) data = toCamelCase(pollsData || []);
                        break;

                    case 'txd_poll_options':
                        const { data: pollOptionsData, error: pollOptionsError } = await supabaseClient
                            .from('poll_options')
                            .select('*')
                            .order('created_at', { ascending: true });
                        if (!pollOptionsError) data = toCamelCase(pollOptionsData || []);
                        break;

                    case 'txd_poll_votes':
                        const { data: pollVotesData, error: pollVotesError } = await supabaseClient
                            .from('poll_votes')
                            .select('*')
                            .order('created_at', { ascending: false });
                        if (!pollVotesError) data = toCamelCase(pollVotesData || []);
                        break;
                }
                
                // Atualizar cache com timestamp
                dataCache[key] = data;
                cacheTimestamps[key] = Date.now();
                const itemsCount = Array.isArray(data)
                    ? data.length
                    : (data && typeof data === 'object'
                        ? (Array.isArray(data.cards) ? data.cards.length : 1)
                        : 0);
                debugLog(`💾 Cache atualizado para '${key}':`, itemsCount, 'itens');
                return data;
                
            } catch (error) {
                console.error(`Erro ao buscar ${key} do Supabase:`, error);
                return dataCache[key] || [];
            }
        }
        
        async function saveData(key, data) {
            // Verificar se Supabase está inicializado
            if (!supabaseClient) {
                console.warn('Supabase não está inicializado. Não é possível salvar dados.');
                return;
            }
            
            const tableName = keyToTableMap[key];
            if (!tableName) {
                console.warn(`Chave ${key} não mapeada para tabela Supabase`);
                return;
            }
            
            try {
                switch(key) {
                    case 'txd_staff':
                        if (Array.isArray(data)) {
                            // Converter para snake_case antes de salvar
                            const convertedData = toSnakeCase(data);
                            
                            // Garantir que cada registro tenha os campos necessários
                            const sanitizedData = convertedData.map(item => {
                                const sanitized = { ...item };
                                // Garantir que ID seja número
                                if (sanitized.id) {
                                    sanitized.id = parseInt(sanitized.id);
                                }
                                // Remover campos undefined
                                Object.keys(sanitized).forEach(key => {
                                    if (sanitized[key] === undefined) {
                                        delete sanitized[key];
                                    }
                                });
                                return sanitized;
                            });
                            
                            console.log('Salvando staff no Supabase:', sanitizedData.length, 'registros');
                            const isMissingColumn = (err, col) => {
                                const msg = (err?.message || '').toString().toLowerCase();
                                const c = String(col || '').toLowerCase();
                                return c && msg.includes(c) && (msg.includes('could not find') || msg.includes('does not exist') || msg.includes('schema cache'));
                            };

                            let { data: result, error } = await supabaseClient
                                .from('staff')
                                .upsert(sanitizedData, { onConflict: 'id' });

                            if (error && isMissingColumn(error, 'roles')) {
                                console.warn('[staff] Coluna roles ausente no Supabase; salvando sem múltiplos cargos. Recomenda-se aplicar a migração para adicionar roles (TEXT[]).', error);
                                const withoutRoles = sanitizedData.map(({ roles, ...rest }) => rest);
                                const retry = await supabaseClient
                                    .from('staff')
                                    .upsert(withoutRoles, { onConflict: 'id' });
                                result = retry.data;
                                error = retry.error;
                            }
                            
                            if (error) {
                                console.error('Erro ao salvar staff:', error);
                                throw error;
                            }
                            
                            // Atualizar cache após salvar
                            dataCache['txd_staff'] = data;
                            return { success: true, data: result };
                        }
                        break;
                        
                    case 'txd_commands':
                        if (Array.isArray(data)) {
                            const convertedData = toSnakeCase(data);
                            const { error } = await supabaseClient
                                .from('commands')
                                .upsert(convertedData, { onConflict: 'id' });
                            if (error) throw error;
                        }
                        break;
                        
                    case 'txd_events':
                        if (Array.isArray(data)) {
                            const isMissingColumn = (err, col) => {
                                const msg = (err?.message || '').toString().toLowerCase();
                                const c = String(col || '').toLowerCase();
                                return c && msg.includes(c) && (msg.includes('could not find') || msg.includes('does not exist') || msg.includes('schema cache'));
                            };

                            const normalizeTimeForDb = (value) => {
                                const v = (value || '').toString().trim();
                                if (!v) return null;
                                if (/^\d{2}:\d{2}:\d{2}$/.test(v)) return v;
                                if (/^\d{2}:\d{2}$/.test(v)) return `${v}:00`;
                                return null;
                            };

                            const v2Payload = data.map(e => {
                                const idRaw = e?.id;
                                const id = idRaw === null || idRaw === undefined || idRaw === '' ? undefined : Number(idRaw);
                                const title = (e?.title || '').toString();
                                const description = e?.description === undefined ? undefined : (e?.description ?? null);
                                const location = e?.location === undefined ? undefined : (e?.location ?? null);
                                const createdBy = (e?.createdBy || e?.created_by || '').toString().trim();

                                const eventDate = getEventDateString(e) || null;
                                const eventTime = normalizeTimeForDb(getEventTimeString(e));

                                const row = {
                                    id: Number.isFinite(id) ? id : undefined,
                                    title,
                                    description,
                                    event_date: eventDate || null,
                                    event_time: eventTime,
                                    location,
                                    created_by: createdBy || null,
                                    created_at: e?.createdAt ? e.createdAt : undefined
                                };

                                Object.keys(row).forEach(k => {
                                    if (row[k] === undefined) delete row[k];
                                });
                                return row;
                            });

                            let { error } = await supabaseClient
                                .from('events')
                                .upsert(v2Payload, { onConflict: 'id' });

                            if (error && (isMissingColumn(error, 'event_date') || isMissingColumn(error, 'event_time'))) {
                                console.warn('[events] Schema parece legacy (sem event_date/event_time). Tentando salvar com datetime/type.', error);

                                const legacyPayload = data.map(e => {
                                    const idRaw = e?.id;
                                    const id = idRaw === null || idRaw === undefined || idRaw === '' ? undefined : Number(idRaw);
                                    const row = {
                                        id: Number.isFinite(id) ? id : undefined,
                                        title: (e?.title || '').toString(),
                                        description: e?.description === undefined ? undefined : (e?.description ?? null),
                                        type: e?.type ? String(e.type) : undefined,
                                        datetime: e?.datetime ? String(e.datetime) : undefined,
                                        location: e?.location === undefined ? undefined : (e?.location ?? null),
                                        created_by: (e?.createdBy || e?.created_by || '').toString().trim() || null,
                                        created_at: e?.createdAt ? e.createdAt : undefined
                                    };
                                    Object.keys(row).forEach(k => {
                                        if (row[k] === undefined) delete row[k];
                                    });
                                    return row;
                                });

                                const retry = await supabaseClient
                                    .from('events')
                                    .upsert(legacyPayload, { onConflict: 'id' });
                                error = retry.error;
                            }

                            if (error) throw error;

                            // Atualizar cache após salvar
                            dataCache['txd_events'] = data;
                            cacheTimestamps['txd_events'] = Date.now();
                        }
                        break;
                        
                    case 'txd_announcements':
                        if (Array.isArray(data)) {
                            const convertedData = toSnakeCase(data);
                            const { error } = await supabaseClient
                                .from('announcements')
                                .upsert(convertedData, { onConflict: 'id' });
                            if (error) throw error;
                        }
                        break;
                        
                    case 'txd_areas':
                        if (Array.isArray(data)) {
                            for (const area of data) {
                                if (!area || !area.id) continue;
                                
                                try {
                                    // Extrair apenas o que precisamos, ignorando tudo mais
                                    const team = area.team;
                                    
                                    // Criar objeto limpo APENAS com campos que existem no schema
                                    // NUNCA usar toSnakeCase aqui - mapear manualmente
                                    const areaToSave = {};
                                    
                                    // Campos obrigatórios
                                    areaToSave.id = String(area.id);
                                    areaToSave.name = String(area.name || '');
                                    
                                    // Mapear leader corretamente (pode vir como leader, Leader, ou leader_name)
                                    // IMPORTANTE: usar leader_name (snake_case) como nome do campo
                                    const leaderValue = area.leader || area.Leader || area.leader_name || null;
                                    if (leaderValue && String(leaderValue).trim() !== '') {
                                        areaToSave.leader_name = String(leaderValue);
                                        areaToSave.has_leader = true;
                                    } else {
                                        areaToSave.leader_name = null;
                                        areaToSave.has_leader = false;
                                    }
                                    
                                    // Campos opcionais (apenas se existirem e não forem vazios)
                                    if (area.icon && String(area.icon).trim() !== '') {
                                        areaToSave.icon = String(area.icon);
                                    }
                                    
                                    if (area.description && String(area.description).trim() !== '') {
                                        areaToSave.description = String(area.description);
                                    }
                                    
                                    // Garantir que NÃO há campos extras (especialmente Leader com L maiúsculo)
                                    // Remover qualquer campo que não esteja na lista permitida
                                    const allowedFields = ['id', 'name', 'icon', 'description', 'has_leader', 'leader_name'];
                                    Object.keys(areaToSave).forEach(key => {
                                        if (!allowedFields.includes(key)) {
                                            delete areaToSave[key];
                                        }
                                    });
                                    
                                    // Salvar área (sem created_at e updated_at, deixar o banco gerenciar)
                                    const { data: savedArea, error: areaError } = await supabaseClient
                                        .from('areas')
                                        .upsert(areaToSave, { onConflict: 'id' })
                                        .select();
                                    
                                    if (areaError) {
                                        console.error('Erro ao salvar área:', areaError, areaToSave);
                                        alert(`Erro ao salvar área ${area.name}: ${areaError.message}`);
                                        // Não lançar erro, apenas logar para não quebrar o fluxo
                                        continue;
                                    } else {
                                        console.log('Área salva com sucesso:', savedArea);
                                    }
                                    
                                    // Deletar membros antigos da equipe
                                    if (area.id) {
                                        await supabaseClient
                                            .from('area_team_members')
                                            .delete()
                                            .eq('area_id', String(area.id));
                                        
                                        // Inserir novos membros da equipe
                                        if (team && Array.isArray(team) && team.length > 0) {
                                            const teamData = team
                                                .filter(name => name && typeof name === 'string')
                                                .map(name => ({
                                                    area_id: String(area.id),
                                                    member_name: String(name)
                                                }));
                                            
                                            if (teamData.length > 0) {
                                                const { error: teamError } = await supabaseClient
                                                    .from('area_team_members')
                                                    .insert(teamData);
                                                
                                                if (teamError) {
                                                    console.error('Erro ao salvar membros da equipe:', teamError);
                                                }
                                            }
                                        }
                                    }
                                } catch (error) {
                                    console.error('Erro ao processar área:', error, area);
                                    // Continuar com próxima área mesmo se houver erro
                                    continue;
                                }
                            }
                            
                            // Limpar cache para forçar refresh na próxima leitura
                            clearCacheKey('txd_areas');
                            
                            console.log('Todas as áreas foram salvas. Cache limpo para forçar refresh.');
                        }
                        break;
                        
                    case 'txd_chat_messages':
                        if (Array.isArray(data)) {
                            // Converter text para message e timestamp para created_at (compatibilidade com schema SQL)
                            const dataWithMessage = data.map(msg => {
                                const converted = { ...msg };
                                if (converted.text && !converted.message) {
                                    converted.message = converted.text;
                                    delete converted.text;
                                }
                                if (converted.timestamp && !converted.createdAt) {
                                    converted.createdAt = converted.timestamp;
                                    delete converted.timestamp;
                                }
                                return converted;
                            });
                            // Converter para snake_case antes de salvar
                            const convertedData = toSnakeCase(dataWithMessage);
                            const { error } = await supabaseClient
                                .from('chat_messages')
                                .upsert(convertedData, { onConflict: 'id' });
                            if (error) throw error;
                        }
                        break;
                        
                    case 'txd_chat_groups':
                        if (Array.isArray(data)) {
                            for (const group of data) {
                                const { members, ...groupData } = group;
                                
                                // Converter grupo para snake_case
                                const convertedGroup = toSnakeCase(groupData);
                                
                                // Salvar grupo
                                const { data: savedGroup, error: groupError } = await supabaseClient
                                    .from('chat_groups')
                                    .upsert(convertedGroup, { onConflict: 'id' })
                                    .select()
                                    .single();
                                if (groupError) throw groupError;
                                
                                // Deletar membros antigos
                                await supabaseClient
                                    .from('chat_group_members')
                                    .delete()
                                    .eq('group_id', savedGroup.id);
                                
                                // Inserir novos membros
                                if (members && members.length > 0) {
                                    const membersData = members.map(m => ({
                                        group_id: savedGroup.id,
                                        member_id: m.id,
                                        member_name: m.name,
                                        member_role: m.role
                                    }));
                                    const { error: membersError } = await supabaseClient
                                        .from('chat_group_members')
                                        .insert(membersData);
                                    if (membersError) throw membersError;
                                }
                            }
                        }
                        break;
                        
                    case 'txd_user_achievements':
                        if (Array.isArray(data)) {
                            // Compatibilidade: alguns schemas exigem user_name NOT NULL
                            const enriched = data.map(row => {
                                if (!row || typeof row !== 'object') return row;
                                const hasUserName = row.userName || row.user_name;
                                if (hasUserName) return row;
                                const fallbackName = (currentUser?.displayName || currentUser?.name || '').toString().trim();
                                return fallbackName ? { ...row, userName: fallbackName } : row;
                            });
                            const convertedData = toSnakeCase(enriched);
                            const { error } = await supabaseClient
                                .from('user_achievements')
                                .upsert(convertedData, { onConflict: 'user_id,achievement_id' });
                            if (error) throw error;
                        }
                        break;

                    case 'txd_system_settings':
                        if (data && typeof data === 'object' && !Array.isArray(data)) {
                            const s = normalizeSystemSettings(data);
                            const payload = {
                                id: 1,
                                system_name: s.systemName,
                                maintenance_mode: !!s.maintenanceMode,
                                global_message: s.globalMessage || '',
                                logo_url: s.logoUrl || '',
                                app_bg_url: s.appBackgroundUrl || '',
                                login_bg_url: s.loginBackgroundUrl || ''
                            };

                            const attempt = async (p) => supabaseClient
                                .from('system_settings')
                                .upsert(p, { onConflict: 'id' });

                            let { error } = await attempt(payload);
                            if (error) {
                                // Se o schema não tiver algumas colunas, tentar salvar com o mínimo
                                const msg = (error?.message || '').toString().toLowerCase();
                                const minimal = { id: 1, system_name: s.systemName, maintenance_mode: !!s.maintenanceMode, global_message: s.globalMessage || '', logo_url: s.logoUrl || '' };
                                if (msg.includes('app_bg_url') || msg.includes('login_bg_url')) {
                                    ({ error } = await attempt(minimal));
                                }
                            }
                            if (error) throw error;
                        }
                        break;
                        
                    case 'txd_discord_config':
                        if (data && typeof data === 'object') {
                            const { error } = await supabaseClient
                                .from('discord_config')
                                .update({
                                    enabled: data.enabled || false,
                                    webhook_main: data.webhooks?.main || '',
                                    webhook_logs: data.webhooks?.logs || '',
                                    webhook_events: data.webhooks?.events || '',
                                    webhook_tickets: data.webhooks?.pendencias || '',
                                    notifications_chat: data.notifications?.chat !== false,
                                    notifications_tasks: data.notifications?.tasks !== false,
                                    notifications_tickets: data.notifications?.pendencias !== false,
                                    notifications_events: data.notifications?.events !== false,
                                    notifications_achievements: data.notifications?.achievements !== false,
                                    notifications_staff: data.notifications?.staff !== false,
                                    commands_enabled: data.commandsEnabled || false,
                                    commands_webhook: data.commandsWebhook || ''
                                })
                                .eq('id', 1);
                            if (error) throw error;
                        }
                        break;
                        
                    case 'txd_discord_commands_log':
                        if (Array.isArray(data)) {
                            // Limpar log antigo e inserir novo
                            await supabaseClient.from('discord_commands_log').delete().neq('id', 0);
                            if (data.length > 0) {
                                const convertedData = toSnakeCase(data);
                                const { error } = await supabaseClient
                                    .from('discord_commands_log')
                                    .insert(convertedData);
                                if (error) throw error;
                            }
                        }
                        break;
                        
                    case 'txd_registration_requests':
                        if (Array.isArray(data)) {
                            try {
                                // Para cada request, fazer upsert
                                for (const request of data) {
                                    const convertedRequest = toSnakeCase(request);
                                    
                                    // Garantir que status está presente
                                    if (!convertedRequest.status) {
                                        convertedRequest.status = 'pending';
                                    }
                                    
                                    // Garantir que requested_at está presente
                                    if (!convertedRequest.requested_at && request.requestedAt) {
                                        convertedRequest.requested_at = request.requestedAt;
                                    } else if (!convertedRequest.requested_at) {
                                        convertedRequest.requested_at = new Date().toISOString();
                                    }
                                    
                                    console.log('Salvando solicitação:', convertedRequest);
                                    
                                    const { data: savedRequest, error } = await supabaseClient
                                        .from('registration_requests')
                                        .upsert(convertedRequest, { onConflict: 'id' })
                                        .select();
                                    
                                    if (error) {
                                        // Se a tabela não existir, mostrar mensagem útil
                                        if (error.code === 'PGRST116' || error.message?.includes('404')) {
                                            console.error('❌ ERRO: Tabela registration_requests não existe no Supabase!');
                                            console.error('📋 Execute o SQL do arquivo: criar_tabela_registration_requests.sql');
                                            alert('Erro: Tabela registration_requests não existe. Execute o SQL de criação no Supabase.');
                                        } else {
                                            console.error('Erro ao salvar registration_request:', error, convertedRequest);
                                        }
                                        throw error;
                                    } else {
                                        console.log('Solicitação salva com sucesso:', savedRequest);
                                    }
                                }
                                
                                // Limpar cache após salvar
                                clearCacheKey('txd_registration_requests');
                            } catch (err) {
                                // Se for erro de tabela não encontrada, tentar criar via insert direto
                                if (err.code === 'PGRST116' || err.message?.includes('404')) {
                                    console.error('Tabela não existe. Por favor, execute o SQL de criação.');
                                    throw new Error('Tabela registration_requests não existe. Execute criar_tabela_registration_requests.sql no Supabase.');
                                }
                                throw err;
                            }
                        }
                        break;
                        
                    case 'txd_license_requests':
                        if (Array.isArray(data)) {
                            try {
                                // Para cada solicitação, fazer upsert
                                for (const request of data) {
                                    const convertedRequest = toSnakeCase(request);
                                    
                                    // Garantir que status está presente
                                    if (!convertedRequest.status) {
                                        convertedRequest.status = 'pending';
                                    }
                                    
                                    // Garantir que created_at está presente
                                    if (!convertedRequest.created_at && request.createdAt) {
                                        convertedRequest.created_at = request.createdAt;
                                    } else if (!convertedRequest.created_at) {
                                        convertedRequest.created_at = new Date().toISOString();
                                    }
                                    
                                    // Mapear campos específicos
                                    if (request.startDate) convertedRequest.start_date = request.startDate;
                                    if (request.endDate) convertedRequest.end_date = request.endDate;
                                    if (request.userId) convertedRequest.user_id = request.userId;
                                    if (request.userName) convertedRequest.user_name = request.userName;
                                    if (request.createdBy) convertedRequest.created_by = request.createdBy;
                                    
                                    console.log('Salvando solicitação de licença:', convertedRequest);
                                    
                                    const { data: savedRequest, error } = await supabaseClient
                                        .from('license_requests')
                                        .upsert(convertedRequest, { onConflict: 'id' })
                                        .select();
                                    
                                    if (error) {
                                        console.error('Erro ao salvar license_request:', error, convertedRequest);
                                        throw error;
                                    } else {
                                        console.log('Solicitação de licença salva com sucesso:', savedRequest);
                                    }
                                }
                                
                                // Limpar cache após salvar
                                clearCacheKey('txd_license_requests');
                            } catch (error) {
                                console.error('Erro ao salvar license_requests:', error);
                                throw error;
                            }
                        }
                        break;
                        
                    case 'txd_pendencies':
                        if (Array.isArray(data)) {
                            try {
                                // Para cada pendência, fazer upsert
                                for (const pendency of data) {
                                    const convertedPendency = toSnakeCase(pendency);
                                    const allowedFields = ['id', 'user_id', 'user_name', 'title', 'description', 'type', 'priority', 'status', 'response', 'attachments', 'due_date', 'created_by', 'approved_by', 'approved_at', 'completed_at'];
                                    const filteredPendency = {};
                                    Object.keys(convertedPendency).forEach(key => {
                                        if (allowedFields.includes(key)) {
                                            filteredPendency[key] = convertedPendency[key];
                                        }
                                    });
                                    
                                    const { error } = await supabaseClient
                                        .from('pendencies')
                                        .upsert(filteredPendency, { onConflict: 'id' });
                                    if (error) throw error;
                                }
                            } catch (error) {
                                console.error('Erro ao salvar pendências:', error);
                                throw error;
                            }
                        }
                        break;
                        
                    case 'txd_warnings':
                        if (Array.isArray(data)) {
                            try {
                                // Para cada advertência, fazer upsert
                                for (const warning of data) {
                                    const convertedWarning = toSnakeCase(warning);
                                    
                                    // Garantir que status está presente
                                    if (!convertedWarning.status) {
                                        convertedWarning.status = 'active';
                                    }
                                    
                                    // Garantir que level está presente
                                    if (!convertedWarning.level) {
                                        convertedWarning.level = 'leve';
                                    }
                                    
                                    // Garantir que created_at está presente
                                    if (!convertedWarning.created_at && warning.createdAt) {
                                        convertedWarning.created_at = warning.createdAt;
                                    } else if (!convertedWarning.created_at) {
                                        convertedWarning.created_at = new Date().toISOString();
                                    }
                                    
                                    // Mapear campos específicos
                                    if (warning.userId) convertedWarning.user_id = warning.userId;
                                    if (warning.userName) convertedWarning.user_name = warning.userName;
                                    if (warning.issuedById) convertedWarning.issued_by_id = warning.issuedById;
                                    if (warning.issuedBy) convertedWarning.issued_by = warning.issuedBy;
                                    if (warning.expiresAt) convertedWarning.expires_at = warning.expiresAt;
                                    if (warning.revokedAt) convertedWarning.revoked_at = warning.revokedAt;
                                    if (warning.revokedBy) convertedWarning.revoked_by = warning.revokedBy;
                                    if (warning.attachmentUrl) convertedWarning.attachment_url = warning.attachmentUrl;
                                    
                                    console.log('Salvando advertência:', convertedWarning);
                                    
                                    const { data: savedWarning, error } = await supabaseClient
                                        .from('warnings')
                                        .upsert(convertedWarning, { onConflict: 'id' })
                                        .select();
                                    
                                    if (error) {
                                        console.error('Erro ao salvar warning:', error, convertedWarning);
                                        throw error;
                                    } else {
                                        console.log('Advertência salva com sucesso:', savedWarning);
                                    }
                                }
                                
                                // Limpar cache após salvar
                                clearCacheKey('txd_warnings');
                            } catch (error) {
                                console.error('Erro ao salvar warnings:', error);
                                throw error;
                            }
                        }
                        break;
                        
                    case 'txd_kanban':
                        if (data && typeof data === 'object') {
                            // Salvar colunas
                            if (data.columns) {
                                const convertedColumns = toSnakeCase(data.columns);
                                const { error: colsError } = await supabaseClient
                                    .from('kanban_columns')
                                    .upsert(convertedColumns, { onConflict: 'id' });
                                if (colsError) throw colsError;
                            }
                            
                            // Salvar cards
                            if (data.cards && Array.isArray(data.cards)) {
                                for (const card of data.cards) {
                                    if (!card || !card.id) {
                                        console.warn('Card inválido ignorado:', card);
                                        continue;
                                    }
                                    
                                    const { assignees, assignee, ...cardData } = card;
                                    
                                    // Garantir que columnId existe
                                    if (!cardData.columnId && !cardData.column_id) {
                                        cardData.columnId = 'todo';
                                    }
                                    
                                    // REMOVER campo de data se estiver vazio (não é obrigatório)
                                    if (!cardData.dueDate || cardData.dueDate === '' || cardData.dueDate === null) {
                                        delete cardData.dueDate;
                                    }
                                    if (cardData.due_date === '' || cardData.due_date === null) {
                                        delete cardData.due_date;
                                    }
                                    
                                    // Converter card para snake_case
                                    const convertedCard = toSnakeCase(cardData);
                                    
                                    // REMOVER due_date se for string vazia (não enviar para o banco)
                                    if (convertedCard.due_date === '' || convertedCard.due_date === null || convertedCard.due_date === undefined) {
                                        delete convertedCard.due_date;
                                    }
                                    
                                    // Salvar card
                                    const { data: savedCard, error: cardError } = await supabaseClient
                                        .from('kanban_cards')
                                        .upsert(convertedCard, { onConflict: 'id' })
                                        .select()
                                        .single();
                                    if (cardError) throw cardError;
                                    
                                    // Deletar assignees antigos primeiro
                                    const { error: deleteError } = await supabaseClient
                                        .from('kanban_card_assignees')
                                        .delete()
                                        .eq('card_id', savedCard.id);
                                    if (deleteError) {
                                        console.warn('Aviso ao deletar assignees antigos (pode ser normal):', deleteError.message);
                                        // Continuar mesmo se houver erro ao deletar (pode não existir ainda)
                                    }
                                    
                                    // Aguardar um pouco para garantir que a deleção foi processada
                                    await new Promise(resolve => setTimeout(resolve, 50));
                                    
                                    // Inserir novos assignees (apenas se houver e não estiverem duplicados)
                                    const assigneesToPersist = Array.isArray(assignees)
                                        ? assignees
                                        : (assignee && typeof assignee === 'string' ? [assignee] : []);

                                    if (assigneesToPersist.length > 0) {
                                        // Remover duplicatas e valores vazios/null
                                        const uniqueAssignees = [...new Set(assigneesToPersist.filter(name => name && typeof name === 'string' && name.trim() !== ''))];
                                        
                                        if (uniqueAssignees.length > 0) {
                                            const assigneesData = uniqueAssignees.map(name => ({
                                            card_id: savedCard.id,
                                                assignee_name: name.trim()
                                        }));
                                            
                                            // Usar upsert para evitar duplicatas
                                        const { error: assigneesError } = await supabaseClient
                                            .from('kanban_card_assignees')
                                                .upsert(assigneesData, { 
                                                    onConflict: 'card_id,assignee_name'
                                                });
                                            if (assigneesError) {
                                                console.warn('Aviso ao salvar assignees (continuando mesmo assim):', assigneesError.message);
                                                // Não lançar erro para não quebrar o salvamento do card principal
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        break;
                        
                    case 'txd_favorite_commands':
                        if (Array.isArray(data)) {
                            // Limpar favoritos antigos
                            await supabaseClient.from('favorite_commands').delete().neq('id', 0);
                            if (data.length > 0) {
                                const favoritesData = data.map(cmdId => ({
                                    user_id: currentUser?.id || 'default',
                                    command_id: cmdId
                                }));
                                const { error } = await supabaseClient
                                    .from('favorite_commands')
                                    .insert(favoritesData);
                                if (error) throw error;
                            }
                        }
                        break;
                        
                    case 'txd_command_usage':
                        if (Array.isArray(data) && data.length > 0) {
                            const convertedData = toSnakeCase(data);
                            const { error } = await supabaseClient
                                .from('command_usage')
                                .insert(convertedData);
                            if (error) throw error;
                        }
                        break;
                }
                
                // Atualizar cache
                dataCache[key] = data;
                
            } catch (error) {
                console.error(`Erro ao salvar ${key} no Supabase:`, error);
            }
        }
        
        // Função para inicializar cache
        async function initializeCache() {
            if (cacheInitialized) return;
            
            try {
                const keys = Object.keys(keyToTableMap);
                for (const key of keys) {
                    await getData(key);
                }
                cacheInitialized = true;
                console.log('✅ Cache Supabase inicializado');
            } catch (error) {
                console.error('Erro ao inicializar cache:', error);
            }
        }
        
        // Inicializar cache ao carregar
        initializeCache();
        
        // ========== SISTEMA DE LOGIN ==========
        // Usuários pré-configurados com acesso total
        const PRECONFIGURED_USERS = {
            'romanov': {
                password: '5875',
                name: 'Romanov',
                role: 'Owner',
                id: 999,
                email: 'romanov@txd.staff',
                status: 'Ativo'
            }
        };

        // Persistência simples de sessão (evita deslogar no F5)
        const SESSION_STORAGE_KEY = 'txd_staff_session_v1';
        const SESSION_TTL_MS = 1000 * 60 * 60 * 24 * 7; // 7 dias

        // Configurações gerais / branding
        const SYSTEM_SETTINGS_LOCAL_KEY = 'txd_system_settings_local_v1';
        const DEFAULT_SYSTEM_SETTINGS = {
            systemName: 'TXD Staff System',
            maintenanceMode: false,
            globalMessage: '',
            logoUrl: '',
            appBackgroundUrl: '',
            loginBackgroundUrl: ''
        };

        function readSystemSettingsLocal() {
            try {
                const raw = localStorage.getItem(SYSTEM_SETTINGS_LOCAL_KEY);
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                return (parsed && typeof parsed === 'object') ? parsed : null;
            } catch (e) {
                return null;
            }
        }

        function writeSystemSettingsLocal(settings) {
            try { localStorage.setItem(SYSTEM_SETTINGS_LOCAL_KEY, JSON.stringify(settings || {})); } catch (e) {}
        }

        function normalizeSystemSettings(input) {
            const s = (input && typeof input === 'object') ? input : {};
            return {
                systemName: (s.systemName ?? s.system_name ?? DEFAULT_SYSTEM_SETTINGS.systemName) || DEFAULT_SYSTEM_SETTINGS.systemName,
                maintenanceMode: (s.maintenanceMode ?? s.maintenance_mode) === true,
                globalMessage: (s.globalMessage ?? s.global_message ?? DEFAULT_SYSTEM_SETTINGS.globalMessage) || '',
                logoUrl: (s.logoUrl ?? s.logo_url ?? DEFAULT_SYSTEM_SETTINGS.logoUrl) || '',
                appBackgroundUrl: (s.appBackgroundUrl ?? s.app_background_url ?? s.app_bg_url ?? '') || '',
                loginBackgroundUrl: (s.loginBackgroundUrl ?? s.login_background_url ?? s.login_bg_url ?? '') || ''
            };
        }

        function getSystemSettingsObject() {
            const cached = dataCache?.txd_system_settings;
            if (cached && typeof cached === 'object' && !Array.isArray(cached)) {
                return normalizeSystemSettings(cached);
            }
            const local = readSystemSettingsLocal();
            if (local) return normalizeSystemSettings(local);
            return { ...DEFAULT_SYSTEM_SETTINGS };
        }

        function safeCssUrl(url) {
            const raw = (url ?? '').toString().trim();
            if (!raw) return '';
            // bloqueia javascript: e data: (evita XSS via CSS url())
            const lower = raw.toLowerCase();
            if (lower.startsWith('javascript:') || lower.startsWith('data:')) return '';
            return raw;
        }

        function applyBrandingFromSystemSettings(settings) {
            try {
                const s = normalizeSystemSettings(settings);
                const defaultLogoUrl = 'https://tdatgzjwcuatpqhfococ.supabase.co/storage/v1/object/public/logos/sem-fundo-txd.png';

                // Título e nome do sistema
                try { document.title = s.systemName || document.title; } catch (e) {}

                // Logo: login + navbar
                const logo = safeCssUrl(s.logoUrl);
                try {
                    document.querySelectorAll('img.navbar-logo, img.logo-image').forEach(img => {
                        if (!img || img.tagName !== 'IMG') return;
                        img.src = logo || defaultLogoUrl;
                    });
                } catch (e) {}

                // Favicon (logo na aba do navegador)
                try {
                    const faviconHref = logo || defaultLogoUrl;
                    const upsertLink = (id, rel) => {
                        let el = document.getElementById(id);
                        if (!el) {
                            el = document.createElement('link');
                            el.id = id;
                            el.rel = rel;
                            document.head.appendChild(el);
                        }
                        el.href = faviconHref;
                    };
                    upsertLink('appFavicon', 'icon');
                    upsertLink('appAppleTouchIcon', 'apple-touch-icon');
                } catch (e) {}

                // Backgrounds (CSS vars)
                const appBg = safeCssUrl(s.appBackgroundUrl);
                const loginBg = safeCssUrl(s.loginBackgroundUrl);
                if (appBg) document.documentElement.style.setProperty('--app-bg-image', `url('${appBg.replace(/'/g, "%27")}')`);
                else document.documentElement.style.removeProperty('--app-bg-image');
                if (loginBg) document.documentElement.style.setProperty('--login-bg-image', `url('${loginBg.replace(/'/g, "%27")}')`);
                else document.documentElement.style.removeProperty('--login-bg-image');
            } catch (e) {}
        }

        function persistSession(user) {
            try {
                if (!user) return;
                const safeUser = {
                    id: user.id,
                    name: user.name,
                    displayName: user.displayName,
                    login: user.login,
                    role: user.role,
                    roles: Array.isArray(user.roles) ? user.roles : normalizeRoleList(user.roles || user.role),
                    email: user.email || null,
                    status: user.status || null,
                    area: user.area || null,
                    gameId: user.gameId || null,
                    discordId: user.discordId || null
                };
                const payload = {
                    user: safeUser,
                    lastSection: String(currentSection || 'inicio'),
                    createdAt: Date.now(),
                    expiresAt: Date.now() + SESSION_TTL_MS
                };
                localStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(payload));
            } catch (e) {}
        }

        function clearPersistedSession() {
            try { localStorage.removeItem(SESSION_STORAGE_KEY); } catch (e) {}
        }

        function readPersistedSession() {
            try {
                const raw = localStorage.getItem(SESSION_STORAGE_KEY);
                if (!raw) return null;
                const parsed = JSON.parse(raw);
                const expiresAt = Number(parsed?.expiresAt || 0);
                if (!expiresAt || Date.now() > expiresAt) {
                    clearPersistedSession();
                    return null;
                }
                const user = parsed?.user || null;
                if (!user || user.id === undefined || user.id === null) return null;
                return {
                    user,
                    lastSection: parsed?.lastSection || 'inicio'
                };
            } catch (e) {
                return null;
            }
        }

                async function restoreSessionIfAvailable() {
            const session = readPersistedSession();
            if (!session) return false;

            try {
                const u = session.user;
                const effectiveRoles = normalizeRoleList(u.roles || u.role);
                const primaryRole = u.role || effectiveRoles[0] || 'Owner';
                currentUser = {
                    id: u.id,
                    name: u.name || u.displayName || 'Staff',
                    displayName: u.displayName || u.name || 'Staff',
                    login: u.login || u.name || 'staff',
                    role: primaryRole,
                    roles: effectiveRoles.length > 0 ? effectiveRoles : [primaryRole],
                    email: u.email || null,
                    status: u.status || 'Ativo',
                    area: u.area || null,
                    gameId: u.gameId || null,
                    discordId: u.discordId || null
                };

                const permissions = getUserPermissionsForRoles(currentUser.roles || currentUser.role);
                applyPermissionsToMenu(permissions);
                renderDevMenuItem();

                const loginScreen = document.getElementById('loginScreen');
                const dashboard = document.getElementById('dashboard');
                if (loginScreen) loginScreen.style.display = 'none';
                if (dashboard) dashboard.classList.add('active');

                if (supabaseClient && !realtimeInitialized) {
                    initializeRealtime();
                }

                // Atualiza caches em background e volta para a última aba (ou início)
                refreshData().catch(() => {});
                try { applyBrandingFromSystemSettings(getSystemSettingsObject()); } catch (e) {}
                showSection(session.lastSection || 'inicio');

                return true;
            } catch (e) {
                clearPersistedSession();
                return false;
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (username && password) {
                try {
                    let userFound = null;
                    
                    // 1. Verificar usuários pré-configurados primeiro
                    const lowerUsername = username.toLowerCase();
                    if (PRECONFIGURED_USERS[lowerUsername]) {
                        const preUser = PRECONFIGURED_USERS[lowerUsername];
                        if (password === preUser.password) {
                            userFound = { ...preUser };
                        } else {
                            alert('Senha incorreta para este usuário.');
                            return;
                        }
                    }
                    
                    // 2. Se não for pré-configurado, buscar no Supabase (por login ou name)
                    if (!userFound && supabaseClient) {
                        const { data: staffData, error } = await supabaseClient
                            .from('staff')
                            .select('*')
                            .or(`name.ilike.%${username}%,display_name.ilike.%${username}%,login.ilike.%${username}%`)
                            .limit(1);
                        
                        if (!error && staffData && Array.isArray(staffData) && staffData.length > 0) {
                            const foundUser = staffData[0];
                            // Verificar senha se existir
                            if (foundUser.password && foundUser.password !== password) {
                                alert('Senha incorreta.');
                                return;
                            }
                            
                            // Verificar se o usuário está aprovado
                            if (foundUser.status === 'Ativo' || foundUser.status === 'ativo') {
                                userFound = {
                                    id: foundUser.id,
                                    name: foundUser.name || foundUser.display_name || username,
                                    displayName: foundUser.display_name || foundUser.name || username,
                                    role: foundUser.role || 'Helper',
                                    roles: foundUser.roles || null,
                                    email: foundUser.email || null,
                                    status: foundUser.status || 'Ativo',
                                    password: foundUser.password || null,
                                    login: foundUser.login || foundUser.name || username,
                                    area: foundUser.area || null,
                                    gameId: foundUser.game_id || null,
                                    discordId: foundUser.discord_id || null
                                };
                            } else {
                                alert('Sua conta ainda não foi aprovada. Aguarde a aprovação de um administrador.');
                                return;
                            }
                        }
                    }
                    
                    // 3. Se não encontrou no Supabase, buscar no cache em memória
                    if (!userFound) {
                        const staffDataRaw = getData('txd_staff');
                        // Garantir que seja sempre um array
                        const staffData = Array.isArray(staffDataRaw) ? staffDataRaw : [];
                        
                        if (staffData.length > 0) {
                            const foundUser = staffData.find(s => 
                                s && (
                                    (s.name && s.name.toLowerCase().includes(username.toLowerCase())) ||
                                    (s.login && s.login.toLowerCase() === username.toLowerCase())
                                )
                            );
                            
                            if (foundUser) {
                                // Verificar se o usuário está aprovado
                                if (foundUser.status === 'Ativo' || foundUser.status === 'ativo') {
                                    // Verificar senha se existir
                                    if (foundUser.password && foundUser.password !== password) {
                                        alert('Senha incorreta.');
                                        return;
                                    }
                                    userFound = foundUser;
                                } else {
                                    alert('Sua conta ainda não foi aprovada. Aguarde a aprovação de um administrador.');
                                    return;
                                }
                            }
                        }
                    }
                    
                    // 4. Verificar se há solicitação aprovada pendente
                    if (!userFound) {
                        const requestsRaw = getData('txd_registration_requests');
                        const requests = Array.isArray(requestsRaw) ? requestsRaw : [];
                        
                        const approvedRequest = requests.find(r => 
                            r && 
                            r.username && 
                            (r.username.toLowerCase() === username.toLowerCase() || 
                             (r.login && r.login.toLowerCase() === username.toLowerCase())) && 
                            r.status === 'approved'
                        );
                        
                        if (approvedRequest) {
                            // Verificar senha
                            if (approvedRequest.password === password) {
                                // Criar usuário a partir da solicitação aprovada diretamente no Supabase
                                const newStaffFromRequest = {
                                    name: approvedRequest.username,
                                    display_name: approvedRequest.displayName || approvedRequest.username,
                                    login: approvedRequest.username,
                                    role: approvedRequest.role || 'Helper', // Cargo padrão
                                    email: approvedRequest.email || null,
                                    status: 'Ativo',
                                    password: approvedRequest.password,
                                    area: approvedRequest.area || '',
                                    game_id: approvedRequest.gameId || null,
                                    discord_id: approvedRequest.discordId || null
                                };
                                
                                // Salvar diretamente no Supabase
                                const { data: savedStaffFromRequest, error: staffErrorFromRequest } = await supabaseClient
                                    .from('staff')
                                    .insert(newStaffFromRequest)
                                    .select();
                                
                                if (staffErrorFromRequest) {
                                    console.error('❌ Erro ao criar staff a partir de solicitação aprovada:', staffErrorFromRequest);
                                } else {
                                    console.log('✅ Staff criado a partir de solicitação aprovada:', savedStaffFromRequest);
                                    // Limpar cache
                                    clearCacheKey('txd_staff');
                                    
                                    // Criar objeto userFound para uso local
                                    userFound = {
                                        id: savedStaffFromRequest[0]?.id || Date.now(),
                                        name: approvedRequest.username,
                                        displayName: approvedRequest.displayName || approvedRequest.username,
                                        role: approvedRequest.role || 'Helper',
                                        email: approvedRequest.email || null,
                                        status: 'Ativo',
                                        password: approvedRequest.password,
                                        createdAt: new Date().toISOString()
                                    };
                                }
                                
                                // Marcar solicitação como processada
                                approvedRequest.status = 'processed';
                                await saveData('txd_registration_requests', requests);
                            } else {
                                alert('Senha incorreta.');
                                return;
                            }
                        } else {
                            // Verificar se há solicitação pendente
                            const pendingRequest = requests.find(r => 
                                r && 
                                r.username && 
                                r.username.toLowerCase() === username.toLowerCase() && 
                                r.status === 'pending'
                            );
                            
                            if (pendingRequest) {
                                alert('Sua solicitação de cadastro ainda está pendente de aprovação. Aguarde a análise de um administrador.');
                                return;
                            }
                            
                            // Se não encontrou nada, informar que precisa se cadastrar
                            alert('Usuário não encontrado. Por favor, crie uma conta primeiro.');
                            return;
                        }
                    }
                    
                    // Definir usuário atual
                    const effectiveRoles = normalizeRoleList(userFound.roles || userFound.role);
                    const primaryRole = userFound.role || effectiveRoles[0] || 'Owner';
                    currentUser = {
                        id: userFound.id || 1,
                        name: userFound.name || userFound.displayName || username,
                        role: primaryRole,
                        roles: effectiveRoles.length > 0 ? effectiveRoles : [primaryRole],
                        email: userFound.email || null,
                        displayName: userFound.displayName || userFound.name || username,
                        status: userFound.status || 'Ativo',
                        login: userFound.login || userFound.name || username,
                        area: userFound.area || null,
                        gameId: userFound.gameId || null,
                        discordId: userFound.discordId || null
                    };

                    // Persistir sessão (não desloga no F5)
                    persistSession(currentUser);
                    try { applyBrandingFromSystemSettings(getSystemSettingsObject()); } catch (e) {}
                    
                    // Aplicar permissões ao menu
                    const permissions = getUserPermissionsForRoles(currentUser.roles || currentUser.role);
                    applyPermissionsToMenu(permissions);
                    renderDevMenuItem();
                    
                    // Mostrar dashboard
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                
                // Inicializar real-time após login
                if (supabaseClient && !realtimeInitialized) {
                    initializeRealtime();
                }
                
                // Recarregar dados do Supabase
                await refreshData();
                
                showSection('inicio');
                
                // Notificar Discord sobre login
                sendDiscordNotification('staff', '🔐 Login Realizado', 
                    `${currentUser?.name || currentUser?.displayName || 'Usuário'} entrou no sistema`,
                    [
                        { name: '👤 Usuário', value: currentUser?.name || currentUser?.displayName || 'Desconhecido', inline: true },
                        { name: '🎖️ Cargo', value: currentUser?.role || 'N/A', inline: true },
                        { name: '🕐 Horário', value: new Date().toLocaleString('pt-BR'), inline: true }
                    ]
                );
                
                // Atualizar badge de notificações
                setTimeout(() => {
                    updateChatNotificationBadge();
                }, 100);
                
                // Verificar notificações periodicamente (a cada 10 segundos)
                setInterval(() => {
                    chatMessages = getData('txd_chat_messages') || [];
                    updateChatNotificationBadge();
                }, 10000);
                    
                } catch (error) {
                    console.error('Erro no login:', error);
                    alert('Erro ao fazer login. Tente novamente.');
                }
            }
        }

        function showRegister() {
            document.getElementById('registerModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');

            // Cleanup específico por modal
            if (modalId === 'pendencyDetailsModal') {
                try { teardownPendencyChat(); } catch (e) {}
            }
        }

        // ========== SISTEMA DE REGISTRO E APROVAÇÃO ==========
        
        async function handleRegister() {
            const form = document.getElementById('registerForm');
            const inputs = form.querySelectorAll('input');
            
            const username = inputs[0].value.trim();
            const displayName = inputs[1].value.trim();
            const password = inputs[2].value;
            const confirmPassword = inputs[3].value;
            
            // Validações
            if (!username || !displayName || !password || !confirmPassword) {
                alert('Por favor, preencha todos os campos.');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('As senhas não coincidem.');
                return;
            }
            
            if (password.length < 4) {
                alert('A senha deve ter pelo menos 4 caracteres.');
                return;
            }
            
            // Verificar se o usuário já existe
            const existingStaff = getData('txd_staff') || [];
            const existingRequest = getData('txd_registration_requests') || [];
            
            if (Array.isArray(existingStaff) && existingStaff.some(s => s && s.name && s.name.toLowerCase() === username.toLowerCase())) {
                alert('Este usuário já está cadastrado no sistema.');
                return;
            }
            
            if (Array.isArray(existingRequest) && existingRequest.some(r => r && r.username && r.username.toLowerCase() === username.toLowerCase() && r.status === 'pending')) {
                alert('Você já possui uma solicitação pendente. Aguarde a aprovação.');
                return;
            }
            
            try {
                // Verificar se Supabase está inicializado
                if (!supabaseClient) {
                    console.error('Supabase não está inicializado!');
                    alert('Erro: Sistema não está conectado ao banco de dados. Recarregue a página.');
                    return;
                }
                
                console.log('Supabase inicializado:', !!supabaseClient);
                
                // Criar solicitação de registro
                const request = {
                    id: Date.now(),
                    username: username,
                    display_name: displayName,
                    password: password, // Em produção, isso deve ser criptografado
                    status: 'pending', // pending, approved, rejected
                    requested_at: new Date().toISOString(),
                    requested_by: username,
                    approved_by: null,
                    approved_at: null,
                    rejection_reason: null
                };
                
                console.log('📝 Criando solicitação:', request);
                console.log('🔍 Tentando salvar no Supabase...');
                console.log('🔗 URL do Supabase:', SUPABASE_URL);
                console.log('📊 Tabela: registration_requests');
                
                // TESTE: Verificar se a tabela existe primeiro
                const { data: testData, error: testError } = await supabaseClient
                    .from('registration_requests')
                    .select('id')
                    .limit(1);
                
                if (testError && (testError.code === 'PGRST116' || testError.message?.includes('does not exist'))) {
                    console.error('❌ TABELA NÃO EXISTE!');
                    alert('❌ ERRO CRÍTICO: A tabela registration_requests não existe no Supabase!\n\nPor favor, execute o SQL de criação da tabela no Supabase SQL Editor.\n\nVerifique o console para mais detalhes.');
                    return;
                }
                
                console.log('✅ Tabela existe. Prosseguindo com inserção...');
                
                // Salvar diretamente no Supabase (não usar saveData que espera array)
                const { data: savedRequest, error: saveError } = await supabaseClient
                    .from('registration_requests')
                    .insert(request)
                    .select();
                
                if (saveError) {
                    console.error('❌ Erro ao salvar solicitação no Supabase:', saveError);
                    console.error('Detalhes do erro:', {
                        code: saveError.code,
                        message: saveError.message,
                        details: saveError.details,
                        hint: saveError.hint
                    });
                    
                    if (saveError.code === 'PGRST116' || saveError.message?.includes('404') || saveError.message?.includes('does not exist')) {
                        alert('❌ Erro: Tabela registration_requests não existe no Supabase.\n\nExecute o SQL de criação da tabela no Supabase SQL Editor.');
                    } else if (saveError.code === '23505' || saveError.message?.includes('duplicate')) {
                        alert('⚠️ Este usuário já possui uma solicitação pendente.');
                    } else {
                        alert(`❌ Erro ao enviar solicitação:\n\n${saveError.message}\n\nVerifique o console para mais detalhes.`);
                    }
                    return;
                }
                
                if (!savedRequest || savedRequest.length === 0) {
                    console.error('⚠️ Solicitação não foi retornada pelo Supabase');
                    alert('⚠️ Solicitação enviada, mas não foi possível confirmar o salvamento. Verifique o painel de controle.');
                } else {
                    console.log('✅ Solicitação salva com sucesso:', savedRequest);
                }
                
                // Limpar cache para forçar refresh
                clearCacheKey('txd_registration_requests');
                
                // Verificar se a solicitação foi realmente salva
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Tentar buscar a solicitação recém-criada para confirmar
                const { data: verifyData, error: verifyError } = await supabaseClient
                    .from('registration_requests')
                    .select('*')
                    .eq('username', username)
                    .eq('status', 'pending')
                    .order('requested_at', { ascending: false })
                    .limit(1);
                
                if (verifyError) {
                    console.warn('⚠️ Não foi possível verificar a solicitação:', verifyError);
                } else if (verifyData && verifyData.length > 0) {
                    console.log('✅ Solicitação confirmada no banco:', verifyData[0]);
                } else {
                    console.warn('⚠️ Solicitação não encontrada após salvar. Pode levar alguns segundos para aparecer.');
                }
                
                // Notificar Discord
                try {
                    sendDiscordNotification('staff', '📝 Nova Solicitação de Cadastro', 
                        `Nova solicitação de cadastro recebida`,
                        [
                            { name: '👤 Usuário', value: username, inline: true },
                            { name: '📛 Nome', value: displayName, inline: true },
                            { name: '🕐 Data', value: new Date().toLocaleString('pt-BR'), inline: true },
                            { name: '⚠️ Ação Necessária', value: 'Aprovar ou rejeitar no painel administrativo', inline: false }
                        ]
                    );
                } catch (discordError) {
                    console.warn('Erro ao notificar Discord:', discordError);
                }
                
                // Fechar modal e mostrar mensagem
                closeModal('registerModal');
                
                // Mostrar mensagem de sucesso com detalhes
                const successMsg = `✅ Solicitação de cadastro enviada com sucesso!

👤 Usuário: ${username}
📛 Nome: ${displayName}
🕐 Data: ${new Date().toLocaleString('pt-BR')}

Aguarde a aprovação de um administrador. Você receberá uma notificação quando sua solicitação for analisada.

💡 Dica: Um administrador pode ver sua solicitação na seção "Controle" do painel.`;
                
                alert(successMsg);
                
                // Limpar formulário
                form.reset();
                
                // Forçar refresh imediato do painel de controle se estiver aberto
                if (currentSection === 'controle') {
                    console.log('🔄 Recarregando painel de controle...');
                    setTimeout(async () => {
                        await loadStaffControl();
                        console.log('✅ Painel recarregado');
                    }, 1000);
                }
                
                // Notificar qualquer admin logado via real-time (já está configurado)
                console.log('📢 Solicitação salva. Real-time deve notificar admins automaticamente.');
                
            } catch (error) {
                console.error('❌ Erro ao criar solicitação:', error);
                console.error('Stack trace:', error.stack);
                alert(`❌ Erro ao enviar solicitação:\n\n${error.message || 'Erro desconhecido'}\n\nVerifique o console para mais detalhes.`);
            }
        }

        function showTerms() {
            // Validar formulário antes de mostrar termos
            const form = document.getElementById('registerForm');
            const inputs = form.querySelectorAll('input');
            
            const username = inputs[0].value.trim();
            const displayName = inputs[1].value.trim();
            const password = inputs[2].value;
            const confirmPassword = inputs[3].value;
            
            if (!username || !displayName || !password || !confirmPassword) {
                alert('Por favor, preencha todos os campos antes de prosseguir.');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('As senhas não coincidem.');
                return;
            }
            
            closeModal('registerModal');
            document.getElementById('termsModal').classList.add('active');
        }

        function toggleConfirmButton() {
            const checkbox = document.getElementById('termAgree');
            const confirmBtn = document.getElementById('confirmTermBtn');
            confirmBtn.disabled = !checkbox.checked;
        }

        async function acceptTerms() {
            // Processar registro após aceitar termos
            await handleRegister();
            closeModal('termsModal');
        }

        function logout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                clearPersistedSession();
                // Notificar Discord sobre logout
                sendDiscordNotification('staff', '🚪 Logout Realizado', 
                    `${currentUser.name} saiu do sistema`,
                    [
                        { name: '👤 Usuário', value: currentUser.name, inline: true },
                        { name: '🎖️ Cargo', value: currentUser.role, inline: true },
                        { name: '🕐 Horário', value: new Date().toLocaleString('pt-BR'), inline: true }
                    ]
                );
                
                document.getElementById('dashboard').classList.remove('active');
                document.getElementById('loginScreen').style.display = 'flex';
                // Limpar formulário
                document.getElementById('loginForm').reset();
            }
        }

        // ========== NAVEGAÇÃO ==========
        function showSection(section) {
            // Atualizar seção atual para real-time
            currentSection = section;

            // Ao abrir a seção, limpar badges relacionados (notificações in-app)
            try {
                if (section === 'pendencias' || section === 'formularios') {
                    clearSectionBadge('pendencias');
                }
                if (section === 'tarefas') {
                    clearSectionBadge('tarefas');
                }
            } catch (e) {}
            
            // Validar permissões antes de exibir a seção
            if (!canAccess(section)) {
                // Mostrar mensagem de acesso negado
                const contentCard = document.querySelector('.content-card');
                if (contentCard) {
                    contentCard.innerHTML = `
                        <div style="text-align: center; padding: 48px 24px;">
                            <div style="font-size: 64px; margin-bottom: 24px;">🔒</div>
                            <h1 style="color: var(--white-soft); margin-bottom: 16px;">Acesso não autorizado</h1>
                            <p style="color: var(--gray-light); margin-bottom: 32px;">
                                Você não tem permissão para acessar esta seção.
                            </p>
                            <p style="color: var(--gray-text); font-size: 14px;">
                                Cargo atual: <strong>${currentUser?.role || 'N/A'}</strong>
                            </p>
                            <button class="btn btn-primary" onclick="showSection('inicio')" style="margin-top: 24px;">
                                <i class="fas fa-home"></i> Voltar ao Início
                            </button>
                        </div>
                    `;
                }
                
                // Atualizar título (se existir no DOM atual)
                const titleElDenied = document.getElementById('sectionTitle');
                if (titleElDenied) titleElDenied.textContent = 'Acesso Negado';
                
                // Atualizar menu ativo (remover ativo de todos)
                document.querySelectorAll('.nav-menu a').forEach(link => {
                    link.classList.remove('active');
                });

                // Limpar contexto do navbar
                updateNavbarContext('');
                
                return; // Bloquear acesso
            }
            
            const titles = {
                'inicio': 'Início',
                'tarefas': 'Tarefas - Kanban',
                'chat': '💬 Chat',
                'ranking': '📊 Ranking',
                'conquistas': '🏆 Conquistas',
                'estatisticas': '📊 Estatísticas',
                'comandos': 'Comandos',
                'controle': 'Controle de Staff',
                'areas': 'Áreas de Responsabilidade',
                'advertencias': 'Gestão de Advertências',
                'agenda': 'Agenda da Equipe',
                'formularios': 'Pendências',
                'pendencias': 'Pendências',
                'dev_backlog': 'DEV - Tarefas',
                'dev_create': 'DEV - Criar Tarefa',
                'dev_detail': 'DEV - Detalhe da Tarefa',
                'relatorios': 'Relatórios de Reunião',
                'votacoes': '🗳️ Votações',
                'config': 'Configurações do Sistema'
            };
            const titleEl = document.getElementById('sectionTitle');
            if (titleEl) titleEl.textContent = titles[section] || 'Painel TXD Staff';
            
            // Atualizar menu ativo
            document.querySelectorAll('.nav-menu a').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(section)) {
                    link.classList.add('active');
                }
            });

            // Contexto no navbar (ex: "Relatório:")
            updateNavbarContext(section);
        }

        function updateNavbarContext(section) {
            const el = document.getElementById('navbarContextLabel');
            if (!el) return;
            if (section === 'relatorios') {
                el.textContent = 'Relatório:';
                el.classList.remove('hidden');
            } else {
                el.textContent = '';
                el.classList.add('hidden');
            }
        }

        // ========== FUNCIONALIDADES ==========
        
        // ========== SISTEMA DE PERMISSÕES POR CARGO (RBAC) - PASSO 2 ==========
        
        // Mapeamento de seções do menu para permissões
        const SECTION_PERMISSIONS = {
            'inicio': '*', // Sempre acessível
            'tarefas': 'dashboard',
            'chat': 'chat', // Chat específico ou suporte
            'ranking': 'dashboard',
            'conquistas': 'dashboard',
            'estatisticas': 'dashboard',
            'comandos': 'comandos',
            'controle': 'staff', // Staff ou staff_area
            'areas': 'area', // Area ou staff_area
            'advertencias': 'moderacao',
            'agenda': 'dashboard',
            'formularios': '*', // Compatibilidade: redireciona para Pendências
            'dev_backlog': 'dev_area',
            'dev_create': 'dev_area',
            'dev_detail': 'dev_area',
            'pendencias': '*', // Todos podem solicitar pendências
            'votacoes': '*', // Acesso geral; quem vota é definido na votação
            'relatorios': 'relatorios',
            'perfil': '*', // Todos podem acessar seu próprio perfil
            'config': 'sistema' // Sistema, config ou logs
        };

        // Permissões por cargo (formato simplificado conforme prompt)
        const ROLE_PERMISSIONS = {
            // Sistema Principal (C-Level) - Todos com acesso total
            'Owner': ['*', 'dev_area'],
            'CEO': ['*', 'dev_area'],
            'COO': ['*', 'dev_area'],
            'CMO': ['*', 'dev_area'],
            'CCO': ['*', 'dev_area'],
            'CIO': ['*', 'dev_area'],
            
            // Sistema Secundário (Operacional)
            'HeadStaff': ['dashboard', 'staff', 'pendencias', 'moderacao'],
            'Diretor': ['dashboard', 'area'],
            'Coordenador': ['pendencias', 'staff_area'],
            'Admin': ['pendencias', 'moderacao', 'comandos'],
            'Moderador': ['pendencias', 'moderacao'],
            'Suporte': ['pendencias'],
            'Helper': ['pendencias_basico'],
            // DEV com acesso total às abas (visualização), além da área DEV
            'Dev': ['*', 'dev_area']
        };

        // Persistência local de cargos/permissões (evita perder ao recarregar)
        const ROLE_PERMISSIONS_LOCAL_KEY = 'txd_role_permissions_v1';
        const ROLE_PERMISSIONS_DEFAULT = (() => {
            try { return JSON.parse(JSON.stringify(ROLE_PERMISSIONS)); } catch (e) { return {}; }
        })();

        function normalizeRolePermissionsObject(input) {
            const obj = (input && typeof input === 'object' && !Array.isArray(input)) ? input : {};
            const out = {};
            Object.keys(obj).forEach(role => {
                const perms = obj[role];
                if (!role || typeof role !== 'string') return;
                if (!Array.isArray(perms)) return;
                const cleaned = perms
                    .map(p => (p ?? '').toString().trim())
                    .filter(Boolean);
                out[role] = Array.from(new Set(cleaned));
            });
            return out;
        }

        function loadRolePermissionsFromLocal() {
            try {
                const raw = localStorage.getItem(ROLE_PERMISSIONS_LOCAL_KEY);
                if (!raw) return;
                const parsed = JSON.parse(raw);
                const saved = normalizeRolePermissionsObject(parsed);
                // aplica override + novos cargos
                Object.keys(saved).forEach(role => {
                    ROLE_PERMISSIONS[role] = saved[role];
                });
            } catch (e) {}
        }

        function saveRolePermissionsToLocal() {
            try {
                const snapshot = normalizeRolePermissionsObject(ROLE_PERMISSIONS);
                localStorage.setItem(ROLE_PERMISSIONS_LOCAL_KEY, JSON.stringify(snapshot));
            } catch (e) {}
        }

        function resetRolePermissionsToDefault() {
            try {
                // remove cargos não-default
                Object.keys(ROLE_PERMISSIONS).forEach(role => {
                    if (!Object.prototype.hasOwnProperty.call(ROLE_PERMISSIONS_DEFAULT, role)) {
                        delete ROLE_PERMISSIONS[role];
                    }
                });
                // restaura defaults
                Object.keys(ROLE_PERMISSIONS_DEFAULT).forEach(role => {
                    ROLE_PERMISSIONS[role] = Array.isArray(ROLE_PERMISSIONS_DEFAULT[role])
                        ? [...ROLE_PERMISSIONS_DEFAULT[role]]
                        : [];
                });
                saveRolePermissionsToLocal();
            } catch (e) {}
        }

        // Aplica roles salvos logo ao carregar o script
        loadRolePermissionsFromLocal();

        // Usuário atual (será definido no login)
        let currentUser = { role: 'Owner', roles: ['Owner'], name: 'Admin', id: 1 };

        // ========== FUNÇÕES DE PERMISSÕES ==========

        function normalizeRoleList(roleOrRoles) {
            if (Array.isArray(roleOrRoles)) {
                return roleOrRoles
                    .map(r => (r ?? '').toString().trim())
                    .filter(Boolean);
            }
            const raw = (roleOrRoles ?? '').toString().trim();
            if (!raw) return [];
            // Suporta formatos antigos (ex: "Owner, Dev")
            if (raw.includes(',')) {
                return raw
                    .split(',')
                    .map(s => s.trim())
                    .filter(Boolean);
            }
            return [raw];
        }

        function canonicalizeRoleKey(role) {
            const raw = (role ?? '').toString().trim();
            if (!raw) return '';
            if (ROLE_PERMISSIONS[raw]) return raw;
            const noSpaces = raw.replace(/\s+/g, '');
            if (ROLE_PERMISSIONS[noSpaces]) return noSpaces;
            return raw;
        }
        
        /**
         * Obtém as permissões do cargo do usuário
         * @param {string} role - Cargo do usuário
         * @returns {Array} Array de permissões
         */
        function getUserPermissions(role) {
            if (!role) return [];
            const key = canonicalizeRoleKey(role);
            return ROLE_PERMISSIONS[key] || [];
        }

        function getUserPermissionsForRoles(roleOrRoles) {
            const roles = normalizeRoleList(roleOrRoles);
            const out = new Set();
            for (const r of roles) {
                for (const p of getUserPermissions(r)) out.add(p);
            }
            return Array.from(out);
        }

        function isDevRole(role) {
            return normalizeRoleList(role).some(r => (r || '').toString().toLowerCase() === 'dev');
        }

        function isCLevelRole(role) {
            return normalizeRoleList(role).some(r => {
                const normalized = (r || '').toString().toLowerCase();
                return ['owner', 'ceo', 'coo', 'cmo', 'cco', 'cio', 'c_level'].includes(normalized);
            });
        }

        function getPendencyScope(type) {
            const normalized = (type || '').toString().toLowerCase();
            if (['doacoes'].includes(normalized)) return 'financial';
            if (['bugs', 'mapas', 'carros', 'roupas', 'itens', 'coordenadas', 'logs', 'atualizacoes', 'desenvolvimento'].includes(normalized)) return 'dev';
            return 'general';
        }

        function isFinancialPendencyType(type) {
            return getPendencyScope(type) === 'financial';
        }

        /**
         * Verifica se o usuário tem acesso a uma seção específica
         * @param {string} section - Nome da seção (ex: 'tarefas', 'controle')
         * @returns {boolean} true se tem acesso, false caso contrário
         */
        function canAccess(section) {
            if (!currentUser || (!currentUser.role && !currentUser.roles)) {
                return false;
            }

            // Seção 'inicio' sempre acessível
            if (section === 'inicio') {
                return true;
            }

            const userPermissions = getUserPermissionsForRoles(currentUser.roles || currentUser.role);

            // DEV também pode visualizar a seção "Tarefas" (Kanban) sem precisar de permissão "dashboard"
            // (mantém as regras de criar/editar/excluir controladas por hasPermission('task.*') onde aplicável)
            if (section === 'tarefas' && (isDevRole(currentUser.roles || currentUser.role) || userPermissions.includes('dev_area'))) {
                return true;
            }
            
            // Obter permissão necessária para a seção
            const requiredPermission = SECTION_PERMISSIONS[section];
            if (!requiredPermission) {
                return false; // Seção não mapeada, negar acesso por segurança
            }

            if (requiredPermission === 'dev_area') {
                return userPermissions.includes('*') || userPermissions.includes('dev_area') || isDevRole(currentUser.roles || currentUser.role);
            }

            // Se tem '*', tem acesso total (exceto regras especiais como dev_area acima)
            if (userPermissions.includes('*')) {
                return true;
            }

            // Se a seção requer '*', verificar casos especiais
            if (requiredPermission === '*') {
                // Seções sempre acessíveis para usuários autenticados
                if (section === 'perfil' || section === 'pendencias' || section === 'formularios') {
                    return true;
                }
                // Para outras seções com '*', apenas usuários com '*' podem acessar
                return userPermissions.includes('*');
            }

            // Verificar se tem a permissão específica ou uma permissão relacionada
            // Mapeamento flexível para permissões relacionadas
            const permissionMap = {
                'dashboard': ['dashboard'],
                'staff': ['staff', 'staff_area'],
                'pendencias': ['pendencias', 'pendencias_basico', 'suporte'],
                'moderacao': ['moderacao'],
                'comandos': ['comandos'],
                'relatorios': ['relatorios'],
                'sistema': ['sistema', 'config', 'logs'],
                'dev_area': ['dev_area'],
                'area': ['area', 'staff_area'],
                'marketing': ['marketing'],
                'chat': ['chat', 'suporte', 'dashboard'], // Chat pode ser acessado por suporte ou dashboard
                'pendencias_basico': ['pendencias_basico', 'pendencias', 'suporte']
            };

            // Verificar permissão direta
            if (userPermissions.includes(requiredPermission)) {
                return true;
            }

            // Verificar permissões relacionadas
            const relatedPermissions = permissionMap[requiredPermission] || [];
            return relatedPermissions.some(perm => userPermissions.includes(perm));
        }

        /**
         * Aplica permissões ao menu, ocultando itens não permitidos
         * @param {Array} permissions - Array de permissões do usuário
         */
        function applyPermissionsToMenu(permissions) {
            const menuItems = document.querySelectorAll('.nav-menu li');
            
            menuItems.forEach(item => {
                const link = item.querySelector('a');
                if (!link) return;

                // Extrair nome da seção do onclick
                const onclickAttr = link.getAttribute('onclick');
                if (!onclickAttr) return;

                const sectionMatch = onclickAttr.match(/showSection\(['"]([^'"]+)['"]\)/);
                if (!sectionMatch) return;

                const section = sectionMatch[1];
                
                // Verificar se tem acesso
                if (!canAccess(section)) {
                    item.classList.add('hidden');
                } else {
                    item.classList.remove('hidden');
                }
            });
        }

        // Renderiza a aba DEV para quem possui acesso à área DEV
        function canShowDevMenu() {
            return canAccess('dev_backlog');
        }

        function renderDevMenuItem() {
            const navMenu = document.querySelector('.nav-menu');
            if (!navMenu) return;

            // Remover DEV se existir
            const existing = document.getElementById('devMenuItem');
            if (existing) existing.remove();

            if (!canShowDevMenu()) return;

            const li = document.createElement('li');
            li.className = '';
            li.id = 'devMenuItem';

            li.innerHTML = `
                <a href="#" onclick="showSection('dev_backlog'); return false;">Dev</a>
            `;

            // Inserir DEV após Agenda (se existir); senão, antes de Pendências; senão, no final
            const agendaLink = Array.from(navMenu.querySelectorAll('a'))
                .find(link => (link.getAttribute('onclick') || '').includes("agenda"));
            if (agendaLink && agendaLink.parentElement) {
                agendaLink.parentElement.after(li);
                return;
            }
            const pendenciasLink = Array.from(navMenu.querySelectorAll('a'))
                .find(link => (link.getAttribute('onclick') || '').includes("pendencias"));
            if (pendenciasLink && pendenciasLink.parentElement) {
                pendenciasLink.parentElement.before(li);
                return;
            }
            navMenu.appendChild(li);
        }

        // Menus dropdown removidos do header (DEV/Estatísticas)

        // Função de compatibilidade para código existente que usa hasPermission
        function hasPermission(action) {
            if (!currentUser || (!currentUser.role && !currentUser.roles)) {
                return false;
            }
            
            const userPermissions = getUserPermissionsForRoles(currentUser.roles || currentUser.role);
            
            // Se tem '*', tem todas as permissões
            if (userPermissions.includes('*')) {
                return true;
            }
            
            // Mapeamento de ações antigas para novas permissões
            const actionToPermissionMap = {
                'task.create': 'dashboard',
                'task.edit': 'dashboard',
                'task.delete': 'dashboard',
                'task.view': 'dashboard',
                // Permitir tarefas para todos que têm acesso ao dashboard ou qualquer permissão
                'tasks': 'dashboard',
                'staff.view': 'staff',
                'staff.create': 'staff',
                'staff.edit': 'staff',
                'staff.delete': 'staff',
                'pendency.view': 'pendencias',
                'pendency.create': 'pendencias',
                'pendency.edit': 'pendencias',
                'pendency.resolve': 'pendencias',
                'system.config': 'sistema',
                'system.logs': 'sistema',
                'warning.view': 'moderacao',
                'warning.create': 'moderacao',
                'form.view': 'pendencias',
                'area.view': 'area',
                'area.create': 'area',
                'area.edit': 'area',
                'report.view': 'relatorios',
                'report.create': 'relatorios',
                'event.view': 'dashboard',
                'event.create': 'dashboard',
                'announcement.view': 'dashboard',
                'announcement.create': 'dashboard'
            };

            const mappedPermission = actionToPermissionMap[action];
            if (mappedPermission) {
                return userPermissions.includes(mappedPermission) || 
                       userPermissions.includes('*') ||
                       (mappedPermission === 'pendencias' && userPermissions.includes('pendencias_basico')) ||
                       (mappedPermission === 'staff' && userPermissions.includes('staff_area')) ||
                       (mappedPermission === 'area' && userPermissions.includes('staff_area'));
            }

            return false;
        }

        // Verificar múltiplas permissões (todas devem ser verdadeiras)
        function hasAllPermissions(...actions) {
            return actions.every(action => hasPermission(action));
        }

        // Verificar se tem pelo menos uma das permissões
        function hasAnyPermission(...actions) {
            return actions.some(action => hasPermission(action));
        }

        // Obter todas as permissões do cargo atual (compatibilidade)
        function getCurrentUserPermissions() {
            return getUserPermissionsForRoles(currentUser?.roles || currentUser?.role);
        }

        // Obter permissões de um cargo específico
        function getRolePermissions(role) {
            return getUserPermissions(role);
        }

        // Verificar se pode executar ação e mostrar erro se não puder
        function requirePermission(action, errorMessage = 'Você não tem permissão para realizar esta ação.') {
            if (!hasPermission(action)) {
                alert(errorMessage);
                return false;
            }
            return true;
        }

        // Função para verificar permissões quando cargo muda
        function checkPermissions() {
            const role = document.getElementById('staffRole')?.value;
            const extras = Array.from(document.getElementById('staffExtraRoles')?.selectedOptions || []).map(o => o.value);
            const roles = [role, ...extras].filter(Boolean);
            if (roles.length > 0) {
                const perms = getUserPermissionsForRoles(roles);
                const roleDesc = perms.includes('*') ? 'Acesso total' : `${perms.length} permissões`;
                console.log(`Permissões (cargos: ${roles.join(' + ')}):`, perms);
                console.log(`Descrição: ${roleDesc}`);
            }
        }

        // ========== GERENCIAMENTO DE DADOS (Supabase) ==========
        // Funções getData e saveData estão definidas acima (usando Supabase)

        // Inicializar dados (valores padrão - serão atualizados pelo refreshData)
        let staffData = dataCache['txd_staff'] || [
            { id: 1, name: 'João Silva', role: 'Owner', area: 'Administração', status: 'Ativo', email: 'joao@txd.com' },
            { id: 2, name: 'Maria Santos', role: 'CEO', area: 'Administração', status: 'Ativo', email: 'maria@txd.com' },
            { id: 3, name: 'Pedro Costa', role: 'Head Staff', area: 'Moderação', status: 'Ativo', email: 'pedro@txd.com' }
        ];

        let eventsData = dataCache['txd_events'] || [];
        let announcementsData = dataCache['txd_announcements'] || [];

        // Carregar dados do Supabase ao iniciar
        refreshData();

        // Função para carregar conteúdo das seções
        function loadSectionContent(section) {
            const contentCard = document.querySelector('.content-card');
            
            switch(section) {
                case 'inicio':
                    loadDashboard();
                    break;
                case 'tarefas':
                    loadKanban();
                    break;
                case 'estatisticas':
                    loadRanking();
                    break;
                case 'ranking':
                    loadRanking();
                    break;
                case 'conquistas':
                    loadAchievements();
                    break;
                case 'controle':
                    loadStaffControl();
                    break;
                case 'comandos':
                    loadCommands();
                    break;
                case 'agenda':
                    loadAgenda();
                    break;
                case 'formularios':
                    loadPendencies();
                    break;
                case 'dev_backlog':
                    loadDevBacklog();
                    break;
                case 'dev_create':
                    loadDevCreate();
                    break;
                case 'dev_detail':
                    loadDevDetail();
                    break;
                case 'relatorios':
                    loadReports();
                    break;
                case 'advertencias':
                    loadWarnings();
                    break;
                case 'areas':
                    loadAreas();
                    break;
                case 'pendencias':
                    loadPendencies();
                    break;
                case 'perfil':
                    loadPerfil();
                    break;
                case 'config':
                    loadSettings();
                    break;
                case 'votacoes':
                    loadVotacoes();
                    break;
            }
        }

        async function loadDashboard() {
            // Carregar dados em background (não bloqueia renderização)
            loadSectionData('inicio').catch(() => {});
            
            // Obter nome do usuário
            const userName = currentUser?.name || currentUser?.displayName || 'Staff';

            const systemSettings = getSystemSettingsObject();
            const globalMessage = (systemSettings?.globalMessage || '').toString().trim();
            
            // Buscar atividades recentes (logs do sistema)
            const logsData = getData('txd_system_logs') || [];
            const recentActivities = Array.isArray(logsData) 
                ? logsData.slice(0, 5).reverse() 
                : [];
            
            const content = `
                ${globalMessage ? `
                <div style="background: rgba(0, 168, 255, 0.10); border: 1px solid rgba(0, 168, 255, 0.35); border-radius: 12px; padding: 16px 18px; margin-bottom: 26px;">
                    <div style="display:flex; align-items:center; gap: 10px; color: var(--white-soft); font-weight: 800;">
                        <i class="fas fa-bullhorn" style="color: var(--primary);"></i> Mensagem do sistema
                    </div>
                    <div style="margin-top: 8px; color: var(--gray-very-light); font-size: 14px; white-space: pre-wrap; line-height: 1.5;">
                        ${escapeHtml(globalMessage)}
                    </div>
                </div>
                ` : ''}
                <!-- HERO -->
                <div style="margin-bottom: 48px;">
                    <h1 id="sectionTitle" style="font-size: 36px; font-weight: 700; color: var(--white-soft); margin-bottom: 12px; line-height: 1.2;">
                        Bem-vindo, ${userName}
                    </h1>
                    <p style="font-size: 18px; color: var(--gray-light); margin-bottom: 8px; line-height: 1.5;">
                        Central de gerenciamento da staff TXD. Controle, organização e autoridade em um só lugar.
                    </p>
                    <p style="font-size: 14px; color: var(--gray-text); line-height: 1.6;">
                        Este painel centraliza todas as ferramentas necessárias para gerenciar a equipe, monitorar atividades e manter a ordem institucional.
                    </p>
                </div>
                
                <!-- AÇÕES RÁPIDAS -->
                <div style="margin-bottom: 48px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: var(--white-soft); margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-bolt" style="color: var(--warning);"></i>
                        Ações Rápidas
                    </h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                        ${hasPermission('event.create') ? `
                        <div class="action-card" onclick="openNewEvent()" style="background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;" 
                             onmouseenter="this.style.borderColor='var(--warning)'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(255, 170, 0, 0.15)';" 
                             onmouseleave="this.style.borderColor='var(--gray-border)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <div style="font-size: 32px; margin-bottom: 16px;">📅</div>
                            <h3 style="font-size: 18px; font-weight: 600; color: var(--white-soft); margin-bottom: 8px;">Criar Evento</h3>
                            <p style="font-size: 14px; color: var(--gray-light); line-height: 1.5;">Agende eventos, reuniões e atividades da staff com data, hora e descrição completa.</p>
                        </div>
                        ` : ''}
                        ${hasPermission('announcement.create') ? `
                        <div class="action-card" onclick="openAnnouncement()" style="background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;" 
                             onmouseenter="this.style.borderColor='var(--warning)'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(255, 170, 0, 0.15)';" 
                             onmouseleave="this.style.borderColor='var(--gray-border)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <div style="font-size: 32px; margin-bottom: 16px;">📢</div>
                            <h3 style="font-size: 18px; font-weight: 600; color: var(--white-soft); margin-bottom: 8px;">Enviar Aviso Geral</h3>
                            <p style="font-size: 14px; color: var(--gray-light); line-height: 1.5;">Comunique-se com toda a equipe através de avisos importantes e notificações gerais.</p>
                        </div>
                        ` : ''}
                        ${hasPermission('staff.manage') || hasPermission('staff') ? `
                        <div class="action-card" onclick="showSection('controle')" style="background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;" 
                             onmouseenter="this.style.borderColor='var(--warning)'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(255, 170, 0, 0.15)';" 
                             onmouseleave="this.style.borderColor='var(--gray-border)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <div style="font-size: 32px; margin-bottom: 16px;">👥</div>
                            <h3 style="font-size: 18px; font-weight: 600; color: var(--white-soft); margin-bottom: 8px;">Gerenciar Staff</h3>
                            <p style="font-size: 14px; color: var(--gray-light); line-height: 1.5;">Visualize, edite e gerencie membros da equipe, permissões e status de cada membro.</p>
                        </div>
                        ` : ''}
                        ${hasPermission('warning.create') || hasPermission('moderation') ? `
                        <div class="action-card" onclick="showSection('advertencias')" style="background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;" 
                             onmouseenter="this.style.borderColor='var(--warning)'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(255, 170, 0, 0.15)';" 
                             onmouseleave="this.style.borderColor='var(--gray-border)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <div style="font-size: 32px; margin-bottom: 16px;">⚠️</div>
                            <h3 style="font-size: 18px; font-weight: 600; color: var(--white-soft); margin-bottom: 8px;">Aplicar Advertência</h3>
                            <p style="font-size: 14px; color: var(--gray-light); line-height: 1.5;">Registre advertências e medidas disciplinares aplicadas aos membros da equipe.</p>
                        </div>
                        ` : ''}
                        ${hasPermission('reports') || hasPermission('dashboard') ? `
                        <div class="action-card" onclick="loadReports()" style="background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;" 
                             onmouseenter="this.style.borderColor='var(--warning)'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(255, 170, 0, 0.15)';" 
                             onmouseleave="this.style.borderColor='var(--gray-border)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <div style="font-size: 32px; margin-bottom: 16px;">📊</div>
                            <h3 style="font-size: 18px; font-weight: 600; color: var(--white-soft); margin-bottom: 8px;">Ver Relatórios</h3>
                            <p style="font-size: 14px; color: var(--gray-light); line-height: 1.5;">Acesse relatórios detalhados de atividades, desempenho e estatísticas do sistema.</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- STATUS DO SISTEMA -->
                <div style="margin-bottom: 48px;">
                    <div style="background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 12px; padding: 24px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--success); box-shadow: 0 0 8px rgba(0, 255, 136, 0.5);"></div>
                            <h3 style="font-size: 18px; font-weight: 600; color: var(--white-soft);">Status do Sistema</h3>
                        </div>
                        <p style="font-size: 15px; color: var(--gray-light); line-height: 1.6; margin: 0;">
                            Nenhuma ação crítica necessária no momento.
                        </p>
                    </div>
                </div>
                
                <!-- ATIVIDADES RECENTES -->
                <div style="margin-bottom: 48px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: var(--white-soft); margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-clock" style="color: var(--gray-text);"></i>
                        Atividades Recentes
                    </h2>
                    ${recentActivities.length > 0 ? `
                    <div style="background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 12px; padding: 20px;">
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            ${recentActivities.map(activity => {
                                const actionIcon = activity.action?.includes('Login') ? '🔐' : 
                                                  activity.action?.includes('Criar') ? '➕' : 
                                                  activity.action?.includes('Editar') ? '✏️' : 
                                                  activity.action?.includes('Excluir') ? '🗑️' : 
                                                  activity.action?.includes('Aprovar') ? '✅' : '📝';
                                const timestamp = activity.timestamp || activity.created_at || new Date().toISOString();
                                const date = new Date(timestamp);
                                const formattedDate = date.toLocaleString('pt-BR', { 
                                    day: '2-digit', 
                                    month: '2-digit', 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                });
                                return `
                                <div style="display: flex; align-items: start; gap: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--gray-border);">
                                    <div style="font-size: 20px; flex-shrink: 0;">${actionIcon}</div>
                                    <div style="flex: 1;">
                                        <p style="color: var(--white-soft); font-size: 14px; margin-bottom: 4px; line-height: 1.5;">
                                            ${activity.action || 'Ação do sistema'}
                                        </p>
                                        <p style="color: var(--gray-text); font-size: 12px;">
                                            ${formattedDate} ${activity.module ? `• ${activity.module}` : ''}
                                        </p>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ` : `
                    <div style="background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 12px; padding: 40px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">📋</div>
                        <p style="color: var(--gray-text); font-size: 14px;">
                            Nenhuma atividade recente registrada.
                        </p>
                    </div>
                    `}
                </div>
                
                <!-- IDENTIDADE -->
                <div style="margin-top: 64px; padding-top: 32px; border-top: 1px solid var(--gray-border); text-align: center;">
                    <p style="color: var(--gray-text); font-size: 14px; font-style: italic; line-height: 1.6;">
                        TXD Staff System — Disciplina gera respeito. Organização gera poder.
                    </p>
                </div>
            `;
            document.querySelector('.content-card').innerHTML = content;
            try { filterPendencies(); } catch (e) {}
        }

        // ========== KANBAN: FILTROS POR RESPONSÁVEL ==========
        let kanbanFilters = { assignee: 'all' };

        function getCardAssigneeList(card) {
            if (!card) return [];
            const assignees = card.assignees ?? card.assignee ?? [];
            if (Array.isArray(assignees)) {
                return assignees.filter(a => a !== null && a !== undefined && String(a).trim() !== '');
            }
            if (assignees) {
                return [assignees];
            }
            return [];
        }

        function formatAssigneesDisplay(card) {
            const list = getCardAssigneeList(card).map(a => String(a).trim()).filter(Boolean);
            if (list.length === 0) return '';
            if (list.length <= 2) return list.join(', ');
            return `${list.slice(0, 2).join(', ')} +${list.length - 2}`;
        }

        function matchesAssignee(card, assigneeName) {
            if (!assigneeName) return true;
            const target = String(assigneeName).toLowerCase().trim();
            if (!target) return true;
            const list = getCardAssigneeList(card).map(a => String(a).toLowerCase().trim());
            return list.some(a => a === target);
        }

        function getKanbanFilterLabel(filterValue, currentUserLabel) {
            if (filterValue === 'mine') return `Minhas tarefas (${currentUserLabel || 'Usuário'})`;
            if (filterValue === 'unassigned') return 'Sem responsável';
            if (filterValue && filterValue !== 'all') return `Responsável: ${filterValue}`;
            return 'Todas as tarefas';
        }

        function setKanbanAssigneeFilter(value) {
            kanbanFilters.assignee = value || 'all';
            loadKanban();
        }

        async function loadKanban() {
            const navSeq = activeNavSeq;
            try { renderSectionLoading('📌 Tarefas'); } catch (e) {}
            await nextFrame();

            // Aquecer dados em paralelo (melhora troca de abas)
            const [staffRows] = await Promise.all([
                getData('txd_staff', false),
                ensureKanbanLoaded(false)
            ]).then(r => [r[0]]);
            if (navSeq !== activeNavSeq) return;
            if (Array.isArray(staffRows)) staffData = staffRows;

            // Renderizar a partir do state único (evita duplicação e permite realtime sem reload)
            let kanbanData = getKanbanSnapshotFromState();
            
            // Validações robustas para garantir que os dados estão corretos
            if (!kanbanData) {
                kanbanData = {
                    columns: [],
                    cards: []
                };
            }
            
            // Garantir que cards é um array
            if (!Array.isArray(kanbanData.cards)) {
                kanbanData.cards = [];
            }
            
            // Garantir que columns é um array
            if (!Array.isArray(kanbanData.columns)) {
                kanbanData.columns = [
                    { id: 'todo', name: 'Para Fazer', color: '#6F7276' },
                    { id: 'inprogress', name: 'Em Progresso', color: '#ffaa00' },
                    { id: 'review', name: 'Em Revisão', color: '#3b82f6' },
                    { id: 'done', name: 'Concluído', color: '#00ff88' }
                ];
            }
            
            // Se não há colunas, criar padrão (mas NÃO salvar automaticamente para evitar loop)
            if (kanbanData.columns.length === 0) {
                kanbanData.columns = [
                    { id: 'todo', name: 'Para Fazer', color: '#6F7276' },
                    { id: 'inprogress', name: 'Em Progresso', color: '#ffaa00' },
                    { id: 'review', name: 'Em Revisão', color: '#3b82f6' },
                    { id: 'done', name: 'Concluído', color: '#00ff88' }
                ];
                // Salvar colunas padrão em background (não bloqueia navegação)
                saveData('txd_kanban', kanbanData).catch(() => {});
            }
            
            // NÃO chamar saveKanbanData() aqui para evitar loop infinito com real-time
            
            // Permitir acesso básico ao Kanban para todos os usuários logados
            // Se não tiver permissão específica, permitir visualização e criação básica
            const canCreate = hasPermission('task.create') || hasPermission('dashboard') || (currentUser && currentUser.role);
            const canEdit = hasPermission('task.edit') || hasPermission('dashboard') || (currentUser && currentUser.role);
            const canDelete = hasPermission('task.delete') || currentUser?.role === 'Owner' || currentUser?.role === 'CEO';
            
            const allCards = Array.isArray(kanbanData.cards) ? kanbanData.cards : [];
            const filterValue = kanbanFilters?.assignee || 'all';
            const currentUserLabel = (currentUser?.displayName || currentUser?.name || currentUser?.login || '').toString();
            const resolvedAssignee = filterValue === 'mine'
                ? currentUserLabel
                : (filterValue === 'all' || filterValue === 'unassigned' ? '' : filterValue);

            const filteredCards = filterValue === 'unassigned'
                ? allCards.filter(card => getCardAssigneeList(card).length === 0)
                : (resolvedAssignee ? allCards.filter(card => matchesAssignee(card, resolvedAssignee)) : allCards);

            const staffList = Array.isArray(staffData) ? staffData : [];
            const staffNames = staffList
                .map(s => s?.displayName || s?.name || s?.login || s?.id)
                .filter(Boolean)
                .map(name => String(name).trim())
                .filter(Boolean);
            const uniqueStaffNames = [...new Set(staffNames)].sort((a, b) => a.localeCompare(b, 'pt-BR'));

            const staffOptions = uniqueStaffNames.map(name => {
                const safeName = escapeHtml(String(name));
                const selected = filterValue === name ? 'selected' : '';
                return `<option value="${safeName}" ${selected}>${safeName}</option>`;
            }).join('');

            const filterLabel = getKanbanFilterLabel(filterValue, currentUserLabel);

            const content = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h1 id="sectionTitle" style="margin-bottom: 8px;">Tarefas - Kanban</h1>
                        <p style="color: var(--gray-light);">Organize suas tarefas e projetos</p>
                    </div>
                    ${canCreate ? `
                    <button class="btn-modal btn-success" onclick="openNewCard()">
                        <i class="fas fa-plus"></i> Nova Tarefa
                    </button>
                    ` : ''}
                </div>
                
                <!-- Filtros por responsável -->
                <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 20px;">
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <div class="filter-chip ${filterValue === 'all' ? 'active' : ''}" onclick="setKanbanAssigneeFilter('all')">
                            <i class="fas fa-layer-group"></i> Todas
                        </div>
                        <div class="filter-chip ${filterValue === 'mine' ? 'active' : ''}" onclick="setKanbanAssigneeFilter('mine')">
                            <i class="fas fa-user"></i> Minhas
                        </div>
                        <div class="filter-chip ${filterValue === 'unassigned' ? 'active' : ''}" onclick="setKanbanAssigneeFilter('unassigned')">
                            <i class="fas fa-user-slash"></i> Sem responsável
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-left: auto; min-width: 220px;">
                        <span style="color: var(--gray-text); font-size: 12px;">Responsável:</span>
                        <select class="command-search-input" onchange="setKanbanAssigneeFilter(this.value)" style="min-width: 200px;">
                            <option value="all" ${filterValue === 'all' ? 'selected' : ''}>Todos</option>
                            <option value="mine" ${filterValue === 'mine' ? 'selected' : ''}>Minhas tarefas</option>
                            <option value="unassigned" ${filterValue === 'unassigned' ? 'selected' : ''}>Sem responsável</option>
                            ${staffOptions}
                        </select>
                    </div>
                </div>
                <div style="display: inline-flex; align-items: center; gap: 8px; background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 999px; padding: 6px 14px; margin-bottom: 24px; font-size: 12px; color: var(--gray-light);">
                    <i class="fas fa-filter"></i> ${filterLabel}
                </div>

                <!-- Estatísticas Rápidas -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Total de Tarefas</div>
                            <div class="stat-card-icon">📋</div>
                        </div>
                        <div class="stat-card-value">${filteredCards.length}</div>
                        <div class="stat-card-subtitle">${filterValue === 'all' ? 'Todas as tarefas' : 'No filtro atual'}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Para Fazer</div>
                            <div class="stat-card-icon">📝</div>
                        </div>
                        <div class="stat-card-value">${filteredCards.filter(c => c && (c.columnId === 'todo' || c.column_id === 'todo')).length}</div>
                        <div class="stat-card-subtitle">Pendentes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Em Progresso</div>
                            <div class="stat-card-icon">⚙️</div>
                        </div>
                        <div class="stat-card-value">${filteredCards.filter(c => c && (c.columnId === 'inprogress' || c.column_id === 'inprogress')).length}</div>
                        <div class="stat-card-subtitle">Em andamento</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Concluído</div>
                            <div class="stat-card-icon">✅</div>
                        </div>
                        <div class="stat-card-value">${filteredCards.filter(c => c && (c.columnId === 'done' || c.column_id === 'done')).length}</div>
                        <div class="stat-card-subtitle">Finalizadas</div>
                    </div>
                </div>
                
                <!-- Board Kanban -->
                <div id="kanbanBoard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 32px;">
                    ${kanbanData.columns.map(column => `
                        <div class="kanban-column" data-column-id="${column.id}" style="background: var(--gray-dark); border-radius: 12px; padding: 16px; min-height: 500px; border: 1px solid var(--gray-border);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid ${column.color};">
                                <h3 style="color: var(--white-soft); font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 12px; height: 12px; border-radius: 50%; background: ${column.color};"></span>
                                    ${column.name}
                                </h3>
                                <span style="background: ${column.color}20; color: ${column.color}; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                    ${filteredCards.filter(c => c && (c.columnId === column.id || c.column_id === column.id)).length}
                                </span>
                            </div>
                            <div class="kanban-cards" data-column="${column.id}" ondragover="event.preventDefault();" style="min-height: 400px;">
                                ${filteredCards.filter(c => c && (c.columnId === column.id || c.column_id === column.id)).map(card => `
                                    <div class="kanban-card" draggable="true" data-card-id="${card.id}" style="background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: ${canEdit ? 'pointer' : 'default'}; transition: all 0.3s ease; position: relative;" 
                                         onmouseenter="this.style.borderColor='var(--gray-text)'; this.style.transform='translateY(-2px)';" 
                                         onmouseleave="this.style.borderColor='var(--gray-border)'; this.style.transform='translateY(0)';"
                                         ondragstart="handleDragStart(event)" 
                                         ondragend="handleDragEnd(event)"
                                         onclick="${canEdit ? `openEditCard(${card.id})` : ''}">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                            <h4 style="color: var(--white-soft); font-size: 14px; font-weight: 600; margin: 0; flex: 1;">${card.title}</h4>
                                            ${canDelete ? `
                                            <button onclick="event.stopPropagation(); event.preventDefault(); deleteCard(${card.id})" style="background: transparent; border: none; color: var(--gray-text); cursor: pointer; padding: 2px 6px; font-size: 12px; opacity: 0.6; transition: opacity 0.2s;" 
                                                    onmouseenter="this.style.opacity='1'; this.style.color='var(--danger)';" 
                                                    onmouseleave="this.style.opacity='0.6'; this.style.color='var(--gray-text)';" 
                                                    title="Excluir">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                            ` : ''}
                                        </div>
                                        ${card.description ? `
                                        <p style="color: var(--gray-light); font-size: 11px; margin: 6px 0; line-height: 1.4; opacity: 0.8;">${card.description.substring(0, 80)}${card.description.length > 80 ? '...' : ''}</p>
                                        ` : ''}
                                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                                            ${card.priority ? `
                                            <span style="font-size: 9px; padding: 2px 6px; border-radius: 4px; background: ${card.priority === 'high' ? 'rgba(255, 51, 102, 0.2)' : card.priority === 'medium' ? 'rgba(255, 170, 0, 0.2)' : 'rgba(0, 255, 136, 0.2)'}; color: ${card.priority === 'high' ? 'var(--danger)' : card.priority === 'medium' ? 'var(--warning)' : 'var(--success)'};">
                                                ${card.priority === 'high' ? '🔴' : card.priority === 'medium' ? '🟡' : '🟢'}
                                            </span>
                                            ` : ''}
                                            ${formatAssigneesDisplay(card) ? `
                                            <span style="color: var(--gray-text); font-size: 10px; opacity: 0.7;">
                                                👤 ${formatAssigneesDisplay(card)}
                                            </span>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            ${canCreate ? `
                            <button onclick="addCardToColumn('${column.id}')" style="width: 100%; padding: 12px; background: transparent; border: 2px dashed var(--gray-border); border-radius: 8px; color: var(--gray-text); cursor: pointer; margin-top: 12px; transition: all 0.3s ease;"
                                    onmouseenter="this.style.borderColor='var(--gray-text)'; this.style.color='var(--white-soft)';"
                                    onmouseleave="this.style.borderColor='var(--gray-border)'; this.style.color='var(--gray-text)';">
                                <i class="fas fa-plus"></i> Adicionar Card
                            </button>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            document.querySelector('.content-card').innerHTML = content;
            
            // Aguardar um pouco para garantir que o DOM foi renderizado
            setTimeout(() => {
            initializeKanbanDragDrop();
            }, 100);
        }

        async function loadStaffControl() {
            // Garantir que staffData é um array
            if (!Array.isArray(staffData)) staffData = [];
            
            // Usar cache primeiro (muito mais rápido), só força refresh se necessário
            const requestsRaw = await getData('txd_registration_requests', false);
            console.log('📥 Dados retornados do getData:', requestsRaw);
            console.log('📥 Tipo:', typeof requestsRaw);
            console.log('📥 É array?', Array.isArray(requestsRaw));
            
            // Buscar solicitações pendentes
            const requests = Array.isArray(requestsRaw) ? requestsRaw : [];
            
            console.log('📊 Total de solicitações carregadas:', requests.length);
            console.log('📊 Todas as solicitações:', requests);
            console.log('💾 Estado do cache:', dataCache['txd_registration_requests']);
            
            // Filtrar por status 'pending' (case-insensitive e verificando diferentes formatos)
            const pendingRequests = requests.filter(r => {
                if (!r) return false;
                const status = String(r.status || '').toLowerCase().trim();
                return status === 'pending';
            });
            
            console.log('Solicitações pendentes encontradas:', pendingRequests.length);
            console.log('Detalhes das pendentes:', pendingRequests);
            
            // Buscar solicitações de licença pendentes
            const licenseRequestsRaw = await getData('txd_license_requests', false);
            const licenseRequests = Array.isArray(licenseRequestsRaw) ? licenseRequestsRaw : [];
            const pendingLicenseRequests = licenseRequests.filter(r => {
                if (!r) return false;
                const status = String(r.status || '').toLowerCase().trim();
                return status === 'pending';
            });
            
            const currentRoles = normalizeRoleList(currentUser?.roles || currentUser?.role);
            const canManage = hasPermission('staff.create') || isCLevelRole(currentRoles) || currentRoles.some(r => canonicalizeRoleKey(r) === 'HeadStaff');
            
            const content = `
                <h1 id="sectionTitle">Controle de Staff</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Gestão de membros da equipe</p>
                
                ${canManage ? `
                <div style="margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn-modal" onclick="openNewStaff()">
                        <i class="fas fa-user-plus"></i> Cadastrar Manualmente
                    </button>
                    <button class="btn-modal ${pendingRequests.length > 0 ? 'btn-warning' : ''}" onclick="showRegistrationRequests()" style="position: relative;">
                        <i class="fas fa-user-clock"></i> Solicitações de Cadastro
                        ${pendingRequests.length > 0 ? `
                        <span style="position: absolute; top: -8px; right: -8px; background: var(--danger); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; box-shadow: 0 2px 8px rgba(255, 51, 102, 0.5);">
                            ${pendingRequests.length}
                        </span>
                        ` : ''}
                    </button>
                    <button class="btn-modal ${pendingLicenseRequests.length > 0 ? 'btn-warning' : ''}" onclick="showLicenseRequests()" style="position: relative;">
                        <i class="fas fa-calendar-times"></i> Solicitações de Licença
                        ${pendingLicenseRequests.length > 0 ? `
                        <span style="position: absolute; top: -8px; right: -8px; background: var(--warning); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; box-shadow: 0 2px 8px rgba(255, 170, 0, 0.5);">
                            ${pendingLicenseRequests.length}
                        </span>
                        ` : ''}
                    </button>
                </div>
                ` : ''}
                
                <!-- SEÇÃO DE SOLICITAÇÕES PENDENTES - SEMPRE VISÍVEL -->
                ${canManage ? `
                <div style="background: ${pendingRequests.length > 0 ? 'var(--warning)' : 'var(--gray-dark)'}; color: ${pendingRequests.length > 0 ? 'white' : 'var(--gray-light)'}; padding: 20px; border-radius: 12px; margin-bottom: 24px; border: 2px solid ${pendingRequests.length > 0 ? 'var(--warning)' : 'var(--gray-border)'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                        <div style="flex: 1;">
                            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-user-clock" style="font-size: 24px;"></i>
                                Solicitações de Cadastro Pendentes
                            </h3>
                            ${pendingRequests.length > 0 ? `
                            <p style="margin: 0; font-size: 15px; opacity: 0.95;">
                                <strong>${pendingRequests.length}</strong> ${pendingRequests.length === 1 ? 'solicitação aguardando' : 'solicitações aguardando'} sua aprovação
                            </p>
                            ` : `
                            <p style="margin: 0; font-size: 14px; opacity: 0.8;">
                                Nenhuma solicitação pendente no momento
                            </p>
                            `}
                        </div>
                        <button class="btn" onclick="showRegistrationRequests()" style="background: ${pendingRequests.length > 0 ? 'white' : 'var(--gray-medium)'}; color: ${pendingRequests.length > 0 ? 'var(--warning)' : 'var(--gray-light)'}; border: none; padding: 12px 24px; font-weight: 600; white-space: nowrap;">
                            <i class="fas fa-eye"></i> ${pendingRequests.length > 0 ? 'Ver Solicitações' : 'Ver Todas'}
                        </button>
                    </div>
                </div>
                ` : ''}
                
                <div class="table-container" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--gray-dark);">
                                <th style="padding: 12px; text-align: left; color: var(--gray-light); font-size: 13px; font-weight: 600;">Nome</th>
                                <th style="padding: 12px; text-align: left; color: var(--gray-light); font-size: 13px; font-weight: 600;">Cargo</th>
                                <th style="padding: 12px; text-align: left; color: var(--gray-light); font-size: 13px; font-weight: 600;">Área</th>
                                <th style="padding: 12px; text-align: left; color: var(--gray-light); font-size: 13px; font-weight: 600;">Status</th>
                                <th style="padding: 12px; text-align: left; color: var(--gray-light); font-size: 13px; font-weight: 600;">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${staffData.map(member => `
                                <tr style="border-top: 1px solid var(--gray-border);">
                                    <td style="padding: 12px; color: var(--white-soft);">${member.name}</td>
                                    <td style="padding: 12px; color: var(--gray-light);">${(getStaffRoles(member).join(' + ') || member.role || '')}</td>
                                    <td style="padding: 12px; color: var(--gray-light);">${member.area}</td>
                                    <td style="padding: 12px;">
                                        <span class="badge badge-success">${member.status}</span>
                                    </td>
                                    <td style="padding: 12px;">
                                        <div style="display: flex; gap: 8px;">
                                            <button class="btn-modal" style="padding: 6px 12px; font-size: 12px;" onclick="editStaff('${member.id}')" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            ${hasPermission('staff.delete') ? `
                                            <button class="btn-modal btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteStaff('${member.id}')" title="Excluir">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            ` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.querySelector('.content-card').innerHTML = content;
            try { filterPendencies(); } catch (e) {}
        }
        
        // ========== GERENCIAMENTO DE SOLICITAÇÕES DE CADASTRO ==========
        
        async function showRegistrationRequests() {
            console.log('🔍 Buscando solicitações de registro...');
            
            // Verificar se Supabase está inicializado
            if (!supabaseClient) {
                alert('❌ Erro: Sistema não está conectado ao banco de dados. Recarregue a página.');
                return;
            }
            
            // Buscar diretamente do Supabase
            try {
                const { data: directData, error: directError } = await supabaseClient
                    .from('registration_requests')
                    .select('*')
                    .order('requested_at', { ascending: false });
                
                if (directError) {
                    console.error('❌ Erro ao buscar do Supabase:', directError);
                    if (directError.code === 'PGRST116' || directError.message?.includes('does not exist')) {
                        alert('❌ Tabela registration_requests não existe no Supabase.\n\nExecute o SQL de criação da tabela no Supabase SQL Editor.');
                        return;
                    }
                }
                
                console.log('📊 Dados diretos do Supabase:', directData);
                
                // Usar cache primeiro (muito mais rápido)
                const requestsRaw = await getData('txd_registration_requests', false);
                console.log('📥 Dados retornados do getData:', requestsRaw);
                console.log('📥 Tipo:', typeof requestsRaw);
                console.log('📥 É array?', Array.isArray(requestsRaw));
                
                const requests = Array.isArray(requestsRaw) ? requestsRaw : [];
                
                console.log('📋 Total de solicitações no cache:', requests.length);
                console.log('📋 Todas as solicitações:', requests);
                console.log('💾 Estado do cache:', dataCache['txd_registration_requests']);
                
                // Filtrar por status 'pending' (case-insensitive e verificando diferentes formatos)
                const pendingRequests = requests.filter(r => {
                    if (!r) {
                        console.warn('⚠️ Solicitação nula encontrada');
                        return false;
                    }
                    const status = String(r.status || '').toLowerCase().trim();
                    const isPending = status === 'pending';
                    
                    if (!isPending) {
                        console.log(`⏭️ Solicitação ${r.id} ignorada - status: "${status}"`);
                    }
                    
                    return isPending;
                });
                
                console.log('✅ Solicitações pendentes encontradas:', pendingRequests.length);
                console.log('📝 Detalhes das pendentes:', pendingRequests);
                console.log('📊 Total de solicitações antes do filtro:', requests.length);
                console.log('📊 Status de todas as solicitações:', requests.map(r => ({ id: r.id, status: r.status })));
                
                // Sempre mostrar a tela, mesmo se não houver solicitações pendentes
                const content = pendingRequests.length === 0 ? `
                <div style="margin-bottom: 24px;">
                    <button class="btn btn-secondary" onclick="loadStaffControl()">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                </div>
                
                <h2 style="color: var(--white-soft); margin-bottom: 24px;">
                    <i class="fas fa-user-clock"></i> Solicitações de Cadastro Pendentes
                </h2>
                
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 60px 40px; text-align: center; border: 1px solid var(--gray-border);">
                    <div style="font-size: 64px; margin-bottom: 24px; opacity: 0.3;">📋</div>
                    <h3 style="color: var(--white-soft); font-size: 20px; margin-bottom: 12px;">Nenhuma solicitação pendente</h3>
                    <p style="color: var(--gray-text); font-size: 14px; line-height: 1.6;">
                        Todas as solicitações de cadastro foram processadas.<br>
                        Novas solicitações aparecerão aqui automaticamente.
                    </p>
                </div>
            ` : `
                <div style="margin-bottom: 24px;">
                    <button class="btn btn-secondary" onclick="loadStaffControl()">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                </div>
                
                <h2 style="color: var(--white-soft); margin-bottom: 24px;">
                    <i class="fas fa-user-clock"></i> Solicitações de Cadastro Pendentes
                </h2>
                
                <div style="display: grid; gap: 16px;">
                    ${pendingRequests.map(request => {
                        const requestDate = new Date(request.requestedAt).toLocaleString('pt-BR');
                        return `
                            <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                                    <div>
                                        <h3 style="color: var(--white-soft); font-size: 18px; margin-bottom: 4px;">
                                            ${request.displayName || request.username}
                                        </h3>
                                        <p style="color: var(--gray-light); font-size: 14px;">
                                            <i class="fas fa-user"></i> ${request.username}
                                        </p>
                                        <p style="color: var(--gray-text); font-size: 12px; margin-top: 4px;">
                                            <i class="fas fa-calendar"></i> Solicitado em ${requestDate}
                                        </p>
                                    </div>
                                    <span style="background: var(--warning); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                        Pendente
                                    </span>
                                </div>
                                
                                <div style="display: flex; gap: 12px; margin-top: 16px;">
                                    <button class="btn btn-success" onclick="approveRegistration('${request.id}')" style="flex: 1;">
                                        <i class="fas fa-check"></i> Aprovar
                                    </button>
                                    <button class="btn btn-danger" onclick="rejectRegistration('${request.id}')" style="flex: 1;">
                                        <i class="fas fa-times"></i> Rejeitar
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
                
                document.querySelector('.content-card').innerHTML = content;
            } catch (error) {
                console.error('❌ Erro ao buscar solicitações:', error);
                alert(`Erro ao carregar solicitações: ${error.message || 'Erro desconhecido'}`);
            }
        }
        
        async function approveRegistration(requestId) {
            const role = prompt('Digite o cargo para o novo membro:\n\nOpções: Owner, CEO, COO, CMO, CCO, CIO, HeadStaff, Diretor, Coordenador, Admin, Moderador, Suporte, Helper, Dev\n\nOu deixe em branco para usar "Helper" como padrão:');
            
            if (role === null) return; // Usuário cancelou
            
            const validRoles = ['Owner', 'CEO', 'COO', 'CMO', 'CCO', 'CIO', 'HeadStaff', 'Diretor', 'Coordenador', 'Admin', 'Moderador', 'Suporte', 'Helper', 'Dev'];
            const selectedRole = role.trim() || 'Helper';
            
            if (role.trim() && !validRoles.includes(selectedRole)) {
                alert('Cargo inválido. Usando "Helper" como padrão.');
            }
            
            try {
                console.log('🔍 Buscando solicitação ID:', requestId, 'Tipo:', typeof requestId);
                
                // Converter ID para número se necessário
                const requestIdNum = typeof requestId === 'string' ? parseInt(requestId) : requestId;
                console.log('🔍 ID convertido:', requestIdNum);
                
                // Buscar diretamente do Supabase primeiro (tentar como número e string)
                let directRequest = null;
                let directError = null;
                
                // Tentar como número primeiro
                const { data: dataNum, error: errorNum } = await supabaseClient
                    .from('registration_requests')
                    .select('*')
                    .eq('id', requestIdNum)
                    .single();
                
                if (!errorNum && dataNum) {
                    directRequest = dataNum;
                } else {
                    // Tentar como string
                    const { data: dataStr, error: errorStr } = await supabaseClient
                        .from('registration_requests')
                        .select('*')
                        .eq('id', String(requestId))
                        .single();
                    
                    if (!errorStr && dataStr) {
                        directRequest = dataStr;
                    } else {
                        directError = errorStr || errorNum;
                    }
                }
                
                let request = null;
                
                if (!directError && directRequest) {
                    console.log('✅ Solicitação encontrada no Supabase:', directRequest);
                    // Converter para formato esperado
                    request = {
                        id: directRequest.id,
                        username: directRequest.username || directRequest.name,
                        displayName: directRequest.display_name || directRequest.displayName || directRequest.name,
                        password: directRequest.password,
                        status: directRequest.status,
                        requestedAt: directRequest.requested_at || directRequest.requestedAt,
                        requestedBy: directRequest.requested_by || directRequest.requestedBy,
                        gameId: directRequest.game_id || directRequest.gameId,
                        discordId: directRequest.discord_id || directRequest.discordId,
                        area: directRequest.area
                    };
                } else {
                    console.warn('⚠️ Não encontrado no Supabase, tentando cache...', directError);
                    // Tentar do cache como fallback
                    const requestsRaw = await getData('txd_registration_requests', true);
                    const requests = Array.isArray(requestsRaw) ? requestsRaw : [];
                    request = requests.find(r => r && (r.id === requestId || String(r.id) === String(requestId)));
                }
                
                if (!request) {
                    console.error('❌ Solicitação não encontrada. ID:', requestId);
                    const allRequests = await getData('txd_registration_requests', true);
                    console.error('📊 Total de solicitações:', allRequests.length);
                    console.error('📊 IDs disponíveis:', allRequests.map(r => r?.id));
                    alert(`Solicitação não encontrada.\n\nID procurado: ${requestId}\n\nRecarregue a página e tente novamente.`);
                    return;
                }
                
                console.log('✅ Solicitação encontrada:', request);
                
                // Atualizar status da solicitação diretamente no Supabase
                const { error: updateError } = await supabaseClient
                    .from('registration_requests')
                    .update({
                        status: 'approved',
                        approved_by: currentUser.name || currentUser.displayName,
                        approved_at: new Date().toISOString()
                    })
                    .eq('id', request.id);
                
                if (updateError) {
                    console.error('Erro ao atualizar solicitação:', updateError);
                    throw updateError;
                }
                
                // Atualizar objeto local
                request.status = 'approved';
                request.approvedBy = currentUser.name || currentUser.displayName;
                request.approvedAt = new Date().toISOString();
                request.role = selectedRole;
                
                // Limpar cache para forçar refresh
                clearCacheKey('txd_registration_requests');
                
                // Criar usuário no staff diretamente no Supabase
                console.log('👤 Criando novo membro do staff...');
                
                // Verificar se já existe um staff com o mesmo login
                const { data: existingStaff, error: checkError } = await supabaseClient
                    .from('staff')
                    .select('id, login, name')
                    .eq('login', request.username)
                    .single();
                
                if (!checkError && existingStaff) {
                    console.warn('⚠️ Staff já existe com este login:', existingStaff);
                    alert(`⚠️ Este usuário já está cadastrado no sistema.\n\nLogin: ${request.username}\nNome: ${existingStaff.name || existingStaff.display_name}`);
                    return;
                }
                
                const newStaff = {
                    name: request.displayName || request.username,
                    display_name: request.displayName || request.username,
                    login: request.username, // Login é o username
                    role: selectedRole,
                    email: request.email || null,
                    status: 'Ativo',
                    password: request.password, // Em produção, deve ser criptografado
                    area: request.area || '',
                    game_id: request.gameId || null,
                    discord_id: request.discordId || null,
                    approved_by: currentUser.name || currentUser.displayName
                };
                
                console.log('📝 Dados do novo staff:', newStaff);
                
                // Salvar diretamente no Supabase (sem ID, deixar o banco gerar)
                const { data: savedStaff, error: staffError } = await supabaseClient
                    .from('staff')
                    .insert(newStaff)
                    .select();
                
                if (staffError) {
                    console.error('❌ Erro ao criar staff no Supabase:', staffError);
                    console.error('📊 Detalhes:', {
                        code: staffError.code,
                        message: staffError.message,
                        details: staffError.details,
                        hint: staffError.hint
                    });
                    throw new Error(`Erro ao criar membro do staff: ${staffError.message || 'Erro desconhecido'}`);
                }
                
                if (!savedStaff || savedStaff.length === 0) {
                    throw new Error('Staff não foi criado. Nenhum dado retornado.');
                }
                
                console.log('✅ Staff criado com sucesso:', savedStaff);
                
                // Limpar cache do staff
                clearCacheKey('txd_staff');
                
                // Notificar Discord
                sendDiscordNotification('staff', '✅ Cadastro Aprovado', 
                    `Solicitação de cadastro aprovada`,
                    [
                        { name: '👤 Usuário', value: request.username, inline: true },
                        { name: '📛 Nome', value: request.displayName, inline: true },
                        { name: '🎖️ Cargo', value: selectedRole, inline: true },
                        { name: '✅ Aprovado por', value: currentUser.name || currentUser.displayName, inline: false }
                    ]
                );
                
                // Log da ação
                logSystemAction('Cadastro aprovado', 'Staff', {
                    username: request.username,
                    role: selectedRole,
                    approvedBy: currentUser.name
                });
                
                alert(`✅ Cadastro aprovado com sucesso!\n\nUsuário: ${request.username}\nCargo: ${selectedRole}\n\nO usuário já pode fazer login no sistema.`);
                
                // Recarregar interface
                loadStaffControl();
                
            } catch (error) {
                console.error('❌ Erro ao aprovar cadastro:', error);
                console.error('📊 Detalhes do erro:', {
                    message: error.message,
                    code: error.code,
                    details: error.details,
                    hint: error.hint,
                    stack: error.stack
                });
                alert(`❌ Erro ao aprovar cadastro:\n\n${error.message || 'Erro desconhecido'}\n\nVerifique o console (F12) para mais detalhes.`);
            }
        }
        
        async function rejectRegistration(requestId) {
            const reason = prompt('Digite o motivo da rejeição (opcional):');
            
            try {
                console.log('🔍 Buscando solicitação ID para rejeitar:', requestId, 'Tipo:', typeof requestId);
                
                // Converter ID para número se necessário
                const requestIdNum = typeof requestId === 'string' ? parseInt(requestId) : requestId;
                console.log('🔍 ID convertido:', requestIdNum);
                
                // Buscar diretamente do Supabase primeiro (tentar como número e string)
                let directRequest = null;
                let directError = null;
                
                // Tentar como número primeiro
                const { data: dataNum, error: errorNum } = await supabaseClient
                    .from('registration_requests')
                    .select('*')
                    .eq('id', requestIdNum)
                    .single();
                
                if (!errorNum && dataNum) {
                    directRequest = dataNum;
                } else {
                    // Tentar como string
                    const { data: dataStr, error: errorStr } = await supabaseClient
                        .from('registration_requests')
                        .select('*')
                        .eq('id', String(requestId))
                        .single();
                    
                    if (!errorStr && dataStr) {
                        directRequest = dataStr;
                    } else {
                        directError = errorStr || errorNum;
                    }
                }
                
                let request = null;
                
                if (!directError && directRequest) {
                    console.log('✅ Solicitação encontrada no Supabase:', directRequest);
                    // Converter para formato esperado
                    request = {
                        id: directRequest.id,
                        username: directRequest.username || directRequest.name,
                        displayName: directRequest.display_name || directRequest.displayName || directRequest.name,
                        password: directRequest.password,
                        status: directRequest.status,
                        requestedAt: directRequest.requested_at || directRequest.requestedAt,
                        requestedBy: directRequest.requested_by || directRequest.requestedBy,
                        gameId: directRequest.game_id || directRequest.gameId,
                        discordId: directRequest.discord_id || directRequest.discordId,
                        area: directRequest.area
                    };
                } else {
                    console.warn('⚠️ Não encontrado no Supabase, tentando cache...', directError);
                    // Tentar do cache como fallback
                    const requestsRaw = await getData('txd_registration_requests', true);
                    const requests = Array.isArray(requestsRaw) ? requestsRaw : [];
                    request = requests.find(r => r && (r.id === requestId || String(r.id) === String(requestId)));
                }
                
                if (!request) {
                    console.error('❌ Solicitação não encontrada. ID:', requestId);
                    alert(`Solicitação não encontrada.\n\nID procurado: ${requestId}\n\nRecarregue a página e tente novamente.`);
                    return;
                }
                
                console.log('✅ Solicitação encontrada para rejeitar:', request);
                
                // Atualizar status da solicitação diretamente no Supabase
                const { error: updateError } = await supabaseClient
                    .from('registration_requests')
                    .update({
                        status: 'rejected',
                        approved_by: currentUser.name || currentUser.displayName,
                        approved_at: new Date().toISOString(),
                        rejection_reason: reason || null
                    })
                    .eq('id', request.id);
                
                if (updateError) {
                    console.error('Erro ao atualizar solicitação:', updateError);
                    throw updateError;
                }
                
                // Atualizar objeto local
                request.status = 'rejected';
                request.approvedBy = currentUser.name || currentUser.displayName;
                request.approvedAt = new Date().toISOString();
                request.rejectionReason = reason || 'Não especificado';
                
                // Limpar cache para forçar refresh
                clearCacheKey('txd_registration_requests');
                
                // Notificar Discord
                sendDiscordNotification('staff', '❌ Cadastro Rejeitado', 
                    `Solicitação de cadastro rejeitada`,
                    [
                        { name: '👤 Usuário', value: request.username, inline: true },
                        { name: '📛 Nome', value: request.displayName, inline: true },
                        { name: '❌ Rejeitado por', value: currentUser.name || currentUser.displayName, inline: true },
                        { name: '📝 Motivo', value: reason || 'Não especificado', inline: false }
                    ]
                );
                
                // Log da ação
                logSystemAction('Cadastro rejeitado', 'Staff', {
                    username: request.username,
                    reason: reason || 'Não especificado',
                    rejectedBy: currentUser.name
                });
                
                alert(`❌ Cadastro rejeitado.\n\nUsuário: ${request.username}`);
                
                // Recarregar interface
                loadStaffControl();
                
            } catch (error) {
                console.error('Erro ao rejeitar cadastro:', error);
                alert('Erro ao rejeitar cadastro. Tente novamente.');
            }
        }

        // ========== GERENCIAMENTO DE SOLICITAÇÕES DE LICENÇA ==========
        
        async function showLicenseRequests() {
            console.log('🔍 Buscando solicitações de licença...');
            
            // Verificar se Supabase está inicializado
            if (!supabaseClient) {
                alert('❌ Erro: Sistema não está conectado ao banco de dados. Recarregue a página.');
                return;
            }
            
            // Buscar solicitações de licença
            try {
                const requestsRaw = await getData('txd_license_requests', false);
                const requests = Array.isArray(requestsRaw) ? requestsRaw : [];
                
                // Filtrar por status 'pending'
                const pendingRequests = requests.filter(r => {
                    if (!r) return false;
                    const status = String(r.status || '').toLowerCase().trim();
                    return status === 'pending';
                });
                
                // Ordenar por data de criação (mais recentes primeiro)
                pendingRequests.sort((a, b) => {
                    const dateA = new Date(a.createdAt || a.created_at || 0);
                    const dateB = new Date(b.createdAt || b.created_at || 0);
                    return dateB - dateA;
                });
                
                const content = pendingRequests.length === 0 ? `
                <div style="margin-bottom: 24px;">
                    <button class="btn btn-secondary" onclick="loadStaffControl()">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                </div>
                
                <h2 style="color: var(--white-soft); margin-bottom: 24px;">
                    <i class="fas fa-calendar-times"></i> Solicitações de Licença Pendentes
                </h2>
                
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 60px 40px; text-align: center; border: 1px solid var(--gray-border);">
                    <div style="font-size: 64px; margin-bottom: 24px; opacity: 0.3;">📅</div>
                    <h3 style="color: var(--white-soft); font-size: 20px; margin-bottom: 12px;">Nenhuma solicitação pendente</h3>
                    <p style="color: var(--gray-text); font-size: 14px; line-height: 1.6;">
                        Todas as solicitações de licença foram processadas.<br>
                        Novas solicitações aparecerão aqui automaticamente.
                    </p>
                </div>
            ` : `
                <div style="margin-bottom: 24px;">
                    <button class="btn btn-secondary" onclick="loadStaffControl()">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                </div>
                
                <h2 style="color: var(--white-soft); margin-bottom: 24px;">
                    <i class="fas fa-calendar-times"></i> Solicitações de Licença Pendentes
                </h2>
                
                <div style="display: grid; gap: 16px;">
                    ${pendingRequests.map(request => {
                        const startDate = new Date(request.startDate || request.start_date).toLocaleDateString('pt-BR');
                        const endDate = new Date(request.endDate || request.end_date).toLocaleDateString('pt-BR');
                        const requestDate = new Date(request.createdAt || request.created_at).toLocaleString('pt-BR');
                        const typeLabels = {
                            'ferias': 'Férias',
                            'medica': 'Licença Médica',
                            'pessoal': 'Assunto Pessoal',
                            'estudo': 'Estudos',
                            'outro': 'Outro'
                        };
                        const typeLabel = typeLabels[request.type] || request.type || 'Não especificado';
                        
                        return `
                            <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px; flex-wrap: wrap; gap: 16px;">
                                    <div style="flex: 1;">
                                        <h3 style="color: var(--white-soft); font-size: 18px; margin-bottom: 8px;">
                                            ${request.userName || request.user_name || 'Usuário Desconhecido'}
                                        </h3>
                                        <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 8px;">
                                            <div>
                                                <span style="color: var(--gray-text); font-size: 12px;">Tipo:</span>
                                                <span style="color: var(--white-soft); font-size: 14px; margin-left: 4px;">${typeLabel}</span>
                                            </div>
                                            <div>
                                                <span style="color: var(--gray-text); font-size: 12px;">Período:</span>
                                                <span style="color: var(--white-soft); font-size: 14px; margin-left: 4px;">${startDate} até ${endDate}</span>
                                            </div>
                                        </div>
                                        <div style="margin-top: 12px;">
                                            <p style="color: var(--gray-text); font-size: 12px; margin-bottom: 4px;">Motivo:</p>
                                            <p style="color: var(--white-soft); font-size: 14px; line-height: 1.5;">${request.reason || 'Não especificado'}</p>
                                        </div>
                                        <p style="color: var(--gray-text); font-size: 12px; margin-top: 12px;">
                                            <i class="fas fa-clock"></i> Solicitado em: ${requestDate}
                                        </p>
                                    </div>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <button class="btn btn-success" onclick="approveLicense(${request.id})" style="padding: 10px 20px;">
                                            <i class="fas fa-check"></i> Aprovar
                                        </button>
                                        <button class="btn btn-danger" onclick="rejectLicense(${request.id})" style="padding: 10px 20px;">
                                            <i class="fas fa-times"></i> Rejeitar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            document.querySelector('.content-card').innerHTML = content;
            
            } catch (error) {
                console.error('Erro ao buscar solicitações de licença:', error);
                alert('Erro ao carregar solicitações de licença. Tente novamente.');
            }
        }
        
        async function approveLicense(requestId) {
            if (!confirm('Deseja aprovar esta solicitação de licença?')) {
                return;
            }
            
            try {
                // Buscar solicitação diretamente do Supabase
                const { data: directRequest, error: directError } = await supabaseClient
                    .from('license_requests')
                    .select('*')
                    .eq('id', requestId)
                    .single();
                
                if (directError || !directRequest) {
                    console.error('Erro ao buscar solicitação:', directError);
                    alert('Solicitação não encontrada. Recarregue a página e tente novamente.');
                    return;
                }
                
                // Atualizar status no Supabase
                const { error: updateError } = await supabaseClient
                    .from('license_requests')
                    .update({
                        status: 'approved',
                        approved_by: currentUser.name || currentUser.displayName,
                        approved_at: new Date().toISOString()
                    })
                    .eq('id', requestId);
                
                if (updateError) {
                    console.error('Erro ao aprovar licença:', updateError);
                    throw updateError;
                }
                
                // Limpar cache
                clearCacheKey('txd_license_requests');
                
                // Notificar Discord
                sendDiscordNotification('staff', '✅ Licença Aprovada', 
                    `Solicitação de licença aprovada`,
                    [
                        { name: '👤 Usuário', value: directRequest.user_name || 'N/A', inline: true },
                        { name: '📅 Período', value: `${new Date(directRequest.start_date).toLocaleDateString('pt-BR')} até ${new Date(directRequest.end_date).toLocaleDateString('pt-BR')}`, inline: true },
                        { name: '✅ Aprovado por', value: currentUser.name || currentUser.displayName, inline: true },
                        { name: '📝 Tipo', value: directRequest.type || 'N/A', inline: false }
                    ]
                );
                
                // Log da ação
                logSystemAction('Licença aprovada', 'Staff', {
                    userId: directRequest.user_id,
                    userName: directRequest.user_name,
                    startDate: directRequest.start_date,
                    endDate: directRequest.end_date,
                    approvedBy: currentUser.name
                });
                
                alert(`✅ Licença aprovada com sucesso!`);
                
                // Recarregar interface
                showLicenseRequests();
                
            } catch (error) {
                console.error('Erro ao aprovar licença:', error);
                alert('Erro ao aprovar licença. Tente novamente.');
            }
        }
        
        async function rejectLicense(requestId) {
            const reason = prompt('Informe o motivo da rejeição (opcional):');
            if (reason === null) return; // Usuário cancelou
            
            try {
                // Buscar solicitação diretamente do Supabase
                const { data: directRequest, error: directError } = await supabaseClient
                    .from('license_requests')
                    .select('*')
                    .eq('id', requestId)
                    .single();
                
                if (directError || !directRequest) {
                    console.error('Erro ao buscar solicitação:', directError);
                    alert('Solicitação não encontrada. Recarregue a página e tente novamente.');
                    return;
                }
                
                // Atualizar status no Supabase
                const { error: updateError } = await supabaseClient
                    .from('license_requests')
                    .update({
                        status: 'rejected',
                        approved_by: currentUser.name || currentUser.displayName,
                        approved_at: new Date().toISOString(),
                        response: reason || null
                    })
                    .eq('id', requestId);
                
                if (updateError) {
                    console.error('Erro ao rejeitar licença:', updateError);
                    throw updateError;
                }
                
                // Limpar cache
                clearCacheKey('txd_license_requests');
                
                // Notificar Discord
                sendDiscordNotification('staff', '❌ Licença Rejeitada', 
                    `Solicitação de licença rejeitada`,
                    [
                        { name: '👤 Usuário', value: directRequest.user_name || 'N/A', inline: true },
                        { name: '📅 Período', value: `${new Date(directRequest.start_date).toLocaleDateString('pt-BR')} até ${new Date(directRequest.end_date).toLocaleDateString('pt-BR')}`, inline: true },
                        { name: '❌ Rejeitado por', value: currentUser.name || currentUser.displayName, inline: true },
                        { name: '📝 Motivo', value: reason || 'Não especificado', inline: false }
                    ]
                );
                
                // Log da ação
                logSystemAction('Licença rejeitada', 'Staff', {
                    userId: directRequest.user_id,
                    userName: directRequest.user_name,
                    reason: reason || 'Não especificado',
                    rejectedBy: currentUser.name
                });
                
                alert(`❌ Licença rejeitada.`);
                
                // Recarregar interface
                showLicenseRequests();
                
            } catch (error) {
                console.error('Erro ao rejeitar licença:', error);
                alert('Erro ao rejeitar licença. Tente novamente.');
            }
        }

        // ========== SISTEMA DE COMANDOS ==========
        let commandsData = dataCache['txd_commands'] || [];
        let favoriteCommands = dataCache['txd_favorite_commands'] || [];
        let commandUsageStats = dataCache['txd_command_usage'] || {};
        let activeCommandFilter = 'todos';
        let commandSearchQuery = '';

        // Inicializar comandos de exemplo (apenas na primeira vez)
        if (commandsData.length === 0) {
            commandsData = [
                {
                    id: 1,
                    name: '/ban',
                    category: 'admin',
                    description: 'Banir um jogador permanentemente ou temporariamente do servidor',
                    syntax: '/ban [id] [motivo] [tempo]',
                    example: '/ban 123 Anti-RP 7d',
                    permission: 'admin.ban',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 2,
                    name: '/kick',
                    category: 'moderacao',
                    description: 'Expulsar um jogador do servidor',
                    syntax: '/kick [id] [motivo]',
                    example: '/kick 123 Comportamento inadequado',
                    permission: 'moderator.kick',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 3,
                    name: '/warn',
                    category: 'moderacao',
                    description: 'Advertir um jogador por quebra de regras',
                    syntax: '/warn [id] [motivo]',
                    example: '/warn 123 DM excessivo',
                    permission: 'moderator.warn',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 4,
                    name: '/tp',
                    category: 'admin',
                    description: 'Teleportar para um jogador ou localização',
                    syntax: '/tp [destino]',
                    example: '/tp 123 ou /tp casa',
                    permission: 'admin.teleport',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 5,
                    name: '/revive',
                    category: 'admin',
                    description: 'Reviver um jogador',
                    syntax: '/revive [id]',
                    example: '/revive 123',
                    permission: 'admin.revive',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 6,
                    name: '/car',
                    category: 'admin',
                    description: 'Spawnar um veículo',
                    syntax: '/car [modelo]',
                    example: '/car adder',
                    permission: 'admin.vehicle',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 7,
                    name: '/give',
                    category: 'admin',
                    description: 'Dar um item para um jogador',
                    syntax: '/give [id] [item] [quantidade]',
                    example: '/give 123 dinheiro 10000',
                    permission: 'admin.give',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 8,
                    name: '/freeze',
                    category: 'moderacao',
                    description: 'Congelar um jogador',
                    syntax: '/freeze [id]',
                    example: '/freeze 123',
                    permission: 'moderator.freeze',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 9,
                    name: '/unfreeze',
                    category: 'moderacao',
                    description: 'Descongelar um jogador',
                    syntax: '/unfreeze [id]',
                    example: '/unfreeze 123',
                    permission: 'moderator.freeze',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 10,
                    name: '/anuncio',
                    category: 'utilidade',
                    description: 'Enviar um anúncio para todos os jogadores',
                    syntax: '/anuncio [mensagem]',
                    example: '/anuncio Evento começando em 10 minutos!',
                    permission: 'staff.announce',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 11,
                    name: '/limpar',
                    category: 'utilidade',
                    description: 'Limpar o chat',
                    syntax: '/limpar',
                    example: '/limpar',
                    permission: 'staff.clear',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 12,
                    name: '/me',
                    category: 'jogador',
                    description: 'Ação em terceira pessoa (roleplay)',
                    syntax: '/me [ação]',
                    example: '/me acende um cigarro',
                    permission: 'player.basic',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 13,
                    name: '/do',
                    category: 'jogador',
                    description: 'Descrever ambiente/situação (roleplay)',
                    syntax: '/do [descrição]',
                    example: '/do O cigarro está aceso',
                    permission: 'player.basic',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 14,
                    name: '/id',
                    category: 'jogador',
                    description: 'Ver seu ID ou de outro jogador',
                    syntax: '/id [jogador]',
                    example: '/id ou /id João',
                    permission: 'player.basic',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 15,
                    name: '/admins',
                    category: 'jogador',
                    description: 'Ver lista de admins online',
                    syntax: '/admins',
                    example: '/admins',
                    permission: 'player.basic',
                    createdAt: new Date().toISOString()
                }
            ];
            saveData('txd_commands', commandsData);
        }

        function loadCommands() {
            // Garantir que as variáveis são arrays
            if (!Array.isArray(commandsData)) commandsData = [];
            if (!Array.isArray(favoriteCommands)) favoriteCommands = [];
            
            const canCreate = hasPermission('system.config');
            
            const filteredCommands = getFilteredCommands();
            
            const categories = [
                { id: 'todos', name: 'Todos', icon: '📋', count: commandsData.length },
                { id: 'admin', name: 'Admin', icon: '👑', count: commandsData.filter(c => c.category === 'admin').length },
                { id: 'moderacao', name: 'Moderação', icon: '🛡️', count: commandsData.filter(c => c.category === 'moderacao').length },
                { id: 'utilidade', name: 'Utilidade', icon: '🔧', count: commandsData.filter(c => c.category === 'utilidade').length },
                { id: 'jogador', name: 'Jogador', icon: '👤', count: commandsData.filter(c => c.category === 'jogador').length },
                { id: 'favoritos', name: 'Favoritos', icon: '⭐', count: favoriteCommands.length }
            ];
            
            const content = `
                <h1 id="sectionTitle">🎮 Comandos do Sistema</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Gestão de comandos do servidor</p>
                
                <!-- Header com busca e botão adicionar -->
                <div class="commands-header">
                    <div class="commands-search-bar">
                        <input type="text" 
                            class="command-search-input" 
                            id="commandSearchInput"
                            placeholder="🔍 Buscar comandos..."
                            value="${commandSearchQuery}"
                            oninput="handleCommandSearch(event)">
                    </div>
                    ${canCreate ? `
                        <button class="btn btn-primary" onclick="openNewCommandModal()">
                            <i class="fas fa-plus"></i> Novo Comando
                        </button>
                    ` : ''}
                </div>
                
                <!-- Filtros por categoria -->
                <div class="commands-filters">
                    ${categories.map(cat => `
                        <div class="filter-chip ${activeCommandFilter === cat.id ? 'active' : ''}" 
                            onclick="filterCommands('${cat.id}')">
                            <span>${cat.icon}</span>
                            <span>${cat.name}</span>
                            <span style="opacity: 0.7;">(${cat.count})</span>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Grid de comandos -->
                ${filteredCommands.length > 0 ? `
                    <div class="commands-grid">
                        ${filteredCommands.map(cmd => renderCommandCard(cmd)).join('')}
                    </div>
                ` : `
                    <div class="commands-empty">
                        <i class="fas fa-terminal"></i>
                        <p>Nenhum comando encontrado</p>
                        <p style="font-size: 14px; margin-top: 8px;">
                            ${commandSearchQuery ? 'Tente uma busca diferente' : 'Nenhum comando nesta categoria'}
                        </p>
                    </div>
                `}
            `;
            
            document.querySelector('.content-card').innerHTML = content;
        }

        function renderCommandCard(cmd) {
            const isFavorite = favoriteCommands.includes(cmd.id);
            const usageCount = commandUsageStats[cmd.id] || 0;
            const canEdit = hasPermission('system.config');
            
            const categoryClass = `category-${cmd.category}`;
            const categoryNames = {
                'admin': 'Admin',
                'moderacao': 'Moderação',
                'utilidade': 'Utilidade',
                'jogador': 'Jogador'
            };
            
            return `
                <div class="command-card" data-command-id="${cmd.id}">
                    <div class="command-card-header">
                        <div class="command-name">
                            <i class="fas fa-terminal"></i>
                            ${cmd.name}
                        </div>
                        <span class="command-category-badge ${categoryClass}">
                            ${categoryNames[cmd.category]}
                        </span>
                    </div>
                    
                    <div class="command-description">${cmd.description}</div>
                    
                    <div class="command-permission">
                        <i class="fas fa-lock"></i>
                        ${cmd.permission}
                    </div>
                    
                    <div class="command-syntax">
                        <div class="command-syntax-label">Sintaxe:</div>
                        ${cmd.syntax}
                    </div>
                    
                    ${cmd.example ? `
                        <div class="command-syntax">
                            <div class="command-syntax-label">Exemplo:</div>
                            <div class="command-example">${cmd.example}</div>
                        </div>
                    ` : ''}
                    
                    <div class="command-actions">
                        <button class="command-action-btn" onclick="copyCommand('${cmd.name}')" title="Copiar comando">
                            <i class="fas fa-copy"></i>
                            Copiar
                        </button>
                        <button class="command-action-btn favorite ${isFavorite ? 'active' : ''}" 
                            onclick="toggleFavoriteCommand(${cmd.id})" 
                            title="${isFavorite ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}">
                            <i class="fas fa-star"></i>
                            ${isFavorite ? 'Favoritado' : 'Favoritar'}
                        </button>
                        ${canEdit ? `
                            <button class="command-action-btn" onclick="editCommand(${cmd.id})" title="Editar comando">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="command-action-btn" onclick="deleteCommand(${cmd.id})" title="Deletar comando">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                    
                    <div class="command-stats">
                        <div class="command-stat">
                            <i class="fas fa-chart-line"></i>
                            <span>${usageCount} uso${usageCount !== 1 ? 's' : ''}</span>
                        </div>
                        <div class="command-stat">
                            <i class="fas fa-clock"></i>
                            <span>${new Date(cmd.createdAt).toLocaleDateString('pt-BR')}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function getFilteredCommands() {
            // Garantir que commandsData é um array
            if (!Array.isArray(commandsData)) commandsData = [];
            if (!Array.isArray(favoriteCommands)) favoriteCommands = [];
            
            let filtered = commandsData;
            
            // Filtrar por categoria
            if (activeCommandFilter === 'favoritos') {
                filtered = filtered.filter(cmd => favoriteCommands.includes(cmd.id));
            } else if (activeCommandFilter !== 'todos') {
                filtered = filtered.filter(cmd => cmd.category === activeCommandFilter);
            }
            
            // Filtrar por busca
            if (commandSearchQuery) {
                const query = commandSearchQuery.toLowerCase();
                filtered = filtered.filter(cmd => 
                    cmd.name.toLowerCase().includes(query) ||
                    cmd.description.toLowerCase().includes(query) ||
                    cmd.syntax.toLowerCase().includes(query) ||
                    cmd.permission.toLowerCase().includes(query)
                );
            }
            
            return filtered;
        }

        function filterCommands(category) {
            activeCommandFilter = category;
            loadCommands();
        }

        function handleCommandSearch(event) {
            commandSearchQuery = event.target.value;
            loadCommands();
        }

        function copyCommand(commandName) {
            navigator.clipboard.writeText(commandName).then(() => {
                // Mostrar feedback visual
                const tempDiv = document.createElement('div');
                tempDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: var(--success);
                    color: var(--black-deep);
                    padding: 12px 20px;
                    border-radius: 8px;
                    font-weight: 600;
                    z-index: 10000;
                    animation: slideInRight 0.3s ease-out;
                `;
                tempDiv.textContent = `✓ ${commandName} copiado!`;
                document.body.appendChild(tempDiv);
                
                setTimeout(() => {
                    tempDiv.style.animation = 'slideOutRight 0.3s ease-out';
                    setTimeout(() => tempDiv.remove(), 300);
                }, 2000);
                
                // Registrar uso
                if (Array.isArray(commandsData)) {
                    const command = commandsData.find(c => c.name === commandName);
                    if (command) {
                        commandUsageStats[command.id] = (commandUsageStats[command.id] || 0) + 1;
                    }
                }
                saveData('txd_command_usage', commandUsageStats);
            });
        }

        function toggleFavoriteCommand(commandId) {
            // Garantir que favoriteCommands é um array
            if (!Array.isArray(favoriteCommands)) favoriteCommands = [];
            
            const index = favoriteCommands.indexOf(commandId);
            if (index > -1) {
                favoriteCommands.splice(index, 1);
            } else {
                favoriteCommands.push(commandId);
            }
            saveData('txd_favorite_commands', favoriteCommands);
            loadCommands();
        }

        function openNewCommandModal() {
            document.getElementById('commandModalTitle').textContent = 'Novo Comando';
            document.getElementById('commandForm').reset();
            document.getElementById('commandId').value = '';
            document.getElementById('commandModal').classList.add('active');
        }

        function editCommand(commandId) {
            // Garantir que commandsData é um array
            if (!Array.isArray(commandsData)) commandsData = [];
            
            const command = commandsData.find(c => c.id === commandId);
            if (!command) return;
            
            document.getElementById('commandModalTitle').textContent = 'Editar Comando';
            document.getElementById('commandId').value = command.id;
            document.getElementById('commandName').value = command.name;
            document.getElementById('commandCategory').value = command.category;
            document.getElementById('commandDescription').value = command.description;
            document.getElementById('commandSyntax').value = command.syntax;
            document.getElementById('commandExample').value = command.example || '';
            document.getElementById('commandPermission').value = command.permission;
            
            document.getElementById('commandModal').classList.add('active');
        }

        function saveCommand(event) {
            event.preventDefault();
            
            // Garantir que commandsData é um array
            if (!Array.isArray(commandsData)) commandsData = [];
            
            const commandId = document.getElementById('commandId').value;
            const isEdit = commandId !== '';
            
            const commandData = {
                id: isEdit ? parseInt(commandId) : Date.now(),
                name: document.getElementById('commandName').value,
                category: document.getElementById('commandCategory').value,
                description: document.getElementById('commandDescription').value,
                syntax: document.getElementById('commandSyntax').value,
                example: document.getElementById('commandExample').value,
                permission: document.getElementById('commandPermission').value,
                createdAt: isEdit ? (commandsData.find(c => c.id == commandId)?.createdAt || new Date().toISOString()) : new Date().toISOString()
            };
            
            if (isEdit) {
                const index = commandsData.findIndex(c => c.id == commandId);
                commandsData[index] = commandData;
                
                // Notificar Discord sobre edição de comando
                sendDiscordNotification('staff', '✏️ Comando Editado', 
                    `${currentUser.name} editou um comando`,
                    [
                        { name: '⚡ Comando', value: commandData.name, inline: true },
                        { name: '📂 Categoria', value: commandData.category, inline: true },
                        { name: '📝 Descrição', value: commandData.description, inline: false },
                        { name: '💻 Sintaxe', value: `\`${commandData.syntax}\``, inline: false },
                        { name: '🔒 Permissão', value: commandData.permission, inline: true },
                        { name: '👨‍💼 Editado por', value: currentUser.name, inline: true }
                    ]
                );
            } else {
                commandsData.push(commandData);
                
                // Notificar Discord sobre novo comando
                sendDiscordNotification('staff', '✨ Novo Comando Adicionado', 
                    `${currentUser.name} adicionou um novo comando`,
                    [
                        { name: '⚡ Comando', value: commandData.name, inline: true },
                        { name: '📂 Categoria', value: commandData.category, inline: true },
                        { name: '📝 Descrição', value: commandData.description, inline: false },
                        { name: '💻 Sintaxe', value: `\`${commandData.syntax}\``, inline: false },
                        { name: '💡 Exemplo', value: `\`${commandData.example}\``, inline: false },
                        { name: '🔒 Permissão', value: commandData.permission, inline: true },
                        { name: '👨‍💼 Criado por', value: currentUser.name, inline: true }
                    ]
                );
            }
            
            saveData('txd_commands', commandsData);
            closeModal('commandModal');
            loadCommands();
            
            alert(isEdit ? 'Comando atualizado com sucesso!' : 'Comando adicionado com sucesso!');
        }

        function deleteCommand(commandId) {
            if (!confirm('Tem certeza que deseja deletar este comando?')) return;
            
            // Garantir que as variáveis são arrays
            if (!Array.isArray(commandsData)) commandsData = [];
            if (!Array.isArray(favoriteCommands)) favoriteCommands = [];
            
            // Buscar dados do comando antes de deletar
            const deletedCommand = commandsData.find(c => c.id === commandId);
            
            commandsData = commandsData.filter(c => c.id !== commandId);
            favoriteCommands = favoriteCommands.filter(id => id !== commandId);
            
            saveData('txd_commands', commandsData);
            saveData('txd_favorite_commands', favoriteCommands);
            
            // Notificar Discord sobre exclusão de comando
            if (deletedCommand) {
                sendDiscordNotification('staff', '❌ Comando Excluído', 
                    `${currentUser.name} excluiu um comando`,
                    [
                        { name: '⚡ Comando', value: deletedCommand.name, inline: true },
                        { name: '📂 Categoria', value: deletedCommand.category, inline: true },
                        { name: '📝 Descrição', value: deletedCommand.description, inline: false },
                        { name: '👨‍💼 Excluído por', value: currentUser.name, inline: true },
                        { name: '🕐 Horário', value: new Date().toLocaleString('pt-BR'), inline: true }
                    ]
                );
            }
            
            loadCommands();
            alert('Comando deletado com sucesso!');
        }

        async function loadAgenda() {
            const navSeq = activeNavSeq;
            try { renderSectionLoading('📅 Agenda da Equipe'); } catch (e) {}
            await nextFrame();
            const events = await getData('txd_events', false);
            if (navSeq !== activeNavSeq) return;
            eventsData = Array.isArray(events) ? events : [];
            
            const canCreate = hasPermission('event.create');
            const canEdit = hasPermission('event.edit');
            const canDelete = hasPermission('event.delete');
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const upcomingEvents = [];
            const pastEvents = [];
            
            eventsData.forEach(event => {
                const eventDate = getEventDateObject(event);
                eventDate.setHours(0, 0, 0, 0);
                if (eventDate >= today) {
                    upcomingEvents.push(event);
                } else {
                    pastEvents.push(event);
                }
            });
            
            upcomingEvents.sort((a, b) => {
                const dateA = getEventDateObject(a);
                const dateB = getEventDateObject(b);
                return dateA - dateB;
            });
            
            pastEvents.sort((a, b) => {
                const dateA = getEventDateObject(a);
                const dateB = getEventDateObject(b);
                return dateB - dateA;
            });
            
            const calendarHTML = generateCalendarHTML(upcomingEvents);
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            const upcomingWeekEvents = upcomingEvents.filter(event => {
                const eventDate = getEventDateObject(event);
                return eventDate <= nextWeek;
            });
            
            const content = `
                <h1 id="sectionTitle">📅 Agenda da Equipe</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Gerencie eventos, reuniões e atividades da equipe</p>
                ${canCreate ? `<div style="margin-bottom: 24px;"><button class="btn-modal btn-success" onclick="openNewEvent()"><i class="fas fa-calendar-plus"></i> Novo Evento</button></div>` : ''}
                ${upcomingWeekEvents.length > 0 ? `
                <div style="margin-bottom: 32px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-bell" style="color: var(--warning); margin-right: 8px;"></i> Lembretes - Próximos 7 Dias
                    </h2>
                    <div style="display: grid; gap: 12px;">
                        ${upcomingWeekEvents.map(event => {
                            const eventDate = getEventDateObject(event);
                            const eventTime = getEventTimeString(event) || '18:00';
                            const daysUntil = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
                            const isToday = daysUntil === 0;
                            const isTomorrow = daysUntil === 1;
                            return `<div style="background: ${isToday ? 'var(--warning)' : 'var(--gray-dark)'}; border-radius: 12px; padding: 16px; border: 1px solid var(--gray-border); ${isToday ? 'border-left: 4px solid var(--danger);' : ''}">
                                <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 12px;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                            <h3 style="color: ${isToday ? 'white' : 'var(--white-soft)'}; font-size: 16px; margin: 0;">${event.title || 'Sem título'}</h3>
                                            ${isToday ? '<span class="badge badge-danger">HOJE</span>' : isTomorrow ? '<span class="badge badge-warning">AMANHÃ</span>' : `<span class="badge badge-secondary">Em ${daysUntil} dias</span>`}
                                        </div>
                                        <div style="display: flex; flex-wrap: wrap; gap: 16px; font-size: 13px; color: ${isToday ? 'rgba(255,255,255,0.9)' : 'var(--gray-light)'};">
                                            <span><i class="fas fa-calendar"></i> ${eventDate.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' })}</span>
                                            <span><i class="fas fa-clock"></i> ${eventTime}</span>
                                            ${event.location ? `<span><i class="fas fa-map-marker-alt"></i> ${event.location}</span>` : ''}
                                        </div>
                                        ${event.description ? `<p style="color: ${isToday ? 'rgba(255,255,255,0.8)' : 'var(--gray-light)'}; font-size: 13px; margin-top: 8px; line-height: 1.5;">${event.description}</p>` : ''}
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        ${canEdit ? `<button class="btn-modal" style="padding: 6px 12px; font-size: 12px; background: ${isToday ? 'rgba(255,255,255,0.2)' : 'var(--gray-darker)'};" onclick="openEditEvent(${event.id})" title="Editar"><i class="fas fa-edit"></i></button>` : ''}
                                        ${canDelete ? `<button class="btn-modal btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteEvent(${event.id})" title="Excluir"><i class="fas fa-trash"></i></button>` : ''}
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>` : ''}
                <div style="margin-bottom: 32px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-calendar-alt" style="color: var(--gray-text); margin-right: 8px;"></i> Calendário do Mês
                    </h2>
                    ${calendarHTML}
                </div>
                ${upcomingEvents.length > 0 ? `
                <div style="margin-bottom: 32px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-arrow-up" style="color: var(--success); margin-right: 8px;"></i> Próximos Eventos
                    </h2>
                    <div style="display: grid; gap: 16px;">
                        ${upcomingEvents.map(event => {
                            const eventDate = getEventDateObject(event);
                            const eventTime = getEventTimeString(event) || '18:00';
                            const eventDateTime = new Date(eventDate);
                            if (eventTime) {
                                const [hours, minutes] = eventTime.split(':');
                                eventDateTime.setHours(parseInt(hours) || 18, parseInt(minutes) || 0);
                            }
                            return `<div style="padding: 20px; background: var(--gray-dark); border-radius: 12px; border: 1px solid var(--gray-border);">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; flex-wrap: wrap; gap: 16px;">
                                    <div style="flex: 1;">
                                        <h3 style="color: var(--white-soft); margin-bottom: 8px; font-size: 18px;">${event.title || 'Sem título'}</h3>
                                        <div style="display: flex; flex-wrap: wrap; gap: 16px; font-size: 14px; color: var(--gray-light);">
                                            <span><i class="fas fa-calendar"></i> ${eventDateTime.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</span>
                                            <span><i class="fas fa-clock"></i> ${eventTime}</span>
                                            ${event.location ? `<span><i class="fas fa-map-marker-alt"></i> ${event.location}</span>` : ''}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        ${canEdit ? `<button class="btn-modal" style="padding: 6px 12px; font-size: 12px;" onclick="openEditEvent(${event.id})" title="Editar"><i class="fas fa-edit"></i></button>` : ''}
                                        ${canDelete ? `<button class="btn-modal btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteEvent(${event.id})" title="Excluir"><i class="fas fa-trash"></i></button>` : ''}
                                    </div>
                                </div>
                                ${event.description ? `<p style="color: var(--gray-light); margin-top: 12px; line-height: 1.6;">${event.description}</p>` : ''}
                            </div>`;
                        }).join('')}
                    </div>
                </div>` : ''}
                ${pastEvents.length > 0 ? `
                <div style="margin-bottom: 32px;">
                    <details style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        <summary style="cursor: pointer; color: var(--white-soft); font-size: 18px; font-weight: 600; margin-bottom: 16px; user-select: none;">
                            <i class="fas fa-history" style="color: var(--gray-text); margin-right: 8px;"></i> Eventos Passados (${pastEvents.length})
                        </summary>
                        <div style="display: grid; gap: 16px; margin-top: 16px;">
                            ${pastEvents.slice(0, 10).map(event => {
                                const eventDate = getEventDateObject(event);
                                const eventTime = getEventTimeString(event) || '18:00';
                                return `<div style="padding: 16px; background: var(--gray-darker); border-radius: 8px; border: 1px solid var(--gray-border); opacity: 0.7;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 12px;">
                                        <div style="flex: 1;">
                                            <h4 style="color: var(--white-soft); margin-bottom: 4px; font-size: 14px;">${event.title || 'Sem título'}</h4>
                                            <div style="font-size: 12px; color: var(--gray-text);">
                                                <span>${eventDate.toLocaleDateString('pt-BR')}</span>
                                                ${eventTime ? `<span style="margin-left: 12px;">${eventTime}</span>` : ''}
                                            </div>
                                        </div>
                                        ${canDelete ? `<button class="btn-modal btn-danger" style="padding: 4px 8px; font-size: 11px;" onclick="deleteEvent(${event.id})" title="Excluir"><i class="fas fa-trash"></i></button>` : ''}
                                    </div>
                                </div>`;
                            }).join('')}
                            ${pastEvents.length > 10 ? `<p style="color: var(--gray-text); font-size: 12px; text-align: center; margin-top: 8px;">Mostrando últimos 10 eventos. Total: ${pastEvents.length}</p>` : ''}
                        </div>
                    </details>
                </div>` : ''}
                ${eventsData.length === 0 ? `
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 60px 40px; text-align: center; border: 1px solid var(--gray-border);">
                    <div style="font-size: 64px; margin-bottom: 24px; opacity: 0.3;">📅</div>
                    <h3 style="color: var(--white-soft); font-size: 20px; margin-bottom: 12px;">Nenhum evento agendado</h3>
                    <p style="color: var(--gray-text); font-size: 14px; line-height: 1.6;">${canCreate ? 'Comece criando seu primeiro evento!' : 'Entre em contato com um administrador para criar eventos.'}</p>
                </div>` : ''}
            `;
            document.querySelector('.content-card').innerHTML = content;
        }
        
        function generateCalendarHTML(events) {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const eventsByDay = {};
            events.forEach(event => {
                const eventDate = getEventDateObject(event);
                if (!Number.isNaN(eventDate.getTime()) && eventDate.getMonth() === month && eventDate.getFullYear() === year) {
                    const day = eventDate.getDate();
                    if (!eventsByDay[day]) eventsByDay[day] = [];
                    eventsByDay[day].push(event);
                }
            });
            let calendarHTML = `<div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border);">
                <div style="text-align: center; margin-bottom: 24px;"><h3 style="color: var(--white-soft); font-size: 20px; font-weight: 600;">${monthNames[month]} ${year}</h3></div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 8px;">
                    ${weekDays.map(day => `<div style="text-align: center; padding: 8px; font-weight: 600; color: var(--gray-light); font-size: 12px;">${day}</div>`).join('')}
                </div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;">`;
            for (let i = 0; i < startingDayOfWeek; i++) {
                calendarHTML += `<div style="aspect-ratio: 1; background: var(--gray-darker); border-radius: 8px; border: 1px solid var(--gray-border);"></div>`;
            }
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const isToday = date.toDateString() === today.toDateString();
                const dayEvents = Array.isArray(eventsByDay[day]) ? eventsByDay[day] : [];
                const hasEvents = dayEvents.length > 0;
                const eventCount = dayEvents.length;
                const borderColor = isToday ? 'var(--success)' : hasEvents ? 'rgba(0,168,255,0.75)' : 'var(--gray-border)';
                const background = isToday
                    ? 'var(--primary)'
                    : hasEvents
                        ? 'linear-gradient(180deg, rgba(0,168,255,0.18), var(--gray-darker))'
                        : 'var(--black-dark)';
                const shadow = hasEvents
                    ? '0 0 0 1px rgba(0,168,255,0.18), 0 10px 18px rgba(0,0,0,0.24)'
                    : 'none';
                const tooltip = hasEvents ? (() => {
                    const preview = dayEvents.slice(0, 4).map(e => {
                        const title = (e.title || 'Sem título').toString();
                        const time = (getEventTimeString(e) || '').toString().trim();
                        return time ? `${title} (${time})` : title;
                    });
                    return `Eventos (${eventCount}): ${preview.join(' • ')}${eventCount > 4 ? ` • +${eventCount - 4}...` : ''}`;
                })() : '';
                const titleAttr = hasEvents ? `title="${escapeHtml(tooltip)}"` : '';
                const labelBg = isToday ? 'rgba(0,0,0,0.22)' : 'rgba(0,168,255,0.14)';
                const labelBorder = isToday ? 'rgba(255,255,255,0.22)' : 'rgba(0,168,255,0.42)';
                const timeBadgeBg = isToday ? 'rgba(0,0,0,0.22)' : 'rgba(0,168,255,0.22)';
                const timeBadgeBorder = isToday ? 'rgba(255,255,255,0.22)' : 'rgba(0,168,255,0.55)';
                const dayEventsSorted = hasEvents
                    ? dayEvents.slice().sort((a, b) => {
                        const ta = (getEventTimeString(a) || '99:99').toString().slice(0, 5);
                        const tb = (getEventTimeString(b) || '99:99').toString().slice(0, 5);
                        if (ta !== tb) return ta.localeCompare(tb, 'pt-BR');
                        return (a.title || '').toString().localeCompare((b.title || '').toString(), 'pt-BR');
                    })
                    : [];

                calendarHTML += `<div ${titleAttr} style="aspect-ratio: 1; background: ${background}; border-radius: 8px; border: 2px solid ${borderColor}; box-shadow: ${shadow}; padding: 8px; cursor: ${hasEvents ? 'pointer' : 'default'}; position: relative; transition: all 0.2s ease;" ${hasEvents ? `onclick="showDayEvents(${day}, ${month}, ${year})" onmouseenter="this.style.transform='scale(1.05)'; this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 1px rgba(0,168,255,0.30), 0 12px 22px rgba(0,0,0,0.32)'" onmouseleave="this.style.transform='scale(1)'; this.style.borderColor='${borderColor}'; this.style.boxShadow='${shadow}'"` : ''}>
                    <div style="font-size: 14px; font-weight: ${isToday ? '700' : '600'}; color: ${isToday ? 'white' : 'var(--white-soft)'}; margin-bottom: 4px;">${day}</div>
                    ${hasEvents ? `
                        <div style="position: absolute; top: 6px; right: 6px; background: rgba(0, 168, 255, 0.22); border: 1px solid rgba(0, 168, 255, 0.55); color: ${isToday ? 'white' : 'var(--white-soft)'}; font-size: 11px; font-weight: 800; border-radius: 999px; padding: 2px 6px; line-height: 1;">
                            ${eventCount}
                        </div>
                        <div style="margin-top: 10px; padding-right: 34px; display: flex; flex-direction: column; gap: 6px;">
                            ${dayEventsSorted.slice(0, 3).map(e => {
                                const title = escapeHtml((e.title || 'Evento').toString());
                                const time = (getEventTimeString(e) || '').toString().trim().slice(0, 5);
                                const timeLabel = time ? escapeHtml(time) : '—';
                                return `
                                    <div style="display: flex; align-items: center; gap: 8px; background: ${labelBg}; border: 1px solid ${labelBorder}; border-radius: 10px; padding: 6px 8px; overflow: hidden; box-shadow: 0 0 0 1px rgba(0,168,255,0.08), 0 10px 16px rgba(0,0,0,0.18);">
                                        <div style="flex: 0 0 auto; background: ${timeBadgeBg}; border: 1px solid ${timeBadgeBorder}; color: ${isToday ? 'white' : 'var(--white-soft)'}; font-size: 10px; font-weight: 900; border-radius: 999px; padding: 2px 6px; line-height: 1;">
                                            ${timeLabel}
                                        </div>
                                        <div style="flex: 1; min-width: 0; font-size: 11px; font-weight: 900; color: ${isToday ? 'white' : 'var(--white-soft)'}; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                            ${title}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                            ${eventCount > 3 ? `<div style="font-size: 10px; font-weight: 900; color: ${isToday ? 'rgba(255,255,255,0.92)' : 'var(--gray-very-light)'}; opacity: 0.9; padding-left: 2px;">+${eventCount - 3} mais</div>` : ''}
                        </div>
                        <div style="position: absolute; left: 8px; right: 8px; bottom: 6px; height: 4px; border-radius: 999px; background: var(--primary); opacity: 0.95;"></div>
                        <div style="display: flex; flex-wrap: wrap; gap: 3px; margin-top: 6px;">
                            ${dayEvents.slice(0, 3).map(() => `<div style="width: 8px; height: 8px; border-radius: 50%; background: var(--primary); box-shadow: 0 0 0 1px rgba(0,168,255,0.35);"></div>`).join('')}
                            ${eventCount > 3 ? `<div style="font-size: 10px; color: var(--gray-very-light); font-weight: 800;">+${eventCount - 3}</div>` : ''}
                        </div>
                    ` : `
                        <div style="position: absolute; left: 8px; right: 8px; bottom: 10px; text-align: center; font-size: 10px; font-weight: 900; letter-spacing: 1px; text-transform: uppercase; color: ${isToday ? 'rgba(255,255,255,0.92)' : 'var(--gray-text)'}; opacity: ${isToday ? '0.95' : '0.75'};">
                            ${isToday ? 'HOJE' : 'SEM EVENTO'}
                        </div>
                    `}
                </div>`;
            }
            calendarHTML += `</div></div>`;
            return calendarHTML;
        }
        
        function showDayEvents(day, month, year) {
            const date = new Date(year, month, day);
            const eventsOnDay = eventsData.filter(event => {
                const eventDate = getEventDateObject(event);
                return eventDate.getDate() === day && eventDate.getMonth() === month && eventDate.getFullYear() === year;
            });
            if (eventsOnDay.length === 0) return;
            const eventsList = eventsOnDay.map(event => {
                const eventTime = getEventTimeString(event) || '18:00';
                return `• ${event.title || 'Sem título'} - ${eventTime}`;
            }).join('\n');
            alert(`Eventos em ${date.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' })}:\n\n${eventsList}`);
        }

        async function loadReports() {
            const navSeq = activeNavSeq;
            try { renderSectionLoading('📊 Relatórios e Estatísticas'); } catch (e) {}
            await nextFrame();

            // Carregar dados em paralelo (reduz lag ao trocar abas)
            const [staff, eventsFetched, messagesFetched] = await Promise.all([
                getData('txd_staff', false),
                getData('txd_events', false),
                getData('txd_chat_messages', false),
                ensureKanbanLoaded(false),
                ensurePendenciesLoaded(false)
            ]).then(results => {
                // results: [staff, events, messages, undefined, undefined]
                return [results[0], results[1], results[2]];
            });

            if (navSeq !== activeNavSeq) return;
            if (Array.isArray(staff)) staffData = staff;
            if (Array.isArray(eventsFetched)) eventsData = eventsFetched;
            if (Array.isArray(messagesFetched)) chatMessages = messagesFetched;

            // Calcular estatísticas gerais (state já carregado)
            const kanbanData = getKanbanSnapshotFromState();
            const totalTasks = (kanbanData?.cards || []).length;
            const completedTasks = (kanbanData?.cards || []).filter(c => c && (c.columnId === 'done' || c.column_id === 'done')).length;
            const pendencias = Array.from(state.pendencies.byId.values());
            const resolvedPendencias = pendencias.filter(p => ['completed', 'concluida', 'concluída'].includes((p.status || '').toLowerCase())).length;
            const events = Array.isArray(eventsData) ? eventsData : [];
            const activeStaff = Array.isArray(staffData) ? staffData.filter(s => s.status === 'Ativo') : [];
            const messages = Array.isArray(chatMessages) ? chatMessages : [];
            
            // Calcular por período (últimos 30 dias)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const recentTasks = (kanbanData?.cards || []).filter(c => {
                if (!c) return false;
                const created = new Date(c.createdAt || c.created_at || 0);
                return created >= thirtyDaysAgo;
            }).length;
            
            const recentPendencias = pendencias.filter(p => {
                const created = new Date(p.createdAt || p.created_at || 0);
                return created >= thirtyDaysAgo;
            }).length;
            
            const recentEvents = events.filter(e => {
                const eventDate = new Date(e.eventDate || e.event_date || 0);
                return eventDate >= thirtyDaysAgo;
            }).length;
            
            // Calcular distribuição de tarefas por status
            const tasksByStatus = {
                todo: (kanbanData?.cards || []).filter(c => c && (c.columnId === 'todo' || c.column_id === 'todo')).length,
                inprogress: (kanbanData?.cards || []).filter(c => c && (c.columnId === 'inprogress' || c.column_id === 'inprogress')).length,
                review: (kanbanData?.cards || []).filter(c => c && (c.columnId === 'review' || c.column_id === 'review')).length,
                done: completedTasks
            };
            
            // Calcular distribuição de pendencias por status
            const pendenciasByStatus = {
                pendente: pendencias.filter(p => ['pending', 'pendente'].includes((p.status || '').toLowerCase())).length,
                emAndamento: pendencias.filter(p => ['in_progress', 'em andamento'].includes((p.status || '').toLowerCase())).length,
                concluida: resolvedPendencias
            };
            
            // Calcular distribuição de staff por cargo
            const staffByRole = {};
            activeStaff.forEach(s => {
                const role = s.role || 'Sem cargo';
                staffByRole[role] = (staffByRole[role] || 0) + 1;
            });
            
            const content = `
                <h1 id="sectionTitle">📊 Relatórios e Estatísticas</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Visão geral do desempenho e atividades do sistema</p>
                
                <!-- ESTATÍSTICAS GERAIS -->
                <div style="margin-bottom: 32px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-chart-line" style="color: var(--gray-text); margin-right: 8px;"></i>
                        Estatísticas Gerais
                    </h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--primary); margin-bottom: 8px;">${totalTasks}</div>
                            <div style="font-size: 14px; color: var(--gray-light);">Total de Tarefas</div>
                            <div style="font-size: 12px; color: var(--gray-text); margin-top: 4px;">${completedTasks} concluídas</div>
                        </div>
                        <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--warning); margin-bottom: 8px;">${pendencias.length}</div>
                            <div style="font-size: 14px; color: var(--gray-light);">Total de Pendencias</div>
                            <div style="font-size: 12px; color: var(--gray-text); margin-top: 4px;">${resolvedPendencias} concluidas</div>
                        </div>
                        <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--success); margin-bottom: 8px;">${activeStaff.length}</div>
                            <div style="font-size: 14px; color: var(--gray-light);">Membros Ativos</div>
                            <div style="font-size: 12px; color: var(--gray-text); margin-top: 4px;">${Array.isArray(staffData) ? staffData.length : 0} total</div>
                        </div>
                        <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--white-soft); margin-bottom: 8px;">${events.length}</div>
                            <div style="font-size: 14px; color: var(--gray-light);">Eventos Agendados</div>
                            <div style="font-size: 12px; color: var(--gray-text); margin-top: 4px;">${recentEvents} este mês</div>
                        </div>
                        <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--primary); margin-bottom: 8px;">${messages.length}</div>
                            <div style="font-size: 14px; color: var(--gray-light);">Mensagens</div>
                            <div style="font-size: 12px; color: var(--gray-text); margin-top: 4px;">No chat interno</div>
                        </div>
                    </div>
                </div>
                
                <!-- ATIVIDADES RECENTES (ÚLTIMOS 30 DIAS) -->
                <div style="margin-bottom: 32px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-calendar-alt" style="color: var(--gray-text); margin-right: 8px;"></i>
                        Atividades dos Últimos 30 Dias
                    </h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                            <div style="font-size: 24px; font-weight: 700; color: var(--primary); margin-bottom: 4px;">${recentTasks}</div>
                            <div style="font-size: 14px; color: var(--gray-light);">Novas Tarefas</div>
                        </div>
                        <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                            <div style="font-size: 24px; font-weight: 700; color: var(--warning); margin-bottom: 4px;">${recentPendencias}</div>
                            <div style="font-size: 14px; color: var(--gray-light);">Novas Pendencias</div>
                        </div>
                        <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                            <div style="font-size: 24px; font-weight: 700; color: var(--success); margin-bottom: 4px;">${recentEvents}</div>
                            <div style="font-size: 14px; color: var(--gray-light);">Novos Eventos</div>
                        </div>
                    </div>
                </div>
                
                <!-- DISTRIBUIÇÃO DE TAREFAS -->
                <div style="margin-bottom: 32px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-tasks" style="color: var(--gray-text); margin-right: 8px;"></i>
                        Distribuição de Tarefas por Status
                    </h2>
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border);">
                        <div style="display: grid; gap: 16px;">
                            ${Object.entries(tasksByStatus).map(([status, count]) => {
                                const statusLabels = {
                                    todo: 'Para Fazer',
                                    inprogress: 'Em Progresso',
                                    review: 'Em Revisão',
                                    done: 'Concluído'
                                };
                                const statusColors = {
                                    todo: '#6F7276',
                                    inprogress: '#ffaa00',
                                    review: '#3b82f6',
                                    done: '#00ff88'
                                };
                                const percentage = totalTasks > 0 ? Math.round((count / totalTasks) * 100) : 0;
                                return `
                                    <div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <span style="color: var(--white-soft); font-size: 14px; font-weight: 600;">${statusLabels[status] || status}</span>
                                            <span style="color: var(--gray-light); font-size: 14px;">${count} (${percentage}%)</span>
                                        </div>
                                        <div style="background: var(--gray-darker); border-radius: 8px; height: 8px; overflow: hidden;">
                                            <div style="background: ${statusColors[status]}; height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- DISTRIBUICAO DE PENDENCIAS -->
                <div style="margin-bottom: 32px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-clipboard-list" style="color: var(--gray-text); margin-right: 8px;"></i>
                        Distribuicao de Pendencias por Status
                    </h2>
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border);">
                        <div style="display: grid; gap: 16px;">
                            ${Object.entries(pendenciasByStatus).map(([status, count]) => {
                                const statusLabels = {
                                    pendente: 'Pendente',
                                    emAndamento: 'Em Andamento',
                                    concluida: 'Concluida'
                                };
                                const statusColors = {
                                    pendente: '#ff3333',
                                    emAndamento: '#ffaa00',
                                    concluida: '#00ff88'
                                };
                                const percentage = pendencias.length > 0 ? Math.round((count / pendencias.length) * 100) : 0;
                                return `
                                    <div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <span style="color: var(--white-soft); font-size: 14px; font-weight: 600;">${statusLabels[status] || status}</span>
                                            <span style="color: var(--gray-light); font-size: 14px;">${count} (${percentage}%)</span>
                                        </div>
                                        <div style="background: var(--gray-darker); border-radius: 8px; height: 8px; overflow: hidden;">
                                            <div style="background: ${statusColors[status]}; height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- DISTRIBUIÇÃO DE STAFF POR CARGO -->
                <div style="margin-bottom: 32px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-users" style="color: var(--gray-text); margin-right: 8px;"></i>
                        Distribuição de Staff por Cargo
                    </h2>
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border);">
                        ${Object.keys(staffByRole).length > 0 ? `
                        <div style="display: grid; gap: 12px;">
                            ${Object.entries(staffByRole).sort((a, b) => b[1] - a[1]).map(([role, count]) => {
                                const percentage = activeStaff.length > 0 ? Math.round((count / activeStaff.length) * 100) : 0;
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--gray-darker); border-radius: 8px;">
                                        <span style="color: var(--white-soft); font-size: 14px; font-weight: 600;">${role}</span>
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <span style="color: var(--gray-light); font-size: 14px;">${count} membros</span>
                                            <span style="color: var(--gray-text); font-size: 12px;">(${percentage}%)</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ` : '<p style="color: var(--gray-text); text-align: center;">Nenhum dado disponível</p>'}
                    </div>
                </div>
                
                <!-- RESUMO DE DESEMPENHO -->
                <div style="margin-bottom: 32px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-trophy" style="color: var(--warning); margin-right: 8px;"></i>
                        Resumo de Desempenho
                    </h2>
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div>
                                <div style="font-size: 18px; font-weight: 600; color: var(--white-soft); margin-bottom: 8px;">Taxa de Conclusão</div>
                                <div style="font-size: 32px; font-weight: 700; color: var(--success);">
                                    ${totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0}%
                                </div>
                                <div style="font-size: 12px; color: var(--gray-text); margin-top: 4px;">
                                    ${completedTasks} de ${totalTasks} tarefas
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 18px; font-weight: 600; color: var(--white-soft); margin-bottom: 8px;">Taxa de Resolução</div>
                                <div style="font-size: 32px; font-weight: 700; color: var(--primary);">
                                    ${pendencias.length > 0 ? Math.round((resolvedPendencias / pendencias.length) * 100) : 0}%
                                </div>
                                <div style="font-size: 12px; color: var(--gray-text); margin-top: 4px;">
                                    ${resolvedPendencias} de ${pendencias.length} pendencias
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 18px; font-weight: 600; color: var(--white-soft); margin-bottom: 8px;">Média de Tarefas/Staff</div>
                                <div style="font-size: 32px; font-weight: 700; color: var(--warning);">
                                    ${activeStaff.length > 0 ? Math.round(totalTasks / activeStaff.length) : 0}
                                </div>
                                <div style="font-size: 12px; color: var(--gray-text); margin-top: 4px;">
                                    Por membro ativo
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- NOTA -->
                <div style="background: var(--gray-darker); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border); text-align: center;">
                    <p style="color: var(--gray-text); font-size: 13px; line-height: 1.6; margin: 0;">
                        <i class="fas fa-info-circle" style="color: var(--primary); margin-right: 8px;"></i>
                        Estes relatórios são atualizados em tempo real. Para análises mais detalhadas, use a seção de Ranking.
                    </p>
                </div>
            `;
            
            document.querySelector('.content-card').innerHTML = content;
        }

        async function loadWarnings() {
            const navSeq = activeNavSeq;
            try { renderSectionLoading('⚠️ Advertências'); } catch (e) {}
            await nextFrame();

            // Buscar dados em paralelo (melhora navegação)
            const [staff, warningsRaw] = await Promise.all([
                getData('txd_staff', false),
                getData('txd_warnings', false)
            ]);
            if (navSeq !== activeNavSeq) return;
            if (Array.isArray(staff)) staffData = staff;
            
            const warnings = Array.isArray(warningsRaw) ? warningsRaw : [];
            
            // Estatísticas
            const totalWarnings = warnings.length;
            const activeWarnings = warnings.filter(w => w.status === 'active' || !w.status).length;
            const warningsByLevel = {
                leve: warnings.filter(w => w.level === 'leve').length,
                moderada: warnings.filter(w => w.level === 'moderada').length,
                grave: warnings.filter(w => w.level === 'grave').length
            };
            
            // Agrupar por usuário
            const warningsByUser = {};
            warnings.forEach(w => {
                const userId = w.userId || w.user_id;
                const userName = w.userName || w.user_name || 'Desconhecido';
                if (!warningsByUser[userId]) {
                    warningsByUser[userId] = {
                        userId: userId,
                        userName: userName,
                        warnings: [],
                        total: 0,
                        active: 0,
                        byLevel: { leve: 0, moderada: 0, grave: 0 }
                    };
                }
                warningsByUser[userId].warnings.push(w);
                warningsByUser[userId].total++;
                if (w.status === 'active' || !w.status) {
                    warningsByUser[userId].active++;
                }
                if (w.level) {
                    warningsByUser[userId].byLevel[w.level] = (warningsByUser[userId].byLevel[w.level] || 0) + 1;
                }
            });
            
            // Ordenar usuários por total de advertências (mais advertências primeiro)
            const usersSorted = Object.values(warningsByUser).sort((a, b) => b.total - a.total);
            
            const canCreate = hasPermission('warning.create') || hasPermission('moderacao');
            const canView = hasPermission('warning.view') || hasPermission('moderacao') || currentUser.role === 'Owner' || currentUser.role === 'CEO';
            
            const content = `
                <h1 id="sectionTitle">⚠️ Gestão de Advertências</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Sistema completo de advertências e medidas disciplinares</p>
                
                ${canCreate ? `
                <div style="margin-bottom: 24px;">
                    <button class="btn-modal btn-danger" onclick="openNewWarningModal()">
                        <i class="fas fa-exclamation-triangle"></i> Aplicar Nova Advertência
                    </button>
                </div>
                ` : ''}
                
                <!-- ESTATÍSTICAS -->
                <div style="margin-bottom: 32px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-chart-bar" style="color: var(--gray-text); margin-right: 8px;"></i>
                        Estatísticas Gerais
                    </h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--danger); margin-bottom: 8px;">${totalWarnings}</div>
                            <div style="font-size: 14px; color: var(--gray-light);">Total de Advertências</div>
                            <div style="font-size: 12px; color: var(--gray-text); margin-top: 4px;">${activeWarnings} ativas</div>
                        </div>
                        <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--success); margin-bottom: 8px;">${warningsByLevel.leve}</div>
                            <div style="font-size: 14px; color: var(--gray-light);">Leves</div>
                        </div>
                        <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--warning); margin-bottom: 8px;">${warningsByLevel.moderada}</div>
                            <div style="font-size: 14px; color: var(--gray-light);">Moderadas</div>
                        </div>
                        <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--danger); margin-bottom: 8px;">${warningsByLevel.grave}</div>
                            <div style="font-size: 14px; color: var(--gray-light);">Graves</div>
                        </div>
                        <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--white-soft); margin-bottom: 8px;">${Object.keys(warningsByUser).length}</div>
                            <div style="font-size: 14px; color: var(--gray-light);">Membros com Advertências</div>
                        </div>
                    </div>
                </div>
                
                <!-- LISTA DE ADVERTÊNCIAS POR USUÁRIO -->
                <div style="margin-bottom: 32px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-users" style="color: var(--gray-text); margin-right: 8px;"></i>
                        Advertências por Usuário
                    </h2>
                    ${usersSorted.length > 0 ? `
                    <div style="display: grid; gap: 16px;">
                        ${usersSorted.map(userData => {
                            const levelColors = {
                                leve: '#00ff88',
                                moderada: '#ffaa00',
                                grave: '#ff3366'
                            };
                            const levelLabels = {
                                leve: 'Leve',
                                moderada: 'Moderada',
                                grave: 'Grave'
                            };
                            
                            // Ordenar advertências por data (mais recentes primeiro)
                            const sortedWarnings = userData.warnings.sort((a, b) => {
                                const dateA = new Date(a.createdAt || a.created_at || 0);
                                const dateB = new Date(b.createdAt || b.created_at || 0);
                                return dateB - dateA;
                            });
                            
                            return `
                                <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px; flex-wrap: wrap; gap: 16px;">
                                        <div style="flex: 1;">
                                            <h3 style="color: var(--white-soft); font-size: 18px; margin-bottom: 8px;">
                                                ${userData.userName}
                                            </h3>
                                            <div style="display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 8px;">
                                                <div>
                                                    <span style="color: var(--gray-text); font-size: 12px;">Total:</span>
                                                    <span style="color: var(--white-soft); font-size: 14px; margin-left: 4px; font-weight: 600;">${userData.total}</span>
                                                </div>
                                                <div>
                                                    <span style="color: var(--gray-text); font-size: 12px;">Ativas:</span>
                                                    <span style="color: var(--danger); font-size: 14px; margin-left: 4px; font-weight: 600;">${userData.active}</span>
                                                </div>
                                                ${Object.entries(userData.byLevel).map(([level, count]) => count > 0 ? `
                                                    <div>
                                                        <span style="color: var(--gray-text); font-size: 12px;">${levelLabels[level]}:</span>
                                                        <span style="color: ${levelColors[level]}; font-size: 14px; margin-left: 4px; font-weight: 600;">${count}</span>
                                                    </div>
                                                ` : '').join('')}
                                            </div>
                                        </div>
                                        <button class="btn btn-secondary" onclick="viewUserWarnings(${userData.userId})" style="padding: 8px 16px;">
                                            <i class="fas fa-eye"></i> Ver Histórico
                                        </button>
                                    </div>
                                    
                                    <!-- Últimas 3 advertências -->
                                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-border);">
                                        <div style="font-size: 12px; color: var(--gray-text); margin-bottom: 8px; font-weight: 600;">Últimas Advertências:</div>
                                        <div style="display: flex; flex-direction: column; gap: 8px;">
                                            ${sortedWarnings.slice(0, 3).map(warning => {
                                                const warningDate = new Date(warning.createdAt || warning.created_at).toLocaleDateString('pt-BR');
                                                const levelColor = levelColors[warning.level] || '#6F7276';
                                                const levelLabel = levelLabels[warning.level] || warning.level;
                                                const statusBadge = warning.status === 'active' || !warning.status ? 'badge-danger' : 
                                                                   warning.status === 'expired' ? 'badge-secondary' : 'badge-success';
                                                const statusText = warning.status === 'active' || !warning.status ? 'Ativa' : 
                                                                  warning.status === 'expired' ? 'Expirada' : 'Revogada';
                                                
                                                return `
                                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--gray-darker); border-radius: 8px; border-left: 4px solid ${levelColor};">
                                                        <div style="flex: 1;">
                                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                                                <span style="color: ${levelColor}; font-size: 14px; font-weight: 600;">${levelLabel}</span>
                                                                <span style="color: var(--gray-text); font-size: 12px;">•</span>
                                                                <span style="color: var(--gray-text); font-size: 12px;">${warningDate}</span>
                                                            </div>
                                                            <div style="color: var(--white-soft); font-size: 13px;">${warning.reason || 'Sem motivo especificado'}</div>
                                                        </div>
                                                        <span class="badge ${statusBadge}" style="margin-left: 12px;">${statusText}</span>
                                                    </div>
                                                `;
                                            }).join('')}
                                            ${sortedWarnings.length === 0 ? '<p style="color: var(--gray-text); font-size: 12px; text-align: center; padding: 12px;">Nenhuma advertência registrada</p>' : ''}
                                        </div>
                                        ${sortedWarnings.length > 3 ? `
                                        <div style="margin-top: 12px; text-align: center;">
                                            <button class="btn btn-secondary" onclick="viewUserWarnings(${userData.userId})" style="padding: 6px 12px; font-size: 12px;">
                                                Ver todas (${sortedWarnings.length})
                                            </button>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    ` : `
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 60px 40px; text-align: center; border: 1px solid var(--gray-border);">
                        <div style="font-size: 64px; margin-bottom: 24px; opacity: 0.3;">✅</div>
                        <h3 style="color: var(--white-soft); font-size: 20px; margin-bottom: 12px;">Nenhuma advertência registrada</h3>
                        <p style="color: var(--gray-text); font-size: 14px; line-height: 1.6;">
                            O sistema de advertências está pronto para uso.<br>
                            ${canCreate ? 'Clique em "Aplicar Nova Advertência" para começar.' : 'Entre em contato com um administrador para aplicar advertências.'}
                        </p>
                    </div>
                    `}
                </div>
            `;
            
            document.querySelector('.content-card').innerHTML = content;
        }
        
        // Abrir modal para criar nova advertência
        function openNewWarningModal() {
            if (!hasPermission('warning.create') && !hasPermission('moderacao')) {
                alert('Você não tem permissão para aplicar advertências.');
                return;
            }
            
            // Limpar formulário
            document.getElementById('warningUserId').value = '';
            document.getElementById('warningUserName').value = '';
            document.getElementById('warningLevel').value = 'leve';
            document.getElementById('warningReason').value = '';
            document.getElementById('warningDescription').value = '';
            document.getElementById('warningExpiresAt').value = '';
            
            // Preencher lista de usuários
            const staffArray = Array.isArray(staffData) ? staffData : [];
            const activeStaff = staffArray.filter(s => s.status === 'Ativo');
            const userSelect = document.getElementById('warningUserId');
            userSelect.innerHTML = '<option value="">Selecione um usuário...</option>';
            activeStaff.forEach(staff => {
                const option = document.createElement('option');
                option.value = staff.id;
                option.textContent = `${staff.displayName || staff.name} (${staff.role})`;
                option.setAttribute('data-name', staff.displayName || staff.name);
                userSelect.appendChild(option);
            });
            
            // Atualizar nome quando selecionar usuário
            userSelect.onchange = function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.value) {
                    document.getElementById('warningUserName').value = selectedOption.getAttribute('data-name') || '';
                } else {
                    document.getElementById('warningUserName').value = '';
                }
            };
            
            document.getElementById('warningModal').classList.add('active');
        }
        
        // Visualizar advertências de um usuário específico
        async function viewUserWarnings(userId) {
            const warningsRaw = await getData('txd_warnings', false);
            const warnings = Array.isArray(warningsRaw) ? warningsRaw : [];
            const userWarnings = warnings.filter(w => (w.userId || w.user_id) == userId)
                .sort((a, b) => {
                    const dateA = new Date(a.createdAt || a.created_at || 0);
                    const dateB = new Date(b.createdAt || b.created_at || 0);
                    return dateB - dateA;
                });
            
            const user = Array.isArray(staffData) ? staffData.find(s => s.id == userId) : null;
            const userName = user ? (user.displayName || user.name) : 'Usuário Desconhecido';
            
            const levelColors = {
                leve: '#00ff88',
                moderada: '#ffaa00',
                grave: '#ff3366'
            };
            const levelLabels = {
                leve: 'Leve',
                moderada: 'Moderada',
                grave: 'Grave'
            };
            
            const content = `
                <div style="margin-bottom: 24px;">
                    <button class="btn btn-secondary" onclick="loadWarnings()">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                </div>
                
                <h2 style="color: var(--white-soft); margin-bottom: 24px;">
                    <i class="fas fa-user-shield"></i> Histórico de Advertências - ${userName}
                </h2>
                
                ${userWarnings.length > 0 ? `
                <div style="display: grid; gap: 16px;">
                    ${userWarnings.map(warning => {
                        const warningDate = new Date(warning.createdAt || warning.created_at).toLocaleString('pt-BR');
                        const levelColor = levelColors[warning.level] || '#6F7276';
                        const levelLabel = levelLabels[warning.level] || warning.level;
                        const statusBadge = warning.status === 'active' || !warning.status ? 'badge-danger' : 
                                           warning.status === 'expired' ? 'badge-secondary' : 'badge-success';
                        const statusText = warning.status === 'active' || !warning.status ? 'Ativa' : 
                                          warning.status === 'expired' ? 'Expirada' : 'Revogada';
                        const issuedBy = warning.issuedBy || warning.issued_by || 'Sistema';
                        const canRevoke = (hasPermission('warning.create') || hasPermission('moderacao')) && 
                                         (warning.status === 'active' || !warning.status);
                        
                        return `
                            <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border); border-left: 4px solid ${levelColor};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px; flex-wrap: wrap; gap: 16px;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                            <span class="badge" style="background: ${levelColor}; color: white; padding: 6px 12px; border-radius: 6px; font-weight: 600;">
                                                ${levelLabel}
                                            </span>
                                            <span class="badge ${statusBadge}">${statusText}</span>
                                        </div>
                                        <h3 style="color: var(--white-soft); font-size: 16px; margin-bottom: 8px;">
                                            ${warning.reason || 'Sem motivo especificado'}
                                        </h3>
                                        ${warning.description ? `
                                        <p style="color: var(--gray-light); font-size: 14px; line-height: 1.6; margin-bottom: 12px;">
                                            ${warning.description}
                                        </p>
                                        ` : ''}
                                        <div style="display: flex; flex-wrap: wrap; gap: 16px; font-size: 12px; color: var(--gray-text);">
                                            <div>
                                                <i class="fas fa-user"></i> Aplicada por: <strong style="color: var(--white-soft);">${issuedBy}</strong>
                                            </div>
                                            <div>
                                                <i class="fas fa-calendar"></i> Data: <strong style="color: var(--white-soft);">${warningDate}</strong>
                                            </div>
                                            ${warning.expiresAt || warning.expires_at ? `
                                            <div>
                                                <i class="fas fa-clock"></i> Expira em: <strong style="color: var(--white-soft);">${new Date(warning.expiresAt || warning.expires_at).toLocaleDateString('pt-BR')}</strong>
                                            </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    ${canRevoke ? `
                                    <button class="btn btn-success" onclick="revokeWarning(${warning.id})" style="padding: 8px 16px;">
                                        <i class="fas fa-check-circle"></i> Revogar
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                ` : `
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 60px 40px; text-align: center; border: 1px solid var(--gray-border);">
                    <div style="font-size: 64px; margin-bottom: 24px; opacity: 0.3;">✅</div>
                    <h3 style="color: var(--white-soft); font-size: 20px; margin-bottom: 12px;">Nenhuma advertência</h3>
                    <p style="color: var(--gray-text); font-size: 14px; line-height: 1.6;">
                        ${userName} não possui advertências registradas.
                    </p>
                </div>
                `}
            `;
            
            document.querySelector('.content-card').innerHTML = content;
        }
        
        // Salvar nova advertência
        async function saveWarning(event) {
            event.preventDefault();
            
            if (!hasPermission('warning.create') && !hasPermission('moderacao')) {
                alert('Você não tem permissão para aplicar advertências.');
                return;
            }
            
            const userId = parseInt(document.getElementById('warningUserId').value);
            const userName = document.getElementById('warningUserName').value.trim();
            const level = document.getElementById('warningLevel').value;
            const reason = document.getElementById('warningReason').value.trim();
            const description = document.getElementById('warningDescription').value.trim();
            const expiresAt = document.getElementById('warningExpiresAt').value;
            
            // Validações
            if (!userId || !userName) {
                alert('Por favor, selecione um usuário.');
                return;
            }
            
            if (!reason) {
                alert('Por favor, informe o motivo da advertência.');
                return;
            }
            
            try {
                // Buscar advertências existentes
                const existingWarnings = await getData('txd_warnings', false);
                const warningsArray = Array.isArray(existingWarnings) ? existingWarnings : [];
                
                // Criar nova advertência
                const newWarning = {
                    id: Date.now(),
                    userId: userId,
                    userName: userName,
                    level: level,
                    reason: reason,
                    description: description || null,
                    issuedBy: currentUser.displayName || currentUser.name || 'Sistema',
                    issuedById: currentUser.id,
                    status: 'active',
                    expiresAt: expiresAt || null,
                    createdAt: new Date().toISOString()
                };
                
                warningsArray.push(newWarning);
                
                // Salvar no Supabase
                await saveData('txd_warnings', warningsArray);
                
                // Limpar cache
                clearCacheKey('txd_warnings');
                
                // Notificar Discord
                const levelLabels = {
                    leve: 'Leve',
                    moderada: 'Moderada',
                    grave: 'Grave'
                };
                const levelColors = {
                    leve: 0x00ff88,
                    moderada: 0xffaa00,
                    grave: 0xff3366
                };
                
                sendDiscordNotification('staff', '⚠️ Advertência Aplicada', 
                    `Nova advertência ${levelLabels[level].toLowerCase()} aplicada`,
                    [
                        { name: '👤 Usuário', value: userName, inline: true },
                        { name: '📊 Nível', value: levelLabels[level], inline: true },
                        { name: '📝 Motivo', value: reason, inline: false },
                        { name: '👨‍💼 Aplicada por', value: currentUser.displayName || currentUser.name, inline: true },
                        { name: '📅 Data', value: new Date().toLocaleDateString('pt-BR'), inline: true }
                    ]
                );
                
                // Log da ação
                logSystemAction('Advertência aplicada', 'Advertências', {
                    userId: userId,
                    userName: userName,
                    level: level,
                    reason: reason,
                    issuedBy: currentUser.name
                });
                
                alert(`✅ Advertência ${levelLabels[level].toLowerCase()} aplicada com sucesso!`);
                closeModal('warningModal');
                loadWarnings();
                
            } catch (error) {
                console.error('Erro ao salvar advertência:', error);
                alert(`Erro ao salvar advertência: ${error.message || 'Erro desconhecido'}`);
            }
        }
        
        // Revogar advertência
        async function revokeWarning(warningId) {
            if (!confirm('Deseja revogar esta advertência? Esta ação não pode ser desfeita.')) {
                return;
            }
            
            if (!hasPermission('warning.create') && !hasPermission('moderacao')) {
                alert('Você não tem permissão para revogar advertências.');
                return;
            }
            
            try {
                // Buscar advertência diretamente do Supabase
                const { data: directWarning, error: directError } = await supabaseClient
                    .from('warnings')
                    .select('*')
                    .eq('id', warningId)
                    .single();
                
                if (directError || !directWarning) {
                    console.error('Erro ao buscar advertência:', directError);
                    alert('Advertência não encontrada. Recarregue a página e tente novamente.');
                    return;
                }
                
                // Atualizar status no Supabase
                const { error: updateError } = await supabaseClient
                    .from('warnings')
                    .update({
                        status: 'revoked',
                        revoked_by: currentUser.name || currentUser.displayName,
                        revoked_at: new Date().toISOString()
                    })
                    .eq('id', warningId);
                
                if (updateError) {
                    console.error('Erro ao revogar advertência:', updateError);
                    throw updateError;
                }
                
                // Limpar cache
                clearCacheKey('txd_warnings');
                
                // Notificar Discord
                sendDiscordNotification('staff', '✅ Advertência Revogada', 
                    `Advertência revogada`,
                    [
                        { name: '👤 Usuário', value: directWarning.user_name || 'N/A', inline: true },
                        { name: '📝 Motivo Original', value: directWarning.reason || 'N/A', inline: true },
                        { name: '✅ Revogada por', value: currentUser.name || currentUser.displayName, inline: true }
                    ]
                );
                
                // Log da ação
                logSystemAction('Advertência revogada', 'Advertências', {
                    warningId: warningId,
                    userId: directWarning.user_id,
                    userName: directWarning.user_name,
                    revokedBy: currentUser.name
                });
                
                alert(`✅ Advertência revogada com sucesso!`);
                
                // Recarregar interface
                loadWarnings();
                
            } catch (error) {
                console.error('Erro ao revogar advertência:', error);
                alert('Erro ao revogar advertência. Tente novamente.');
            }
        }

        // ========== SISTEMA DE PENDÊNCIAS ==========

        // Filtro (em memória) para exibir apenas pendências assumidas pelo usuário atual
        let pendencyAssigneeFilterMode = null;
        
        async function loadPendencies() {
            const navSeq = activeNavSeq;
            try { renderSectionLoading('📋 Pendências'); } catch (e) {}
            await nextFrame();
            // aquecer dados em background (não bloqueia)
            loadSectionData('pendencias').catch(() => {});
            await ensurePendenciesLoaded(false);
            if (navSeq !== activeNavSeq) return;
            const pendencies = Array.from(state.pendencies.byId.values());
            const isCLevel = isCLevelRole(currentUser?.roles || currentUser?.role);
            const isDev = isDevRole(currentUser?.roles || currentUser?.role);
            const canViewAll = hasPermission('pendency.view_all') || hasPermission('dashboard') || isCLevel;

            const currentUserId = String(currentUser?.id ?? '');
            const currentUserName = (currentUser?.name || currentUser?.displayName || '').toString();

            const isMinePendency = (p) => {
                const userId = String(p?.userId ?? p?.user_id ?? '');
                const userName = (p?.userName || p?.user_name || '').toString();
                return (currentUserId && userId && userId === currentUserId) || (currentUserName && userName && userName === currentUserName);
            };

            const myPendencies = pendencies.filter(isMinePendency);

            const isAssignedToMe = (p) => {
                const assignedUserId = p?.assignedUserId ?? p?.assigned_user_id ?? null;
                const assignedUserName = p?.assignedUserName ?? p?.assigned_user_name ?? null;
                return isCurrentUserId(assignedUserId) || isCurrentUserName(assignedUserName);
            };

            const visiblePendencies = pendencies.filter(p => {
                if (isMinePendency(p)) return true;
                if (isCLevel) return true; // Owner/CEO/C-Level vê tudo
                if (canViewAll) return true;

                const area = getEffectivePendencyArea(p);
                const assignedRole = (p?.assignedRole || p?.assigned_role || '').toString().toLowerCase().trim();
                const assignedUserId = String(p?.assignedUserId ?? p?.assigned_user_id ?? '');

                if (area === 'geral') return true;
                if (area === 'clevel') return false;
                if (area === 'dev') {
                    return isDev || assignedRole === 'dev' || (assignedUserId && assignedUserId === currentUserId);
                }

                // Fallback antigo baseado em type (compatibilidade)
                const scope = getPendencyScope(p?.type);
                if (scope === 'financial') return false;
                if (scope === 'dev') return isDev;
                return false;
            });

            const canApproveBase = hasPermission('pendency.approve') || hasPermission('dashboard') || isCLevel || isDev;
            const canApprovePendency = (pendency) => {
                if (!canApproveBase) return false;
                if (isFinancialPendencyType(pendency?.type)) return isCLevel;
                if (getPendencyScope(pendency?.type) === 'financial') return isCLevel;

                const area = getEffectivePendencyArea(pendency);
                if (area === 'clevel' && !isCLevel) return false;
                if (area === 'dev' && !(isDev || isCLevel)) return false;
                return true;
            };

            if (pendencyAssigneeFilterMode === null) {
                pendencyAssigneeFilterMode = 'all';
            }
            const assigneeFilterEnabled = canApproveBase;
            const assigneeFilterMode = pendencyAssigneeFilterMode || 'all';

            const pendingPendencies = visiblePendencies.filter(p => normalizePendencyStatusValue(p?.status, p) === 'pending');
            const approvedPendencies = visiblePendencies.filter(p => normalizePendencyStatusValue(p?.status, p) === 'approved');
            const rejectedPendencies = visiblePendencies.filter(p => normalizePendencyStatusValue(p?.status, p) === 'rejected');
            const inProgressPendencies = visiblePendencies.filter(p => normalizePendencyStatusValue(p?.status, p) === 'in_progress');
            const completedPendencies = visiblePendencies.filter(p => normalizePendencyStatusValue(p?.status, p) === 'completed');
            const sortedCompletedPendencies = [...completedPendencies].sort((a, b) => {
                // Priorizar pendências concluídas que foram assumidas por mim (mais fácil de encontrar na aba Concluídas)
                const aMine = isAssignedToMe(a) ? 1 : 0;
                const bMine = isAssignedToMe(b) ? 1 : 0;
                if (aMine !== bMine) return bMine - aMine;

                const aCompleted = new Date(a.completedAt || a.completed_at || a.updatedAt || a.updated_at || a.createdAt || a.created_at || 0).getTime();
                const bCompleted = new Date(b.completedAt || b.completed_at || b.updatedAt || b.updated_at || b.createdAt || b.created_at || 0).getTime();
                return bCompleted - aCompleted;
            });
            const totalPendencies = visiblePendencies.length;
            const urgentPendencies = visiblePendencies.filter(p => p.priority === 'urgent' || p.priority === 'Urgente').length;
            const myPendingCount = pendingPendencies.length;
            const sortPendencies = (list) => {
                const priorityOrder = { 'urgent': 0, 'Urgente': 0, 'high': 1, 'Alta': 1, 'medium': 2, 'Média': 2, 'low': 3, 'Baixa': 3 };
                return list.sort((a, b) => {
                    const priorityA = priorityOrder[a.priority] ?? 2;
                    const priorityB = priorityOrder[b.priority] ?? 2;
                    if (priorityA !== priorityB) return priorityA - priorityB;
                    const dateA = new Date(a.createdAt || a.created_at || 0);
                    const dateB = new Date(b.createdAt || b.created_at || 0);
                    return dateB - dateA;
                });
            };
            const sortedPending = sortPendencies([...pendingPendencies]);
            const sortedApproved = sortPendencies([...approvedPendencies]);
            const sortedRejected = sortPendencies([...rejectedPendencies]);
            const sortedInProgress = sortPendencies([...inProgressPendencies]);
            const canCreate = true;
            const canApprove = canApproveBase;
            const canEdit = hasPermission('pendency.edit') || hasPermission('dashboard');
            const content = `
                <h1 id="sectionTitle">📋 Pendências</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Solicite pendências e acompanhe o andamento. Pendências financeiras são tratadas apenas por C-Level.</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <div style="width: 40px; height: 40px; border-radius: 8px; background: var(--primary); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-clipboard-list" style="color: white; font-size: 18px;"></i>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--white-soft);">${totalPendencies}</div>
                                <div style="font-size: 12px; color: var(--gray-text);">Total</div>
                            </div>
                        </div>
                    </div>
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <div style="width: 40px; height: 40px; border-radius: 8px; background: var(--danger); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-clock" style="color: white; font-size: 18px;"></i>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--white-soft);">${myPendingCount}</div>
                                <div style="font-size: 12px; color: var(--gray-text);">Pendentes</div>
                            </div>
                        </div>
                    </div>
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <div style="width: 40px; height: 40px; border-radius: 8px; background: var(--warning); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-spinner" style="color: white; font-size: 18px;"></i>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--white-soft);">${inProgressPendencies.length}</div>
                                <div style="font-size: 12px; color: var(--gray-text);">Em Andamento</div>
                            </div>
                        </div>
                    </div>
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <div style="width: 40px; height: 40px; border-radius: 8px; background: var(--success); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-check-circle" style="color: white; font-size: 18px;"></i>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--white-soft);">${completedPendencies.length}</div>
                                <div style="font-size: 12px; color: var(--gray-text);">Concluídas</div>
                            </div>
                        </div>
                    </div>
                    ${urgentPendencies > 0 ? `
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border); border-left: 4px solid var(--danger);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <div style="width: 40px; height: 40px; border-radius: 8px; background: var(--danger); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-exclamation-triangle" style="color: white; font-size: 18px;"></i>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--white-soft);">${urgentPendencies}</div>
                                <div style="font-size: 12px; color: var(--gray-text);">Urgentes</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
                ${canCreate ? `
                <div style="margin-bottom: 24px;">
                    <button class="btn-modal btn-success" onclick="openNewPendencyModal()">
                        <i class="fas fa-plus"></i> Nova Solicitação de Pendência
                    </button>
                </div>
                ` : ''}
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 16px; margin-bottom: 24px; border: 1px solid var(--gray-border);">
                    <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
                        <select id="pendencyStatusFilter" onchange="filterPendencies()" style="padding: 8px 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 6px; color: var(--white-soft); font-size: 14px; cursor: pointer;">
                            <option value="all">Todos os Status</option>
                            <option value="pending">Pendentes</option>
                            <option value="approved">Aprovadas</option>
                            <option value="in_progress">Em Andamento</option>
                            <option value="completed">Concluídas</option>
                            <option value="rejected">Rejeitadas</option>
                        </select>
                        <select id="pendencyTypeFilter" onchange="filterPendencies()" style="padding: 8px 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 6px; color: var(--white-soft); font-size: 14px; cursor: pointer;">
                            <option value="all">Todos os Tipos</option>
                            <option value="bugs">Bugs</option>
                            <option value="mapas">Mapas</option>
                            <option value="carros">Carros</option>
                            <option value="roupas">Roupas</option>
                            <option value="itens">Itens</option>
                            <option value="coordenadas">Coordenadas</option>
                            <option value="logs">Logs</option>
                            <option value="atualizacoes">Atualizações</option>
                            <option value="doacoes">Doações</option>
                        </select>
                        <select id="pendencyPriorityFilter" onchange="filterPendencies()" style="padding: 8px 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 6px; color: var(--white-soft); font-size: 14px; cursor: pointer;">
                            <option value="all">Todas as Prioridades</option>
                            <option value="urgent">Urgente</option>
                            <option value="high">Alta</option>
                            <option value="medium">Média</option>
                            <option value="low">Baixa</option>
                        </select>
                        ${assigneeFilterEnabled ? `
                        <select id="pendencyAssigneeFilter" onchange="setPendencyAssigneeFilterMode(this.value)" style="padding: 8px 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 6px; color: var(--white-soft); font-size: 14px; cursor: pointer;">
                            <option value="mine" ${assigneeFilterMode === 'mine' ? 'selected' : ''}>Somente minhas (assumidas)</option>
                            <option value="unassigned" ${assigneeFilterMode === 'unassigned' ? 'selected' : ''}>Sem responsável</option>
                            <option value="all" ${assigneeFilterMode === 'all' ? 'selected' : ''}>Todas</option>
                        </select>
                        ` : ''}
                        <input type="text" id="pendencySearchInput" placeholder="Buscar pendências..." onkeyup="filterPendencies()" style="flex: 1; min-width: 200px; padding: 8px 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 6px; color: var(--white-soft); font-size: 14px;">
                        <button class="btn btn-secondary" onclick="clearPendencyFilters()" style="padding: 8px 16px;">
                            <i class="fas fa-times"></i> Limpar
                        </button>
                    </div>
                </div>
                ${sortedPending.length > 0 ? `
                <div style="margin-bottom: 32px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-hourglass-half" style="color: var(--danger); margin-right: 8px;"></i>
                        Pendentes (${sortedPending.length})
                    </h2>
                    <div style="display: grid; gap: 16px;" id="pendingPendenciesList">
                        ${sortedPending.map(p => renderPendencyCard(p, canApprovePendency(p), canEdit, false)).join('')}
                    </div>
                </div>
                ` : ''}
                ${sortedInProgress.length > 0 ? `
                <div style="margin-bottom: 32px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-spinner" style="color: var(--warning); margin-right: 8px;"></i>
                        Em Andamento (${sortedInProgress.length})
                    </h2>
                    <div style="display: grid; gap: 16px;" id="inProgressPendenciesList">
                        ${sortedInProgress.map(p => renderPendencyCard(p, canApprovePendency(p), canEdit, false)).join('')}
                    </div>
                </div>
                ` : ''}
                ${sortedApproved.length > 0 ? `
                <div style="margin-bottom: 32px;">
                    <details style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        <summary style="cursor: pointer; color: var(--white-soft); font-size: 18px; font-weight: 600; margin-bottom: 16px; user-select: none;">
                            <i class="fas fa-check" style="color: var(--success); margin-right: 8px;"></i>
                            Aprovadas (${sortedApproved.length})
                        </summary>
                        <div style="display: grid; gap: 16px; margin-top: 16px;" id="approvedPendenciesList">
                            ${sortedApproved.map(p => renderPendencyCard(p, canApprovePendency(p), canEdit, false)).join('')}
                        </div>
                    </details>
                </div>
                ` : ''}
                ${sortedRejected.length > 0 ? `
                <div style="margin-bottom: 32px;">
                    <details style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        <summary style="cursor: pointer; color: var(--white-soft); font-size: 18px; font-weight: 600; margin-bottom: 16px; user-select: none;">
                            <i class="fas fa-times" style="color: var(--danger); margin-right: 8px;"></i>
                            Reprovadas (${sortedRejected.length})
                        </summary>
                        <div style="display: grid; gap: 16px; margin-top: 16px;" id="rejectedPendenciesList">
                            ${sortedRejected.slice(0, 10).map(p => renderPendencyCard(p, canApprovePendency(p), canEdit, false)).join('')}
                            ${sortedRejected.length > 10 ? `<p style="color: var(--gray-text); font-size: 12px; text-align: center; margin-top: 8px;">Mostrando últimos 10. Total: ${sortedRejected.length}</p>` : ''}
                        </div>
                    </details>
                </div>
                ` : ''}
                ${!canApprove && myPendencies.length > 0 ? `
                <div style="margin-bottom: 32px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-clipboard-list" style="color: var(--primary); margin-right: 8px;"></i>
                        Minhas Pendências (${myPendencies.length})
                    </h2>
                    <div style="display: grid; gap: 16px;" id="myPendenciesList">
                        ${sortPendencies([...myPendencies]).map(p => renderPendencyCard(p, canApprovePendency(p), false, false)).join('')}
                    </div>
                </div>
                ` : ''}
                ${completedPendencies.length > 0 ? `
                <div style="margin-bottom: 32px;">
                    <details style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        <summary style="cursor: pointer; color: var(--white-soft); font-size: 18px; font-weight: 600; margin-bottom: 16px; user-select: none;">
                            <i class="fas fa-check-circle" style="color: var(--success); margin-right: 8px;"></i>
                            Concluídas (${completedPendencies.length})
                        </summary>
                        <div style="display: grid; gap: 16px; margin-top: 16px;">
                            ${sortedCompletedPendencies.slice(0, 10).map(p => renderPendencyCard(p, canApprovePendency(p), false, true)).join('')}
                            ${completedPendencies.length > 10 ? `<p style="color: var(--gray-text); font-size: 12px; text-align: center; margin-top: 8px;">Mostrando últimas 10. Total: ${completedPendencies.length}</p>` : ''}
                        </div>
                    </details>
                </div>
                ` : ''}
                ${visiblePendencies.length === 0 ? `
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 60px 40px; text-align: center; border: 1px solid var(--gray-border);">
                    <div style="font-size: 64px; margin-bottom: 24px; opacity: 0.3;">📋</div>
                    <h3 style="color: var(--white-soft); font-size: 20px; margin-bottom: 12px;">Nenhuma pendência encontrada</h3>
                    <p style="color: var(--gray-text); font-size: 14px; line-height: 1.6;">
                        ${canCreate ? 'Comece criando sua primeira solicitação de pendência!' : 'Entre em contato com um administrador.'}
                    </p>
                </div>
                ` : ''}
            `;
            document.querySelector('.content-card').innerHTML = content;
            try { filterPendencies(); } catch (e) {}
        }
        
        function renderPendencyCard(pendency, canApprove, canEdit, isCompleted = false, ignoreFilters = false) {
            const priority = pendency.priority || 'medium';
            const priorityColors = {
                'urgent': { bg: 'var(--danger)', text: 'white', label: 'Urgente' },
                'Urgente': { bg: 'var(--danger)', text: 'white', label: 'Urgente' },
                'high': { bg: 'var(--danger)', text: 'white', label: 'Alta' },
                'Alta': { bg: 'var(--danger)', text: 'white', label: 'Alta' },
                'medium': { bg: 'var(--warning)', text: 'white', label: 'Média' },
                'Média': { bg: 'var(--warning)', text: 'white', label: 'Média' },
                'low': { bg: 'var(--success)', text: 'white', label: 'Baixa' },
                'Baixa': { bg: 'var(--success)', text: 'white', label: 'Baixa' }
            };
            const priorityInfo = priorityColors[priority] || priorityColors['medium'];
            const typeLabels = {
                'bugs': 'Bugs',
                'mapas': 'Mapas',
                'carros': 'Carros',
                'roupas': 'Roupas',
                'itens': 'Itens',
                'coordenadas': 'Coordenadas',
                'logs': 'Logs',
                'atualizacoes': 'Atualizações',
                'doacoes': 'Doações'
            };
            const typeLabel = typeLabels[pendency.type] || pendency.type || 'Bugs';
            const financialOnly = isFinancialPendencyType(pendency.type);
            const scope = getPendencyScope(pendency.type); // compatibilidade
            const area = getEffectivePendencyArea(pendency);
            const isDevDestination = area === 'dev';
            const normalizedStatus = normalizePendencyStatusValue(pendency?.status, pendency);
            const isActuallyCompleted = isCompleted || normalizedStatus === 'completed';
            const assignedUserId = String(pendency?.assignedUserId ?? pendency?.assigned_user_id ?? '').trim();
            const assignedUserName = (pendency?.assignedUserName ?? pendency?.assigned_user_name ?? '').toString().trim();
            const isAssignee = isCurrentUserId(assignedUserId) || isCurrentUserName(assignedUserName);
            const canWork = !!(canApprove || isAssignee);
            const isRequester = isCurrentUserId(pendency?.userId ?? pendency?.user_id) || isCurrentUserName(pendency?.userName ?? pendency?.user_name);
            const canEditSelf = isRequester && normalizedStatus === 'pending';
            const canEditThis = (canEdit || canEditSelf) && !['completed', 'rejected'].includes(normalizedStatus);
            const assignedLabel = assignedUserName
                ? assignedUserName
                : (assignedUserId ? `ID ${assignedUserId}` : 'Sem responsável');
            const shouldShowAssignee = area === 'dev' || area === 'clevel' || assignedUserName || assignedUserId;
            const statusLabels = {
                'pending': 'Pendente',
                'in_progress': 'Em Andamento',
                'approved': 'Aprovada',
                'completed': 'Concluída',
                'rejected': 'Rejeitada',
            };
            const statusLabel = statusLabels[normalizedStatus] || 'Pendente';
            const statusColors = {
                'pending': 'var(--warning)',
                'in_progress': 'var(--primary)',
                'approved': 'var(--success)',
                'completed': 'var(--success)',
                'rejected': 'var(--danger)',
            };
            const statusColor = statusColors[normalizedStatus] || 'var(--warning)';
            const createdAt = new Date(pendency.createdAt || pendency.created_at || 0);
            const dueDate = pendency.dueDate || pendency.due_date;
            const isOverdue = dueDate && new Date(dueDate) < new Date() && (normalizedStatus === 'pending' || normalizedStatus === 'in_progress' || normalizedStatus === 'approved');
            return `
                <div class="pendency-card" data-filter-ignore="${ignoreFilters ? '1' : '0'}" data-pendency-id="${pendency.id}" data-status="${normalizedStatus}" data-priority="${priority}" data-type="${pendency.type}" data-assignee-id="${escapeHtml(assignedUserId || '')}" style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border); ${isActuallyCompleted ? 'opacity: 0.7;' : ''} ${isOverdue ? 'border-left: 4px solid var(--danger);' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; flex-wrap: wrap; gap: 12px;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px; flex-wrap: wrap;">
                                <h3 style="color: var(--white-soft); font-size: 18px; margin: 0;">#${pendency.id} - ${pendency.title || 'Sem título'}</h3>
                                <span class="badge" style="background: ${priorityInfo.bg}; color: ${priorityInfo.text}; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">${priorityInfo.label}</span>
                                <span class="badge" style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">${statusLabel}</span>
                                ${financialOnly ? '<span class="badge" style="background: var(--danger); color: white; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">Somente C-Level</span>' : ''}
                                ${isDevDestination ? '<span class="badge" style="background: var(--primary); color: white; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">DEV</span>' : ''}
                                ${isOverdue ? '<span class="badge badge-danger">Vencida</span>' : ''}
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 16px; font-size: 13px; color: var(--gray-light);">
                                <span><i class="fas fa-user"></i> ${pendency.userName || pendency.user_name || 'N/A'}</span>
                                ${shouldShowAssignee ? `<span><i class="fas fa-user-check"></i> ${assignedLabel}</span>` : ''}
                                <span><i class="fas fa-tag"></i> ${typeLabel}</span>
                                <span><i class="fas fa-calendar"></i> ${createdAt.toLocaleDateString('pt-BR')}</span>
                                ${dueDate ? `<span style="color: ${isOverdue ? 'var(--danger)' : 'var(--gray-light)'};"><i class="fas fa-clock"></i> Vence: ${new Date(dueDate).toLocaleDateString('pt-BR')}</span>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            ${!isActuallyCompleted && canApprove && normalizedStatus === 'pending' ? `
                            <button class="btn-modal btn-success" style="padding: 6px 12px; font-size: 12px;" onclick="approvePendency(${pendency.id})" title="Aprovar"><i class="fas fa-check"></i></button>
                            <button class="btn-modal btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="rejectPendency(${pendency.id})" title="Rejeitar"><i class="fas fa-times"></i></button>
                            ` : ''}
                            ${!isActuallyCompleted && canWork && normalizedStatus === 'approved' ? `
                            <button class="btn-modal btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="startPendency(${pendency.id})" title="Iniciar"><i class="fas fa-play"></i></button>
                            <button class="btn-modal btn-success" style="padding: 6px 12px; font-size: 12px;" onclick="completePendency(${pendency.id})" title="Concluir"><i class="fas fa-check-circle"></i></button>
                            ` : ''}
                            ${!isActuallyCompleted && canWork && normalizedStatus === 'in_progress' ? `
                            <button class="btn-modal btn-success" style="padding: 6px 12px; font-size: 12px;" onclick="completePendency(${pendency.id})" title="Concluir"><i class="fas fa-check-circle"></i></button>
                            ` : ''}
                            ${canEditThis ? `
                            <button class="btn-modal btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="openEditPendencyModal(${pendency.id})" title="Editar"><i class="fas fa-edit"></i></button>
                            ` : ''}
                            <button class="btn-modal btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="viewPendencyDetails(${pendency.id})" title="Ver detalhes"><i class="fas fa-eye"></i></button>
                        </div>
                    </div>
                    ${pendency.description ? `
                    <p style="color: var(--gray-light); font-size: 14px; line-height: 1.6; margin-top: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                        ${pendency.description}
                    </p>
                    ` : ''}
                    ${pendency.response ? `
                    <div style="background: var(--gray-darker); border-radius: 8px; padding: 12px; margin-top: 12px; border-left: 3px solid var(--primary);">
                        <div style="font-size: 12px; color: var(--gray-text); margin-bottom: 4px;">Resposta:</div>
                        <div style="font-size: 13px; color: var(--white-soft);">${pendency.response}</div>
                    </div>
                    ` : ''}
                </div>
            `;
        }
        
        function filterPendencies() {
            const statusFilter = document.getElementById('pendencyStatusFilter')?.value || 'all';
            const typeFilter = document.getElementById('pendencyTypeFilter')?.value || 'all';
            const priorityFilter = document.getElementById('pendencyPriorityFilter')?.value || 'all';
            const assigneeFilter = document.getElementById('pendencyAssigneeFilter')?.value || 'all';
            const searchQuery = document.getElementById('pendencySearchInput')?.value.toLowerCase() || '';
            const cards = document.querySelectorAll('.pendency-card:not([data-filter-ignore="1"])');
            cards.forEach(card => {
                const status = card.getAttribute('data-status') || '';
                const priority = card.getAttribute('data-priority') || '';
                const type = card.getAttribute('data-type') || '';
                const assigneeId = (card.getAttribute('data-assignee-id') || '').toString().trim();
                const text = card.textContent.toLowerCase();
                let show = true;
                if (statusFilter !== 'all') {
                    const statusMap = {
                        'pending': ['pending', 'Pendente'],
                        'in_progress': ['in_progress', 'Em Andamento'],
                        'approved': ['approved', 'Aprovada'],
                        'completed': ['completed', 'Concluída'],
                        'rejected': ['rejected', 'Rejeitada']
                    };
                    const validStatuses = statusMap[statusFilter] || [];
                    if (!validStatuses.some(s => status.toLowerCase().includes(s.toLowerCase()))) show = false;
                }
                if (typeFilter !== 'all' && show && type.toLowerCase() !== typeFilter.toLowerCase()) show = false;
                if (priorityFilter !== 'all' && show) {
                    const priorityMap = {
                        'urgent': ['urgent', 'Urgente'],
                        'high': ['high', 'Alta'],
                        'medium': ['medium', 'Média'],
                        'low': ['low', 'Baixa']
                    };
                    const validPriorities = priorityMap[priorityFilter] || [];
                    if (!validPriorities.some(p => priority.toLowerCase().includes(p.toLowerCase()))) show = false;
                }
                if (assigneeFilter !== 'all' && show) {
                    const meId = (typeof getCurrentUserIdString === 'function')
                        ? (getCurrentUserIdString() || '')
                        : (String(currentUser?.id ?? '') || '');
                    const me = String(meId).trim();
                    if (assigneeFilter === 'mine') {
                        if (!me || !assigneeId || assigneeId !== me) show = false;
                    } else if (assigneeFilter === 'unassigned') {
                        if (assigneeId) show = false;
                    }
                }
                if (searchQuery && show && !text.includes(searchQuery)) show = false;
                card.style.display = show ? 'block' : 'none';
            });
        }

        function setPendencyAssigneeFilterMode(mode) {
            pendencyAssigneeFilterMode = String(mode || 'all');
            filterPendencies();
        }
        
        function clearPendencyFilters() {
            if (document.getElementById('pendencyStatusFilter')) document.getElementById('pendencyStatusFilter').value = 'all';
            if (document.getElementById('pendencyTypeFilter')) document.getElementById('pendencyTypeFilter').value = 'all';
            if (document.getElementById('pendencyPriorityFilter')) document.getElementById('pendencyPriorityFilter').value = 'all';
            if (document.getElementById('pendencyAssigneeFilter')) {
                const isCLevel = isCLevelRole(currentUser?.roles || currentUser?.role);
                const isDev = isDevRole(currentUser?.roles || currentUser?.role);
                const mode = 'all';
                pendencyAssigneeFilterMode = mode;
                document.getElementById('pendencyAssigneeFilter').value = mode;
            }
            if (document.getElementById('pendencySearchInput')) document.getElementById('pendencySearchInput').value = '';
            filterPendencies();
        }

        async function loadAreas() {
            // Forçar refresh dos dados do Supabase antes de renderizar
            const areasHtml = await renderAreas(true);
            
            const content = `
                <h1 id="sectionTitle">Áreas de Responsabilidade</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Gestão de áreas e responsáveis</p>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <p style="color: var(--gray-text); font-size: 14px;">
                            Organize a equipe por áreas de atuação e defina líderes e equipes
                        </p>
                    </div>
                    ${hasPermission('staff.manage_roles') ? `
                    <button class="btn-modal" onclick="openAreaModal()">
                        <i class="fas fa-plus"></i> Adicionar Área
                    </button>
                    ` : ''}
                </div>
                
                <div id="areasContainer" style="display: grid; gap: 20px;">
                    ${areasHtml}
                </div>
            `;
            document.querySelector('.content-card').innerHTML = content;
        }
        
        async function renderAreas(forceRefresh = false) {
            const areas = await getAreasData(forceRefresh);
            // Garantir que areas é um array antes de usar map
            if (!Array.isArray(areas)) {
                console.error('getAreasData() não retornou um array:', areas);
                return '<p style="color: var(--gray-text);">Erro ao carregar áreas. Recarregue a página.</p>';
            }
            return areas.map(area => {
                if (!area || !area.id) return '';
                return `
                <div class="area-card" style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                        <div>
                            <h3 style="color: var(--white-soft); font-size: 18px; margin-bottom: 4px;">
                                ${area.icon || '📋'} ${area.name}
                            </h3>
                            ${area.description ? `<p style="color: var(--gray-text); font-size: 13px;">${area.description}</p>` : ''}
                        </div>
                        ${hasPermission('staff.manage_roles') ? `
                        <button class="btn-icon" onclick="editArea('${area.id}')" style="padding: 8px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 6px; color: var(--gray-light); cursor: pointer;">
                            <i class="fas fa-edit"></i>
                        </button>
                        ` : ''}
                    </div>
                    
                    ${area.hasLeader ? `
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i class="fas fa-crown" style="color: var(--warning);"></i>
                            <span style="color: var(--gray-light); font-weight: 600; font-size: 14px;">Líder:</span>
                        </div>
                        <div id="leader-${area.id}" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${area.leader ? `
                                <div class="staff-badge" style="background: var(--black-dark); padding: 8px 12px; border-radius: 6px; display: flex; align-items: center; gap: 8px; border: 1px solid var(--gray-border);">
                                    <span style="color: var(--white-soft); font-size: 13px;">${area.leader}</span>
                                    ${hasPermission('staff.manage_roles') ? `
                                    <button onclick="removeLeader('${area.id}')" style="background: none; border: none; color: var(--danger); cursor: pointer; padding: 0; font-size: 12px;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    ` : ''}
                                </div>
                            ` : `
                                ${hasPermission('staff.manage_roles') ? `
                                <select id="leaderSelect-${area.id}" onchange="assignLeader('${area.id}', this.value)" style="padding: 8px 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 6px; color: var(--white-soft); font-size: 13px; cursor: pointer;">
                                    <option value="">Selecione um líder...</option>
                                    ${getAvailableStaff().map(staff => `
                                        <option value="${staff.name}">${staff.name} (${staff.role})</option>
                                    `).join('')}
                                </select>
                                ` : '<span style="color: var(--gray-text); font-size: 13px;">Nenhum líder atribuído</span>'}
                            `}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i class="fas fa-users" style="color: var(--success);"></i>
                            <span style="color: var(--gray-light); font-weight: 600; font-size: 14px;">Equipe:</span>
                            <span style="color: var(--gray-text); font-size: 12px;">(${area.team.length} membros)</span>
                        </div>
                        <div id="team-${area.id}" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">
                            ${area.team.length > 0 ? area.team.map(member => `
                                <div class="staff-badge" style="background: var(--black-dark); padding: 8px 12px; border-radius: 6px; display: flex; align-items: center; gap: 8px; border: 1px solid var(--gray-border);">
                                    <span style="color: var(--white-soft); font-size: 13px;">${member}</span>
                                    ${hasPermission('staff.manage_roles') ? `
                                    <button onclick="removeTeamMember('${area.id}', '${member}')" style="background: none; border: none; color: var(--danger); cursor: pointer; padding: 0; font-size: 12px;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    ` : ''}
                                </div>
                            `).join('') : `
                                <span style="color: var(--gray-text); font-size: 13px;">Nenhum membro na equipe</span>
                            `}
                        </div>
                        ${hasPermission('staff.manage_roles') ? `
                        <select id="teamSelect-${area.id}" onchange="assignTeamMember('${area.id}', this.value)" style="padding: 8px 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 6px; color: var(--white-soft); font-size: 13px; cursor: pointer; width: 100%; max-width: 300px;">
                            <option value="">Adicionar membro à equipe...</option>
                            ${getAvailableStaffForTeam(area).map(staff => `
                                <option value="${staff.name}">${staff.name} (${staff.role})</option>
                            `).join('')}
                        </select>
                        ` : ''}
                    </div>
                </div>
            `;
            }).filter(html => html !== '').join('');
        }
        
        async function getAreasData(forceRefresh = false) {
            const areasRaw = await getData('txd_areas', forceRefresh);
            // Garantir que areas é sempre um array
            let areas = Array.isArray(areasRaw) ? areasRaw : [];
            
            // Áreas atualizadas conforme solicitado
            const defaultAreas = [
                { id: 'staff', name: 'Responsável Staff', icon: '👥', hasLeader: false, leader: null, team: [], description: 'Gestão geral da equipe' },
                { id: 'marketing', name: 'Marketing', icon: '📢', hasLeader: true, leader: null, team: [], description: 'Marketing e divulgação' },
                { id: 'creator', name: 'Creator', icon: '🎨', hasLeader: true, leader: null, team: [], description: 'Criação de conteúdo' },
                { id: 'eventos', name: 'Eventos', icon: '🎉', hasLeader: true, leader: null, team: [], description: 'Organização de eventos' },
                { id: 'peds', name: 'Peds', icon: '👤', hasLeader: true, leader: null, team: [], description: 'Gestão de PEDs' },
                { id: 'policia', name: 'Polícia', icon: '🚔', hasLeader: true, leader: null, team: [], description: 'Departamento de polícia' },
                { id: 'ilegal', name: 'Ilegal', icon: '⚫', hasLeader: true, leader: null, team: [], description: 'Atividades ilegais' },
                { id: 'mecanica', name: 'Mecânica', icon: '🔧', hasLeader: true, leader: null, team: [], description: 'Oficina mecânica' },
                { id: 'legal', name: 'Legal', icon: '⚖️', hasLeader: true, leader: null, team: [], description: 'Atividades legais' },
                { id: 'hospital', name: 'Hospital', icon: '🏥', hasLeader: true, leader: null, team: [], description: 'Sistema de saúde' },
                { id: 'restaurante', name: 'Restaurante', icon: '🍽️', hasLeader: true, leader: null, team: [], description: 'Restaurantes e bares' },
                { id: 'var', name: 'Var', icon: '🎥', hasLeader: true, leader: null, team: [], description: 'VAR e moderação' }
            ];
            
            // Se não existem áreas, criar padrão (mas não salvar automaticamente)
            if (!Array.isArray(areas) || areas.length === 0) {
                areas = defaultAreas;
                // Não salvar automaticamente aqui - deixar o usuário salvar manualmente se necessário
            } else {
                // Atualizar áreas existentes com novos nomes (mantendo dados existentes)
                const areaMap = {};
                // Garantir que areas é um array antes de usar forEach
                if (Array.isArray(areas)) {
                    areas.forEach(area => {
                        if (area && area.id) {
                            areaMap[area.id] = area;
                        }
                    });
                }
                
                // Atualizar ou adicionar áreas padrão
                defaultAreas.forEach(defaultArea => {
                    if (areaMap[defaultArea.id]) {
                        // Atualizar nome se mudou (mas manter leader e team existentes)
                        areaMap[defaultArea.id].name = defaultArea.name;
                        if (defaultArea.icon) areaMap[defaultArea.id].icon = defaultArea.icon;
                        if (defaultArea.description) areaMap[defaultArea.id].description = defaultArea.description;
                        if (defaultArea.hasLeader !== undefined) areaMap[defaultArea.id].hasLeader = defaultArea.hasLeader;
                    } else {
                        // Adicionar nova área
                        areaMap[defaultArea.id] = defaultArea;
                    }
                });
                
                // Remover áreas que não estão mais na lista padrão (exceto staff)
                const validIds = defaultAreas.map(a => a.id);
                areas = Object.values(areaMap).filter(area => area && (validIds.includes(area.id) || area.id === 'staff'));
                
                // Garantir que todas as áreas padrão existam
                defaultAreas.forEach(defaultArea => {
                    const exists = areas.find(a => a && a.id === defaultArea.id);
                    if (!exists) {
                        areas.push(defaultArea);
                    }
                });
                
                // NÃO salvar automaticamente - apenas retornar os dados atualizados
            }
            
            // Garantir que retorna um array válido
            return Array.isArray(areas) ? areas : defaultAreas;
        }
        
        function getAvailableStaff() {
            // Garantir que staffData é um array
            if (!Array.isArray(staffData)) staffData = [];
            return staffData.filter(s => s.status === 'Ativo');
        }
        
        function getAvailableStaffForTeam(area) {
            // Retornar staff que não está na equipe e não é o líder
            return getAvailableStaff().filter(staff => {
                return staff.name !== area.leader && !area.team.includes(staff.name);
            });
        }
        
        async function assignLeader(areaId, leaderName) {
            if (!leaderName) return;
            
            try {
                const areas = await getAreasData();
                const area = areas.find(a => a.id === areaId);
                
                if (!area) {
                    alert('Área não encontrada.');
                    return;
                }
                
                // Garantir que team é um array
                if (!Array.isArray(area.team)) {
                    area.team = [];
                }
                
                // Se já tinha líder, mover para equipe
                if (area.leader && !area.team.includes(area.leader)) {
                    area.team.push(area.leader);
                }
                
                // Remover da equipe se estiver lá
                area.team = area.team.filter(m => m !== leaderName);
                
                // Atribuir novo líder
                area.leader = leaderName;
                area.hasLeader = true;
                
                // Salvar no Supabase
                await saveData('txd_areas', areas);
                
                // Notificar Discord
                sendDiscordNotification('staff', '👑 Líder Atribuído', 
                    `${currentUser?.name || currentUser?.displayName || 'Sistema'} atribuiu um líder à área ${area.name}`,
                    [
                        { name: '📋 Área', value: area.name, inline: true },
                        { name: '👑 Líder', value: leaderName, inline: true },
                        { name: '👨‍💼 Atribuído por', value: currentUser?.name || currentUser?.displayName || 'Sistema', inline: true }
                    ]
                );
                
                // Aguardar um pouco para garantir que o Supabase processou
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Recarregar áreas com refresh forçado
                await loadAreas();
            } catch (error) {
                console.error('Erro ao atribuir líder:', error);
                alert('Erro ao atribuir líder. Verifique o console para mais detalhes.');
            }
        }
        
        async function removeLeader(areaId) {
            if (!confirm('Deseja remover o líder desta área?')) return;
            
            try {
                const areas = await getAreasData();
                const area = areas.find(a => a.id === areaId);
                
                if (!area || !area.leader) {
                    alert('Área não encontrada ou não possui líder.');
                    return;
                }
                
                const oldLeader = area.leader;
                area.leader = null;
                area.hasLeader = false;
                
                // Salvar no Supabase
                await saveData('txd_areas', areas);
                
                // Notificar Discord
                sendDiscordNotification('staff', '👑 Líder Removido', 
                    `${currentUser?.name || currentUser?.displayName || 'Sistema'} removeu o líder da área ${area.name}`,
                    [
                        { name: '📋 Área', value: area.name, inline: true },
                        { name: '👑 Líder Removido', value: oldLeader, inline: true },
                        { name: '👨‍💼 Removido por', value: currentUser?.name || currentUser?.displayName || 'Sistema', inline: true }
                    ]
                );
                
                // Aguardar um pouco para garantir que o Supabase processou
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Recarregar áreas com refresh forçado
                await loadAreas();
            } catch (error) {
                console.error('Erro ao remover líder:', error);
                alert('Erro ao remover líder. Verifique o console para mais detalhes.');
            }
        }
        
        async function assignTeamMember(areaId, memberName) {
            if (!memberName) return;
            
            try {
                const areas = await getAreasData();
                const area = areas.find(a => a.id === areaId);
                
                if (!area) {
                    alert('Área não encontrada.');
                    return;
                }
                
                // Garantir que team é um array
                if (!Array.isArray(area.team)) {
                    area.team = [];
                }
                
                if (area.team.includes(memberName)) {
                    alert('Este membro já está na equipe!');
                    return;
                }
                
                area.team.push(memberName);
                
                // Salvar no Supabase
                await saveData('txd_areas', areas);
                
                // Notificar Discord
                sendDiscordNotification('staff', '👥 Membro Adicionado à Equipe', 
                    `${currentUser?.name || currentUser?.displayName || 'Sistema'} adicionou um membro à equipe de ${area.name}`,
                    [
                        { name: '📋 Área', value: area.name, inline: true },
                        { name: '👤 Membro', value: memberName, inline: true },
                        { name: '👥 Total na Equipe', value: area.team.length.toString(), inline: true },
                        { name: '👨‍💼 Adicionado por', value: currentUser?.name || currentUser?.displayName || 'Sistema', inline: true }
                    ]
                );
                
                // Aguardar um pouco para garantir que o Supabase processou
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Recarregar áreas com refresh forçado
                await loadAreas();
            } catch (error) {
                console.error('Erro ao adicionar membro à equipe:', error);
                alert('Erro ao adicionar membro. Verifique o console para mais detalhes.');
            }
        }
        
        async function removeTeamMember(areaId, memberName) {
            if (!confirm(`Deseja remover ${memberName} da equipe?`)) return;
            
            try {
                const areas = await getAreasData();
                const area = areas.find(a => a.id === areaId);
                
                if (!area) {
                    alert('Área não encontrada.');
                    return;
                }
                
                // Garantir que team é um array
                if (!Array.isArray(area.team)) {
                    area.team = [];
                }
                
                area.team = area.team.filter(m => m !== memberName);
                
                // Salvar no Supabase
                await saveData('txd_areas', areas);
                
                // Notificar Discord
                sendDiscordNotification('staff', '👥 Membro Removido da Equipe', 
                    `${currentUser?.name || currentUser?.displayName || 'Sistema'} removeu um membro da equipe de ${area.name}`,
                    [
                        { name: '📋 Área', value: area.name, inline: true },
                        { name: '👤 Membro Removido', value: memberName, inline: true },
                        { name: '👨‍💼 Removido por', value: currentUser?.name || currentUser?.displayName || 'Sistema', inline: true }
                    ]
                );
                
                // Aguardar um pouco para garantir que o Supabase processou
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Recarregar áreas com refresh forçado
                await loadAreas();
            } catch (error) {
                console.error('Erro ao remover membro da equipe:', error);
                alert('Erro ao remover membro. Verifique o console para mais detalhes.');
            }
        }
        
        function openAreaModal() {
            // Modal para adicionar nova área (opcional)
            alert('Funcionalidade de adicionar novas áreas será implementada em breve. Por enquanto, use as áreas padrão.');
        }
        
        async function editArea(areaId) {
            try {
                const areas = await getAreasData();
                const area = areas.find(a => a.id === areaId);
                
                if (!area) {
                    alert('Área não encontrada.');
                    return;
                }
                
                const newDescription = prompt('Editar descrição da área:', area.description || '');
                if (newDescription === null) return;
                
                area.description = newDescription;
                
                // Salvar no Supabase
                await saveData('txd_areas', areas);
                
                // Aguardar um pouco para garantir que o Supabase processou
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Recarregar áreas com refresh forçado
                await loadAreas();
            } catch (error) {
                console.error('Erro ao editar área:', error);
                alert('Erro ao editar área. Verifique o console para mais detalhes.');
            }
        }

        // ========== PERFIL DO USUÁRIO ==========
        
        async function loadPerfil() {
            if (!currentUser || !currentUser.id) {
                alert('Erro: Usuário não identificado. Faça login novamente.');
                showSection('inicio');
                return;
            }
            
            // Buscar dados completos do usuário com comparação flexível
            const staffDataRaw = await getData('txd_staff', false);
            const staffDataArray = Array.isArray(staffDataRaw) ? staffDataRaw : [];
            const userData = staffDataArray.find(s => {
                if (!s) return false;
                // Comparar IDs como string e number, ou por login/name
                return String(s.id) === String(currentUser.id) || 
                       s.id === currentUser.id ||
                       (s.login && s.login === currentUser.login) ||
                       (s.name && s.name === currentUser.name);
            }) || currentUser;
            
            // Calcular estatísticas do usuário
            const tasksCompleted = await getCompletedTasksByStaff(currentUser.id);
            const pendenciasResolved = getResolvedPendenciesByStaff(currentUser.id);
            const messagesCount = getMessagesByStaff(currentUser.id);
            let score = (tasksCompleted * 10) + (pendenciasResolved * 15) + (messagesCount * 2);
            
            // Buscar conquistas
            const userAchievements = getData('txd_user_achievements') || {};
            const currentUserAchievements = userAchievements[currentUser.id] || [];
            const achievementPoints = calculateAchievementPoints(currentUserAchievements);
            
            // Buscar histórico de atividades recentes
            const logsData = getData('txd_system_logs') || [];
            const userActivities = Array.isArray(logsData) 
                ? logsData.filter(log => log.userId === currentUser.id || log.userId === String(currentUser.id))
                    .slice(0, 10)
                    .reverse()
                : [];
            
            // Buscar solicitações de licença do usuário
            const licenseRequests = await getLicenseRequestsByUser(currentUser.id);
            
            // Buscar advertências do usuário
            const warningsRaw = await getData('txd_warnings', false);
            const warnings = Array.isArray(warningsRaw) ? warningsRaw : [];
            const userWarnings = warnings.filter(w => 
                String(w.userId || w.user_id) === String(currentUser.id) ||
                (w.userName || w.user_name) === (currentUser.name || currentUser.displayName)
            );
            const activeWarnings = userWarnings.filter(w => w.status === 'active' || !w.status);
            
            // Buscar pendências do usuário
            await ensurePendenciesLoaded(false);
            const pendencies = Array.from(state.pendencies.byId.values());
            const myPendencies = pendencies.filter(p => 
                String(p.userId || p.user_id) === String(currentUser.id) ||
                (p.userName || p.user_name) === (currentUser.name || currentUser.displayName)
            );
            const myOpenPendencies = myPendencies.filter(p => p.status === 'pending' || p.status === 'Pendente');
            const myInProgressPendencies = myPendencies.filter(p => p.status === 'in_progress' || p.status === 'Em Andamento');
            const myResolvedPendencies = myPendencies.filter(p => p.status === 'completed' || p.status === 'Concluída');
            score = (tasksCompleted * 10) + (myResolvedPendencies.length * 15) + (messagesCount * 2);
            
            // Buscar tarefas do usuário
            await ensureKanbanLoaded(false);
            const kanbanData = getKanbanSnapshotFromState();
            const allCards = kanbanData?.cards || [];
            const myTasks = allCards.filter(card => {
                if (!card) return false;
                const assignees = card.assignees || card.assignee || [];
                const assigneeArray = Array.isArray(assignees) ? assignees : (assignees ? [assignees] : []);
                return assigneeArray.some(a => 
                    a === (currentUser.name || currentUser.displayName) ||
                    String(a) === String(currentUser.id)
                );
            });
            const myActiveTasks = myTasks.filter(t => {
                const columnId = t.columnId || t.column_id;
                return columnId !== 'done' && columnId !== 'Done';
            });
            
            // Calcular tempo de serviço (se houver data de entrada)
            const entryDate = userData.entryDate || userData.entry_date || userData.createdAt || userData.created_at;
            let serviceTime = null;
            if (entryDate) {
                const entry = new Date(entryDate);
                const now = new Date();
                const diffTime = Math.abs(now - entry);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays < 30) {
                    serviceTime = `${diffDays} dias`;
                } else if (diffDays < 365) {
                    const months = Math.floor(diffDays / 30);
                    serviceTime = `${months} ${months === 1 ? 'mês' : 'meses'}`;
                } else {
                    const years = Math.floor(diffDays / 365);
                    const months = Math.floor((diffDays % 365) / 30);
                    serviceTime = `${years} ${years === 1 ? 'ano' : 'anos'}`;
                    if (months > 0) {
                        serviceTime += ` e ${months} ${months === 1 ? 'mês' : 'meses'}`;
                    }
                }
            }
            
            const content = `
                <h1 id="sectionTitle">👤 Meu Perfil</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Gerencie suas informações pessoais, visualize seu desempenho e solicite licenças</p>
                
                <!-- INFORMAÇÕES PESSOAIS -->
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border); margin-bottom: 24px;">
                    <div style="display: grid; gap: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 16px; border-bottom: 1px solid var(--gray-border);">
                            <div>
                                <h3 style="color: var(--white-soft); font-size: 20px; margin-bottom: 4px;">
                                    ${userData.displayName || userData.name || 'Usuário'}
                                </h3>
                                <p style="color: var(--gray-light); font-size: 14px;">
                                    <i class="fas fa-user-tag"></i> ${userData.role || 'N/A'}
                                </p>
                            </div>
                            <span class="badge badge-success">${userData.status || 'Ativo'}</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div>
                                <p style="color: var(--gray-text); font-size: 12px; margin-bottom: 4px;">Login</p>
                                <p style="color: var(--white-soft); font-size: 14px; font-weight: 600;">${userData.login || userData.name || 'N/A'}</p>
                            </div>
                            <div>
                                <p style="color: var(--gray-text); font-size: 12px; margin-bottom: 4px;">Email</p>
                                <p style="color: var(--white-soft); font-size: 14px; font-weight: 600;">${userData.email || 'Não informado'}</p>
                            </div>
                            <div>
                                <p style="color: var(--gray-text); font-size: 12px; margin-bottom: 4px;">Área</p>
                                <p style="color: var(--white-soft); font-size: 14px; font-weight: 600;">${userData.area || 'Não definida'}</p>
                            </div>
                            <div>
                                <p style="color: var(--gray-text); font-size: 12px; margin-bottom: 4px;">ID Game</p>
                                <p style="color: var(--white-soft); font-size: 14px; font-weight: 600;">${userData.gameId || 'Não informado'}</p>
                            </div>
                            <div>
                                <p style="color: var(--gray-text); font-size: 12px; margin-bottom: 4px;">ID Discord</p>
                                <p style="color: var(--white-soft); font-size: 14px; font-weight: 600;">${userData.discordId || 'Não informado'}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ESTATÍSTICAS -->
                <div style="margin-bottom: 24px;">
                    <h2 style="font-size: 18px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-chart-line" style="color: var(--gray-text); margin-right: 8px;"></i>
                        Estatísticas de Desempenho
                    </h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--success); margin-bottom: 8px;">${tasksCompleted}</div>
                            <div style="font-size: 14px; color: var(--gray-light);">Tarefas Concluídas</div>
                        </div>
                        <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--primary); margin-bottom: 8px;">${myResolvedPendencies.length}</div>
                            <div style="font-size: 14px; color: var(--gray-light);">Pendências Concluídas</div>
                        </div>
                        <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--warning); margin-bottom: 8px;">${messagesCount}</div>
                            <div style="font-size: 14px; color: var(--gray-light);">Mensagens Enviadas</div>
                        </div>
                        <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--white-soft); margin-bottom: 8px;">${score}</div>
                            <div style="font-size: 14px; color: var(--gray-light);">Pontuação Total</div>
                        </div>
                    </div>
                </div>
                
                <!-- CONQUISTAS -->
                <div style="margin-bottom: 24px;">
                    <h2 style="font-size: 18px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-trophy" style="color: var(--warning); margin-right: 8px;"></i>
                        Conquistas Desbloqueadas
                    </h2>
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--white-soft);">
                                    ${currentUserAchievements.length} / ${ACHIEVEMENTS.length}
                                </div>
                                <div style="font-size: 14px; color: var(--gray-light);">Conquistas Desbloqueadas</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--warning);">
                                    ${achievementPoints} pts
                                </div>
                                <div style="font-size: 14px; color: var(--gray-light);">Pontos de Conquistas</div>
                            </div>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                            ${currentUserAchievements.length > 0 
                                ? currentUserAchievements.map(achId => {
                                    const achievement = ACHIEVEMENTS.find(a => a.id === achId);
                                    return achievement ? `
                                        <div style="background: var(--gray-darker); border-radius: 8px; padding: 12px; border: 1px solid var(--gray-border); display: flex; align-items: center; gap: 12px; min-width: 200px;">
                                            <div style="font-size: 32px;">${achievement.icon}</div>
                                            <div>
                                                <div style="font-size: 14px; font-weight: 600; color: var(--white-soft);">${achievement.title}</div>
                                                <div style="font-size: 12px; color: var(--gray-light);">${achievement.reward}</div>
                                            </div>
                                        </div>
                                    ` : '';
                                }).join('')
                                : '<p style="color: var(--gray-text); font-size: 14px; text-align: center; width: 100%;">Nenhuma conquista desbloqueada ainda. Continue trabalhando!</p>'
                            }
                        </div>
                        ${currentUserAchievements.length < ACHIEVEMENTS.length ? `
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-border);">
                                <a href="#" onclick="showSection('conquistas'); return false;" style="color: var(--primary); text-decoration: none; font-size: 14px; display: inline-flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-arrow-right"></i> Ver todas as conquistas
                                </a>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- HISTÓRICO DE ATIVIDADES -->
                <div style="margin-bottom: 24px;">
                    <h2 style="font-size: 18px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-history" style="color: var(--gray-text); margin-right: 8px;"></i>
                        Atividades Recentes
                    </h2>
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        ${userActivities.length > 0 
                            ? `<div style="display: flex; flex-direction: column; gap: 12px;">
                                ${userActivities.map(activity => {
                                    const actionIcon = activity.action?.includes('Login') ? '🔐' : 
                                                      activity.action?.includes('Criar') ? '➕' : 
                                                      activity.action?.includes('Editar') ? '✏️' : 
                                                      activity.action?.includes('Excluir') ? '🗑️' : 
                                                      activity.action?.includes('Aprovar') ? '✅' : 
                                                      activity.action?.includes('Perfil') ? '👤' : '📝';
                                    const timestamp = activity.timestamp || activity.created_at || new Date().toISOString();
                                    const date = new Date(timestamp);
                                    const formattedDate = date.toLocaleString('pt-BR', { 
                                        day: '2-digit', 
                                        month: '2-digit', 
                                        year: 'numeric',
                                        hour: '2-digit', 
                                        minute: '2-digit' 
                                    });
                                    return `
                                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--gray-darker); border-radius: 8px;">
                                            <div style="font-size: 20px;">${actionIcon}</div>
                                            <div style="flex: 1;">
                                                <div style="font-size: 14px; font-weight: 600; color: var(--white-soft);">${activity.action || 'Ação'}</div>
                                                <div style="font-size: 12px; color: var(--gray-text);">${activity.entity || activity.section || 'Sistema'}</div>
                                            </div>
                                            <div style="font-size: 12px; color: var(--gray-text);">${formattedDate}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>`
                            : '<p style="color: var(--gray-text); font-size: 14px; text-align: center;">Nenhuma atividade registrada ainda.</p>'
                        }
                    </div>
                </div>
                
                <!-- MINHAS TAREFAS -->
                <div style="margin-bottom: 24px;">
                    <h2 style="font-size: 18px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-tasks" style="color: var(--primary); margin-right: 8px;"></i>
                        Minhas Tarefas
                    </h2>
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 16px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${myTasks.length}</div>
                                <div style="font-size: 12px; color: var(--gray-light);">Total</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--warning);">${myActiveTasks.length}</div>
                                <div style="font-size: 12px; color: var(--gray-light);">Em Andamento</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--success);">${myTasks.length - myActiveTasks.length}</div>
                                <div style="font-size: 12px; color: var(--gray-light);">Concluídas</div>
                            </div>
                        </div>
                        ${myActiveTasks.length > 0 ? `
                            <div style="margin-top: 16px;">
                                <a href="#" onclick="showSection('tarefas'); return false;" style="color: var(--primary); text-decoration: none; font-size: 14px; display: inline-flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-arrow-right"></i> Ver minhas tarefas ativas
                                </a>
                            </div>
                        ` : '<p style="color: var(--gray-text); font-size: 14px; text-align: center;">Nenhuma tarefa atribuída no momento.</p>'}
                    </div>
                </div>
                
                <!-- MINHAS PENDÊNCIAS -->
                <div style="margin-bottom: 24px;">
                    <h2 style="font-size: 18px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-clipboard-list" style="color: var(--warning); margin-right: 8px;"></i>
                        Minhas Pendências
                    </h2>
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 16px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--warning);">${myPendencies.length}</div>
                                <div style="font-size: 12px; color: var(--gray-light);">Total</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--danger);">${myOpenPendencies.length}</div>
                                <div style="font-size: 12px; color: var(--gray-light);">Pendentes</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${myInProgressPendencies.length}</div>
                                <div style="font-size: 12px; color: var(--gray-light);">Em Andamento</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--success);">${myPendencies.length - myOpenPendencies.length - myInProgressPendencies.length}</div>
                                <div style="font-size: 12px; color: var(--gray-light);">Concluídas</div>
                            </div>
                        </div>
                        ${myOpenPendencies.length > 0 || myInProgressPendencies.length > 0 ? `
                            <div style="margin-top: 16px;">
                                <a href="#" onclick="showSection('pendencias'); return false;" style="color: var(--primary); text-decoration: none; font-size: 14px; display: inline-flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-arrow-right"></i> Ver minhas pendências
                                </a>
                            </div>
                        ` : '<p style="color: var(--gray-text); font-size: 14px; text-align: center;">Nenhuma pendência aberta no momento.</p>'}
                    </div>
                </div>
                
                <!-- MINHAS ADVERTÊNCIAS -->
                ${userWarnings.length > 0 ? `
                <div style="margin-bottom: 24px;">
                    <h2 style="font-size: 18px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-exclamation-triangle" style="color: var(--danger); margin-right: 8px;"></i>
                        Minhas Advertências
                    </h2>
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 16px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--danger);">${userWarnings.length}</div>
                                <div style="font-size: 12px; color: var(--gray-light);">Total</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: ${activeWarnings.length > 0 ? 'var(--danger)' : 'var(--success)'};">${activeWarnings.length}</div>
                                <div style="font-size: 12px; color: var(--gray-light);">Ativas</div>
                            </div>
                        </div>
                        ${activeWarnings.length > 0 ? `
                            <div style="background: var(--gray-darker); border-radius: 8px; padding: 16px; margin-bottom: 16px; border-left: 4px solid var(--danger);">
                                <div style="font-size: 14px; font-weight: 600; color: var(--white-soft); margin-bottom: 8px;">
                                    ⚠️ Você possui ${activeWarnings.length} advertência${activeWarnings.length > 1 ? 's' : ''} ativa${activeWarnings.length > 1 ? 's' : ''}
                                </div>
                                <div style="font-size: 12px; color: var(--gray-light);">
                                    Mantenha um comportamento adequado para evitar novas advertências.
                                </div>
                            </div>
                        ` : ''}
                        <div style="margin-top: 16px;">
                            <a href="#" onclick="showSection('advertencias'); return false;" style="color: var(--primary); text-decoration: none; font-size: 14px; display: inline-flex; align-items: center; gap: 8px;">
                                <i class="fas fa-arrow-right"></i> Ver histórico completo de advertências
                            </a>
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <!-- INFORMAÇÕES ADICIONAIS -->
                <div style="margin-bottom: 24px;">
                    <h2 style="font-size: 18px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-info-circle" style="color: var(--gray-text); margin-right: 8px;"></i>
                        Informações Adicionais
                    </h2>
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            ${serviceTime ? `
                            <div>
                                <p style="color: var(--gray-text); font-size: 12px; margin-bottom: 4px;">Tempo de Serviço</p>
                                <p style="color: var(--white-soft); font-size: 14px; font-weight: 600;">
                                    <i class="fas fa-clock" style="margin-right: 8px;"></i>${serviceTime}
                                </p>
                            </div>
                            ` : ''}
                            <div>
                                <p style="color: var(--gray-text); font-size: 12px; margin-bottom: 4px;">Último Login</p>
                                <p style="color: var(--white-soft); font-size: 14px; font-weight: 600;">
                                    <i class="fas fa-sign-in-alt" style="margin-right: 8px;"></i>Agora
                                </p>
                            </div>
                            <div>
                                <p style="color: var(--gray-text); font-size: 12px; margin-bottom: 4px;">Membro desde</p>
                                <p style="color: var(--white-soft); font-size: 14px; font-weight: 600;">
                                    <i class="fas fa-calendar" style="margin-right: 8px;"></i>${entryDate ? new Date(entryDate).toLocaleDateString('pt-BR') : 'N/A'}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SOLICITAÇÕES DE LICENÇA -->
                <div style="margin-bottom: 24px;">
                    <h2 style="font-size: 18px; font-weight: 600; color: var(--white-soft); margin-bottom: 16px;">
                        <i class="fas fa-calendar-times" style="color: var(--gray-text); margin-right: 8px;"></i>
                        Solicitações de Licença
                    </h2>
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        ${licenseRequests.length > 0 
                            ? `<div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px;">
                                ${licenseRequests.map(req => {
                                    const statusBadge = req.status === 'aprovada' || req.status === 'approved' ? 'badge-success' : 
                                                       req.status === 'rejeitada' || req.status === 'rejected' ? 'badge-danger' : 
                                                       'badge-warning';
                                    const statusText = req.status === 'aprovada' || req.status === 'approved' ? 'Aprovada' : 
                                                      req.status === 'rejeitada' || req.status === 'rejected' ? 'Rejeitada' : 
                                                      'Pendente';
                                    const startDate = new Date(req.start_date || req.startDate).toLocaleDateString('pt-BR');
                                    const endDate = new Date(req.end_date || req.endDate).toLocaleDateString('pt-BR');
                                    return `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--gray-darker); border-radius: 8px;">
                                            <div style="flex: 1;">
                                                <div style="font-size: 14px; font-weight: 600; color: var(--white-soft); margin-bottom: 4px;">
                                                    ${startDate} até ${endDate}
                                                </div>
                                                <div style="font-size: 12px; color: var(--gray-light);">${req.reason || 'Sem motivo especificado'}</div>
                                                ${req.response ? `<div style="font-size: 12px; color: var(--gray-text); margin-top: 4px;">Resposta: ${req.response}</div>` : ''}
                                            </div>
                                            <span class="badge ${statusBadge}">${statusText}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>`
                            : '<p style="color: var(--gray-text); font-size: 14px; text-align: center; margin-bottom: 16px;">Nenhuma solicitação de licença registrada.</p>'
                        }
                        <button class="btn-modal" onclick="openLicenseRequestModal()" style="width: 100%;">
                            <i class="fas fa-plus"></i> Solicitar Nova Licença
                        </button>
                    </div>
                </div>
                
                <!-- AÇÕES -->
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn-modal" onclick="openProfileModal()">
                        <i class="fas fa-edit"></i> Editar Perfil
                    </button>
                    <button class="btn-modal" onclick="openLicenseRequestModal()">
                        <i class="fas fa-calendar-times"></i> Solicitar Licença
                    </button>
                </div>
            `;
            
            document.querySelector('.content-card').innerHTML = content;
        }
        
        // Função auxiliar para buscar solicitações de licença do usuário
        async function getLicenseRequestsByUser(userId) {
            try {
                const licenseRequests = await getData('txd_license_requests', false);
                if (!Array.isArray(licenseRequests)) return [];
                return licenseRequests.filter(req => 
                    req && (String(req.user_id) === String(userId) || String(req.userId) === String(userId))
                ).sort((a, b) => {
                    const dateA = new Date(a.created_at || a.createdAt || 0);
                    const dateB = new Date(b.created_at || b.createdAt || 0);
                    return dateB - dateA;
                });
            } catch (error) {
                console.error('Erro ao buscar solicitações de licença:', error);
                return [];
            }
        }
        
        // Abrir modal de solicitação de licença
        function openLicenseRequestModal() {
            if (!currentUser || !currentUser.id) {
                alert('Erro: Usuário não identificado.');
                return;
            }
            
            // Limpar formulário
            document.getElementById('licenseStartDate').value = '';
            document.getElementById('licenseEndDate').value = '';
            document.getElementById('licenseReason').value = '';
            document.getElementById('licenseType').value = 'ferias';
            
            // Definir data mínima como hoje
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('licenseStartDate').setAttribute('min', today);
            document.getElementById('licenseEndDate').setAttribute('min', today);
            
            document.getElementById('licenseRequestModal').classList.add('active');
        }
        
        // Salvar solicitação de licença
        async function saveLicenseRequest(event) {
            event.preventDefault();
            
            if (!currentUser || !currentUser.id) {
                alert('Erro: Usuário não identificado.');
                return;
            }
            
            const startDate = document.getElementById('licenseStartDate').value;
            const endDate = document.getElementById('licenseEndDate').value;
            const reason = document.getElementById('licenseReason').value.trim();
            const type = document.getElementById('licenseType').value;
            
            // Validações
            if (!startDate || !endDate) {
                alert('Por favor, preencha as datas de início e término.');
                return;
            }
            
            if (!reason) {
                alert('Por favor, descreva o motivo da licença.');
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (start < today) {
                alert('A data de início não pode ser anterior a hoje.');
                return;
            }
            
            if (end < start) {
                alert('A data de término deve ser posterior à data de início.');
                return;
            }
            
            try {
                // Buscar solicitações existentes
                const existingRequests = await getData('txd_license_requests', false);
                const requestsArray = Array.isArray(existingRequests) ? existingRequests : [];
                
                // Criar nova solicitação
                const newRequest = {
                    id: Date.now(),
                    userId: currentUser.id,
                    userName: currentUser.displayName || currentUser.name || 'Usuário',
                    startDate: startDate,
                    endDate: endDate,
                    reason: reason,
                    type: type,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.id
                };
                
                requestsArray.push(newRequest);
                
                // Salvar no Supabase
                await saveData('txd_license_requests', requestsArray);
                
                // Limpar cache para forçar atualização
                clearCacheKey('txd_license_requests');
                
                // Log da ação
                logSystemAction('Solicitação de licença criada', 'Perfil', {
                    userId: currentUser.id,
                    licenseType: type,
                    startDate: startDate,
                    endDate: endDate
                });
                
                alert('✅ Solicitação de licença enviada com sucesso! Você receberá uma notificação quando houver uma resposta.');
                closeModal('licenseRequestModal');
                loadPerfil();
                
            } catch (error) {
                console.error('Erro ao salvar solicitação de licença:', error);
                alert(`Erro ao salvar solicitação: ${error.message || 'Erro desconhecido'}`);
            }
        }
        
        function openProfileModal() {
            if (!currentUser || !currentUser.id) {
                alert('Erro: Usuário não identificado.');
                return;
            }
            
            // Buscar dados completos do usuário com comparação flexível
            const staffDataRaw = getData('txd_staff');
            const staffDataArray = Array.isArray(staffDataRaw) ? staffDataRaw : [];
            const userData = staffDataArray.find(s => {
                if (!s) return false;
                // Comparar IDs como string e number, ou por login/name
                return String(s.id) === String(currentUser.id) || 
                       s.id === currentUser.id ||
                       (s.login && s.login === currentUser.login) ||
                       (s.name && s.name === currentUser.name);
            }) || currentUser;
            
            // Preencher formulário
            document.getElementById('profileName').value = userData.displayName || userData.name || '';
            document.getElementById('profileLogin').value = userData.login || userData.name || '';
            document.getElementById('profilePassword').value = userData.password || '';
            document.getElementById('profileGameId').value = userData.gameId || '';
            document.getElementById('profileDiscordId').value = userData.discordId || '';
            document.getElementById('profileArea').value = userData.area || '';
            
            document.getElementById('profileModal').classList.add('active');
        }
        
        async function saveProfile(event) {
            event.preventDefault();
            
            if (!currentUser || !currentUser.id) {
                alert('Erro: Usuário não identificado.');
                return;
            }
            
            const name = document.getElementById('profileName').value.trim();
            const login = document.getElementById('profileLogin').value.trim();
            const password = document.getElementById('profilePassword').value;
            const gameId = document.getElementById('profileGameId').value.trim();
            const discordId = document.getElementById('profileDiscordId').value.trim();
            const area = document.getElementById('profileArea').value;
            
            // Validações
            if (!name || !login) {
                alert('Nome e Login são obrigatórios.');
                return;
            }
            
            if (password && password.length < 4) {
                alert('A senha deve ter pelo menos 4 caracteres.');
                return;
            }
            
            // Verificar se o login já está em uso por outro usuário
            const staffDataRaw = getData('txd_staff');
            const staffDataArray = Array.isArray(staffDataRaw) ? staffDataRaw : [];
            const loginExists = staffDataArray.some(s => s && s.id !== currentUser.id && (s.login === login || s.name === login));
            
            if (loginExists) {
                alert('Este login já está em uso por outro usuário. Escolha outro.');
                return;
            }
            
            try {
                // Buscar usuário com comparação flexível de ID (string ou number)
                let userIndex = staffDataArray.findIndex(s => {
                    if (!s) return false;
                    // Comparar IDs como string e number
                    return String(s.id) === String(currentUser.id) || 
                           s.id === currentUser.id ||
                           (s.login && s.login === currentUser.login) ||
                           (s.name && s.name === currentUser.name);
                });
                
                let userRecord;
                
                if (userIndex === -1) {
                    // Usuário não encontrado - criar novo registro
                    console.log('Usuário não encontrado no array, criando novo registro...');
                    userRecord = {
                        id: currentUser.id || Date.now(),
                        name: name,
                        displayName: name,
                        login: login,
                        password: password || currentUser.password || null,
                        role: currentUser.role || 'Helper',
                        area: area || currentUser.area || null,
                        status: currentUser.status || 'Ativo',
                        email: currentUser.email || null,
                        gameId: gameId || currentUser.gameId || null,
                        discordId: discordId || currentUser.discordId || null,
                        createdAt: currentUser.createdAt || new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    staffDataArray.push(userRecord);
                    userIndex = staffDataArray.length - 1;
                } else {
                    // Atualizar registro existente
                    userRecord = staffDataArray[userIndex];
                }
                
                // Atualizar dados
                userRecord.name = name;
                userRecord.displayName = name;
                userRecord.login = login;
                if (password) {
                    userRecord.password = password;
                }
                userRecord.gameId = gameId || null;
                userRecord.discordId = discordId || null;
                userRecord.area = area || null;
                userRecord.updatedAt = new Date().toISOString();
                
                // Garantir que campos obrigatórios existam
                if (!userRecord.role) userRecord.role = currentUser.role || 'Helper';
                if (!userRecord.status) userRecord.status = currentUser.status || 'Ativo';
                if (!userRecord.id) userRecord.id = currentUser.id || Date.now();
                
                // Garantir que ID seja um número
                userRecord.id = parseInt(userRecord.id) || Date.now();
                
                // Atualizar cache local primeiro
                dataCache['txd_staff'] = staffDataArray;
                
                // Salvar no Supabase
                console.log('Salvando perfil no Supabase...', userRecord);
                const saveResult = await saveData('txd_staff', staffDataArray);
                
                // Verificar se houve erro no saveData
                if (saveResult && saveResult.error) {
                    throw new Error(saveResult.error.message || 'Erro ao salvar no banco de dados');
                }
                
                // Atualizar currentUser
                currentUser.name = name;
                currentUser.displayName = name;
                currentUser.login = login;
                currentUser.gameId = gameId || null;
                currentUser.discordId = discordId || null;
                currentUser.area = area || null;
                
                // Log da ação
                logSystemAction('Perfil atualizado', 'Perfil', {
                    userId: currentUser.id,
                    updatedFields: ['name', 'login', 'gameId', 'discordId', 'area']
                });
                
                alert('✅ Perfil atualizado com sucesso!');
                closeModal('profileModal');
                loadPerfil();
                
            } catch (error) {
                console.error('Erro ao salvar perfil:', error);
                alert(`Erro ao salvar perfil: ${error.message || 'Erro desconhecido'}\n\nTente novamente ou verifique o console para mais detalhes.`);
            }
        }

        // ========== CHAT INTERNO ==========
        let chatMessages = dataCache['txd_chat_messages'] || [];
        let chatGroups = dataCache['txd_chat_groups'] || [];
        let activeChatUser = null;
        let activeChatGroup = null;
        let pendingAttachment = null;
        
        // Inicializar mensagens de exemplo (apenas na primeira vez)
        if ((!Array.isArray(chatMessages) || chatMessages.length === 0) && Array.isArray(staffData) && staffData.length > 1) {
            const exampleMessages = [
                {
                    id: Date.now() - 3600000,
                    senderId: 2,
                    senderName: 'Maria Santos',
                    receiverId: 1,
                    text: 'Olá! Tudo bem? Conseguiu revisar o relatório que enviei?',
                    timestamp: new Date(Date.now() - 3600000).toISOString(),
                    read: true
                },
                {
                    id: Date.now() - 1800000,
                    senderId: 3,
                    senderName: 'Pedro Costa',
                    receiverId: 1,
                    text: 'Bom dia! Precisamos marcar uma reunião para discutir as novas diretrizes.',
                    timestamp: new Date(Date.now() - 1800000).toISOString(),
                    read: false
                }
            ];
            chatMessages = exampleMessages;
            saveData('txd_chat_messages', chatMessages);
        }
        
        // Inicializar grupo de exemplo (apenas na primeira vez)
        if ((!Array.isArray(chatGroups) || chatGroups.length === 0) && Array.isArray(staffData) && staffData.length >= 3) {
            const exampleGroup = {
                id: Date.now(),
                name: 'Equipe de Moderação',
                description: 'Grupo principal da equipe de moderação',
                members: [
                    { id: 1, name: 'João Silva', role: 'Owner' },
                    { id: 2, name: 'Maria Santos', role: 'CEO' },
                    { id: 3, name: 'Pedro Costa', role: 'Head Staff' }
                ],
                createdBy: 1,
                createdAt: new Date(Date.now() - 86400000).toISOString()
            };
            chatGroups = [exampleGroup];
            saveData('txd_chat_groups', chatGroups);
            
            // Adicionar mensagem de exemplo no grupo
            const groupMessage = {
                id: Date.now() - 7200000,
                senderId: 2,
                senderName: 'Maria Santos',
                groupId: exampleGroup.id,
                text: 'Bem-vindos ao grupo! Vamos usar este espaço para coordenar as atividades da equipe.',
                timestamp: new Date(Date.now() - 7200000).toISOString(),
                read: false
            };
            chatMessages.push(groupMessage);
            saveData('txd_chat_messages', chatMessages);
        }

        function loadChat() {
            // Garantir que as variáveis são arrays
            if (!Array.isArray(staffData)) staffData = [];
            if (!Array.isArray(chatMessages)) chatMessages = [];
            if (!Array.isArray(chatGroups)) chatGroups = [];
            
            const chatUsers = staffData.filter(staff => staff.id !== currentUser.id);
            
            const content = `
                <h1 id="sectionTitle">💬 Chat Interno</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Comunicação em tempo real com a equipe</p>
                
                <div class="chat-container">
                    <div class="chat-sidebar">
                        <button class="btn btn-primary" onclick="openCreateGroupModal()" style="width: 100%; margin-bottom: 12px; font-size: 13px;">
                            <i class="fas fa-users"></i> Criar Grupo
                        </button>
                        <div style="margin-bottom: 16px;">
                            <input type="text" id="chatSearch" placeholder="Buscar conversa..." 
                                style="width: 100%; padding: 10px 14px; background: var(--gray-medium); border: 1px solid var(--gray-border); 
                                border-radius: 10px; color: var(--white-soft); font-size: 14px;">
                        </div>
                        <div id="chatUserList">
                            ${chatGroups.map(group => {
                                const unreadCountGroup = getGroupUnreadCount(group.id);
                                const lastMessageGroup = getGroupLastMessage(group.id);
                                return `
                                    <div class="chat-list-item ${activeChatGroup?.id === group.id ? 'active' : ''}" 
                                        onclick="selectChatGroup(${group.id})">
                                        <div class="chat-avatar" style="background: linear-gradient(135deg, var(--success), var(--gray-border));">👥</div>
                                        <div class="chat-info">
                                            <div class="chat-name">
                                                ${group.name}
                                                <span class="group-indicator">GRUPO</span>
                                            </div>
                                            <div class="chat-last-message">${lastMessageGroup || 'Sem mensagens'}</div>
                                        </div>
                                        ${unreadCountGroup > 0 ? `<div class="chat-badge">${unreadCountGroup}</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                            ${chatUsers.map(user => {
                                const unreadCount = getUnreadCount(user.id);
                                const lastMessage = getLastMessage(user.id);
                                return `
                                    <div class="chat-list-item ${activeChatUser?.id === user.id && !activeChatGroup ? 'active' : ''}" 
                                        onclick="selectChatUser(${user.id})">
                                        <div class="chat-avatar">${user.name.charAt(0)}</div>
                                        <div class="chat-info">
                                            <div class="chat-name">${user.name}</div>
                                            <div class="chat-last-message">${lastMessage || 'Sem mensagens'}</div>
                                        </div>
                                        ${unreadCount > 0 ? `<div class="chat-badge">${unreadCount}</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div class="chat-main">
                        <div id="chatContent">
                            ${activeChatGroup ? renderGroupChatContent(activeChatGroup) : 
                              activeChatUser ? renderChatContent(activeChatUser) : `
                                <div style="display: flex; align-items: center; justify-content: center; height: 100%; 
                                    color: var(--gray-text); flex-direction: column; gap: 12px;">
                                    <i class="fas fa-comments" style="font-size: 48px; opacity: 0.5;"></i>
                                    <p>Selecione uma conversa para começar</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
            
            document.querySelector('.content-card').innerHTML = content;
            
            // Auto-scroll para última mensagem se houver chat ativo
            if (activeChatUser || activeChatGroup) {
                setTimeout(() => {
                    const messagesDiv = document.getElementById('chatMessages');
                    if (messagesDiv) {
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }
                }, 100);
            }
        }

        function renderChatContent(user) {
            const messages = getChatMessages(user.id);
            
            return `
                <div class="chat-header">
                    <div class="chat-avatar">${user.name.charAt(0)}</div>
                    <div class="chat-header-info">
                        <h3>${user.name}</h3>
                        <div class="chat-header-status">● Online</div>
                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    ${messages.length === 0 ? `
                        <div style="text-align: center; color: var(--gray-text); padding: 40px;">
                            <i class="fas fa-comment-dots" style="font-size: 36px; opacity: 0.5; margin-bottom: 12px;"></i>
                            <p>Nenhuma mensagem ainda. Inicie a conversa!</p>
                        </div>
                    ` : messages.map(msg => `
                        <div class="chat-message ${msg.senderId === currentUser.id ? 'sent' : ''}">
                            <div class="chat-message-avatar">${msg.senderName.charAt(0)}</div>
                            <div class="chat-message-content">
                                <div class="chat-message-bubble">
                                    ${msg.text}
                                    ${msg.attachment ? renderAttachment(msg.attachment) : ''}
                                </div>
                                <div class="chat-message-time">${formatChatTime(msg.timestamp)}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                ${renderAttachmentPreview()}
                
                <div class="chat-input-area">
                    <input type="file" id="attachmentInput" accept="image/*,.pdf,.doc,.docx,.txt" style="display: none;" onchange="handleAttachmentSelect(event)">
                    <button class="attachment-btn" onclick="document.getElementById('attachmentInput').click()">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <textarea id="chatInput" class="chat-input" placeholder="Digite sua mensagem..." 
                        rows="1" onkeypress="handleChatKeyPress(event)"></textarea>
                    <button class="chat-send-btn" onclick="sendChatMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            `;
        }

        function renderGroupChatContent(group) {
            const messages = getGroupChatMessages(group.id);
            
            return `
                <div class="chat-header">
                    <div class="chat-avatar" style="background: linear-gradient(135deg, var(--success), var(--gray-border));">👥</div>
                    <div class="chat-header-info">
                        <h3>${group.name}</h3>
                        <div class="chat-header-status">${group.members.length} membros</div>
                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    ${messages.length === 0 ? `
                        <div style="text-align: center; color: var(--gray-text); padding: 40px;">
                            <i class="fas fa-users" style="font-size: 36px; opacity: 0.5; margin-bottom: 12px;"></i>
                            <p>Nenhuma mensagem no grupo ainda. Seja o primeiro!</p>
                        </div>
                    ` : messages.map(msg => `
                        <div class="chat-message ${msg.senderId === currentUser.id ? 'sent' : ''}">
                            <div class="chat-message-avatar">${msg.senderName.charAt(0)}</div>
                            <div class="chat-message-content">
                                ${msg.senderId !== currentUser.id ? `<div style="font-size: 11px; color: var(--gray-text); margin-bottom: 4px; font-weight: 600;">${msg.senderName}</div>` : ''}
                                <div class="chat-message-bubble">
                                    ${msg.text}
                                    ${msg.attachment ? renderAttachment(msg.attachment) : ''}
                                </div>
                                <div class="chat-message-time">${formatChatTime(msg.timestamp)}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                ${renderAttachmentPreview()}
                
                <div class="chat-input-area">
                    <input type="file" id="attachmentInput" accept="image/*,.pdf,.doc,.docx,.txt" style="display: none;" onchange="handleAttachmentSelect(event)">
                    <button class="attachment-btn" onclick="document.getElementById('attachmentInput').click()">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <textarea id="chatInput" class="chat-input" placeholder="Digite sua mensagem..." 
                        rows="1" onkeypress="handleChatKeyPress(event)"></textarea>
                    <button class="chat-send-btn" onclick="sendChatMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            `;
        }

        function renderAttachment(attachment) {
            if (attachment.type === 'image') {
                return `<img src="${attachment.data}" class="chat-attachment-preview" alt="${attachment.name}" onclick="window.open('${attachment.data}', '_blank')">`;
            } else {
                return `
                    <div class="chat-attachment">
                        <div class="attachment-icon">
                            <i class="fas fa-file"></i>
                        </div>
                        <div class="attachment-info">
                            <div class="attachment-name">${attachment.name}</div>
                            <div class="attachment-size">${attachment.size}</div>
                        </div>
                    </div>
                `;
            }
        }

        function renderAttachmentPreview() {
            if (!pendingAttachment) return '';
            
            return `
                <div class="attachment-preview-container">
                    ${pendingAttachment.type === 'image' ? 
                        `<img src="${pendingAttachment.data}" class="attachment-preview-thumb" alt="${pendingAttachment.name}">` :
                        `<div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-file" style="font-size: 24px; color: var(--gray-light);"></i>
                            <span style="color: var(--white-soft);">${pendingAttachment.name}</span>
                        </div>`
                    }
                    <button class="remove-attachment-btn" onclick="removeAttachment()">×</button>
                </div>
            `;
        }

        function selectChatUser(userId) {
            // Garantir que staffData é um array
            if (!Array.isArray(staffData)) staffData = [];
            activeChatUser = staffData.find(s => s.id === userId);
            activeChatGroup = null; // Desselecionar grupo
            markMessagesAsRead(userId);
            
            // Atualizar badge após marcar como lido
            setTimeout(() => {
                updateChatNotificationBadge();
            }, 100);
            
            loadChat();
        }

        function selectChatGroup(groupId) {
            // Garantir que chatGroups é um array
            if (!Array.isArray(chatGroups)) chatGroups = [];
            activeChatGroup = chatGroups.find(g => g.id === groupId);
            activeChatUser = null; // Desselecionar usuário individual
            markGroupMessagesAsRead(groupId);
            
            setTimeout(() => {
                updateChatNotificationBadge();
            }, 100);
            
            loadChat();
        }

        function getChatMessages(userId) {
            const messages = Array.isArray(chatMessages) ? chatMessages : [];
            return messages.filter(msg => 
                (msg.senderId === currentUser.id && msg.receiverId === userId) ||
                (msg.senderId === userId && msg.receiverId === currentUser.id)
            ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        }

        function getLastMessage(userId) {
            const messages = getChatMessages(userId);
            if (messages.length === 0) return null;
            const last = messages[messages.length - 1];
            return last.text.length > 30 ? last.text.substring(0, 30) + '...' : last.text;
        }

        function getUnreadCount(userId) {
            const messages = Array.isArray(chatMessages) ? chatMessages : [];
            return messages.filter(msg => 
                msg.senderId === userId && 
                msg.receiverId === currentUser.id && 
                !msg.read
            ).length;
        }

        function markMessagesAsRead(userId) {
            const messages = Array.isArray(chatMessages) ? chatMessages : [];
            messages.forEach(msg => {
                if (msg.senderId === userId && msg.receiverId === currentUser.id) {
                    msg.read = true;
                }
            });
            chatMessages = messages;
            saveData('txd_chat_messages', chatMessages);
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text && !pendingAttachment) return;
            if (!activeChatUser && !activeChatGroup) return;
            
            const message = {
                id: Date.now(),
                senderId: currentUser.id,
                senderName: currentUser.displayName,
                text: text || '',
                timestamp: new Date().toISOString(),
                read: false
            };
            
            // Adicionar anexo se houver
            if (pendingAttachment) {
                message.attachment = pendingAttachment;
                pendingAttachment = null;
            }
            
            // Enviar para grupo ou usuário individual
            if (activeChatGroup) {
                message.groupId = activeChatGroup.id;
                checkAndUnlockAchievement('group_message');
            } else {
                message.receiverId = activeChatUser.id;
            }
            
            chatMessages.push(message);
            saveData('txd_chat_messages', chatMessages);
            
            // Desbloquear conquista de primeira mensagem
            checkAndUnlockAchievement('first_message');
            
            // Notificar Discord (apenas para grupos)
            if (activeChatGroup) {
                sendDiscordNotification('chat', '💬 Nova Mensagem no Grupo', `${message.senderName} enviou uma mensagem em "${activeChatGroup.name}"`, [
                    { name: '📝 Mensagem', value: message.text.substring(0, 100) + (message.text.length > 100 ? '...' : ''), inline: false },
                    { name: '👥 Grupo', value: activeChatGroup.name, inline: true },
                    { name: '👤 Enviado por', value: message.senderName, inline: true }
                ]);
            }
            
            input.value = '';
            loadChat();
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        function formatChatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Agora';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm atrás';
            if (diff < 86400000) return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        }

        // ========== FUNÇÕES DE GRUPOS ==========
        function getGroupChatMessages(groupId) {
            const messages = Array.isArray(chatMessages) ? chatMessages : [];
            return messages.filter(msg => msg && msg.groupId === groupId)
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        }

        function getGroupLastMessage(groupId) {
            const messages = getGroupChatMessages(groupId);
            if (messages.length === 0) return null;
            const last = messages[messages.length - 1];
            return last.text.length > 30 ? last.text.substring(0, 30) + '...' : last.text;
        }

        function getGroupUnreadCount(groupId) {
            const messages = Array.isArray(chatMessages) ? chatMessages : [];
            return messages.filter(msg => 
                msg && msg.groupId === groupId && 
                msg.senderId !== currentUser.id && 
                !msg.read
            ).length;
        }

        function markGroupMessagesAsRead(groupId) {
            chatMessages.forEach(msg => {
                if (msg.groupId === groupId && msg.senderId !== currentUser.id) {
                    msg.read = true;
                }
            });
            saveData('txd_chat_messages', chatMessages);
        }

        function openCreateGroupModal() {
            // Garantir que staffData é um array
            if (!Array.isArray(staffData)) staffData = [];
            
            const modal = document.getElementById('createGroupModal');
            const memberSelection = document.getElementById('groupMembersSelection');
            
            // Preencher lista de membros
            const otherStaff = staffData.filter(staff => staff.id !== currentUser.id);
            memberSelection.innerHTML = otherStaff.map(staff => `
                <div style="display: flex; align-items: center; gap: 12px; padding: 8px; border-radius: 8px; 
                    background: var(--gray-dark); margin-bottom: 8px; border: 1px solid var(--gray-border);">
                    <input type="checkbox" id="member_${staff.id}" value="${staff.id}" 
                        style="width: 18px; height: 18px; cursor: pointer;">
                    <label for="member_${staff.id}" style="flex: 1; cursor: pointer; color: var(--white-soft); font-size: 14px;">
                        <strong>${staff.name}</strong> - ${staff.role}
                    </label>
                </div>
            `).join('');
            
            modal.classList.add('active');
        }

        function saveGroup(event) {
            event.preventDefault();
            
            const groupName = document.getElementById('groupName').value;
            const groupDescription = document.getElementById('groupDescription').value;
            
            // Obter membros selecionados
            const selectedMembers = [];
            staffData.forEach(staff => {
                const checkbox = document.getElementById(`member_${staff.id}`);
                if (checkbox && checkbox.checked) {
                    selectedMembers.push({
                        id: staff.id,
                        name: staff.name,
                        role: staff.role
                    });
                }
            });
            
            if (selectedMembers.length === 0) {
                alert('Selecione pelo menos um membro para o grupo!');
                return;
            }
            
            // Adicionar o criador ao grupo
            selectedMembers.push({
                id: currentUser.id,
                name: currentUser.displayName,
                role: currentUser.role
            });
            
            const newGroup = {
                id: Date.now(),
                name: groupName,
                description: groupDescription,
                members: selectedMembers,
                createdBy: currentUser.id,
                createdAt: new Date().toISOString()
            };
            
            chatGroups.push(newGroup);
            saveData('txd_chat_groups', chatGroups);
            
            // Notificar Discord sobre criação de grupo
            sendDiscordNotification('chat', '👥 Novo Grupo Criado', 
                `${currentUser.name} criou um novo grupo de chat`,
                [
                    { name: '📛 Nome do Grupo', value: groupName, inline: true },
                    { name: '👥 Membros', value: selectedMembers.length.toString(), inline: true },
                    { name: '📝 Descrição', value: groupDescription || 'Sem descrição', inline: false },
                    { name: '👤 Participantes', value: selectedMembers.map(m => m.name).join(', '), inline: false },
                    { name: '👨‍💼 Criado por', value: currentUser.name, inline: true }
                ]
            );
            
            // Desbloquear conquista
            checkAndUnlockAchievement('create_group');
            
            closeModal('createGroupModal');
            document.getElementById('createGroupForm').reset();
            
            alert('Grupo criado com sucesso!');
            loadChat();
        }

        // ========== FUNÇÕES DE ANEXOS ==========
        function handleAttachmentSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const fileData = {
                    name: file.name,
                    size: formatFileSize(file.size),
                    type: file.type.startsWith('image/') ? 'image' : 'file',
                    data: e.target.result
                };
                
                pendingAttachment = fileData;
                
                // Desbloquear conquista
                checkAndUnlockAchievement('first_attachment');
                
                loadChat();
            };
            
            reader.readAsDataURL(file);
        }

        function removeAttachment() {
            pendingAttachment = null;
            loadChat();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // ========== SISTEMA DE RANKING E ESTATÍSTICAS ==========
        async function loadRanking() {
            const navSeq = activeNavSeq;
            try { renderSectionLoading('📊 Ranking e Estatísticas'); } catch (e) {}
            await nextFrame();

            // Carregar dados necessários em paralelo (sem N requests)
            const [staffRows, chatRows] = await Promise.all([
                getData('txd_staff', false),
                getData('txd_chat_messages', false),
                ensureKanbanLoaded(false),
                ensurePendenciesLoaded(false)
            ]).then(r => [r[0], r[1]]);

            if (navSeq !== activeNavSeq) return;
            if (Array.isArray(staffRows)) staffData = staffRows;
            if (Array.isArray(chatRows)) chatMessages = chatRows;

            const kanbanData = getKanbanSnapshotFromState();
            const cards = Array.isArray(kanbanData?.cards) ? kanbanData.cards : [];

            // Contagem de tarefas concluídas por nome (assignee)
            const doneByAssignee = new Map();
            cards.forEach(card => {
                if (!card) return;
                const columnId = card.columnId || card.column_id || '';
                if (columnId !== 'done') return;
                const assignees = getCardAssigneeList(card);
                assignees.forEach(name => {
                    const key = normalizePersonLabel(name);
                    if (!key) return;
                    doneByAssignee.set(key, (doneByAssignee.get(key) || 0) + 1);
                });
            });

            const staffList = Array.isArray(staffData) ? staffData : [];
            const staffStats = staffList.map(staff => {
                const label = normalizePersonLabel(staff.displayName || staff.name || '');
                const tasksCompleted = label ? (doneByAssignee.get(label) || 0) : 0;
                const pendenciasResolved = getResolvedPendenciesByStaff(staff.id);
                const messagesCount = getMessagesByStaff(staff.id);
                const score = (tasksCompleted * 10) + (pendenciasResolved * 15) + (messagesCount * 2);
                return { ...staff, tasksCompleted, pendenciasResolved, messagesCount, score };
            });
            
            // Ordenar por pontuação
            staffStats.sort((a, b) => b.score - a.score);
            
            const content = `
                <h1 id="sectionTitle">📊 Ranking e Estatísticas</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Desempenho e métricas da equipe</p>
                
                <!-- Cards de Estatísticas Gerais -->
                <div class="ranking-grid">
                    <div class="ranking-card">
                        <div class="ranking-card-header">
                            <div class="ranking-card-title">Total de Tarefas</div>
                            <div class="ranking-card-icon">✅</div>
                        </div>
                        <div style="font-size: 36px; font-weight: 800; color: var(--success); margin: 12px 0;">
                            ${staffStats.reduce((sum, s) => sum + s.tasksCompleted, 0)}
                        </div>
                        <div style="color: var(--gray-text); font-size: 13px;">Concluídas este mês</div>
                    </div>
                    
                    <div class="ranking-card">
                        <div class="ranking-card-header">
                            <div class="ranking-card-title">Pendencias Resolvidas</div>
                            <div class="ranking-card-icon">🎫</div>
                        </div>
                        <div style="font-size: 36px; font-weight: 800; color: var(--warning); margin: 12px 0;">
                            ${staffStats.reduce((sum, s) => sum + s.pendenciasResolved, 0)}
                        </div>
                        <div style="color: var(--gray-text); font-size: 13px;">Total resolvidos</div>
                    </div>
                    
                    <div class="ranking-card">
                        <div class="ranking-card-header">
                            <div class="ranking-card-title">Taxa de Atividade</div>
                            <div class="ranking-card-icon">📈</div>
                        </div>
                        <div style="font-size: 36px; font-weight: 800; color: var(--gray-very-light); margin: 12px 0;">
                            ${Math.round(staffStats.reduce((sum, s) => sum + s.score, 0) / staffStats.length)}
                        </div>
                        <div style="color: var(--gray-text); font-size: 13px;">Pontuação média</div>
                    </div>
                </div>
                
                <!-- Ranking de Desempenho -->
                <div class="stats-chart">
                    <div class="stats-chart-title">🏆 Top Performers - Ranking Geral</div>
                    ${staffStats.slice(0, 10).map((staff, index) => `
                        <div class="ranking-item">
                            <div class="ranking-position ${index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : ''}">
                                ${index + 1}
                            </div>
                            <div class="ranking-avatar">${staff.name.charAt(0)}</div>
                            <div class="ranking-info">
                                <div class="ranking-name">${staff.name}</div>
                                <div class="ranking-role">${staff.role}</div>
                            </div>
                            <div class="ranking-value">${staff.score} pts</div>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Gráfico de Tarefas Concluídas -->
                <div class="stats-chart">
                    <div class="stats-chart-title">✅ Tarefas Concluídas por Staff</div>
                    ${staffStats.slice(0, 8).map(staff => {
                        const maxTasks = Math.max(...staffStats.map(s => s.tasksCompleted));
                        const percentage = maxTasks > 0 ? (staff.tasksCompleted / maxTasks) * 100 : 0;
                        return `
                            <div class="chart-bar">
                                <div class="chart-bar-label">
                                    <span class="chart-bar-name">${staff.name}</span>
                                    <span class="chart-bar-value">${staff.tasksCompleted} tarefas</span>
                                </div>
                                <div class="chart-bar-bg">
                                    <div class="chart-bar-fill" style="width: ${percentage}%;"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <!-- Gráfico de Pendencias Resolvidas -->
                <div class="stats-chart">
                    <div class="stats-chart-title">📋 Pendencias Resolvidas por Staff</div>
                    ${staffStats.slice(0, 8).map(staff => {
                        const maxPendencias = Math.max(...staffStats.map(s => s.pendenciasResolved));
                        const percentage = maxPendencias > 0 ? (staff.pendenciasResolved / maxPendencias) * 100 : 0;
                        return `
                            <div class="chart-bar">
                                <div class="chart-bar-label">
                                    <span class="chart-bar-name">${staff.name}</span>
                                    <span class="chart-bar-value">${staff.pendenciasResolved} pendencias</span>
                                </div>
                                <div class="chart-bar-bg">
                                    <div class="chart-bar-fill" style="width: ${percentage}%; background: linear-gradient(90deg, var(--warning), var(--gray-very-light));"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <!-- Distribuição por Cargo -->
                <div class="stats-chart">
                    <div class="stats-chart-title">👥 Distribuição por Cargo</div>
                    ${getStaffByRole().map(roleData => {
                        const percentage = (roleData.count / staffData.length) * 100;
                        return `
                            <div class="chart-bar">
                                <div class="chart-bar-label">
                                    <span class="chart-bar-name">${roleData.role}</span>
                                    <span class="chart-bar-value">${roleData.count} membros</span>
                                </div>
                                <div class="chart-bar-bg">
                                    <div class="chart-bar-fill" style="width: ${percentage}%; background: linear-gradient(90deg, var(--gray-very-light), var(--success));"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            document.querySelector('.content-card').innerHTML = content;
        }

        // Funções auxiliares para cálculo de estatísticas
        async function getCompletedTasksByStaff(staffId) {
            try {
                // Usa o state em memória (evita N requests ao navegar)
                await ensureKanbanLoaded(false);
                const kanbanData = getKanbanSnapshotFromState();
                const staff = staffData.find(s => s.id === staffId);
                if (!staff) return 0;
                
                // Garantir que cards é um array
                if (!kanbanData || !kanbanData.cards || !Array.isArray(kanbanData.cards)) {
                    return 0;
                }
                
                return kanbanData.cards.filter(card => {
                    if (!card) return false;
                    const columnId = card.columnId || card.column_id || '';
                    const assignees = card.assignees || [];
                    return columnId === 'done' && Array.isArray(assignees) && assignees.includes(staff.name);
                }).length;
            } catch (error) {
                console.error('Erro ao buscar tarefas completadas:', error);
                return 0;
            }
        }

        function getResolvedPendenciesByStaff(staffId) {
            const staff = staffData.find(s => s.id === staffId);
            if (!staff) return 0;
            
            const pendenciasRaw = dataCache['txd_pendencies'];
            const pendencias = Array.isArray(pendenciasRaw) ? pendenciasRaw : [];
            return pendencias.filter(p => {
                const status = (p?.status || '').toLowerCase();
                const concluida = ['completed', 'concluida', 'concluída'].includes(status);
                const meta = (p?.attachments && typeof p.attachments === 'object') ? (p.attachments._meta || p.attachments.meta || null) : null;
                const responsavel = String(
                    p?.assignedUserName || p?.assigned_user_name || meta?.assignedUserName || meta?.assigned_user_name ||
                    p?.approvedBy || p?.approved_by || ''
                );
                return concluida && normalizePersonLabel(responsavel) === normalizePersonLabel(staff.displayName || staff.name || '');
            }).length;
        }

        function getMessagesByStaff(staffId) {
            const messages = Array.isArray(chatMessages) ? chatMessages : [];
            return messages.filter(msg => msg && msg.senderId === staffId).length;
        }

        function getStaffByRole() {
            const roleCount = {};
            staffData.forEach(staff => {
                roleCount[staff.role] = (roleCount[staff.role] || 0) + 1;
            });
            
            return Object.entries(roleCount).map(([role, count]) => ({
                role,
                count
            })).sort((a, b) => b.count - a.count);
        }

        // ========== SISTEMA DE CONQUISTAS ==========
        const ACHIEVEMENTS = [
            {
                id: 'first_message',
                title: '📨 Primeira Mensagem',
                description: 'Envie sua primeira mensagem no chat',
                icon: '💬',
                condition: () => {
                    const messages = Array.isArray(chatMessages) ? chatMessages : [];
                    return messages.filter(m => m && m.senderId === currentUser.id).length >= 1;
                },
                reward: '+10 pts'
            },
            {
                id: 'chat_master',
                title: '💯 Mestre do Chat',
                description: 'Envie 100 mensagens no chat',
                icon: '🗣️',
                condition: () => {
                    const messages = Array.isArray(chatMessages) ? chatMessages : [];
                    return messages.filter(m => m && m.senderId === currentUser.id).length >= 100;
                },
                reward: '+50 pts'
            },
            {
                id: 'first_task',
                title: '✅ Primeira Tarefa',
                description: 'Complete sua primeira tarefa',
                icon: '🎯',
                condition: async () => {
                    try {
                        const count = await getCompletedTasksByStaff(currentUser.id);
                        return count >= 1;
                    } catch (error) {
                        console.error('Erro ao verificar primeira tarefa:', error);
                        return false;
                    }
                },
                reward: '+15 pts'
            },
            {
                id: 'task_champion',
                title: '🏆 Campeão de Tarefas',
                description: 'Complete 50 tarefas',
                icon: '⭐',
                condition: async () => {
                    try {
                        const count = await getCompletedTasksByStaff(currentUser.id);
                        return count >= 50;
                    } catch (error) {
                        console.error('Erro ao verificar campeão de tarefas:', error);
                        return false;
                    }
                },
                reward: '+100 pts'
            },
            {
                id: 'first_pendency',
                title: '🎫 Primeiro Atendimento',
                description: 'Resolva seu primeira pendencia',
                icon: '🛎️',
                condition: () => getResolvedPendenciesByStaff(currentUser.id) >= 1,
                reward: '+20 pts'
            },
            {
                id: 'pendencies_hero',
                title: '🦸 Herói do Suporte',
                description: 'Resolva 30 pendencias',
                icon: '💪',
                condition: () => getResolvedPendenciesByStaff(currentUser.id) >= 30,
                reward: '+75 pts'
            },
            {
                id: 'create_group',
                title: '👥 Criador de Comunidade',
                description: 'Crie um grupo no chat',
                icon: '🌟',
                condition: () => chatGroups.some(g => g.createdBy === currentUser.id),
                reward: '+25 pts'
            },
            {
                id: 'group_message',
                title: '📢 Comunicador',
                description: 'Envie 10 mensagens em grupos',
                icon: '📣',
                condition: () => {
                    const messages = Array.isArray(chatMessages) ? chatMessages : [];
                    return messages.filter(m => m && m.senderId === currentUser.id && m.groupId).length >= 10;
                },
                reward: '+30 pts'
            },
            {
                id: 'first_attachment',
                title: '📎 Compartilhador',
                description: 'Envie seu primeiro anexo',
                icon: '📁',
                condition: () => {
                    const messages = Array.isArray(chatMessages) ? chatMessages : [];
                    return messages.filter(m => m && m.senderId === currentUser.id && m.attachment).length >= 1;
                },
                reward: '+15 pts'
            },
            {
                id: 'early_bird',
                title: '🌅 Madrugador',
                description: 'Faça login antes das 7h',
                icon: '☀️',
                condition: () => {
                    const now = new Date();
                    return now.getHours() < 7;
                },
                reward: '+10 pts'
            },
            {
                id: 'night_owl',
                title: '🦉 Coruja Noturna',
                description: 'Faça login depois das 23h',
                icon: '🌙',
                condition: () => {
                    const now = new Date();
                    return now.getHours() >= 23;
                },
                reward: '+10 pts'
            },
            {
                id: 'top_performer',
                title: '🥇 Top Performer',
                description: 'Fique em 1º lugar no ranking',
                icon: '👑',
                condition: async () => {
                    try {
                        const staffStatsPromises = staffData.map(async (staff) => {
                            const tasksCompleted = await getCompletedTasksByStaff(staff.id);
                            return {
                                id: staff.id,
                                score: (tasksCompleted * 10) + 
                                       (getResolvedPendenciesByStaff(staff.id) * 15) + 
                                       (getMessagesByStaff(staff.id) * 2)
                            };
                        });
                        const staffStats = await Promise.all(staffStatsPromises);
                        staffStats.sort((a, b) => b.score - a.score);
                        return staffStats[0]?.id === currentUser.id;
                    } catch (error) {
                        console.error('Erro ao verificar top performer:', error);
                        return false;
                    }
                },
                reward: '+150 pts'
            }
        ];

        async function loadAchievements() {
            const navSeq = activeNavSeq;
            try { renderSectionLoading('🏆 Conquistas'); } catch (e) {}
            await nextFrame();

            // Garantir dados necessários (evita condições assíncronas dispararem múltiplos fetches)
            const [staffRows, chatRows, achievementsRows] = await Promise.all([
                getData('txd_staff', false),
                getData('txd_chat_messages', false),
                getData('txd_user_achievements', false),
                ensureKanbanLoaded(false),
                ensurePendenciesLoaded(false)
            ]).then(r => [r[0], r[1], r[2]]);

            if (navSeq !== activeNavSeq) return;
            if (Array.isArray(staffRows)) staffData = staffRows;
            if (Array.isArray(chatRows)) chatMessages = chatRows;

            const allRows = Array.isArray(achievementsRows) ? achievementsRows : (Array.isArray(dataCache['txd_user_achievements']) ? dataCache['txd_user_achievements'] : []);
            dataCache['txd_user_achievements'] = allRows;

            const myId = String(currentUser?.id ?? '').trim();
            const currentUserAchievements = allRows
                .filter(r => isSameUserId(r?.userId ?? r?.user_id, myId))
                .map(r => (r?.achievementId ?? r?.achievement_id ?? '').toString())
                .filter(Boolean);

            const newlyUnlocked = [];
            
            // Verificar todas as conquistas (aguardar condições assíncronas)
            for (const achievement of ACHIEVEMENTS) {
                if (!currentUserAchievements.includes(achievement.id)) {
                    try {
                        const conditionResult = typeof achievement.condition === 'function' 
                            ? await achievement.condition() 
                            : achievement.condition();
                        if (conditionResult) {
                            currentUserAchievements.push(achievement.id);
                            newlyUnlocked.push(achievement.id);
                        }
                    } catch (error) {
                        console.error(`Erro ao verificar conquista ${achievement.id}:`, error);
                    }
                }
            }
            
            // Salvar apenas novas conquistas (evita upsert gigante / lag)
            if (newlyUnlocked.length > 0) {
                const nowIso = new Date().toISOString();
                const rowsToUpsert = newlyUnlocked.map(id => ({
                    userId: currentUser.id,
                    userName: String(currentUser?.displayName || currentUser?.name || '').trim() || null,
                    achievementId: id,
                    unlockedAt: nowIso
                }));
                saveData('txd_user_achievements', rowsToUpsert).catch(() => {});
                // Atualizar cache local
                rowsToUpsert.forEach(r => allRows.push(r));
                dataCache['txd_user_achievements'] = allRows;
            }
            
            const unlockedCount = currentUserAchievements.length;
            const totalCount = ACHIEVEMENTS.length;
            const completionPercentage = Math.round((unlockedCount / totalCount) * 100);
            
            const content = `
                <h1 id="sectionTitle">🏆 Conquistas</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Sistema de conquistas e recompensas</p>
                
                <!-- Resumo de Conquistas -->
                <div class="user-achievements-summary">
                    <div class="achievement-stat">
                        <div class="achievement-stat-value">${unlockedCount}/${totalCount}</div>
                        <div class="achievement-stat-label">Conquistas Desbloqueadas</div>
                    </div>
                    <div class="achievement-stat">
                        <div class="achievement-stat-value">${completionPercentage}%</div>
                        <div class="achievement-stat-label">Conclusão</div>
                    </div>
                    <div class="achievement-stat">
                        <div class="achievement-stat-value">${calculateAchievementPoints(currentUserAchievements)}</div>
                        <div class="achievement-stat-label">Pontos de Conquista</div>
                    </div>
                </div>
                
                <!-- Grid de Conquistas -->
                <div class="achievements-grid">
                    ${(await Promise.all(ACHIEVEMENTS.map(async (achievement) => {
                        const isUnlocked = currentUserAchievements.includes(achievement.id);
                        const progress = await getAchievementProgress(achievement);
                        
                        return `
                            <div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}">
                                <div class="achievement-icon">${achievement.icon}</div>
                                <div class="achievement-title">${achievement.title}</div>
                                <div class="achievement-description">${achievement.description}</div>
                                ${!isUnlocked && progress.current < progress.target ? `
                                    <div class="achievement-progress">
                                        <div class="achievement-progress-fill" style="width: ${(progress.current / progress.target) * 100}%"></div>
                                    </div>
                                    <div class="achievement-progress-text">${progress.current} / ${progress.target}</div>
                                ` : ''}
                                <div class="achievement-reward">${achievement.reward}</div>
                            </div>
                        `;
                    }))).join('')}
                </div>
            `;
            
            document.querySelector('.content-card').innerHTML = content;
        }

        function getAchievementProgress(achievement) {
            let current = 0;
            let target = 1;
            
            const messages = Array.isArray(chatMessages) ? chatMessages : [];
            
            switch(achievement.id) {
                case 'first_message':
                    current = Math.min(messages.filter(m => m && m.senderId === currentUser.id).length, 1);
                    target = 1;
                    break;
                case 'chat_master':
                    current = messages.filter(m => m && m.senderId === currentUser.id).length;
                    target = 100;
                    break;
                case 'first_task':
                    current = Math.min(getCompletedTasksByStaff(currentUser.id), 1);
                    target = 1;
                    break;
                case 'task_champion':
                    current = getCompletedTasksByStaff(currentUser.id);
                    target = 50;
                    break;
                case 'first_pendency':
                    current = Math.min(getResolvedPendenciesByStaff(currentUser.id), 1);
                    target = 1;
                    break;
                case 'pendencies_hero':
                    current = getResolvedPendenciesByStaff(currentUser.id);
                    target = 30;
                    break;
                case 'group_message':
                    current = messages.filter(m => m && m.senderId === currentUser.id && m.groupId).length;
                    target = 10;
                    break;
                case 'first_attachment':
                    current = Math.min(messages.filter(m => m && m.senderId === currentUser.id && m.attachment).length, 1);
                    target = 1;
                    break;
            }
            
            return { current, target };
        }

        function calculateAchievementPoints(unlockedAchievements) {
            return unlockedAchievements.reduce((total, achievementId) => {
                const achievement = ACHIEVEMENTS.find(a => a.id === achievementId);
                if (achievement) {
                    const points = parseInt(achievement.reward.match(/\d+/)[0]);
                    return total + points;
                }
                return total;
            }, 0);
        }

        function checkAndUnlockAchievement(achievementId) {
            try {
                const allRows = Array.isArray(dataCache['txd_user_achievements']) ? dataCache['txd_user_achievements'] : [];
                const myId = String(currentUser?.id ?? '').trim();
                if (!myId) return;

                const already = allRows.some(r => isSameUserId(r?.userId ?? r?.user_id, myId) && String(r?.achievementId ?? r?.achievement_id) === String(achievementId));
                if (already) return;

                const achievement = ACHIEVEMENTS.find(a => a.id === achievementId);
                if (!achievement) return;

                const maybe = achievement.condition ? achievement.condition() : false;
                const unlock = (ok) => {
                    if (!ok) return;
                    const row = {
                        userId: currentUser.id,
                        userName: String(currentUser?.displayName || currentUser?.name || '').trim() || null,
                        achievementId: achievementId,
                        unlockedAt: new Date().toISOString()
                    };
                    allRows.push(row);
                    dataCache['txd_user_achievements'] = allRows;
                    saveData('txd_user_achievements', [row]).catch(() => {});

                    showAchievementNotification(achievement);
                    sendDiscordNotification('achievements', '🏆 Conquista Desbloqueada!', `${currentUser?.displayName || currentUser?.name || 'Usuário'} desbloqueou uma nova conquista!`, [
                        { name: '🎖️ Conquista', value: achievement.title || 'Conquista', inline: false },
                        { name: '📝 Descrição', value: achievement.description || 'Sem descrição', inline: false },
                        { name: '🎁 Recompensa', value: achievement.reward || 'N/A', inline: true },
                        { name: '👤 Staff', value: currentUser?.displayName || currentUser?.name || 'Usuário', inline: true }
                    ]);
                };

                if (maybe && typeof maybe.then === 'function') {
                    maybe.then(unlock).catch(() => {});
                } else {
                    unlock(!!maybe);
                }
            } catch (e) {}
        }

        function showAchievementNotification(achievement) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, var(--success), var(--gray-very-light));
                color: var(--black-deep);
                padding: 20px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0, 255, 136, 0.3);
                z-index: 10000;
                font-weight: 700;
                display: flex;
                align-items: center;
                gap: 12px;
                animation: slideInRight 0.5s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="font-size: 32px;">${achievement.icon}</div>
                <div>
                    <div style="font-size: 16px; margin-bottom: 4px;">Conquista Desbloqueada!</div>
                    <div style="font-size: 14px; opacity: 0.9;">${achievement.title}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.5s ease-out';
                setTimeout(() => notification.remove(), 500);
            }, 4000);
        }

        // ========== INTEGRAÇÃO DISCORD ==========
        function getDiscordConfig() {
            const stored = getData('txd_discord_config');
            const defaultConfig = {
                enabled: false,
                webhooks: {
                    main: '',
                    logs: '',
                    events: '',
                    pendencias: ''
                },
                notifications: {
                    chat: true,
                    tasks: true,
                    pendencias: true,
                    events: true,
                    achievements: true,
                    staff: true
                },
                commandsEnabled: false,
                commandsWebhook: ''
            };
            
            // Se não existe config salva OU é um array vazio, salvar padrão
            if (!stored || Array.isArray(stored) || Object.keys(stored).length === 0 || !stored.hasOwnProperty('enabled')) {
                // Criar config padrão silenciosamente (sem log)
                saveData('txd_discord_config', defaultConfig);
                return defaultConfig;
            }
            
            // Garantir que todas as propriedades existem
            return {
                enabled: stored.enabled === true, // Força boolean
                webhooks: stored.webhooks || defaultConfig.webhooks,
                notifications: stored.notifications || defaultConfig.notifications,
                commandsEnabled: stored.commandsEnabled === true || false,
                commandsWebhook: stored.commandsWebhook || ''
            };
        }

        let discordConfig = getDiscordConfig();

        // ========== PAINEL ADMINISTRATIVO CENTRAL - PASSO 3 ==========
        
        // Variável para controlar aba ativa
        let activeSettingsTab = 'geral';

        function isRomanovUser() {
            const login = (currentUser?.login || '').toString().trim().toLowerCase();
            const name = (currentUser?.name || currentUser?.displayName || '').toString().trim().toLowerCase();
            return login === 'romanov' || name === 'romanov';
        }

        function loadSettings() {
            debugLog('loadSettings() chamado');
            
            // Recarregar config do Discord
            discordConfig = getDiscordConfig();
            
            debugLog('loadSettings() - discordConfig:', discordConfig);
            if (!hasPermission('system.config')) {
                const content = `
                    <h1 id="sectionTitle">Configurações do Sistema</h1>
                    <p style="color: var(--gray-light); margin-bottom: 24px;">Acesso negado</p>
                    <div style="padding: 20px; background: var(--gray-dark); border-radius: 12px; border: 1px solid var(--gray-border);">
                        <p style="color: var(--danger); margin-bottom: 12px;">
                            <i class="fas fa-lock"></i> Você não tem permissão para acessar as configurações do sistema.
                        </p>
                        <p style="color: var(--gray-light); font-size: 14px;">
                            Apenas cargos com permissão de administração podem acessar esta seção.
                        </p>
                    </div>
                `;
                document.querySelector('.content-card').innerHTML = content;
                return;
            }

            // Se não for romanov, não deixar cair na aba Geral (que é exclusiva)
            if (!isRomanovUser() && activeSettingsTab === 'geral') {
                activeSettingsTab = 'discord';
            }
            
            // Carregar aba padrão
            loadSettingsSection(activeSettingsTab);
        }
        
        // Função para carregar seção específica do painel de configurações
        function loadSettingsSection(tab) {
            activeSettingsTab = tab;
            
            const tabs = [
                { id: 'geral', name: 'Geral', icon: '⚙️', romanovOnly: true },
                { id: 'cargos', name: 'Cargos & Permissões', icon: '👥' },
                { id: 'seguranca', name: 'Acesso & Segurança', icon: '🔐' },
                { id: 'discord', name: 'Discord', icon: '🎮' },
                { id: 'logs', name: 'Logs & Auditoria', icon: '📋' },
                { id: 'sistema', name: 'Sistema', icon: '🖥️' }
            ];
            
            const tabsHTML = tabs
                .filter(t => !(t.romanovOnly && !isRomanovUser()))
                .map(t => `
                <button class="settings-tab ${tab === t.id ? 'active' : ''}" 
                        onclick="loadSettingsSection('${t.id}')"
                        style="padding: 12px 20px; background: ${tab === t.id ? 'var(--gray-medium)' : 'transparent'}; 
                               border: none; border-bottom: 2px solid ${tab === t.id ? 'var(--success)' : 'transparent'}; 
                               color: ${tab === t.id ? 'var(--white-soft)' : 'var(--gray-light)'}; 
                               cursor: pointer; font-size: 14px; font-weight: ${tab === t.id ? '600' : '400'}; 
                               transition: all 0.3s ease;">
                    <i class="fas"></i> ${t.icon} ${t.name}
                </button>
            `).join('');
            
            let contentHTML = '';
            
            switch(tab) {
                case 'geral':
                    if (!isRomanovUser()) {
                        contentHTML = `
                            <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border); text-align: center;">
                                <i class="fas fa-lock" style="font-size: 48px; color: var(--danger); margin-bottom: 16px;"></i>
                                <p style="color: var(--danger); font-size: 16px; margin-bottom: 8px;">Acesso Negado</p>
                                <p style="color: var(--gray-light); font-size: 14px;">
                                    A aba <strong>Geral</strong> é exclusiva do usuário <strong>romanov</strong>.
                                </p>
                            </div>
                        `;
                    } else {
                        contentHTML = loadSettingsGeneral();
                    }
                    break;
                case 'cargos':
                    contentHTML = loadSettingsRoles();
                    break;
                case 'seguranca':
                    contentHTML = loadSettingsSecurity();
                    break;
                case 'discord':
                    contentHTML = loadSettingsDiscord();
                    break;
                case 'logs':
                    contentHTML = loadSettingsLogs();
                    break;
                case 'sistema':
                    contentHTML = loadSettingsSystem();
                    break;
                default:
                    contentHTML = loadSettingsGeneral();
            }

            const content = `
                <h1 id="sectionTitle">Configurações do Sistema</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Painel Administrativo Central</p>
                
                <!-- Tabs Navigation -->
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 8px; margin-bottom: 24px; border: 1px solid var(--gray-border); display: flex; gap: 4px; overflow-x: auto;">
                    ${tabsHTML}
                </div>
                
                <!-- Tab Content -->
                <div id="settingsTabContent">
                    ${contentHTML}
                </div>
            `;
            
            document.querySelector('.content-card').innerHTML = content;
        }
        
        // 1. CONFIGURAÇÕES GERAIS
        function loadSettingsGeneral() {
            const systemSettings = getSystemSettingsObject();
            
            return `
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border); margin-bottom: 24px;">
                    <h2 style="color: var(--white-soft); margin-bottom: 20px; font-size: 18px;">
                        <i class="fas fa-cog"></i> Configurações Gerais
                    </h2>

                    <div style="background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 10px; padding: 16px; margin-bottom: 18px;">
                        <div style="color: var(--white-soft); font-weight: 800; margin-bottom: 10px;">O que dá para configurar aqui</div>
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; color: var(--gray-light); font-size: 13px; line-height: 1.45;">
                            <div>• Nome do sistema (título do painel)</div>
                            <div>• Logo (login + header)</div>
                            <div>• Imagem de fundo (login)</div>
                            <div>• Imagem de fundo (painel)</div>
                            <div>• Mensagem global (banner no início)</div>
                            <div>• Modo manutenção (bloqueio geral)</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- Nome do Sistema -->
                        <div>
                            <label style="color: var(--gray-light); font-size: 14px; margin-bottom: 8px; display: block;">
                                Nome do Sistema
                            </label>
                            <input type="text" 
                                   id="systemName"
                                   value="${systemSettings.systemName || 'TXD Staff System'}"
                                   placeholder="Nome do sistema"
                                   style="width: 100%; padding: 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 8px; color: var(--white-soft); font-size: 14px;"
                                   onchange="saveSystemSetting('systemName', this.value)">
                        </div>
                        
                        <!-- Logo -->
                        <div>
                            <label style="color: var(--gray-light); font-size: 14px; margin-bottom: 8px; display: block;">
                                URL do Logo
                            </label>
                            <input type="text" 
                                   id="logoUrl"
                                   value="${systemSettings.logoUrl || ''}"
                                   placeholder="https://exemplo.com/logo.png"
                                   style="width: 100%; padding: 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 8px; color: var(--white-soft); font-size: 14px;"
                                   onchange="saveSystemSetting('logoUrl', this.value)">
                            <div style="display:flex; align-items:center; gap: 12px; margin-top: 10px;">
                                <div style="width: 54px; height: 54px; border-radius: 12px; background: var(--black-dark); border: 1px solid var(--gray-border); display:flex; align-items:center; justify-content:center; overflow:hidden;">
                                    <img src="${escapeHtml(systemSettings.logoUrl || 'https://tdatgzjwcuatpqhfococ.supabase.co/storage/v1/object/public/logos/sem-fundo-txd.png')}" alt="Preview logo" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                                </div>
                                <div style="color: var(--gray-text); font-size: 12px; line-height: 1.5;">
                                    A logo será aplicada no login e no header assim que salvar.
                                </div>
                            </div>
                        </div>

                        <!-- Background do Login -->
                        <div>
                            <label style="color: var(--gray-light); font-size: 14px; margin-bottom: 8px; display: block;">
                                URL do Fundo (Login)
                            </label>
                            <input type="text"
                                   id="loginBackgroundUrl"
                                   value="${systemSettings.loginBackgroundUrl || ''}"
                                   placeholder="https://exemplo.com/bg-login.jpg"
                                   style="width: 100%; padding: 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 8px; color: var(--white-soft); font-size: 14px;"
                                   onchange="saveSystemSetting('loginBackgroundUrl', this.value)">
                            <p style="color: var(--gray-text); font-size: 12px; margin-top: 8px;">
                                Dica: use uma imagem em alta resolução (JPG/PNG).
                            </p>
                        </div>

                        <!-- Background do Painel -->
                        <div>
                            <label style="color: var(--gray-light); font-size: 14px; margin-bottom: 8px; display: block;">
                                URL do Fundo (Painel)
                            </label>
                            <input type="text"
                                   id="appBackgroundUrl"
                                   value="${systemSettings.appBackgroundUrl || ''}"
                                   placeholder="https://exemplo.com/bg-painel.jpg"
                                   style="width: 100%; padding: 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 8px; color: var(--white-soft); font-size: 14px;"
                                   onchange="saveSystemSetting('appBackgroundUrl', this.value)">
                            <p style="color: var(--gray-text); font-size: 12px; margin-top: 8px;">
                                Esta imagem aparece atrás de todas as abas do painel.
                            </p>
                        </div>
                        
                        <!-- Modo Manutenção -->
                        <div>
                            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                <div class="toggle-switch ${systemSettings.maintenanceMode ? 'active' : ''}" 
                                     onclick="toggleMaintenanceMode()"
                                     id="maintenanceToggle">
                                </div>
                                <span style="color: var(--gray-light); font-size: 14px;">
                                    Modo Manutenção
                                    <span style="margin-left: 8px; font-weight: 600; color: ${systemSettings.maintenanceMode ? 'var(--warning)' : 'var(--success)'};">
                                        (${systemSettings.maintenanceMode ? 'ATIVO' : 'INATIVO'})
                                    </span>
                                </span>
                            </label>
                            <p style="color: var(--gray-text); font-size: 12px; margin-top: 8px; margin-left: 48px;">
                                Quando ativo, apenas administradores podem acessar o sistema
                            </p>
                        </div>
                        
                        <!-- Mensagem Global -->
                        <div>
                            <label style="color: var(--gray-light); font-size: 14px; margin-bottom: 8px; display: block;">
                                Mensagem Global do Sistema
                            </label>
                            <textarea id="globalMessage"
                                      placeholder="Digite uma mensagem que será exibida para todos os usuários..."
                                      style="width: 100%; padding: 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 8px; color: var(--white-soft); font-size: 14px; min-height: 100px; resize: vertical; font-family: inherit;"
                                      onchange="saveSystemSetting('globalMessage', this.value)">${systemSettings.globalMessage || ''}</textarea>
                            <p style="color: var(--gray-text); font-size: 12px; margin-top: 8px;">
                                Esta mensagem aparecerá no topo do dashboard para todos os usuários
                            </p>
                        </div>
                        
                        <button class="btn btn-primary" onclick="saveAllGeneralSettings()" style="margin-top: 8px;">
                            <i class="fas fa-save"></i> Salvar Configurações Gerais
                        </button>
                    </div>
                </div>
            `;
        }
        
        // 2. CARGOS & PERMISSÕES (RBAC COMPLETO)
        function loadSettingsRoles() {
            if (!hasPermission('permission.manage') && currentUser.role !== 'Owner' && currentUser.role !== 'CEO') {
                return `
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border); text-align: center;">
                        <i class="fas fa-lock" style="font-size: 48px; color: var(--danger); margin-bottom: 16px;"></i>
                        <p style="color: var(--danger); font-size: 16px; margin-bottom: 8px;">Acesso Negado</p>
                        <p style="color: var(--gray-light); font-size: 14px;">
                            Apenas Owner e CEO podem gerenciar cargos e permissões.
                        </p>
                    </div>
                `;
            }
            
            const roles = Object.keys(ROLE_PERMISSIONS);
            const canManage = currentUser?.role === 'Owner' || currentUser?.role === 'CEO' || hasPermission('permission.manage');
            
            return `
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border); margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: var(--white-soft); font-size: 18px; margin: 0;">
                            <i class="fas fa-users-cog"></i> Gestão de Cargos e Permissões
                        </h2>
                        <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="resetRolePermissionsToDefault(); loadSettingsSection('cargos');" style="width:auto; padding: 10px 14px;">
                                <i class="fas fa-rotate-left"></i> Resetar Padrão
                            </button>
                            <button class="btn btn-primary" onclick="openNewRoleModal()">
                            <i class="fas fa-plus"></i> Novo Cargo
                            </button>
                        </div>
                    </div>
                    <p style="color: var(--gray-text); font-size: 12px; margin: 0 0 14px 0;">
                        Dica: permissões são salvas no navegador (localStorage). Para multiusuário, depois podemos persistir no Supabase.
                    </p>
                    
                        <div style="display: grid; gap: 16px;">
                        ${roles.map(role => {
                            const permissions = getUserPermissions(role);
                            const hasAll = permissions.includes('*');
                            const isCLevel = ['Owner', 'CEO', 'COO', 'CMO', 'CCO', 'CIO'].includes(role);
                            const isOperational = !isCLevel && role !== 'Dev';
                                
                                return `
                                    <div style="background: var(--black-dark); border-radius: 8px; padding: 16px; border: 1px solid var(--gray-border);">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                                <h3 style="color: var(--white-soft); font-size: 16px; font-weight: 600; margin: 0;">
                                                    ${role}
                                                </h3>
                                                <span style="background: ${isCLevel ? 'var(--success)' : 'var(--info)'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                                    ${isCLevel ? 'C-Level' : isOperational ? 'Operacional' : 'Técnico'}
                                            </span>
                                        </div>
                                            <p style="color: var(--gray-text); font-size: 12px; margin: 0;">
                                                ${hasAll ? 'Acesso total ao sistema' : `${permissions.length} permissões configuradas`}
                                            </p>
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="btn btn-secondary" onclick="editRole('${role}')" style="padding: 8px 16px; font-size: 12px;">
                                                <i class="fas fa-edit"></i> Editar
                                            </button>
                                            ${role !== 'Owner' && role !== 'CEO' ? `
                                            <button class="btn btn-danger" onclick="deleteRole('${role}')" style="padding: 8px 16px; font-size: 12px;">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                    
                                        ${hasAll ? `
                                    <p style="color: var(--success); font-size: 12px; padding: 8px; background: rgba(0, 255, 136, 0.1); border-radius: 6px; margin: 0;">
                                            <i class="fas fa-check-circle"></i> Possui acesso total ao sistema
                                        </p>
                                        ` : `
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px;">
                                        ${permissions.slice(0, 8).map(perm => `
                                                <span style="background: var(--gray-medium); color: var(--gray-light); padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                                ${perm}
                                                </span>
                                            `).join('')}
                                        ${permissions.length > 8 ? `
                                                <span style="background: var(--gray-medium); color: var(--gray-light); padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                                +${permissions.length - 8} mais
                                                </span>
                                            ` : ''}
                                        </div>
                                        `}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                
                <!-- Preview de Permissões -->
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border);">
                    <h2 style="color: var(--white-soft); margin-bottom: 16px; font-size: 18px;">
                        <i class="fas fa-eye"></i> Preview: Suas Permissões
                    </h2>
                    <div style="background: var(--black-dark); border-radius: 8px; padding: 16px;">
                        <p style="color: var(--white-soft); font-weight: 600; margin-bottom: 8px;">Cargo(s): ${(normalizeRoleList(currentUser.roles || currentUser.role).join(' + ') || currentUser.role)}</p>
                        <p style="color: var(--gray-light); font-size: 14px; margin-bottom: 16px;">
                            ${getCurrentUserPermissions().includes('*') ? 'Acesso total ao sistema' : `${getCurrentUserPermissions().length} permissões ativas`}
                        </p>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${getCurrentUserPermissions().map(perm => `
                                <span style="background: var(--success); color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500;">
                                    <i class="fas fa-check-circle"></i> ${perm}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 3. ACESSO & SEGURANÇA
        function loadSettingsSecurity() {
            const securitySettings = getData('txd_security_settings') || {
                sessionTimeout: 30, // minutos
                autoLogout: true,
                maxLoginAttempts: 5,
                requireTermsAcceptance: true,
                blockedIPs: []
            };
            
            return `
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border); margin-bottom: 24px;">
                    <h2 style="color: var(--white-soft); margin-bottom: 20px; font-size: 18px;">
                        <i class="fas fa-shield-alt"></i> Configurações de Segurança
                    </h2>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- Tempo de Sessão -->
                        <div>
                            <label style="color: var(--gray-light); font-size: 14px; margin-bottom: 8px; display: block;">
                                Tempo de Sessão (minutos)
                            </label>
                            <input type="number" 
                                   id="sessionTimeout"
                                   value="${securitySettings.sessionTimeout || 30}"
                                   min="5"
                                   max="480"
                                   style="width: 100%; padding: 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 8px; color: var(--white-soft); font-size: 14px;"
                                   onchange="saveSystemSetting('sessionTimeout', parseInt(this.value))">
                            <p style="color: var(--gray-text); font-size: 12px; margin-top: 8px;">
                                Tempo máximo de inatividade antes do logout automático
                            </p>
                        </div>
                        
                        <!-- Logout Automático -->
                        <div>
                            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                <div class="toggle-switch ${securitySettings.autoLogout ? 'active' : ''}" 
                                     onclick="toggleAutoLogout()"
                                     id="autoLogoutToggle">
                                </div>
                                <span style="color: var(--gray-light); font-size: 14px;">
                                    Logout Automático por Inatividade
                                    <span style="margin-left: 8px; font-weight: 600; color: ${securitySettings.autoLogout ? 'var(--success)' : 'var(--danger)'};">
                                        (${securitySettings.autoLogout ? 'ATIVO' : 'INATIVO'})
                                    </span>
                                </span>
                            </label>
                        </div>
                        
                        <!-- Tentativas de Login -->
                        <div>
                            <label style="color: var(--gray-light); font-size: 14px; margin-bottom: 8px; display: block;">
                                Máximo de Tentativas de Login
                            </label>
                            <input type="number" 
                                   id="maxLoginAttempts"
                                   value="${securitySettings.maxLoginAttempts || 5}"
                                   min="3"
                                   max="10"
                                   style="width: 100%; padding: 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 8px; color: var(--white-soft); font-size: 14px;"
                                   onchange="saveSystemSetting('maxLoginAttempts', parseInt(this.value))">
                            <p style="color: var(--gray-text); font-size: 12px; margin-top: 8px;">
                                Após exceder este limite, o IP será bloqueado temporariamente
                            </p>
                        </div>
                        
                        <!-- Aceite de Termos -->
                        <div>
                            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                <div class="toggle-switch ${securitySettings.requireTermsAcceptance ? 'active' : ''}" 
                                     onclick="toggleTermsRequirement()"
                                     id="termsToggle">
                                </div>
                                <span style="color: var(--gray-light); font-size: 14px;">
                                    Forçar Aceite de Termos
                                    <span style="margin-left: 8px; font-weight: 600; color: ${securitySettings.requireTermsAcceptance ? 'var(--success)' : 'var(--danger)'};">
                                        (${securitySettings.requireTermsAcceptance ? 'ATIVO' : 'INATIVO'})
                                    </span>
                                </span>
                            </label>
                            <p style="color: var(--gray-text); font-size: 12px; margin-top: 8px; margin-left: 48px;">
                                Usuários devem aceitar os termos antes de acessar o sistema
                            </p>
                        </div>
                        
                        <!-- IPs Bloqueados (preparar estrutura) -->
                        <div>
                            <label style="color: var(--gray-light); font-size: 14px; margin-bottom: 8px; display: block;">
                                IPs Bloqueados
                            </label>
                            <div style="background: var(--black-dark); border-radius: 8px; padding: 12px; border: 1px solid var(--gray-border); min-height: 100px;">
                                ${securitySettings.blockedIPs && securitySettings.blockedIPs.length > 0 ? `
                                    ${securitySettings.blockedIPs.map(ip => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--gray-dark); border-radius: 6px; margin-bottom: 8px;">
                                            <span style="color: var(--white-soft); font-family: monospace; font-size: 12px;">${ip}</span>
                                            <button class="btn btn-danger" onclick="unblockIP('${ip}')" style="padding: 4px 12px; font-size: 11px;">
                                                <i class="fas fa-unlock"></i> Desbloquear
                            </button>
                        </div>
                                    `).join('')}
                                ` : `
                                    <p style="color: var(--gray-text); font-size: 12px; text-align: center; margin: 0;">
                                        Nenhum IP bloqueado no momento
                                    </p>
                                `}
                    </div>
                            <p style="color: var(--gray-text); font-size: 12px; margin-top: 8px;">
                                IPs bloqueados automaticamente após múltiplas tentativas de login falhadas
                            </p>
                </div>
                        
                        <button class="btn btn-primary" onclick="saveAllSecuritySettings()" style="margin-top: 8px;">
                            <i class="fas fa-save"></i> Salvar Configurações de Segurança
                        </button>
                    </div>
                </div>
            `;
        }
        
        // 4. DISCORD (já existe, mas vamos adaptar para a aba)
        function loadSettingsDiscord() {
            discordConfig = getDiscordConfig();
            
            return `
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border);">
                    <div class="discord-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div class="discord-icon" style="width: 48px; height: 48px; background: #5865F2; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                            <i class="fab fa-discord"></i>
                        </div>
                            <div>
                                <h2 style="color: var(--white-soft); font-size: 18px; margin: 0;">
                                    Integração com Discord
                                </h2>
                                <p style="color: var(--gray-light); font-size: 14px; margin: 4px 0 0 0;">
                                    Envie notificações automáticas para o servidor Discord
                                </p>
                        </div>
                        </div>
                        <div class="discord-status ${discordConfig.enabled ? 'active' : 'inactive'}" 
                             style="background: ${discordConfig.enabled ? 'var(--success)' : 'var(--danger)'}; 
                                    color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                            <i class="fas fa-circle" style="font-size: 8px; margin-right: 6px;"></i>
                            ${discordConfig.enabled ? 'Ativo' : 'Inativo'}
                        </div>
                    </div>
                    
                    ${discordConfig.enabled ? `
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;" onclick="toggleDiscordIntegration()">
                                <div class="toggle-switch ${discordConfig.enabled ? 'active' : ''}" id="discordToggle"></div>
                            <span style="color: var(--gray-light); font-size: 14px;">
                                Ativar integração com Discord
                                <span style="margin-left: 8px; font-weight: 600; color: ${discordConfig.enabled ? 'var(--success)' : 'var(--danger)'};">
                                    (${discordConfig.enabled ? 'ATIVO' : 'INATIVO'})
                                </span>
                            </span>
                        </label>
                    </div>
                    
                        <!-- Webhook Principal -->
                        <div style="margin-bottom: 20px;">
                            <label style="color: var(--gray-light); font-size: 14px; margin-bottom: 8px; display: block;">
                                <i class="fas fa-link"></i> Webhook Principal (Obrigatório)
                            </label>
                        <input type="text" 
                               id="webhookMain"
                               placeholder="https://discord.com/api/webhooks/..."
                                   value="${discordConfig.webhooks?.main || ''}"
                                   style="width: 100%; padding: 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 8px; color: var(--white-soft); font-family: monospace; font-size: 12px;"
                               onchange="saveWebhook('main', this.value)">
                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <button class="btn btn-secondary" onclick="testWebhook('main')" style="padding: 8px 16px; font-size: 12px;">
                                <i class="fas fa-vial"></i> Testar
                            </button>
                                <button class="btn btn-secondary" onclick="diagnoseDiscordIntegration()" style="padding: 8px 16px; font-size: 12px;">
                                    <i class="fas fa-stethoscope"></i> Diagnóstico
                            </button>
                        </div>
                            <p style="color: var(--gray-text); font-size: 11px; margin-top: 8px;">
                                Este webhook receberá a maioria das notificações do sistema
                            </p>
                    </div>
                    
                        <!-- Tipos de Notificações -->
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: var(--white-soft); font-size: 16px; margin-bottom: 12px;">
                                <i class="fas fa-bell"></i> Tipos de Notificações
                            </h3>
                            <div style="display: grid; gap: 12px;">
                                ${['chat', 'tasks', 'pendencias', 'events', 'achievements', 'staff'].map(type => {
                                    const typeNames = {
                                        chat: '💬 Chat',
                                        tasks: '📋 Tarefas',
                                        pendencias: '📋 Pendencias',
                                        events: '📅 Eventos',
                                        achievements: '🏆 Conquistas',
                                        staff: '👥 Staff'
                                    };
                                    return `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--black-dark); border-radius: 8px; border: 1px solid var(--gray-border);">
                                            <span style="color: var(--white-soft); font-size: 14px;">${typeNames[type]}</span>
                                            <div class="toggle-switch ${discordConfig.notifications?.[type] ? 'active' : ''}" 
                                                 onclick="toggleNotification('${type}')"
                                                 style="cursor: pointer;">
                            </div>
                        </div>
                                    `;
                                }).join('')}
                        </div>
                    </div>
                    
                        <div style="background: var(--info); color: white; padding: 12px; border-radius: 8px; font-size: 13px; margin-top: 20px;">
                            <i class="fas fa-info-circle"></i> <strong>Dica:</strong> Use o botão "Diagnóstico" para verificar se tudo está configurado corretamente.
                            </div>
                    ` : `
                        <div style="text-align: center; padding: 40px; color: var(--gray-text);">
                            <i class="fab fa-discord" style="font-size: 64px; opacity: 0.3; margin-bottom: 16px;"></i>
                            <p style="margin-bottom: 20px;">Ative a integração para configurar webhooks e notificações</p>
                            <button class="btn btn-primary" onclick="toggleDiscordIntegration()">
                                <i class="fas fa-power-off"></i> Ativar Integração
                            </button>
                        </div>
                    `}
                    </div>
            `;
        }
        
        function loadDiscordConfigContent() {
            return `
                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;" onclick="toggleDiscordIntegration()">
                        <div class="toggle-switch ${discordConfig.enabled ? 'active' : ''}" id="discordToggle"></div>
                        <span style="color: var(--gray-light); font-size: 14px;">
                            Ativar integração com Discord
                            <span style="margin-left: 8px; font-weight: 600; color: ${discordConfig.enabled ? 'var(--success)' : 'var(--danger)'};">
                                (${discordConfig.enabled ? 'ATIVO' : 'INATIVO'})
                            </span>
                        </span>
                    </label>
                            </div>
                
                <!-- Webhooks e Notificações - conteúdo existente será mantido -->
                <div style="margin-top: 24px;">
                    <p style="color: var(--gray-light); font-size: 14px; margin-bottom: 16px;">
                        Configure os webhooks e tipos de notificações abaixo. O conteúdo completo será carregado aqui.
                    </p>
                    <button class="btn btn-secondary" onclick="loadSettingsSection('discord'); location.reload();">
                        <i class="fas fa-sync"></i> Recarregar Configurações Discord
                            </button>
                        </div>
            `;
        }
        
        // 5. LOGS & AUDITORIA
        function loadSettingsLogs() {
            if (!hasPermission('system.logs') && currentUser.role !== 'Owner' && currentUser.role !== 'CEO' && currentUser.role !== 'HeadStaff') {
                return `
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border); text-align: center;">
                        <i class="fas fa-lock" style="font-size: 48px; color: var(--danger); margin-bottom: 16px;"></i>
                        <p style="color: var(--danger); font-size: 16px; margin-bottom: 8px;">Acesso Negado</p>
                        <p style="color: var(--gray-light); font-size: 14px;">
                            Apenas C-Level e HeadStaff podem visualizar logs do sistema.
                        </p>
                    </div>
                `;
            }
            
            const logsRaw = getData('txd_system_logs');
            // Garantir que logs seja sempre um array
            const logs = Array.isArray(logsRaw) ? logsRaw : [];
            const recentLogs = logs.slice(-50).reverse(); // Últimos 50 logs
            
            return `
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border); margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: var(--white-soft); font-size: 18px; margin: 0;">
                            <i class="fas fa-file-alt"></i> Logs do Sistema
                        </h2>
                        <button class="btn btn-secondary" onclick="exportLogs()">
                            <i class="fas fa-download"></i> Exportar Logs
                        </button>
                        </div>
                        
                    <div style="background: var(--black-dark); border-radius: 8px; padding: 16px; max-height: 600px; overflow-y: auto;">
                        ${recentLogs.length > 0 ? `
                            <div style="display: grid; gap: 12px;">
                                ${recentLogs.map(log => `
                                    <div style="background: var(--gray-dark); border-radius: 6px; padding: 12px; border-left: 3px solid ${getLogColor(log.action)};">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div>
                                                <span style="color: var(--white-soft); font-weight: 600; font-size: 14px;">
                                                    ${log.action || 'Ação desconhecida'}
                                                </span>
                                                <span style="color: var(--gray-text); font-size: 12px; margin-left: 12px;">
                                                    ${log.module || 'Sistema'}
                                                </span>
                            </div>
                                            <span style="color: var(--gray-text); font-size: 11px;">
                                                ${new Date(log.timestamp).toLocaleString('pt-BR')}
                                            </span>
                            </div>
                                        ${log.metadata ? `
                                            <div style="color: var(--gray-light); font-size: 12px; margin-top: 8px;">
                                                ${JSON.stringify(log.metadata, null, 2)}
                        </div>
                                        ` : ''}
                                        <div style="color: var(--gray-text); font-size: 11px; margin-top: 8px;">
                                            Usuário: ${log.user_id || 'Sistema'} | IP: ${log.ip || 'N/A'}
                            </div>
                            </div>
                                `).join('')}
                        </div>
                        ` : `
                            <p style="color: var(--gray-text); font-size: 14px; text-align: center; padding: 40px;">
                                Nenhum log registrado ainda
                            </p>
                        `}
                            </div>
                            </div>
            `;
        }
        
        function getLogColor(action) {
            if (action.includes('login') || action.includes('Login')) return 'var(--success)';
            if (action.includes('delete') || action.includes('Delete') || action.includes('remove')) return 'var(--danger)';
            if (action.includes('create') || action.includes('Create') || action.includes('add')) return 'var(--info)';
            if (action.includes('update') || action.includes('Update') || action.includes('edit')) return 'var(--warning)';
            return 'var(--gray-text)';
        }
        
        // 6. CONFIGURAÇÕES DO SISTEMA
        function loadSettingsSystem() {
            return `
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border); margin-bottom: 24px;">
                    <h2 style="color: var(--white-soft); margin-bottom: 20px; font-size: 18px;">
                        <i class="fas fa-server"></i> Configurações do Sistema
                    </h2>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- Módulos do Sistema -->
                        <div>
                            <h3 style="color: var(--white-soft); font-size: 16px; margin-bottom: 12px;">
                                Módulos do Sistema
                            </h3>
                            <div style="display: grid; gap: 12px;">
                                ${['Chat', 'Pendencias', 'Kanban', 'Agenda', 'Ranking', 'Conquistas'].map(module => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--black-dark); border-radius: 8px; border: 1px solid var(--gray-border);">
                                        <span style="color: var(--white-soft); font-size: 14px;">${module}</span>
                                        <div class="toggle-switch active" style="cursor: pointer;">
                            </div>
                            </div>
                                `).join('')}
                        </div>
                    </div>
                    
                        <!-- Ações do Sistema -->
                            <div>
                            <h3 style="color: var(--white-soft); font-size: 16px; margin-bottom: 12px;">
                                Ações do Sistema
                            </h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                                <button class="btn btn-secondary" onclick="clearCache()">
                                    <i class="fas fa-broom"></i> Limpar Cache Local
                                </button>
                                <button class="btn btn-primary" onclick="exportSystemData()">
                                    <i class="fas fa-download"></i> Exportar Backup Completo
                                </button>
                                <button class="btn btn-success" onclick="importSystemData()">
                                    <i class="fas fa-upload"></i> Restaurar Backup
                                </button>
                                <button class="btn btn-secondary" onclick="viewBackupHistory()">
                                    <i class="fas fa-history"></i> Histórico de Backups
                                </button>
                                ${currentUser.role === 'Owner' ? `
                                <button class="btn btn-danger" onclick="resetSystemSettings()">
                                    <i class="fas fa-undo"></i> Resetar Configurações
                                </button>
                                ` : ''}
                            </div>
                            <div style="background: var(--gray-darker); border-radius: 8px; padding: 16px; margin-top: 16px; border: 1px solid var(--gray-border);">
                                <p style="color: var(--gray-light); font-size: 13px; margin: 0; line-height: 1.6;">
                                    <i class="fas fa-info-circle" style="color: var(--primary); margin-right: 8px;"></i>
                                    <strong>Backup Completo:</strong> Exporta todos os dados do sistema (staff, tarefas, pendencias, eventos, chat, advertências, etc.) em um único arquivo JSON. Use "Restaurar Backup" para importar dados de um backup anterior. O histórico mantém os últimos 10 backups.
                                </p>
                            </div>
                        </div>
                        </div>
                    </div>
            `;
        }

        // ========== FUNÇÕES OBRIGATÓRIAS ==========
        
        // Salvar configuração do sistema
        async function saveSystemSetting(key, value) {
            try {
                // Configurações gerais / branding são exclusivas do romanov
                const romanovOnlyKeys = new Set(['systemName', 'maintenanceMode', 'globalMessage', 'logoUrl', 'appBackgroundUrl', 'loginBackgroundUrl']);
                if (romanovOnlyKeys.has(String(key || '')) && !isRomanovUser()) {
                    alert('Apenas o usuário romanov pode alterar as configurações gerais.');
                    return false;
                }
                const settings = getSystemSettingsObject();
                settings[key] = value;
                // Salvar local (sempre) para funcionar mesmo sem tabela no Supabase
                dataCache['txd_system_settings'] = settings;
                writeSystemSettingsLocal(settings);
                applyBrandingFromSystemSettings(settings);

                // Persistir no Supabase (best-effort)
                await saveData('txd_system_settings', settings);
                
                // Log da ação
                logSystemAction('Configuração atualizada', 'Sistema', { key, value });
                
                return true;
            } catch (error) {
                console.error('Erro ao salvar configuração:', error);
                return false;
            }
        }
        
        // Criar novo cargo
        function createRole(roleName, permissions, level = 'operational') {
            if (!hasPermission('permission.manage') && currentUser.role !== 'Owner' && currentUser.role !== 'CEO') {
                alert('Você não tem permissão para criar cargos.');
                return false;
            }
            
            if (ROLE_PERMISSIONS[roleName]) {
                alert('Este cargo já existe.');
                return false;
            }
            
            ROLE_PERMISSIONS[roleName] = permissions;
            saveRolePermissionsToLocal();
            
            logSystemAction('Cargo criado', 'Permissões', { role: roleName, permissions, level });
            
            loadSettingsSection('cargos');
            return true;
        }
        
        // Atualizar permissões de um cargo
        function updateRolePermissions(role, permissions) {
            if (!hasPermission('permission.manage') && currentUser.role !== 'Owner' && currentUser.role !== 'CEO') {
                alert('Você não tem permissão para editar permissões.');
                return false;
            }
            
            if (role === 'Owner' || role === 'CEO') {
                alert('Não é possível alterar permissões de Owner ou CEO.');
                return false;
            }
            
            ROLE_PERMISSIONS[role] = permissions;
            saveRolePermissionsToLocal();
            
            logSystemAction('Permissões atualizadas', 'Permissões', { role, permissions });
            
            loadSettingsSection('cargos');
            return true;
        }
        
        // Registrar ação do sistema (logs)
        function logSystemAction(action, module, metadata = {}) {
            try {
                const logsRaw = getData('txd_system_logs');
                const logs = Array.isArray(logsRaw) ? logsRaw : [];
                const logEntry = {
                    id: Date.now(),
                    user_id: currentUser?.id || 'system',
                    user_name: currentUser?.name || 'Sistema',
                    action: action,
                    module: module,
                    timestamp: new Date().toISOString(),
                    metadata: metadata,
                    ip: 'N/A' // Será implementado quando houver backend
                };
                
                logs.push(logEntry);
                
                // Manter apenas últimos 1000 logs
                if (logs.length > 1000) {
                    logs.shift();
                }
                
                saveData('txd_system_logs', logs);
                
                return true;
            } catch (error) {
                console.error('Erro ao registrar log:', error);
                return false;
            }
        }
        
        // Funções auxiliares para as abas
        function saveAllGeneralSettings() {
            if (!isRomanovUser()) {
                alert('Apenas o usuário romanov pode salvar as configurações gerais.');
                return;
            }
            const systemName = document.getElementById('systemName')?.value;
            const logoUrl = document.getElementById('logoUrl')?.value;
            const globalMessage = document.getElementById('globalMessage')?.value;
            const loginBackgroundUrl = document.getElementById('loginBackgroundUrl')?.value;
            const appBackgroundUrl = document.getElementById('appBackgroundUrl')?.value;
            
            if (systemName) saveSystemSetting('systemName', systemName);
            if (logoUrl !== undefined) saveSystemSetting('logoUrl', logoUrl);
            if (globalMessage !== undefined) saveSystemSetting('globalMessage', globalMessage);
            if (loginBackgroundUrl !== undefined) saveSystemSetting('loginBackgroundUrl', loginBackgroundUrl);
            if (appBackgroundUrl !== undefined) saveSystemSetting('appBackgroundUrl', appBackgroundUrl);
            
            alert('Configurações gerais salvas com sucesso!');
            logSystemAction('Configurações gerais atualizadas', 'Sistema', { systemName, logoUrl, loginBackgroundUrl, appBackgroundUrl });
        }
        
        function toggleMaintenanceMode() {
            if (!isRomanovUser()) {
                alert('Apenas o usuário romanov pode alterar o modo manutenção.');
                return;
            }
            const settings = getSystemSettingsObject();
            settings.maintenanceMode = !settings.maintenanceMode;
            dataCache['txd_system_settings'] = settings;
            writeSystemSettingsLocal(settings);
            applyBrandingFromSystemSettings(settings);
            saveData('txd_system_settings', settings).catch(() => {});
            loadSettingsSection('geral');
            logSystemAction('Modo manutenção alterado', 'Sistema', { maintenanceMode: settings.maintenanceMode });
        }
        
        function saveAllSecuritySettings() {
            const sessionTimeout = parseInt(document.getElementById('sessionTimeout')?.value) || 30;
            const maxLoginAttempts = parseInt(document.getElementById('maxLoginAttempts')?.value) || 5;
            
            const settings = {
                sessionTimeout,
                maxLoginAttempts,
                autoLogout: document.getElementById('autoLogoutToggle')?.classList.contains('active'),
                requireTermsAcceptance: document.getElementById('termsToggle')?.classList.contains('active'),
                blockedIPs: getData('txd_security_settings')?.blockedIPs || []
            };
            
            saveData('txd_security_settings', settings);
            alert('Configurações de segurança salvas com sucesso!');
            logSystemAction('Configurações de segurança atualizadas', 'Segurança', settings);
        }
        
        function toggleAutoLogout() {
            const settings = getData('txd_security_settings') || {};
            settings.autoLogout = !settings.autoLogout;
            saveData('txd_security_settings', settings);
            loadSettingsSection('seguranca');
        }
        
        function toggleTermsRequirement() {
            const settings = getData('txd_security_settings') || {};
            settings.requireTermsAcceptance = !settings.requireTermsAcceptance;
            saveData('txd_security_settings', settings);
            loadSettingsSection('seguranca');
        }
        
        function unblockIP(ip) {
            const settings = getData('txd_security_settings') || {};
            if (settings.blockedIPs) {
                settings.blockedIPs = settings.blockedIPs.filter(blockedIP => blockedIP !== ip);
                saveData('txd_security_settings', settings);
                loadSettingsSection('seguranca');
                logSystemAction('IP desbloqueado', 'Segurança', { ip });
            }
        }
        
        function exportLogs() {
            const logsRaw = getData('txd_system_logs');
            const logs = Array.isArray(logsRaw) ? logsRaw : [];
            const dataStr = JSON.stringify(logs, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `txd_logs_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            logSystemAction('Logs exportados', 'Sistema', { count: logs.length });
        }
        
        function clearCache() {
            if (confirm('Tem certeza que deseja limpar o cache local? Isso não afetará os dados no Supabase.')) {
                Object.keys(dataCache).forEach(key => delete dataCache[key]);
                Object.keys(cacheTimestamps).forEach(key => delete cacheTimestamps[key]);
                alert('Cache limpo com sucesso!');
                logSystemAction('Cache limpo', 'Sistema', {});
            }
        }
        
        // ========== SISTEMA DE BACKUP E RESTORE ==========
        
        async function exportSystemData() {
            try {
                // Mostrar loading
                const loadingMsg = alert('Gerando backup completo... Isso pode levar alguns segundos.');
                
                // Buscar TODOS os dados do sistema (forçar refresh para garantir dados atualizados)
                const allData = {
                    metadata: {
                        version: '2.6.0',
                        exportDate: new Date().toISOString(),
                        exportedBy: currentUser.displayName || currentUser.name || 'Sistema',
                        exportedById: currentUser.id
                    },
                    staff: await getData('txd_staff', false) || [],
                    pendencias: await getData('txd_pendencias', false) || [],
                    events: await getData('txd_events', false) || [],
                    commands: await getData('txd_commands', false) || [],
                    commandUsage: await getData('txd_command_usage', false) || [],
                    favoriteCommands: await getData('txd_favorite_commands', false) || [],
                    areas: await getData('txd_areas', false) || [],
                    chatMessages: await getData('txd_chat_messages', false) || [],
                    chatGroups: await getData('txd_chat_groups', false) || [],
                    userAchievements: await getData('txd_user_achievements', false) || {},
                    announcements: await getData('txd_announcements', false) || [],
                    kanban: await getData('txd_kanban', false) || { columns: [], cards: [] },
                    warnings: await getData('txd_warnings', false) || [],
                    licenseRequests: await getData('txd_license_requests', false) || [],
                    registrationRequests: await getData('txd_registration_requests', false) || [],
                    systemLogs: await getData('txd_system_logs', false) || [],
                    systemSettings: await getData('txd_system_settings', false) || {},
                    securitySettings: await getData('txd_security_settings', false) || {},
                    discordConfig: await getData('txd_discord_config', false) || {}
                };
                
                // Calcular estatísticas do backup
                const stats = {
                    totalRecords: 0,
                    byType: {}
                };
                
                Object.keys(allData).forEach(key => {
                    if (key === 'metadata') return;
                    const data = allData[key];
                    if (Array.isArray(data)) {
                        stats.totalRecords += data.length;
                        stats.byType[key] = data.length;
                    } else if (typeof data === 'object' && data !== null) {
                        if (data.columns && data.cards) {
                            // Kanban
                            stats.byType[key] = {
                                columns: data.columns.length,
                                cards: data.cards.length
                            };
                            stats.totalRecords += data.columns.length + data.cards.length;
                        } else {
                            // Objeto simples
                            stats.byType[key] = Object.keys(data).length;
                            stats.totalRecords += Object.keys(data).length;
                        }
                    }
                });
                
                allData.metadata.stats = stats;
                
                // Converter para JSON
                const dataStr = JSON.stringify(allData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
                link.download = `txd_backup_completo_${timestamp}.json`;
                link.click();
                
                // Limpar URL
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                // Salvar histórico de backup
                const backupHistory = Array.isArray(backupHistoryMemory) ? [...backupHistoryMemory] : [];
                backupHistory.push({
                    date: new Date().toISOString(),
                    fileName: link.download,
                    stats: stats,
                    exportedBy: currentUser.displayName || currentUser.name
                });
                // Manter apenas últimos 10 backups no histórico
                if (backupHistory.length > 10) {
                    backupHistory.shift();
                }
                backupHistoryMemory = backupHistory;
                
                logSystemAction('Backup completo exportado', 'Sistema', {
                    totalRecords: stats.totalRecords,
                    byType: stats.byType
                });
                
                alert(`✅ Backup exportado com sucesso!\n\nTotal de registros: ${stats.totalRecords}\nArquivo: ${link.download}`);
                
            } catch (error) {
                console.error('Erro ao exportar backup:', error);
                alert(`Erro ao exportar backup: ${error.message || 'Erro desconhecido'}`);
            }
        }
        
        // Importar/Restaurar dados de backup
        async function importSystemData() {
            // Criar input de arquivo
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.style.display = 'none';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    // Ler arquivo
                    const text = await file.text();
                    const backupData = JSON.parse(text);
                    
                    // Validar estrutura do backup
                    if (!backupData.metadata) {
                        throw new Error('Arquivo de backup inválido: falta metadata');
                    }
                    
                    // Mostrar preview do backup
                    const stats = backupData.metadata.stats || {};
                    const confirmMsg = `Deseja restaurar este backup?\n\n` +
                        `Data do backup: ${new Date(backupData.metadata.exportDate).toLocaleString('pt-BR')}\n` +
                        `Exportado por: ${backupData.metadata.exportedBy || 'N/A'}\n` +
                        `Total de registros: ${stats.totalRecords || 0}\n\n` +
                        `⚠️ ATENÇÃO: Esta ação irá SOBRESCREVER os dados atuais!`;
                    
                    if (!confirm(confirmMsg)) {
                        return;
                    }
                    
                    if (!confirm('Esta ação é IRREVERSÍVEL. Tem certeza absoluta?')) {
                        return;
                    }
                    
                    // Mostrar opções de restauração
                    const restoreOptions = prompt(
                        'Escolha o que restaurar:\n\n' +
                        '1 = Tudo (restauração completa)\n' +
                        '2 = Apenas Staff\n' +
                        '3 = Apenas Tarefas e Pendencias\n' +
                        '4 = Apenas Eventos e Agenda\n' +
                        '5 = Apenas Configurações\n\n' +
                        'Digite o número da opção:'
                    );
                    
                    if (!restoreOptions) return;
                    
                    const option = parseInt(restoreOptions);
                    let restoredCount = 0;
                    const restoredTypes = [];
                    
                    // Restaurar dados baseado na opção
                    if (option === 1 || option === 2) {
                        // Staff
                        if (backupData.staff && Array.isArray(backupData.staff)) {
                            await saveData('txd_staff', backupData.staff);
                            restoredCount += backupData.staff.length;
                            restoredTypes.push('Staff');
                        }
                    }
                    
                    if (option === 1 || option === 3) {
                        // Pendencias
                        if (backupData.pendencias && Array.isArray(backupData.pendencias)) {
                            await saveData('txd_pendencias', backupData.pendencias);
                            restoredCount += backupData.pendencias.length;
                            restoredTypes.push('Pendencias');
                        }
                        
                        // Kanban
                        if (backupData.kanban) {
                            await saveData('txd_kanban', backupData.kanban);
                            restoredCount += (backupData.kanban.cards?.length || 0) + (backupData.kanban.columns?.length || 0);
                            restoredTypes.push('Tarefas');
                        }
                    }
                    
                    if (option === 1 || option === 4) {
                        // Events
                        if (backupData.events && Array.isArray(backupData.events)) {
                            await saveData('txd_events', backupData.events);
                            restoredCount += backupData.events.length;
                            restoredTypes.push('Eventos');
                        }
                    }
                    
                    if (option === 1 || option === 5) {
                        // Settings
                        if (backupData.systemSettings) {
                            await saveData('txd_system_settings', backupData.systemSettings);
                            restoredTypes.push('Configurações');
                        }
                        if (backupData.securitySettings) {
                            await saveData('txd_security_settings', backupData.securitySettings);
                            restoredTypes.push('Segurança');
                        }
                        if (backupData.discordConfig) {
                            await saveData('txd_discord_config', backupData.discordConfig);
                            restoredTypes.push('Discord');
                        }
                    }
                    
                    if (option === 1) {
                        // Restaurar tudo
                        const keyMap = {
                            'commands': 'txd_commands',
                            'commandUsage': 'txd_command_usage',
                            'favoriteCommands': 'txd_favorite_commands',
                            'areas': 'txd_areas',
                            'chatMessages': 'txd_chat_messages',
                            'chatGroups': 'txd_chat_groups',
                            'userAchievements': 'txd_user_achievements',
                            'announcements': 'txd_announcements',
                            'warnings': 'txd_warnings',
                            'licenseRequests': 'txd_license_requests',
                            'registrationRequests': 'txd_registration_requests',
                            'systemLogs': 'txd_system_logs'
                        };
                        
                        for (const [backupKey, txdKey] of Object.entries(keyMap)) {
                            if (backupData[backupKey]) {
                                await saveData(txdKey, backupData[backupKey]);
                                if (Array.isArray(backupData[backupKey])) {
                                    restoredCount += backupData[backupKey].length;
                                } else if (typeof backupData[backupKey] === 'object' && backupData[backupKey] !== null) {
                                    if (backupData[backupKey].cards && backupData[backupKey].columns) {
                                        restoredCount += (backupData[backupKey].cards.length || 0) + (backupData[backupKey].columns.length || 0);
                                    } else {
                                        restoredCount += Object.keys(backupData[backupKey]).length;
                                    }
                                }
                                restoredTypes.push(backupKey);
                            }
                        }
                    }
                    
                    // Limpar cache para forçar reload
                    Object.keys(dataCache).forEach(key => clearCacheKey(key));
                    
                    // Log da ação
                    logSystemAction('Backup restaurado', 'Sistema', {
                        backupDate: backupData.metadata.exportDate,
                        restoredTypes: restoredTypes,
                        restoredCount: restoredCount,
                        restoredBy: currentUser.name
                    });
                    
                    alert(`✅ Backup restaurado com sucesso!\n\nTipos restaurados: ${restoredTypes.join(', ')}\nTotal de registros: ${restoredCount}\n\nA página será recarregada.`);
                    
                    // Recarregar página após 2 segundos
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                    
                } catch (error) {
                    console.error('Erro ao importar backup:', error);
                    alert(`Erro ao importar backup: ${error.message || 'Erro desconhecido'}\n\nVerifique se o arquivo é um backup válido do TXD Staff System.`);
                }
                
                // Remover input
                document.body.removeChild(input);
            };
            
            document.body.appendChild(input);
            input.click();
        }
        
        // Ver histórico de backups
        function viewBackupHistory() {
            const history = Array.isArray(backupHistoryMemory) ? [...backupHistoryMemory] : [];
            
            if (history.length === 0) {
                alert('Nenhum backup encontrado no histórico.');
                return;
            }
            
            const historyList = history.reverse().map((backup, index) => {
                const date = new Date(backup.date).toLocaleString('pt-BR');
                return `${index + 1}. ${backup.fileName}\n   Data: ${date}\n   Por: ${backup.exportedBy}\n   Registros: ${backup.stats?.totalRecords || 0}\n`;
            }).join('\n');
            
            alert(`Histórico de Backups (últimos 10):\n\n${historyList}`);
        }
        
        function resetSystemSettings() {
            if (currentUser.role !== 'Owner') {
                alert('Apenas o Owner pode resetar as configurações do sistema.');
                return;
            }
            
            if (confirm('ATENÇÃO: Esta ação irá resetar TODAS as configurações do sistema. Tem certeza?')) {
                if (confirm('Esta ação é IRREVERSÍVEL. Confirme novamente.')) {
                    clearCacheKey('txd_system_settings');
                    clearCacheKey('txd_security_settings');
                    clearCacheKey('txd_discord_config');
                    alert('Configurações resetadas. A página será recarregada.');
                    logSystemAction('Configurações resetadas', 'Sistema', {});
                    location.reload();
                }
            }
        }
        
        function editRole(role) {
            const r = String(role || '').trim();
            if (!r) return;
            if (r === 'Owner' || r === 'CEO') {
                alert('Não é possível editar Owner/CEO.');
                return;
            }
            openRoleModal({ mode: 'edit', roleName: r });
        }
        
        function deleteRole(role) {
            const r = String(role || '').trim();
            if (!r) return;
            if (r === 'Owner' || r === 'CEO') {
                alert('Não é possível excluir Owner/CEO.');
                return;
            }
            if (confirm(`Tem certeza que deseja excluir o cargo "${r}"?`)) {
                delete ROLE_PERMISSIONS[r];
                saveRolePermissionsToLocal();
                loadSettingsSection('cargos');
                logSystemAction('Cargo excluído', 'Permissões', { role: r });
            }
        }
        
        function openNewRoleModal() {
            openRoleModal({ mode: 'create' });
        }

        const PERMISSION_CATALOG = [
            { key: 'dashboard', label: 'Dashboard', desc: 'Acesso a tarefas/estatísticas gerais.' },
            { key: 'pendencias', label: 'Pendências (completo)', desc: 'Criar/visualizar/gerenciar pendências.' },
            { key: 'pendencias_basico', label: 'Pendências (básico)', desc: 'Criar e acompanhar suas pendências.' },
            { key: 'moderacao', label: 'Moderação', desc: 'Advertências e recursos de moderação.' },
            { key: 'comandos', label: 'Comandos', desc: 'Gerenciar catálogo de comandos.' },
            { key: 'area', label: 'Áreas', desc: 'Gerenciar áreas de responsabilidade.' },
            { key: 'staff', label: 'Controle de staff', desc: 'Gerenciar membros/contas da staff.' },
            { key: 'staff_area', label: 'Staff (área)', desc: 'Acesso parcial para área.' },
            { key: 'relatorios', label: 'Relatórios', desc: 'Acesso à aba de relatórios.' },
            { key: 'sistema', label: 'Sistema/Config', desc: 'Acesso às configurações do sistema.' },
            { key: 'dev_area', label: 'Área DEV', desc: 'Acesso à aba DEV (backlog).' },
            { key: 'chat', label: 'Chat', desc: 'Acesso ao chat interno (se habilitado).' }
        ];

        function renderPermissionsGrid(selected) {
            const set = new Set((Array.isArray(selected) ? selected : []).map(p => String(p).trim()).filter(Boolean));
            const hasAll = set.has('*');
            const grid = document.getElementById('permissionsGrid');
            if (!grid) return;
            grid.innerHTML = PERMISSION_CATALOG.map(p => {
                const checked = hasAll ? false : set.has(p.key);
                const disabled = hasAll ? 'disabled' : '';
                return `
                    <label style="display:flex; gap: 10px; align-items:flex-start; background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 12px; padding: 12px; cursor: pointer;">
                        <input type="checkbox" class="perm-checkbox" value="${escapeHtml(p.key)}" ${checked ? 'checked' : ''} ${disabled} style="width: 18px; height: 18px; margin-top: 2px;">
                        <div style="flex:1;">
                            <div style="color: var(--white-soft); font-weight: 800; font-size: 13px;">${escapeHtml(p.label)} <span style="color: var(--gray-text); font-weight: 700;">(${escapeHtml(p.key)})</span></div>
                            <div style="color: var(--gray-light); font-size: 12px; margin-top: 4px; line-height: 1.4;">${escapeHtml(p.desc)}</div>
                        </div>
                    </label>
                `;
            }).join('');

            const toggle = document.getElementById('permAllToggle');
            if (toggle) toggle.checked = hasAll;
        }

        function toggleAllPermissions(checked) {
            const grid = document.getElementById('permissionsGrid');
            if (!grid) return;
            grid.querySelectorAll('input.perm-checkbox').forEach(cb => {
                cb.disabled = !!checked;
                if (checked) cb.checked = false;
            });
        }

        function openRoleModal({ mode, roleName } = {}) {
            const m = String(mode || 'create');
            const modal = document.getElementById('roleModal');
            if (!modal) return;
            const title = document.getElementById('roleModalTitle');
            const modeEl = document.getElementById('roleModalMode');
            const origEl = document.getElementById('roleModalOriginalName');
            const nameInput = document.getElementById('roleNameInput');

            const editing = m === 'edit';
            const r = editing ? String(roleName || '').trim() : '';
            const perms = editing ? (getUserPermissions(r) || []) : [];

            if (title) title.textContent = editing ? `Editar Cargo: ${r}` : 'Novo Cargo';
            if (modeEl) modeEl.value = editing ? 'edit' : 'create';
            if (origEl) origEl.value = r;
            if (nameInput) {
                nameInput.value = editing ? r : '';
                nameInput.disabled = editing; // renomear cargo pode quebrar dados existentes
            }

            renderPermissionsGrid(perms);
            modal.classList.add('active');
        }

        function collectSelectedPermissions() {
            const all = document.getElementById('permAllToggle')?.checked === true;
            if (all) return ['*'];
            const grid = document.getElementById('permissionsGrid');
            if (!grid) return [];
            const perms = Array.from(grid.querySelectorAll('input.perm-checkbox'))
                .filter(cb => cb && cb.checked)
                .map(cb => cb.value)
                .map(v => String(v).trim())
                .filter(Boolean);
            // manter dev_area opcional, e remover duplicados
            return Array.from(new Set(perms));
        }

        function saveRoleFromModal(event) {
            event.preventDefault();
            if (!hasPermission('permission.manage') && currentUser.role !== 'Owner' && currentUser.role !== 'CEO') {
                alert('Sem permissão para alterar cargos.');
                return;
            }
            const mode = document.getElementById('roleModalMode')?.value || 'create';
            const original = document.getElementById('roleModalOriginalName')?.value || '';
            const nameInput = document.getElementById('roleNameInput');
            const roleName = (nameInput?.value || '').toString().trim();
            const perms = collectSelectedPermissions();

            if (!roleName) {
                alert('Informe o nome do cargo.');
                return;
            }
            if (roleName === 'Owner' || roleName === 'CEO') {
                alert('Owner/CEO não podem ser alterados.');
                return;
            }
            if (mode === 'create') {
                if (ROLE_PERMISSIONS[roleName]) {
                    alert('Este cargo já existe.');
                    return;
                }
                createRole(roleName, perms);
            } else {
                updateRolePermissions(original || roleName, perms);
            }

            saveRolePermissionsToLocal();
            closeModal('roleModal');
            loadSettingsSection('cargos');
        }

        // ========== FUNÇÕES DE INTEGRAÇÃO DISCORD ==========
        async function toggleDiscordIntegration() {
            try {
                console.log('Toggle Discord - Estado antes:', discordConfig.enabled);
                
                // Recarregar config para garantir sincronização
                discordConfig = getDiscordConfig();
                
                // Atualizar estado
                discordConfig.enabled = !discordConfig.enabled;
                
                console.log('Toggle Discord - Estado depois:', discordConfig.enabled);
                
                // Salvar no Supabase e aguardar conclusão
                const saved = await saveDiscordConfig();
                
                if (!saved) {
                    alert('Erro ao salvar configuração. Tente novamente.');
                    return;
                }
                
                console.log('Toggle Discord - Salvo no Supabase');
                console.log('Toggle Discord - Config completa:', discordConfig);
                
                // Atualizar toggle visual IMEDIATAMENTE
                const toggleElement = document.getElementById('discordToggle');
                if (toggleElement) {
                    if (discordConfig.enabled) {
                        toggleElement.classList.add('active');
                    } else {
                        toggleElement.classList.remove('active');
                    }
                    console.log('Toggle Discord - Elemento toggle atualizado:', toggleElement.className);
                }
                
                // Atualizar badge de status
                const statusBadge = document.getElementById('discordStatusBadge');
                if (statusBadge) {
                    statusBadge.className = `discord-status ${discordConfig.enabled ? 'active' : 'inactive'}`;
                    statusBadge.innerHTML = `
                        <i class="fas fa-circle"></i>
                        ${discordConfig.enabled ? 'Ativo' : 'Inativo'}
                    `;
                    console.log('Toggle Discord - Badge atualizado:', discordConfig.enabled ? 'Ativo' : 'Inativo');
                }
                
                // Mostrar feedback visual
                const statusText = discordConfig.enabled ? 'ativada' : 'desativada';
                const tempNotif = document.createElement('div');
                tempNotif.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${discordConfig.enabled ? '#10b981' : '#6b7280'};
                    color: white;
                    padding: 16px 24px;
                    border-radius: 8px;
                    font-weight: 600;
                    font-size: 15px;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    animation: slideInRight 0.3s ease-out;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                `;
                tempNotif.innerHTML = `
                    <i class="fas fa-${discordConfig.enabled ? 'check-circle' : 'times-circle'}" style="font-size: 18px;"></i>
                    <span>Integração Discord ${statusText}!</span>
                `;
                document.body.appendChild(tempNotif);
                
                setTimeout(() => {
                    tempNotif.style.animation = 'slideOutRight 0.3s ease-out';
                    setTimeout(() => tempNotif.remove(), 300);
                }, 2500);
                
                // Recarregar configurações DEPOIS para não perder o foco
                console.log('Toggle Discord - Recarregando configurações...');
                setTimeout(async () => {
                    // Aguardar um pouco para garantir que o saveData foi processado
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    // Recarregar config antes de recarregar a página
                    discordConfig = getDiscordConfig();
                    console.log('Toggle Discord - Config recarregada antes de atualizar UI:', discordConfig);
                    
                    // Atualizar apenas a aba Discord, não toda a página
                    if (activeSettingsTab === 'discord') {
                        loadSettingsSection('discord');
                    }
                    console.log('Toggle Discord - Configurações recarregadas!');
                }, 500);
                
            } catch (error) {
                console.error('Erro ao ativar/desativar Discord:', error);
                alert('❌ Erro ao ativar/desativar integração Discord: ' + error.message);
            }
        }

        async function toggleNotification(type) {
            // Buscar config mais recente
            discordConfig = getDiscordConfig();
            discordConfig.notifications[type] = !discordConfig.notifications[type];
            await saveDiscordConfig();
            loadSettingsSection('discord');
        }

        async function saveWebhook(type, value) {
            // Buscar config mais recente
            discordConfig = getDiscordConfig();
            discordConfig.webhooks[type] = value;
            await saveDiscordConfig();
            
            // Feedback visual
            const btn = event?.target?.closest('.webhook-btn');
            if (btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Salvo!';
                btn.style.background = 'var(--success)';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
            }
        }

        async function saveDiscordConfig() {
            try {
            console.log('saveDiscordConfig() - Salvando:', discordConfig);
                await saveData('txd_discord_config', discordConfig);
                
                // Aguardar um pouco para garantir que o cache foi atualizado
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Atualizar variável global para manter sincronização
                discordConfig = getDiscordConfig();
            
            // Verificar se salvou corretamente
            const saved = getData('txd_discord_config');
            console.log('saveDiscordConfig() - Verificação:', saved);
                console.log('saveDiscordConfig() - Variável global atualizada:', discordConfig);
                
                return true;
            } catch (error) {
                console.error('Erro ao salvar configuração Discord:', error);
                return false;
            }
        }

        function testWebhook(type) {
            // Buscar configuração mais recente
            const currentConfig = getDiscordConfig();
            const webhookUrl = currentConfig.webhooks[type];
            
            if (!webhookUrl || webhookUrl.trim() === '') {
                alert('⚠️ Configure o webhook antes de testar!\n\n1. Vá até o Discord\n2. Crie um webhook no canal desejado\n3. Cole a URL aqui');
                return;
            }
            
            // Validar formato da URL
            if (!webhookUrl.startsWith('https://discord.com/api/webhooks/')) {
                alert('❌ URL do webhook inválida!\n\nA URL deve começar com: https://discord.com/api/webhooks/');
                return;
            }
            
            console.log('🧪 Testando webhook:', type, webhookUrl.substring(0, 50) + '...');
            
            const embed = {
                title: '✅ Teste de Webhook',
                description: `Este é um teste do webhook ${type === 'main' ? 'principal' : `de ${type}`}. Se você está vendo esta mensagem, a integração está funcionando! 🎉`,
                color: 5814783, // Cor verde
                fields: [
                    {
                        name: '📅 Data',
                        value: new Date().toLocaleDateString('pt-BR'),
                        inline: true
                    },
                    {
                        name: '🕒 Hora',
                        value: new Date().toLocaleTimeString('pt-BR'),
                        inline: true
                    },
                    {
                        name: '👤 Testado por',
                        value: currentUser?.displayName || currentUser?.name || 'Usuário',
                        inline: true
                    },
                    {
                        name: '🔗 Tipo de Webhook',
                        value: type === 'main' ? 'Principal' : type.charAt(0).toUpperCase() + type.slice(1),
                        inline: false
                    }
                ],
                footer: {
                    text: 'TXD Staff System - Teste de Integração'
                },
                timestamp: new Date().toISOString()
            };
            
            sendDiscordWebhook(webhookUrl, {
                username: 'TXD Staff Bot',
                avatar_url: 'https://i.imgur.com/4M34hi2.png',
                embeds: [embed]
            });
            
            // Feedback visual
            setTimeout(() => {
                alert('✅ Mensagem de teste enviada!\n\nVerifique o canal do Discord para confirmar o recebimento.');
            }, 1000);
        }
        
        // Função de diagnóstico da integração Discord
        function diagnoseDiscordIntegration() {
            const config = getDiscordConfig();
            const diagnostics = {
                enabled: config.enabled,
                hasMainWebhook: !!(config.webhooks?.main && config.webhooks.main.trim() !== ''),
                hasPendenciasWebhook: !!(config.webhooks?.pendencias && config.webhooks.pendencias.trim() !== ''),
                hasEventsWebhook: !!(config.webhooks?.events && config.webhooks.events.trim() !== ''),
                hasLogsWebhook: !!(config.webhooks?.logs && config.webhooks.logs.trim() !== ''),
                notificationsEnabled: {
                    chat: config.notifications?.chat || false,
                    tasks: config.notifications?.tasks || false,
                    pendencias: config.notifications?.pendencias || false,
                    events: config.notifications?.events || false,
                    achievements: config.notifications?.achievements || false,
                    staff: config.notifications?.staff || false
                }
            };
            
            console.log('🔍 Diagnóstico da Integração Discord:', diagnostics);
            
            let message = '🔍 DIAGNÓSTICO DA INTEGRAÇÃO DISCORD\n\n';
            message += `Status: ${diagnostics.enabled ? '✅ ATIVO' : '❌ INATIVO'}\n\n`;
            message += 'Webhooks Configurados:\n';
            message += `  • Principal: ${diagnostics.hasMainWebhook ? '✅' : '❌'}\n`;
            message += `  • Pendencias: ${diagnostics.hasPendenciasWebhook ? '✅' : '❌'}\n`;
            message += `  • Eventos: ${diagnostics.hasEventsWebhook ? '✅' : '❌'}\n`;
            message += `  • Logs: ${diagnostics.hasLogsWebhook ? '✅' : '❌'}\n\n`;
            message += 'Notificações Ativas:\n';
            Object.keys(diagnostics.notificationsEnabled).forEach(key => {
                const status = diagnostics.notificationsEnabled[key] ? '✅' : '❌';
                message += `  • ${key}: ${status}\n`;
            });
            
            if (!diagnostics.enabled) {
                message += '\n⚠️ A integração está DESATIVADA. Ative no painel de configurações.';
            } else if (!diagnostics.hasMainWebhook) {
                message += '\n⚠️ Webhook principal não configurado. Configure um webhook para receber notificações.';
            } else {
                message += '\n✅ Configuração parece correta!';
            }
            
            alert(message);
            return diagnostics;
        }

        function sendDiscordWebhook(webhookUrl, data) {
            // Validar e sanitizar dados antes de enviar
            try {
                // Validar webhook URL
                if (!webhookUrl || typeof webhookUrl !== 'string' || !webhookUrl.startsWith('https://discord.com/api/webhooks/')) {
                    console.error('Webhook URL inválida:', webhookUrl);
                    return;
                }
                
                // Sanitizar dados
                const sanitizedData = {
                    username: (data.username || 'TXD Staff Bot').substring(0, 80), // Max 80 chars
                    avatar_url: data.avatar_url || 'https://i.imgur.com/4M34hi2.png',
                    embeds: (data.embeds || []).map(embed => {
                        // Limites do Discord:
                        // title: 256 chars
                        // description: 4096 chars
                        // field name: 256 chars
                        // field value: 1024 chars
                        // total embed: 6000 chars
                        
                        const sanitizedEmbed = {
                            color: embed.color || 5814783,
                            fields: (embed.fields || []).slice(0, 25).map(field => ({
                                name: field.name ? String(field.name).substring(0, 256) : '\u200b', // Zero-width space se vazio
                                value: field.value ? String(field.value).substring(0, 1024) : '\u200b',
                                inline: field.inline === true || field.inline === false ? field.inline : false
                            })),
                            footer: {
                                text: String(embed.footer?.text || 'TXD Staff System').substring(0, 2048)
                            },
                            timestamp: embed.timestamp || new Date().toISOString()
                        };
                        
                        // Adicionar title apenas se existir e não for vazio
                        if (embed.title && String(embed.title).trim() !== '') {
                            sanitizedEmbed.title = String(embed.title).substring(0, 256);
                        }
                        
                        // Adicionar description apenas se existir e não for vazio
                        if (embed.description && String(embed.description).trim() !== '') {
                            sanitizedEmbed.description = String(embed.description).substring(0, 4096);
                        }
                        
                        // Garantir que pelo menos title OU description exista
                        if (!sanitizedEmbed.title && !sanitizedEmbed.description) {
                            sanitizedEmbed.title = 'Notificação do Sistema';
                        }
                        
                        return sanitizedEmbed;
                    })
                };
                
                // Remover campos vazios
                if (!sanitizedData.embeds || sanitizedData.embeds.length === 0) {
                    console.error('Nenhum embed válido para enviar');
                    return;
                }
                
                console.log('Enviando para Discord:', {
                    url: webhookUrl.substring(0, 50) + '...',
                    embedTitle: sanitizedData.embeds[0]?.title,
                    embedDescription: sanitizedData.embeds[0]?.description?.substring(0, 50) + '...'
                });
                
                fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(sanitizedData)
                })
                .then(response => {
                    if (response.ok) {
                        console.log('✅ Mensagem enviada com sucesso para o Discord!');
                        return response.json();
                    } else {
                        // Tentar ler resposta de erro
                        return response.text().then(text => {
                            console.error('❌ Erro ao enviar mensagem Discord:', {
                                status: response.status,
                                statusText: response.statusText,
                                body: text
                            });
                            throw new Error(`Discord retornou erro ${response.status}: ${text}`);
                        });
                    }
                })
                .then(data => {
                    if (data) {
                        console.log('✅ Resposta do Discord:', data);
                    }
                })
                .catch(error => {
                    console.error('❌ Erro ao conectar com Discord:', {
                        message: error.message,
                        stack: error.stack
                    });
                });
            } catch (error) {
                console.error('❌ Erro ao processar dados do Discord:', error);
            }
        }

        function sendDiscordNotification(type, title, description, fields = []) {
            try {
                // Sempre buscar a configuração mais recente
                const currentConfig = getDiscordConfig();
                
                if (!currentConfig || !currentConfig.enabled) {
                    // Discord desabilitado - não fazer nada, não logar
                    return;
                }
                
                if (!currentConfig.notifications || !currentConfig.notifications[type]) {
                    // Tipo de notificação desabilitado - não fazer nada, não logar
                    return;
                }
                
                let webhookUrl = currentConfig.webhooks.main;
                
                // Usar webhook específico se configurado
                if (type === 'pendencias' && currentConfig.webhooks.pendencias) {
                    webhookUrl = currentConfig.webhooks.pendencias;
                } else if (type === 'events' && currentConfig.webhooks.events) {
                    webhookUrl = currentConfig.webhooks.events;
                } else if (type === 'logs' && currentConfig.webhooks.logs) {
                    webhookUrl = currentConfig.webhooks.logs;
                }
                
                if (!webhookUrl || webhookUrl.trim() === '') {
                    console.log('Webhook URL não configurada para o tipo:', type);
                    return;
                }
                
                console.log('Enviando notificação Discord:', { type, title, webhookUrl: webhookUrl.substring(0, 50) + '...' });
                
                const colors = {
                    chat: 5793266, // Azul
                    tasks: 5814783, // Verde
                    pendencias: 16776960, // Amarelo
                    events: 10181046, // Roxo
                    achievements: 16763904, // Laranja
                    staff: 15277667 // Vermelho claro
                };
                
                // Sanitizar campos - garantir que não sejam undefined/null
                const sanitizedFields = (fields || []).map(field => ({
                    name: field.name ? String(field.name) : 'Campo',
                    value: field.value ? String(field.value) : 'N/A',
                    inline: field.inline === true || field.inline === false ? field.inline : false
                }));
                
                const embed = {
                    title: title ? String(title) : 'Notificação',
                    description: description ? String(description) : 'Ação realizada no sistema',
                    color: colors[type] || 5814783,
                    fields: sanitizedFields,
                    footer: {
                        text: 'TXD Staff System'
                    },
                    timestamp: new Date().toISOString()
                };
                
                sendDiscordWebhook(webhookUrl, {
                    username: 'TXD Staff Bot',
                    avatar_url: 'https://i.imgur.com/4M34hi2.png',
                    embeds: [embed]
                });
            } catch (error) {
                console.error('Erro ao enviar notificação Discord:', error);
            }
        }

        // ========== COMANDOS DO DISCORD PARA O SISTEMA ==========
        
        function toggleDiscordCommands() {
            discordConfig = getDiscordConfig();
            discordConfig.commandsEnabled = !discordConfig.commandsEnabled;
            saveDiscordConfig();
            loadSettings();
        }
        
        function saveDiscordCommandsWebhook(url) {
            discordConfig = getDiscordConfig();
            discordConfig.commandsWebhook = url;
            saveDiscordConfig();
        }
        
        function loadDiscordCommandsLog() {
            const logsRaw = getData('txd_discord_commands_log');
            const logs = Array.isArray(logsRaw) ? logsRaw : [];
            if (logs.length === 0) {
                return '<div style="color: var(--gray-text); font-style: italic;">Nenhum comando recebido ainda.</div>';
            }
            return logs.slice(-10).reverse().map(log => {
                const time = new Date(log.timestamp).toLocaleString('pt-BR');
                const status = log.success ? '✅' : '❌';
                return `<div style="margin-bottom: 8px; padding: 8px; background: var(--gray-dark); border-radius: 4px; border-left: 3px solid ${log.success ? 'var(--success)' : 'var(--danger)'};">
                    ${status} <strong>${log.command}</strong> - ${log.message}<br>
                    <span style="color: var(--gray-text); font-size: 10px;">${time}</span>
                </div>`;
            }).join('');
        }
        
        function clearDiscordCommandsLog() {
            if (confirm('Deseja limpar o log de comandos?')) {
                saveData('txd_discord_commands_log', []);
                loadSettings();
            }
        }
        
        function addDiscordCommandLog(command, message, success = true) {
            const logs = getData('txd_discord_commands_log') || [];
            logs.push({
                command: command,
                message: message,
                success: success,
                timestamp: new Date().toISOString()
            });
            // Manter apenas últimos 50 logs
            if (logs.length > 50) {
                logs.shift();
            }
            saveData('txd_discord_commands_log', logs);
        }
        
        function processDiscordCommand(commandText, authorName = 'Discord') {
            try {
                if (!discordConfig || !discordConfig.commandsEnabled) {
                    return { success: false, message: 'Comandos do Discord estão desativados' };
                }
                
                const parts = commandText.trim().split(/\s+/);
                const command = parts[0].toLowerCase();
                const args = parts.slice(1);
                
                console.log('Processando comando Discord:', command, args);
                
                switch (command) {
                    case '!tarefa':
                    case '!task':
                        return processTaskCommand(args, authorName);
                    
                    case '!evento':
                    case '!event':
                        return processEventCommand(args, authorName);
                    
                    case '!staff':
                        return processStaffCommand(args, authorName);
                    
                    case '!status':
                        return processStatusCommand(args, authorName);
                    
                    default:
                        return { success: false, message: `Comando desconhecido: ${command}. Use !tarefa, !evento, !staff ou !status` };
                }
            } catch (error) {
                console.error('Erro ao processar comando:', error);
                return { success: false, message: 'Erro ao processar comando: ' + error.message };
            }
        }
        
        function processTaskCommand(args, authorName) {
            if (args.length < 2 || args[0] !== 'criar') {
                return { success: false, message: 'Uso: !tarefa criar "Título" | descrição | prioridade | responsável' };
            }
            
            // Parse: criar "Título" | descrição | prioridade | responsável
            const text = args.slice(1).join(' ');
            const parts = text.split('|').map(p => p.trim());
            
            if (parts.length < 1) {
                return { success: false, message: 'Título é obrigatório' };
            }
            
            const title = parts[0].replace(/^"|"$/g, ''); // Remove aspas
            const description = parts[1] || '';
            const priority = parts[2] || 'medium';
            const assignee = parts[3] || authorName;
            
            // Criar tarefa
            let kanbanData = getKanbanData();
            const newCard = {
                id: Date.now(),
                columnId: 'todo',
                title: title,
                description: description,
                priority: priority.toLowerCase(),
                dueDate: '',
                assignee: assignee,
                tags: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            kanbanData.cards.push(newCard);
            saveKanbanData(kanbanData);
            
            // Recarregar Kanban se estiver na página
            if (document.getElementById('sectionTitle')?.textContent.includes('Tarefas')) {
                loadKanban();
            }
            
            addDiscordCommandLog('!tarefa', `Tarefa "${title}" criada com sucesso`, true);
            
            return { success: true, message: `Tarefa "${title}" criada com sucesso!` };
        }
        
        function processEventCommand(args, authorName) {
            if (args.length < 2 || args[0] !== 'criar') {
                return { success: false, message: 'Uso: !evento criar "Título" | data | hora | local' };
            }
            
            const text = args.slice(1).join(' ');
            const parts = text.split('|').map(p => p.trim());
            
            if (parts.length < 1) {
                return { success: false, message: 'Título é obrigatório' };
            }
            
            const title = parts[0].replace(/^"|"$/g, '');
            const date = parts[1] || new Date().toISOString().split('T')[0];
            const time = parts[2] || '18:00';
            const location = parts[3] || 'Discord';
            
            const newEvent = {
                id: Date.now(),
                title: title,
                description: `Evento criado via Discord por ${authorName}`,
                date: date,
                time: time,
                location: location,
                createdBy: authorName,
                createdAt: new Date().toISOString()
            };
            
            eventsData.push(newEvent);
            saveData('txd_events', eventsData);
            
            if (document.getElementById('sectionTitle')?.textContent.includes('Agenda')) {
                loadAgenda();
            }
            
            addDiscordCommandLog('!evento', `Evento "${title}" criado com sucesso`, true);
            
            return { success: true, message: `Evento "${title}" criado com sucesso!` };
        }
        
        function processStaffCommand(args, authorName) {
            if (args.length < 2 || args[0] !== 'adicionar') {
                return { success: false, message: 'Uso: !staff adicionar "Nome" | cargo | área' };
            }
            
            const text = args.slice(1).join(' ');
            const parts = text.split('|').map(p => p.trim());
            
            if (parts.length < 1) {
                return { success: false, message: 'Nome é obrigatório' };
            }
            
            const name = parts[0].replace(/^"|"$/g, '');
            const role = parts[1] || 'Staff';
            const area = parts[2] || 'Geral';
            
            const newStaff = {
                id: Date.now(),
                name: name,
                role: role,
                area: area,
                status: 'Ativo',
                email: ''
            };
            
            staffData.push(newStaff);
            saveData('txd_staff', staffData);
            
            if (document.getElementById('sectionTitle')?.textContent.includes('Staff')) {
                loadStaffControl();
            }
            
            addDiscordCommandLog('!staff', `Staff "${name}" adicionado com sucesso`, true);
            
            return { success: true, message: `Staff "${name}" adicionado com sucesso!` };
        }
        
        function processStatusCommand(args, authorName) {
            if (args.length < 2) {
                return { success: false, message: 'Uso: !status tarefa ID | nova-coluna (ex: todo, inprogress, review, done)' };
            }
            
            const taskId = parseInt(args[0]);
            const newColumn = args[1];
            
            if (isNaN(taskId)) {
                return { success: false, message: 'ID da tarefa deve ser um número' };
            }
            
            const validColumns = ['todo', 'inprogress', 'review', 'done'];
            if (!validColumns.includes(newColumn)) {
                return { success: false, message: `Coluna inválida. Use: ${validColumns.join(', ')}` };
            }
            
            if (!state.kanban.initialized) {
                ensureKanbanLoaded(true).catch(err => console.error('[kanban] Falha ao inicializar via comando:', err));
                return { success: false, message: 'Kanban ainda não carregado. Abra a seção Tarefas e tente novamente em alguns segundos.' };
            }

            const card = state.kanban.cardsById.get(String(taskId));
            
            if (!card) {
                return { success: false, message: `Tarefa com ID ${taskId} não encontrada` };
            }

            updateKanbanCardColumn(taskId, newColumn)
                .then(() => {
                    if (document.getElementById('sectionTitle')?.textContent.includes('Tarefas')) {
                        renderTarefas();
                    }
                })
                .catch(err => console.error('[kanban] Erro ao mover tarefa via comando !status:', err));
            
            addDiscordCommandLog('!status', `Tarefa ${taskId} movida para ${newColumn}`, true);
            
            return { success: true, message: `Tarefa ${taskId} movida para ${newColumn}!` };
        }
        
        function testDiscordCommand() {
            const testCommand = '!tarefa criar "Teste do Discord" | Descrição de teste | high | Sistema';
            const result = processDiscordCommand(testCommand, 'Sistema');
            
            if (result.success) {
                alert('✅ Comando testado com sucesso!\n\n' + result.message);
            } else {
                alert('❌ Erro ao testar comando:\n\n' + result.message);
            }
            
            loadSettings(); // Recarregar para atualizar log
        }
        
        function showDiscordCommandsHelp() {
            const helpText = `
📖 COMO CONFIGURAR COMANDOS DO DISCORD

OPÇÃO 1: Bot do Discord (Recomendado)
1. Crie um bot no Discord Developer Portal
2. Adicione o bot ao seu servidor
3. Configure o bot para escutar mensagens
4. Quando alguém digitar um comando, o bot deve:
   - Processar o comando
   - Chamar a função processDiscordCommand()
   - Ou enviar para um webhook reverso

OPÇÃO 2: Webhook Reverso
1. Configure um servidor que recebe webhooks do Discord
2. Quando receber mensagem com comando, processe
3. Envie resultado de volta para o Discord

COMANDOS DISPONÍVEIS:

!tarefa criar "Título" | descrição | prioridade | responsável
  Exemplo: !tarefa criar "Revisar código" | Revisar PR #123 | high | João

!evento criar "Título" | data | hora | local
  Exemplo: !evento criar "Reunião" | 2026-01-15 | 18:00 | Discord

!staff adicionar "Nome" | cargo | área
  Exemplo: !staff adicionar "Maria" | Moderador | Suporte

!status tarefa-ID | nova-coluna
  Exemplo: !status 1234567890 | inprogress
  Colunas: todo, inprogress, review, done

NOTA: Este sistema funciona localmente. Para usar com bot real,
você precisa de um servidor intermediário ou usar a função
processDiscordCommand() diretamente.
            `;
            
            alert(helpText);
        }
        
        // Verificar comandos periodicamente (simulação)
        // Em produção, isso seria feito por um bot do Discord
        setInterval(() => {
            if (discordConfig && discordConfig.commandsEnabled) {
                // Aqui você pode adicionar lógica para verificar comandos
                // Por exemplo, verificar um endpoint ou Supabase em tempo real
            }
        }, 5000); // Verifica a cada 5 segundos

        // ========== FUNÇÕES DE MODAIS ==========
        function openNewEvent() {
            if (!hasPermission('event.create')) {
                alert('Você não tem permissão para criar eventos.');
                return;
            }
            document.getElementById('eventId').value = '';
            document.getElementById('eventModalTitle').textContent = 'Novo Evento';
            document.getElementById('eventForm').reset();
            document.getElementById('eventModal').classList.add('active');
        }

        function openEditEvent(id) {
            if (!hasPermission('event.edit')) {
                alert('Você não tem permissão para editar eventos.');
                return;
            }
            // Garantir que eventsData é um array
            if (!Array.isArray(eventsData)) eventsData = [];
            const event = eventsData.find(e => e.id === id);
            if (event) {
                const existingDate = (event.eventDate || event.event_date || '').toString();
                const existingTime = (event.eventTime || event.event_time || '').toString();
                const fallbackDateTime = existingDate
                    ? `${existingDate}T${(existingTime || '18:00').toString().trim().slice(0, 5)}`
                    : '';
                document.getElementById('eventId').value = event.id;
                document.getElementById('eventModalTitle').textContent = 'Editar Evento';
                document.getElementById('eventType').value = event.type;
                document.getElementById('eventTitle').value = event.title;
                document.getElementById('eventDateTime').value = event.datetime || fallbackDateTime;
                document.getElementById('eventDescription').value = event.description || '';
                document.getElementById('eventModal').classList.add('active');
            }
        }

        function extractDateTimeParts(datetimeLocal) {
            const raw = (datetimeLocal || '').toString().trim();
            if (!raw || !raw.includes('T')) return { date: '', time: '' };
            const [datePart, timePartRaw] = raw.split('T');
            const timePart = (timePartRaw || '').toString().trim().slice(0, 5);
            return { date: datePart || '', time: timePart || '' };
        }

        function getEventDateString(evt) {
            const v = (evt?.eventDate || evt?.event_date || evt?.date || '').toString().trim();
            if (v) return v;
            const dt = (evt?.datetime || '').toString().trim();
            return extractDateTimeParts(dt).date || '';
        }

        function getEventDateObject(evt) {
            const dateStr = getEventDateString(evt);
            if (dateStr && /^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return new Date(`${dateStr}T00:00`);
            }
            const dt = (evt?.datetime || '').toString().trim();
            if (dt) return new Date(dt);
            return new Date(0);
        }

        function getEventTimeString(evt) {
            const v = (evt?.eventTime || evt?.event_time || evt?.time || '').toString().trim();
            if (v) return v.slice(0, 5);
            const dt = (evt?.datetime || '').toString().trim();
            return extractDateTimeParts(dt).time || '';
        }

        function saveEvent(event) {
            event.preventDefault();
            if (!hasPermission('event.create') && !hasPermission('event.edit')) {
                alert('Você não tem permissão para esta ação.');
                return;
            }

            // Garantir que eventsData é um array
            if (!Array.isArray(eventsData)) eventsData = [];
            const dateTimeValue = document.getElementById('eventDateTime').value;
            const { date: eventDate, time: eventTime } = extractDateTimeParts(dateTimeValue);
            
            const eventData = {
                id: document.getElementById('eventId').value || Date.now(),
                type: document.getElementById('eventType').value,
                title: document.getElementById('eventTitle').value,
                datetime: dateTimeValue,
                eventDate: eventDate,
                eventTime: eventTime,
                description: document.getElementById('eventDescription').value,
                createdAt: new Date().toISOString()
            };

            if (eventData.id && eventsData.find(e => e.id == eventData.id)) {
                // Editar
                const index = eventsData.findIndex(e => e.id == eventData.id);
                eventsData[index] = eventData;
            } else {
                // Novo
                eventsData.push(eventData);
            }

            // Atualizar cache imediatamente (evita UI "perder" eventos por stale-while-revalidate)
            dataCache['txd_events'] = eventsData;
            cacheTimestamps['txd_events'] = Date.now();

            saveData('txd_events', eventsData);
            
            // Notificar Discord
            if (eventData.id && eventsData.find(e => e.id == eventData.id)) {
                // Evento editado
                sendDiscordNotification('events', '📝 Evento Atualizado', `O evento "${eventData.title}" foi atualizado`, [
                    { name: '📅 Data', value: new Date(eventData.datetime).toLocaleDateString('pt-BR'), inline: true },
                    { name: '🕒 Hora', value: (getEventTimeString(eventData) || new Date(eventData.datetime).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})), inline: true },
                    { name: '📝 Tipo', value: eventData.type === 'event' ? 'Evento' : eventData.type === 'meeting' ? 'Reunião' : 'Treinamento', inline: true }
                ]);
            } else {
                // Evento novo
                sendDiscordNotification('events', '🎉 Novo Evento Criado', `"${eventData.title}" foi agendado!`, [
                    { name: '📅 Data', value: new Date(eventData.datetime).toLocaleDateString('pt-BR'), inline: true },
                    { name: '🕒 Hora', value: (getEventTimeString(eventData) || new Date(eventData.datetime).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})), inline: true },
                    { name: '📝 Tipo', value: eventData.type === 'event' ? 'Evento' : eventData.type === 'meeting' ? 'Reunião' : 'Treinamento', inline: true },
                    { name: '👤 Criado por', value: currentUser.displayName, inline: true }
                ]);
            }
            
            closeModal('eventModal');
            loadAgenda();
            if (document.getElementById('sectionTitle').textContent === 'Dashboard') {
                loadDashboard();
            }
            alert('Evento salvo com sucesso!');
        }

        // ========== FUNÇÕES DE PENDÊNCIAS ==========
        let pendencyDestinationTouched = false;

        function handlePendencyDestinationChange() {
            pendencyDestinationTouched = true;
            updatePendencyAssigneeOptions();
        }

        function getStaffRoles(member) {
            if (!member) return [];
            const roles = member.roles ?? member.staff_roles ?? member.staffRoles ?? member.staff_roles;
            const list = normalizeRoleList(roles);
            if (list.length > 0) return list;
            const single = member.role ?? member.memberRole ?? member.member_role;
            return normalizeRoleList(single);
        }

        function getStaffDisplayName(member) {
            return (member?.displayName || member?.display_name || member?.name || '').toString().trim();
        }

        function isActiveStaffMember(member) {
            const status = (member?.status || '').toString().toLowerCase().trim();
            return status !== 'inativo' && status !== 'inactive' && status !== 'desativado';
        }

        function updatePendencyAssigneeOptions() {
            const destination = (document.getElementById('pendencyDestination')?.value || '').toString().toLowerCase().trim();
            const group = document.getElementById('pendencyAssigneeGroup');
            const select = document.getElementById('pendencyAssignee');
            if (!group || !select) return;

            const shouldShow = destination === 'dev' || destination === 'clevel';
            if (!shouldShow) {
                group.classList.add('hidden');
                select.value = '';
                return;
            }

            group.classList.remove('hidden');

            const previouslySelected = (select.value || '').toString();
            select.innerHTML = '<option value=\"\">Sem responsável</option>';

            const list = Array.isArray(staffData) ? staffData : [];
            const filtered = list
                .filter(isActiveStaffMember)
                .filter(m => {
                    const roles = getStaffRoles(m);
                    if (destination === 'dev') return roles.some(r => (r || '').toString().toLowerCase() === 'dev');
                    if (destination === 'clevel') return isCLevelRole(roles);
                    return true;
                })
                .sort((a, b) => getStaffDisplayName(a).localeCompare(getStaffDisplayName(b), 'pt-BR'));

            for (const m of filtered) {
                const id = (m.id ?? m.user_id ?? m.userId ?? '').toString();
                const name = getStaffDisplayName(m);
                if (!id || !name) continue;
                const rolesLabel = getStaffRoles(m).join(' + ');
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = rolesLabel ? `${name} (${rolesLabel})` : name;
                select.appendChild(opt);
            }

            // Tenta restaurar seleção anterior quando fizer sentido
            if (previouslySelected) {
                const exists = Array.from(select.options).some(o => o.value === previouslySelected);
                if (exists) select.value = previouslySelected;
            }
        }

        function handlePendencyTypeChange() {
            const type = document.getElementById('pendencyType')?.value || '';
            const devGroup = document.getElementById('pendencyDevTypeGroup');
            const devSelect = document.getElementById('pendencyDevType');
            const donationGroup = document.getElementById('pendencyDonationItemGroup');
            const donationSelect = document.getElementById('pendencyDonationItem');
            const donationOtherGroup = document.getElementById('pendencyDonationItemOtherGroup');
            const donationOtherInput = document.getElementById('pendencyDonationItemOther');
            const destinationSelect = document.getElementById('pendencyDestination');

            if (!devGroup || !devSelect || !donationGroup || !donationSelect || !donationOtherGroup || !donationOtherInput) return;

            devGroup.classList.add('hidden');
            donationGroup.classList.add('hidden');
            donationOtherGroup.classList.add('hidden');
            devSelect.required = false;
            donationSelect.required = false;
            donationOtherInput.required = false;
            devSelect.value = '';
            donationSelect.value = '';
            donationOtherInput.value = '';

            if (type === 'desenvolvimento') {
                devGroup.classList.remove('hidden');
                devSelect.required = true;
            } else if (type === 'doacoes') {
                donationGroup.classList.remove('hidden');
                donationSelect.required = true;
            }

            // Destino padrão baseado no tipo (sem sobrescrever escolha manual)
            if (destinationSelect && !pendencyDestinationTouched) {
                if (type === 'desenvolvimento') destinationSelect.value = 'dev';
                else if (type === 'doacoes') destinationSelect.value = 'clevel';
                else destinationSelect.value = 'geral';
            }

            updatePendencyAssigneeOptions();
        }

        function handleDonationItemChange() {
            const donationSelect = document.getElementById('pendencyDonationItem');
            const donationOtherGroup = document.getElementById('pendencyDonationItemOtherGroup');
            const donationOtherInput = document.getElementById('pendencyDonationItemOther');
            if (!donationSelect || !donationOtherGroup || !donationOtherInput) return;

            if (donationSelect.value === 'outro') {
                donationOtherGroup.classList.remove('hidden');
                donationOtherInput.required = true;
            } else {
                donationOtherGroup.classList.add('hidden');
                donationOtherInput.required = false;
                donationOtherInput.value = '';
            }
        }

        function openNewPendencyModal() {
            document.getElementById('pendencyId').value = '';
            document.getElementById('pendencyModalTitle').textContent = 'Nova Solicitação de Pendência';
            document.getElementById('pendencyForm').reset();
            pendencyDestinationTouched = false;
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('pendencyDueDate').setAttribute('min', today);
            handlePendencyTypeChange();
            updatePendencyAssigneeOptions();
            document.getElementById('pendencyModal').classList.add('active');
        }

        function parseDonationItemFromDescription(description) {
            const raw = (description || '').toString();
            const match = raw.match(/^\s*\[Item de doação:\s*(.+?)\]\s*\n?/i);
            if (!match) return null;
            const label = (match[1] || '').toString().trim();
            const cleaned = raw.replace(match[0], '');
            return { label, cleanedDescription: cleaned };
        }

        function inferDonationItemKeyFromLabel(label) {
            const l = (label || '').toString().trim().toLowerCase();
            if (!l) return null;
            const map = new Map([
                ['vip', 'vip'],
                ['coins', 'coins'],
                ['coin', 'coins'],
                ['veiculo', 'veiculo'],
                ['veículo', 'veiculo'],
                ['casa', 'casa'],
                ['item exclusivo', 'item_exclusivo'],
                ['item_exclusivo', 'item_exclusivo'],
                ['pack', 'pack'],
                ['pacote', 'pack'],
            ]);
            return map.get(l) || null;
        }

        async function openEditPendencyModal(pendencyId) {
            const pid = Number(pendencyId);
            if (!pid) return;
            await ensurePendenciesLoaded(false);
            const pendency = state.pendencies.byId.get(String(pid));
            if (!pendency) {
                alert('Pendência não encontrada.');
                return;
            }

            document.getElementById('pendencyForm').reset();
            document.getElementById('pendencyId').value = String(pid);
            document.getElementById('pendencyModalTitle').textContent = `Editar Pendência #${pid}`;

            // Evitar que handlePendencyTypeChange sobrescreva destino automaticamente
            pendencyDestinationTouched = true;

            const typeCategoryEl = document.getElementById('pendencyType');
            const devTypeEl = document.getElementById('pendencyDevType');
            const donationItemEl = document.getElementById('pendencyDonationItem');
            const donationOtherEl = document.getElementById('pendencyDonationItemOther');

            document.getElementById('pendencyTitle').value = (pendency.title || '').toString();
            document.getElementById('pendencyPriority').value = (pendency.priority || 'medium').toString();
            document.getElementById('pendencyDueDate').value = (pendency.dueDate || pendency.due_date || '').toString().slice(0, 10);

            const type = (pendency.type || '').toString().toLowerCase().trim();
            let description = (pendency.description || '').toString();

            if (type === 'doacoes' || isFinancialPendencyType(type)) {
                if (typeCategoryEl) typeCategoryEl.value = 'doacoes';

                const parsed = parseDonationItemFromDescription(description);
                const donationLabel = parsed?.label || '';
                description = parsed?.cleanedDescription ?? description;

                const inferredKey = inferDonationItemKeyFromLabel(donationLabel);
                if (donationItemEl) donationItemEl.value = inferredKey || (donationLabel ? 'outro' : 'vip');
                if (donationOtherEl) donationOtherEl.value = (!inferredKey && donationLabel) ? donationLabel : '';
            } else {
                if (typeCategoryEl) typeCategoryEl.value = 'desenvolvimento';
                if (devTypeEl) devTypeEl.value = type;
            }

            document.getElementById('pendencyDescription').value = description.trim();

            const destination = getEffectivePendencyArea(pendency) || 'geral';
            const destinationEl = document.getElementById('pendencyDestination');
            if (destinationEl) destinationEl.value = destination;

            try { handlePendencyTypeChange(); } catch (e) {}
            try { handleDonationItemChange(); } catch (e) {}
            try { handlePendencyDestinationChange(); } catch (e) {}
            try { updatePendencyAssigneeOptions(); } catch (e) {}

            const meta = (pendency.attachments && typeof pendency.attachments === 'object')
                ? (pendency.attachments._meta || pendency.attachments.meta || null)
                : null;
            const assignedUserId = meta?.assignedUserId ?? meta?.assigned_user_id ?? pendency.assignedUserId ?? pendency.assigned_user_id ?? null;
            if (assignedUserId !== null && assignedUserId !== undefined) {
                const assigneeEl = document.getElementById('pendencyAssignee');
                if (assigneeEl) assigneeEl.value = String(assignedUserId);
            }

            document.getElementById('pendencyModal').classList.add('active');
        }
        
        async function savePendency(event) {
            event.preventDefault();
            if (!currentUser || !currentUser.id) {
                alert('Erro: Usuário não identificado.');
                return;
            }
            const pendencyId = document.getElementById('pendencyId').value;
            const title = document.getElementById('pendencyTitle').value.trim();
            const description = document.getElementById('pendencyDescription').value.trim();
            const typeCategory = document.getElementById('pendencyType').value;
            const devType = document.getElementById('pendencyDevType')?.value || '';
            const donationItem = document.getElementById('pendencyDonationItem')?.value || '';
            const donationItemOther = document.getElementById('pendencyDonationItemOther')?.value?.trim() || '';
            const priority = document.getElementById('pendencyPriority').value;
            const dueDate = document.getElementById('pendencyDueDate').value;
            if (!title || !description || !typeCategory) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }

            let type = typeCategory;
            let finalDescription = description;
            let displayType = typeCategory;

            if (typeCategory === 'desenvolvimento') {
                if (!devType) {
                    alert('Selecione o tipo de desenvolvimento.');
                    return;
                }
                type = devType;
                displayType = devType;
            } else if (typeCategory === 'doacoes') {
                if (!donationItem) {
                    alert('Selecione o item da doação.');
                    return;
                }
                const donationMap = {
                    vip: 'VIP',
                    coins: 'Coins',
                    veiculo: 'Veículo',
                    casa: 'Casa',
                    item_exclusivo: 'Item Exclusivo',
                    pack: 'Pacote',
                    outro: 'Outro'
                };
                const donationLabel = donationItem === 'outro'
                    ? donationItemOther
                    : (donationMap[donationItem] || donationItem);
                if (donationItem === 'outro' && !donationLabel) {
                    alert('Descreva o item de doação.');
                    return;
                }
                type = 'doacoes';
                displayType = `Doações (${donationLabel})`;
                finalDescription = `[Item de doação: ${donationLabel}]\n${description}`;
            }
            const destinationSelect = document.getElementById('pendencyDestination');
            const rawDestination = (destinationSelect?.value || '').toString().toLowerCase().trim();
            const inferredDestination = inferPendencyAreaFromType(typeCategory === 'desenvolvimento' ? 'desenvolvimento' : type);
            const destination = rawDestination || inferredDestination || 'geral';

            // Regras: doações (financeiro) deve ir para C-Level
            if (type === 'doacoes' && destination !== 'clevel') {
                alert('Pendências financeiras (Doações) devem ter destino C-Level.');
                return;
            }

            const opKey = `pendency:save:${pendencyId || 'new'}`;
            return withIdempotency(opKey, async () => {
                if (!supabaseClient) {
                    console.error('[pendencies] Supabase indisponível. Não foi possível salvar.');
                    alert('Erro: sistema sem conexão com o banco. Recarregue a página.');
                    return;
                }

                try {
                    const existing = pendencyId ? state.pendencies.byId.get(String(pendencyId)) : null;
                    const existingMeta = existing?.attachments && typeof existing.attachments === 'object'
                        ? (existing.attachments._meta || existing.attachments.meta || null)
                        : null;

                    // Em edição, manter o solicitante original (não trocar user_id/user_name/created_by)
                    const requesterId = (existing?.userId ?? existing?.user_id ?? currentUser.id) ? String(existing?.userId ?? existing?.user_id ?? currentUser.id) : String(currentUser.id);
                    const requesterName = (existing?.userName ?? existing?.user_name ?? existingMeta?.createdByName ?? (currentUser.displayName || currentUser.name || 'Usuário')).toString();
                    const createdBy = (existing?.createdBy ?? existing?.created_by ?? requesterId) ? String(existing?.createdBy ?? existing?.created_by ?? requesterId) : requesterId;

                    const assigneeId = (document.getElementById('pendencyAssignee')?.value || '').toString().trim();
                    const assignee = assigneeId ? (Array.isArray(staffData) ? staffData.find(m => String(m?.id) === String(assigneeId)) : null) : null;
                    const assignedRole = destination === 'dev' ? 'dev' : null;
                    const nowIso = new Date().toISOString();
                    const meta = {
                        destination,
                        assignedRole,
                        assignedUserId: assigneeId || null,
                        assignedUserName: assignee ? getStaffDisplayName(assignee) : null,
                        createdByUserId: String(existingMeta?.createdByUserId || requesterId),
                        createdByRole: String(existingMeta?.createdByRole || currentUser.role || (normalizeRoleList(currentUser.roles || [])[0] || '')),
                        createdByName: String(existingMeta?.createdByName || requesterName),
                        ...(pendencyId ? {
                            lastEditedAt: nowIso,
                            lastEditedByUserId: String(currentUser.id),
                            lastEditedByName: String(currentUser.displayName || currentUser.name || ''),
                            lastEditedByRole: String(currentUser.role || (normalizeRoleList(currentUser.roles || [])[0] || ''))
                        } : {}),
                        clientRequestId: pendencyId ? `pendency:${pendencyId}` : `pendency:new:${Date.now()}`
                    };

                    const payloadBase = {
                        user_id: requesterId,
                        user_name: requesterName,
                        title: title,
                        description: finalDescription,
                        type: type,
                        priority: priority,
                        due_date: dueDate || null,
                        created_by: createdBy,
                        destination: destination,
                        assigned_role: destination === 'dev' ? 'dev' : (destination === 'clevel' ? 'clevel' : null),
                        assigned_user_id: assigneeId || null,
                        assigned_user_name: assignee ? getStaffDisplayName(assignee) : null,
                        // `attachments` é JSONB na tabela padrão. Guardamos o destino aqui para roteamento sem migração.
                        attachments: {
                            ...(existing?.attachments && typeof existing.attachments === 'object' ? existing.attachments : {}),
                            _meta: { ...(existingMeta || {}), ...meta }
                        }
                    };

                    let savedRow = null;
                    const isMissingColumn = (err, col) => {
                        const msg = (err?.message || '').toString().toLowerCase();
                        const c = String(col || '').toLowerCase();
                        return c && msg.includes(c) && (msg.includes('could not find') || msg.includes('does not exist') || msg.includes('schema cache'));
                    };
                    const isMissingAttachmentsColumn = (err) => isMissingColumn(err, 'attachments');
                    const isMissingRoutingColumns = (err) => (
                        isMissingColumn(err, 'destination') ||
                        isMissingColumn(err, 'assigned_role') ||
                        isMissingColumn(err, 'assigned_user_id') ||
                        isMissingColumn(err, 'assigned_user_name')
                    );
                    const payloadNoAttachments = (() => {
                        const copy = { ...payloadBase };
                        delete copy.attachments;
                        return copy;
                    })();
                    const stripRoutingFields = (payload) => {
                        const copy = { ...payload };
                        delete copy.destination;
                        delete copy.assigned_role;
                        delete copy.assigned_user_id;
                        delete copy.assigned_user_name;
                        return copy;
                    };
                    if (pendencyId) {
                        const doUpdate = async (payload) => supabaseClient
                            .from('pendencies')
                            .update({ ...payload, updated_at: nowIso })
                            .eq('id', pendencyId)
                            .select('*')
                            .single();

                        let payloadAttempt = payloadBase;
                        let result = await doUpdate(payloadAttempt);
                        if (result.error && isMissingAttachmentsColumn(result.error)) {
                            console.warn('[pendencies] Coluna attachments ausente; salvando sem destino/meta. Recomenda-se adicionar JSONB attachments.', result.error);
                            payloadAttempt = payloadNoAttachments;
                            result = await doUpdate(payloadAttempt);
                        }
                        if (result.error && isMissingRoutingColumns(result.error)) {
                            console.warn('[pendencies] Colunas de atribuição/destino ausentes; salvando sem assigned_* e destination. Recomenda-se aplicar a migração.', result.error);
                            payloadAttempt = stripRoutingFields(payloadAttempt);
                            result = await doUpdate(payloadAttempt);
                        }
                        if (result.error) {
                            console.error('[pendencies] Erro ao atualizar:', { pendencyId, error: result.error, payloadBase });
                            throw result.error;
                        }
                        savedRow = result.data;
                    } else {
                        const doInsert = async (payload) => supabaseClient
                            .from('pendencies')
                            .insert(payload)
                            .select('*')
                            .single();

                        let payloadAttempt = payloadBase;
                        let result = await doInsert(payloadAttempt);
                        if (result.error && isMissingAttachmentsColumn(result.error)) {
                            console.warn('[pendencies] Coluna attachments ausente; salvando sem destino/meta. Recomenda-se adicionar JSONB attachments.', result.error);
                            payloadAttempt = payloadNoAttachments;
                            result = await doInsert(payloadAttempt);
                        }
                        if (result.error && isMissingRoutingColumns(result.error)) {
                            console.warn('[pendencies] Colunas de atribuição/destino ausentes; salvando sem assigned_* e destination. Recomenda-se aplicar a migração.', result.error);
                            payloadAttempt = stripRoutingFields(payloadAttempt);
                            result = await doInsert(payloadAttempt);
                        }
                        if (result.error) {
                            console.error('[pendencies] Erro ao inserir:', { error: result.error, payloadBase });
                            throw result.error;
                        }
                        savedRow = result.data;
                    }

                    const normalized = normalizePendencyRow(savedRow);
                    upsertItem(state.pendencies.byId, normalized);
                    clearCacheKey('txd_pendencies');

                    try {
                        sendDiscordNotification('staff', pendencyId ? '✏️ Pendência Atualizada' : '📋 Nova Pendência Solicitada',
                            pendencyId ? `Pendência #${normalized.id} atualizada` : `Nova pendência #${normalized.id} foi criada`,
                            [
                                { name: '📋 Título', value: title, inline: false },
                                { name: '📌 Destino', value: destination.toUpperCase(), inline: true },
                                { name: '👤 Solicitado por', value: payloadBase.user_name, inline: true },
                                { name: '📊 Prioridade', value: priority === 'urgent' ? 'Urgente' : priority === 'high' ? 'Alta' : priority === 'medium' ? 'Média' : 'Baixa', inline: true },
                                { name: '🏷️ Tipo', value: displayType === 'bugs' ? 'Bugs' : displayType === 'mapas' ? 'Mapas' : displayType === 'carros' ? 'Carros' : displayType === 'roupas' ? 'Roupas' : displayType === 'itens' ? 'Itens' : displayType === 'coordenadas' ? 'Coordenadas' : displayType === 'logs' ? 'Logs' : displayType === 'atualizacoes' ? 'Atualizações' : displayType, inline: true }
                            ]);
                    } catch (err) {
                        console.warn('[pendencies] Falha ao notificar Discord:', err);
                    }

                    logSystemAction(pendencyId ? 'Pendência atualizada' : 'Pendência criada', 'Pendências', {
                        pendencyId: normalized.id,
                        title: title,
                        destination,
                        type: type,
                        priority: priority
                    });

                    // Notificação persistente: nova pendência criada (roteada por destino)
                    if (!pendencyId) {
                        const audience = destination === 'dev'
                            ? 'dev'
                            : (destination === 'clevel' ? 'clevel' : 'all');
                        createNotification({
                            type: 'pendency_created',
                            title: '📋 Nova pendência criada',
                            body: `#${normalized.id} • ${title}`,
                            audience,
                            entityType: 'pendency',
                            entityId: normalized.id,
                            metadata: {
                                actorUserId: getCurrentUserIdString(),
                                actorName: String(currentUser?.displayName || currentUser?.name || ''),
                                pendencyUserId: String(payloadBase.user_id || ''),
                                destination,
                                suppressSelf: true
                            }
                        }).catch(() => {});
                    }

                    alert(`✅ Pendência ${pendencyId ? 'editada' : 'criada'} com sucesso!`);
                    closeModal('pendencyModal');
                    renderPendencias();
                } catch (error) {
                    console.error('[pendencies] Erro ao salvar pendência:', { pendencyId, error });
                    alert(`Erro ao salvar pendência: ${error.message || 'Erro desconhecido'}`);
                }
            });
        }
        
        async function approvePendency(pendencyId) {
            if (!hasPermission('pendency.approve') && !hasPermission('dashboard') && !isCLevelRole(currentUser?.roles || currentUser?.role) && !isDevRole(currentUser?.roles || currentUser?.role)) {
                alert('Você não tem permissão para aprovar pendências.');
                return;
            }
            const response = prompt('Deseja adicionar uma resposta/observação? (Opcional)');
            try {
                const { data: directPendency, error: directError } = await supabaseClient
                    .from('pendencies')
                    .select('*')
                    .eq('id', pendencyId)
                    .single();
                if (directError || !directPendency) {
                    alert('Pendência não encontrada.');
                    return;
                }

                const scope = getPendencyScope(directPendency.type);
                if (scope === 'financial' && !isCLevelRole(currentUser?.roles || currentUser?.role)) {
                    alert('Pendências financeiras só podem ser aprovadas por C-Level.');
                    return;
                }

                if (scope === 'dev' && !isCLevelRole(currentUser?.roles || currentUser?.role) && !isDevRole(currentUser?.roles || currentUser?.role)) {
                    alert('Pendências de desenvolvimento só podem ser aprovadas por Desenvolvedores ou C-Level.');
                    return;
                }

                const { error: updateError } = await supabaseClient
                    .from('pendencies')
                    .update({
                        status: 'approved',
                        response: response || null,
                        approved_by: currentUser.name || currentUser.displayName,
                        approved_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', pendencyId);
                if (updateError) throw updateError;
                clearCacheKey('txd_pendencies');
                try {
                    const normalized = normalizePendencyRow({
                        ...directPendency,
                        status: 'approved',
                        response: response || null,
                        approved_by: currentUser.name || currentUser.displayName,
                        approved_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                    upsertItem(state.pendencies.byId, normalized);
                } catch (e) {
                    console.warn('[pendencies] Falha ao atualizar state (approve):', e);
                }
                sendDiscordNotification('staff', '✅ Pendência Aprovada', `Pendência #${pendencyId} foi aprovada`, [
                    { name: '📋 Título', value: directPendency.title || 'N/A', inline: false },
                    { name: '✅ Aprovada por', value: currentUser.name || currentUser.displayName, inline: true }
                ]);
                logSystemAction('Pendência aprovada', 'Pendências', { pendencyId });

                // Notificação persistente para o solicitante
                createNotification({
                    type: 'pendency_approved',
                    title: '✅ Pendência aprovada',
                    body: `#${pendencyId} • ${(directPendency.title || 'Sem título')}`,
                    audience: 'user',
                    audienceUserId: directPendency.user_id ?? directPendency.userId ?? null,
                    entityType: 'pendency',
                    entityId: pendencyId,
                    metadata: {
                        actorUserId: getCurrentUserIdString(),
                        actorName: String(currentUser?.displayName || currentUser?.name || ''),
                        status: 'approved'
                    }
                }).catch(() => {});
                alert('✅ Pendência aprovada com sucesso!');
                renderPendencias();
            } catch (error) {
                console.error('Erro ao aprovar pendência:', error);
                alert('Erro ao aprovar pendência. Tente novamente.');
            }
        }
        
        async function rejectPendency(pendencyId) {
            if (!hasPermission('pendency.approve') && !hasPermission('dashboard') && !isCLevelRole(currentUser?.roles || currentUser?.role) && !isDevRole(currentUser?.roles || currentUser?.role)) {
                alert('Você não tem permissão para rejeitar pendências.');
                return;
            }
            const reason = prompt('Informe o motivo da rejeição:');
            if (!reason) {
                alert('É necessário informar o motivo da rejeição.');
                return;
            }
            try {
                const { data: directPendency, error: directError } = await supabaseClient
                    .from('pendencies')
                    .select('*')
                    .eq('id', pendencyId)
                    .single();
                if (directError || !directPendency) {
                    alert('Pendência não encontrada.');
                    return;
                }

                const scope = getPendencyScope(directPendency.type);
                if (scope === 'financial' && !isCLevelRole(currentUser?.roles || currentUser?.role)) {
                    alert('Pendências financeiras só podem ser rejeitadas por C-Level.');
                    return;
                }

                if (scope === 'dev' && !isCLevelRole(currentUser?.roles || currentUser?.role) && !isDevRole(currentUser?.roles || currentUser?.role)) {
                    alert('Pendências de desenvolvimento só podem ser rejeitadas por Desenvolvedores ou C-Level.');
                    return;
                }

                const { error: updateError } = await supabaseClient
                    .from('pendencies')
                    .update({
                        status: 'rejected',
                        response: reason,
                        approved_by: currentUser.name || currentUser.displayName,
                        approved_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', pendencyId);
                if (updateError) throw updateError;
                clearCacheKey('txd_pendencies');
                try {
                    const normalized = normalizePendencyRow({
                        ...directPendency,
                        status: 'rejected',
                        response: reason,
                        approved_by: currentUser.name || currentUser.displayName,
                        approved_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                    upsertItem(state.pendencies.byId, normalized);
                } catch (e) {
                    console.warn('[pendencies] Falha ao atualizar state (reject):', e);
                }
                sendDiscordNotification('staff', '❌ Pendência Rejeitada', `Pendência #${pendencyId} foi rejeitada`, [
                    { name: '📋 Título', value: directPendency.title || 'N/A', inline: false },
                    { name: '❌ Rejeitada por', value: currentUser.name || currentUser.displayName, inline: true },
                    { name: '📝 Motivo', value: reason, inline: false }
                ]);
                logSystemAction('Pendência rejeitada', 'Pendências', { pendencyId, reason });

                // Notificação persistente para o solicitante
                createNotification({
                    type: 'pendency_rejected',
                    title: '❌ Pendência rejeitada',
                    body: `#${pendencyId} • ${(directPendency.title || 'Sem título')}\nMotivo: ${reason}`,
                    audience: 'user',
                    audienceUserId: directPendency.user_id ?? directPendency.userId ?? null,
                    entityType: 'pendency',
                    entityId: pendencyId,
                    metadata: {
                        actorUserId: getCurrentUserIdString(),
                        actorName: String(currentUser?.displayName || currentUser?.name || ''),
                        status: 'rejected'
                    }
                }).catch(() => {});
                alert('✅ Pendência rejeitada.');
                renderPendencias();
            } catch (error) {
                console.error('Erro ao rejeitar pendência:', error);
                alert('Erro ao rejeitar pendência. Tente novamente.');
            }
        }
        
        async function startPendency(pendencyId) {
            if (!hasPermission('pendency.approve') && !hasPermission('dashboard') && !isCLevelRole(currentUser?.roles || currentUser?.role) && !isDevRole(currentUser?.roles || currentUser?.role)) {
                alert('Você não tem permissão para iniciar pendências.');
                return;
            }
            try {
                const { data: directPendency, error: directError } = await supabaseClient
                    .from('pendencies')
                    .select('*')
                    .eq('id', pendencyId)
                    .single();
                if (directError || !directPendency) {
                    alert('Pendência não encontrada.');
                    return;
                }
                
                const scope = getPendencyScope(directPendency.type);
                if (scope === 'financial' && !isCLevelRole(currentUser?.roles || currentUser?.role)) {
                    alert('Pendências financeiras só podem ser iniciadas por C-Level.');
                    return;
                }
                if (scope === 'dev' && !isCLevelRole(currentUser?.roles || currentUser?.role) && !isDevRole(currentUser?.roles || currentUser?.role)) {
                    alert('Pendências de desenvolvimento só podem ser iniciadas por Desenvolvedores ou C-Level.');
                    return;
                }

                const { error: updateError } = await supabaseClient
                    .from('pendencies')
                    .update({
                        status: 'in_progress',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', pendencyId);
                if (updateError) throw updateError;
                clearCacheKey('txd_pendencies');
                try {
                    const normalized = normalizePendencyRow({
                        ...directPendency,
                        status: 'in_progress',
                        updated_at: new Date().toISOString()
                    });
                    upsertItem(state.pendencies.byId, normalized);
                } catch (e) {
                    console.warn('[pendencies] Falha ao atualizar state (start):', e);
                }
                logSystemAction('Pendência iniciada', 'Pendências', { pendencyId });

                // Notificação persistente para o solicitante
                createNotification({
                    type: 'pendency_in_progress',
                    title: '⏳ Pendência em andamento',
                    body: `#${pendencyId} • ${(directPendency.title || 'Sem título')}`,
                    audience: 'user',
                    audienceUserId: directPendency.user_id ?? directPendency.userId ?? null,
                    entityType: 'pendency',
                    entityId: pendencyId,
                    metadata: {
                        actorUserId: getCurrentUserIdString(),
                        actorName: String(currentUser?.displayName || currentUser?.name || ''),
                        status: 'in_progress'
                    }
                }).catch(() => {});
                alert('✅ Pendência iniciada!');
                renderPendencias();
            } catch (error) {
                console.error('Erro ao iniciar pendência:', error);
                alert('Erro ao iniciar pendência. Tente novamente.');
            }
        }
        
        async function completePendency(pendencyId) {
            if (!hasPermission('pendency.approve') && !hasPermission('dashboard') && !isCLevelRole(currentUser?.roles || currentUser?.role) && !isDevRole(currentUser?.roles || currentUser?.role)) {
                alert('Você não tem permissão para concluir pendências.');
                return;
            }
            if (!supabaseClient) {
                alert('Banco de dados indisponível. Recarregue a página.');
                return;
            }
            if (!confirm('Deseja marcar esta pendência como concluída?')) return;
            try {
                const { data: directPendency, error: directError } = await supabaseClient
                    .from('pendencies')
                    .select('*')
                    .eq('id', pendencyId)
                    .single();
                if (directError || !directPendency) {
                    alert('Pendência não encontrada.');
                    return;
                }

                const rawStatus = (directPendency.status || '').toString().toLowerCase().trim();
                if (['completed', 'concluida', 'concluída'].includes(rawStatus)) {
                    alert('Esta pendência já está concluída.');
                    return;
                }
                if (['rejected', 'rejeitada'].includes(rawStatus)) {
                    alert('Esta pendência está rejeitada e não pode ser concluída.');
                    return;
                }
                if (['pending', 'pendente'].includes(rawStatus)) {
                    alert('A pendência precisa ser aprovada antes de concluir.');
                    return;
                }
                
                const scope = getPendencyScope(directPendency.type);
                if (scope === 'financial' && !isCLevelRole(currentUser?.roles || currentUser?.role)) {
                    alert('Pendências financeiras só podem ser concluídas por C-Level.');
                    return;
                }
                if (scope === 'dev' && !isCLevelRole(currentUser?.roles || currentUser?.role) && !isDevRole(currentUser?.roles || currentUser?.role)) {
                    alert('Pendências de desenvolvimento só podem ser concluídas por Desenvolvedores ou C-Level.');
                    return;
                }

                const completedAt = new Date().toISOString();
                const basePayload = {
                    status: 'completed',
                    completed_at: completedAt,
                    updated_at: completedAt
                };

                const attemptUpdate = async (payload) => supabaseClient
                    .from('pendencies')
                    .update(payload)
                    .eq('id', pendencyId);

                let updateResult = await attemptUpdate(basePayload);
                if (updateResult.error) {
                    const msg = (updateResult.error.message || '').toString().toLowerCase();
                    // Compatibilidade caso o schema não tenha algumas colunas (ex: completed_at / updated_at)
                    if (msg.includes('completed_at') && (msg.includes('could not find') || msg.includes('does not exist') || msg.includes('schema cache'))) {
                        console.warn('[pendencies] Coluna completed_at ausente; concluindo sem completed_at.', updateResult.error);
                        updateResult = await attemptUpdate({ status: 'completed', updated_at: completedAt });
                    }
                }
                if (updateResult.error) {
                    const msg = (updateResult.error.message || '').toString().toLowerCase();
                    if (msg.includes('updated_at') && (msg.includes('could not find') || msg.includes('does not exist') || msg.includes('schema cache'))) {
                        console.warn('[pendencies] Coluna updated_at ausente; concluindo apenas com status.', updateResult.error);
                        updateResult = await attemptUpdate({ status: 'completed' });
                    }
                }
                if (updateResult.error) throw updateResult.error;
                clearCacheKey('txd_pendencies');
                try {
                    const normalized = normalizePendencyRow({
                        ...directPendency,
                        status: 'completed',
                        completed_at: completedAt,
                        updated_at: completedAt
                    });
                    upsertItem(state.pendencies.byId, normalized);
                } catch (e) {
                    console.warn('[pendencies] Falha ao atualizar state (complete):', e);
                }
                sendDiscordNotification('staff', '✅ Pendência Concluída', `Pendência #${pendencyId} foi concluída!`, [
                    { name: '✅ Concluída por', value: currentUser.name || currentUser.displayName, inline: true }
                ]);
                logSystemAction('Pendência concluída', 'Pendências', { pendencyId });

                // Notificação persistente para o solicitante
                createNotification({
                    type: 'pendency_completed',
                    title: '✅ Pendência concluída',
                    body: `#${pendencyId} • ${(directPendency.title || 'Sem título')}`,
                    audience: 'user',
                    audienceUserId: directPendency.user_id ?? directPendency.userId ?? null,
                    entityType: 'pendency',
                    entityId: pendencyId,
                    metadata: {
                        actorUserId: getCurrentUserIdString(),
                        actorName: String(currentUser?.displayName || currentUser?.name || ''),
                        status: 'completed'
                    }
                }).catch(() => {});
                alert('✅ Pendência marcada como concluída!');
                renderPendencias();
            } catch (error) {
                console.error('Erro ao concluir pendência:', error);
                alert('Erro ao concluir pendência. Tente novamente.');
            }
        }
        
        async function viewPendencyDetails(pendencyId) {
            await ensurePendenciesLoaded(false);
            const pendency = state.pendencies.byId.get(String(pendencyId));
            if (!pendency) {
                alert('Pendência não encontrada.');
                return;
            }
            const meta = (pendency.attachments && typeof pendency.attachments === 'object')
                ? (pendency.attachments._meta || pendency.attachments.meta || null)
                : null;
            const assignedUserId = meta?.assignedUserId ?? meta?.assigned_user_id ?? pendency.assignedUserId ?? pendency.assigned_user_id ?? null;
            const assignedUserName = meta?.assignedUserName ?? meta?.assigned_user_name ?? meta?.assignedByName ?? pendency.assignedUserName ?? pendency.assigned_user_name ?? null;
            const canManage = hasPermission('pendency.approve') || hasPermission('dashboard') || isCLevelRole(currentUser?.roles || currentUser?.role) || isDevRole(currentUser?.roles || currentUser?.role);
            const isRequester = isCurrentUserId(pendency.userId ?? pendency.user_id);
            const isAssignedToMe = assignedUserId ? isCurrentUserId(assignedUserId) : false;
            const priorityColors = {
                urgent: { bg: 'var(--danger)', label: 'Urgente' },
                high: { bg: 'var(--danger)', label: 'Alta' },
                medium: { bg: 'var(--warning)', label: 'Média' },
                low: { bg: 'var(--success)', label: 'Baixa' }
            };
            const priorityInfo = priorityColors[pendency.priority] || priorityColors.medium;
            const typeLabels = {
                bugs: 'Bugs',
                mapas: 'Mapas',
                carros: 'Carros',
                roupas: 'Roupas',
                itens: 'Itens',
                coordenadas: 'Coordenadas',
                logs: 'Logs',
                atualizacoes: 'Atualizações',
                doacoes: 'Doações'
            };
            const statusLabels = {
                pending: 'Pendente',
                in_progress: 'Em Andamento',
                approved: 'Aprovada',
                completed: 'Concluída',
                rejected: 'Rejeitada'
            };
            const normalizedStatus = normalizePendencyStatusValue(pendency?.status, pendency);
            const canAssume = canManage && !isRequester && !['completed', 'rejected'].includes(normalizedStatus) && (!assignedUserId || !isAssignedToMe);
            const createdAt = new Date(pendency.createdAt || pendency.created_at || 0);
            const updatedAt = new Date(pendency.updatedAt || pendency.updated_at || createdAt);
            const lastEditedAt = meta?.lastEditedAt || meta?.last_edited_at || null;
            const lastEditedByName = meta?.lastEditedByName || meta?.last_edited_by_name || null;
            const dueDate = pendency.dueDate || pendency.due_date;
            const completedAt = pendency.completedAt || pendency.completed_at;
            const approvedAt = pendency.approvedAt || pendency.approved_at;
            const canEditThis = (hasPermission('pendency.edit') || hasPermission('dashboard') || (isRequester && normalizedStatus === 'pending')) && !['completed', 'rejected'].includes(normalizedStatus);
            const content = `
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
                        <div style="flex: 1;">
                            <h3 style="color: var(--white-soft); font-size: 24px; margin-bottom: 12px;">#${pendency.id} - ${pendency.title || 'Sem título'}</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
                                <span class="badge" style="background: ${priorityInfo.bg}; color: white; padding: 6px 16px; border-radius: 6px; font-size: 13px; font-weight: 600;">${priorityInfo.label}</span>
                                <span class="badge badge-secondary">${typeLabels[pendency.type] || pendency.type}</span>
                                <span class="badge badge-primary" id="pendencyStatusBadge">${statusLabels[normalizedStatus] || normalizedStatus}</span>
                                ${isFinancialPendencyType(pendency.type) ? '<span class="badge badge-danger">Somente C-Level</span>' : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            ${canEditThis ? `
                                <button type="button" class="btn btn-primary" style="width: auto; padding: 10px 14px; border-radius: 12px;" onclick="openEditPendencyModal(${pendency.id})">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    ${(lastEditedAt || (updatedAt && createdAt && (updatedAt.getTime() - createdAt.getTime()) > 15000)) ? `
                    <div style="background: rgba(255, 170, 0, 0.12); border: 1px solid rgba(255, 170, 0, 0.35); border-radius: 10px; padding: 12px 14px; margin-bottom: 18px;">
                        <div style="color: var(--warning); font-weight: 800; font-size: 13px; margin-bottom: 4px;">
                            <i class="fas fa-pen"></i> Atenção: esta pendência foi editada
                        </div>
                        <div style="color: var(--gray-light); font-size: 12px;">
                            ${lastEditedAt ? `Editada em ${new Date(lastEditedAt).toLocaleString('pt-BR')}${lastEditedByName ? ` por ${escapeHtml(String(lastEditedByName))}` : ''}.` : `Última atualização: ${updatedAt.toLocaleString('pt-BR')}.`}
                        </div>
                    </div>
                    ` : ''}
                    <div style="margin-bottom: 24px;">
                        <h4 style="color: var(--white-soft); font-size: 16px; margin-bottom: 12px;">Descrição</h4>
                        <div style="background: var(--black-dark); border-radius: 8px; padding: 16px; border: 1px solid var(--gray-border);">
                            <p style="color: var(--gray-light); line-height: 1.6; white-space: pre-wrap;">${pendency.description || 'Sem descrição'}</p>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div>
                            <div style="font-size: 12px; color: var(--gray-text); margin-bottom: 4px;">Solicitado por</div>
                            <div style="color: var(--white-soft); font-weight: 600;">${pendency.userName || pendency.user_name || 'N/A'}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--gray-text); margin-bottom: 4px;">Data de criação</div>
                            <div style="color: var(--white-soft); font-weight: 600;">${createdAt.toLocaleString('pt-BR')}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--gray-text); margin-bottom: 4px;">Última atualização</div>
                            <div style="color: var(--white-soft); font-weight: 600;">${updatedAt.toLocaleString('pt-BR')}</div>
                        </div>
                        ${dueDate ? `
                        <div>
                            <div style="font-size: 12px; color: var(--gray-text); margin-bottom: 4px;">Data limite</div>
                            <div style="color: ${new Date(dueDate) < new Date() ? 'var(--danger)' : 'var(--white-soft)'}; font-weight: 600;">${new Date(dueDate).toLocaleDateString('pt-BR')}</div>
                        </div>
                        ` : ''}
                        ${approvedAt ? `
                        <div>
                            <div style="font-size: 12px; color: var(--gray-text); margin-bottom: 4px;">Aprovada em</div>
                            <div style="color: var(--success); font-weight: 600;">${new Date(approvedAt).toLocaleString('pt-BR')}</div>
                        </div>
                        ` : ''}
                        ${completedAt ? `
                        <div>
                            <div style="font-size: 12px; color: var(--gray-text); margin-bottom: 4px;">Concluída em</div>
                            <div style="color: var(--success); font-weight: 600;">${new Date(completedAt).toLocaleString('pt-BR')}</div>
                        </div>
                        ` : ''}
                    </div>
                    ${pendency.response ? `
                    <div style="background: var(--gray-darker); border-radius: 8px; padding: 16px; border-left: 3px solid var(--primary);">
                        <div style="font-size: 12px; color: var(--gray-text); margin-bottom: 8px; font-weight: 600;">Resposta/Observação:</div>
                        <div style="font-size: 14px; color: var(--white-soft); line-height: 1.6; white-space: pre-wrap;">${pendency.response}</div>
                    </div>
                    ` : ''}

                    <div style="margin-top: 18px; display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 12px; padding: 14px;">
                        <div>
                            <div style="font-size: 12px; color: var(--gray-text); margin-bottom: 6px;">Responsável</div>
                            <div id="pendencyAssignedLabel" style="color: var(--white-soft); font-weight: 700;">
                                ${assignedUserName ? escapeHtml(String(assignedUserName)) : (assignedUserId ? `ID ${escapeHtml(String(assignedUserId))}` : '<span style="color: var(--gray-light); font-weight: 600;">Não atribuído</span>')}
                            </div>
                        </div>
                        ${canAssume ? `
                            <button id="pendencyAssumeBtn" type="button" class="btn btn-primary" onclick="assignPendencyToMe(${pendency.id})" style="width: auto; padding: 10px 14px; border-radius: 12px;">
                                <i class="fas fa-hand-pointer"></i> Assumir
                            </button>
                        ` : ''}
                    </div>

                    <div style="margin-top: 24px;">
                        <h4 style="color: var(--white-soft); font-size: 16px; margin-bottom: 12px;">
                            <i class="fas fa-comments" style="color: var(--gray-very-light); margin-right: 8px;"></i>
                            Chat da Pendência
                        </h4>
                        <div id="pendencyChatStatus" style="color: var(--gray-text); font-size: 12px; margin-bottom: 10px;"></div>
                        <div id="pendencyChatMessages"
                             style="background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 12px; padding: 12px; max-height: 280px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                        </div>
                        <form id="pendencyChatForm" onsubmit="sendPendencyChatMessage(event, ${pendency.id})" style="display: flex; gap: 10px; margin-top: 12px;">
                            <input id="pendencyChatInput"
                                   type="text"
                                   placeholder="Digite uma mensagem…"
                                   style="flex: 1; padding: 12px 14px; background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 12px; color: var(--white-soft); font-size: 14px;"
                                   autocomplete="off" />
                            <button type="submit" class="btn btn-primary" style="width: auto; padding: 12px 18px; border-radius: 12px;">
                                <i class="fas fa-paper-plane"></i> Enviar
                            </button>
                        </form>
                        <div style="color: var(--gray-text); font-size: 11px; margin-top: 8px;">
                            Visível para quem tem acesso a esta pendência.
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('pendencyDetailsContent').innerHTML = content;
            document.getElementById('pendencyDetailsModal').classList.add('active');

            // Inicializar mini-chat da pendência
            setupPendencyChat(pendency.id);
        }

        function mergePendencyAttachmentsMeta(existingAttachments, metaPatch) {
            const base = (existingAttachments && typeof existingAttachments === 'object' && !Array.isArray(existingAttachments))
                ? { ...existingAttachments }
                : {};
            const currentMetaRaw = base._meta ?? base.meta ?? null;
            const currentMeta = (currentMetaRaw && typeof currentMetaRaw === 'object' && !Array.isArray(currentMetaRaw))
                ? currentMetaRaw
                : {};
            base._meta = { ...currentMeta, ...(metaPatch && typeof metaPatch === 'object' ? metaPatch : {}) };
            return base;
        }

        async function assignPendencyToMe(pendencyId) {
            const pid = Number(pendencyId);
            if (!pid) return;

            if (!supabaseClient) {
                alert('Supabase indisponível. Não foi possível assumir a pendência.');
                return;
            }

            const myId = getCurrentUserIdString();
            if (!myId) {
                alert('Você precisa estar logado para assumir a pendência.');
                return;
            }

            const canManage = hasPermission('pendency.approve') || hasPermission('dashboard') || isCLevelRole(currentUser?.roles || currentUser?.role) || isDevRole(currentUser?.roles || currentUser?.role);
            if (!canManage) {
                alert('Você não tem permissão para assumir esta pendência.');
                return;
            }

            await ensurePendenciesLoaded(false);
            const pendency = state.pendencies.byId.get(String(pid));
            if (!pendency) {
                alert('Pendência não encontrada.');
                return;
            }

            const normalizedStatus = normalizePendencyStatusValue(pendency?.status, pendency);
            if (normalizedStatus === 'completed' || normalizedStatus === 'rejected') {
                alert('Esta pendência já foi finalizada e não pode ser assumida.');
                return;
            }

            const isCLevel = isCLevelRole(currentUser?.roles || currentUser?.role);
            const isDev = isDevRole(currentUser?.roles || currentUser?.role);
            const scope = getPendencyScope(pendency?.type);
            if (scope === 'financial' && !isCLevel) {
                alert('Pendências financeiras só podem ser assumidas por C-Level.');
                return;
            }
            if (scope === 'dev' && !(isDev || isCLevel)) {
                alert('Pendências de desenvolvimento só podem ser assumidas por Desenvolvedores ou C-Level.');
                return;
            }

            const requesterId = pendency?.userId ?? pendency?.user_id ?? null;
            if (isSameUserId(requesterId, myId)) {
                alert('Você não pode assumir a própria pendência.');
                return;
            }

            const existingAssignedId = String(pendency?.assignedUserId ?? pendency?.assigned_user_id ?? '').trim();
            const existingAssignedName = (pendency?.assignedUserName ?? pendency?.assigned_user_name ?? '').toString().trim();
            if (existingAssignedId && isSameUserId(existingAssignedId, myId)) {
                try { showToast({ title: '✅ Já está com você', message: `Pendência #${pid} já está atribuída para você.`, variant: 'success' }); } catch (e) {}
                return;
            }

            if (existingAssignedId && !isSameUserId(existingAssignedId, myId)) {
                const ok = confirm(`Esta pendência já está atribuída para ${existingAssignedName || ('ID ' + existingAssignedId)}. Deseja assumir mesmo assim?`);
                if (!ok) return;
            }

            return withIdempotency(`pendency:assign:${pid}`, async () => {
                try {
                    const nowIso = new Date().toISOString();
                    const destination = getEffectivePendencyArea(pendency) || inferPendencyAreaFromType(pendency?.type);
                    const assignedRole = destination === 'clevel'
                        ? 'clevel'
                        : (destination === 'dev' ? 'dev' : (isCLevel ? 'clevel' : (isDev ? 'dev' : null)));
                    const nextStatus = (normalizedStatus === 'pending' || normalizedStatus === 'approved')
                        ? 'in_progress'
                        : (normalizedStatus || 'in_progress');

                    const patch = {
                        assignedUserId: myId,
                        assignedUserName: String(currentUser?.displayName || currentUser?.name || '').trim() || `ID ${myId}`,
                        assignedAt: nowIso,
                        destination,
                        assignedRole,
                        status: nextStatus
                    };

                    const mergedAttachments = mergePendencyAttachmentsMeta(pendency.attachments, patch);

                    const isMissingColumn = (err, col) => {
                        const msg = (err?.message || '').toString().toLowerCase();
                        const c = String(col || '').toLowerCase();
                        return c && msg.includes(c) && (msg.includes('could not find') || msg.includes('does not exist') || msg.includes('schema cache'));
                    };

                    // Preferir salvar nos campos dedicados quando existirem (e manter meta em attachments para compatibilidade)
                    const updateBase = {
                        destination: destination || null,
                        assigned_role: assignedRole || null,
                        assigned_user_id: myId,
                        assigned_user_name: patch.assignedUserName,
                        status: nextStatus,
                        updated_at: nowIso,
                        attachments: mergedAttachments
                    };

                    const attemptUpdate = async (payload) => supabaseClient
                        .from('pendencies')
                        .update(payload)
                        .eq('id', pid)
                        .select('*')
                        .single();

                    let { data: saved, error } = await attemptUpdate(updateBase);
                    if (error && (
                        isMissingColumn(error, 'destination') ||
                        isMissingColumn(error, 'assigned_role') ||
                        isMissingColumn(error, 'assigned_user_id') ||
                        isMissingColumn(error, 'assigned_user_name')
                    )) {
                        console.warn('[pendencies] Colunas de atribuição/destino ausentes; assumindo apenas via attachments._meta.', error);
                        ({ data: saved, error } = await attemptUpdate({ status: nextStatus, updated_at: nowIso, attachments: mergedAttachments }));
                    } else if (error && isMissingColumn(error, 'attachments')) {
                        console.warn('[pendencies] Coluna attachments ausente; assumindo apenas via colunas assigned_*.', error);
                        ({ data: saved, error } = await attemptUpdate({
                            destination: destination || null,
                            assigned_role: assignedRole || null,
                            assigned_user_id: myId,
                            assigned_user_name: patch.assignedUserName,
                            status: nextStatus,
                            updated_at: nowIso
                        }));
                    } else if (error && isMissingColumn(error, 'updated_at')) {
                        console.warn('[pendencies] Coluna updated_at ausente; salvando sem updated_at.', error);
                        const withoutUpdatedAt = { ...updateBase };
                        delete withoutUpdatedAt.updated_at;
                        ({ data: saved, error } = await attemptUpdate(withoutUpdatedAt));
                    }

                    if (error) throw error;

                    const normalized = normalizePendencyRow(saved);
                    upsertItem(state.pendencies.byId, normalized);
                    refreshGlobalsForKey('txd_pendencies').catch(() => {});
                    renderPendencias();

                    const labelEl = document.getElementById('pendencyAssignedLabel');
                    if (labelEl) {
                        labelEl.innerHTML = escapeHtml(String(patch.assignedUserName));
                    }
                    const btnEl = document.getElementById('pendencyAssumeBtn');
                    if (btnEl) {
                        btnEl.classList.add('hidden');
                    }
                    const statusBadgeEl = document.getElementById('pendencyStatusBadge');
                    if (statusBadgeEl) {
                        const labels = { pending: 'Pendente', in_progress: 'Em Andamento', approved: 'Aprovada', completed: 'Concluída', rejected: 'Rejeitada' };
                        statusBadgeEl.textContent = labels[nextStatus] || nextStatus;
                    }

                    // Se a lista estiver aberta, garantir que o filtro fique "somente minhas" após assumir
                    try {
                        const assigneeEl = document.getElementById('pendencyAssigneeFilter');
                        if (assigneeEl) {
                            pendencyAssigneeFilterMode = 'mine';
                            assigneeEl.value = 'mine';
                        }
                        filterPendencies();
                    } catch (e) {}

                    // Notificação persistente para o solicitante (se existir inbox)
                    createNotification({
                        type: 'pendency_assigned',
                        title: '👤 Pendência assumida',
                        body: `#${pid} • ${(pendency?.title || 'Sem título')}\nResponsável: ${patch.assignedUserName}`,
                        audience: 'user',
                        audienceUserId: requesterId,
                        entityType: 'pendency',
                        entityId: pid,
                        metadata: {
                            actorUserId: myId,
                            actorName: String(currentUser?.displayName || currentUser?.name || ''),
                            status: nextStatus,
                            destination
                        }
                    }).catch(() => {});

                    try { showToast({ title: '✅ Pendência assumida', message: `Você assumiu a pendência #${pid}.`, variant: 'success' }); } catch (e) {}
                } catch (err) {
                    console.error('Erro ao assumir pendência:', err);
                    alert('Erro ao assumir pendência. Tente novamente.');
                }
            });
        }

        // ========== MINI-CHAT POR PENDÊNCIA ==========

        let pendencyChatChannel = null;
        let currentPendencyChatId = null;

        function teardownPendencyChat() {
            currentPendencyChatId = null;
            const statusEl = document.getElementById('pendencyChatStatus');
            const messagesEl = document.getElementById('pendencyChatMessages');
            if (statusEl) statusEl.textContent = '';
            if (messagesEl) messagesEl.innerHTML = '';

            if (supabaseClient && pendencyChatChannel) {
                try { supabaseClient.removeChannel(pendencyChatChannel); } catch (e) {}
            }
            pendencyChatChannel = null;
        }

        function getPendencyChatSenderLabel() {
            const name = (currentUser?.displayName || currentUser?.name || 'Usuário').toString();
            const role = (currentUser?.role || '').toString();
            return role ? `${name} (${role})` : name;
        }

        function isMyChatMessage(msg) {
            const myId = String(currentUser?.id ?? '');
            const msgId = String(msg?.senderId ?? msg?.sender_id ?? '');
            if (myId && msgId && myId === msgId) return true;

            const myName = (currentUser?.name || currentUser?.displayName || '').toString().trim().toLowerCase();
            const senderName = (msg?.senderName || msg?.sender_name || '').toString().trim().toLowerCase();
            return !!(myName && senderName && myName === senderName);
        }

        function renderPendencyChatMessages(messages) {
            const messagesEl = document.getElementById('pendencyChatMessages');
            if (!messagesEl) return;

            const list = Array.isArray(messages) ? messages : [];
            messagesEl.innerHTML = list.map(m => {
                const mine = isMyChatMessage(m);
                const sender = escapeHtml(m.senderName || m.sender_name || 'Usuário');
                const text = escapeHtml(m.message || '');
                const time = (() => {
                    const v = m.createdAt || m.created_at;
                    try { return v ? new Date(v).toLocaleString('pt-BR') : ''; } catch (e) { return ''; }
                })();

                return `
                    <div style="display: flex; flex-direction: column; align-items: ${mine ? 'flex-end' : 'flex-start'}; gap: 4px;">
                        <div style="font-size: 11px; color: var(--gray-text); padding: 0 6px;">
                            ${sender}${time ? ` • ${escapeHtml(time)}` : ''}
                        </div>
                        <div style="max-width: 85%; color: ${mine ? 'var(--white-soft)' : 'var(--gray-very-light)'}; padding: 2px 6px; font-size: 13px; line-height: 1.35; text-align: left; white-space: pre-wrap; word-break: break-word;">
                            ${text}
                        </div>
                    </div>
                `;
            }).join('') || `<div style="color: var(--gray-text); font-size: 13px; padding: 8px;">Nenhuma mensagem ainda.</div>`;

            // Scroll para o final
            try { messagesEl.scrollTop = messagesEl.scrollHeight; } catch (e) {}
        }

        async function loadPendencyChatMessages(pendencyId) {
            const statusEl = document.getElementById('pendencyChatStatus');
            if (statusEl) statusEl.textContent = 'Carregando chat…';

            if (!supabaseClient) {
                if (statusEl) statusEl.textContent = 'Supabase indisponível. Chat não está disponível.';
                renderPendencyChatMessages([]);
                return [];
            }

            const pid = Number(pendencyId);
            if (!pid) {
                if (statusEl) statusEl.textContent = 'ID da pendência inválido.';
                renderPendencyChatMessages([]);
                return [];
            }

            try {
                const { data, error } = await supabaseClient
                    .from('pendency_messages')
                    .select('*')
                    .eq('pendency_id', pid)
                    .order('created_at', { ascending: true });

                if (error) {
                    // Caso a tabela ainda não exista no Supabase
                    const msg = (error?.message || '').toString();
                    if (msg.toLowerCase().includes('relation') || msg.toLowerCase().includes('pendency_messages')) {
                        if (statusEl) statusEl.textContent = 'Tabela do chat não existe ainda. Execute o SQL de criação (criar_tabela_pendency_messages.sql) no Supabase.';
                    } else {
                        if (statusEl) statusEl.textContent = 'Erro ao carregar chat.';
                    }
                    console.warn('[pendency_chat] erro ao buscar mensagens:', error);
                    renderPendencyChatMessages([]);
                    return [];
                }

                if (statusEl) statusEl.textContent = '';
                const msgs = toCamelCase(data || []);
                renderPendencyChatMessages(msgs);
                return msgs;
            } catch (err) {
                console.warn('[pendency_chat] falha ao buscar mensagens:', err);
                if (statusEl) statusEl.textContent = 'Erro ao carregar chat.';
                renderPendencyChatMessages([]);
                return [];
            }
        }

        function subscribePendencyChat(pendencyId) {
            if (!supabaseClient) return;
            const pid = Number(pendencyId);
            if (!pid) return;

            // Remove canal anterior, se existir
            if (pendencyChatChannel) {
                try { supabaseClient.removeChannel(pendencyChatChannel); } catch (e) {}
                pendencyChatChannel = null;
            }

            // Assinar somente mensagens desta pendência
            pendencyChatChannel = supabaseClient
                .channel(`pendency_messages:${pid}`)
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'pendency_messages', filter: `pendency_id=eq.${pid}` },
                    () => {
                        // Recarrega mensagens quando houver mudança (simples e confiável)
                        loadPendencyChatMessages(pid).catch(() => {});
                    }
                )
                .subscribe();
        }

        async function setupPendencyChat(pendencyId) {
            const pid = Number(pendencyId);
            if (!pid) return;

            if (currentPendencyChatId && Number(currentPendencyChatId) === pid) {
                return;
            }

            currentPendencyChatId = pid;
            await loadPendencyChatMessages(pid);
            subscribePendencyChat(pid);
        }

        async function sendPendencyChatMessage(event, pendencyId) {
            event.preventDefault();

            const statusEl = document.getElementById('pendencyChatStatus');
            const input = document.getElementById('pendencyChatInput');
            if (!input) return;

            const text = (input.value || '').toString().trim();
            if (!text) return;

            if (!currentUser || !currentUser.role) {
                if (statusEl) statusEl.textContent = 'Você precisa estar logado para enviar mensagens.';
                return;
            }

            if (!supabaseClient) {
                if (statusEl) statusEl.textContent = 'Supabase indisponível. Não foi possível enviar.';
                return;
            }

            const pid = Number(pendencyId);
            if (!pid) {
                if (statusEl) statusEl.textContent = 'ID da pendência inválido.';
                return;
            }

            input.disabled = true;
            const submitBtn = document.querySelector('#pendencyChatForm button[type="submit"]');
            if (submitBtn) submitBtn.disabled = true;

            try {
                const payload = {
                    pendency_id: pid,
                    sender_id: String(currentUser?.id ?? ''),
                    sender_name: getPendencyChatSenderLabel(),
                    message: text
                };

                const { error } = await supabaseClient
                    .from('pendency_messages')
                    .insert(payload);

                if (error) {
                    console.warn('[pendency_chat] erro ao enviar:', error);
                    const msg = (error?.message || '').toString();
                    if (msg.toLowerCase().includes('relation') || msg.toLowerCase().includes('pendency_messages')) {
                        if (statusEl) statusEl.textContent = 'Tabela do chat não existe ainda. Execute o SQL de criação (criar_tabela_pendency_messages.sql) no Supabase.';
                    } else {
                        if (statusEl) statusEl.textContent = 'Erro ao enviar mensagem.';
                    }
                    return;
                }

                // Notificação persistente (se o inbox existir)
                try {
                    if (notificationsSupported === null) await detectNotificationsSupport();
                    if (notificationsSupported === true) {
                        await ensurePendenciesLoaded(false);
                        const pendency = state.pendencies.byId.get(String(pid));
                        const pendencyUserId = pendency?.userId ?? pendency?.user_id ?? null;
                        const handlerUserId = (pendency?.assignedUserId ?? pendency?.assigned_user_id ?? null);
                        const meId = getCurrentUserIdString();
                        const isOwner = isSameUserId(pendencyUserId, meId);
                        const isHandler = handlerUserId ? isSameUserId(handlerUserId, meId) : false;
                        const msgPreview = text.length > 140 ? (text.slice(0, 140) + '…') : text;

                        if (isHandler && pendencyUserId && !isSameUserId(pendencyUserId, meId)) {
                            // Responsável -> avisar solicitante
                            createNotification({
                                type: 'pendency_message',
                                title: '💬 Nova mensagem na sua pendência',
                                body: `#${pid} • ${(pendency?.title || 'Sem título')}\n${msgPreview}`,
                                audience: 'user',
                                audienceUserId: pendencyUserId,
                                entityType: 'pendency',
                                entityId: pid,
                                metadata: {
                                    actorUserId: getCurrentUserIdString(),
                                    actorName: String(currentUser?.displayName || currentUser?.name || ''),
                                    sender: getPendencyChatSenderLabel(),
                                    suppressSelf: true
                                }
                            }).catch(() => {});
                        } else if (isOwner && handlerUserId && !isSameUserId(handlerUserId, meId)) {
                            // Solicitante -> avisar responsável (quem assumiu)
                            createNotification({
                                type: 'pendency_message',
                                title: '💬 Nova mensagem na pendência',
                                body: `#${pid} • ${(pendency?.title || 'Sem título')}\n${msgPreview}`,
                                audience: 'user',
                                audienceUserId: String(handlerUserId),
                                entityType: 'pendency',
                                entityId: pid,
                                metadata: {
                                    actorUserId: getCurrentUserIdString(),
                                    actorName: String(currentUser?.displayName || currentUser?.name || ''),
                                    sender: getPendencyChatSenderLabel(),
                                    suppressSelf: true
                                }
                            }).catch(() => {});
                        }
                    }
                } catch (e) {}

                input.value = '';
                if (statusEl) statusEl.textContent = '';

                // O realtime normalmente atualiza; mas por garantia, recarrega
                await loadPendencyChatMessages(pid);
            } catch (err) {
                console.warn('[pendency_chat] falha ao enviar:', err);
                if (statusEl) statusEl.textContent = 'Erro ao enviar mensagem.';
            } finally {
                input.disabled = false;
                if (submitBtn) submitBtn.disabled = false;
                try { input.focus(); } catch (e) {}
            }
        }
        
        function openAnnouncement() {
            if (!hasPermission('announcement.create')) {
                alert('Você não tem permissão para enviar avisos.');
                return;
            }
            document.getElementById('announcementForm').reset();
            document.getElementById('announcementModal').classList.add('active');
        }

        function saveAnnouncement(event) {
            event.preventDefault();
            if (!hasPermission('announcement.create')) {
                alert('Você não tem permissão para esta ação.');
                return;
            }

            const announcement = {
                id: Date.now(),
                title: document.getElementById('announcementTitle').value,
                priority: document.getElementById('announcementPriority').value,
                message: document.getElementById('announcementMessage').value,
                author: currentUser.name,
                createdAt: new Date().toISOString()
            };

            announcementsData.push(announcement);
            saveData('txd_announcements', announcementsData);
            closeModal('announcementModal');
            alert('Aviso enviado com sucesso!');
        }

        function openNewStaff() {
            if (!hasPermission('staff.create')) {
                alert('Você não tem permissão para adicionar membros.');
                return;
            }
            document.getElementById('staffId').value = '';
            document.getElementById('staffModalTitle').textContent = 'Adicionar Membro';
            document.getElementById('staffForm').reset();
            // Mostrar campos de login e senha para novo cadastro
            document.getElementById('staffLoginGroup').style.display = 'block';
            document.getElementById('staffPasswordGroup').style.display = 'block';
            document.getElementById('staffLogin').required = true;
            document.getElementById('staffPassword').required = true;
            document.getElementById('staffModal').classList.add('active');
        }

        function editStaff(id) {
            if (!hasPermission('staff.edit')) {
                alert('Você não tem permissão para editar membros.');
                return;
            }
            const member = staffData.find(s => String(s.id) === String(id));
            if (member) {
                document.getElementById('staffId').value = member.id;
                document.getElementById('staffModalTitle').textContent = 'Editar Membro';
                document.getElementById('staffName').value = member.name;
                document.getElementById('staffRole').value = member.role;
                // Selecionar cargos adicionais (se houver)
                try {
                    const extrasSelect = document.getElementById('staffExtraRoles');
                    if (extrasSelect) {
                        const roles = getStaffRoles(member);
                        const primary = (member.role || '').toString().trim();
                        const extras = roles.filter(r => r && r !== primary);
                        Array.from(extrasSelect.options).forEach(opt => {
                            opt.selected = extras.includes(opt.value);
                        });
                    }
                } catch (e) {
                    console.warn('Falha ao carregar cargos adicionais:', e);
                }
                document.getElementById('staffArea').value = member.area;
                document.getElementById('staffStatus').value = member.status;
                document.getElementById('staffEmail').value = member.email || '';
                // Esconder campos de login e senha na edição (mudar no perfil)
                document.getElementById('staffLoginGroup').style.display = 'none';
                document.getElementById('staffPasswordGroup').style.display = 'none';
                document.getElementById('staffLogin').required = false;
                document.getElementById('staffPassword').required = false;
                document.getElementById('staffModal').classList.add('active');
            }
        }

        function saveStaff(event) {
            event.preventDefault();
            const isEdit = document.getElementById('staffId').value;
            
            if (isEdit && !hasPermission('staff.edit')) {
                alert('Você não tem permissão para editar membros.');
                return;
            }
            if (!isEdit && !hasPermission('staff.create')) {
                alert('Você não tem permissão para adicionar membros.');
                return;
            }

            // Validar login e senha para novo cadastro
            if (!isEdit) {
                const login = document.getElementById('staffLogin').value.trim();
                const password = document.getElementById('staffPassword').value;
                
                if (!login || !password) {
                    alert('Login e senha são obrigatórios para novo cadastro.');
                    return;
                }
                
                if (password.length < 4) {
                    alert('A senha deve ter pelo menos 4 caracteres.');
                    return;
                }
                
                // Verificar se o login já existe
                const existingStaff = getData('txd_staff') || [];
                if (Array.isArray(existingStaff) && existingStaff.some(s => s && (s.name === login || s.login === login))) {
                    alert('Este login já está em uso. Escolha outro.');
                    return;
                }
            }
            
            const primaryRole = document.getElementById('staffRole').value;
            const extraRoles = Array.from(document.getElementById('staffExtraRoles')?.selectedOptions || [])
                .map(o => o.value)
                .filter(Boolean);
            const roles = Array.from(new Set([primaryRole, ...extraRoles].filter(Boolean)));

            const staffMember = {
                id: isEdit ? parseInt(isEdit) : Date.now(),
                name: document.getElementById('staffName').value,
                role: primaryRole,
                roles,
                area: document.getElementById('staffArea').value,
                status: document.getElementById('staffStatus').value,
                email: document.getElementById('staffEmail').value
            };
            
            // Adicionar login e senha apenas para novo cadastro
            if (!isEdit) {
                staffMember.login = document.getElementById('staffLogin').value.trim();
                staffMember.password = document.getElementById('staffPassword').value;
                staffMember.displayName = staffMember.name;
                staffMember.createdAt = new Date().toISOString();
                staffMember.status = 'Ativo';
            }

            if (isEdit) {
                const index = staffData.findIndex(s => s.id === staffMember.id);
                if (index !== -1) {
                    staffData[index] = staffMember;
                }
                const roleLabel = (Array.isArray(staffMember.roles) && staffMember.roles.length > 0)
                    ? staffMember.roles.join(' + ')
                    : (staffMember.role || '');
                
                // Notificar Discord sobre edição
                sendDiscordNotification('staff', '✏️ Staff Editado', 
                    `${currentUser.name} editou informações de um membro`,
                    [
                        { name: '👤 Membro', value: staffMember.name, inline: true },
                        { name: '🎖️ Cargo', value: roleLabel || staffMember.role, inline: true },
                        { name: '📊 Status', value: staffMember.status, inline: true },
                        { name: '🏢 Área', value: staffMember.area, inline: false },
                        { name: '👨‍💼 Editado por', value: currentUser.name, inline: false }
                    ]
                );
            } else {
                staffData.push(staffMember);
                const roleLabel = (Array.isArray(staffMember.roles) && staffMember.roles.length > 0)
                    ? staffMember.roles.join(' + ')
                    : (staffMember.role || '');
                
                // Notificar Discord sobre novo membro
                sendDiscordNotification('staff', '✨ Novo Membro Adicionado', 
                    `${currentUser.name} adicionou um novo membro à equipe`,
                    [
                        { name: '👤 Nome', value: staffMember.name, inline: true },
                        { name: '🎖️ Cargo', value: roleLabel || staffMember.role, inline: true },
                        { name: '📊 Status', value: staffMember.status, inline: true },
                        { name: '🏢 Área', value: staffMember.area, inline: false },
                        { name: '📧 E-mail', value: staffMember.email, inline: false },
                        { name: '👨‍💼 Adicionado por', value: currentUser.name, inline: false }
                    ]
                );
            }

            saveData('txd_staff', staffData);
            closeModal('staffModal');
            loadStaffControl();
            if (document.getElementById('sectionTitle').textContent === 'Dashboard') {
                loadDashboard();
            }
            alert('Membro salvo com sucesso!');
        }

        let deleteItemId = null;
        let deleteItemType = null;

        function deleteStaff(id) {
            if (!hasPermission('staff.delete')) {
                alert('Você não tem permissão para excluir membros.');
                return;
            }
            const member = staffData.find(s => String(s.id) === String(id));
            if (member) {
                deleteItemId = id;
                deleteItemType = 'staff';
                document.getElementById('deleteMessage').textContent = `Tem certeza que deseja excluir ${member.name}? Esta ação não pode ser desfeita.`;
                document.getElementById('deleteModal').classList.add('active');
            }
        }

        function deleteEvent(id) {
            if (!hasPermission('event.delete')) {
                alert('Você não tem permissão para excluir eventos.');
                return;
            }
            // Garantir que eventsData é um array
            if (!Array.isArray(eventsData)) eventsData = [];
            const event = eventsData.find(e => e.id === id);
            if (event) {
                deleteItemId = id;
                deleteItemType = 'event';
                document.getElementById('deleteMessage').textContent = `Tem certeza que deseja excluir o evento "${event.title}"? Esta ação não pode ser desfeita.`;
                document.getElementById('deleteModal').classList.add('active');
            }
        }

        async function confirmDelete() {
            if (deleteItemType === 'staff') {
                const deletedMember = staffData.find(s => String(s.id) === String(deleteItemId));
                try {
                    if (supabaseClient && deleteItemId !== null && deleteItemId !== undefined) {
                        const { error } = await supabaseClient
                            .from('staff')
                            .delete()
                            .eq('id', deleteItemId);
                        if (error) throw error;
                        clearCacheKey('txd_staff');
                    } else {
                        console.warn('Supabase não inicializado ou ID inválido para exclusão.');
                    }
                } catch (error) {
                    console.error('Erro ao excluir staff no Supabase:', error);
                    alert('Erro ao excluir membro. Verifique o console.');
                    closeModal('deleteModal');
                    deleteItemId = null;
                    deleteItemType = null;
                    return;
                }

                staffData = staffData.filter(s => String(s.id) !== String(deleteItemId));
                loadStaffControl();
                
                // Notificar Discord sobre exclusão
                if (deletedMember) {
                    sendDiscordNotification('staff', '❌ Staff Removido', 
                        `${currentUser.name} removeu um membro da equipe`,
                        [
                            { name: '👤 Membro Removido', value: deletedMember.name, inline: true },
                            { name: '🎖️ Cargo', value: deletedMember.role, inline: true },
                            { name: '👨‍💼 Removido por', value: currentUser.name, inline: false },
                            { name: '🕐 Horário', value: new Date().toLocaleString('pt-BR'), inline: false }
                        ]
                    );
                }
            } else if (deleteItemType === 'event') {
                // Garantir que eventsData é um array
                if (!Array.isArray(eventsData)) eventsData = [];
                const deletedEvent = eventsData.find(e => e.id === deleteItemId);
                eventsData = eventsData.filter(e => e.id !== deleteItemId);
                saveData('txd_events', eventsData);
                loadAgenda();
                
                // Notificar Discord sobre exclusão de evento
                if (deletedEvent) {
                    sendDiscordNotification('events', '❌ Evento Cancelado', 
                        `${currentUser.name} cancelou um evento`,
                        [
                            { name: '📅 Evento', value: deletedEvent.title, inline: false },
                            { name: '📝 Descrição', value: deletedEvent.description || 'Sem descrição', inline: false },
                            { name: '👨‍💼 Cancelado por', value: currentUser.name, inline: false },
                            { name: '🕐 Horário', value: new Date().toLocaleString('pt-BR'), inline: false }
                        ]
                    );
                }
            }
            closeModal('deleteModal');
            deleteItemId = null;
            deleteItemType = null;
            alert('Item excluído com sucesso!');
        }

        function openAssignFunctions() {
            alert('Funcionalidade de atribuir funções será implementada em breve.');
        }

        function syncSystem() {
            if (!hasPermission('all')) {
                alert('Apenas administradores podem sincronizar o sistema.');
                return;
            }
            if (confirm('Deseja sincronizar o sistema agora?')) {
                // Simular sincronização
                setTimeout(() => {
                    alert('Sistema sincronizado com sucesso!');
                }, 1000);
            }
        }

        // ========== SISTEMA KANBAN ==========
        // Variáveis globais para drag and drop (declaradas mais abaixo)
        // let draggedCard = null;
        // let draggedCardElement = null;

        async function getKanbanData() {
            // Buscar dados do Supabase (forçar refresh)
            let data = await getData('txd_kanban', true);
            
            // Garantir estrutura correta (sem fallback local/demo)
            if (!data || typeof data !== 'object') {
                data = { columns: [], cards: [] };
            }
            
            // Garantir que cards é sempre um array
            if (!Array.isArray(data.cards)) {
                data.cards = [];
            }
            
            // Garantir que columns é sempre um array
            if (!Array.isArray(data.columns)) {
                data.columns = [
                    { id: 'todo', name: 'Para Fazer', color: '#6F7276' },
                    { id: 'inprogress', name: 'Em Progresso', color: '#ffaa00' },
                    { id: 'review', name: 'Em Revisão', color: '#3b82f6' },
                    { id: 'done', name: 'Concluído', color: '#00ff88' }
                ];
            }

            // Se não houver colunas no banco, cria o padrão uma única vez
            if (data.columns.length === 0) {
                data.columns = [
                    { id: 'todo', name: 'Para Fazer', color: '#6F7276', position: 0 },
                    { id: 'inprogress', name: 'Em Progresso', color: '#ffaa00', position: 1 },
                    { id: 'review', name: 'Em Revisão', color: '#3b82f6', position: 2 },
                    { id: 'done', name: 'Concluído', color: '#00ff88', position: 3 }
                ];
                await saveData('txd_kanban', data);
            }
            
            return data;
        }

        async function saveKanbanData(data) {
            await saveData('txd_kanban', data);
        }

        function getSelectValues(selectEl) {
            if (!selectEl) return [];
            const options = Array.from(selectEl.selectedOptions || []);
            return options
                .map(opt => String(opt.value || '').trim())
                .filter(v => v && v !== '');
        }

        function normalizeKanbanCardForState(cardRow, assigneesOverride = null) {
            const c = toCamelCase(cardRow || {});
            const id = Number(c.id);
            const assignees = Array.isArray(assigneesOverride)
                ? assigneesOverride
                : (Array.isArray(c.assignees) ? c.assignees : (c.assignee ? [c.assignee] : []));
            return {
                ...c,
                id,
                columnId: c.columnId || c.column_id || 'todo',
                dueDate: c.dueDate || c.due_date || null,
                tags: Array.isArray(c.tags) ? c.tags : (c.tags ? c.tags : []),
                assignees
            };
        }

        async function persistKanbanCard(cardData) {
            if (!supabaseClient) throw new Error('Supabase não inicializado');
            const id = Number(cardData?.id);
            if (!id) throw new Error('ID inválido para tarefa');

            const previousAssignees = state.kanban.assigneesByCardId.get(String(id)) || [];

            const assignees = Array.isArray(cardData.assignees)
                ? cardData.assignees
                : (cardData.assignee ? [cardData.assignee] : []);
            const uniqueAssignees = [...new Set(assignees.map(a => String(a).trim()).filter(Boolean))];

            const row = {
                id,
                column_id: String(cardData.columnId || 'todo'),
                title: String(cardData.title || '').trim(),
                description: (cardData.description ?? '').toString(),
                priority: (cardData.priority ?? '').toString(),
                due_date: cardData.dueDate || null,
                tags: Array.isArray(cardData.tags) ? cardData.tags : []
            };

            const { data: saved, error: upsertError } = await supabaseClient
                .from('kanban_cards')
                .upsert(row, { onConflict: 'id' })
                .select('*')
                .single();
            if (upsertError) {
                console.error('[kanban] Erro ao upsert card:', { upsertError, row });
                throw upsertError;
            }

            // Assignees (tabela separada) - manter idempotente e sem duplicar
            const { error: deleteAssigneesError } = await supabaseClient
                .from('kanban_card_assignees')
                .delete()
                .eq('card_id', id);
            if (deleteAssigneesError) {
                console.warn('[kanban] Aviso ao limpar assignees:', deleteAssigneesError);
            }

            if (uniqueAssignees.length > 0) {
                const assigneesRows = uniqueAssignees.map(name => ({
                    card_id: id,
                    assignee_name: name
                }));
                const { error: assigneesError } = await supabaseClient
                    .from('kanban_card_assignees')
                    .upsert(assigneesRows, { onConflict: 'card_id,assignee_name' });
                if (assigneesError) {
                    console.warn('[kanban] Aviso ao salvar assignees:', assigneesError);
                }
            }

            // Atualizar state imediatamente (realtime também vai confirmar)
            const normalized = normalizeKanbanCardForState(saved, uniqueAssignees);
            upsertItem(state.kanban.cardsById, normalized);
            state.kanban.assigneesByCardId.set(String(id), uniqueAssignees);
            clearCacheKey('txd_kanban');

            // Notificação persistente: nova tarefa atribuída (apenas novos assignees)
            try {
                if (notificationsSupported === null) await detectNotificationsSupport();
                if (notificationsSupported === true) {
                    const prev = Array.isArray(previousAssignees) ? previousAssignees : [];
                    const isSame = (a, b) => normalizeText(a) === normalizeText(b);
                    const newlyAssigned = uniqueAssignees.filter(name => !prev.some(p => isSame(p, name)));

                    const staffArray = Array.isArray(staffData) ? staffData : [];
                    for (const assigneeName of newlyAssigned) {
                        const staffMatch = staffArray.find(s => {
                            const candidates = [
                                s?.displayName,
                                s?.name,
                                s?.login
                            ].map(v => normalizeText(v)).filter(Boolean);
                            const target = normalizeText(assigneeName);
                            return target && candidates.includes(target);
                        });
                        const targetUserId = staffMatch?.id;
                        if (!targetUserId) continue;
                        if (isSameUserId(targetUserId, getCurrentUserIdString())) continue;

                        createNotification({
                            type: 'task_assigned',
                            title: '✅ Nova tarefa atribuída',
                            body: `#${id} • ${(normalized.title || 'Sem título')}`,
                            audience: 'user',
                            audienceUserId: String(targetUserId),
                            entityType: 'task',
                            entityId: id,
                            metadata: {
                                actorUserId: getCurrentUserIdString(),
                                actorName: String(currentUser?.displayName || currentUser?.name || ''),
                                assigneeName: String(assigneeName)
                            }
                        }).catch(() => {});
                    }
                }
            } catch (e) {}

            return normalized;
        }

        async function updateKanbanCardColumn(cardId, newColumnId) {
            if (!supabaseClient) throw new Error('Supabase não inicializado');
            const id = Number(cardId);
            if (!id) throw new Error('ID inválido');
            const columnId = String(newColumnId || 'todo');

            const { data: updated, error } = await supabaseClient
                .from('kanban_cards')
                .update({ column_id: columnId, updated_at: new Date().toISOString() })
                .eq('id', id)
                .select('*')
                .single();
            if (error) {
                console.error('[kanban] Erro ao mover card:', { id, columnId, error });
                throw error;
            }

            const normalized = normalizeKanbanCardForState(updated);
            upsertItem(state.kanban.cardsById, normalized);
            clearCacheKey('txd_kanban');
            return normalized;
        }

        async function populateCardAssigneeOptions(selectedValues = []) {
            const assigneeSelect = document.getElementById('cardAssignee');
            if (!assigneeSelect) return;

            const staff = await getData('txd_staff', true);
            const staffArray = Array.isArray(staff) ? staff : [];
            const activeStaff = staffArray.filter(m => m && (m.status === 'Ativo' || m.status === 'ativo' || !m.status));

            const normalizedSelected = Array.isArray(selectedValues)
                ? selectedValues.map(v => String(v).trim()).filter(Boolean)
                : [];

            const optionsHtml = activeStaff.map(member => {
                const label = (member.displayName || member.name || member.login || '').toString().trim();
                if (!label) return '';
                const roleSuffix = member.role ? ` (${member.role})` : '';
                const selected = normalizedSelected.includes(label) ? 'selected' : '';
                return `<option value="${escapeHtml(label)}" ${selected}>${escapeHtml(label + roleSuffix)}</option>`;
            }).filter(Boolean).join('');

            assigneeSelect.innerHTML = '<option value="">Sem responsável</option>' + optionsHtml;
            // Multi-select: marcar selecionados explicitamente
            if (normalizedSelected.length > 0) {
                Array.from(assigneeSelect.options).forEach(opt => {
                    const v = String(opt.value || '').trim();
                    opt.selected = v && normalizedSelected.includes(v);
                });
            }
        }

        async function openNewCard(columnId = null) {
            // Permitir criação para qualquer usuário logado (Kanban deve ser acessível)
            // Se não tiver permissão específica, ainda permite criar
            const canCreate = hasPermission('task.create') || hasPermission('dashboard') || currentUser?.role;
            if (!canCreate) {
                alert('Você precisa estar logado para criar tarefas.');
                return;
            }
            
            // Garantir que os elementos existem
            const cardIdInput = document.getElementById('cardId');
            const cardModalTitle = document.getElementById('cardModalTitle');
            const cardColumnIdInput = document.getElementById('cardColumnId');
            const cardForm = document.getElementById('cardForm');
            const cardModal = document.getElementById('cardModal');
            
            if (!cardIdInput || !cardModalTitle || !cardColumnIdInput || !cardForm || !cardModal) {
                console.error('Elementos do modal de tarefa não encontrados');
                alert('Erro ao abrir modal de tarefa. Recarregue a página.');
                return;
            }
            
            cardModalTitle.textContent = 'Nova Tarefa';
            cardColumnIdInput.value = columnId || 'todo';
            cardForm.reset();
            cardForm.dataset.mode = 'create';
            // Gerar ID uma única vez (evita duplicação em double-click / submits repetidos)
            cardIdInput.value = String(Date.now());
            
            // Atualizar lista de responsáveis
            await populateCardAssigneeOptions([]);
            
            cardModal.classList.add('active');
        }

        function addCardToColumn(columnId) {
            openNewCard(columnId);
        }

        async function openEditCard(cardId) {
            // Permitir edição para qualquer usuário logado
            const canEdit = hasPermission('task.edit') || hasPermission('dashboard') || currentUser?.role;
            if (!canEdit) {
                alert('Você precisa estar logado para editar tarefas.');
                return;
            }
            await ensureKanbanLoaded(false);
            const kanbanData = getKanbanSnapshotFromState();
            if (!kanbanData || !Array.isArray(kanbanData.cards)) {
                alert('Erro ao carregar dados do Kanban.');
                return;
            }
            
            const card = kanbanData.cards.find(c => c && c.id == cardId);
            if (!card) {
                alert('Tarefa não encontrada.');
                return;
            }
            
            // Garantir que os elementos existem
            const cardIdInput = document.getElementById('cardId');
            const cardModalTitle = document.getElementById('cardModalTitle');
            const cardColumnIdInput = document.getElementById('cardColumnId');
            const cardTitleInput = document.getElementById('cardTitle');
            const cardDescriptionInput = document.getElementById('cardDescription');
            const cardPriorityInput = document.getElementById('cardPriority');
            const cardDueDateInput = document.getElementById('cardDueDate');
            const cardAssigneeInput = document.getElementById('cardAssignee');
            const cardTagsInput = document.getElementById('cardTags');
            const cardModal = document.getElementById('cardModal');
            
            if (!cardIdInput || !cardModalTitle || !cardColumnIdInput || !cardTitleInput || !cardModal) {
                console.error('Elementos do modal de tarefa não encontrados');
                alert('Erro ao abrir modal de tarefa. Recarregue a página.');
                return;
            }
            
            cardIdInput.value = card.id;
            cardModalTitle.textContent = 'Editar Tarefa';
            const cardForm = document.getElementById('cardForm');
            if (cardForm) cardForm.dataset.mode = 'edit';
            cardColumnIdInput.value = card.columnId || 'todo';
            cardTitleInput.value = card.title || '';
            if (cardDescriptionInput) cardDescriptionInput.value = card.description || '';
            if (cardPriorityInput) cardPriorityInput.value = card.priority || '';
            if (cardDueDateInput) cardDueDateInput.value = card.dueDate || '';
            if (cardTagsInput) cardTagsInput.value = (card.tags && Array.isArray(card.tags)) ? card.tags.join(', ') : '';
            
            // Atualizar lista de responsáveis
            const selectedAssignees = Array.isArray(card.assignees)
                ? card.assignees
                : (card.assignee ? [card.assignee] : []);
            await populateCardAssigneeOptions(selectedAssignees);
            
            cardModal.classList.add('active');
        }

        async function saveCard(event) {
            event.preventDefault();
            
            try {
                const cardIdInput = document.getElementById('cardId');
                const cardColumnIdInput = document.getElementById('cardColumnId');
                const cardTitleInput = document.getElementById('cardTitle');
                const cardDescriptionInput = document.getElementById('cardDescription');
                const cardPriorityInput = document.getElementById('cardPriority');
                const cardDueDateInput = document.getElementById('cardDueDate');
                const cardAssigneeInput = document.getElementById('cardAssignee');
                const cardTagsInput = document.getElementById('cardTags');
                
                if (!cardIdInput || !cardColumnIdInput || !cardTitleInput) {
                    alert('Erro: Elementos do formulário não encontrados. Recarregue a página.');
                    return;
                }
                
                const cardId = cardIdInput.value;
                const mode = document.getElementById('cardForm')?.dataset?.mode || '';
                const isEdit = mode === 'edit';
                
                // Verificar permissões (permitir para usuários logados)
                const canEdit = hasPermission('task.edit') || hasPermission('dashboard') || currentUser?.role;
                const canCreate = hasPermission('task.create') || hasPermission('dashboard') || currentUser?.role;
                
                if (isEdit && !canEdit) {
                    alert('Você não tem permissão para editar tarefas.');
                    return;
                }
                if (!isEdit && !canCreate) {
                    alert('Você não tem permissão para criar tarefas.');
                    return;
                }
                
                // Validar título (obrigatório)
                const title = cardTitleInput.value.trim();
                if (!title) {
                    alert('Por favor, preencha o título da tarefa.');
                    cardTitleInput.focus();
                    return;
                }
                
                await ensureKanbanLoaded(false);
                const id = parseInt(cardId) || Date.now();
                const existing = state.kanban.cardsById.get(String(id));

                const selectedAssignees = getSelectValues(cardAssigneeInput);

                const cardData = {
                    id,
                    columnId: cardColumnIdInput.value || 'todo',
                    title: title,
                    description: cardDescriptionInput ? cardDescriptionInput.value : '',
                    priority: cardPriorityInput ? cardPriorityInput.value : '',
                    assignee: selectedAssignees[0] || '',
                    assignees: selectedAssignees,
                    tags: cardTagsInput ? cardTagsInput.value.split(',').map(t => t.trim()).filter(t => t) : [],
                    createdAt: existing?.createdAt || existing?.created_at || new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                if (cardDueDateInput && cardDueDateInput.value && cardDueDateInput.value.trim() !== '') {
                    cardData.dueDate = cardDueDateInput.value;
                }

                const opKey = `kanban:save:${id}`;
                const submitter = event?.submitter;
                if (submitter) submitter.disabled = true;
                try {
                    await withIdempotency(opKey, async () => {
                        const saved = await persistKanbanCard(cardData);

                        const discordConfig = getDiscordConfig();
                        if (discordConfig && discordConfig.enabled && discordConfig.notifications && discordConfig.notifications.tasks) {
                            const columnName = state.kanban.columnsById.get(String(saved.columnId))?.name || saved.columnId;
                            if (isEdit) {
                                sendDiscordNotification('tasks', '✏️ Tarefa Editada',
                                    `${currentUser.name} editou uma tarefa`,
                                    [
                                        { name: '📋 Tarefa', value: saved.title, inline: false },
                                        { name: '📝 Descrição', value: saved.description || 'Sem descrição', inline: false },
                                        { name: '📊 Coluna', value: columnName, inline: true },
                                        { name: '⚡ Prioridade', value: saved.priority === 'high' ? '🔴 Alta' : saved.priority === 'medium' ? '🟡 Média' : '🟢 Baixa', inline: true },
                                        { name: '📅 Prazo', value: saved.dueDate || 'Sem prazo', inline: true },
                                        { name: '👤 Responsável', value: saved.assignees?.[0] || 'Não atribuído', inline: true },
                                        { name: '👨‍💼 Editado por', value: currentUser.name, inline: true }
                                    ]
                                );
                            } else {
                                sendDiscordNotification('tasks', '✨ Nova Tarefa Criada',
                                    `${currentUser.name} criou uma nova tarefa`,
                                    [
                                        { name: '📋 Tarefa', value: saved.title, inline: false },
                                        { name: '📝 Descrição', value: saved.description || 'Sem descrição', inline: false },
                                        { name: '📊 Coluna', value: columnName, inline: true },
                                        { name: '⚡ Prioridade', value: saved.priority === 'high' ? '🔴 Alta' : saved.priority === 'medium' ? '🟡 Média' : '🟢 Baixa', inline: true },
                                        { name: '📅 Prazo', value: saved.dueDate || 'Sem prazo', inline: true },
                                        { name: '👤 Responsável', value: saved.assignees?.[0] || 'Não atribuído', inline: true },
                                        { name: '🏷️ Tags', value: Array.isArray(saved.tags) && saved.tags.length > 0 ? saved.tags.join(', ') : 'Sem tags', inline: false },
                                        { name: '👨‍💼 Criado por', value: currentUser.name, inline: true }
                                    ]
                                );
                            }
                        }
                    });
                } finally {
                    if (submitter) submitter.disabled = false;
                }

                closeModal('cardModal');
                renderTarefas();
                alert('Tarefa salva com sucesso!');
                
            } catch (error) {
                console.error('Erro ao salvar tarefa:', error);
                alert('Erro ao salvar tarefa: ' + (error.message || 'Erro desconhecido'));
            }
        }

        async function deleteCard(cardId) {
            // Permitir exclusão para usuários com permissão ou Owner/CEO
            const canDelete = hasPermission('task.delete') || currentUser?.role === 'Owner' || currentUser?.role === 'CEO';
            if (!canDelete) {
                alert('Você não tem permissão para excluir tarefas.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir esta tarefa?')) return;
            
            try {
                await ensureKanbanLoaded(false);
                const id = Number(cardId);
                const deletedCard = state.kanban.cardsById.get(String(id));

                const opKey = `kanban:delete:${id}`;
                await withIdempotency(opKey, async () => {
                    if (!supabaseClient) throw new Error('Supabase não inicializado');

                    // Deletar assignees primeiro (cascade)
                    const { error: deleteAssigneesError } = await supabaseClient
                        .from('kanban_card_assignees')
                        .delete()
                        .eq('card_id', id);
                    if (deleteAssigneesError) {
                        console.warn('[kanban] Aviso ao deletar assignees:', deleteAssigneesError.message);
                    }

                    const { error: deleteError } = await supabaseClient
                        .from('kanban_cards')
                        .delete()
                        .eq('id', id);
                    if (deleteError) {
                        console.error('[kanban] Erro ao deletar card:', { id, deleteError });
                        throw deleteError;
                    }

                    removeItem(state.kanban.cardsById, id);
                    state.kanban.assigneesByCardId.delete(String(id));
                    clearCacheKey('txd_kanban');
                    renderTarefas();
                });

                // Notificar Discord sobre exclusão (apenas se Discord estiver habilitado)
                if (deletedCard) {
                    const discordConfig = getDiscordConfig();
                    if (discordConfig && discordConfig.enabled && discordConfig.notifications && discordConfig.notifications.tasks) {
                        sendDiscordNotification('tasks', '❌ Tarefa Excluída',
                            `${currentUser?.name || 'Usuário'} excluiu uma tarefa`,
                            [
                                { name: '📋 Tarefa', value: deletedCard.title || 'Sem título', inline: false },
                                { name: '👨‍💼 Excluído por', value: currentUser?.name || 'Usuário', inline: true }
                            ]
                        );
                    }
                }
            } catch (error) {
                console.error('Erro ao excluir tarefa:', error);
                alert('Erro ao excluir tarefa: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Drag and Drop
        let draggedCard = null;
        let draggedCardElement = null;
        
        function handleDragStart(event) {
            // Encontrar o card correto (pode ser clicado em um elemento filho)
            const cardElement = event.target.closest('.kanban-card');
            if (!cardElement) {
                event.preventDefault();
                return;
            }
            
            draggedCard = cardElement;
            draggedCardElement = cardElement;
            cardElement.style.opacity = '0.5';
            cardElement.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', cardElement.outerHTML);
        }

        function handleDragEnd(event) {
            // Encontrar o card correto
            const cardElement = event.target.closest('.kanban-card') || event.target;
            if (cardElement) {
                cardElement.style.opacity = '1';
                cardElement.classList.remove('dragging');
            }
        }

        function initializeKanbanDragDrop() {
            // Limpar event listeners anteriores se existirem
            const existingColumns = document.querySelectorAll('.kanban-cards');
            existingColumns.forEach(column => {
                // Clonar elementos para remover event listeners antigos
                const newColumn = column.cloneNode(true);
                column.parentNode.replaceChild(newColumn, column);
            });
            
            // Buscar colunas novamente após clonar
            const columns = document.querySelectorAll('.kanban-cards');
            
            if (columns.length === 0) {
                console.warn('Nenhuma coluna Kanban encontrada para inicializar drag and drop');
                return;
            }
            
            columns.forEach(column => {
                column.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    column.classList.add('drag-over');
                    
                    const afterElement = getDragAfterElement(column, e.clientY);
                    const dragging = document.querySelector('.kanban-card.dragging');
                    if (dragging) {
                        if (afterElement == null) {
                            column.appendChild(dragging);
                        } else {
                            column.insertBefore(dragging, afterElement);
                        }
                    }
                });

                column.addEventListener('dragleave', () => {
                    column.classList.remove('drag-over');
                });

                column.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    column.classList.remove('drag-over');
                    
                    if (draggedCard) {
                        const cardId = parseInt(draggedCard.getAttribute('data-card-id'));
                        const newColumnId = column.getAttribute('data-column');

                        await ensureKanbanLoaded(false);
                        const card = state.kanban.cardsById.get(String(cardId));
                        if (card) {
                            const oldColumnId = card.columnId;
                            const oldColumnName = state.kanban.columnsById.get(String(oldColumnId))?.name || oldColumnId;
                            const newColumnName = state.kanban.columnsById.get(String(newColumnId))?.name || newColumnId;

                            if (oldColumnId !== newColumnId) {
                                const opKey = `kanban:move:${cardId}:${newColumnId}`;
                                try {
                                    await withIdempotency(opKey, async () => {
                                        await updateKanbanCardColumn(cardId, newColumnId);
                                    });
                                    renderTarefas();
                                } catch (error) {
                                    console.error('[kanban] Erro ao mover tarefa via drag&drop:', { cardId, newColumnId, error });
                                    alert('Erro ao mover tarefa: ' + (error.message || 'Erro desconhecido'));
                                    renderTarefas();
                                }
                            }
                            
                            // Notificar Discord sobre movimentação de tarefa (apenas se Discord estiver habilitado)
                            // Verificar ANTES de chamar getDiscordConfig para evitar logs desnecessários
                            if (oldColumnId !== newColumnId) {
                                // Verificar se Discord está habilitado sem chamar getDiscordConfig (que loga)
                                const storedConfig = getData('txd_discord_config');
                                if (storedConfig && storedConfig.enabled === true && storedConfig.notifications && storedConfig.notifications.tasks === true) {
                                    // Só chamar getDiscordConfig se realmente precisar enviar notificação
                                    const discordConfig = getDiscordConfig();
                                    if (discordConfig && discordConfig.enabled && discordConfig.notifications && discordConfig.notifications.tasks) {
                                        sendDiscordNotification('tasks', '🔄 Tarefa Movida', 
                                            `${currentUser.name} moveu uma tarefa`,
                                            [
                                                { name: '📋 Tarefa', value: card.title, inline: false },
                                                { name: '📤 De', value: oldColumnName, inline: true },
                                                { name: '📥 Para', value: newColumnName, inline: true },
                                                { name: '👤 Responsável', value: (Array.isArray(card.assignees) ? card.assignees[0] : card.assignee) || 'Não atribuído', inline: true },
                                                { name: '👨‍💼 Movido por', value: currentUser.name, inline: true },
                                                { name: '🕐 Horário', value: new Date().toLocaleString('pt-BR'), inline: true }
                                            ]
                                        );
                                    }
                                }
                            }
                        }
                        
                        draggedCard = null;
                        draggedCardElement = null;
                    }
                });
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.kanban-card:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // Fechar modal com ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });

        // Variável global para rastrear seção atual
        let currentSection = 'inicio';
        
        // Carregar dados em memória ao iniciar
        async function refreshData(forceRefresh = false) {
            try {
                // Se não forçar refresh, usar cache quando disponível
                const [staff, events, announcements, messages, groups, commands, favorites, usage, discord, requests, kanban] = await Promise.all([
                    getData('txd_staff', forceRefresh),
                    getData('txd_events', forceRefresh),
                    getData('txd_announcements', forceRefresh),
                    getData('txd_chat_messages', forceRefresh),
                    getData('txd_chat_groups', forceRefresh),
                    getData('txd_commands', forceRefresh),
                    getData('txd_favorite_commands', forceRefresh),
                    getData('txd_command_usage', forceRefresh),
                    getData('txd_discord_config', forceRefresh),
                    getData('txd_registration_requests', forceRefresh),
                    getData('txd_kanban', forceRefresh)
                ]);
                
                // Atualizar variáveis globais
                staffData = staff || staffData || [];
                eventsData = events || [];
                announcementsData = announcements || [];                chatMessages = messages || [];
                chatGroups = groups || [];
                commandsData = commands || [];
                favoriteCommands = favorites || [];
                commandUsageStats = usage || {};
                discordConfig = discord || getDiscordConfig();
                
                updateChatNotificationBadge();
                
                // Inicializar real-time após primeiro carregamento
                if (!realtimeInitialized && supabaseClient) {
                    initializeRealtime();
                }

                // Inicializar inbox de notificações (se existir no Supabase)
                initializeNotificationsSystem().catch(() => {});

                // Aplicar branding/configurações gerais (logo, fundos, título)
                try { applyBrandingFromSystemSettings(getSystemSettingsObject()); } catch (e) {}
            } catch (error) {
                console.error('Erro ao atualizar dados:', error);
            }
        }

        function updateChatNotificationBadge() {
            if (!currentUser) return;
            
            // Garantir que chatMessages é um array
            const messages = Array.isArray(chatMessages) ? chatMessages : [];
            
            const totalUnread = messages.filter(msg => 
                msg.receiverId === currentUser.id && !msg.read
            ).length;
            
            const chatLink = document.querySelector('.nav-menu li a[onclick*="chat"]');
            if (chatLink) {
                // Remover badge anterior se existir
                const existingBadge = chatLink.querySelector('.notification-badge');
                if (existingBadge) {
                    existingBadge.remove();
                }
                
                // Adicionar novo badge se houver mensagens não lidas
                if (totalUnread > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'notification-badge';
                    badge.textContent = totalUnread > 99 ? '99+' : totalUnread;
                    chatLink.style.position = 'relative';
                    chatLink.appendChild(badge);
                }
            }
        }

        // ========== NOTIFICAÇÕES PERSISTENTES (INBOX) ==========

        let notificationsSupported = null; // null = desconhecido, true/false após detecção
        let notificationsFilterMode = 'unread'; // unread | all
        let notificationsCache = [];
        let notificationsReadSet = new Set();
        let notificationsInitialized = false;

        function getCurrentUserIdString() {
            const v = currentUser?.id;
            if (v === undefined || v === null) return '';
            return String(v).trim();
        }

        function isSameUserId(a, b) {
            const sa = (a === undefined || a === null) ? '' : String(a).trim();
            const sb = (b === undefined || b === null) ? '' : String(b).trim();
            return !!(sa && sb && sa === sb);
        }

        function notificationAppliesToCurrentUser(notification) {
            if (!notification || !currentUser) return false;
            const audience = normalizeText(notification.audience || 'all');
            const userId = getCurrentUserIdString();

            // Não notificar o próprio autor (quando marcado explicitamente)
            try {
                const suppressSelf = !!(notification?.metadata?.suppressSelf ?? notification?.metadata?.suppress_self);
                const actorId = notification?.metadata?.actorUserId ?? notification?.metadata?.actor_user_id ?? null;
                if (suppressSelf && isSameUserId(actorId, userId)) return false;
            } catch (e) {}

            if (audience === 'all' || audience === '*' || audience === 'staff') return true;
            // "dev" deve ser somente DEV (não inclui C-Level)
            if (audience === 'dev') return isDevRole(currentUser?.roles || currentUser?.role);
            if (audience === 'clevel' || audience === 'c_level') return isCLevelRole(currentUser?.roles || currentUser?.role);
            if (audience === 'user') return userId && isSameUserId(notification.audienceUserId ?? notification.audience_user_id, userId);
            return false;
        }

        function normalizePersonLabel(value) {
            const raw = (value ?? '').toString().trim();
            if (!raw) return '';
            // Remove sufixos tipo "Nome (Cargo)"
            return raw.replace(/\s*\([^)]*\)\s*$/g, '').trim().toLowerCase();
        }

        function findStaffByAnyName(label) {
            const target = normalizePersonLabel(label);
            if (!target) return null;
            const staffArray = Array.isArray(staffData) ? staffData : [];
            return staffArray.find(s => {
                const candidates = [s?.displayName, s?.name, s?.login].map(normalizePersonLabel).filter(Boolean);
                return candidates.includes(target);
            }) || null;
        }

        async function detectNotificationsSupport() {
            if (!supabaseClient) {
                notificationsSupported = false;
                return false;
            }
            try {
                const { error } = await supabaseClient
                    .from('notifications')
                    .select('id')
                    .limit(1);
                if (error) {
                    const msg = normalizeText(error.message);
                    if (msg.includes('relation') || msg.includes('does not exist') || msg.includes('notifications')) {
                        notificationsSupported = false;
                        return false;
                    }
                    // Outros erros: considerar suportado, mas logar.
                    console.warn('[notifications] erro ao detectar suporte:', error);
                }
                notificationsSupported = true;
                return true;
            } catch (e) {
                notificationsSupported = false;
                return false;
            }
        }

        async function createNotification({
            type,
            title,
            body = '',
            audience = 'all',
            audienceUserId = null,
            entityType = null,
            entityId = null,
            metadata = {}
        } = {}) {
            if (!supabaseClient) return null;
            if (!type || !title) return null;

            if (notificationsSupported === null) {
                await detectNotificationsSupport();
            }
            if (notificationsSupported === false) return null;

            const row = {
                type: String(type),
                title: String(title),
                body: body ? String(body) : null,
                audience: String(audience || 'all'),
                audience_user_id: (audienceUserId !== undefined && audienceUserId !== null && String(audienceUserId).trim() !== '')
                    ? String(audienceUserId)
                    : null,
                entity_type: entityType ? String(entityType) : null,
                entity_id: (entityId !== undefined && entityId !== null && String(entityId).trim() !== '') ? String(entityId) : null,
                metadata: (metadata && typeof metadata === 'object') ? metadata : {}
            };

            try {
                const { data, error } = await supabaseClient
                    .from('notifications')
                    .insert(row)
                    .select('*')
                    .single();
                if (error) throw error;
                return toCamelCase(data || {});
            } catch (e) {
                const msg = normalizeText(e?.message || '');
                if (msg.includes('relation') || msg.includes('does not exist') || msg.includes('notifications')) {
                    notificationsSupported = false;
                }
                console.warn('[notifications] falha ao criar:', e);
                return null;
            }
        }

        async function loadNotificationsForCurrentUser(limit = 120) {
            if (!supabaseClient || !currentUser) return [];
            if (notificationsSupported === null) await detectNotificationsSupport();
            if (notificationsSupported === false) return [];

            const safeLimit = Math.max(10, Math.min(Number(limit) || 120, 300));

            const { data, error } = await supabaseClient
                .from('notifications')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(safeLimit);

            if (error) throw error;

            const all = toCamelCase(data || []);
            return all.filter(notificationAppliesToCurrentUser);
        }

        async function loadNotificationReadsForCurrentUser(notificationIds = []) {
            if (!supabaseClient || !currentUser) return new Set();
            if (!Array.isArray(notificationIds) || notificationIds.length === 0) return new Set();
            const userId = getCurrentUserIdString();
            if (!userId) return new Set();

            const ids = notificationIds.map(id => Number(id)).filter(n => Number.isFinite(n) && n > 0);
            if (ids.length === 0) return new Set();

            try {
                const { data, error } = await supabaseClient
                    .from('notification_reads')
                    .select('notification_id')
                    .eq('user_id', userId)
                    .in('notification_id', ids);
                if (error) throw error;

                const set = new Set();
                (data || []).forEach(r => {
                    const nid = r.notification_id ?? r.notificationId;
                    if (nid) set.add(Number(nid));
                });
                return set;
            } catch (e) {
                console.warn('[notifications] falha ao carregar reads:', e);
                return new Set();
            }
        }

        function getUnreadNotificationsCount() {
            const list = Array.isArray(notificationsCache) ? notificationsCache : [];
            let count = 0;
            for (const n of list) {
                const id = Number(n?.id);
                if (id && !notificationsReadSet.has(id)) count++;
            }
            return count;
        }

        function updateNotificationsNavBadge() {
            const badge = document.getElementById('notificationsNavBadge');
            if (!badge) return;

            const unread = getUnreadNotificationsCount();
            if (unread > 0) {
                badge.textContent = unread > 99 ? '99+' : String(unread);
                badge.classList.remove('hidden');
            } else {
                badge.textContent = '0';
                badge.classList.add('hidden');
            }
        }

        function setNotificationsFilter(mode) {
            const m = (mode === 'all') ? 'all' : 'unread';
            notificationsFilterMode = m;

            const bUnread = document.getElementById('notifFilterUnread');
            const bAll = document.getElementById('notifFilterAll');
            if (bUnread && bAll) {
                // Alternar visual usando as classes existentes
                bUnread.classList.toggle('btn-primary', m === 'unread');
                bUnread.classList.toggle('btn-secondary', m !== 'unread');
                bAll.classList.toggle('btn-primary', m === 'all');
                bAll.classList.toggle('btn-secondary', m !== 'all');
            }

            renderNotificationsList();
        }

        function renderNotificationsList() {
            const listEl = document.getElementById('notificationsList');
            const statusEl = document.getElementById('notificationsStatus');
            if (!listEl) return;

            const list = Array.isArray(notificationsCache) ? notificationsCache : [];
            const filtered = notificationsFilterMode === 'all'
                ? list
                : list.filter(n => {
                    const id = Number(n?.id);
                    return id && !notificationsReadSet.has(id);
                });

            if (statusEl) {
                const unread = getUnreadNotificationsCount();
                statusEl.textContent = notificationsSupported === false
                    ? 'Tabela de notificações não existe ainda. Execute o SQL de criação (criar_tabela_notifications.sql) no Supabase.'
                    : `${unread} não lida(s) • ${list.length} total`;
            }

            if (filtered.length === 0) {
                listEl.innerHTML = `<div style="color: var(--gray-text); font-size: 13px; padding: 14px; border: 1px dashed var(--gray-border); border-radius: 12px; background: var(--black-dark);">Sem notificações aqui.</div>`;
                return;
            }

            listEl.innerHTML = filtered.map(n => {
                const id = Number(n.id);
                const isRead = notificationsReadSet.has(id);
                const title = escapeHtml((n.title || '').toString());
                const body = escapeHtml((n.body || '').toString());
                const createdAt = (() => {
                    try { return n.createdAt ? new Date(n.createdAt).toLocaleString('pt-BR') : ''; } catch (e) { return ''; }
                })();
                const badge = isRead ? '' : `<span style="background: rgba(0,255,136,0.18); color: var(--success); border: 1px solid rgba(0,255,136,0.25); padding: 2px 8px; border-radius: 999px; font-size: 10px; font-weight: 800;">NOVA</span>`;
                const meta = `${escapeHtml(createdAt)}${n.type ? ` • ${escapeHtml(String(n.type))}` : ''}`;

                return `
                    <div style="background: var(--gray-medium); border: 1px solid ${isRead ? 'var(--gray-border)' : 'rgba(0,255,136,0.35)'}; border-radius: 14px; padding: 14px; cursor: pointer;" onclick="openNotificationItem(${id})">
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
                            <div style="color: var(--white-soft); font-weight: 800; font-size: 14px;">${title}</div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                ${badge}
                                <button type="button" class="btn btn-secondary" style="width: auto; padding: 8px 10px; font-size: 12px;" onclick="event.stopPropagation(); markNotificationRead(${id});">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </div>
                        <div style="color: var(--gray-light); font-size: 12px; margin-top: 6px;">${meta}</div>
                        ${body ? `<div style="color: var(--white-soft); font-size: 13px; margin-top: 10px; white-space: pre-wrap; line-height: 1.45;">${body}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        async function refreshNotifications({ render = false } = {}) {
            if (!currentUser || !supabaseClient) return;

            try {
                if (notificationsSupported === null) await detectNotificationsSupport();
                if (notificationsSupported === false) {
                    notificationsCache = [];
                    notificationsReadSet = new Set();
                    updateNotificationsNavBadge();
                    if (render) renderNotificationsList();
                    return;
                }

                const list = await loadNotificationsForCurrentUser(140);
                notificationsCache = list;
                notificationsReadSet = await loadNotificationReadsForCurrentUser(list.map(n => n.id));
                updateNotificationsNavBadge();
                if (render) renderNotificationsList();

                notificationsInitialized = true;
            } catch (e) {
                console.warn('[notifications] falha ao atualizar:', e);
            }
        }

        function openNotificationsModal() {
            // Sempre começa com "Não lidas"
            setNotificationsFilter('unread');
            document.getElementById('notificationsModal')?.classList?.add('active');
            refreshNotifications({ render: true }).catch(() => {});
        }

        async function markNotificationRead(notificationId) {
            if (!supabaseClient || !currentUser) return;
            if (notificationsSupported === null) await detectNotificationsSupport();
            if (notificationsSupported === false) return;

            const nid = Number(notificationId);
            if (!nid) return;

            const userId = getCurrentUserIdString();
            if (!userId) return;

            try {
                const { error } = await supabaseClient
                    .from('notification_reads')
                    .upsert(
                        { notification_id: nid, user_id: userId, read_at: new Date().toISOString() },
                        { onConflict: 'notification_id,user_id' }
                    );
                if (error) throw error;
                notificationsReadSet.add(nid);
                updateNotificationsNavBadge();
                renderNotificationsList();
            } catch (e) {
                console.warn('[notifications] falha ao marcar lida:', e);
            }
        }

        async function markAllNotificationsRead() {
            if (!supabaseClient || !currentUser) return;
            if (notificationsSupported === null) await detectNotificationsSupport();
            if (notificationsSupported === false) return;

            const userId = getCurrentUserIdString();
            if (!userId) return;

            const unreadIds = (Array.isArray(notificationsCache) ? notificationsCache : [])
                .map(n => Number(n?.id))
                .filter(id => id && !notificationsReadSet.has(id));
            if (unreadIds.length === 0) return;

            try {
                const rows = unreadIds.map(id => ({
                    notification_id: id,
                    user_id: userId,
                    read_at: new Date().toISOString()
                }));
                const { error } = await supabaseClient
                    .from('notification_reads')
                    .upsert(rows, { onConflict: 'notification_id,user_id' });
                if (error) throw error;

                unreadIds.forEach(id => notificationsReadSet.add(id));
                updateNotificationsNavBadge();
                renderNotificationsList();
            } catch (e) {
                console.warn('[notifications] falha ao marcar tudo lido:', e);
            }
        }

        function openNotificationItem(notificationId) {
            const nid = Number(notificationId);
            if (!nid) return;
            const notif = (Array.isArray(notificationsCache) ? notificationsCache : []).find(n => Number(n?.id) === nid);
            if (!notif) return;

            // Marcar como lido ao abrir
            if (!notificationsReadSet.has(nid)) {
                markNotificationRead(nid).catch(() => {});
            }

            // Navegação básica por entidade
            const type = normalizeText(notif.entityType || notif.entity_type || '');
            const eid = String(notif.entityId || notif.entity_id || '').trim();
            if (type === 'pendency' && eid) {
                try { closeModal('notificationsModal'); } catch (e) {}
                showSection('pendencias');
                setTimeout(() => {
                    try { viewPendencyDetails(Number(eid)); } catch (e) {}
                }, 250);
                return;
            }
            if (type === 'kanban' || type === 'kanban_card' || type === 'task') {
                try { closeModal('notificationsModal'); } catch (e) {}
                showSection('tarefas');
            }
        }

        function ensureNotificationsRealtime() {
            if (!supabaseClient) return;
            if (notificationsSupported !== true) return;
            if (realtimeChannelsByName?.has?.('notifications_changes')) return;

            // Novas notificações
            subscribeRealtimeOnce('notifications_changes', () => supabaseClient
                .channel('notifications_changes')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications' }, (payload) => {
                    try {
                        const n = toCamelCase(payload.new || {});
                        if (!notificationAppliesToCurrentUser(n)) return;

                        // Ignorar toast quando fui eu quem gerou
                        const actorId = n?.metadata?.actorUserId ?? n?.metadata?.actor_user_id ?? null;
                        if (!isSameUserId(actorId, getCurrentUserIdString())) {
                            showToast({
                                title: n.title || 'Nova notificação',
                                message: n.body || '',
                                variant: 'info'
                            });
                        }

                        // Atualizar cache rápido (evita refetch imediato)
                        notificationsCache = [n, ...(Array.isArray(notificationsCache) ? notificationsCache : [])].slice(0, 200);
                        updateNotificationsNavBadge();
                        if (document.getElementById('notificationsModal')?.classList?.contains('active')) {
                            refreshNotifications({ render: true }).catch(() => {});
                        }

                        // Badges de seção (opcional)
                        const t = normalizeText(n.type || '');
                        if (t.startsWith('pendency')) bumpSectionBadge('pendencias', 1);
                        if (t.startsWith('task')) bumpSectionBadge('tarefas', 1);
                    } catch (e) {
                        console.warn('[notifications][realtime] erro:', e);
                    }
                })
                .subscribe());

            // Leituras (para sincronizar múltiplas abas do mesmo user)
            subscribeRealtimeOnce('notification_reads_changes', () => supabaseClient
                .channel('notification_reads_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'notification_reads' }, (payload) => {
                    try {
                        const row = toCamelCase(payload.new || payload.old || {});
                        const userId = row.userId ?? row.user_id;
                        if (!isSameUserId(userId, getCurrentUserIdString())) return;

                        const nid = Number(row.notificationId ?? row.notification_id);
                        if (nid) notificationsReadSet.add(nid);
                        updateNotificationsNavBadge();
                        if (document.getElementById('notificationsModal')?.classList?.contains('active')) {
                            renderNotificationsList();
                        }
                    } catch (e) {}
                })
                .subscribe());
        }

        async function initializeNotificationsSystem() {
            if (notificationsInitialized) {
                if (notificationsSupported === null) await detectNotificationsSupport();
                if (notificationsSupported) ensureNotificationsRealtime();
                return;
            }
            if (!currentUser || !supabaseClient) return;
            await detectNotificationsSupport();
            if (notificationsSupported) {
                ensureNotificationsRealtime();
                await refreshNotifications({ render: false });
            } else {
                updateNotificationsNavBadge();
            }
            notificationsInitialized = true;
        }

        // ========== NOTIFICAÇÕES IN-APP (BADGES + TOASTS) ==========

        const sectionBadges = {
            pendencias: 0,
            tarefas: 0
        };

        function normalizeText(value) {
            return (value ?? '').toString().trim().toLowerCase();
        }

        function ensureToastContainer() {
            let container = document.getElementById('toastContainer');
            if (container) return container;

            container = document.createElement('div');
            container.id = 'toastContainer';
            container.style.position = 'fixed';
            container.style.top = '16px';
            container.style.right = '16px';
            container.style.zIndex = '3000';
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.style.gap = '10px';
            container.style.maxWidth = '360px';
            document.body.appendChild(container);
            return container;
        }

        function showToast({ title, message, variant = 'info', timeoutMs = 4500 } = {}) {
            try {
                const container = ensureToastContainer();

                const variantMeta = {
                    info: { border: 'rgba(207,207,207,0.25)' },
                    success: { border: 'rgba(0,255,136,0.35)' },
                    warning: { border: 'rgba(255,170,0,0.35)' },
                    danger: { border: 'rgba(255,51,102,0.35)' }
                };

                const meta = variantMeta[variant] || variantMeta.info;

                const toast = document.createElement('div');
                toast.style.background = 'rgba(26, 27, 29, 0.92)';
                toast.style.backdropFilter = 'blur(18px)';
                toast.style.border = `1px solid ${meta.border}`;
                toast.style.borderRadius = '14px';
                toast.style.padding = '12px 14px';
                toast.style.boxShadow = '0 10px 26px rgba(0,0,0,0.35)';
                toast.style.cursor = 'pointer';

                const t = document.createElement('div');
                t.style.color = 'var(--white-soft)';
                t.style.fontWeight = '700';
                t.style.fontSize = '13px';
                t.style.marginBottom = message ? '4px' : '0';
                t.textContent = (title || '').toString();

                const m = document.createElement('div');
                m.style.color = 'var(--gray-light)';
                m.style.fontSize = '12px';
                m.style.lineHeight = '1.35';
                m.textContent = (message || '').toString();

                if (title) toast.appendChild(t);
                if (message) toast.appendChild(m);

                const remove = () => {
                    try { toast.remove(); } catch (e) {}
                };

                toast.addEventListener('click', remove);
                container.appendChild(toast);

                setTimeout(remove, timeoutMs);
            } catch (e) {
                // Silenciar falhas de toast
            }
        }

        function setNavBadgeForSection(section, count) {
            const sectionName = String(section || '').trim();
            const n = Number(count || 0);
            const link = document.querySelector(`.nav-menu li a[onclick*="showSection('${sectionName}')"]`);
            if (!link) return;

            const existingBadge = link.querySelector('.notification-badge');
            if (existingBadge) existingBadge.remove();

            if (n > 0) {
                const badge = document.createElement('span');
                badge.className = 'notification-badge';
                badge.textContent = n > 99 ? '99+' : String(n);
                link.style.position = 'relative';
                link.appendChild(badge);
            }
        }

        function bumpSectionBadge(section, delta = 1) {
            const key = String(section || '').trim();
            if (!Object.prototype.hasOwnProperty.call(sectionBadges, key)) return;
            sectionBadges[key] = Math.max(0, Number(sectionBadges[key] || 0) + Number(delta || 0));
            setNavBadgeForSection(key, sectionBadges[key]);
        }

        function clearSectionBadge(section) {
            const key = String(section || '').trim();
            if (!Object.prototype.hasOwnProperty.call(sectionBadges, key)) return;
            sectionBadges[key] = 0;
            setNavBadgeForSection(key, 0);
        }

        function isCurrentUserId(value) {
            const me = String(currentUser?.id ?? '');
            const v = String(value ?? '');
            return !!(me && v && me === v);
        }

        function isCurrentUserName(value) {
            const v = normalizeText(value);
            const a = normalizeText(currentUser?.name);
            const b = normalizeText(currentUser?.displayName);
            return !!(v && (v === a || v === b));
        }

        // ========== ISSUE TRACKER (SUPABASE) ==========
        const ISSUE_STATUSES = [
            { value: 'open', label: 'Aberto', color: 'var(--danger)' },
            { value: 'triage', label: 'Triagem', color: 'var(--warning)' },
            { value: 'in_progress', label: 'Em Progresso', color: 'var(--primary)' },
            { value: 'blocked', label: 'Bloqueado', color: 'var(--gray-text)' },
            { value: 'testing', label: 'Teste', color: 'var(--warning)' },
            { value: 'done', label: 'Concluido', color: 'var(--success)' }
        ];

        const ISSUE_SEVERITIES = [
            { value: 'critical', label: 'Critico', color: 'var(--danger)' },
            { value: 'high', label: 'Alta', color: 'var(--warning)' },
            { value: 'medium', label: 'Media', color: 'var(--gray-very-light)' },
            { value: 'low', label: 'Baixa', color: 'var(--success)' }
        ];

        const ISSUE_CATEGORIES = [
            { value: 'mapas', label: 'MAPAS' },
            { value: 'bugs', label: 'BUGS' },
            { value: 'carros', label: 'CARROS' },
            { value: 'roupas', label: 'ROUPAS' },
            { value: 'itens', label: 'ITENS' },
            { value: 'coordenadas', label: 'COORDENADAS' },
            { value: 'logs', label: 'LOGS' },
            { value: 'atualizacoes', label: 'ATUALIZAÇÕES' }
        ];

        const ISSUE_BUCKET = 'issue_attachments';
        const ISSUE_PAGE_SIZE = 10;
        const ISSUE_BOARD_PAGE_SIZE = 200;
        const ISSUE_MAX_FILE_MB = 30;
        const ISSUE_ALLOWED_TYPES = [
            'image/png',
            'image/jpeg',
            'image/webp',
            'image/gif',
            'video/mp4',
            'video/webm',
            'video/quicktime'
        ];

        function sanitizeFilename(name) {
            return (name || 'arquivo').toString().replace(/[^a-zA-Z0-9._-]/g, '_');
        }

        function handleIssueFileSelect(event) {
            const preview = document.getElementById('issueAttachmentPreview');
            if (!preview) return;
            const files = Array.from(event.target.files || []);
            if (!files.length) {
                preview.innerHTML = '';
                return;
            }
            preview.innerHTML = files.map(file => {
                const sizeMb = (file.size / (1024 * 1024)).toFixed(2);
                const validType = ISSUE_ALLOWED_TYPES.includes(file.type);
                const tooLarge = file.size > ISSUE_MAX_FILE_MB * 1024 * 1024;
                const status = (!validType || tooLarge) ? 'Invalido' : 'Ok';
                const color = (!validType || tooLarge) ? 'var(--danger)' : 'var(--success)';
                return `
                    <div style="background: var(--black-dark); border-radius: 10px; padding: 10px; border: 1px solid var(--gray-border); display: flex; justify-content: space-between; gap: 12px;">
                        <span style="color: var(--gray-light); font-size: 12px;">${escapeHtml(file.name)} (${sizeMb}MB)</span>
                        <span style="color: ${color}; font-size: 11px; font-weight: 700;">${status}</span>
                    </div>
                `;
            }).join('');
        }

        async function uploadIssueFiles(issueId, files = []) {
            if (!supabaseClient) throw new Error('Supabase nao inicializado.');
            const links = [];
            for (const file of files) {
                if (!ISSUE_ALLOWED_TYPES.includes(file.type)) {
                    throw new Error(`Tipo nao permitido: ${file.name}`);
                }
                if (file.size > ISSUE_MAX_FILE_MB * 1024 * 1024) {
                    throw new Error(`Arquivo muito grande: ${file.name}`);
                }
                const safeName = sanitizeFilename(file.name);
                const path = `issues/${issueId}/${Date.now()}_${safeName}`;
                const { data, error } = await supabaseClient
                    .storage
                    .from(ISSUE_BUCKET)
                    .upload(path, file, { upsert: false });
                if (error) throw error;
                const { data: publicUrl } = supabaseClient
                    .storage
                    .from(ISSUE_BUCKET)
                    .getPublicUrl(data.path);
                if (publicUrl?.publicUrl) {
                    links.push(publicUrl.publicUrl);
                }
            }
            return links;
        }

        const issueUiState = {
            mode: 'my', // my | backlog
            view: 'list', // list | board | create | detail
            selectedId: null,
            lastListSection: 'formularios',
            lastListView: 'list',
            filters: {
                status: 'all',
                severity: 'all',
                assigned: 'all',
                search: '',
                category: 'all'
            },
            page: 1,
            pageSize: ISSUE_PAGE_SIZE
        };

        function escapeHtml(value) {
            if (value === null || value === undefined) return '';
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatDateTime(value) {
            if (!value) return '-';
            try {
                return new Date(value).toLocaleString('pt-BR');
            } catch (err) {
                return value;
            }
        }

        function getStatusMeta(value) {
            return ISSUE_STATUSES.find(s => s.value === value) || { label: value, color: 'var(--gray-text)' };
        }

        function getSeverityMeta(value) {
            return ISSUE_SEVERITIES.find(s => s.value === value) || { label: value, color: 'var(--gray-text)' };
        }

        function getCategoryBadgeStyle(rawCategory) {
            const category = (rawCategory || '').toString().toLowerCase().trim();
            const fallback = {
                bg: 'rgba(255,255,255,0.08)',
                border: 'rgba(255,255,255,0.14)',
                text: 'var(--white-soft)'
            };

            const map = {
                mapas: { bg: 'rgba(59,130,246,0.14)', border: 'rgba(59,130,246,0.35)', text: '#3b82f6' },
                bugs: { bg: 'rgba(255,51,102,0.14)', border: 'rgba(255,51,102,0.35)', text: 'var(--danger)' },
                carros: { bg: 'rgba(255,170,0,0.14)', border: 'rgba(255,170,0,0.35)', text: 'var(--warning)' },
                roupas: { bg: 'rgba(236,72,153,0.14)', border: 'rgba(236,72,153,0.35)', text: '#ec4899' },
                itens: { bg: 'rgba(0,255,136,0.12)', border: 'rgba(0,255,136,0.30)', text: 'var(--success)' },
                coordenadas: { bg: 'rgba(34,211,238,0.14)', border: 'rgba(34,211,238,0.35)', text: '#22d3ee' },
                logs: { bg: 'rgba(111,114,118,0.14)', border: 'rgba(111,114,118,0.35)', text: 'var(--gray-very-light)' },
                atualizacoes: { bg: 'rgba(0,168,255,0.18)', border: 'rgba(0,168,255,0.45)', text: 'var(--primary)' }
            };

            return map[category] || fallback;
        }

        function normalizeCategoryLabel(value) {
            const found = ISSUE_CATEGORIES.find(c => c.value === value);
            return found ? found.label : '';
        }

        function getCategoryPrefix(category) {
            const value = (category || '').toString().toUpperCase();
            return value;
        }

        function extractCategoryFromTitle(title = '') {
            const match = title.match(/^\s*\[(.+?)\]\s*/);
            if (!match) return { category: '', cleanTitle: title };
            const raw = match[1].toString().toLowerCase();
            const normalized = ISSUE_CATEGORIES.find(c => c.value === raw)?.value || raw;
            const cleanTitle = title.replace(match[0], '').trim();
            return { category: normalized, cleanTitle };
        }

        function applyCategoryToTitle(title = '', category = 'all') {
            const { cleanTitle } = extractCategoryFromTitle(title);
            if (!category || category === 'all') return cleanTitle;
            const prefix = getCategoryPrefix(category);
            return `[${prefix}] ${cleanTitle}`.trim();
        }

        function getIssueUser() {
            if (!currentUser) return null;
            return {
                id: currentUser.id,
                name: currentUser.displayName || currentUser.name || 'Usuario',
                role: currentUser.role || 'Staff',
                roles: normalizeRoleList(currentUser.roles || currentUser.role)
            };
        }

        function canViewAllIssues(profile) {
            const roleOrRoles = profile?.roles || profile?.role || currentUser?.roles || currentUser?.role;
            const permissions = getUserPermissionsForRoles(roleOrRoles);
            return permissions.includes('*') || permissions.includes('dev_area') || isDevRole(roleOrRoles);
        }

        function canManageIssues(profile) {
            return canViewAllIssues(profile);
        }

        function refreshIssueProfileAndMenu() {
            const devMenu = document.getElementById('devMenuGroup');
            if (devMenu) {
                if (canViewAllIssues(getIssueUser())) {
                    devMenu.classList.remove('hidden');
                } else {
                    devMenu.classList.add('hidden');
                }
            }
        }
        refreshIssueProfileAndMenu();

        async function ensureIssueAccess({ requireDev = false } = {}) {
            if (!supabaseClient) {
                return { ok: false, message: 'Supabase nao inicializado.' };
            }
            const profile = getIssueUser();
            if (!profile) {
                return { ok: false, message: 'Voce precisa estar logado no painel.' };
            }
            if (requireDev && !canViewAllIssues(profile)) {
                return { ok: false, message: 'Area DEV restrita apenas para cargo Dev.' };
            }
            return { ok: true, profile };
        }

        async function fetchAssignees() {
            const staffList = Array.isArray(staffData) ? staffData : [];
            return staffList
                .filter(member => isDevRole(getStaffRoles(member)))
                .map(member => ({
                    id: member.id || member.name,
                    display_name: member.displayName || member.name || member.login || 'Dev'
                }));
        }

        async function createIssue(payload) {
            const user = getIssueUser();
            if (!user) throw new Error('Usuario nao encontrado.');
            const insertPayload = {
                title: payload.title,
                description: payload.description,
                steps_to_reproduce: payload.steps_to_reproduce || null,
                expected_result: payload.expected_result || null,
                actual_result: payload.actual_result || null,
                severity: payload.severity || 'medium',
                status: payload.status || 'open',
                assigned_to: payload.assigned_to || null,
                created_by: user.name,
                created_by_id: String(user.id || ''),
                updated_by: user.name
            };
            const { data, error } = await supabaseClient
                .from('issues')
                .insert(insertPayload)
                .select('*')
                .single();
            if (error) throw error;
            return data;
        }

        async function fetchIssues(filters = {}) {
            let query = supabaseClient
                .from('issues')
                .select('*', { count: 'exact' });

            if (filters.status && filters.status !== 'all') {
                query = query.eq('status', filters.status);
            }
            if (filters.severity && filters.severity !== 'all') {
                query = query.eq('severity', filters.severity);
            }
            if (filters.assigned && filters.assigned !== 'all') {
                if (filters.assigned === 'unassigned') {
                    query = query.is('assigned_to', null);
                } else {
                    query = query.eq('assigned_to', filters.assigned);
                }
            }
            if (filters.search) {
                const term = filters.search.replace(/[%_]/g, '\\$&');
                query = query.or(`title.ilike.%${term}%,description.ilike.%${term}%`);
            }
            if (filters.createdById) {
                query = query.eq('created_by_id', String(filters.createdById));
            }
            if (filters.category && filters.category !== 'all') {
                const prefix = getCategoryPrefix(filters.category);
                if (prefix) {
                    query = query.ilike('title', `[${prefix}]%`);
                }
            }

            query = query.order('created_at', { ascending: false });
            const page = filters.page || 1;
            const pageSize = filters.pageSize || ISSUE_PAGE_SIZE;
            const from = (page - 1) * pageSize;
            const to = from + pageSize - 1;
            query = query.range(from, to);

            const { data, error, count } = await query;
            if (error) throw error;
            return { data: data || [], count: count || 0 };
        }

        async function fetchIssuesForBoard(filters = {}) {
            const boardFilters = {
                ...filters,
                status: 'all',
                page: 1,
                pageSize: ISSUE_BOARD_PAGE_SIZE
            };
            return fetchIssues(boardFilters);
        }

        async function fetchIssueById(issueId) {
            const { data, error } = await supabaseClient
                .from('issues')
                .select('*')
                .eq('id', issueId)
                .single();
            if (error) throw error;
            return data;
        }

        async function fetchIssueCount(filters = {}) {
            let query = supabaseClient
                .from('issues')
                .select('*', { count: 'exact', head: true });

            if (filters.status && filters.status !== 'all') {
                query = query.eq('status', filters.status);
            }
            if (filters.unassigned) {
                query = query.is('assigned_to', null);
            }
            if (filters.assigned && filters.assigned !== 'all' && filters.assigned !== 'unassigned') {
                query = query.eq('assigned_to', filters.assigned);
            }

            const { count, error } = await query;
            if (error) throw error;
            return count || 0;
        }

        async function refreshDevStats() {
            const container = document.getElementById('devStats');
            if (!container) return;
            if (!supabaseClient) {
                container.innerHTML = '<p style="color: var(--gray-text);">Supabase nao inicializado.</p>';
                return;
            }
            try {
                const myName = (currentUser?.displayName || currentUser?.name || '').toString().trim();
                const [total, open, triage, inProgress, blocked, testing, done, unassigned, mine] = await Promise.all([
                    fetchIssueCount(),
                    fetchIssueCount({ status: 'open' }),
                    fetchIssueCount({ status: 'triage' }),
                    fetchIssueCount({ status: 'in_progress' }),
                    fetchIssueCount({ status: 'blocked' }),
                    fetchIssueCount({ status: 'testing' }),
                    fetchIssueCount({ status: 'done' }),
                    fetchIssueCount({ unassigned: true }),
                    myName ? fetchIssueCount({ assigned: myName }) : Promise.resolve(0)
                ]);

                container.innerHTML = `
                    <div style="display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                        ${renderDevStatCard('Total', total, 'var(--gray-very-light)', "setIssueStatusFilter('all')", issueUiState.filters.status === 'all')}
                        ${renderDevStatCard('Abertos', open, 'var(--danger)', "setIssueStatusFilter('open')", issueUiState.filters.status === 'open')}
                        ${renderDevStatCard('Triagem', triage, 'var(--warning)', "setIssueStatusFilter('triage')", issueUiState.filters.status === 'triage')}
                        ${renderDevStatCard('Em Progresso', inProgress, 'var(--primary)', "setIssueStatusFilter('in_progress')", issueUiState.filters.status === 'in_progress')}
                        ${renderDevStatCard('Bloqueados', blocked, 'var(--gray-text)', "setIssueStatusFilter('blocked')", issueUiState.filters.status === 'blocked')}
                        ${renderDevStatCard('Teste', testing, 'var(--warning)', "setIssueStatusFilter('testing')", issueUiState.filters.status === 'testing')}
                        ${renderDevStatCard('Concluidos', done, 'var(--success)', "setIssueStatusFilter('done')", issueUiState.filters.status === 'done')}
                        ${renderDevStatCard('Nao Atribuidos', unassigned, 'var(--gray-light)', "applyDevQuickFilter('unassigned')", issueUiState.filters.assigned === 'unassigned')}
                        ${renderDevStatCard('Minhas Tarefas', mine, 'var(--accent-primary)', "applyDevQuickFilter('mine')", !!myName && issueUiState.filters.assigned === myName)}
                    </div>
                `;
            } catch (error) {
                console.error('Erro ao carregar estatisticas DEV:', error);
                container.innerHTML = '<p style="color: var(--danger);">Erro ao carregar estatisticas.</p>';
            }
        }

        function renderDevStatCard(title, value, color, onClick = '', isActive = false) {
            const clickable = !!onClick;
            return `
                <div ${clickable ? `onclick="${onClick}"` : ''} style="background: var(--gray-dark); border-radius: 12px; padding: 16px; border: 1px solid ${isActive ? 'var(--accent-primary)' : 'var(--gray-border)'}; display: grid; gap: 6px; ${clickable ? 'cursor: pointer;' : ''}">
                    <div style="color: var(--gray-text); font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">${title}</div>
                    <div style="color: ${color}; font-size: 22px; font-weight: 700;">${value}</div>
                </div>
            `;
        }

        async function updateIssue(issueId, payload) {
            const user = getIssueUser();
            if (!user) throw new Error('Usuario nao encontrado.');
            const updatePayload = {
                ...payload,
                updated_by: user.name
            };
            const { data, error } = await supabaseClient
                .from('issues')
                .update(updatePayload)
                .eq('id', issueId)
                .select('*')
                .single();
            if (error) throw error;
            return data;
        }

        async function addComment(issueId, content) {
            const user = getIssueUser();
            if (!user) throw new Error('Usuario nao encontrado.');
            const { data, error } = await supabaseClient
                .from('issue_comments')
                .insert({
                    issue_id: issueId,
                    author_id: String(user.id || ''),
                    author_name: user.name,
                    content
                })
                .select('*')
                .single();
            if (error) throw error;
            return data;
        }

        async function fetchComments(issueId) {
            const { data, error } = await supabaseClient
                .from('issue_comments')
                .select('*')
                .eq('issue_id', issueId)
                .order('created_at', { ascending: true });
            if (error) throw error;
            return data || [];
        }

        async function saveAttachmentLinks(issueId, links) {
            if (!links.length) return [];
            const rows = links.map(link => ({
                issue_id: issueId,
                storage_url: link,
                filename: link.split('/').pop() || 'anexo'
            }));
            const { data, error } = await supabaseClient
                .from('issue_attachments')
                .insert(rows)
                .select('*');
            if (error) throw error;
            return data || [];
        }

        async function fetchAttachments(issueId) {
            const { data, error } = await supabaseClient
                .from('issue_attachments')
                .select('*')
                .eq('issue_id', issueId)
                .order('created_at', { ascending: true });
            if (error) throw error;
            return data || [];
        }

        function renderIssuesList(issues) {
            if (!issues.length) {
                return `
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 40px; text-align: center; border: 1px solid var(--gray-border);">
                        <div style="font-size: 32px; opacity: 0.4; margin-bottom: 16px;">Tarefas</div>
                        <h3 style="color: var(--white-soft); margin-bottom: 8px;">Nenhuma tarefa encontrada</h3>
                        <p style="color: var(--gray-text); font-size: 14px;">Tente ajustar os filtros ou criar uma nova tarefa.</p>
                    </div>
                `;
            }

            const canManage = issueUiState.mode === 'backlog' && canManageIssues(getIssueUser());

            return issues.map(issue => {
                const statusMeta = getStatusMeta(issue.status);
                const severityMeta = getSeverityMeta(issue.severity);
                const createdBy = issue.created_by || 'Desconhecido';
                const assignedTo = issue.assigned_to || 'Nao atribuido';
                const { category, cleanTitle } = extractCategoryFromTitle(issue.title || '');
                const categoryLabel = normalizeCategoryLabel(category);
                const categoryBadge = getCategoryBadgeStyle(category);
                const quickSelectId = `issueQuickStatus-${issue.id}`;
                return `
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border); display: grid; gap: 12px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
                            <div style="font-size: 16px; font-weight: 700; color: var(--white-soft);">${escapeHtml(cleanTitle || issue.title)}</div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                ${categoryLabel ? `<span style="background: ${categoryBadge.bg}; border: 1px solid ${categoryBadge.border}; color: ${categoryBadge.text}; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 800;">${categoryLabel}</span>` : ''}
                                <span style="background: ${statusMeta.color}; color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700;">${statusMeta.label}</span>
                                <span style="background: rgba(255,255,255,0.08); color: var(--white-soft); padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700;">${severityMeta.label}</span>
                            </div>
                        </div>
                        <div style="color: var(--gray-light); font-size: 13px; line-height: 1.5;">
                            ${escapeHtml(issue.description || '').slice(0, 160)}${(issue.description || '').length > 160 ? '...' : ''}
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 16px; color: var(--gray-text); font-size: 12px;">
                            <span><i class="fas fa-user"></i> ${escapeHtml(createdBy)}</span>
                            <span><i class="fas fa-user-check"></i> ${escapeHtml(assignedTo)}</span>
                            <span><i class="fas fa-clock"></i> ${formatDateTime(issue.created_at)}</span>
                        </div>
                        ${canManage ? `
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                            <label style="color: var(--gray-text); font-size: 12px;">Status:</label>
                            <select id="${quickSelectId}" style="padding: 6px 10px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 6px; color: var(--white-soft); font-size: 12px;">
                                ${ISSUE_STATUSES.map(s => `<option value="${s.value}" ${s.value === issue.status ? 'selected' : ''}>${s.label}</option>`).join('')}
                            </select>
                            <button class="btn-modal btn-secondary" onclick="quickUpdateIssueStatus('${issue.id}')">
                                <i class="fas fa-save"></i> Atualizar Status
                            </button>
                        </div>
                        ` : ''}
                        <div style="display: flex; justify-content: flex-end; gap: 10px;">
                            <button class="btn-modal btn-secondary" onclick="openIssueDetail('${issue.id}')">
                                <i class="fas fa-eye"></i> Detalhes
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderIssueFilters(showAssignee) {
            const statusOptions = ISSUE_STATUSES.map(s => `<option value="${s.value}">${s.label}</option>`).join('');
            const severityOptions = ISSUE_SEVERITIES.map(s => `<option value="${s.value}">${s.label}</option>`).join('');
            const selectedCategory = issueUiState.filters.category || 'all';
            const categoryOptions = ISSUE_CATEGORIES.map(c => `<option value="${c.value}" ${c.value === selectedCategory ? 'selected' : ''}>${c.label}</option>`).join('');
            const assigneeField = showAssignee ? `
                <select id="issueAssigneeFilter" onchange="applyIssueFilters()" style="padding: 8px 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 6px; color: var(--white-soft); font-size: 14px; cursor: pointer; min-width: 180px;">
                    <option value="all">Todas atribuicoes</option>
                    <option value="unassigned">Nao atribuido</option>
                </select>
            ` : '';

            return `
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 16px; margin-bottom: 24px; border: 1px solid var(--gray-border);">
                    <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
                        <select id="issueCategoryFilter" onchange="applyIssueFilters()" style="padding: 8px 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 6px; color: var(--white-soft); font-size: 14px; cursor: pointer;">
                            <option value="all">Todas categorias</option>
                            ${categoryOptions}
                        </select>
                        <select id="issueStatusFilter" onchange="applyIssueFilters()" style="padding: 8px 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 6px; color: var(--white-soft); font-size: 14px; cursor: pointer;">
                            <option value="all">Todos os status</option>
                            ${statusOptions}
                        </select>
                        <select id="issueSeverityFilter" onchange="applyIssueFilters()" style="padding: 8px 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 6px; color: var(--white-soft); font-size: 14px; cursor: pointer;">
                            <option value="all">Todas severidades</option>
                            ${severityOptions}
                        </select>
                        ${assigneeField}
                        <input type="text" id="issueSearchInput" placeholder="Buscar tarefas..." onkeyup="applyIssueFilters()" style="flex: 1; min-width: 200px; padding: 8px 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 6px; color: var(--white-soft); font-size: 14px;">
                        <button class="btn btn-secondary" onclick="clearIssueFilters()" style="padding: 8px 16px;">
                            <i class="fas fa-times"></i> Limpar
                        </button>
                    </div>
                </div>
            `;
        }

        function renderPagination(total, page, pageSize) {
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            return `
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-top: 20px;">
                    <div style="color: var(--gray-text); font-size: 13px;">Pagina ${page} de ${totalPages} (${total} itens)</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="changeIssuePage(-1)" ${page <= 1 ? 'disabled' : ''}>Anterior</button>
                        <button class="btn btn-secondary" onclick="changeIssuePage(1)" ${page >= totalPages ? 'disabled' : ''}>Proxima</button>
                    </div>
                </div>
            `;
        }

        function renderIssueAccessMessage(title, message, showBack = false) {
            return `
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 40px; text-align: center; border: 1px solid var(--gray-border);">
                    <h2 style="color: var(--white-soft); margin-bottom: 12px;">${escapeHtml(title)}</h2>
                    <p style="color: var(--gray-text); margin-bottom: 20px;">${escapeHtml(message)}</p>
                    ${showBack ? `<button class="btn btn-secondary" onclick="showSection('inicio')">Voltar</button>` : ''}
                </div>
            `;
        }

        async function loadForms() {
            issueUiState.mode = 'my';
            issueUiState.lastListSection = 'formularios';
            const access = await ensureIssueAccess({ requireDev: false });
            if (!access.ok) {
                document.querySelector('.content-card').innerHTML = `
                    <h1 id="sectionTitle">Tarefas de Bug</h1>
                    ${renderIssueAccessMessage('Acesso restrito', access.message, true)}
                `;
                return;
            }

            const profile = access.profile;
            if (issueUiState.view === 'create') {
                await renderIssueCreateView(profile, { title: 'Reportar Bug', allowAssign: canManageIssues(profile) });
                return;
            }
            if (issueUiState.view === 'detail' && issueUiState.selectedId) {
                await renderIssueDetailView(issueUiState.selectedId, profile, { allowManage: canManageIssues(profile), showBack: true });
                return;
            }
            issueUiState.view = 'list';

            const canSeeDev = canViewAllIssues(profile);
            const content = `
                <h1 id="sectionTitle">Tarefas de Bug</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Abra tarefas para o DEV com o máximo de detalhes.</p>
                <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 24px;">
                    <button class="btn-modal btn-success" onclick="openIssueCreate('formularios')">
                        <i class="fas fa-plus"></i> Abrir Tarefa
                    </button>
                    ${canSeeDev ? `
                        <button class="btn-modal btn-secondary" onclick="showSection('dev_backlog')">
                            <i class="fas fa-layer-group"></i> Ir para DEV
                        </button>
                    ` : ''}
                </div>
                ${renderIssueFilters(false)}
                <div id="issuesListContainer"></div>
                <div id="issuesPagination"></div>
            `;
            document.querySelector('.content-card').innerHTML = content;
            syncIssueFilterControls();
            issueUiState.page = 1;
            await refreshIssuesList();
        }

        async function loadDevBacklog() {
            issueUiState.mode = 'backlog';
            if (!['list', 'board'].includes(issueUiState.view)) {
                issueUiState.view = 'board';
            }
            issueUiState.lastListView = issueUiState.view;
            issueUiState.lastListSection = 'dev_backlog';

            const access = await ensureIssueAccess({ requireDev: true });
            if (!access.ok) {
                document.querySelector('.content-card').innerHTML = `
                    <h1 id="sectionTitle">DEV - Backlog</h1>
                    ${renderIssueAccessMessage('Acesso restrito', access.message, true)}
                `;
                return;
            }

            // Pendências DEV também entram no fluxo do DEV (triagem -> conversão em tarefa)
            try {
                await ensurePendenciesLoaded(false);
            } catch (e) {
                console.warn('[dev_backlog] falha ao carregar pendências:', e);
            }

            const devPendencies = Array.from(state?.pendencies?.byId?.values?.() || [])
                .filter(p => {
                    const area = getEffectivePendencyArea(p);
                    const scope = getPendencyScope(p?.type);
                    return area === 'dev' || scope === 'dev';
                })
                .filter(p => {
                    const st = normalizePendencyStatusValue(p?.status, p);
                    return st !== 'completed' && st !== 'rejected';
                })
                .sort((a, b) => {
                    const aTime = new Date(a.createdAt || a.created_at || 0).getTime();
                    const bTime = new Date(b.createdAt || b.created_at || 0).getTime();
                    return bTime - aTime;
                });

            const assumedPendencies = Array.from(state?.pendencies?.byId?.values?.() || [])
                .filter(p => {
                    const area = getEffectivePendencyArea(p);
                    const scope = getPendencyScope(p?.type);
                    return area === 'dev' || scope === 'dev';
                })
                .filter(p => {
                    const assignedUserId = p?.assignedUserId ?? p?.assigned_user_id ?? null;
                    const assignedUserName = p?.assignedUserName ?? p?.assigned_user_name ?? null;
                    return isCurrentUserId(assignedUserId) || isCurrentUserName(assignedUserName);
                })
                .filter(p => {
                    const st = normalizePendencyStatusValue(p?.status, p);
                    return st !== 'completed' && st !== 'rejected';
                })
                .sort((a, b) => {
                    const aTime = new Date(a.updatedAt || a.updated_at || a.createdAt || a.created_at || 0).getTime();
                    const bTime = new Date(b.updatedAt || b.updated_at || b.createdAt || b.created_at || 0).getTime();
                    return bTime - aTime;
                });

            const renderDevPendencyRow = (p) => {
                const status = normalizePendencyStatusValue(p?.status, p);
                const statusLabel = status === 'pending' ? 'Pendente' : status === 'approved' ? 'Aprovada' : status === 'in_progress' ? 'Em andamento' : status;
                const assigned = (p?.assignedUserName || p?.assigned_user_name || '').toString().trim() || 'Sem responsável';
                const createdAt = p?.createdAt || p?.created_at || null;
                const createdLabel = createdAt ? new Date(createdAt).toLocaleDateString('pt-BR') : '';
                const type = (p?.type || '').toString();
                const typeLabel = type ? type.toUpperCase() : 'DEV';
                const typeBadge = getCategoryBadgeStyle(type);
                return `
                    <div style="display:flex; justify-content: space-between; gap: 12px; align-items:flex-start; padding: 12px; border-radius: 12px; background: var(--gray-medium); border: 1px solid var(--gray-border);">
                        <div style="min-width: 220px; flex: 1;">
                            <div style="display:flex; gap: 10px; flex-wrap: wrap; align-items:center;">
                                <div style="color: var(--white-soft); font-weight: 800;">#${escapeHtml(String(p.id || ''))} • ${escapeHtml(p.title || 'Sem título')}</div>
                                <span style="padding: 3px 9px; border-radius: 999px; font-size: 11px; font-weight: 900; background: ${typeBadge.bg}; border: 1px solid ${typeBadge.border}; color: ${typeBadge.text};">${escapeHtml(typeLabel)}</span>
                                <span style="padding: 3px 9px; border-radius: 999px; font-size: 11px; font-weight: 800; background: rgba(255,170,0,.10); border: 1px solid rgba(255,170,0,.35); color: var(--warning);">${escapeHtml(statusLabel)}</span>
                            </div>
                            <div style="margin-top: 8px; color: var(--gray-text); font-size: 12px; display:flex; gap: 14px; flex-wrap: wrap;">
                                <span><i class="fas fa-user"></i> ${escapeHtml(p.userName || p.user_name || 'N/A')}</span>
                                <span><i class="fas fa-user-check"></i> ${escapeHtml(assigned)}</span>
                                ${createdLabel ? `<span><i class="fas fa-calendar"></i> ${escapeHtml(createdLabel)}</span>` : ``}
                            </div>
                        </div>
                        <div style="display:flex; gap: 8px; flex-wrap: wrap; align-items:center;">
                            <button type="button" class="btn btn-secondary" style="width:auto; padding: 10px 12px;" onclick="viewPendencyDetails(${Number(p.id)})">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                            <button type="button" class="btn btn-primary" style="width:auto; padding: 10px 12px;" onclick="assignPendencyToMe(${Number(p.id)})">
                                <i class="fas fa-hand-paper"></i> Assumir
                            </button>
                        </div>
                    </div>
                `;
            };

            const content = `
                <h1 id="sectionTitle">DEV - Tarefas</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Gerencie todas as tarefas enviadas pela staff e acompanhe o fluxo completo.</p>
                <div style="background: var(--black-dark); border-radius: 12px; padding: 16px; border: 1px solid var(--gray-border); margin-bottom: 20px;">
                    <strong style="color: var(--white-soft);">Painel DEV</strong>
                    <p style="color: var(--gray-text); font-size: 13px; margin-top: 6px;">Aqui voce acompanha o que a equipe envia, atualiza status e organiza as prioridades.</p>
                </div>
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 16px; border: 1px solid var(--gray-border); margin-bottom: 18px;">
                    <div style="display:flex; justify-content: space-between; align-items:center; gap: 12px; flex-wrap: wrap;">
                        <div>
                            <div style="color: var(--white-soft); font-weight: 900; font-size: 14px;">
                                <i class="fas fa-clipboard-list" style="color: var(--primary);"></i> Pendências de desenvolvimento (triagem)
                            </div>
                            <div style="color: var(--gray-text); font-size: 12px; margin-top: 6px;">
                                Pendências de desenvolvimento (ex: MAPAS/BUGS/ITENS) aparecem aqui para triagem (ver detalhes e assumir).
                            </div>
                        </div>
                        <div style="display:flex; gap: 10px; align-items:center; flex-wrap: wrap;">
                            <span style="padding: 6px 10px; border-radius: 999px; background: rgba(0,168,255,.10); border: 1px solid rgba(0,168,255,.35); color: var(--primary); font-weight: 900; font-size: 12px;">
                                ${devPendencies.length} abertas
                            </span>
                            <button type="button" class="btn btn-secondary" style="width:auto; padding: 10px 12px;" onclick="showSection('pendencias'); return false;">
                                <i class="fas fa-arrow-left"></i> Ver pendências
                            </button>
                        </div>
                    </div>
                    <div style="margin-top: 14px; display:flex; flex-direction: column; gap: 10px;">
                        ${devPendencies.length === 0 ? `
                            <div style="color: var(--gray-text); font-size: 13px; padding: 10px 6px;">Nenhuma pendência DEV aberta no momento.</div>
                        ` : devPendencies.slice(0, 8).map(renderDevPendencyRow).join('')}
                        ${devPendencies.length > 8 ? `<div style="color: var(--gray-text); font-size: 12px; text-align:center; margin-top: 6px;">Mostrando 8 de ${devPendencies.length}. Veja detalhes na aba Pendências.</div>` : ``}
                    </div>
                </div>
                <div style="margin-bottom: 18px;">
                    <div style="display:flex; justify-content: space-between; align-items:center; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;">
                        <div style="color: var(--white-soft); font-weight: 900; font-size: 14px;">
                            <i class="fas fa-hand-paper" style="color: var(--primary);"></i> Pendências assumidas por você
                        </div>
                        <span style="padding: 6px 10px; border-radius: 999px; background: rgba(0,168,255,.10); border: 1px solid rgba(0,168,255,.35); color: var(--primary); font-weight: 900; font-size: 12px;">
                            ${assumedPendencies.length} ativas
                        </span>
                    </div>
                    ${assumedPendencies.length === 0 ? `
                        <div style="color: var(--gray-text); font-size: 13px; padding: 10px 6px;">Nenhuma pendência atribuída a você no momento.</div>
                    ` : `
                        <div style="display: grid; gap: 16px;">
                            ${assumedPendencies.slice(0, 12).map(p => renderPendencyCard(p, false, false, false, true)).join('')}
                            ${assumedPendencies.length > 12 ? `<div style="color: var(--gray-text); font-size: 12px; text-align:center; margin-top: 2px;">Mostrando 12 de ${assumedPendencies.length}. Veja todas na aba Pendências.</div>` : ``}
                        </div>
                    `}
                </div>
                <!-- Área de tarefas (issues) removida a pedido -->
            `;
            document.querySelector('.content-card').innerHTML = content;
        }

        function openDevIssueFromPendency(pendencyId) {
            const pid = String(pendencyId || '').trim();
            if (!pid) return;
            const pendency = state?.pendencies?.byId?.get?.(pid) || null;
            if (!pendency) {
                alert('Pendência não encontrada no cache. Recarregue a página e tente novamente.');
                return;
            }
            const type = (pendency.type || '').toString().toLowerCase().trim();
            const category = (['bugs', 'mapas', 'carros', 'roupas', 'itens', 'coordenadas', 'logs', 'atualizacoes'].includes(type)) ? type : 'bugs';
            const title = (pendency.title || '').toString().trim();
            const desc = (pendency.description || '').toString().trim();
            const requester = (pendency.userName || pendency.user_name || '').toString().trim();
            const prefillTitle = title ? `Pendência #${pid} - ${title}` : `Pendência #${pid}`;
            const prefillDesc = [
                requester ? `Solicitante: ${requester}` : null,
                `Pendência ID: ${pid}`,
                '',
                desc
            ].filter(v => v !== null).join('\n');

            issueUiState.filters.category = category;
            issueUiState.prefill = {
                category,
                title: prefillTitle,
                description: prefillDesc
            };
            issueUiState.lastListSection = 'dev_backlog';
            showSection('dev_create');
        }

        async function loadDevCreate() {
            issueUiState.mode = 'backlog';
            issueUiState.view = 'create';
            issueUiState.lastListSection = 'dev_backlog';
            const access = await ensureIssueAccess({ requireDev: true });
            if (!access.ok) {
                document.querySelector('.content-card').innerHTML = `
                    <h1 id="sectionTitle">DEV - Criar Tarefa</h1>
                    ${renderIssueAccessMessage('Acesso restrito', access.message, true)}
                `;
                return;
            }
            await renderIssueCreateView(access.profile, { title: 'DEV - Criar Tarefa', allowAssign: true });
        }

        async function loadDevDetail() {
            const access = await ensureIssueAccess({ requireDev: true });
            if (!access.ok) {
                document.querySelector('.content-card').innerHTML = `
                    <h1 id="sectionTitle">DEV - Detalhe da Tarefa</h1>
                    ${renderIssueAccessMessage('Acesso restrito', access.message, true)}
                `;
                return;
            }
            if (!issueUiState.selectedId) {
                showSection('dev_backlog');
                return;
            }
            await renderIssueDetailView(issueUiState.selectedId, access.profile, { allowManage: true, showBack: true });
        }

        async function renderIssueCreateView(profile, options = {}) {
            const allowAssign = !!options.allowAssign;
            const title = options.title || 'Criar Tarefa';
            const statusOptions = ISSUE_STATUSES.map(s => `<option value="${s.value}">${s.label}</option>`).join('');
            const severityOptions = ISSUE_SEVERITIES.map(s => `<option value="${s.value}">${s.label}</option>`).join('');
            const selectedCategory = issueUiState.filters.category || 'all';
            const categoryOptions = ISSUE_CATEGORIES.map(c => `<option value="${c.value}" ${c.value === selectedCategory ? 'selected' : ''}>${c.label}</option>`).join('');

            const assignees = allowAssign ? await fetchAssignees() : [];
            const assigneeOptions = assignees.map(a => `<option value="${escapeHtml(a.display_name || a.id)}">${escapeHtml(a.display_name || a.id)}</option>`).join('');

            const content = `
                <h1 id="sectionTitle">${escapeHtml(title)}</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Descreva o que aconteceu com detalhes para agilizar a correção.</p>
                <form id="issueCreateForm" onsubmit="submitIssueCreate(event)" style="display: grid; gap: 16px;">
                    <div class="input-group">
                        <label>Categoria *</label>
                        <select id="issueCategory" required>
                            ${categoryOptions}
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Titulo *</label>
                        <input type="text" id="issueTitle" placeholder="Ex: Ao abrir o porta malas do Kuruma, o inventario nao abre" required>
                    </div>
                    <div class="input-group">
                        <label>Descricao *</label>
                        <textarea id="issueDescription" rows="4" placeholder="Explique o que ocorreu, o que esperava e o impacto." required></textarea>
                    </div>
                    <div class="input-group">
                        <label>Passos para reproduzir</label>
                        <textarea id="issueSteps" rows="3" placeholder="1) ... 2) ... 3) ..."></textarea>
                    </div>
                    <div class="input-group">
                        <label>Resultado esperado</label>
                        <textarea id="issueExpected" rows="2" placeholder="Ex: Inventario deveria abrir com os itens."></textarea>
                    </div>
                    <div class="input-group">
                        <label>Resultado atual</label>
                        <textarea id="issueActual" rows="2" placeholder="Ex: Inventario nao aparece e itens somem."></textarea>
                    </div>
                    <div style="display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                        <div class="input-group">
                            <label>Severidade</label>
                            <select id="issueSeverity" ${allowAssign ? '' : 'disabled'}>
                                ${severityOptions}
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Status</label>
                            <select id="issueStatus" ${allowAssign ? '' : 'disabled'}>
                                ${statusOptions}
                            </select>
                        </div>
                        ${allowAssign ? `
                        <div class="input-group">
                            <label>Atribuir para</label>
                            <select id="issueAssignedTo">
                                <option value="">Nao atribuido</option>
                                ${assigneeOptions}
                            </select>
                        </div>
                        ` : ''}
                    </div>
                    <div class="input-group">
                        <label>Anexos (imagens ou videos)</label>
                        <input type="file" id="issueAttachmentFiles" multiple accept="image/*,video/*" onchange="handleIssueFileSelect(event)">
                        <div id="issueAttachmentPreview" style="display: grid; gap: 8px; margin-top: 10px;"></div>
                        <label style="margin-top: 8px;">Links (URLs, um por linha)</label>
                        <textarea id="issueAttachmentUrls" rows="3" placeholder="https://..."></textarea>
                        <small style="color: var(--gray-text); display: block; margin-top: 6px;">
                            Dica: use imagens ou videos para facilitar a analise.
                        </small>
                    </div>
                    <div id="issueUploadProgress" style="color: var(--gray-text); font-size: 13px;"></div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-secondary" onclick="cancelIssueCreate()">Cancelar</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Salvar Tarefa</button>
                    </div>
                </form>
            `;
            document.querySelector('.content-card').innerHTML = content;
            // Prefill opcional (ex: vindo de uma pendência DEV)
            try {
                const prefill = issueUiState.prefill;
                if (prefill && typeof prefill === 'object') {
                    if (prefill.category && document.getElementById('issueCategory')) {
                        document.getElementById('issueCategory').value = String(prefill.category);
                    }
                    if (prefill.title && document.getElementById('issueTitle')) {
                        document.getElementById('issueTitle').value = String(prefill.title);
                    }
                    if (prefill.description && document.getElementById('issueDescription')) {
                        document.getElementById('issueDescription').value = String(prefill.description);
                    }
                    issueUiState.prefill = null;
                }
            } catch (e) {
                console.warn('[issues] falha ao aplicar prefill:', e);
            }
            if (!allowAssign) {
                const severitySelect = document.getElementById('issueSeverity');
                const statusSelect = document.getElementById('issueStatus');
                if (severitySelect) severitySelect.value = 'medium';
                if (statusSelect) statusSelect.value = 'open';
            }
        }

        async function renderIssueDetailView(issueId, profile, options = {}) {
            const allowManage = !!options.allowManage;
            const issue = await fetchIssueById(issueId);
            const canView = allowManage || (String(issue.created_by_id || '') === String(currentUser?.id || ''));
            if (!canView) {
                document.querySelector('.content-card').innerHTML = `
                    <h1 id="sectionTitle">Tarefa</h1>
                    ${renderIssueAccessMessage('Acesso restrito', 'Voce nao tem permissao para visualizar esta tarefa.', true)}
                `;
                return;
            }
            const comments = await fetchComments(issueId);
            const attachments = await fetchAttachments(issueId);

            const statusMeta = getStatusMeta(issue.status);
            const severityMeta = getSeverityMeta(issue.severity);
            const createdBy = issue.created_by || 'Desconhecido';
            const assignedTo = issue.assigned_to || 'Nao atribuido';
            const { category, cleanTitle } = extractCategoryFromTitle(issue.title || '');
            const categoryLabel = normalizeCategoryLabel(category);
            const categoryBadge = getCategoryBadgeStyle(category);

            const statusOptions = ISSUE_STATUSES.map(s => `<option value="${s.value}" ${s.value === issue.status ? 'selected' : ''}>${s.label}</option>`).join('');
            const severityOptions = ISSUE_SEVERITIES.map(s => `<option value="${s.value}" ${s.value === issue.severity ? 'selected' : ''}>${s.label}</option>`).join('');
            const assignees = allowManage ? await fetchAssignees() : [];
            const assigneeOptions = assignees.map(a => {
                const value = a.display_name || a.id;
                return `<option value="${escapeHtml(value)}" ${value === issue.assigned_to ? 'selected' : ''}>${escapeHtml(value)}</option>`;
            }).join('');

            const content = `
                <h1 id="sectionTitle">Tarefa #${escapeHtml(issue.id)}</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Detalhes completos da tarefa.</p>
                <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
                    ${categoryLabel ? `<span style="background: ${categoryBadge.bg}; border: 1px solid ${categoryBadge.border}; color: ${categoryBadge.text}; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 800;">${categoryLabel}</span>` : ''}
                    <span style="background: ${statusMeta.color}; color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 700;">${statusMeta.label}</span>
                    <span style="background: rgba(255,255,255,0.08); color: var(--white-soft); padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 700;">${severityMeta.label}</span>
                    <span style="background: rgba(255,255,255,0.08); color: var(--white-soft); padding: 6px 12px; border-radius: 6px; font-size: 12px;">Criado por ${escapeHtml(createdBy)}</span>
                    <span style="background: rgba(255,255,255,0.08); color: var(--white-soft); padding: 6px 12px; border-radius: 6px; font-size: 12px;">Atribuido: ${escapeHtml(assignedTo)}</span>
                </div>
                <div style="display: grid; gap: 16px; margin-bottom: 24px;">
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        <h3 style="color: var(--white-soft); margin-bottom: 8px;">${escapeHtml(cleanTitle || issue.title)}</h3>
                        <p style="color: var(--gray-light); white-space: pre-wrap;">${escapeHtml(issue.description)}</p>
                    </div>
                    ${issue.steps_to_reproduce ? `
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        <h4 style="color: var(--white-soft); margin-bottom: 8px;">Passos para reproduzir</h4>
                        <p style="color: var(--gray-light); white-space: pre-wrap;">${escapeHtml(issue.steps_to_reproduce)}</p>
                    </div>
                    ` : ''}
                    ${issue.expected_result ? `
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        <h4 style="color: var(--white-soft); margin-bottom: 8px;">Resultado esperado</h4>
                        <p style="color: var(--gray-light); white-space: pre-wrap;">${escapeHtml(issue.expected_result)}</p>
                    </div>
                    ` : ''}
                    ${issue.actual_result ? `
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        <h4 style="color: var(--white-soft); margin-bottom: 8px;">Resultado atual</h4>
                        <p style="color: var(--gray-light); white-space: pre-wrap;">${escapeHtml(issue.actual_result)}</p>
                    </div>
                    ` : ''}
                </div>

                ${allowManage ? `
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border); margin-bottom: 24px;">
                    <h3 style="color: var(--white-soft); margin-bottom: 12px;">Atualizar Tarefa</h3>
                    <form id="issueUpdateForm" onsubmit="submitIssueUpdate(event, '${issue.id}')">
                        <div style="display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); margin-bottom: 16px;">
                            <div class="input-group">
                                <label>Categoria</label>
                                <select id="issueUpdateCategory">
                                    <option value="all">Sem categoria</option>
                            ${categoryOptions}
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Status</label>
                                <select id="issueUpdateStatus">${statusOptions}</select>
                            </div>
                            <div class="input-group">
                                <label>Severidade</label>
                                <select id="issueUpdateSeverity">${severityOptions}</select>
                            </div>
                            <div class="input-group">
                                <label>Atribuir para</label>
                                <select id="issueUpdateAssigned">
                                    <option value="">Nao atribuido</option>
                                    ${assigneeOptions}
                                </select>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Titulo</label>
                            <input type="text" id="issueUpdateTitle" value="${escapeHtml(cleanTitle || issue.title)}">
                        </div>
                        <div class="input-group">
                            <label>Descricao</label>
                            <textarea id="issueUpdateDescription" rows="4">${escapeHtml(issue.description)}</textarea>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 16px;">
                            <button class="btn btn-primary" type="submit"><i class="fas fa-save"></i> Salvar Alteracoes</button>
                        </div>
                    </form>
                </div>
                ` : ''}

                <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border); margin-bottom: 24px;">
                    <h3 style="color: var(--white-soft); margin-bottom: 12px;">Anexos</h3>
                    ${renderAttachments(attachments)}
                </div>

                <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                    <h3 style="color: var(--white-soft); margin-bottom: 12px;">Comentarios e retorno do DEV</h3>
                    ${renderComments(comments)}
                    <form id="issueCommentForm" onsubmit="submitIssueComment(event, '${issue.id}')" style="margin-top: 16px;">
                        <div class="input-group">
                            <label>Adicionar comentario</label>
                            <textarea id="issueCommentContent" rows="3" placeholder="Deixe um retorno para quem abriu a tarefa..." required></textarea>
                        </div>
                        <button class="btn btn-primary" type="submit"><i class="fas fa-paper-plane"></i> Enviar</button>
                    </form>
                </div>

                ${options.showBack ? `
                <div style="margin-top: 24px;">
                    <button class="btn btn-secondary" onclick="returnToIssueList()">Voltar</button>
                </div>
                ` : ''}
            `;
            document.querySelector('.content-card').innerHTML = content;
        }

        function renderAttachments(attachments) {
            if (!attachments.length) {
                return `<p style="color: var(--gray-text); font-size: 14px;">Sem anexos.</p>`;
            }
            const items = attachments.map(att => {
                const url = att.storage_url || '';
                const lower = url.toLowerCase();
                const isVideo = lower.endsWith('.mp4') || lower.endsWith('.webm') || lower.endsWith('.mov');
                return `
                    <div style="background: var(--black-dark); border-radius: 12px; padding: 12px; border: 1px solid var(--gray-border);">
                        ${isVideo ? `
                            <video src="${url}" controls style="width: 100%; border-radius: 8px;"></video>
                        ` : `
                            <img src="${url}" alt="${escapeHtml(att.filename)}" style="width: 100%; border-radius: 8px;">
                        `}
                        <div style="color: var(--gray-light); font-size: 12px; margin-top: 8px;">${escapeHtml(att.filename)}</div>
                    </div>
                `;
            }).join('');

            return `
                <div style="display: grid; gap: 12px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                    ${items}
                </div>
            `;
        }

        function renderComments(comments) {
            if (!comments.length) {
                return `<p style="color: var(--gray-text); font-size: 14px;">Nenhum comentario ainda.</p>`;
            }
            return `
                <div style="display: grid; gap: 12px;">
                    ${comments.map(c => `
                        <div style="background: var(--black-dark); border-radius: 10px; padding: 12px; border: 1px solid var(--gray-border);">
                            <div style="display: flex; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                    <strong style="color: var(--white-soft); font-size: 13px;">${escapeHtml(c.author_name || 'Usuario')}</strong>
                                    ${renderCommentRoleBadge(c)}
                                </div>
                                <span style="color: var(--gray-text); font-size: 11px;">${formatDateTime(c.created_at)}</span>
                            </div>
                            <p style="color: var(--gray-light); font-size: 13px; margin-top: 6px; white-space: pre-wrap;">${escapeHtml(c.content)}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderCommentRoleBadge(comment) {
            const role = getStaffRoleFromComment(comment);
            if (!role) return '';
            const isDev = isDevRole(role);
            const label = isDev ? 'DEV' : role;
            const color = isDev ? 'var(--primary)' : 'var(--gray-text)';
            return `<span style="background: ${color}; color: white; padding: 2px 8px; border-radius: 999px; font-size: 10px; font-weight: 700;">${label}</span>`;
        }

        function getStaffRoleFromComment(comment) {
            const staffList = Array.isArray(staffData) ? staffData : [];
            const authorId = String(comment?.author_id || '');
            const authorName = (comment?.author_name || '').toString().toLowerCase();
            const found = staffList.find(member => {
                if (!member) return false;
                const idMatch = authorId && String(member.id || '') === authorId;
                const nameMatch = authorName && ((member.name || '').toString().toLowerCase() === authorName);
                const loginMatch = authorName && ((member.login || '').toString().toLowerCase() === authorName);
                return idMatch || nameMatch || loginMatch;
            });
            return found?.role ? found.role.toString().toLowerCase() : '';
        }

        function renderIssuesBoard(issues) {
            const groups = ISSUE_STATUSES.reduce((acc, status) => {
                acc[status.value] = [];
                return acc;
            }, {});

            issues.forEach(issue => {
                if (issueUiState.filters.category && issueUiState.filters.category !== 'all') {
                    const { category } = extractCategoryFromTitle(issue.title || '');
                    if (category !== issueUiState.filters.category) {
                        return;
                    }
                }
                const key = groups[issue.status] ? issue.status : 'open';
                groups[key].push(issue);
            });

            const columns = ISSUE_STATUSES.map(status => {
                const items = groups[status.value] || [];
                return `
                    <div style="min-width: 260px; background: var(--black-dark); border-radius: 12px; padding: 12px; border: 1px solid var(--gray-border); display: grid; gap: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
                            <strong style="color: var(--white-soft); font-size: 13px;">${status.label}</strong>
                            <span style="color: var(--gray-text); font-size: 12px;">${items.length}</span>
                        </div>
                        <div class="issue-column" data-status="${status.value}" style="display: grid; gap: 10px; min-height: 120px;">
                            ${items.length ? items.map(issue => renderIssueCard(issue)).join('') : `
                                <div style="border: 1px dashed var(--gray-border); border-radius: 10px; padding: 14px; color: var(--gray-text); font-size: 12px; text-align: center;">
                                    Arraste tarefas para ca.
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div style="display: flex; gap: 16px; overflow-x: auto; padding-bottom: 8px;">
                    ${columns}
                </div>
            `;
        }

        function renderIssueCard(issue) {
            const statusMeta = getStatusMeta(issue.status);
            const severityMeta = getSeverityMeta(issue.severity);
            const createdBy = issue.created_by || 'Desconhecido';
            const assignedTo = issue.assigned_to || 'Nao atribuido';
            const canManage = canManageIssues(getIssueUser());
            const canTake = canManage && !issue.assigned_to;
            return `
                <div class="issue-card" draggable="true" data-issue-id="${issue.id}" style="background: var(--gray-dark); border-radius: 10px; padding: 12px; border: 1px solid var(--gray-border); display: grid; gap: 8px; cursor: grab;">
                    <div style="font-size: 13px; font-weight: 700; color: var(--white-soft);">${escapeHtml(issue.title)}</div>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                        <span style="background: ${statusMeta.color}; color: white; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 700;">${statusMeta.label}</span>
                        <span style="background: rgba(255,255,255,0.08); color: var(--white-soft); padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 700;">${severityMeta.label}</span>
                    </div>
                    <div style="color: var(--gray-text); font-size: 11px;">
                        <span><i class="fas fa-user"></i> ${escapeHtml(createdBy)}</span>
                    </div>
                    <div style="color: var(--gray-text); font-size: 11px;">
                        <span><i class="fas fa-user-check"></i> ${escapeHtml(assignedTo)}</span>
                    </div>
                    <div style="display: flex; justify-content: flex-end;">
                        ${canTake ? `
                        <button class="btn-modal btn-secondary" onclick="quickAssignIssueToMe('${issue.id}')" style="padding: 6px 10px; font-size: 11px;">
                            Assumir
                        </button>
                        ` : ''}
                        <button class="btn-modal btn-secondary" onclick="openIssueDetail('${issue.id}')" style="padding: 6px 10px; font-size: 11px;">
                            Detalhes
                        </button>
                    </div>
                </div>
            `;
        }

        function initIssueBoardDnD() {
            const cards = document.querySelectorAll('.issue-card');
            const columns = document.querySelectorAll('.issue-column');
            if (!cards.length || !columns.length) return;

            cards.forEach(card => {
                card.addEventListener('dragstart', (event) => {
                    event.dataTransfer.setData('text/plain', card.dataset.issueId || '');
                    card.style.opacity = '0.6';
                });
                card.addEventListener('dragend', () => {
                    card.style.opacity = '1';
                });
            });

            columns.forEach(column => {
                column.addEventListener('dragover', (event) => {
                    event.preventDefault();
                    column.style.background = 'rgba(255,255,255,0.04)';
                });
                column.addEventListener('dragleave', () => {
                    column.style.background = 'transparent';
                });
                column.addEventListener('drop', async (event) => {
                    event.preventDefault();
                    column.style.background = 'transparent';
                    const issueId = event.dataTransfer.getData('text/plain');
                    const targetStatus = column.dataset.status;
                    if (!issueId || !targetStatus) return;
                    await updateIssueStatusFromBoard(issueId, targetStatus);
                });
            });
        }

        async function updateIssueStatusFromBoard(issueId, status) {
            const access = await ensureIssueAccess({ requireDev: true });
            if (!access.ok) {
                alert(access.message);
                return;
            }
            try {
                await updateIssue(issueId, { status });
                await refreshIssuesBoard();
            } catch (error) {
                console.error('Erro ao mover tarefa:', error);
                alert('Erro ao mover tarefa.');
            }
        }

        async function quickAssignIssueToMe(issueId) {
            const user = getIssueUser();
            if (!user || !user.name) return;
            try {
                await updateIssue(issueId, { assigned_to: user.name });
                if (issueUiState.mode === 'backlog' && issueUiState.view === 'board') {
                    await refreshIssuesBoard();
                } else {
                    await refreshIssuesList();
                }
            } catch (error) {
                console.error('Erro ao assumir tarefa:', error);
                alert('Erro ao assumir tarefa.');
            }
        }

        async function populateAssigneeFilter() {
            const select = document.getElementById('issueAssigneeFilter');
            if (!select) return;
            const assignees = await fetchAssignees();
            const optionValues = new Set();
            assignees.forEach(assignee => {
                const value = (assignee.display_name || assignee.id || '').toString().trim();
                if (!value || optionValues.has(value)) return;
                optionValues.add(value);
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            });
            const myName = (currentUser?.displayName || currentUser?.name || '').toString().trim();
            if (myName && !optionValues.has(myName)) {
                const option = document.createElement('option');
                option.value = myName;
                option.textContent = myName;
                select.appendChild(option);
            }
        }

        async function refreshIssuesList() {
            const listContainer = document.getElementById('issuesListContainer');
            if (!listContainer) return;
            listContainer.innerHTML = '<p style="color: var(--gray-text);">Carregando...</p>';
            try {
                const filters = {
                    status: issueUiState.filters.status,
                    severity: issueUiState.filters.severity,
                    assigned: issueUiState.mode === 'backlog' ? issueUiState.filters.assigned : 'all',
                    search: issueUiState.filters.search,
                    category: issueUiState.filters.category,
                    createdById: issueUiState.mode === 'my' ? (currentUser?.id || null) : null,
                    page: issueUiState.page,
                    pageSize: issueUiState.pageSize
                };
                const { data, count } = await fetchIssues(filters);
                listContainer.innerHTML = renderIssuesList(data);
                const pagination = document.getElementById('issuesPagination');
                if (pagination) {
                    pagination.innerHTML = renderPagination(count, issueUiState.page, issueUiState.pageSize);
                }
                if (issueUiState.mode === 'backlog') {
                    refreshDevStats().catch(() => {});
                }
            } catch (error) {
                console.error('Erro ao carregar tarefas:', error);
                listContainer.innerHTML = '<p style="color: var(--danger);">Erro ao carregar tarefas.</p>';
            }
        }

        async function refreshIssuesBoard() {
            const boardContainer = document.getElementById('issuesBoardContainer');
            if (!boardContainer) return;
            boardContainer.innerHTML = '<p style="color: var(--gray-text);">Carregando...</p>';
            try {
                const filters = {
                    severity: issueUiState.filters.severity,
                    assigned: issueUiState.filters.assigned,
                    search: issueUiState.filters.search,
                    category: issueUiState.filters.category
                };
                const { data } = await fetchIssuesForBoard(filters);
                boardContainer.innerHTML = renderIssuesBoard(data);
                initIssueBoardDnD();
                if (issueUiState.mode === 'backlog') {
                    refreshDevStats().catch(() => {});
                }
            } catch (error) {
                console.error('Erro ao carregar board:', error);
                boardContainer.innerHTML = '<p style="color: var(--danger);">Erro ao carregar board.</p>';
            }
        }

        function syncIssueFilterControls() {
            const category = document.getElementById('issueCategoryFilter');
            const status = document.getElementById('issueStatusFilter');
            const severity = document.getElementById('issueSeverityFilter');
            const assigned = document.getElementById('issueAssigneeFilter');
            const search = document.getElementById('issueSearchInput');
            if (category) category.value = issueUiState.filters.category || 'all';
            if (status) status.value = issueUiState.filters.status || 'all';
            if (severity) severity.value = issueUiState.filters.severity || 'all';
            if (assigned) assigned.value = issueUiState.filters.assigned || 'all';
            if (search) search.value = issueUiState.filters.search || '';
            if (issueUiState.mode === 'backlog' && issueUiState.view === 'board' && status) {
                status.disabled = true;
            } else if (status) {
                status.disabled = false;
            }
        }

        function setIssueCategoryFilter(category) {
            issueUiState.filters.category = category || 'all';
            issueUiState.page = 1;
            showSection('dev_backlog');
        }

        function setIssueStatusFilter(status) {
            issueUiState.filters.status = status || 'all';
            issueUiState.page = 1;
            syncIssueFilterControls();
            if (issueUiState.mode === 'backlog' && issueUiState.view === 'board') {
                refreshIssuesBoard();
            } else {
                refreshIssuesList();
            }
        }

        function applyDevQuickFilter(mode) {
            const myName = (currentUser?.displayName || currentUser?.name || '').toString().trim();
            if (mode === 'mine' && myName) {
                issueUiState.filters.assigned = myName;
            } else if (mode === 'unassigned') {
                issueUiState.filters.assigned = 'unassigned';
            } else if (mode === 'critical') {
                issueUiState.filters.severity = 'critical';
            } else if (mode === 'blocked') {
                issueUiState.filters.status = 'blocked';
            } else {
                issueUiState.filters = { status: 'all', severity: 'all', assigned: 'all', search: '', category: 'all' };
            }

            issueUiState.page = 1;
            syncIssueFilterControls();
            if (issueUiState.mode === 'backlog' && issueUiState.view === 'board') {
                refreshIssuesBoard();
            } else {
                refreshIssuesList();
            }
        }

        function applyIssueFilters() {
            issueUiState.filters.status = document.getElementById('issueStatusFilter')?.value || 'all';
            issueUiState.filters.severity = document.getElementById('issueSeverityFilter')?.value || 'all';
            issueUiState.filters.assigned = document.getElementById('issueAssigneeFilter')?.value || 'all';
            issueUiState.filters.search = document.getElementById('issueSearchInput')?.value?.trim() || '';
            issueUiState.filters.category = document.getElementById('issueCategoryFilter')?.value || 'all';
            issueUiState.page = 1;
            if (issueUiState.mode === 'backlog' && issueUiState.view === 'board') {
                refreshIssuesBoard();
            } else {
                refreshIssuesList();
            }
        }

        function clearIssueFilters() {
            issueUiState.filters = { status: 'all', severity: 'all', assigned: 'all', search: '', category: 'all' };
            const status = document.getElementById('issueStatusFilter');
            const severity = document.getElementById('issueSeverityFilter');
            const assigned = document.getElementById('issueAssigneeFilter');
            const category = document.getElementById('issueCategoryFilter');
            const search = document.getElementById('issueSearchInput');
            if (status) status.value = 'all';
            if (severity) severity.value = 'all';
            if (assigned) assigned.value = 'all';
            if (category) category.value = 'all';
            if (search) search.value = '';
            issueUiState.page = 1;
            if (issueUiState.mode === 'backlog' && issueUiState.view === 'board') {
                refreshIssuesBoard();
            } else {
                refreshIssuesList();
            }
        }

        function changeIssuePage(delta) {
            const nextPage = issueUiState.page + delta;
            if (nextPage < 1) return;
            issueUiState.page = nextPage;
            refreshIssuesList();
        }

        function setDevView(view) {
            if (!['list', 'board'].includes(view)) return;
            issueUiState.view = view;
            issueUiState.lastListView = view;
            const board = document.getElementById('issuesBoardContainer');
            const list = document.getElementById('issuesListContainer');
            const pagination = document.getElementById('issuesPagination');
            const statusFilter = document.getElementById('issueStatusFilter');
            if (board) board.style.display = view === 'board' ? 'block' : 'none';
            if (list) list.style.display = view === 'list' ? 'block' : 'none';
            if (pagination) pagination.style.display = view === 'list' ? 'block' : 'none';
            if (statusFilter) {
                statusFilter.disabled = view === 'board';
                if (view === 'board') statusFilter.value = 'all';
            }
            if (view === 'board') {
                refreshIssuesBoard();
            } else {
                refreshIssuesList();
            }
        }

        function openIssueCreate(targetSection) {
            issueUiState.view = 'create';
            issueUiState.selectedId = null;
            issueUiState.lastListSection = targetSection === 'dev_create' ? 'dev_backlog' : 'formularios';
            if (targetSection === 'dev_create') {
                showSection('dev_create');
            } else {
                showSection('formularios');
            }
        }

        function cancelIssueCreate() {
            issueUiState.view = 'list';
            showSection(issueUiState.lastListSection || 'formularios');
        }

        async function submitIssueCreate(event) {
            event.preventDefault();
            const access = await ensureIssueAccess({ requireDev: issueUiState.lastListSection === 'dev_backlog' });
            if (!access.ok) {
                alert(access.message);
                return;
            }

            const allowAssign = canManageIssues(access.profile);
            const title = document.getElementById('issueTitle')?.value?.trim();
            const category = document.getElementById('issueCategory')?.value || 'all';
            const description = document.getElementById('issueDescription')?.value?.trim();
            if (!title || !description) {
                alert('Preencha titulo e descricao.');
                return;
            }

            const payload = {
                title: applyCategoryToTitle(title, category),
                description,
                steps_to_reproduce: document.getElementById('issueSteps')?.value?.trim(),
                expected_result: document.getElementById('issueExpected')?.value?.trim(),
                actual_result: document.getElementById('issueActual')?.value?.trim(),
                severity: allowAssign ? document.getElementById('issueSeverity')?.value : 'medium',
                status: allowAssign ? document.getElementById('issueStatus')?.value : 'open',
                assigned_to: allowAssign ? document.getElementById('issueAssignedTo')?.value || null : null
            };

            const attachmentText = document.getElementById('issueAttachmentUrls')?.value || '';
            const attachmentLinks = attachmentText
                .split('\n')
                .map(line => line.trim())
                .filter(Boolean);
            const attachmentFiles = Array.from(document.getElementById('issueAttachmentFiles')?.files || []);
            
            try {
                const issue = await createIssue(payload);
                const progress = document.getElementById('issueUploadProgress');
                let uploadedLinks = [];
                if (attachmentFiles.length) {
                    if (progress) progress.textContent = 'Enviando arquivos...';
                    uploadedLinks = await uploadIssueFiles(issue.id, attachmentFiles);
                }
                const allLinks = [...attachmentLinks, ...uploadedLinks];
                if (allLinks.length) {
                    if (progress) progress.textContent = 'Salvando anexos...';
                    await saveAttachmentLinks(issue.id, allLinks);
                }
                issueUiState.view = 'detail';
                issueUiState.selectedId = issue.id;
                if (canManageIssues(access.profile)) {
                    showSection('dev_detail');
                } else {
                    showSection('formularios');
                }
            } catch (error) {
                console.error('Erro ao criar tarefa:', error);
                alert('Erro ao criar tarefa.');
            }
        }

        function openIssueDetail(issueId) {
            const previousView = issueUiState.view;
            issueUiState.selectedId = issueId;
            issueUiState.view = 'detail';
            const profile = getIssueUser();
            if (canViewAllIssues(profile)) {
                issueUiState.lastListSection = 'dev_backlog';
                issueUiState.lastListView = ['list', 'board'].includes(previousView) ? previousView : issueUiState.lastListView;
                showSection('dev_detail');
            } else {
                issueUiState.lastListSection = 'formularios';
                showSection('formularios');
            }
        }

        function returnToIssueList() {
            if (issueUiState.lastListSection === 'dev_backlog' && ['list', 'board'].includes(issueUiState.lastListView)) {
                issueUiState.view = issueUiState.lastListView;
            } else {
                issueUiState.view = 'list';
            }
            issueUiState.selectedId = null;
            showSection(issueUiState.lastListSection || 'formularios');
        }

        async function submitIssueUpdate(event, issueId) {
            event.preventDefault();
            const access = await ensureIssueAccess({ requireDev: true });
            if (!access.ok) {
                alert(access.message);
                return;
            }

            try {
                const category = document.getElementById('issueUpdateCategory')?.value || 'all';
                const rawTitle = document.getElementById('issueUpdateTitle')?.value?.trim();
                await updateIssue(issueId, {
                    status: document.getElementById('issueUpdateStatus')?.value,
                    severity: document.getElementById('issueUpdateSeverity')?.value,
                    assigned_to: document.getElementById('issueUpdateAssigned')?.value || null,
                    title: applyCategoryToTitle(rawTitle || '', category),
                    description: document.getElementById('issueUpdateDescription')?.value?.trim()
                });
                alert('Tarefa atualizada.');
                await renderIssueDetailView(issueId, access.profile, { allowManage: true, showBack: true });
            } catch (error) {
                console.error('Erro ao atualizar tarefa:', error);
                alert('Erro ao atualizar tarefa.');
            }
        }

        async function quickUpdateIssueStatus(issueId) {
            const access = await ensureIssueAccess({ requireDev: true });
            if (!access.ok) {
                alert(access.message);
                return;
            }
            const select = document.getElementById(`issueQuickStatus-${issueId}`);
            const status = select?.value;
            if (!status) return;
            try {
                await updateIssue(issueId, { status });
                await refreshIssuesList();
                if (issueUiState.mode === 'backlog') {
                    refreshDevStats().catch(() => {});
                }
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                alert('Erro ao atualizar status.');
            }
        }

        async function submitIssueComment(event, issueId) {
            event.preventDefault();
            const content = document.getElementById('issueCommentContent')?.value?.trim();
            if (!content) return;
            try {
                await addComment(issueId, content);
                const profile = getIssueUser();
                await renderIssueDetailView(issueId, profile, { allowManage: canManageIssues(profile), showBack: true });
            } catch (error) {
                console.error('Erro ao comentar:', error);
                alert('Erro ao comentar.');
            }
        }

        // ========== VOTAÇÕES ==========

        const STAFF_ROLES_LIST = [
            'Owner', 'CEO', 'COO', 'CMO', 'CCO', 'CIO',
            'Diretor', 'Head Staff', 'Coordenador', 'Admin', 'Moderador', 'Suporte', 'Helper', 'Dev'
        ];

        let pollsUiFilterMode = 'open'; // open | closed | all

        function normalizeRoleKey(role) {
            return (role || '').toString().toLowerCase().replace(/\s+/g, '').trim();
        }

        function pollRoleIsAllowed(poll, roleOrRoles) {
            const allowed = poll?.allowedRoles ?? poll?.allowed_roles;
            if (!Array.isArray(allowed) || allowed.length === 0) return true;
            const normalizedAllowed = new Set(allowed.map(normalizeRoleKey));
            const roles = normalizeRoleList(roleOrRoles);
            if (roles.length === 0) return false;
            return roles.some(r => normalizedAllowed.has(normalizeRoleKey(r)));
        }

        function pollIsOpenNow(poll) {
            const status = (poll?.status || 'open').toString().toLowerCase().trim();
            if (status !== 'open') return false;
            const endsAt = poll?.endsAt ?? poll?.ends_at ?? null;
            if (!endsAt) return true;
            const t = new Date(endsAt).getTime();
            if (!Number.isFinite(t)) return true;
            return Date.now() < t;
        }

        function canManagePolls() {
            return isCLevelRole(currentUser?.roles || currentUser?.role) || isDevRole(currentUser?.roles || currentUser?.role);
        }

        function formatDateTimeBR(value) {
            if (!value) return '';
            const d = new Date(value);
            if (!Number.isFinite(d.getTime())) return '';
            return d.toLocaleString('pt-BR');
        }

        function getCurrentVoterId() {
            const id = currentUser?.id;
            if (id === undefined || id === null) return '';
            return String(id).trim();
        }

        function computePollResults(pollId, options, votes) {
            const optionCounts = new Map();
            let total = 0;
            (options || []).forEach(o => optionCounts.set(String(o.id), 0));
            (votes || []).forEach(v => {
                if (String(v.pollId ?? v.poll_id) !== String(pollId)) return;
                const opt = String(v.optionId ?? v.option_id ?? '');
                if (!opt) return;
                optionCounts.set(opt, (optionCounts.get(opt) || 0) + 1);
                total += 1;
            });
            return { optionCounts, total };
        }

        function setPollsFilter(mode) {
            pollsUiFilterMode = String(mode || 'open');
            loadVotacoes();
        }

        async function loadVotacoes() {
            const contentCard = document.querySelector('.content-card');
            if (!contentCard) return;

            try {
                const [pollsRaw, optionsRaw, votesRaw] = await Promise.all([
                    getData('txd_polls', false),
                    getData('txd_poll_options', false),
                    getData('txd_poll_votes', false)
                ]);

                const polls = Array.isArray(pollsRaw) ? pollsRaw : [];
                const pollOptions = Array.isArray(optionsRaw) ? optionsRaw : [];
                const pollVotes = Array.isArray(votesRaw) ? votesRaw : [];

                const openPolls = polls.filter(p => pollIsOpenNow(p));
                const closedPolls = polls.filter(p => !pollIsOpenNow(p));

                const visiblePolls = pollsUiFilterMode === 'all'
                    ? polls
                    : (pollsUiFilterMode === 'closed' ? closedPolls : openPolls);

                const canCreate = canManagePolls();

                contentCard.innerHTML = `
                <div class=\"commands-header\">
                    <div>
                        <h1 id=\"sectionTitle\" style=\"margin-bottom: 6px;\">🗳️ Votações</h1>
                        <p style=\"color: var(--gray-light); margin: 0;\">Crie votações internas e registre os votos por cargo.</p>
                    </div>
                    <div style=\"display: flex; gap: 10px; align-items: center; flex-wrap: wrap;\">
                        <div class=\"commands-filters\" style=\"margin: 0;\">
                            <div class=\"filter-chip ${pollsUiFilterMode === 'open' ? 'active' : ''}\" onclick=\"setPollsFilter('open')\"><i class=\"fas fa-unlock\"></i> Abertas (${openPolls.length})</div>
                            <div class=\"filter-chip ${pollsUiFilterMode === 'closed' ? 'active' : ''}\" onclick=\"setPollsFilter('closed')\"><i class=\"fas fa-lock\"></i> Encerradas (${closedPolls.length})</div>
                            <div class=\"filter-chip ${pollsUiFilterMode === 'all' ? 'active' : ''}\" onclick=\"setPollsFilter('all')\"><i class=\"fas fa-layer-group\"></i> Todas (${polls.length})</div>
                        </div>
                        ${canCreate ? `
                        <button type=\"button\" class=\"btn btn-primary\" style=\"width:auto; padding: 12px 14px;\" onclick=\"openPollModal(); return false;\">
                            <i class=\"fas fa-plus\"></i> Nova votação
                        </button>` : ``}
                    </div>
                </div>

                <div id=\"pollsList\" style=\"display: flex; flex-direction: column; gap: 14px; margin-top: 16px;\">
                    ${visiblePolls.length === 0 ? `
                        <div class=\"commands-empty\" style=\"padding: 40px 20px;\">
                            <i class=\"fas fa-chart-bar\" style=\"font-size: 54px;\"></i>
                            <div style=\"margin-top: 10px;\">Nenhuma votação para exibir.</div>
                        </div>
                    ` : visiblePolls.map(poll => renderPollCard(poll, pollOptions, pollVotes)).join('')}
                </div>
            `;
            } catch (e) {
                console.error('[polls] Erro ao carregar votações:', e);
                contentCard.innerHTML = `
                    <h1 id=\"sectionTitle\">🗳️ Votações</h1>
                    <div style=\"background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 12px; padding: 20px; margin-top: 16px;\">
                        <div style=\"color: var(--danger); font-weight: 800;\">Erro ao carregar votações</div>
                        <div style=\"color: var(--gray-light); margin-top: 8px;\">Abra o console (F12) para ver detalhes.</div>
                        <div style=\"margin-top: 14px;\">
                            <button type=\"button\" class=\"btn btn-secondary\" style=\"width:auto;\" onclick=\"loadVotacoes(); return false;\">
                                <i class=\"fas fa-rotate\"></i> Tentar novamente
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        function renderPollCard(poll, pollOptions, pollVotes) {
            const pollId = poll?.id;
            const isOpen = pollIsOpenNow(poll);
            const endsAt = poll?.endsAt ?? poll?.ends_at ?? null;
            const createdAt = poll?.createdAt ?? poll?.created_at ?? null;
            const allowed = Array.isArray(poll?.allowedRoles) ? poll.allowedRoles : (Array.isArray(poll?.allowed_roles) ? poll.allowed_roles : []);

            const options = (pollOptions || [])
                .filter(o => String(o.pollId ?? o.poll_id) === String(pollId))
                .sort((a, b) => (a.position ?? 0) - (b.position ?? 0));

            const votes = (pollVotes || []).filter(v => String(v.pollId ?? v.poll_id) === String(pollId));
            const voterId = getCurrentVoterId();
            const myVote = votes.find(v => String(v.voterId ?? v.voter_id) === voterId);
            const hasVoted = !!myVote;

            const canVote = isOpen && pollRoleIsAllowed(poll, currentUser?.roles || currentUser?.role);
            const showResults = !isOpen || hasVoted;
            const { optionCounts, total } = computePollResults(pollId, options, votes);

            return `
                <div style=\"background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 16px; padding: 20px;\">
                    <div style=\"display:flex; justify-content: space-between; gap: 12px; flex-wrap: wrap; align-items: flex-start;\">
                        <div style=\"min-width: 260px; flex: 1;\">
                            <div style=\"display:flex; align-items:center; gap:10px; flex-wrap: wrap;\">
                                <div style=\"font-size: 16px; font-weight: 800; color: var(--white-soft);\">${escapeHtml(poll?.title || 'Sem título')}</div>
                                <span style=\"font-size: 11px; font-weight: 800; letter-spacing: .6px; text-transform: uppercase; padding: 4px 10px; border-radius: 999px; border: 1px solid ${isOpen ? 'rgba(0,255,136,.35)' : 'rgba(255,51,102,.35)'}; color: ${isOpen ? 'var(--success)' : 'var(--danger)'}; background: ${isOpen ? 'rgba(0,255,136,.08)' : 'rgba(255,51,102,.08)'};\">
                                    ${isOpen ? 'ABERTA' : 'ENCERRADA'}
                                </span>
                            </div>
                            ${poll?.description ? `<div style=\"color: var(--gray-light); margin-top: 8px; line-height: 1.6;\">${escapeHtml(poll.description)}</div>` : ``}
                            <div style=\"display:flex; gap: 14px; flex-wrap: wrap; margin-top: 12px; color: var(--gray-text); font-size: 12px;\">
                                <div><i class=\"fas fa-user\"></i> ${escapeHtml(poll?.createdBy || poll?.created_by || 'Sistema')}</div>
                                ${createdAt ? `<div><i class=\"fas fa-clock\"></i> ${formatDateTimeBR(createdAt)}</div>` : ``}
                                ${endsAt ? `<div><i class=\"fas fa-hourglass-end\"></i> Encerra: ${formatDateTimeBR(endsAt)}</div>` : ``}
                            </div>
                            <div style=\"margin-top: 10px; display:flex; flex-wrap: wrap; gap: 8px; align-items: center;\">
                                <span style=\"color: var(--gray-text); font-size: 12px; font-weight: 700;\">Pode votar:</span>
                                ${(allowed && allowed.length > 0) ? allowed.map(r => `<span style=\"padding: 4px 10px; border-radius: 999px; border: 1px solid rgba(207,207,207,.25); background: rgba(207,207,207,.08); color: var(--gray-very-light); font-size: 12px;\">${escapeHtml(r)}</span>`).join('') : `<span style=\"padding: 4px 10px; border-radius: 999px; border: 1px solid rgba(0,255,136,.25); background: rgba(0,255,136,.08); color: var(--success); font-size: 12px;\">Todos</span>`}
                            </div>
                        </div>

                        ${canManagePolls() ? `
                        <div style=\"display:flex; gap: 8px; align-items:center; flex-wrap: wrap;\">
                            <button type=\"button\" class=\"btn btn-secondary\" style=\"width:auto; padding: 10px 12px;\" onclick=\"openPollModal(${pollId}); return false;\"><i class=\"fas fa-pen\"></i> Editar</button>
                            ${isOpen ? `<button type=\"button\" class=\"btn btn-danger\" style=\"width:auto; padding: 10px 12px;\" onclick=\"closePoll(${pollId}); return false;\"><i class=\"fas fa-lock\"></i> Encerrar</button>` : ``}
                            <button type=\"button\" class=\"btn btn-secondary\" style=\"width:auto; padding: 10px 12px; border-color: rgba(255,51,102,.35); color: var(--danger);\" onclick=\"deletePoll(${pollId}); return false;\"><i class=\"fas fa-trash\"></i></button>
                        </div>` : ``}
                    </div>

                    <div style=\"margin-top: 16px; display: grid; grid-template-columns: 1fr; gap: 12px;\">
                        ${options.length === 0 ? `
                            <div style=\"color: var(--gray-text); font-size: 13px;\">Sem opções cadastradas.</div>
                        ` : options.map(opt => renderPollOption(pollId, opt, { isOpen, canVote, hasVoted, showResults, myVote, optionCounts, total })).join('')}
                    </div>

                    ${(!canVote && isOpen && !hasVoted) ? `
                        <div style=\"margin-top: 14px; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,170,0,.35); background: rgba(255,170,0,.08); color: var(--warning); font-weight: 600;\">
                            <i class=\"fas fa-ban\"></i> Seu cargo (${escapeHtml(normalizeRoleList(currentUser?.roles || currentUser?.role).join(' + ') || currentUser?.role || 'N/A')}) não está autorizado a votar nesta votação.
                        </div>
                    ` : ``}

                    ${(!showResults && isOpen && canVote && !hasVoted) ? `
                        <div style=\"margin-top: 14px; color: var(--gray-text); font-size: 12px;\">
                            Os resultados serão exibidos após você votar ou quando a votação for encerrada.
                        </div>
                    ` : ``}

                    <div style=\"margin-top: 12px; color: var(--gray-text); font-size: 12px;\">
                        Total de votos: <strong style=\"color: var(--white-soft);\">${total}</strong>
                    </div>
                </div>
            `;
        }

        function renderPollOption(pollId, opt, ctx) {
            const optId = opt?.id;
            const optText = opt?.optionText ?? opt?.option_text ?? '';
            const count = ctx.optionCounts.get(String(optId)) || 0;
            const percent = ctx.total > 0 ? Math.round((count / ctx.total) * 100) : 0;
            const selected = ctx.hasVoted && String(ctx.myVote?.optionId ?? ctx.myVote?.option_id) === String(optId);

            if (!ctx.showResults && ctx.isOpen && ctx.canVote && !ctx.hasVoted) {
                return `
                    <div style=\"display:flex; gap: 10px; align-items:center; padding: 12px; border-radius: 12px; background: var(--gray-medium); border: 1px solid var(--gray-border);\">
                        <div style=\"flex: 1; color: var(--white-soft);\">${escapeHtml(optText || 'Opção')}</div>
                        <button type=\"button\" class=\"btn btn-primary\" style=\"width:auto; padding: 10px 12px;\" onclick=\"event && event.preventDefault && event.preventDefault(); event && event.stopPropagation && event.stopPropagation(); voteOnPoll(${pollId}, ${optId}); return false;\">
                            <i class=\"fas fa-check\"></i> Votar
                        </button>
                    </div>
                `;
            }

            return `
                <div style=\"padding: 12px; border-radius: 12px; background: ${selected ? 'rgba(0,255,136,.08)' : 'var(--gray-medium)'}; border: 1px solid ${selected ? 'rgba(0,255,136,.35)' : 'var(--gray-border)'};\">
                    <div style=\"display:flex; align-items:center; justify-content: space-between; gap: 12px;\">
                        <div style=\"flex:1; color: var(--white-soft); font-weight: ${selected ? '800' : '600'};\">
                            ${selected ? '✅ ' : ''}${escapeHtml(optText || 'Opção')}
                        </div>
                        <div style=\"color: var(--gray-very-light); font-weight: 700;\">${count} (${percent}%)</div>
                    </div>
                    <div style=\"margin-top: 10px; height: 10px; border-radius: 999px; overflow: hidden; border: 1px solid rgba(255,255,255,.08); background: rgba(0,0,0,.25);\">
                        <div style=\"height: 100%; width: ${percent}%; background: linear-gradient(90deg, var(--success), var(--gray-very-light));\"></div>
                    </div>
                </div>
            `;
        }

        function renderAllowedRolesChecklist(selectedRoles = []) {
            const container = document.getElementById('pollAllowedRoles');
            if (!container) return;
            const selected = new Set((selectedRoles || []).map(normalizeRoleKey));
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px;">
                    ${STAFF_ROLES_LIST.map(role => {
                        const checked = selected.has(normalizeRoleKey(role));
                        return `
                            <label style="display:flex; gap: 10px; align-items:center; padding: 10px; border-radius: 10px; background: rgba(0,0,0,.15); border: 1px solid rgba(255,255,255,.08); cursor: pointer;">
                                <input type="checkbox" value="${escapeHtml(role)}" ${checked ? 'checked' : ''} style="width: 18px; height: 18px;">
                                <span style="color: var(--white-soft); font-weight: 600; font-size: 13px;">${escapeHtml(role)}</span>
                            </label>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function getSelectedAllowedRolesFromModal() {
            const container = document.getElementById('pollAllowedRoles');
            if (!container) return [];
            const boxes = Array.from(container.querySelectorAll('input[type="checkbox"]'));
            return boxes.filter(b => b.checked).map(b => b.value);
        }

        function addPollOptionRow(value = '') {
            const list = document.getElementById('pollOptionsList');
            if (!list) return;
            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.gap = '10px';
            row.style.alignItems = 'center';
            row.innerHTML = `
                <input class="poll-option-input" type="text" value="${escapeHtml(value)}" placeholder="Ex: Sim" style="flex:1; padding: 12px 14px; background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 12px; color: var(--white-soft); font-size: 14px;" required>
                <button type="button" class="btn btn-secondary" style="width:auto; padding: 10px 12px;" title="Remover opção">
                    <i class="fas fa-times"></i>
                </button>
            `;
            row.querySelector('button')?.addEventListener('click', () => row.remove());
            list.appendChild(row);
        }

        function getPollOptionsFromModal() {
            const list = document.getElementById('pollOptionsList');
            if (!list) return [];
            const inputs = Array.from(list.querySelectorAll('.poll-option-input'));
            return inputs.map(i => i.value.trim()).filter(v => v);
        }

        async function openPollModal(pollId = null) {
            if (!canManagePolls()) {
                alert('Você não tem permissão para criar/editar votações.');
                return;
            }
            const modal = document.getElementById('pollModal');
            if (!modal) return;

            document.getElementById('pollForm')?.reset?.();
            document.getElementById('pollId').value = pollId ? String(pollId) : '';
            document.getElementById('pollModalTitle').textContent = pollId ? 'Editar Votação' : 'Nova Votação';

            const list = document.getElementById('pollOptionsList');
            if (list) list.innerHTML = '';

            if (!pollId) {
                renderAllowedRolesChecklist([]);
                addPollOptionRow('');
                addPollOptionRow('');
                document.getElementById('pollStatus').value = 'open';
                modal.classList.add('active');
                return;
            }

            const [pollsRaw, optionsRaw, votesRaw] = await Promise.all([
                getData('txd_polls', false),
                getData('txd_poll_options', false),
                getData('txd_poll_votes', false)
            ]);
            const polls = Array.isArray(pollsRaw) ? pollsRaw : [];
            const pollOptions = Array.isArray(optionsRaw) ? optionsRaw : [];
            const pollVotes = Array.isArray(votesRaw) ? votesRaw : [];

            const poll = polls.find(p => String(p.id) === String(pollId));
            if (!poll) {
                alert('Votação não encontrada.');
                return;
            }

            document.getElementById('pollTitle').value = poll.title || '';
            document.getElementById('pollDescription').value = poll.description || '';
            document.getElementById('pollStatus').value = (poll.status || 'open');

            const endsAt = poll.endsAt ?? poll.ends_at ?? null;
            if (endsAt) {
                const d = new Date(endsAt);
                if (Number.isFinite(d.getTime())) {
                    const pad = (n) => String(n).padStart(2, '0');
                    const local = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
                    document.getElementById('pollEndsAt').value = local;
                }
            }

            const allowed = Array.isArray(poll.allowedRoles) ? poll.allowedRoles : (Array.isArray(poll.allowed_roles) ? poll.allowed_roles : []);
            renderAllowedRolesChecklist(allowed);

            const votes = pollVotes.filter(v => String(v.pollId ?? v.poll_id) === String(pollId));
            const hasVotes = votes.length > 0;

            const options = pollOptions
                .filter(o => String(o.pollId ?? o.poll_id) === String(pollId))
                .sort((a, b) => (a.position ?? 0) - (b.position ?? 0));

            if (!hasVotes) {
                if (options.length > 0) {
                    options.forEach(o => addPollOptionRow(o.optionText ?? o.option_text ?? ''));
                } else {
                    addPollOptionRow('');
                    addPollOptionRow('');
                }
            } else {
                const info = document.createElement('div');
                info.style.color = 'var(--warning)';
                info.style.fontWeight = '700';
                info.style.fontSize = '13px';
                info.style.marginBottom = '10px';
                info.innerHTML = '<i class="fas fa-info-circle"></i> Esta votação já possui votos. As opções não podem ser alteradas.';
                list?.appendChild(info);
                options.forEach(o => {
                    const optText = o.optionText ?? o.option_text ?? '';
                    const row = document.createElement('div');
                    row.style.padding = '12px 14px';
                    row.style.borderRadius = '12px';
                    row.style.background = 'rgba(0,0,0,.15)';
                    row.style.border = '1px solid rgba(255,255,255,.08)';
                    row.style.color = 'var(--white-soft)';
                    row.textContent = optText || 'Opção';
                    list?.appendChild(row);
                });
            }

            modal.classList.add('active');
        }

        async function savePoll(event) {
            event.preventDefault();
            if (!supabaseClient) {
                alert('Supabase não está disponível.');
                return;
            }
            if (!canManagePolls()) {
                alert('Você não tem permissão para criar/editar votações.');
                return;
            }

            const pollIdValue = document.getElementById('pollId')?.value?.trim();
            const title = document.getElementById('pollTitle')?.value?.trim();
            const description = document.getElementById('pollDescription')?.value?.trim() || null;
            const endsAtLocal = document.getElementById('pollEndsAt')?.value?.trim() || '';
            const status = (document.getElementById('pollStatus')?.value || 'open').toString().trim();
            const allowedRoles = getSelectedAllowedRolesFromModal();

            if (!title) {
                alert('Informe o título da votação.');
                return;
            }

            const endsAtIso = endsAtLocal ? new Date(endsAtLocal).toISOString() : null;

            const opKey = pollIdValue ? `poll:save:${pollIdValue}` : `poll:create:${title}`;
            return withIdempotency(opKey, async () => {
                try {
                    if (!pollIdValue) {
                        const { data: inserted, error: insertError } = await supabaseClient
                            .from('polls')
                            .insert([{
                                title,
                                description,
                                status,
                                ends_at: endsAtIso,
                                allowed_roles: allowedRoles,
                                created_by: currentUser?.name || currentUser?.displayName || 'Sistema',
                                created_by_id: getCurrentVoterId() || null
                            }])
                            .select('*')
                            .single();
                        if (insertError) throw insertError;

                        const options = getPollOptionsFromModal();
                        if (options.length < 2) {
                            alert('Adicione pelo menos 2 opções.');
                            await supabaseClient.from('polls').delete().eq('id', inserted.id);
                            return;
                        }
                        const rows = options.map((opt, idx) => ({
                            poll_id: inserted.id,
                            option_text: opt,
                            position: idx
                        }));
                        const { error: optError } = await supabaseClient.from('poll_options').insert(rows);
                        if (optError) throw optError;
                    } else {
                        const pollId = Number(pollIdValue);
                        const { error: updateError } = await supabaseClient
                            .from('polls')
                            .update({
                                title,
                                description,
                                status,
                                ends_at: endsAtIso,
                                allowed_roles: allowedRoles
                            })
                            .eq('id', pollId);
                        if (updateError) throw updateError;

                        const { data: votes, error: votesError } = await supabaseClient
                            .from('poll_votes')
                            .select('id')
                            .eq('poll_id', pollId)
                            .limit(1);
                        if (votesError) throw votesError;
                        const hasVotes = Array.isArray(votes) && votes.length > 0;

                        if (!hasVotes) {
                            const options = getPollOptionsFromModal();
                            if (options.length < 2) {
                                alert('Adicione pelo menos 2 opções.');
                                return;
                            }
                            await supabaseClient.from('poll_options').delete().eq('poll_id', pollId);
                            const rows = options.map((opt, idx) => ({
                                poll_id: pollId,
                                option_text: opt,
                                position: idx
                            }));
                            const { error: optError } = await supabaseClient.from('poll_options').insert(rows);
                            if (optError) throw optError;
                        }
                    }

                    clearCacheKey('txd_polls');
                    clearCacheKey('txd_poll_options');
                    clearCacheKey('txd_poll_votes');

                    closeModal('pollModal');
                    await loadVotacoes();
                } catch (error) {
                    console.error('Erro ao salvar votação:', error);
                    alert(`Erro ao salvar votação: ${error?.message || 'erro desconhecido'}`);
                }
            });
        }

        async function closePoll(pollId) {
            if (!canManagePolls()) {
                alert('Você não tem permissão para encerrar votações.');
                return;
            }
            if (!confirm('Encerrar esta votação?')) return;
            if (!supabaseClient) return;

            return withIdempotency(`poll:close:${pollId}`, async () => {
                try {
                    const { error } = await supabaseClient
                        .from('polls')
                        .update({ status: 'closed' })
                        .eq('id', pollId);
                    if (error) throw error;
                    clearCacheKey('txd_polls');
                    await loadVotacoes();
                } catch (e) {
                    console.error('Erro ao encerrar votação:', e);
                    alert('Erro ao encerrar votação.');
                }
            });
        }

        async function deletePoll(pollId) {
            if (!canManagePolls()) {
                alert('Você não tem permissão para excluir votações.');
                return;
            }
            if (!confirm('Excluir esta votação? Isso remove opções e votos.')) return;
            if (!supabaseClient) return;

            return withIdempotency(`poll:delete:${pollId}`, async () => {
                try {
                    const { error } = await supabaseClient
                        .from('polls')
                        .delete()
                        .eq('id', pollId);
                    if (error) throw error;
                    clearCacheKey('txd_polls');
                    clearCacheKey('txd_poll_options');
                    clearCacheKey('txd_poll_votes');
                    await loadVotacoes();
                } catch (e) {
                    console.error('Erro ao excluir votação:', e);
                    alert('Erro ao excluir votação.');
                }
            });
        }

        async function voteOnPoll(pollId, optionId) {
            if (!supabaseClient) {
                alert('Supabase não está disponível.');
                return;
            }
            const voterId = getCurrentVoterId();
            if (!voterId) {
                alert('Usuário inválido para votar.');
                return;
            }

            return withIdempotency(`poll:vote:${pollId}`, async () => {
                try {
                    const [pollsRaw, votesRaw] = await Promise.all([
                        getData('txd_polls', false),
                        getData('txd_poll_votes', false)
                    ]);
                    const polls = Array.isArray(pollsRaw) ? pollsRaw : [];
                    const votes = Array.isArray(votesRaw) ? votesRaw : [];

                    const poll = polls.find(p => String(p.id) === String(pollId));
                    if (!poll) {
                        alert('Votação não encontrada.');
                        return;
                    }
                    if (!pollIsOpenNow(poll)) {
                        alert('Esta votação já foi encerrada.');
                        return;
                    }
                    if (!pollRoleIsAllowed(poll, currentUser?.roles || currentUser?.role)) {
                        alert('Seu cargo não está autorizado a votar nesta votação.');
                        return;
                    }

                    const existing = votes.find(v => String(v.pollId ?? v.poll_id) === String(pollId) && String(v.voterId ?? v.voter_id) === voterId);
                    if (existing) {
                        alert('Você já votou nesta votação.');
                        return;
                    }

                    const { error } = await supabaseClient
                        .from('poll_votes')
                        .insert([{
                            poll_id: pollId,
                            option_id: optionId,
                            voter_id: voterId,
                            voter_name: currentUser?.name || currentUser?.displayName || 'Usuário',
                            voter_role: (normalizeRoleList(currentUser?.roles || currentUser?.role).join(' + ') || currentUser?.role || null)
                        }]);
                    if (error) throw error;

                    clearCacheKey('txd_poll_votes');
                    await loadVotacoes();
                } catch (e) {
                    console.error('Erro ao votar:', e);
                    const msg = (e?.message || '').toLowerCase();
                    if (msg.includes('duplicate') || msg.includes('unique')) {
                        alert('Você já votou nesta votação.');
                        return;
                    }
                    alert('Erro ao registrar seu voto.');
                }
            });
        }

        // Mapeamento de dados necessários por seção (lazy loading)
        const sectionDataMap = {
            'inicio': ['txd_staff', 'txd_system_logs'],
            'tarefas': ['txd_kanban', 'txd_staff'],
            'ranking': ['txd_kanban', 'txd_pendencies', 'txd_staff'],
            'conquistas': ['txd_kanban', 'txd_pendencies', 'txd_staff'],
            'estatisticas': ['txd_kanban', 'txd_pendencies', 'txd_staff', 'txd_chat_messages'],
            'controle': ['txd_staff', 'txd_registration_requests'],
            'comandos': ['txd_commands', 'txd_favorite_commands', 'txd_command_usage'],
            'agenda': ['txd_events'],
            'formularios': ['txd_pendencies', 'txd_staff'],
            'dev_backlog': ['txd_staff', 'txd_pendencies'],
            'dev_create': ['txd_staff'],
            'dev_detail': ['txd_staff'],
            'pendencias': ['txd_pendencies', 'txd_staff'],
            'votacoes': ['txd_polls', 'txd_poll_options', 'txd_poll_votes', 'txd_staff'],
            'relatorios': ['txd_staff', 'txd_pendencies', 'txd_events'],
            'advertencias': ['txd_staff', 'txd_warnings'],
            'areas': ['txd_areas', 'txd_staff'],
            'perfil': ['txd_staff', 'txd_license_requests', 'txd_user_achievements', 'txd_system_logs', 'txd_kanban', 'txd_pendencies', 'txd_chat_messages'],
            'config': ['txd_system_settings', 'txd_security_settings', 'txd_discord_config']
        };
        
        // Função para carregar apenas dados necessários para uma seção
        async function loadSectionData(section) {
            const neededKeys = sectionDataMap[section] || [];
            if (neededKeys.length === 0) return;
            
            // Carregar apenas os dados necessários (usando cache quando possível)
            await Promise.all(neededKeys.map(key => getData(key, false)));
        }
        
        // Atualizar showSection para carregar conteúdo de forma otimizada (não bloqueia UI)
        const originalShowSectionFunc = showSection;
        showSection = function(section) {
            if (originalShowSectionFunc) originalShowSectionFunc(section);

            // Nova navegação (permite ignorar renders atrasados)
            const navSeq = bumpNavSeq();

            // Mostrar feedback imediato e renderizar a seção no próximo frame (melhora sensação de velocidade)
            try { renderSectionLoading('Carregando…'); } catch (e) {}
            nextFrame().then(() => {
                if (navSeq !== activeNavSeq) return;
                loadSectionContent(section);
            }).catch(() => {
                // fallback
                if (navSeq !== activeNavSeq) return;
                try { loadSectionContent(section); } catch (e) {}
            });

            // Carregar dados em background (não bloqueia renderização)
            loadSectionData(section).catch(err => {
                debugWarn('Erro ao carregar dados da seção em background:', err);
            });

            // Salvar última seção (persistência)
            try {
                const raw = localStorage.getItem(SESSION_STORAGE_KEY);
                if (raw) {
                    const parsed = JSON.parse(raw);
                    parsed.lastSection = String(section || 'inicio');
                    localStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(parsed));
                }
            } catch (e) {}
        };

        // Inicializar
        (async function initApp() {
            const restored = await restoreSessionIfAvailable();
            if (!restored) {
                renderDevMenuItem();
                refreshData();
            }

            // Prefetch leve para reduzir lag ao trocar abas
            (function schedulePrefetch() {
                const run = () => {
                    // evita estourar requests: pega só o essencial (cache + SWR)
                    Promise.allSettled([
                        getData('txd_staff', false),
                        getData('txd_pendencies', false),
                        getData('txd_kanban', false),
                        getData('txd_events', false)
                    ]).catch(() => {});
                };
                try {
                    if (typeof requestIdleCallback === 'function') {
                        requestIdleCallback(run, { timeout: 1500 });
                    } else {
                        setTimeout(run, 600);
                    }
                } catch (e) {
                    setTimeout(run, 800);
                }
            })();

            if (!restored) {
                if (document.getElementById('dashboard').classList.contains('active')) {
                    loadDashboard();
                } else {
                    // Carregar conteúdo inicial se não estiver no dashboard
                    const content = `
                        <h1 id="sectionTitle">Bem-vindo ao Painel TXD Staff</h1>
                        <p style="color: var(--gray-light); margin-bottom: 24px;">Selecione uma opção no menu para começar.</p>
                    `;
                    document.getElementById('mainContent').innerHTML = content;
                }
            }
        })();
    </script>

</body>
</html>
