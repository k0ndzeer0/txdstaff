<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TXD Staff System - Painel Completo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Paleta de cores TXD */
            --black-deep: #0B0B0C;
            --black-dark: #1A1B1D;
            --gray-dark: #2A2C2F;
            --gray-medium: #3A3D41;
            --gray-border: #55585C;
            --gray-text: #6F7276;
            --gray-light: #9A9A9A;
            --gray-very-light: #CFCFCF;
            --white-soft: #F2F2F2;
            
            /* Cores de destaque - usando tons da paleta */
            --accent-primary: var(--gray-very-light);
            --accent-hover: var(--white-soft);
            --success: #00ff88;
            --danger: #ff3366;
            --warning: #ffaa00;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--black-deep);
            color: var(--white-soft);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Background com imagem */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://tdatgzjwcuatpqhfococ.supabase.co/storage/v1/object/public/logos/Design%20sem%20nome%20(1).jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            z-index: -2;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(11, 11, 12, 0.75);
            z-index: -1;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: var(--black-dark);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--gray-border);
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-text);
        }

        .hidden {
            display: none !important;
        }

        /* ========== LOGIN SCREEN ========== */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: rgba(26, 27, 29, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid var(--gray-border);
            border-radius: 24px;
            padding: 48px;
            max-width: 420px;
            width: 100%;
            text-align: center;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(122, 44, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-image {
            max-width: 200px;
            height: auto;
            display: block;
            margin: 0 auto 20px;
        }

        .subtitle {
            color: var(--gray-light);
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 40px;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--gray-medium);
            color: var(--white-soft);
            border: 1px solid var(--gray-border);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            background: var(--gray-border);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.4);
        }

        .btn-secondary {
            background: transparent;
            color: var(--gray-very-light);
            border: 1px solid var(--gray-border);
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: var(--gray-dark);
            border-color: var(--gray-text);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        }

        /* ========== MODALS ========== */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: rgba(26, 27, 29, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid var(--gray-border);
            border-radius: 24px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-lg {
            max-width: 900px;
        }

        .close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: var(--gray-text);
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            transition: all 0.3s ease;
        }

        .close:hover {
            background: var(--gray-medium);
            border-color: var(--gray-text);
            color: var(--white-soft);
        }

        .modal-header {
            margin-bottom: 24px;
            padding-right: 40px;
        }

        .modal-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--white-soft);
            margin-bottom: 8px;
        }

        .confidential-badge {
            background: rgba(255, 51, 102, 0.2);
            color: var(--danger);
            padding: 8px 16px;
            border-radius: 8px;
            display: inline-block;
            margin-bottom: 20px;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid rgba(255, 51, 102, 0.3);
        }

        .term-section {
            text-align: left;
            margin: 20px 0;
        }

        .term-section h4 {
            color: var(--gray-very-light);
            margin: 20px 0 12px;
            font-size: 16px;
            font-weight: 700;
        }

        .term-section p {
            line-height: 1.8;
            color: var(--gray-light);
            margin-bottom: 16px;
        }

        .term-section strong {
            color: var(--white-soft);
        }

        .highlight-danger {
            color: var(--danger);
            font-weight: 700;
        }

        /* ========== INPUTS ========== */
        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--white-soft);
            font-weight: 600;
            font-size: 14px;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 12px 16px;
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 12px;
            color: var(--white-soft);
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .input-group input:focus,
        .input-group textarea:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--gray-text);
            background: var(--gray-medium);
            box-shadow: 0 0 0 3px rgba(111, 114, 118, 0.1);
        }

        .input-group input::placeholder,
        .input-group textarea::placeholder {
            color: var(--gray-text);
        }

        .input-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* ========== DASHBOARD ========== */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .navbar {
            background: rgba(26, 27, 29, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--gray-border);
            padding: 20px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            min-height: 100px;
        }

        .navbar-logo {
            height: 90px !important;
            width: auto !important;
            display: block;
            object-fit: contain;
        }

        .nav-menu {
            display: flex;
            gap: 8px;
            list-style: none;
            flex-wrap: wrap;
        }

        .nav-menu li a {
            color: var(--gray-light);
            text-decoration: none;
            font-weight: 500;
            padding: 10px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .nav-menu li a:hover {
            color: var(--white-soft);
            background: var(--gray-dark);
        }

        .nav-menu li a.active {
            color: var(--white-soft);
            background: var(--gray-medium);
            border-bottom: 2px solid var(--gray-very-light);
        }

        .content-card {
            background: rgba(26, 27, 29, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid var(--gray-border);
            border-radius: 16px;
            padding: 32px;
            margin: 24px;
            transition: all 0.3s ease;
        }

        .content-card:hover {
            border-color: var(--gray-text);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .content-card h1 {
            color: var(--white-soft);
            margin-bottom: 12px;
            font-size: 32px;
            font-weight: 700;
        }

        .content-card p {
            color: var(--gray-light);
            margin-bottom: 24px;
        }

        .btn-modal {
            background: var(--gray-medium);
            color: var(--white-soft);
            border: 1px solid var(--gray-border);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .btn-modal:hover {
            transform: translateY(-2px);
            background: var(--gray-border);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #cc0000 100%);
        }

        .btn-danger:hover {
            box-shadow: 0 4px 16px rgba(255, 51, 102, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #00cc66 100%);
        }

        .btn-success:hover {
            box-shadow: 0 4px 16px rgba(0, 255, 136, 0.4);
        }

        /* Checkbox customizado */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--gray-dark);
            border: 1px dashed var(--gray-border);
            border-radius: 8px;
            margin: 20px 0;
        }

        .checkbox-container input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: var(--gray-text);
        }

        .checkbox-container label {
            color: var(--white-soft);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 0;
        }

        /* Kanban Styles */
        .kanban-column {
            transition: all 0.3s ease;
        }

        .kanban-column:hover {
            border-color: var(--gray-text);
        }

        .kanban-card {
            user-select: none;
        }

        .kanban-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .kanban-cards {
            transition: background-color 0.2s ease;
        }

        .kanban-cards.drag-over {
            background: rgba(111, 114, 118, 0.1);
            border-radius: 8px;
        }

        /* ========== CHAT INTERNO ========== */
        .chat-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: calc(100vh - 200px);
            max-height: 700px;
        }

        .chat-sidebar {
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 16px;
            padding: 20px;
            overflow-y: auto;
        }

        .chat-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 8px;
            border: 1px solid transparent;
        }

        .chat-list-item:hover {
            background: var(--gray-medium);
            border-color: var(--gray-border);
        }

        .chat-list-item.active {
            background: var(--gray-medium);
            border-color: var(--gray-text);
        }

        .chat-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gray-medium), var(--gray-border));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 600;
            color: var(--white-soft);
            font-size: 14px;
            margin-bottom: 2px;
        }

        .chat-last-message {
            color: var(--gray-text);
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-badge {
            background: var(--success);
            color: var(--black-deep);
            font-size: 11px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        .chat-main {
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray-border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-info h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--white-soft);
            margin-bottom: 2px;
        }

        .chat-header-status {
            font-size: 12px;
            color: var(--success);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-message {
            display: flex;
            gap: 12px;
            max-width: 70%;
        }

        .chat-message.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .chat-message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gray-medium), var(--gray-border));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }

        .chat-message-content {
            flex: 1;
        }

        .chat-message-bubble {
            background: var(--gray-medium);
            border: 1px solid var(--gray-border);
            padding: 12px 16px;
            border-radius: 16px;
            color: var(--white-soft);
            line-height: 1.5;
            word-wrap: break-word;
        }

        .chat-message.sent .chat-message-bubble {
            background: rgba(207, 207, 207, 0.15);
            border-color: rgba(207, 207, 207, 0.3);
        }

        .chat-message-time {
            font-size: 11px;
            color: var(--gray-text);
            margin-top: 4px;
            padding: 0 8px;
        }

        .chat-input-area {
            padding: 20px;
            border-top: 1px solid var(--gray-border);
            display: flex;
            gap: 12px;
        }

        .chat-input {
            flex: 1;
            background: var(--gray-medium);
            border: 1px solid var(--gray-border);
            border-radius: 12px;
            padding: 12px 16px;
            color: var(--white-soft);
            font-size: 14px;
            font-family: inherit;
            resize: none;
            max-height: 100px;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--gray-text);
        }

        .chat-send-btn {
            background: var(--gray-very-light);
            color: var(--black-deep);
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .chat-send-btn:hover {
            background: var(--white-soft);
            transform: scale(1.05);
        }

        /* ========== RANKING E ESTATÍSTICAS ========== */
        .ranking-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .ranking-card {
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .ranking-card:hover {
            border-color: var(--gray-text);
            transform: translateY(-4px);
        }

        .ranking-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .ranking-card-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--white-soft);
        }

        .ranking-card-icon {
            font-size: 24px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px;
            background: var(--gray-medium);
            border: 1px solid var(--gray-border);
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .ranking-item:hover {
            border-color: var(--gray-text);
            transform: translateX(4px);
        }

        .ranking-position {
            font-size: 18px;
            font-weight: 800;
            min-width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
        }

        .ranking-position.gold {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: var(--black-deep);
            border: none;
        }

        .ranking-position.silver {
            background: linear-gradient(135deg, #C0C0C0, #A8A8A8);
            color: var(--black-deep);
            border: none;
        }

        .ranking-position.bronze {
            background: linear-gradient(135deg, #CD7F32, #A0522D);
            color: var(--white-soft);
            border: none;
        }

        .ranking-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gray-medium), var(--gray-border));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .ranking-info {
            flex: 1;
        }

        .ranking-name {
            font-weight: 600;
            color: var(--white-soft);
            margin-bottom: 2px;
        }

        .ranking-role {
            font-size: 12px;
            color: var(--gray-text);
        }

        .ranking-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--success);
        }

        .stats-chart {
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .stats-chart-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--white-soft);
            margin-bottom: 20px;
        }

        .chart-bar {
            margin-bottom: 16px;
        }

        .chart-bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .chart-bar-name {
            color: var(--gray-light);
        }

        .chart-bar-value {
            color: var(--white-soft);
            font-weight: 600;
        }

        .chart-bar-bg {
            height: 12px;
            background: var(--gray-medium);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--gray-border);
        }

        .chart-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--gray-very-light));
            border-radius: 6px;
            transition: width 1s ease;
        }

        /* ========== SISTEMA DE COMANDOS ========== */
        .commands-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            gap: 16px;
            flex-wrap: wrap;
        }

        .commands-search-bar {
            display: flex;
            gap: 12px;
            flex: 1;
            min-width: 300px;
        }

        .command-search-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 12px;
            color: var(--white-soft);
            font-size: 14px;
        }

        .command-search-input:focus {
            outline: none;
            border-color: var(--gray-text);
        }

        .commands-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .filter-chip {
            padding: 8px 16px;
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 20px;
            color: var(--gray-light);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-chip:hover {
            background: var(--gray-medium);
            border-color: var(--gray-text);
        }

        .filter-chip.active {
            background: var(--gray-very-light);
            color: var(--black-deep);
            border-color: var(--gray-very-light);
        }

        .commands-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .command-card {
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .command-card:hover {
            border-color: var(--gray-text);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .command-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .command-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--white-soft);
            font-family: 'Courier New', monospace;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .command-category-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .category-admin {
            background: rgba(255, 51, 102, 0.2);
            color: var(--danger);
            border: 1px solid rgba(255, 51, 102, 0.3);
        }

        .category-moderacao {
            background: rgba(255, 170, 0, 0.2);
            color: var(--warning);
            border: 1px solid rgba(255, 170, 0, 0.3);
        }

        .category-utilidade {
            background: rgba(0, 255, 136, 0.2);
            color: var(--success);
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .category-jogador {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .command-description {
            color: var(--gray-light);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .command-syntax {
            background: var(--black-dark);
            border: 1px solid var(--gray-border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: var(--gray-very-light);
            position: relative;
        }

        .command-syntax-label {
            font-size: 10px;
            color: var(--gray-text);
            text-transform: uppercase;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .command-example {
            color: var(--success);
        }

        .command-permission {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--gray-medium);
            border-radius: 6px;
            font-size: 12px;
            color: var(--gray-light);
            margin-bottom: 12px;
        }

        .command-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .command-action-btn {
            flex: 1;
            padding: 8px;
            background: var(--gray-medium);
            border: 1px solid var(--gray-border);
            border-radius: 8px;
            color: var(--white-soft);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .command-action-btn:hover {
            background: var(--gray-border);
            border-color: var(--gray-text);
        }

        .command-action-btn.favorite.active {
            background: rgba(255, 170, 0, 0.2);
            border-color: var(--warning);
            color: var(--warning);
        }

        .command-stats {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--gray-border);
        }

        .command-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--gray-text);
        }

        .commands-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-text);
        }

        .commands-empty i {
            font-size: 64px;
            opacity: 0.3;
            margin-bottom: 16px;
        }

        /* ========== INTEGRAÇÃO DISCORD ========== */
        .discord-section {
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .discord-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .discord-icon {
            width: 48px;
            height: 48px;
            background: #5865F2;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .discord-title {
            flex: 1;
        }

        .discord-title h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--white-soft);
            margin-bottom: 4px;
        }

        .discord-title p {
            font-size: 13px;
            color: var(--gray-light);
        }

        .discord-status {
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .discord-status.active {
            background: rgba(0, 255, 136, 0.2);
            color: var(--success);
        }

        .discord-status.inactive {
            background: rgba(255, 51, 102, 0.2);
            color: var(--danger);
        }

        .webhook-item {
            background: var(--gray-medium);
            border: 1px solid var(--gray-border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .webhook-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .webhook-name {
            font-weight: 600;
            color: var(--white-soft);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .webhook-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--gray-border);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: var(--success);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: left 0.3s ease;
        }

        .toggle-switch.active::after {
            left: 23px;
        }

        .webhook-url {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--gray-light);
            background: var(--black-dark);
            padding: 8px 12px;
            border-radius: 8px;
            word-break: break-all;
            margin-bottom: 12px;
        }

        .webhook-actions {
            display: flex;
            gap: 8px;
        }

        .webhook-btn {
            flex: 1;
            padding: 8px 12px;
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 8px;
            color: var(--white-soft);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .webhook-btn:hover {
            background: var(--gray-border);
            border-color: var(--gray-text);
        }

        .webhook-btn.test {
            background: rgba(88, 101, 242, 0.2);
            border-color: #5865F2;
            color: #5865F2;
        }

        .webhook-btn.test:hover {
            background: rgba(88, 101, 242, 0.3);
        }

        .notification-types {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .notification-type {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--gray-medium);
            border: 1px solid var(--gray-border);
            border-radius: 10px;
        }

        .notification-type-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--gray-light);
        }

        .discord-preview {
            background: #2f3136;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            border-left: 4px solid #5865F2;
        }

        .discord-preview-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .discord-preview-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gray-very-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--black-deep);
        }

        .discord-preview-name {
            font-weight: 600;
            color: #ffffff;
            font-size: 14px;
        }

        .discord-preview-content {
            color: #dcddde;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Notificação no menu */
        .nav-menu li a {
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -8px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* ========== CHAT EM GRUPO ========== */
        .group-indicator {
            background: var(--success);
            color: var(--black-deep);
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 6px;
            margin-left: 8px;
        }

        .group-members {
            display: flex;
            align-items: center;
            gap: -8px;
            margin-left: 8px;
        }

        .group-member-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gray-medium), var(--gray-border));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            border: 2px solid var(--gray-dark);
            margin-left: -8px;
        }

        .group-member-avatar:first-child {
            margin-left: 0;
        }

        .chat-attachment {
            margin-top: 8px;
            padding: 12px;
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .attachment-icon {
            width: 40px;
            height: 40px;
            background: var(--gray-medium);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .attachment-info {
            flex: 1;
        }

        .attachment-name {
            color: var(--white-soft);
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 2px;
        }

        .attachment-size {
            color: var(--gray-text);
            font-size: 11px;
        }

        .chat-attachment-preview {
            max-width: 300px;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .chat-attachment-preview:hover {
            transform: scale(1.05);
        }

        .attachment-input-wrapper {
            position: relative;
        }

        .attachment-btn {
            background: var(--gray-medium);
            color: var(--gray-light);
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .attachment-btn:hover {
            background: var(--gray-border);
            color: var(--white-soft);
        }

        .attachment-preview-container {
            display: flex;
            gap: 8px;
            padding: 8px;
            background: var(--gray-medium);
            border-radius: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .attachment-preview-thumb {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }

        .remove-attachment-btn {
            background: var(--danger);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
        }

        /* ========== SISTEMA DE CONQUISTAS ========== */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .achievement-card {
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 16px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .achievement-card.unlocked {
            border-color: var(--success);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05), transparent);
        }

        .achievement-card.unlocked::before {
            content: '✓';
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--success);
            color: var(--black-deep);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
        }

        .achievement-card.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .achievement-icon {
            font-size: 64px;
            margin-bottom: 16px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        .achievement-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--white-soft);
            margin-bottom: 8px;
        }

        .achievement-description {
            font-size: 13px;
            color: var(--gray-light);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .achievement-progress {
            width: 100%;
            background: var(--gray-medium);
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
            margin-top: 12px;
        }

        .achievement-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--gray-very-light));
            transition: width 0.5s ease;
        }

        .achievement-progress-text {
            font-size: 11px;
            color: var(--gray-text);
            margin-top: 6px;
        }

        .achievement-reward {
            background: rgba(255, 170, 0, 0.15);
            color: var(--warning);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 12px;
        }

        .user-achievements-summary {
            display: flex;
            gap: 16px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .achievement-stat {
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 12px;
            padding: 20px;
            flex: 1;
            min-width: 200px;
            text-align: center;
        }

        .achievement-stat-value {
            font-size: 42px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--success), var(--gray-very-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .achievement-stat-label {
            color: var(--gray-light);
            font-size: 14px;
            margin-top: 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-menu {
                display: none;
            }

            .content-card {
                margin: 16px;
                padding: 24px;
            }

            .modal-content {
                padding: 24px;
                width: 95%;
            }

            .chat-container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .chat-sidebar {
                max-height: 200px;
            }

            .chat-main {
                height: 500px;
            }
        }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <img src="https://tdatgzjwcuatpqhfococ.supabase.co/storage/v1/object/public/logos/sem-fundo-txd.png" alt="TXD Staff" class="logo-image" style="max-width: 200px; height: auto; margin-bottom: 20px;">
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="input-group" style="margin-top: 0;">
                    <label>Usuário</label>
                    <input type="text" id="loginUsername" placeholder="Digite seu usuário" required>
                </div>
                <div class="input-group">
                    <label>Senha</label>
                    <input type="password" id="loginPassword" placeholder="Digite sua senha" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i>
                    Conectar
                </button>
            </form>
            <button class="btn btn-secondary" onclick="showRegister()">
                <i class="fas fa-user-plus"></i>
                Registre-se
            </button>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('registerModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> Criar Conta</h2>
            </div>
            <form id="registerForm">
                <div class="input-group">
                    <label>Usuário de Login</label>
                    <input type="text" placeholder="Ex: zayon.dev" required>
                </div>
                <div class="input-group">
                    <label>Nome de Exibição</label>
                    <input type="text" placeholder="Ex: Zayon" required>
                </div>
                <div class="input-group">
                    <label>Senha</label>
                    <input type="password" placeholder="••••••••" required>
                </div>
                <div class="input-group">
                    <label>Repetir Senha</label>
                    <input type="password" placeholder="••••••••" required>
                </div>
                <button type="button" class="btn btn-primary" onclick="showTerms()">Prosseguir</button>
            </form>
        </div>
    </div>

    <!-- Terms Modal -->
    <div id="termsModal" class="modal">
        <div class="modal-content modal-lg">
            <span class="close" onclick="closeModal('termsModal')">&times;</span>
            <div style="text-align: center; margin-bottom: 30px;">
                <span class="confidential-badge">CONFIDENCIAL</span>
                <h2 style="color: var(--white-soft); margin: 20px 0 10px;">TERMO DE CONFIDENCIALIDADE E SIGILO</h2>
                <p style="color: var(--gray-light); font-size: 14px; letter-spacing: 2px;">STAFF ACCESS</p>
            </div>

            <div class="term-section">
                <p>Este documento formaliza o acordo entre a <strong>TXD RP</strong> e o solicitante <strong>CANDIDATO</strong>. Ao prosseguir, você assume responsabilidade legal e administrativa sobre os dados acessados.</p>

                <h4>1. NATUREZA DAS INFORMAÇÕES</h4>
                <p>Todas as informações, logs, ferramentas, estratégias, dados de usuários (IP, IDs, Histórico) e discussões internas visualizadas neste painel são classificadas como <strong>ESTRITAMENTE CONFIDENCIAIS</strong>.</p>

                <h4>2. VEDAÇÃO TOTAL DE COMPARTILHAMENTO</h4>
                <p>É terminantemente proibido capturar tela (print), gravar, transmitir (stream) ou compartilhar verbalmente qualquer informação interna com jogadores, outras staffs ou terceiros. <span class="highlight-danger">A violação desta cláusula resultará em BANIMENTO PERMANENTE (Blacklist) e remoção imediata de todos os cargos.</span></p>

                <h4>3. SEGURANÇA DA CONTA</h4>
                <p>O acesso é <strong>INTRANSFERÍVEL</strong>. O titular da conta é o único responsável por qualquer ação realizada através de suas credenciais. O compartilhamento de senha caracteriza quebra de segurança grave.</p>

                <h4>4. DECLARAÇÃO DE CIÊNCIA</h4>
                <p>Declaro estar ciente de que minhas ações no painel são monitoradas e registradas (LOGS). O uso das ferramentas administrativas para benefício próprio ou de terceiros (Abuso de Poder) acarretará nas sanções máximas previstas nas regras da cidade.</p>

                <div class="checkbox-container">
                    <input type="checkbox" id="termAgree" onchange="toggleConfirmButton()">
                    <label for="termAgree">Li, compreendi e concordo integralmente com os termos deste documento oficial.</label>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button class="btn btn-secondary" onclick="closeModal('termsModal')" style="flex: 1;">RECUSAR</button>
                <button class="btn btn-primary" id="confirmTermBtn" onclick="acceptTerms()" disabled style="flex: 1;">CONFIRMAR REGISTRO</button>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <nav class="navbar">
            <img src="https://tdatgzjwcuatpqhfococ.supabase.co/storage/v1/object/public/logos/sem-fundo-txd.png" alt="TXD Staff" class="navbar-logo" style="height: 90px !important; width: auto !important;">
            <ul class="nav-menu">
                <li><a href="#" onclick="showSection('inicio'); return false;" class="active">Início</a></li>
                <li><a href="#" onclick="showSection('tarefas'); return false;">Tarefas</a></li>
                <li><a href="#" onclick="showSection('formularios'); return false;">🎫 Tickets</a></li>
                <li><a href="#" onclick="showSection('ranking'); return false;">📊 Ranking</a></li>
                <li><a href="#" onclick="showSection('conquistas'); return false;">🏆 Conquistas</a></li>
                <li><a href="#" onclick="showSection('comandos'); return false;">Comandos</a></li>
                <li><a href="#" onclick="showSection('controle'); return false;">Controle</a></li>
                <li><a href="#" onclick="showSection('areas'); return false;">Áreas</a></li>
                <li><a href="#" onclick="showSection('advertencias'); return false;">Advertências</a></li>
                <li><a href="#" onclick="showSection('agenda'); return false;">Agenda</a></li>
                <li><a href="#" onclick="showSection('formularios'); return false;">Formulários</a></li>
                <li><a href="#" onclick="showSection('relatorios'); return false;">Relatórios</a></li>
                <li><a href="#" onclick="showSection('perfil'); return false;">👤 Perfil</a></li>
                <li><a href="#" onclick="showSection('config'); return false;">Configurações</a></li>
            </ul>
            <button class="btn btn-secondary" onclick="logout()" style="width: auto; padding: 10px 20px;">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </nav>

        <div class="content-card" id="mainContent">
            <h1 id="sectionTitle">Bem-vindo ao Painel TXD Staff</h1>
            <p style="color: var(--gray-light);">Selecione uma opção no menu para começar.</p>
        </div>
    </div>

    <!-- Modal: Novo Evento -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('eventModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-calendar-plus"></i> <span id="eventModalTitle">Novo Evento</span></h2>
            </div>
            <form id="eventForm" onsubmit="saveEvent(event)">
                <input type="hidden" id="eventId">
                <div class="input-group">
                    <label>Tipo</label>
                    <select id="eventType" required>
                        <option value="">Selecione...</option>
                        <option value="event">Evento</option>
                        <option value="meeting">Reunião</option>
                        <option value="training">Treinamento</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Título</label>
                    <input type="text" id="eventTitle" placeholder="Ex: Reunião Geral Mensal" required>
                </div>
                <div class="input-group">
                    <label>Data e Hora</label>
                    <input type="datetime-local" id="eventDateTime" required>
                </div>
                <div class="input-group">
                    <label>Descrição</label>
                    <textarea id="eventDescription" rows="4" placeholder="Descrição do evento..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('eventModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Adicionar/Editar Comando -->
    <div id="commandModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('commandModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-terminal"></i> <span id="commandModalTitle">Novo Comando</span></h2>
            </div>
            <form id="commandForm" onsubmit="saveCommand(event)">
                <input type="hidden" id="commandId">
                <div class="input-group">
                    <label>Nome do Comando</label>
                    <input type="text" id="commandName" placeholder="Ex: /ban" required>
                </div>
                <div class="input-group">
                    <label>Categoria</label>
                    <select id="commandCategory" required>
                        <option value="">Selecione...</option>
                        <option value="admin">Administração</option>
                        <option value="moderacao">Moderação</option>
                        <option value="utilidade">Utilidade</option>
                        <option value="jogador">Jogador</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Descrição</label>
                    <textarea id="commandDescription" rows="2" placeholder="Descreva o que o comando faz..." required></textarea>
                </div>
                <div class="input-group">
                    <label>Sintaxe</label>
                    <input type="text" id="commandSyntax" placeholder="Ex: /ban [id] [motivo] [tempo]" required>
                </div>
                <div class="input-group">
                    <label>Exemplo de Uso</label>
                    <input type="text" id="commandExample" placeholder="Ex: /ban 123 Anti-RP 7d">
                </div>
                <div class="input-group">
                    <label>Permissão Necessária</label>
                    <input type="text" id="commandPermission" placeholder="Ex: admin.ban" required>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('commandModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;"><i class="fas fa-save"></i> Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Criar Grupo de Chat -->
    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('createGroupModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-users"></i> Criar Grupo de Chat</h2>
            </div>
            <form id="createGroupForm" onsubmit="saveGroup(event)">
                <div class="input-group">
                    <label>Nome do Grupo</label>
                    <input type="text" id="groupName" placeholder="Ex: Equipe de Moderação" required>
                </div>
                <div class="input-group">
                    <label>Descrição</label>
                    <textarea id="groupDescription" rows="2" placeholder="Breve descrição do grupo..."></textarea>
                </div>
                <div class="input-group">
                    <label>Membros</label>
                    <div id="groupMembersSelection" style="max-height: 200px; overflow-y: auto; padding: 12px; background: var(--gray-medium); border-radius: 8px; border: 1px solid var(--gray-border);">
                        <!-- Será preenchido dinamicamente -->
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createGroupModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;"><i class="fas fa-check"></i> Criar Grupo</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Enviar Aviso -->
    <div id="announcementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('announcementModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-bullhorn"></i> Enviar Aviso</h2>
            </div>
            <form id="announcementForm" onsubmit="saveAnnouncement(event)">
                <div class="input-group">
                    <label>Título do Aviso</label>
                    <input type="text" id="announcementTitle" placeholder="Ex: Reunião Geral Obrigatória" required>
                </div>
                <div class="input-group">
                    <label>Prioridade</label>
                    <select id="announcementPriority" required>
                        <option value="normal">Normal</option>
                        <option value="high">Alta</option>
                        <option value="urgent">Urgente</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Mensagem</label>
                    <textarea id="announcementMessage" rows="6" placeholder="Digite o conteúdo do aviso..." required></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('announcementModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Enviar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Adicionar/Editar Membro -->
    <div id="staffModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('staffModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> <span id="staffModalTitle">Adicionar Membro</span></h2>
            </div>
            <form id="staffForm" onsubmit="saveStaff(event)">
                <input type="hidden" id="staffId">
                <div class="input-group">
                    <label>Nome Completo *</label>
                    <input type="text" id="staffName" placeholder="Ex: João Silva" required>
                </div>
                <div class="input-group" id="staffLoginGroup">
                    <label>Login *</label>
                    <input type="text" id="staffLogin" placeholder="Ex: joaosilva" required>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 4px; display: block;">Usado para fazer login no sistema</small>
                </div>
                <div class="input-group" id="staffPasswordGroup">
                    <label>Senha *</label>
                    <input type="password" id="staffPassword" placeholder="Mínimo 4 caracteres" required>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 4px; display: block;">Mínimo 4 caracteres</small>
                </div>
                <div class="input-group">
                    <label>Cargo</label>
                    <select id="staffRole" required onchange="checkPermissions()">
                        <option value="">Selecione...</option>
                        <option value="Owner">Owner</option>
                        <option value="CEO">CEO</option>
                        <option value="COO">COO</option>
                        <option value="CMO">CMO</option>
                        <option value="CCO">CCO</option>
                        <option value="CIO">CIO</option>
                        <option value="Diretor">Diretor</option>
                        <option value="Head Staff">Head Staff</option>
                        <option value="Coordenador">Coordenador</option>
                        <option value="Admin">Admin</option>
                        <option value="Moderador">Moderador</option>
                        <option value="Suporte">Suporte</option>
                        <option value="Helper">Helper</option>
                        <option value="Dev">Dev</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Área de Responsabilidade</label>
                    <select id="staffArea" required>
                        <option value="">Selecione...</option>
                        <option value="Responsável Staff">Responsável Staff</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Creator">Creator</option>
                        <option value="Eventos">Eventos</option>
                        <option value="Peds">Peds</option>
                        <option value="Polícia">Polícia</option>
                        <option value="Ilegal">Ilegal</option>
                        <option value="Mecânica">Mecânica</option>
                        <option value="Legal">Legal</option>
                        <option value="Hospital">Hospital</option>
                        <option value="Restaurante">Restaurante</option>
                        <option value="Var">Var</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Status</label>
                    <select id="staffStatus" required>
                        <option value="Ativo">Ativo</option>
                        <option value="Ausente">Ausente</option>
                        <option value="Inativo">Inativo</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="staffEmail" placeholder="exemplo@email.com">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('staffModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Perfil do Usuário -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('profileModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-user-circle"></i> Meu Perfil</h2>
            </div>
            <form id="profileForm" onsubmit="saveProfile(event)">
                <div class="input-group">
                    <label>Nome *</label>
                    <input type="text" id="profileName" placeholder="Seu nome completo" required>
                </div>
                <div class="input-group">
                    <label>Login *</label>
                    <input type="text" id="profileLogin" placeholder="Seu login de acesso" required>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 4px; display: block;">Usado para fazer login no sistema</small>
                </div>
                <div class="input-group">
                    <label>Senha *</label>
                    <input type="password" id="profilePassword" placeholder="Mínimo 4 caracteres" required>
                    <small style="color: var(--gray-text); font-size: 12px; margin-top: 4px; display: block;">Mínimo 4 caracteres</small>
                </div>
                <div class="input-group">
                    <label>ID Game</label>
                    <input type="text" id="profileGameId" placeholder="Ex: 12345">
                </div>
                <div class="input-group">
                    <label>ID Discord</label>
                    <input type="text" id="profileDiscordId" placeholder="Ex: 123456789012345678">
                </div>
                <div class="input-group">
                    <label>Área de Interesse</label>
                    <select id="profileArea">
                        <option value="">Selecione...</option>
                        <option value="Responsável Staff">Responsável Staff</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Creator">Creator</option>
                        <option value="Eventos">Eventos</option>
                        <option value="Peds">Peds</option>
                        <option value="Polícia">Polícia</option>
                        <option value="Ilegal">Ilegal</option>
                        <option value="Mecânica">Mecânica</option>
                        <option value="Legal">Legal</option>
                        <option value="Hospital">Hospital</option>
                        <option value="Restaurante">Restaurante</option>
                        <option value="Var">Var</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('profileModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Confirmar Exclusão -->
    <div id="deleteModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-triangle"></i> Confirmar Exclusão</h2>
            </div>
            <p style="color: var(--gray-light); margin-bottom: 24px;" id="deleteMessage"></p>
            <div style="display: flex; gap: 10px;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('deleteModal')" style="flex: 1;">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()" style="flex: 1;">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal: Nova/Editar Card Kanban -->
    <div id="cardModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('cardModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-sticky-note"></i> <span id="cardModalTitle">Nova Tarefa</span></h2>
            </div>
            <form id="cardForm" onsubmit="saveCard(event)">
                <input type="hidden" id="cardId">
                <input type="hidden" id="cardColumnId">
                <div class="input-group">
                    <label>Título da Tarefa</label>
                    <input type="text" id="cardTitle" placeholder="Ex: Implementar sistema de login" required>
                </div>
                <div class="input-group">
                    <label>Descrição</label>
                    <textarea id="cardDescription" rows="4" placeholder="Descreva os detalhes da tarefa..."></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="input-group">
                        <label>Prioridade</label>
                        <select id="cardPriority">
                            <option value="">Sem prioridade</option>
                            <option value="low">Baixa</option>
                            <option value="medium">Média</option>
                            <option value="high">Alta</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Data de Vencimento</label>
                        <input type="date" id="cardDueDate">
                    </div>
                </div>
                <div class="input-group">
                    <label>Responsável</label>
                    <select id="cardAssignee">
                        <option value="">Sem responsável</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Tags (separadas por vírgula)</label>
                    <input type="text" id="cardTags" placeholder="Ex: urgente, frontend, bug">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('cardModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========== CONFIGURAÇÃO SUPABASE ==========
        const SUPABASE_URL = 'https://tdatgzjwcuatpqhfococ.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkYXRnemp3Y3VhdHBxaGZvY29jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNDAzMjUsImV4cCI6MjA4MzkxNjMyNX0.0UujT6QJNDesCWL67GoX-mOLcNf1YIucz8vvxt_gcMg';
        
        // Inicializar Supabase
        // O CDN do Supabase expõe através de window.supabase ou supabase globalmente
        let supabaseClient;
        if (typeof window !== 'undefined' && window.supabase) {
            // CDN expõe via window.supabase
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } else if (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function') {
            // CDN expõe diretamente como supabase
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } else {
            console.error('Supabase não está carregado. Verifique se o script foi incluído corretamente.');
        }
        
        // Cache local para performance
        const dataCache = {};
        let cacheInitialized = false;
        
        // Subscriptions de real-time
        let realtimeSubscriptions = [];
        
        // Função para inicializar real-time
        function initializeRealtime() {
            if (!supabaseClient) {
                console.warn('Supabase não inicializado. Real-time não disponível.');
                return;
            }
            
            // Limpar subscriptions antigas
            realtimeSubscriptions.forEach(sub => {
                try {
                    supabaseClient.removeChannel(sub);
                } catch (e) {
                    console.warn('Erro ao remover subscription:', e);
                }
            });
            realtimeSubscriptions = [];
            
            // Subscription para registration_requests
            const regChannel = supabaseClient
                .channel('registration_requests_changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'registration_requests' },
                    (payload) => {
                        console.log('Mudança em registration_requests:', payload);
                        // Limpar cache e recarregar
                        delete dataCache['txd_registration_requests'];
                        // Se estiver na seção de controle ou staff, recarregar
                        if (currentSection === 'controle' || currentSection === 'staff') {
                            setTimeout(() => loadStaffControl(), 500);
                        }
                    }
                )
                .subscribe();
            realtimeSubscriptions.push(regChannel);
            
            // Subscription para kanban (com debounce para evitar loops)
            let kanbanReloadTimeout = null;
            const reloadKanbanDebounced = () => {
                if (kanbanReloadTimeout) {
                    clearTimeout(kanbanReloadTimeout);
                }
                kanbanReloadTimeout = setTimeout(() => {
                    if (currentSection === 'tarefas') {
                        loadKanban();
                    }
                }, 1000); // Aguardar 1 segundo antes de recarregar
            };
            
            const kanbanCardsChannel = supabaseClient
                .channel('kanban_cards_changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'kanban_cards' },
                    (payload) => {
                        // Ignorar eventos DELETE (payload.old existe mas payload.new não)
                        // DELETE: tem payload.old mas não tem payload.new
                        // UPDATE: tem payload.old e payload.new
                        // INSERT: tem payload.new mas não tem payload.old
                        if (payload.old && !payload.new) {
                            console.log('Evento DELETE ignorado (já processado localmente)');
                            return;
                        }
                        
                        // Ignorar mudanças feitas pelo próprio usuário atual (evitar loop)
                        if (payload.new && payload.new.updated_at) {
                            const now = new Date();
                            const updatedAt = new Date(payload.new.updated_at);
                            const diff = now - updatedAt;
                            // Se a mudança foi feita há menos de 3 segundos, pode ser do próprio usuário
                            if (diff < 3000) {
                                console.log('Mudança recente em kanban_cards (possivelmente do próprio usuário), ignorando...');
                                return;
                            }
                        }
                        console.log('Mudança em kanban_cards:', payload);
                        delete dataCache['txd_kanban'];
                        reloadKanbanDebounced();
                    }
                )
                .subscribe();
            realtimeSubscriptions.push(kanbanCardsChannel);
            
            const kanbanColumnsChannel = supabaseClient
                .channel('kanban_columns_changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'kanban_columns' },
                    (payload) => {
                        console.log('Mudança em kanban_columns:', payload);
                        delete dataCache['txd_kanban'];
                        reloadKanbanDebounced();
                    }
                )
                .subscribe();
            realtimeSubscriptions.push(kanbanColumnsChannel);
            
            // Subscription para staff
            const staffChannel = supabaseClient
                .channel('staff_changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'staff' },
                    (payload) => {
                        console.log('Mudança em staff:', payload);
                        delete dataCache['txd_staff'];
                        if (currentSection === 'staff') {
                            setTimeout(() => loadStaffControl(), 500);
                        }
                    }
                )
                .subscribe();
            realtimeSubscriptions.push(staffChannel);
            
            console.log('✅ Real-time inicializado com sucesso!');
        }
        
        // Mapeamento de chaves localStorage para tabelas Supabase
        const keyToTableMap = {
            'txd_staff': 'staff',
            'txd_commands': 'commands',
            'txd_command_usage': 'command_usage',
            'txd_favorite_commands': 'favorite_commands',
            'txd_areas': 'areas',
            'txd_chat_messages': 'chat_messages',
            'txd_chat_groups': 'chat_groups',
            'txd_user_achievements': 'user_achievements',
            'txd_discord_config': 'discord_config',
            'txd_discord_commands_log': 'discord_commands_log',
            'txd_events': 'events',
            'txd_tickets': 'tickets',
            'txd_announcements': 'announcements',
            'txd_kanban': 'kanban',
            'txd_system_logs': 'system_logs',
            'txd_system_settings': 'system_settings',
            'txd_security_settings': 'security_settings',
            'txd_registration_requests': 'registration_requests'
        };
        
        // ========== FUNÇÕES SUPABASE ==========
        
        // Funções helper para conversão camelCase <-> snake_case
        function toSnakeCase(obj) {
            if (Array.isArray(obj)) {
                return obj.map(item => toSnakeCase(item));
            } else if (obj !== null && typeof obj === 'object' && !(obj instanceof Date)) {
                const converted = {};
                for (const key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        // Se já está em snake_case, manter
                        if (key.includes('_')) {
                            converted[key] = toSnakeCase(obj[key]);
                        } else {
                            // Converter camelCase para snake_case
                            const snakeKey = key.replace(/([A-Z])/g, '_$1').toLowerCase().replace(/^_/, '');
                            converted[snakeKey] = toSnakeCase(obj[key]);
                        }
                    }
                }
                return converted;
            }
            return obj;
        }
        
        function toCamelCase(obj) {
            if (Array.isArray(obj)) {
                return obj.map(item => toCamelCase(item));
            } else if (obj !== null && typeof obj === 'object' && !(obj instanceof Date)) {
                const converted = {};
                for (const key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        // Se já está em camelCase (sem underscore), manter
                        if (!key.includes('_')) {
                            converted[key] = toCamelCase(obj[key]);
                        } else {
                            // Converter snake_case para camelCase
                            const camelKey = key.replace(/_([a-z])/g, (g) => g[1].toUpperCase());
                            converted[camelKey] = toCamelCase(obj[key]);
                        }
                    }
                }
                return converted;
            }
            return obj;
        }
        
        async function getData(key, forceRefresh = false) {
            // Se não forçar refresh e tem no cache, retorna imediatamente
            if (!forceRefresh && dataCache[key] !== undefined) {
                return dataCache[key];
            }
            
            // Verificar se Supabase está inicializado
            if (!supabaseClient) {
                console.warn('Supabase não está inicializado. Retornando array vazio.');
                return [];
            }
            
            const tableName = keyToTableMap[key];
            if (!tableName) {
                console.warn(`Chave ${key} não mapeada para tabela Supabase`);
                return [];
            }
            
            try {
                let data = [];
                
                switch(key) {
                    case 'txd_staff':
                        const { data: staffData, error: staffError } = await supabaseClient
                            .from('staff')
                            .select('*')
                            .order('created_at', { ascending: false });
                        if (!staffError) data = toCamelCase(staffData || []);
                        break;
                        
                    case 'txd_commands':
                        const { data: commandsData, error: commandsError } = await supabaseClient
                            .from('commands')
                            .select('*')
                            .order('created_at', { ascending: false });
                        if (!commandsError) data = toCamelCase(commandsData || []);
                        break;
                        
                    case 'txd_events':
                        const { data: eventsData, error: eventsError } = await supabaseClient
                            .from('events')
                            .select('*')
                            .order('event_date', { ascending: true });
                        if (!eventsError) data = toCamelCase(eventsData || []);
                        break;
                        
                    case 'txd_tickets':
                        const { data: ticketsData, error: ticketsError } = await supabaseClient
                            .from('tickets')
                            .select('*')
                            .order('created_at', { ascending: false });
                        if (!ticketsError) data = toCamelCase(ticketsData || []);
                        break;
                        
                    case 'txd_announcements':
                        const { data: announcementsData, error: announcementsError } = await supabaseClient
                            .from('announcements')
                            .select('*')
                            .order('created_at', { ascending: false });
                        if (!announcementsError) data = toCamelCase(announcementsData || []);
                        break;
                        
                    case 'txd_areas':
                        const { data: areasData, error: areasError } = await supabaseClient
                            .from('areas')
                            .select('*')
                            .order('name', { ascending: true });
                        if (!areasError) {
                            // Converter snake_case para camelCase manualmente
                            const convertedAreas = (areasData || []).map(area => ({
                                id: area.id,
                                name: area.name,
                                icon: area.icon,
                                description: area.description,
                                hasLeader: area.has_leader || false,
                                leader: area.leader_name || null,
                                team: [],
                                createdAt: area.created_at,
                                updatedAt: area.updated_at
                            }));
                            
                            // Buscar membros das equipes
                            const { data: teamMembers } = await supabaseClient
                                .from('area_team_members')
                                .select('*');
                            
                            data = convertedAreas.map(area => ({
                                ...area,
                                team: (teamMembers || [])
                                    .filter(m => m && m.area_id === area.id)
                                    .map(m => m.member_name)
                            }));
                        }
                        break;
                        
                    case 'txd_chat_messages':
                        const { data: messagesData, error: messagesError } = await supabaseClient
                            .from('chat_messages')
                            .select('*')
                            .order('created_at', { ascending: true });
                        if (!messagesError) {
                            // Converter message para text e created_at para timestamp (compatibilidade com código JavaScript)
                            data = (messagesData || []).map(msg => {
                                const converted = toCamelCase(msg);
                                if (converted.message && !converted.text) {
                                    converted.text = converted.message;
                                    delete converted.message;
                                }
                                if (converted.createdAt && !converted.timestamp) {
                                    converted.timestamp = converted.createdAt;
                                    delete converted.createdAt;
                                }
                                return converted;
                            });
                        }
                        break;
                        
                    case 'txd_chat_groups':
                        const { data: groupsData, error: groupsError } = await supabaseClient
                            .from('chat_groups')
                            .select(`
                                *,
                                chat_group_members (*)
                            `)
                            .order('created_at', { ascending: false });
                        if (!groupsError) {
                            const convertedGroups = toCamelCase(groupsData || []);
                            data = convertedGroups.map(group => ({
                                ...group,
                                members: (group.chatGroupMembers || []).map(m => ({
                                    id: m.memberId,
                                    name: m.memberName,
                                    role: m.memberRole
                                }))
                            }));
                        }
                        break;
                        
                    case 'txd_user_achievements':
                        const { data: achievementsData, error: achievementsError } = await supabaseClient
                            .from('user_achievements')
                            .select('*');
                        if (!achievementsError) data = toCamelCase(achievementsData || []);
                        break;
                        
                    case 'txd_discord_config':
                        const { data: configData, error: configError } = await supabaseClient
                            .from('discord_config')
                            .select('*')
                            .eq('id', 1)
                            .single();
                        if (!configError && configData) {
                            data = {
                                enabled: configData.enabled || false,
                                webhooks: {
                                    main: configData.webhook_main || '',
                                    logs: configData.webhook_logs || '',
                                    events: configData.webhook_events || '',
                                    tickets: configData.webhook_tickets || ''
                                },
                                notifications: {
                                    chat: configData.notifications_chat !== false,
                                    tasks: configData.notifications_tasks !== false,
                                    tickets: configData.notifications_tickets !== false,
                                    events: configData.notifications_events !== false,
                                    achievements: configData.notifications_achievements !== false,
                                    staff: configData.notifications_staff !== false
                                },
                                commandsEnabled: configData.commands_enabled || false,
                                commandsWebhook: configData.commands_webhook || ''
                            };
                        } else {
                            data = {
                                enabled: false,
                                webhooks: { main: '', logs: '', events: '', tickets: '' },
                                notifications: { chat: true, tasks: true, tickets: true, events: true, achievements: true, staff: true },
                                commandsEnabled: false,
                                commandsWebhook: ''
                            };
                        }
                        break;
                        
                    case 'txd_discord_commands_log':
                        const { data: logData, error: logError } = await supabaseClient
                            .from('discord_commands_log')
                            .select('*')
                            .order('created_at', { ascending: false })
                            .limit(50);
                        if (!logError) data = toCamelCase(logData || []);
                        break;
                        
                    case 'txd_kanban':
                        // Buscar colunas
                        const { data: columnsData, error: columnsError } = await supabaseClient
                            .from('kanban_columns')
                            .select('*')
                            .order('position', { ascending: true });
                        
                        // Buscar cards (sem join para evitar erro)
                        const { data: cardsData, error: cardsError } = await supabaseClient
                            .from('kanban_cards')
                            .select('*')
                            .order('created_at', { ascending: false });
                        
                        // Buscar assignees separadamente
                        let assigneesData = [];
                        if (!cardsError && cardsData && cardsData.length > 0) {
                            const cardIds = cardsData.map(c => c.id).filter(id => id);
                            if (cardIds.length > 0) {
                                const { data: assigneesRaw, error: assigneesError } = await supabaseClient
                                    .from('kanban_card_assignees')
                                    .select('*')
                                    .in('card_id', cardIds);
                                if (!assigneesError && assigneesRaw) {
                                    assigneesData = assigneesRaw;
                                }
                            }
                        }
                        
                        if (!columnsError && !cardsError) {
                            const convertedColumns = toCamelCase(columnsData || []);
                            const convertedCards = toCamelCase(cardsData || []);
                            
                            // Mapear assignees para cada card
                            data = {
                                columns: convertedColumns,
                                cards: convertedCards.map(card => {
                                    // Buscar assignees deste card
                                    const cardAssignees = assigneesData
                                        .filter(a => a.card_id === card.id)
                                        .map(a => a.assignee_name || a.assigneeName)
                                        .filter(name => name);
                                    
                                    // Garantir que assignees seja um array
                                    let assigneesArray = [];
                                    if (cardAssignees && cardAssignees.length > 0) {
                                        assigneesArray = cardAssignees;
                                    } else if (card.assignees && Array.isArray(card.assignees)) {
                                        assigneesArray = card.assignees;
                                    } else if (card.assignee && typeof card.assignee === 'string' && card.assignee.trim() !== '') {
                                        assigneesArray = [card.assignee];
                                    }
                                    
                                    return {
                                        ...card,
                                        assignees: assigneesArray,
                                        // Garantir que columnId existe
                                        columnId: card.columnId || card.column_id || 'todo'
                                    };
                                })
                            };
                        }
                        break;
                        
                    case 'txd_favorite_commands':
                        const { data: favoritesData, error: favoritesError } = await supabaseClient
                            .from('favorite_commands')
                            .select('command_id');
                        if (!favoritesError) {
                            data = (favoritesData || []).map(f => f.command_id);
                        }
                        break;
                        
                    case 'txd_command_usage':
                        const { data: usageData, error: usageError } = await supabaseClient
                            .from('command_usage')
                            .select('*')
                            .order('used_at', { ascending: false });
                        if (!usageError) data = toCamelCase(usageData || []);
                        break;
                        
                    case 'txd_registration_requests':
                        try {
                            const { data: requestsData, error: requestsError } = await supabaseClient
                                .from('registration_requests')
                                .select('*')
                                .order('requested_at', { ascending: false });
                            if (!requestsError && requestsData) {
                                console.log('📊 Dados brutos do Supabase:', requestsData);
                                console.log('📊 Primeira solicitação (exemplo):', requestsData[0]);
                                console.log('📊 Campos disponíveis:', requestsData[0] ? Object.keys(requestsData[0]) : 'Nenhum dado');
                                
                                // Converter para camelCase e garantir campos necessários
                                // Mapear todos os campos possíveis
                                data = (requestsData || []).map(req => {
                                    // Log para debug
                                    if (requestsData.indexOf(req) === 0) {
                                        console.log('🔍 Mapeando primeira solicitação:', req);
                                    }
                                    
                                    return {
                                        id: req.id,
                                        username: req.username || req.login || req.name || req.user || '',
                                        displayName: req.display_name || req.displayName || req.display_name || req.name || req.username || '',
                                        password: req.password || '',
                                        status: (req.status || 'pending').toLowerCase().trim(),
                                        requestedAt: req.requested_at || req.requestedAt || req.created_at || req.timestamp || new Date().toISOString(),
                                        requestedBy: req.requested_by || req.requestedBy || req.username || req.name || '',
                                        approvedBy: req.approved_by || req.approvedBy || null,
                                        approvedAt: req.approved_at || req.approvedAt || null,
                                        rejectionReason: req.rejection_reason || req.rejectionReason || null,
                                        gameId: req.game_id || req.gameId || null,
                                        discordId: req.discord_id || req.discordId || null,
                                        area: req.area || null,
                                        // Manter dados originais para debug
                                        _raw: req
                                    };
                                });
                                console.log('✅ Solicitações mapeadas:', data.length);
                                console.log('📋 Primeira solicitação mapeada:', data[0]);
                                console.log('📋 Todas as solicitações:', data);
                                
                                // IMPORTANTE: Garantir que data não seja undefined
                                if (!data || data.length === 0) {
                                    console.warn('⚠️ Nenhuma solicitação foi mapeada!');
                                    data = [];
                                }
                            } else if (requestsError) {
                                // Se a tabela não existir (404), retornar array vazio
                                if (requestsError.code === 'PGRST116' || requestsError.message?.includes('404')) {
                                    console.warn('Tabela registration_requests não existe ainda. Execute o SQL de criação.');
                                    data = [];
                                } else {
                                    console.error('Erro ao buscar registration_requests:', requestsError);
                                    data = [];
                                }
                            }
                        } catch (err) {
                            console.error('Erro ao buscar registration_requests:', err);
                            data = [];
                        }
                        break;
                }
                
                // Atualizar cache
                dataCache[key] = data;
                console.log(`💾 Cache atualizado para '${key}':`, data.length, 'itens');
                console.log(`💾 Cache['${key}'] =`, dataCache[key]);
                return data;
                
            } catch (error) {
                console.error(`Erro ao buscar ${key} do Supabase:`, error);
                return dataCache[key] || [];
            }
        }
        
        async function saveData(key, data) {
            // Verificar se Supabase está inicializado
            if (!supabaseClient) {
                console.warn('Supabase não está inicializado. Não é possível salvar dados.');
                return;
            }
            
            const tableName = keyToTableMap[key];
            if (!tableName) {
                console.warn(`Chave ${key} não mapeada para tabela Supabase`);
                return;
            }
            
            try {
                switch(key) {
                    case 'txd_staff':
                        if (Array.isArray(data)) {
                            // Converter para snake_case antes de salvar
                            const convertedData = toSnakeCase(data);
                            
                            // Garantir que cada registro tenha os campos necessários
                            const sanitizedData = convertedData.map(item => {
                                const sanitized = { ...item };
                                // Garantir que ID seja número
                                if (sanitized.id) {
                                    sanitized.id = parseInt(sanitized.id);
                                }
                                // Remover campos undefined
                                Object.keys(sanitized).forEach(key => {
                                    if (sanitized[key] === undefined) {
                                        delete sanitized[key];
                                    }
                                });
                                return sanitized;
                            });
                            
                            console.log('Salvando staff no Supabase:', sanitizedData.length, 'registros');
                            const { data: result, error } = await supabaseClient
                                .from('staff')
                                .upsert(sanitizedData, { onConflict: 'id' });
                            
                            if (error) {
                                console.error('Erro ao salvar staff:', error);
                                throw error;
                            }
                            
                            // Atualizar cache após salvar
                            dataCache['txd_staff'] = data;
                            return { success: true, data: result };
                        }
                        break;
                        
                    case 'txd_commands':
                        if (Array.isArray(data)) {
                            const convertedData = toSnakeCase(data);
                            const { error } = await supabaseClient
                                .from('commands')
                                .upsert(convertedData, { onConflict: 'id' });
                            if (error) throw error;
                        }
                        break;
                        
                    case 'txd_events':
                        if (Array.isArray(data)) {
                            const convertedData = toSnakeCase(data);
                            const { error } = await supabaseClient
                                .from('events')
                                .upsert(convertedData, { onConflict: 'id' });
                            if (error) throw error;
                        }
                        break;
                        
                    case 'txd_tickets':
                        if (Array.isArray(data)) {
                            const convertedData = toSnakeCase(data);
                            const { error } = await supabaseClient
                                .from('tickets')
                                .upsert(convertedData, { onConflict: 'id' });
                            if (error) throw error;
                        }
                        break;
                        
                    case 'txd_announcements':
                        if (Array.isArray(data)) {
                            const convertedData = toSnakeCase(data);
                            const { error } = await supabaseClient
                                .from('announcements')
                                .upsert(convertedData, { onConflict: 'id' });
                            if (error) throw error;
                        }
                        break;
                        
                    case 'txd_areas':
                        if (Array.isArray(data)) {
                            for (const area of data) {
                                if (!area || !area.id) continue;
                                
                                try {
                                    // Extrair apenas o que precisamos, ignorando tudo mais
                                    const team = area.team;
                                    
                                    // Criar objeto limpo APENAS com campos que existem no schema
                                    // NUNCA usar toSnakeCase aqui - mapear manualmente
                                    const areaToSave = {};
                                    
                                    // Campos obrigatórios
                                    areaToSave.id = String(area.id);
                                    areaToSave.name = String(area.name || '');
                                    
                                    // Mapear leader corretamente (pode vir como leader, Leader, ou leader_name)
                                    // IMPORTANTE: usar leader_name (snake_case) como nome do campo
                                    const leaderValue = area.leader || area.Leader || area.leader_name || null;
                                    if (leaderValue && String(leaderValue).trim() !== '') {
                                        areaToSave.leader_name = String(leaderValue);
                                        areaToSave.has_leader = true;
                                    } else {
                                        areaToSave.leader_name = null;
                                        areaToSave.has_leader = false;
                                    }
                                    
                                    // Campos opcionais (apenas se existirem e não forem vazios)
                                    if (area.icon && String(area.icon).trim() !== '') {
                                        areaToSave.icon = String(area.icon);
                                    }
                                    
                                    if (area.description && String(area.description).trim() !== '') {
                                        areaToSave.description = String(area.description);
                                    }
                                    
                                    // Garantir que NÃO há campos extras (especialmente Leader com L maiúsculo)
                                    // Remover qualquer campo que não esteja na lista permitida
                                    const allowedFields = ['id', 'name', 'icon', 'description', 'has_leader', 'leader_name'];
                                    Object.keys(areaToSave).forEach(key => {
                                        if (!allowedFields.includes(key)) {
                                            delete areaToSave[key];
                                        }
                                    });
                                    
                                    // Salvar área (sem created_at e updated_at, deixar o banco gerenciar)
                                    const { data: savedArea, error: areaError } = await supabaseClient
                                        .from('areas')
                                        .upsert(areaToSave, { onConflict: 'id' })
                                        .select();
                                    
                                    if (areaError) {
                                        console.error('Erro ao salvar área:', areaError, areaToSave);
                                        alert(`Erro ao salvar área ${area.name}: ${areaError.message}`);
                                        // Não lançar erro, apenas logar para não quebrar o fluxo
                                        continue;
                                    } else {
                                        console.log('Área salva com sucesso:', savedArea);
                                    }
                                    
                                    // Deletar membros antigos da equipe
                                    if (area.id) {
                                        await supabaseClient
                                            .from('area_team_members')
                                            .delete()
                                            .eq('area_id', String(area.id));
                                        
                                        // Inserir novos membros da equipe
                                        if (team && Array.isArray(team) && team.length > 0) {
                                            const teamData = team
                                                .filter(name => name && typeof name === 'string')
                                                .map(name => ({
                                                    area_id: String(area.id),
                                                    member_name: String(name)
                                                }));
                                            
                                            if (teamData.length > 0) {
                                                const { error: teamError } = await supabaseClient
                                                    .from('area_team_members')
                                                    .insert(teamData);
                                                
                                                if (teamError) {
                                                    console.error('Erro ao salvar membros da equipe:', teamError);
                                                }
                                            }
                                        }
                                    }
                                } catch (error) {
                                    console.error('Erro ao processar área:', error, area);
                                    // Continuar com próxima área mesmo se houver erro
                                    continue;
                                }
                            }
                            
                            // Limpar cache para forçar refresh na próxima leitura
                            delete dataCache['txd_areas'];
                            
                            console.log('Todas as áreas foram salvas. Cache limpo para forçar refresh.');
                        }
                        break;
                        
                    case 'txd_chat_messages':
                        if (Array.isArray(data)) {
                            // Converter text para message e timestamp para created_at (compatibilidade com schema SQL)
                            const dataWithMessage = data.map(msg => {
                                const converted = { ...msg };
                                if (converted.text && !converted.message) {
                                    converted.message = converted.text;
                                    delete converted.text;
                                }
                                if (converted.timestamp && !converted.createdAt) {
                                    converted.createdAt = converted.timestamp;
                                    delete converted.timestamp;
                                }
                                return converted;
                            });
                            // Converter para snake_case antes de salvar
                            const convertedData = toSnakeCase(dataWithMessage);
                            const { error } = await supabaseClient
                                .from('chat_messages')
                                .upsert(convertedData, { onConflict: 'id' });
                            if (error) throw error;
                        }
                        break;
                        
                    case 'txd_chat_groups':
                        if (Array.isArray(data)) {
                            for (const group of data) {
                                const { members, ...groupData } = group;
                                
                                // Converter grupo para snake_case
                                const convertedGroup = toSnakeCase(groupData);
                                
                                // Salvar grupo
                                const { data: savedGroup, error: groupError } = await supabaseClient
                                    .from('chat_groups')
                                    .upsert(convertedGroup, { onConflict: 'id' })
                                    .select()
                                    .single();
                                if (groupError) throw groupError;
                                
                                // Deletar membros antigos
                                await supabaseClient
                                    .from('chat_group_members')
                                    .delete()
                                    .eq('group_id', savedGroup.id);
                                
                                // Inserir novos membros
                                if (members && members.length > 0) {
                                    const membersData = members.map(m => ({
                                        group_id: savedGroup.id,
                                        member_id: m.id,
                                        member_name: m.name,
                                        member_role: m.role
                                    }));
                                    const { error: membersError } = await supabaseClient
                                        .from('chat_group_members')
                                        .insert(membersData);
                                    if (membersError) throw membersError;
                                }
                            }
                        }
                        break;
                        
                    case 'txd_user_achievements':
                        if (Array.isArray(data)) {
                            const convertedData = toSnakeCase(data);
                            const { error } = await supabaseClient
                                .from('user_achievements')
                                .upsert(convertedData, { onConflict: 'user_id,achievement_id' });
                            if (error) throw error;
                        }
                        break;
                        
                    case 'txd_discord_config':
                        if (data && typeof data === 'object') {
                            const { error } = await supabaseClient
                                .from('discord_config')
                                .update({
                                    enabled: data.enabled || false,
                                    webhook_main: data.webhooks?.main || '',
                                    webhook_logs: data.webhooks?.logs || '',
                                    webhook_events: data.webhooks?.events || '',
                                    webhook_tickets: data.webhooks?.tickets || '',
                                    notifications_chat: data.notifications?.chat !== false,
                                    notifications_tasks: data.notifications?.tasks !== false,
                                    notifications_tickets: data.notifications?.tickets !== false,
                                    notifications_events: data.notifications?.events !== false,
                                    notifications_achievements: data.notifications?.achievements !== false,
                                    notifications_staff: data.notifications?.staff !== false,
                                    commands_enabled: data.commandsEnabled || false,
                                    commands_webhook: data.commandsWebhook || ''
                                })
                                .eq('id', 1);
                            if (error) throw error;
                        }
                        break;
                        
                    case 'txd_discord_commands_log':
                        if (Array.isArray(data)) {
                            // Limpar log antigo e inserir novo
                            await supabaseClient.from('discord_commands_log').delete().neq('id', 0);
                            if (data.length > 0) {
                                const convertedData = toSnakeCase(data);
                                const { error } = await supabaseClient
                                    .from('discord_commands_log')
                                    .insert(convertedData);
                                if (error) throw error;
                            }
                        }
                        break;
                        
                    case 'txd_registration_requests':
                        if (Array.isArray(data)) {
                            try {
                                // Para cada request, fazer upsert
                                for (const request of data) {
                                    const convertedRequest = toSnakeCase(request);
                                    
                                    // Garantir que status está presente
                                    if (!convertedRequest.status) {
                                        convertedRequest.status = 'pending';
                                    }
                                    
                                    // Garantir que requested_at está presente
                                    if (!convertedRequest.requested_at && request.requestedAt) {
                                        convertedRequest.requested_at = request.requestedAt;
                                    } else if (!convertedRequest.requested_at) {
                                        convertedRequest.requested_at = new Date().toISOString();
                                    }
                                    
                                    console.log('Salvando solicitação:', convertedRequest);
                                    
                                    const { data: savedRequest, error } = await supabaseClient
                                        .from('registration_requests')
                                        .upsert(convertedRequest, { onConflict: 'id' })
                                        .select();
                                    
                                    if (error) {
                                        // Se a tabela não existir, mostrar mensagem útil
                                        if (error.code === 'PGRST116' || error.message?.includes('404')) {
                                            console.error('❌ ERRO: Tabela registration_requests não existe no Supabase!');
                                            console.error('📋 Execute o SQL do arquivo: criar_tabela_registration_requests.sql');
                                            alert('Erro: Tabela registration_requests não existe. Execute o SQL de criação no Supabase.');
                                        } else {
                                            console.error('Erro ao salvar registration_request:', error, convertedRequest);
                                        }
                                        throw error;
                                    } else {
                                        console.log('Solicitação salva com sucesso:', savedRequest);
                                    }
                                }
                                
                                // Limpar cache após salvar
                                delete dataCache['txd_registration_requests'];
                            } catch (err) {
                                // Se for erro de tabela não encontrada, tentar criar via insert direto
                                if (err.code === 'PGRST116' || err.message?.includes('404')) {
                                    console.error('Tabela não existe. Por favor, execute o SQL de criação.');
                                    throw new Error('Tabela registration_requests não existe. Execute criar_tabela_registration_requests.sql no Supabase.');
                                }
                                throw err;
                            }
                        }
                        break;
                        
                    case 'txd_kanban':
                        if (data && typeof data === 'object') {
                            // Salvar colunas
                            if (data.columns) {
                                const convertedColumns = toSnakeCase(data.columns);
                                const { error: colsError } = await supabaseClient
                                    .from('kanban_columns')
                                    .upsert(convertedColumns, { onConflict: 'id' });
                                if (colsError) throw colsError;
                            }
                            
                            // Salvar cards
                            if (data.cards && Array.isArray(data.cards)) {
                                for (const card of data.cards) {
                                    if (!card || !card.id) {
                                        console.warn('Card inválido ignorado:', card);
                                        continue;
                                    }
                                    
                                    const { assignees, assignee, ...cardData } = card;
                                    
                                    // Garantir que columnId existe
                                    if (!cardData.columnId && !cardData.column_id) {
                                        cardData.columnId = 'todo';
                                    }
                                    
                                    // REMOVER campo de data se estiver vazio (não é obrigatório)
                                    if (!cardData.dueDate || cardData.dueDate === '' || cardData.dueDate === null) {
                                        delete cardData.dueDate;
                                    }
                                    if (cardData.due_date === '' || cardData.due_date === null) {
                                        delete cardData.due_date;
                                    }
                                    
                                    // Converter card para snake_case
                                    const convertedCard = toSnakeCase(cardData);
                                    
                                    // REMOVER due_date se for string vazia (não enviar para o banco)
                                    if (convertedCard.due_date === '' || convertedCard.due_date === null || convertedCard.due_date === undefined) {
                                        delete convertedCard.due_date;
                                    }
                                    
                                    // Salvar card
                                    const { data: savedCard, error: cardError } = await supabaseClient
                                        .from('kanban_cards')
                                        .upsert(convertedCard, { onConflict: 'id' })
                                        .select()
                                        .single();
                                    if (cardError) throw cardError;
                                    
                                    // Deletar assignees antigos primeiro
                                    const { error: deleteError } = await supabaseClient
                                        .from('kanban_card_assignees')
                                        .delete()
                                        .eq('card_id', savedCard.id);
                                    if (deleteError) {
                                        console.warn('Aviso ao deletar assignees antigos (pode ser normal):', deleteError.message);
                                        // Continuar mesmo se houver erro ao deletar (pode não existir ainda)
                                    }
                                    
                                    // Aguardar um pouco para garantir que a deleção foi processada
                                    await new Promise(resolve => setTimeout(resolve, 50));
                                    
                                    // Inserir novos assignees (apenas se houver e não estiverem duplicados)
                                    if (assignees && Array.isArray(assignees) && assignees.length > 0) {
                                        // Remover duplicatas e valores vazios/null
                                        const uniqueAssignees = [...new Set(assignees.filter(name => name && typeof name === 'string' && name.trim() !== ''))];
                                        
                                        if (uniqueAssignees.length > 0) {
                                            const assigneesData = uniqueAssignees.map(name => ({
                                            card_id: savedCard.id,
                                                assignee_name: name.trim()
                                        }));
                                            
                                            // Usar upsert para evitar duplicatas
                                        const { error: assigneesError } = await supabaseClient
                                            .from('kanban_card_assignees')
                                                .upsert(assigneesData, { 
                                                    onConflict: 'card_id,assignee_name'
                                                });
                                            if (assigneesError) {
                                                console.warn('Aviso ao salvar assignees (continuando mesmo assim):', assigneesError.message);
                                                // Não lançar erro para não quebrar o salvamento do card principal
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        break;
                        
                    case 'txd_favorite_commands':
                        if (Array.isArray(data)) {
                            // Limpar favoritos antigos
                            await supabaseClient.from('favorite_commands').delete().neq('id', 0);
                            if (data.length > 0) {
                                const favoritesData = data.map(cmdId => ({
                                    user_id: currentUser?.id || 'default',
                                    command_id: cmdId
                                }));
                                const { error } = await supabaseClient
                                    .from('favorite_commands')
                                    .insert(favoritesData);
                                if (error) throw error;
                            }
                        }
                        break;
                        
                    case 'txd_command_usage':
                        if (Array.isArray(data) && data.length > 0) {
                            const convertedData = toSnakeCase(data);
                            const { error } = await supabaseClient
                                .from('command_usage')
                                .insert(convertedData);
                            if (error) throw error;
                        }
                        break;
                }
                
                // Atualizar cache
                dataCache[key] = data;
                
            } catch (error) {
                console.error(`Erro ao salvar ${key} no Supabase:`, error);
            }
        }
        
        // Função para inicializar cache
        async function initializeCache() {
            if (cacheInitialized) return;
            
            try {
                const keys = Object.keys(keyToTableMap);
                for (const key of keys) {
                    await getData(key);
                }
                cacheInitialized = true;
                console.log('✅ Cache Supabase inicializado');
            } catch (error) {
                console.error('Erro ao inicializar cache:', error);
            }
        }
        
        // Inicializar cache ao carregar
        initializeCache();
        
        // ========== SISTEMA DE LOGIN ==========
        // Usuários pré-configurados com acesso total
        const PRECONFIGURED_USERS = {
            'romanov': {
                password: '5875',
                name: 'Romanov',
                role: 'Owner',
                id: 999,
                email: 'romanov@txd.staff',
                status: 'Ativo'
            }
        };

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (username && password) {
                try {
                    let userFound = null;
                    
                    // 1. Verificar usuários pré-configurados primeiro
                    const lowerUsername = username.toLowerCase();
                    if (PRECONFIGURED_USERS[lowerUsername]) {
                        const preUser = PRECONFIGURED_USERS[lowerUsername];
                        if (password === preUser.password) {
                            userFound = { ...preUser };
                        } else {
                            alert('Senha incorreta para este usuário.');
                            return;
                        }
                    }
                    
                    // 2. Se não for pré-configurado, buscar no Supabase (por login ou name)
                    if (!userFound && supabaseClient) {
                        const { data: staffData, error } = await supabaseClient
                            .from('staff')
                            .select('*')
                            .or(`name.ilike.%${username}%,display_name.ilike.%${username}%,login.ilike.%${username}%`)
                            .limit(1);
                        
                        if (!error && staffData && Array.isArray(staffData) && staffData.length > 0) {
                            const foundUser = staffData[0];
                            // Verificar senha se existir
                            if (foundUser.password && foundUser.password !== password) {
                                alert('Senha incorreta.');
                                return;
                            }
                            
                            // Verificar se o usuário está aprovado
                            if (foundUser.status === 'Ativo' || foundUser.status === 'ativo') {
                                userFound = {
                                    id: foundUser.id,
                                    name: foundUser.name || foundUser.display_name || username,
                                    displayName: foundUser.display_name || foundUser.name || username,
                                    role: foundUser.role || 'Helper',
                                    email: foundUser.email || null,
                                    status: foundUser.status || 'Ativo',
                                    password: foundUser.password || null,
                                    login: foundUser.login || foundUser.name || username,
                                    area: foundUser.area || null,
                                    gameId: foundUser.game_id || null,
                                    discordId: foundUser.discord_id || null
                                };
                            } else {
                                alert('Sua conta ainda não foi aprovada. Aguarde a aprovação de um administrador.');
                                return;
                            }
                        }
                    }
                    
                    // 3. Se não encontrou no Supabase, buscar no localStorage
                    if (!userFound) {
                        const staffDataRaw = getData('txd_staff');
                        // Garantir que seja sempre um array
                        const staffData = Array.isArray(staffDataRaw) ? staffDataRaw : [];
                        
                        if (staffData.length > 0) {
                            const foundUser = staffData.find(s => 
                                s && (
                                    (s.name && s.name.toLowerCase().includes(username.toLowerCase())) ||
                                    (s.login && s.login.toLowerCase() === username.toLowerCase())
                                )
                            );
                            
                            if (foundUser) {
                                // Verificar se o usuário está aprovado
                                if (foundUser.status === 'Ativo' || foundUser.status === 'ativo') {
                                    // Verificar senha se existir
                                    if (foundUser.password && foundUser.password !== password) {
                                        alert('Senha incorreta.');
                                        return;
                                    }
                                    userFound = foundUser;
                                } else {
                                    alert('Sua conta ainda não foi aprovada. Aguarde a aprovação de um administrador.');
                                    return;
                                }
                            }
                        }
                    }
                    
                    // 4. Verificar se há solicitação aprovada pendente
                    if (!userFound) {
                        const requestsRaw = getData('txd_registration_requests');
                        const requests = Array.isArray(requestsRaw) ? requestsRaw : [];
                        
                        const approvedRequest = requests.find(r => 
                            r && 
                            r.username && 
                            (r.username.toLowerCase() === username.toLowerCase() || 
                             (r.login && r.login.toLowerCase() === username.toLowerCase())) && 
                            r.status === 'approved'
                        );
                        
                        if (approvedRequest) {
                            // Verificar senha
                            if (approvedRequest.password === password) {
                                // Criar usuário a partir da solicitação aprovada
                                userFound = {
                                    id: Date.now(),
                                    name: approvedRequest.username,
                                    displayName: approvedRequest.displayName,
                                    role: approvedRequest.role || 'Helper', // Cargo padrão
                                    email: approvedRequest.email || null,
                                    status: 'Ativo',
                                    password: approvedRequest.password,
                                    createdAt: new Date().toISOString()
                                };
                                
                                // Adicionar ao staff
                                const staffData = getData('txd_staff') || [];
                                staffData.push(userFound);
                                await saveData('txd_staff', staffData);
                                
                                // Marcar solicitação como processada
                                approvedRequest.status = 'processed';
                                await saveData('txd_registration_requests', requests);
                            } else {
                                alert('Senha incorreta.');
                                return;
                            }
                        } else {
                            // Verificar se há solicitação pendente
                            const pendingRequest = requests.find(r => 
                                r && 
                                r.username && 
                                r.username.toLowerCase() === username.toLowerCase() && 
                                r.status === 'pending'
                            );
                            
                            if (pendingRequest) {
                                alert('Sua solicitação de cadastro ainda está pendente de aprovação. Aguarde a análise de um administrador.');
                                return;
                            }
                            
                            // Se não encontrou nada, informar que precisa se cadastrar
                            alert('Usuário não encontrado. Por favor, crie uma conta primeiro.');
                            return;
                        }
                    }
                    
                    // Definir usuário atual
                    currentUser = {
                        id: userFound.id || 1,
                        name: userFound.name || userFound.displayName || username,
                        role: userFound.role || 'Owner',
                        email: userFound.email || null,
                        displayName: userFound.displayName || userFound.name || username,
                        status: userFound.status || 'Ativo',
                        login: userFound.login || userFound.name || username,
                        area: userFound.area || null,
                        gameId: userFound.gameId || null,
                        discordId: userFound.discordId || null
                    };
                    
                    // Aplicar permissões ao menu
                    const permissions = getUserPermissions(currentUser.role);
                    applyPermissionsToMenu(permissions);
                    
                    // Mostrar dashboard
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                
                // Inicializar real-time após login
                if (supabaseClient && !cacheInitialized) {
                    initializeRealtime();
                    cacheInitialized = true;
                }
                
                // Recarregar dados do Supabase
                await refreshData();
                
                showSection('inicio');
                
                // Notificar Discord sobre login
                sendDiscordNotification('staff', '🔐 Login Realizado', 
                    `${currentUser?.name || currentUser?.displayName || 'Usuário'} entrou no sistema`,
                    [
                        { name: '👤 Usuário', value: currentUser?.name || currentUser?.displayName || 'Desconhecido', inline: true },
                        { name: '🎖️ Cargo', value: currentUser?.role || 'N/A', inline: true },
                        { name: '🕐 Horário', value: new Date().toLocaleString('pt-BR'), inline: true }
                    ]
                );
                
                // Atualizar badge de notificações
                setTimeout(() => {
                    updateChatNotificationBadge();
                }, 100);
                
                // Verificar notificações periodicamente (a cada 10 segundos)
                setInterval(() => {
                    chatMessages = getData('txd_chat_messages') || [];
                    updateChatNotificationBadge();
                }, 10000);
                    
                } catch (error) {
                    console.error('Erro no login:', error);
                    alert('Erro ao fazer login. Tente novamente.');
                }
            }
        }

        function showRegister() {
            document.getElementById('registerModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ========== SISTEMA DE REGISTRO E APROVAÇÃO ==========
        
        async function handleRegister() {
            const form = document.getElementById('registerForm');
            const inputs = form.querySelectorAll('input');
            
            const username = inputs[0].value.trim();
            const displayName = inputs[1].value.trim();
            const password = inputs[2].value;
            const confirmPassword = inputs[3].value;
            
            // Validações
            if (!username || !displayName || !password || !confirmPassword) {
                alert('Por favor, preencha todos os campos.');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('As senhas não coincidem.');
                return;
            }
            
            if (password.length < 4) {
                alert('A senha deve ter pelo menos 4 caracteres.');
                return;
            }
            
            // Verificar se o usuário já existe
            const existingStaff = getData('txd_staff') || [];
            const existingRequest = getData('txd_registration_requests') || [];
            
            if (Array.isArray(existingStaff) && existingStaff.some(s => s && s.name && s.name.toLowerCase() === username.toLowerCase())) {
                alert('Este usuário já está cadastrado no sistema.');
                return;
            }
            
            if (Array.isArray(existingRequest) && existingRequest.some(r => r && r.username && r.username.toLowerCase() === username.toLowerCase() && r.status === 'pending')) {
                alert('Você já possui uma solicitação pendente. Aguarde a aprovação.');
                return;
            }
            
            try {
                // Verificar se Supabase está inicializado
                if (!supabaseClient) {
                    console.error('Supabase não está inicializado!');
                    alert('Erro: Sistema não está conectado ao banco de dados. Recarregue a página.');
                    return;
                }
                
                console.log('Supabase inicializado:', !!supabaseClient);
                
                // Criar solicitação de registro
                const request = {
                    id: Date.now(),
                    username: username,
                    display_name: displayName,
                    password: password, // Em produção, isso deve ser criptografado
                    status: 'pending', // pending, approved, rejected
                    requested_at: new Date().toISOString(),
                    requested_by: username,
                    approved_by: null,
                    approved_at: null,
                    rejection_reason: null
                };
                
                console.log('📝 Criando solicitação:', request);
                console.log('🔍 Tentando salvar no Supabase...');
                console.log('🔗 URL do Supabase:', SUPABASE_URL);
                console.log('📊 Tabela: registration_requests');
                
                // TESTE: Verificar se a tabela existe primeiro
                const { data: testData, error: testError } = await supabaseClient
                    .from('registration_requests')
                    .select('id')
                    .limit(1);
                
                if (testError && (testError.code === 'PGRST116' || testError.message?.includes('does not exist'))) {
                    console.error('❌ TABELA NÃO EXISTE!');
                    alert('❌ ERRO CRÍTICO: A tabela registration_requests não existe no Supabase!\n\nPor favor, execute o SQL de criação da tabela no Supabase SQL Editor.\n\nVerifique o console para mais detalhes.');
                    return;
                }
                
                console.log('✅ Tabela existe. Prosseguindo com inserção...');
                
                // Salvar diretamente no Supabase (não usar saveData que espera array)
                const { data: savedRequest, error: saveError } = await supabaseClient
                    .from('registration_requests')
                    .insert(request)
                    .select();
                
                if (saveError) {
                    console.error('❌ Erro ao salvar solicitação no Supabase:', saveError);
                    console.error('Detalhes do erro:', {
                        code: saveError.code,
                        message: saveError.message,
                        details: saveError.details,
                        hint: saveError.hint
                    });
                    
                    if (saveError.code === 'PGRST116' || saveError.message?.includes('404') || saveError.message?.includes('does not exist')) {
                        alert('❌ Erro: Tabela registration_requests não existe no Supabase.\n\nExecute o SQL de criação da tabela no Supabase SQL Editor.');
                    } else if (saveError.code === '23505' || saveError.message?.includes('duplicate')) {
                        alert('⚠️ Este usuário já possui uma solicitação pendente.');
                    } else {
                        alert(`❌ Erro ao enviar solicitação:\n\n${saveError.message}\n\nVerifique o console para mais detalhes.`);
                    }
                    return;
                }
                
                if (!savedRequest || savedRequest.length === 0) {
                    console.error('⚠️ Solicitação não foi retornada pelo Supabase');
                    alert('⚠️ Solicitação enviada, mas não foi possível confirmar o salvamento. Verifique o painel de controle.');
                } else {
                    console.log('✅ Solicitação salva com sucesso:', savedRequest);
                }
                
                // Limpar cache para forçar refresh
                delete dataCache['txd_registration_requests'];
                
                // Verificar se a solicitação foi realmente salva
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Tentar buscar a solicitação recém-criada para confirmar
                const { data: verifyData, error: verifyError } = await supabaseClient
                    .from('registration_requests')
                    .select('*')
                    .eq('username', username)
                    .eq('status', 'pending')
                    .order('requested_at', { ascending: false })
                    .limit(1);
                
                if (verifyError) {
                    console.warn('⚠️ Não foi possível verificar a solicitação:', verifyError);
                } else if (verifyData && verifyData.length > 0) {
                    console.log('✅ Solicitação confirmada no banco:', verifyData[0]);
                } else {
                    console.warn('⚠️ Solicitação não encontrada após salvar. Pode levar alguns segundos para aparecer.');
                }
                
                // Notificar Discord
                try {
                    sendDiscordNotification('staff', '📝 Nova Solicitação de Cadastro', 
                        `Nova solicitação de cadastro recebida`,
                        [
                            { name: '👤 Usuário', value: username, inline: true },
                            { name: '📛 Nome', value: displayName, inline: true },
                            { name: '🕐 Data', value: new Date().toLocaleString('pt-BR'), inline: true },
                            { name: '⚠️ Ação Necessária', value: 'Aprovar ou rejeitar no painel administrativo', inline: false }
                        ]
                    );
                } catch (discordError) {
                    console.warn('Erro ao notificar Discord:', discordError);
                }
                
                // Fechar modal e mostrar mensagem
                closeModal('registerModal');
                
                // Mostrar mensagem de sucesso com detalhes
                const successMsg = `✅ Solicitação de cadastro enviada com sucesso!

👤 Usuário: ${username}
📛 Nome: ${displayName}
🕐 Data: ${new Date().toLocaleString('pt-BR')}

Aguarde a aprovação de um administrador. Você receberá uma notificação quando sua solicitação for analisada.

💡 Dica: Um administrador pode ver sua solicitação na seção "Controle" do painel.`;
                
                alert(successMsg);
                
                // Limpar formulário
                form.reset();
                
                // Forçar refresh imediato do painel de controle se estiver aberto
                if (currentSection === 'controle') {
                    console.log('🔄 Recarregando painel de controle...');
                    setTimeout(async () => {
                        await loadStaffControl();
                        console.log('✅ Painel recarregado');
                    }, 1000);
                }
                
                // Notificar qualquer admin logado via real-time (já está configurado)
                console.log('📢 Solicitação salva. Real-time deve notificar admins automaticamente.');
                
            } catch (error) {
                console.error('❌ Erro ao criar solicitação:', error);
                console.error('Stack trace:', error.stack);
                alert(`❌ Erro ao enviar solicitação:\n\n${error.message || 'Erro desconhecido'}\n\nVerifique o console para mais detalhes.`);
            }
        }

        function showTerms() {
            // Validar formulário antes de mostrar termos
            const form = document.getElementById('registerForm');
            const inputs = form.querySelectorAll('input');
            
            const username = inputs[0].value.trim();
            const displayName = inputs[1].value.trim();
            const password = inputs[2].value;
            const confirmPassword = inputs[3].value;
            
            if (!username || !displayName || !password || !confirmPassword) {
                alert('Por favor, preencha todos os campos antes de prosseguir.');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('As senhas não coincidem.');
                return;
            }
            
            closeModal('registerModal');
            document.getElementById('termsModal').classList.add('active');
        }

        function toggleConfirmButton() {
            const checkbox = document.getElementById('termAgree');
            const confirmBtn = document.getElementById('confirmTermBtn');
            confirmBtn.disabled = !checkbox.checked;
        }

        async function acceptTerms() {
            // Processar registro após aceitar termos
            await handleRegister();
            closeModal('termsModal');
        }

        function logout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                // Notificar Discord sobre logout
                sendDiscordNotification('staff', '🚪 Logout Realizado', 
                    `${currentUser.name} saiu do sistema`,
                    [
                        { name: '👤 Usuário', value: currentUser.name, inline: true },
                        { name: '🎖️ Cargo', value: currentUser.role, inline: true },
                        { name: '🕐 Horário', value: new Date().toLocaleString('pt-BR'), inline: true }
                    ]
                );
                
                document.getElementById('dashboard').classList.remove('active');
                document.getElementById('loginScreen').style.display = 'flex';
                // Limpar formulário
                document.getElementById('loginForm').reset();
            }
        }

        // ========== NAVEGAÇÃO ==========
        function showSection(section) {
            // Atualizar seção atual para real-time
            currentSection = section;
            
            // Validar permissões antes de exibir a seção
            if (!canAccess(section)) {
                // Mostrar mensagem de acesso negado
                const contentCard = document.querySelector('.content-card');
                if (contentCard) {
                    contentCard.innerHTML = `
                        <div style="text-align: center; padding: 48px 24px;">
                            <div style="font-size: 64px; margin-bottom: 24px;">🔒</div>
                            <h1 style="color: var(--white-soft); margin-bottom: 16px;">Acesso não autorizado</h1>
                            <p style="color: var(--gray-light); margin-bottom: 32px;">
                                Você não tem permissão para acessar esta seção.
                            </p>
                            <p style="color: var(--gray-text); font-size: 14px;">
                                Cargo atual: <strong>${currentUser?.role || 'N/A'}</strong>
                            </p>
                            <button class="btn btn-primary" onclick="showSection('inicio')" style="margin-top: 24px;">
                                <i class="fas fa-home"></i> Voltar ao Início
                            </button>
                        </div>
                    `;
                }
                
                // Atualizar título
                document.getElementById('sectionTitle').textContent = 'Acesso Negado';
                
                // Atualizar menu ativo (remover ativo de todos)
                document.querySelectorAll('.nav-menu a').forEach(link => {
                    link.classList.remove('active');
                });
                
                return; // Bloquear acesso
            }
            
            const titles = {
                'inicio': 'Início',
                'tarefas': 'Tarefas - Kanban',
                'chat': '💬 Chat',
                'ranking': '📊 Ranking',
                'conquistas': '🏆 Conquistas',
                'comandos': 'Comandos',
                'controle': 'Controle de Staff',
                'areas': 'Áreas de Responsabilidade',
                'advertencias': 'Gestão de Advertências',
                'agenda': 'Agenda da Equipe',
                'formularios': 'Formulários Recebidos',
                'relatorios': 'Relatórios de Reunião',
                'config': 'Configurações do Sistema'
            };
            document.getElementById('sectionTitle').textContent = titles[section] || 'Painel TXD Staff';
            
            // Atualizar menu ativo
            document.querySelectorAll('.nav-menu a').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(section)) {
                    link.classList.add('active');
                }
            });
        }

        // ========== FUNCIONALIDADES ==========
        
        // ========== SISTEMA DE PERMISSÕES POR CARGO (RBAC) - PASSO 2 ==========
        
        // Mapeamento de seções do menu para permissões
        const SECTION_PERMISSIONS = {
            'inicio': '*', // Sempre acessível
            'tarefas': 'dashboard',
            'chat': 'chat', // Chat específico ou suporte
            'ranking': 'dashboard',
            'conquistas': 'dashboard',
            'comandos': 'comandos',
            'controle': 'staff', // Staff ou staff_area
            'areas': 'area', // Area ou staff_area
            'advertencias': 'moderacao',
            'agenda': 'dashboard',
            'formularios': 'tickets', // Tickets ou tickets_basico
            'relatorios': 'relatorios',
            'perfil': '*', // Todos podem acessar seu próprio perfil
            'config': 'sistema' // Sistema, config ou logs
        };

        // Permissões por cargo (formato simplificado conforme prompt)
        const ROLE_PERMISSIONS = {
            // Sistema Principal (C-Level) - Todos com acesso total
            'Owner': ['*'],
            'CEO': ['*'],
            'COO': ['*'],
            'CMO': ['*'],
            'CCO': ['*'],
            'CIO': ['*'],
            
            // Sistema Secundário (Operacional)
            'HeadStaff': ['dashboard', 'staff', 'tickets', 'moderacao'],
            'Diretor': ['dashboard', 'area'],
            'Coordenador': ['tickets', 'staff_area'],
            'Admin': ['tickets', 'moderacao', 'comandos'],
            'Moderador': ['tickets', 'moderacao'],
            'Suporte': ['tickets'],
            'Helper': ['tickets_basico'],
            'Dev': ['sistema']
        };

        // Usuário atual (será definido no login)
        let currentUser = { role: 'Owner', name: 'Admin', id: 1 };

        // ========== FUNÇÕES DE PERMISSÕES ==========
        
        /**
         * Obtém as permissões do cargo do usuário
         * @param {string} role - Cargo do usuário
         * @returns {Array} Array de permissões
         */
        function getUserPermissions(role) {
            if (!role) return [];
            return ROLE_PERMISSIONS[role] || [];
        }

        /**
         * Verifica se o usuário tem acesso a uma seção específica
         * @param {string} section - Nome da seção (ex: 'tarefas', 'controle')
         * @returns {boolean} true se tem acesso, false caso contrário
         */
        function canAccess(section) {
            if (!currentUser || !currentUser.role) {
                return false;
            }

            // Seção 'inicio' sempre acessível
            if (section === 'inicio') {
                return true;
            }

            const userPermissions = getUserPermissions(currentUser.role);
            
            // Se tem '*', tem acesso total
            if (userPermissions.includes('*')) {
                return true;
            }

            // Obter permissão necessária para a seção
            const requiredPermission = SECTION_PERMISSIONS[section];
            if (!requiredPermission) {
                return false; // Seção não mapeada, negar acesso por segurança
            }

            // Se a seção requer '*', apenas usuários com '*' podem acessar
            if (requiredPermission === '*') {
                return userPermissions.includes('*');
            }

            // Verificar se tem a permissão específica ou uma permissão relacionada
            // Mapeamento flexível para permissões relacionadas
            const permissionMap = {
                'dashboard': ['dashboard'],
                'staff': ['staff', 'staff_area'],
                'tickets': ['tickets', 'tickets_basico', 'suporte'],
                'moderacao': ['moderacao'],
                'comandos': ['comandos'],
                'relatorios': ['relatorios'],
                'sistema': ['sistema', 'config', 'logs'],
                'area': ['area', 'staff_area'],
                'marketing': ['marketing'],
                'chat': ['chat', 'suporte', 'dashboard'], // Chat pode ser acessado por suporte ou dashboard
                'tickets_basico': ['tickets_basico', 'tickets', 'suporte']
            };

            // Verificar permissão direta
            if (userPermissions.includes(requiredPermission)) {
                return true;
            }

            // Verificar permissões relacionadas
            const relatedPermissions = permissionMap[requiredPermission] || [];
            return relatedPermissions.some(perm => userPermissions.includes(perm));
        }

        /**
         * Aplica permissões ao menu, ocultando itens não permitidos
         * @param {Array} permissions - Array de permissões do usuário
         */
        function applyPermissionsToMenu(permissions) {
            const menuItems = document.querySelectorAll('.nav-menu li');
            
            menuItems.forEach(item => {
                const link = item.querySelector('a');
                if (!link) return;

                // Extrair nome da seção do onclick
                const onclickAttr = link.getAttribute('onclick');
                if (!onclickAttr) return;

                const sectionMatch = onclickAttr.match(/showSection\(['"]([^'"]+)['"]\)/);
                if (!sectionMatch) return;

                const section = sectionMatch[1];
                
                // Verificar se tem acesso
                if (!canAccess(section)) {
                    item.classList.add('hidden');
                } else {
                    item.classList.remove('hidden');
                }
            });
        }

        // Função de compatibilidade para código existente que usa hasPermission
        function hasPermission(action) {
            if (!currentUser || !currentUser.role) {
                return false;
            }
            
            const userPermissions = getUserPermissions(currentUser.role);
            
            // Se tem '*', tem todas as permissões
            if (userPermissions.includes('*')) {
                return true;
            }
            
            // Mapeamento de ações antigas para novas permissões
            const actionToPermissionMap = {
                'task.create': 'dashboard',
                'task.edit': 'dashboard',
                'task.delete': 'dashboard',
                'task.view': 'dashboard',
                // Permitir tarefas para todos que têm acesso ao dashboard ou qualquer permissão
                'tasks': 'dashboard',
                'staff.view': 'staff',
                'staff.create': 'staff',
                'staff.edit': 'staff',
                'staff.delete': 'staff',
                'ticket.view': 'tickets',
                'ticket.create': 'tickets',
                'ticket.edit': 'tickets',
                'ticket.resolve': 'tickets',
                'system.config': 'sistema',
                'system.logs': 'sistema',
                'warning.view': 'moderacao',
                'warning.create': 'moderacao',
                'form.view': 'tickets',
                'area.view': 'area',
                'area.create': 'area',
                'area.edit': 'area',
                'report.view': 'relatorios',
                'report.create': 'relatorios',
                'event.view': 'dashboard',
                'event.create': 'dashboard',
                'announcement.view': 'dashboard',
                'announcement.create': 'dashboard'
            };

            const mappedPermission = actionToPermissionMap[action];
            if (mappedPermission) {
                return userPermissions.includes(mappedPermission) || 
                       userPermissions.includes('*') ||
                       (mappedPermission === 'tickets' && userPermissions.includes('tickets_basico')) ||
                       (mappedPermission === 'staff' && userPermissions.includes('staff_area')) ||
                       (mappedPermission === 'area' && userPermissions.includes('staff_area'));
            }

            return false;
        }

        // Verificar múltiplas permissões (todas devem ser verdadeiras)
        function hasAllPermissions(...actions) {
            return actions.every(action => hasPermission(action));
        }

        // Verificar se tem pelo menos uma das permissões
        function hasAnyPermission(...actions) {
            return actions.some(action => hasPermission(action));
        }

        // Obter todas as permissões do cargo atual (compatibilidade)
        function getCurrentUserPermissions() {
            return getUserPermissions(currentUser?.role);
        }

        // Obter permissões de um cargo específico
        function getRolePermissions(role) {
            return getUserPermissions(role);
        }

        // Verificar se pode executar ação e mostrar erro se não puder
        function requirePermission(action, errorMessage = 'Você não tem permissão para realizar esta ação.') {
            if (!hasPermission(action)) {
                alert(errorMessage);
                return false;
            }
            return true;
        }

        // Função para verificar permissões quando cargo muda
        function checkPermissions() {
            const role = document.getElementById('staffRole')?.value;
            if (role) {
                const rolePerms = getRolePermissions(role);
                const roleDesc = getUserPermissions(role).includes('*') ? 'Acesso total' : `${getUserPermissions(role).length} permissões`;
                console.log(`Permissões do cargo ${role}:`, rolePerms);
                console.log(`Descrição: ${roleDesc}`);
            }
        }

        // ========== GERENCIAMENTO DE DADOS (Supabase) ==========
        // Funções getData e saveData estão definidas acima (usando Supabase)

        // Inicializar dados (valores padrão - serão atualizados pelo refreshData)
        let staffData = dataCache['txd_staff'] || [
            { id: 1, name: 'João Silva', role: 'Owner', area: 'Administração', status: 'Ativo', email: 'joao@txd.com' },
            { id: 2, name: 'Maria Santos', role: 'CEO', area: 'Administração', status: 'Ativo', email: 'maria@txd.com' },
            { id: 3, name: 'Pedro Costa', role: 'Head Staff', area: 'Moderação', status: 'Ativo', email: 'pedro@txd.com' }
        ];

        let eventsData = dataCache['txd_events'] || [];
        let announcementsData = dataCache['txd_announcements'] || [];
        let ticketsData = dataCache['txd_tickets'] || [
            { id: 1, title: 'Problema com banimento', type: 'Ticket', status: 'Finalizado', responsible: 'João Silva' },
            { id: 2, title: 'Dúvida sobre regras', type: 'Call', status: 'Finalizado', responsible: 'Maria Santos' },
            { id: 3, title: 'Suporte técnico - Login', type: 'Ticket', status: 'Finalizado', responsible: 'Pedro Costa' },
            { id: 4, title: 'Revisão de punição', type: 'Ticket', status: 'Finalizado', responsible: 'João Silva' },
            { id: 5, title: 'Dúvida sobre gameplay', type: 'Call', status: 'Finalizado', responsible: 'Maria Santos' },
            { id: 6, title: 'Bug no sistema', type: 'Ticket', status: 'Em andamento', responsible: 'Pedro Costa' },
            { id: 7, title: 'Solicitação de whitelist', type: 'Ticket', status: 'Aberto', responsible: 'João Silva' }
        ];

        // Carregar dados do Supabase ao iniciar
        refreshData();

        // Função para carregar conteúdo das seções
        function loadSectionContent(section) {
            const contentCard = document.querySelector('.content-card');
            
            switch(section) {
                case 'inicio':
                    loadDashboard();
                    break;
                case 'tarefas':
                    loadKanban();
                    break;
                case 'ranking':
                    loadRanking();
                    break;
                case 'conquistas':
                    loadAchievements();
                    break;
                case 'controle':
                    loadStaffControl();
                    break;
                case 'comandos':
                    loadCommands();
                    break;
                case 'agenda':
                    loadAgenda();
                    break;
                case 'formularios':
                    loadForms();
                    break;
                case 'relatorios':
                    loadReports();
                    break;
                case 'advertencias':
                    loadWarnings();
                    break;
                case 'areas':
                    loadAreas();
                    break;
                case 'perfil':
                    loadPerfil();
                    break;
                case 'config':
                    loadSettings();
                    break;
            }
        }

        async function loadDashboard() {
            await refreshData();
            
            // Obter nome do usuário
            const userName = currentUser?.name || currentUser?.displayName || 'Staff';
            
            // Buscar atividades recentes (logs do sistema)
            const logsData = getData('txd_system_logs') || [];
            const recentActivities = Array.isArray(logsData) 
                ? logsData.slice(0, 5).reverse() 
                : [];
            
            const content = `
                <!-- HERO -->
                <div style="margin-bottom: 48px;">
                    <h1 id="sectionTitle" style="font-size: 36px; font-weight: 700; color: var(--white-soft); margin-bottom: 12px; line-height: 1.2;">
                        Bem-vindo, ${userName}
                    </h1>
                    <p style="font-size: 18px; color: var(--gray-light); margin-bottom: 8px; line-height: 1.5;">
                        Central de gerenciamento da staff TXD. Controle, organização e autoridade em um só lugar.
                    </p>
                    <p style="font-size: 14px; color: var(--gray-text); line-height: 1.6;">
                        Este painel centraliza todas as ferramentas necessárias para gerenciar a equipe, monitorar atividades e manter a ordem institucional.
                    </p>
                </div>
                
                <!-- AÇÕES RÁPIDAS -->
                <div style="margin-bottom: 48px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: var(--white-soft); margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-bolt" style="color: var(--warning);"></i>
                        Ações Rápidas
                    </h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                        ${hasPermission('event.create') ? `
                        <div class="action-card" onclick="openNewEvent()" style="background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;" 
                             onmouseenter="this.style.borderColor='var(--warning)'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(255, 170, 0, 0.15)';" 
                             onmouseleave="this.style.borderColor='var(--gray-border)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <div style="font-size: 32px; margin-bottom: 16px;">📅</div>
                            <h3 style="font-size: 18px; font-weight: 600; color: var(--white-soft); margin-bottom: 8px;">Criar Evento</h3>
                            <p style="font-size: 14px; color: var(--gray-light); line-height: 1.5;">Agende eventos, reuniões e atividades da staff com data, hora e descrição completa.</p>
                        </div>
                        ` : ''}
                        ${hasPermission('announcement.create') ? `
                        <div class="action-card" onclick="openAnnouncement()" style="background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;" 
                             onmouseenter="this.style.borderColor='var(--warning)'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(255, 170, 0, 0.15)';" 
                             onmouseleave="this.style.borderColor='var(--gray-border)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <div style="font-size: 32px; margin-bottom: 16px;">📢</div>
                            <h3 style="font-size: 18px; font-weight: 600; color: var(--white-soft); margin-bottom: 8px;">Enviar Aviso Geral</h3>
                            <p style="font-size: 14px; color: var(--gray-light); line-height: 1.5;">Comunique-se com toda a equipe através de avisos importantes e notificações gerais.</p>
                        </div>
                        ` : ''}
                        ${hasPermission('staff.manage') || hasPermission('staff') ? `
                        <div class="action-card" onclick="showSection('controle')" style="background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;" 
                             onmouseenter="this.style.borderColor='var(--warning)'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(255, 170, 0, 0.15)';" 
                             onmouseleave="this.style.borderColor='var(--gray-border)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <div style="font-size: 32px; margin-bottom: 16px;">👥</div>
                            <h3 style="font-size: 18px; font-weight: 600; color: var(--white-soft); margin-bottom: 8px;">Gerenciar Staff</h3>
                            <p style="font-size: 14px; color: var(--gray-light); line-height: 1.5;">Visualize, edite e gerencie membros da equipe, permissões e status de cada membro.</p>
                        </div>
                        ` : ''}
                        ${hasPermission('warning.create') || hasPermission('moderation') ? `
                        <div class="action-card" onclick="showSection('advertencias')" style="background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;" 
                             onmouseenter="this.style.borderColor='var(--warning)'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(255, 170, 0, 0.15)';" 
                             onmouseleave="this.style.borderColor='var(--gray-border)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <div style="font-size: 32px; margin-bottom: 16px;">⚠️</div>
                            <h3 style="font-size: 18px; font-weight: 600; color: var(--white-soft); margin-bottom: 8px;">Aplicar Advertência</h3>
                            <p style="font-size: 14px; color: var(--gray-light); line-height: 1.5;">Registre advertências e medidas disciplinares aplicadas aos membros da equipe.</p>
                        </div>
                        ` : ''}
                        ${hasPermission('reports') || hasPermission('dashboard') ? `
                        <div class="action-card" onclick="loadReports()" style="background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 12px; padding: 24px; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;" 
                             onmouseenter="this.style.borderColor='var(--warning)'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(255, 170, 0, 0.15)';" 
                             onmouseleave="this.style.borderColor='var(--gray-border)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            <div style="font-size: 32px; margin-bottom: 16px;">📊</div>
                            <h3 style="font-size: 18px; font-weight: 600; color: var(--white-soft); margin-bottom: 8px;">Ver Relatórios</h3>
                            <p style="font-size: 14px; color: var(--gray-light); line-height: 1.5;">Acesse relatórios detalhados de atividades, desempenho e estatísticas do sistema.</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- STATUS DO SISTEMA -->
                <div style="margin-bottom: 48px;">
                    <div style="background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 12px; padding: 24px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--success); box-shadow: 0 0 8px rgba(0, 255, 136, 0.5);"></div>
                            <h3 style="font-size: 18px; font-weight: 600; color: var(--white-soft);">Status do Sistema</h3>
                        </div>
                        <p style="font-size: 15px; color: var(--gray-light); line-height: 1.6; margin: 0;">
                            Nenhuma ação crítica necessária no momento.
                        </p>
                    </div>
                </div>
                
                <!-- ATIVIDADES RECENTES -->
                <div style="margin-bottom: 48px;">
                    <h2 style="font-size: 20px; font-weight: 600; color: var(--white-soft); margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-clock" style="color: var(--gray-text);"></i>
                        Atividades Recentes
                    </h2>
                    ${recentActivities.length > 0 ? `
                    <div style="background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 12px; padding: 20px;">
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            ${recentActivities.map(activity => {
                                const actionIcon = activity.action?.includes('Login') ? '🔐' : 
                                                  activity.action?.includes('Criar') ? '➕' : 
                                                  activity.action?.includes('Editar') ? '✏️' : 
                                                  activity.action?.includes('Excluir') ? '🗑️' : 
                                                  activity.action?.includes('Aprovar') ? '✅' : '📝';
                                const timestamp = activity.timestamp || activity.created_at || new Date().toISOString();
                                const date = new Date(timestamp);
                                const formattedDate = date.toLocaleString('pt-BR', { 
                                    day: '2-digit', 
                                    month: '2-digit', 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                });
                                return `
                                <div style="display: flex; align-items: start; gap: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--gray-border);">
                                    <div style="font-size: 20px; flex-shrink: 0;">${actionIcon}</div>
                                    <div style="flex: 1;">
                                        <p style="color: var(--white-soft); font-size: 14px; margin-bottom: 4px; line-height: 1.5;">
                                            ${activity.action || 'Ação do sistema'}
                                        </p>
                                        <p style="color: var(--gray-text); font-size: 12px;">
                                            ${formattedDate} ${activity.module ? `• ${activity.module}` : ''}
                                        </p>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ` : `
                    <div style="background: var(--gray-dark); border: 1px solid var(--gray-border); border-radius: 12px; padding: 40px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">📋</div>
                        <p style="color: var(--gray-text); font-size: 14px;">
                            Nenhuma atividade recente registrada.
                        </p>
                    </div>
                    `}
                </div>
                
                <!-- IDENTIDADE -->
                <div style="margin-top: 64px; padding-top: 32px; border-top: 1px solid var(--gray-border); text-align: center;">
                    <p style="color: var(--gray-text); font-size: 14px; font-style: italic; line-height: 1.6;">
                        TXD Staff System — Disciplina gera respeito. Organização gera poder.
                    </p>
                </div>
            `;
            document.querySelector('.content-card').innerHTML = content;
        }

        async function loadKanban() {
            // Buscar dados atualizados do Supabase
            await refreshData();
            let kanbanData = await getKanbanData();
            
            // Validações robustas para garantir que os dados estão corretos
            if (!kanbanData) {
                kanbanData = {
                    columns: [],
                    cards: []
                };
            }
            
            // Garantir que cards é um array
            if (!Array.isArray(kanbanData.cards)) {
                kanbanData.cards = [];
            }
            
            // Garantir que columns é um array
            if (!Array.isArray(kanbanData.columns)) {
                kanbanData.columns = [
                    { id: 'todo', name: 'Para Fazer', color: '#6F7276' },
                    { id: 'inprogress', name: 'Em Progresso', color: '#ffaa00' },
                    { id: 'review', name: 'Em Revisão', color: '#3b82f6' },
                    { id: 'done', name: 'Concluído', color: '#00ff88' }
                ];
            }
            
            // Se não há colunas, criar padrão (mas NÃO salvar automaticamente para evitar loop)
            if (kanbanData.columns.length === 0) {
                kanbanData.columns = [
                    { id: 'todo', name: 'Para Fazer', color: '#6F7276' },
                    { id: 'inprogress', name: 'Em Progresso', color: '#ffaa00' },
                    { id: 'review', name: 'Em Revisão', color: '#3b82f6' },
                    { id: 'done', name: 'Concluído', color: '#00ff88' }
                ];
                // Salvar colunas padrão apenas uma vez (sem recarregar)
                await saveData('txd_kanban', kanbanData);
            }
            
            // NÃO chamar saveKanbanData() aqui para evitar loop infinito com real-time
            
            // Permitir acesso básico ao Kanban para todos os usuários logados
            // Se não tiver permissão específica, permitir visualização e criação básica
            const canCreate = hasPermission('task.create') || hasPermission('dashboard') || (currentUser && currentUser.role);
            const canEdit = hasPermission('task.edit') || hasPermission('dashboard') || (currentUser && currentUser.role);
            const canDelete = hasPermission('task.delete') || currentUser?.role === 'Owner' || currentUser?.role === 'CEO';
            
            const content = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h1 id="sectionTitle" style="margin-bottom: 8px;">Tarefas - Kanban</h1>
                        <p style="color: var(--gray-light);">Organize suas tarefas e projetos</p>
                    </div>
                    ${canCreate ? `
                    <button class="btn-modal btn-success" onclick="openNewCard()">
                        <i class="fas fa-plus"></i> Nova Tarefa
                    </button>
                    ` : ''}
                </div>
                
                <!-- Estatísticas Rápidas -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Total de Tarefas</div>
                            <div class="stat-card-icon">📋</div>
                        </div>
                        <div class="stat-card-value">${(kanbanData.cards || []).length}</div>
                        <div class="stat-card-subtitle">Todas as tarefas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Para Fazer</div>
                            <div class="stat-card-icon">📝</div>
                        </div>
                        <div class="stat-card-value">${(kanbanData.cards || []).filter(c => c && c.columnId === 'todo').length}</div>
                        <div class="stat-card-subtitle">Pendentes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Em Progresso</div>
                            <div class="stat-card-icon">⚙️</div>
                        </div>
                        <div class="stat-card-value">${(kanbanData.cards || []).filter(c => c && c.columnId === 'inprogress').length}</div>
                        <div class="stat-card-subtitle">Em andamento</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Concluído</div>
                            <div class="stat-card-icon">✅</div>
                        </div>
                        <div class="stat-card-value">${(kanbanData.cards || []).filter(c => c && c.columnId === 'done').length}</div>
                        <div class="stat-card-subtitle">Finalizadas</div>
                    </div>
                </div>
                
                <!-- Board Kanban -->
                <div id="kanbanBoard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 32px;">
                    ${kanbanData.columns.map(column => `
                        <div class="kanban-column" data-column-id="${column.id}" style="background: var(--gray-dark); border-radius: 12px; padding: 16px; min-height: 500px; border: 1px solid var(--gray-border);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid ${column.color};">
                                <h3 style="color: var(--white-soft); font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 12px; height: 12px; border-radius: 50%; background: ${column.color};"></span>
                                    ${column.name}
                                </h3>
                                <span style="background: ${column.color}20; color: ${column.color}; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                    ${(kanbanData.cards || []).filter(c => c && c.columnId === column.id).length}
                                </span>
                            </div>
                            <div class="kanban-cards" data-column="${column.id}" ondragover="event.preventDefault();" style="min-height: 400px;">
                                ${(kanbanData.cards || []).filter(c => c && c.columnId === column.id).map(card => `
                                    <div class="kanban-card" draggable="true" data-card-id="${card.id}" style="background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: ${canEdit ? 'pointer' : 'default'}; transition: all 0.3s ease; position: relative;" 
                                         onmouseenter="this.style.borderColor='var(--gray-text)'; this.style.transform='translateY(-2px)';" 
                                         onmouseleave="this.style.borderColor='var(--gray-border)'; this.style.transform='translateY(0)';"
                                         ondragstart="handleDragStart(event)" 
                                         ondragend="handleDragEnd(event)"
                                         onclick="${canEdit ? `openEditCard(${card.id})` : ''}">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                            <h4 style="color: var(--white-soft); font-size: 14px; font-weight: 600; margin: 0; flex: 1;">${card.title}</h4>
                                            ${canDelete ? `
                                            <button onclick="event.stopPropagation(); event.preventDefault(); deleteCard(${card.id})" style="background: transparent; border: none; color: var(--gray-text); cursor: pointer; padding: 2px 6px; font-size: 12px; opacity: 0.6; transition: opacity 0.2s;" 
                                                    onmouseenter="this.style.opacity='1'; this.style.color='var(--danger)';" 
                                                    onmouseleave="this.style.opacity='0.6'; this.style.color='var(--gray-text)';" 
                                                    title="Excluir">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                            ` : ''}
                                        </div>
                                        ${card.description ? `
                                        <p style="color: var(--gray-light); font-size: 11px; margin: 6px 0; line-height: 1.4; opacity: 0.8;">${card.description.substring(0, 80)}${card.description.length > 80 ? '...' : ''}</p>
                                        ` : ''}
                                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                                            ${card.priority ? `
                                            <span style="font-size: 9px; padding: 2px 6px; border-radius: 4px; background: ${card.priority === 'high' ? 'rgba(255, 51, 102, 0.2)' : card.priority === 'medium' ? 'rgba(255, 170, 0, 0.2)' : 'rgba(0, 255, 136, 0.2)'}; color: ${card.priority === 'high' ? 'var(--danger)' : card.priority === 'medium' ? 'var(--warning)' : 'var(--success)'};">
                                                ${card.priority === 'high' ? '🔴' : card.priority === 'medium' ? '🟡' : '🟢'}
                                            </span>
                                            ` : ''}
                                            ${card.assignee ? `
                                            <span style="color: var(--gray-text); font-size: 10px; opacity: 0.7;">
                                                👤 ${card.assignee}
                                            </span>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            ${canCreate ? `
                            <button onclick="addCardToColumn('${column.id}')" style="width: 100%; padding: 12px; background: transparent; border: 2px dashed var(--gray-border); border-radius: 8px; color: var(--gray-text); cursor: pointer; margin-top: 12px; transition: all 0.3s ease;"
                                    onmouseenter="this.style.borderColor='var(--gray-text)'; this.style.color='var(--white-soft)';"
                                    onmouseleave="this.style.borderColor='var(--gray-border)'; this.style.color='var(--gray-text)';">
                                <i class="fas fa-plus"></i> Adicionar Card
                            </button>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            document.querySelector('.content-card').innerHTML = content;
            
            // Aguardar um pouco para garantir que o DOM foi renderizado
            setTimeout(() => {
            initializeKanbanDragDrop();
            }, 100);
        }

        async function loadStaffControl() {
            // Garantir que staffData é um array
            if (!Array.isArray(staffData)) staffData = [];
            
            // Forçar refresh das solicitações do Supabase
            console.log('🔄 Forçando refresh das solicitações...');
            const requestsRaw = await getData('txd_registration_requests', true);
            console.log('📥 Dados retornados do getData:', requestsRaw);
            console.log('📥 Tipo:', typeof requestsRaw);
            console.log('📥 É array?', Array.isArray(requestsRaw));
            
            // Buscar solicitações pendentes
            const requests = Array.isArray(requestsRaw) ? requestsRaw : [];
            
            console.log('📊 Total de solicitações carregadas:', requests.length);
            console.log('📊 Todas as solicitações:', requests);
            console.log('💾 Estado do cache:', dataCache['txd_registration_requests']);
            
            // Filtrar por status 'pending' (case-insensitive e verificando diferentes formatos)
            const pendingRequests = requests.filter(r => {
                if (!r) return false;
                const status = String(r.status || '').toLowerCase().trim();
                return status === 'pending';
            });
            
            console.log('Solicitações pendentes encontradas:', pendingRequests.length);
            console.log('Detalhes das pendentes:', pendingRequests);
            
            const canManage = hasPermission('staff.create') || currentUser.role === 'Owner' || currentUser.role === 'CEO' || currentUser.role === 'HeadStaff';
            
            const content = `
                <h1 id="sectionTitle">Controle de Staff</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Gestão de membros da equipe</p>
                
                ${canManage ? `
                <div style="margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn-modal" onclick="openNewStaff()">
                        <i class="fas fa-user-plus"></i> Cadastrar Manualmente
                    </button>
                    <button class="btn-modal ${pendingRequests.length > 0 ? 'btn-warning' : ''}" onclick="showRegistrationRequests()" style="position: relative;">
                        <i class="fas fa-user-clock"></i> Solicitações de Cadastro
                        ${pendingRequests.length > 0 ? `
                        <span style="position: absolute; top: -8px; right: -8px; background: var(--danger); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; box-shadow: 0 2px 8px rgba(255, 51, 102, 0.5);">
                            ${pendingRequests.length}
                        </span>
                        ` : ''}
                    </button>
                </div>
                ` : ''}
                
                <!-- SEÇÃO DE SOLICITAÇÕES PENDENTES - SEMPRE VISÍVEL -->
                ${canManage ? `
                <div style="background: ${pendingRequests.length > 0 ? 'var(--warning)' : 'var(--gray-dark)'}; color: ${pendingRequests.length > 0 ? 'white' : 'var(--gray-light)'}; padding: 20px; border-radius: 12px; margin-bottom: 24px; border: 2px solid ${pendingRequests.length > 0 ? 'var(--warning)' : 'var(--gray-border)'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                        <div style="flex: 1;">
                            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-user-clock" style="font-size: 24px;"></i>
                                Solicitações de Cadastro Pendentes
                            </h3>
                            ${pendingRequests.length > 0 ? `
                            <p style="margin: 0; font-size: 15px; opacity: 0.95;">
                                <strong>${pendingRequests.length}</strong> ${pendingRequests.length === 1 ? 'solicitação aguardando' : 'solicitações aguardando'} sua aprovação
                            </p>
                            ` : `
                            <p style="margin: 0; font-size: 14px; opacity: 0.8;">
                                Nenhuma solicitação pendente no momento
                            </p>
                            `}
                        </div>
                        <button class="btn" onclick="showRegistrationRequests()" style="background: ${pendingRequests.length > 0 ? 'white' : 'var(--gray-medium)'}; color: ${pendingRequests.length > 0 ? 'var(--warning)' : 'var(--gray-light)'}; border: none; padding: 12px 24px; font-weight: 600; white-space: nowrap;">
                            <i class="fas fa-eye"></i> ${pendingRequests.length > 0 ? 'Ver Solicitações' : 'Ver Todas'}
                        </button>
                    </div>
                </div>
                ` : ''}
                
                <div class="table-container" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--gray-dark);">
                                <th style="padding: 12px; text-align: left; color: var(--gray-light); font-size: 13px; font-weight: 600;">Nome</th>
                                <th style="padding: 12px; text-align: left; color: var(--gray-light); font-size: 13px; font-weight: 600;">Cargo</th>
                                <th style="padding: 12px; text-align: left; color: var(--gray-light); font-size: 13px; font-weight: 600;">Área</th>
                                <th style="padding: 12px; text-align: left; color: var(--gray-light); font-size: 13px; font-weight: 600;">Status</th>
                                <th style="padding: 12px; text-align: left; color: var(--gray-light); font-size: 13px; font-weight: 600;">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${staffData.map(member => `
                                <tr style="border-top: 1px solid var(--gray-border);">
                                    <td style="padding: 12px; color: var(--white-soft);">${member.name}</td>
                                    <td style="padding: 12px; color: var(--gray-light);">${member.role}</td>
                                    <td style="padding: 12px; color: var(--gray-light);">${member.area}</td>
                                    <td style="padding: 12px;">
                                        <span class="badge badge-success">${member.status}</span>
                                    </td>
                                    <td style="padding: 12px;">
                                        <div style="display: flex; gap: 8px;">
                                            <button class="btn-modal" style="padding: 6px 12px; font-size: 12px;" onclick="editStaff(${member.id})" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            ${hasPermission('staff.delete') ? `
                                            <button class="btn-modal btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteStaff(${member.id})" title="Excluir">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            ` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.querySelector('.content-card').innerHTML = content;
        }
        
        // ========== GERENCIAMENTO DE SOLICITAÇÕES DE CADASTRO ==========
        
        async function showRegistrationRequests() {
            console.log('🔍 Buscando solicitações de registro...');
            
            // Verificar se Supabase está inicializado
            if (!supabaseClient) {
                alert('❌ Erro: Sistema não está conectado ao banco de dados. Recarregue a página.');
                return;
            }
            
            // Buscar diretamente do Supabase
            try {
                const { data: directData, error: directError } = await supabaseClient
                    .from('registration_requests')
                    .select('*')
                    .order('requested_at', { ascending: false });
                
                if (directError) {
                    console.error('❌ Erro ao buscar do Supabase:', directError);
                    if (directError.code === 'PGRST116' || directError.message?.includes('does not exist')) {
                        alert('❌ Tabela registration_requests não existe no Supabase.\n\nExecute o SQL de criação da tabela no Supabase SQL Editor.');
                        return;
                    }
                }
                
                console.log('📊 Dados diretos do Supabase:', directData);
                
                // Forçar refresh antes de exibir
                console.log('🔄 Forçando refresh antes de exibir...');
                const requestsRaw = await getData('txd_registration_requests', true);
                console.log('📥 Dados retornados do getData:', requestsRaw);
                console.log('📥 Tipo:', typeof requestsRaw);
                console.log('📥 É array?', Array.isArray(requestsRaw));
                
                const requests = Array.isArray(requestsRaw) ? requestsRaw : [];
                
                console.log('📋 Total de solicitações no cache:', requests.length);
                console.log('📋 Todas as solicitações:', requests);
                console.log('💾 Estado do cache:', dataCache['txd_registration_requests']);
                
                // Filtrar por status 'pending' (case-insensitive e verificando diferentes formatos)
                const pendingRequests = requests.filter(r => {
                    if (!r) {
                        console.warn('⚠️ Solicitação nula encontrada');
                        return false;
                    }
                    const status = String(r.status || '').toLowerCase().trim();
                    const isPending = status === 'pending';
                    
                    if (!isPending) {
                        console.log(`⏭️ Solicitação ${r.id} ignorada - status: "${status}"`);
                    }
                    
                    return isPending;
                });
                
                console.log('✅ Solicitações pendentes encontradas:', pendingRequests.length);
                console.log('📝 Detalhes das pendentes:', pendingRequests);
                console.log('📊 Total de solicitações antes do filtro:', requests.length);
                console.log('📊 Status de todas as solicitações:', requests.map(r => ({ id: r.id, status: r.status })));
                
                // Sempre mostrar a tela, mesmo se não houver solicitações pendentes
                const content = pendingRequests.length === 0 ? `
                <div style="margin-bottom: 24px;">
                    <button class="btn btn-secondary" onclick="loadStaffControl()">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                </div>
                
                <h2 style="color: var(--white-soft); margin-bottom: 24px;">
                    <i class="fas fa-user-clock"></i> Solicitações de Cadastro Pendentes
                </h2>
                
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 60px 40px; text-align: center; border: 1px solid var(--gray-border);">
                    <div style="font-size: 64px; margin-bottom: 24px; opacity: 0.3;">📋</div>
                    <h3 style="color: var(--white-soft); font-size: 20px; margin-bottom: 12px;">Nenhuma solicitação pendente</h3>
                    <p style="color: var(--gray-text); font-size: 14px; line-height: 1.6;">
                        Todas as solicitações de cadastro foram processadas.<br>
                        Novas solicitações aparecerão aqui automaticamente.
                    </p>
                </div>
            ` : `
                <div style="margin-bottom: 24px;">
                    <button class="btn btn-secondary" onclick="loadStaffControl()">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                </div>
                
                <h2 style="color: var(--white-soft); margin-bottom: 24px;">
                    <i class="fas fa-user-clock"></i> Solicitações de Cadastro Pendentes
                </h2>
                
                <div style="display: grid; gap: 16px;">
                    ${pendingRequests.map(request => {
                        const requestDate = new Date(request.requestedAt).toLocaleString('pt-BR');
                        return `
                            <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                                    <div>
                                        <h3 style="color: var(--white-soft); font-size: 18px; margin-bottom: 4px;">
                                            ${request.displayName || request.username}
                                        </h3>
                                        <p style="color: var(--gray-light); font-size: 14px;">
                                            <i class="fas fa-user"></i> ${request.username}
                                        </p>
                                        <p style="color: var(--gray-text); font-size: 12px; margin-top: 4px;">
                                            <i class="fas fa-calendar"></i> Solicitado em ${requestDate}
                                        </p>
                                    </div>
                                    <span style="background: var(--warning); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                        Pendente
                                    </span>
                                </div>
                                
                                <div style="display: flex; gap: 12px; margin-top: 16px;">
                                    <button class="btn btn-success" onclick="approveRegistration(${request.id})" style="flex: 1;">
                                        <i class="fas fa-check"></i> Aprovar
                                    </button>
                                    <button class="btn btn-danger" onclick="rejectRegistration(${request.id})" style="flex: 1;">
                                        <i class="fas fa-times"></i> Rejeitar
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
                
                document.querySelector('.content-card').innerHTML = content;
            } catch (error) {
                console.error('❌ Erro ao buscar solicitações:', error);
                alert(`Erro ao carregar solicitações: ${error.message || 'Erro desconhecido'}`);
            }
        }
        
        async function approveRegistration(requestId) {
            const role = prompt('Digite o cargo para o novo membro:\n\nOpções: Owner, CEO, COO, CMO, CCO, CIO, HeadStaff, Diretor, Coordenador, Admin, Moderador, Suporte, Helper, Dev\n\nOu deixe em branco para usar "Helper" como padrão:');
            
            if (role === null) return; // Usuário cancelou
            
            const validRoles = ['Owner', 'CEO', 'COO', 'CMO', 'CCO', 'CIO', 'HeadStaff', 'Diretor', 'Coordenador', 'Admin', 'Moderador', 'Suporte', 'Helper', 'Dev'];
            const selectedRole = role.trim() || 'Helper';
            
            if (role.trim() && !validRoles.includes(selectedRole)) {
                alert('Cargo inválido. Usando "Helper" como padrão.');
            }
            
            try {
                const requestsRaw = getData('txd_registration_requests');
                const requests = Array.isArray(requestsRaw) ? requestsRaw : [];
                const request = requests.find(r => r && r.id === requestId);
                
                if (!request) {
                    alert('Solicitação não encontrada.');
                    return;
                }
                
                // Atualizar status da solicitação
                request.status = 'approved';
                request.approvedBy = currentUser.name || currentUser.displayName;
                request.approvedAt = new Date().toISOString();
                request.role = selectedRole;
                
                await saveData('txd_registration_requests', requests);
                
                // Criar usuário no staff
                const newStaff = {
                    id: Date.now(),
                    name: request.displayName || request.username,
                    displayName: request.displayName || request.username,
                    login: request.username, // Login é o username
                    role: selectedRole,
                    email: request.email || null,
                    status: 'Ativo',
                    password: request.password, // Em produção, deve ser criptografado
                    area: request.area || '',
                    gameId: request.gameId || null,
                    discordId: request.discordId || null,
                    createdAt: new Date().toISOString(),
                    approvedBy: currentUser.name || currentUser.displayName
                };
                
                const staffData = getData('txd_staff') || [];
                staffData.push(newStaff);
                await saveData('txd_staff', staffData);
                
                // Notificar Discord
                sendDiscordNotification('staff', '✅ Cadastro Aprovado', 
                    `Solicitação de cadastro aprovada`,
                    [
                        { name: '👤 Usuário', value: request.username, inline: true },
                        { name: '📛 Nome', value: request.displayName, inline: true },
                        { name: '🎖️ Cargo', value: selectedRole, inline: true },
                        { name: '✅ Aprovado por', value: currentUser.name || currentUser.displayName, inline: false }
                    ]
                );
                
                // Log da ação
                logSystemAction('Cadastro aprovado', 'Staff', {
                    username: request.username,
                    role: selectedRole,
                    approvedBy: currentUser.name
                });
                
                alert(`✅ Cadastro aprovado com sucesso!\n\nUsuário: ${request.username}\nCargo: ${selectedRole}\n\nO usuário já pode fazer login no sistema.`);
                
                // Recarregar interface
                loadStaffControl();
                
            } catch (error) {
                console.error('Erro ao aprovar cadastro:', error);
                alert('Erro ao aprovar cadastro. Tente novamente.');
            }
        }
        
        async function rejectRegistration(requestId) {
            const reason = prompt('Digite o motivo da rejeição (opcional):');
            
            try {
                const requestsRaw = getData('txd_registration_requests');
                const requests = Array.isArray(requestsRaw) ? requestsRaw : [];
                const request = requests.find(r => r && r.id === requestId);
                
                if (!request) {
                    alert('Solicitação não encontrada.');
                    return;
                }
                
                // Atualizar status da solicitação
                request.status = 'rejected';
                request.approvedBy = currentUser.name || currentUser.displayName;
                request.approvedAt = new Date().toISOString();
                request.rejectionReason = reason || 'Não especificado';
                
                await saveData('txd_registration_requests', requests);
                
                // Notificar Discord
                sendDiscordNotification('staff', '❌ Cadastro Rejeitado', 
                    `Solicitação de cadastro rejeitada`,
                    [
                        { name: '👤 Usuário', value: request.username, inline: true },
                        { name: '📛 Nome', value: request.displayName, inline: true },
                        { name: '❌ Rejeitado por', value: currentUser.name || currentUser.displayName, inline: true },
                        { name: '📝 Motivo', value: reason || 'Não especificado', inline: false }
                    ]
                );
                
                // Log da ação
                logSystemAction('Cadastro rejeitado', 'Staff', {
                    username: request.username,
                    reason: reason || 'Não especificado',
                    rejectedBy: currentUser.name
                });
                
                alert(`❌ Cadastro rejeitado.\n\nUsuário: ${request.username}`);
                
                // Recarregar interface
                loadStaffControl();
                
            } catch (error) {
                console.error('Erro ao rejeitar cadastro:', error);
                alert('Erro ao rejeitar cadastro. Tente novamente.');
            }
        }

        // ========== SISTEMA DE COMANDOS ==========
        let commandsData = dataCache['txd_commands'] || [];
        let favoriteCommands = dataCache['txd_favorite_commands'] || [];
        let commandUsageStats = dataCache['txd_command_usage'] || {};
        let activeCommandFilter = 'todos';
        let commandSearchQuery = '';

        // Inicializar comandos de exemplo (apenas na primeira vez)
        if (commandsData.length === 0) {
            commandsData = [
                {
                    id: 1,
                    name: '/ban',
                    category: 'admin',
                    description: 'Banir um jogador permanentemente ou temporariamente do servidor',
                    syntax: '/ban [id] [motivo] [tempo]',
                    example: '/ban 123 Anti-RP 7d',
                    permission: 'admin.ban',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 2,
                    name: '/kick',
                    category: 'moderacao',
                    description: 'Expulsar um jogador do servidor',
                    syntax: '/kick [id] [motivo]',
                    example: '/kick 123 Comportamento inadequado',
                    permission: 'moderator.kick',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 3,
                    name: '/warn',
                    category: 'moderacao',
                    description: 'Advertir um jogador por quebra de regras',
                    syntax: '/warn [id] [motivo]',
                    example: '/warn 123 DM excessivo',
                    permission: 'moderator.warn',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 4,
                    name: '/tp',
                    category: 'admin',
                    description: 'Teleportar para um jogador ou localização',
                    syntax: '/tp [destino]',
                    example: '/tp 123 ou /tp casa',
                    permission: 'admin.teleport',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 5,
                    name: '/revive',
                    category: 'admin',
                    description: 'Reviver um jogador',
                    syntax: '/revive [id]',
                    example: '/revive 123',
                    permission: 'admin.revive',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 6,
                    name: '/car',
                    category: 'admin',
                    description: 'Spawnar um veículo',
                    syntax: '/car [modelo]',
                    example: '/car adder',
                    permission: 'admin.vehicle',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 7,
                    name: '/give',
                    category: 'admin',
                    description: 'Dar um item para um jogador',
                    syntax: '/give [id] [item] [quantidade]',
                    example: '/give 123 dinheiro 10000',
                    permission: 'admin.give',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 8,
                    name: '/freeze',
                    category: 'moderacao',
                    description: 'Congelar um jogador',
                    syntax: '/freeze [id]',
                    example: '/freeze 123',
                    permission: 'moderator.freeze',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 9,
                    name: '/unfreeze',
                    category: 'moderacao',
                    description: 'Descongelar um jogador',
                    syntax: '/unfreeze [id]',
                    example: '/unfreeze 123',
                    permission: 'moderator.freeze',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 10,
                    name: '/anuncio',
                    category: 'utilidade',
                    description: 'Enviar um anúncio para todos os jogadores',
                    syntax: '/anuncio [mensagem]',
                    example: '/anuncio Evento começando em 10 minutos!',
                    permission: 'staff.announce',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 11,
                    name: '/limpar',
                    category: 'utilidade',
                    description: 'Limpar o chat',
                    syntax: '/limpar',
                    example: '/limpar',
                    permission: 'staff.clear',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 12,
                    name: '/me',
                    category: 'jogador',
                    description: 'Ação em terceira pessoa (roleplay)',
                    syntax: '/me [ação]',
                    example: '/me acende um cigarro',
                    permission: 'player.basic',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 13,
                    name: '/do',
                    category: 'jogador',
                    description: 'Descrever ambiente/situação (roleplay)',
                    syntax: '/do [descrição]',
                    example: '/do O cigarro está aceso',
                    permission: 'player.basic',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 14,
                    name: '/id',
                    category: 'jogador',
                    description: 'Ver seu ID ou de outro jogador',
                    syntax: '/id [jogador]',
                    example: '/id ou /id João',
                    permission: 'player.basic',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 15,
                    name: '/admins',
                    category: 'jogador',
                    description: 'Ver lista de admins online',
                    syntax: '/admins',
                    example: '/admins',
                    permission: 'player.basic',
                    createdAt: new Date().toISOString()
                }
            ];
            saveData('txd_commands', commandsData);
        }

        function loadCommands() {
            // Garantir que as variáveis são arrays
            if (!Array.isArray(commandsData)) commandsData = [];
            if (!Array.isArray(favoriteCommands)) favoriteCommands = [];
            
            const canCreate = hasPermission('system.config');
            
            const filteredCommands = getFilteredCommands();
            
            const categories = [
                { id: 'todos', name: 'Todos', icon: '📋', count: commandsData.length },
                { id: 'admin', name: 'Admin', icon: '👑', count: commandsData.filter(c => c.category === 'admin').length },
                { id: 'moderacao', name: 'Moderação', icon: '🛡️', count: commandsData.filter(c => c.category === 'moderacao').length },
                { id: 'utilidade', name: 'Utilidade', icon: '🔧', count: commandsData.filter(c => c.category === 'utilidade').length },
                { id: 'jogador', name: 'Jogador', icon: '👤', count: commandsData.filter(c => c.category === 'jogador').length },
                { id: 'favoritos', name: 'Favoritos', icon: '⭐', count: favoriteCommands.length }
            ];
            
            const content = `
                <h1 id="sectionTitle">🎮 Comandos do Sistema</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Gestão de comandos do servidor</p>
                
                <!-- Header com busca e botão adicionar -->
                <div class="commands-header">
                    <div class="commands-search-bar">
                        <input type="text" 
                            class="command-search-input" 
                            id="commandSearchInput"
                            placeholder="🔍 Buscar comandos..."
                            value="${commandSearchQuery}"
                            oninput="handleCommandSearch(event)">
                    </div>
                    ${canCreate ? `
                        <button class="btn btn-primary" onclick="openNewCommandModal()">
                            <i class="fas fa-plus"></i> Novo Comando
                        </button>
                    ` : ''}
                </div>
                
                <!-- Filtros por categoria -->
                <div class="commands-filters">
                    ${categories.map(cat => `
                        <div class="filter-chip ${activeCommandFilter === cat.id ? 'active' : ''}" 
                            onclick="filterCommands('${cat.id}')">
                            <span>${cat.icon}</span>
                            <span>${cat.name}</span>
                            <span style="opacity: 0.7;">(${cat.count})</span>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Grid de comandos -->
                ${filteredCommands.length > 0 ? `
                    <div class="commands-grid">
                        ${filteredCommands.map(cmd => renderCommandCard(cmd)).join('')}
                    </div>
                ` : `
                    <div class="commands-empty">
                        <i class="fas fa-terminal"></i>
                        <p>Nenhum comando encontrado</p>
                        <p style="font-size: 14px; margin-top: 8px;">
                            ${commandSearchQuery ? 'Tente uma busca diferente' : 'Nenhum comando nesta categoria'}
                        </p>
                    </div>
                `}
            `;
            
            document.querySelector('.content-card').innerHTML = content;
        }

        function renderCommandCard(cmd) {
            const isFavorite = favoriteCommands.includes(cmd.id);
            const usageCount = commandUsageStats[cmd.id] || 0;
            const canEdit = hasPermission('system.config');
            
            const categoryClass = `category-${cmd.category}`;
            const categoryNames = {
                'admin': 'Admin',
                'moderacao': 'Moderação',
                'utilidade': 'Utilidade',
                'jogador': 'Jogador'
            };
            
            return `
                <div class="command-card" data-command-id="${cmd.id}">
                    <div class="command-card-header">
                        <div class="command-name">
                            <i class="fas fa-terminal"></i>
                            ${cmd.name}
                        </div>
                        <span class="command-category-badge ${categoryClass}">
                            ${categoryNames[cmd.category]}
                        </span>
                    </div>
                    
                    <div class="command-description">${cmd.description}</div>
                    
                    <div class="command-permission">
                        <i class="fas fa-lock"></i>
                        ${cmd.permission}
                    </div>
                    
                    <div class="command-syntax">
                        <div class="command-syntax-label">Sintaxe:</div>
                        ${cmd.syntax}
                    </div>
                    
                    ${cmd.example ? `
                        <div class="command-syntax">
                            <div class="command-syntax-label">Exemplo:</div>
                            <div class="command-example">${cmd.example}</div>
                        </div>
                    ` : ''}
                    
                    <div class="command-actions">
                        <button class="command-action-btn" onclick="copyCommand('${cmd.name}')" title="Copiar comando">
                            <i class="fas fa-copy"></i>
                            Copiar
                        </button>
                        <button class="command-action-btn favorite ${isFavorite ? 'active' : ''}" 
                            onclick="toggleFavoriteCommand(${cmd.id})" 
                            title="${isFavorite ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}">
                            <i class="fas fa-star"></i>
                            ${isFavorite ? 'Favoritado' : 'Favoritar'}
                        </button>
                        ${canEdit ? `
                            <button class="command-action-btn" onclick="editCommand(${cmd.id})" title="Editar comando">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="command-action-btn" onclick="deleteCommand(${cmd.id})" title="Deletar comando">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                    
                    <div class="command-stats">
                        <div class="command-stat">
                            <i class="fas fa-chart-line"></i>
                            <span>${usageCount} uso${usageCount !== 1 ? 's' : ''}</span>
                        </div>
                        <div class="command-stat">
                            <i class="fas fa-clock"></i>
                            <span>${new Date(cmd.createdAt).toLocaleDateString('pt-BR')}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function getFilteredCommands() {
            // Garantir que commandsData é um array
            if (!Array.isArray(commandsData)) commandsData = [];
            if (!Array.isArray(favoriteCommands)) favoriteCommands = [];
            
            let filtered = commandsData;
            
            // Filtrar por categoria
            if (activeCommandFilter === 'favoritos') {
                filtered = filtered.filter(cmd => favoriteCommands.includes(cmd.id));
            } else if (activeCommandFilter !== 'todos') {
                filtered = filtered.filter(cmd => cmd.category === activeCommandFilter);
            }
            
            // Filtrar por busca
            if (commandSearchQuery) {
                const query = commandSearchQuery.toLowerCase();
                filtered = filtered.filter(cmd => 
                    cmd.name.toLowerCase().includes(query) ||
                    cmd.description.toLowerCase().includes(query) ||
                    cmd.syntax.toLowerCase().includes(query) ||
                    cmd.permission.toLowerCase().includes(query)
                );
            }
            
            return filtered;
        }

        function filterCommands(category) {
            activeCommandFilter = category;
            loadCommands();
        }

        function handleCommandSearch(event) {
            commandSearchQuery = event.target.value;
            loadCommands();
        }

        function copyCommand(commandName) {
            navigator.clipboard.writeText(commandName).then(() => {
                // Mostrar feedback visual
                const tempDiv = document.createElement('div');
                tempDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: var(--success);
                    color: var(--black-deep);
                    padding: 12px 20px;
                    border-radius: 8px;
                    font-weight: 600;
                    z-index: 10000;
                    animation: slideInRight 0.3s ease-out;
                `;
                tempDiv.textContent = `✓ ${commandName} copiado!`;
                document.body.appendChild(tempDiv);
                
                setTimeout(() => {
                    tempDiv.style.animation = 'slideOutRight 0.3s ease-out';
                    setTimeout(() => tempDiv.remove(), 300);
                }, 2000);
                
                // Registrar uso
                if (Array.isArray(commandsData)) {
                    const command = commandsData.find(c => c.name === commandName);
                    if (command) {
                        commandUsageStats[command.id] = (commandUsageStats[command.id] || 0) + 1;
                    }
                }
                saveData('txd_command_usage', commandUsageStats);
            });
        }

        function toggleFavoriteCommand(commandId) {
            // Garantir que favoriteCommands é um array
            if (!Array.isArray(favoriteCommands)) favoriteCommands = [];
            
            const index = favoriteCommands.indexOf(commandId);
            if (index > -1) {
                favoriteCommands.splice(index, 1);
            } else {
                favoriteCommands.push(commandId);
            }
            saveData('txd_favorite_commands', favoriteCommands);
            loadCommands();
        }

        function openNewCommandModal() {
            document.getElementById('commandModalTitle').textContent = 'Novo Comando';
            document.getElementById('commandForm').reset();
            document.getElementById('commandId').value = '';
            document.getElementById('commandModal').classList.add('active');
        }

        function editCommand(commandId) {
            // Garantir que commandsData é um array
            if (!Array.isArray(commandsData)) commandsData = [];
            
            const command = commandsData.find(c => c.id === commandId);
            if (!command) return;
            
            document.getElementById('commandModalTitle').textContent = 'Editar Comando';
            document.getElementById('commandId').value = command.id;
            document.getElementById('commandName').value = command.name;
            document.getElementById('commandCategory').value = command.category;
            document.getElementById('commandDescription').value = command.description;
            document.getElementById('commandSyntax').value = command.syntax;
            document.getElementById('commandExample').value = command.example || '';
            document.getElementById('commandPermission').value = command.permission;
            
            document.getElementById('commandModal').classList.add('active');
        }

        function saveCommand(event) {
            event.preventDefault();
            
            // Garantir que commandsData é um array
            if (!Array.isArray(commandsData)) commandsData = [];
            
            const commandId = document.getElementById('commandId').value;
            const isEdit = commandId !== '';
            
            const commandData = {
                id: isEdit ? parseInt(commandId) : Date.now(),
                name: document.getElementById('commandName').value,
                category: document.getElementById('commandCategory').value,
                description: document.getElementById('commandDescription').value,
                syntax: document.getElementById('commandSyntax').value,
                example: document.getElementById('commandExample').value,
                permission: document.getElementById('commandPermission').value,
                createdAt: isEdit ? (commandsData.find(c => c.id == commandId)?.createdAt || new Date().toISOString()) : new Date().toISOString()
            };
            
            if (isEdit) {
                const index = commandsData.findIndex(c => c.id == commandId);
                commandsData[index] = commandData;
                
                // Notificar Discord sobre edição de comando
                sendDiscordNotification('staff', '✏️ Comando Editado', 
                    `${currentUser.name} editou um comando`,
                    [
                        { name: '⚡ Comando', value: commandData.name, inline: true },
                        { name: '📂 Categoria', value: commandData.category, inline: true },
                        { name: '📝 Descrição', value: commandData.description, inline: false },
                        { name: '💻 Sintaxe', value: `\`${commandData.syntax}\``, inline: false },
                        { name: '🔒 Permissão', value: commandData.permission, inline: true },
                        { name: '👨‍💼 Editado por', value: currentUser.name, inline: true }
                    ]
                );
            } else {
                commandsData.push(commandData);
                
                // Notificar Discord sobre novo comando
                sendDiscordNotification('staff', '✨ Novo Comando Adicionado', 
                    `${currentUser.name} adicionou um novo comando`,
                    [
                        { name: '⚡ Comando', value: commandData.name, inline: true },
                        { name: '📂 Categoria', value: commandData.category, inline: true },
                        { name: '📝 Descrição', value: commandData.description, inline: false },
                        { name: '💻 Sintaxe', value: `\`${commandData.syntax}\``, inline: false },
                        { name: '💡 Exemplo', value: `\`${commandData.example}\``, inline: false },
                        { name: '🔒 Permissão', value: commandData.permission, inline: true },
                        { name: '👨‍💼 Criado por', value: currentUser.name, inline: true }
                    ]
                );
            }
            
            saveData('txd_commands', commandsData);
            closeModal('commandModal');
            loadCommands();
            
            alert(isEdit ? 'Comando atualizado com sucesso!' : 'Comando adicionado com sucesso!');
        }

        function deleteCommand(commandId) {
            if (!confirm('Tem certeza que deseja deletar este comando?')) return;
            
            // Garantir que as variáveis são arrays
            if (!Array.isArray(commandsData)) commandsData = [];
            if (!Array.isArray(favoriteCommands)) favoriteCommands = [];
            
            // Buscar dados do comando antes de deletar
            const deletedCommand = commandsData.find(c => c.id === commandId);
            
            commandsData = commandsData.filter(c => c.id !== commandId);
            favoriteCommands = favoriteCommands.filter(id => id !== commandId);
            
            saveData('txd_commands', commandsData);
            saveData('txd_favorite_commands', favoriteCommands);
            
            // Notificar Discord sobre exclusão de comando
            if (deletedCommand) {
                sendDiscordNotification('staff', '❌ Comando Excluído', 
                    `${currentUser.name} excluiu um comando`,
                    [
                        { name: '⚡ Comando', value: deletedCommand.name, inline: true },
                        { name: '📂 Categoria', value: deletedCommand.category, inline: true },
                        { name: '📝 Descrição', value: deletedCommand.description, inline: false },
                        { name: '👨‍💼 Excluído por', value: currentUser.name, inline: true },
                        { name: '🕐 Horário', value: new Date().toLocaleString('pt-BR'), inline: true }
                    ]
                );
            }
            
            loadCommands();
            alert('Comando deletado com sucesso!');
        }

        function loadAgenda() {
            // Garantir que eventsData é um array
            if (!Array.isArray(eventsData)) eventsData = [];
            
            const canCreate = hasPermission('event.create');
            const canEdit = hasPermission('event.edit');
            const canDelete = hasPermission('event.delete');
            
            const content = `
                <h1 id="sectionTitle">Agenda da Equipe</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Eventos e reuniões</p>
                ${canCreate ? `
                <div style="margin-bottom: 20px;">
                    <button class="btn-modal btn-success" onclick="openNewEvent()">
                        <i class="fas fa-calendar-plus"></i> Novo Evento
                    </button>
                </div>
                ` : ''}
                ${eventsData.length === 0 ? `
                <p style="color: var(--gray-text);">Nenhum evento agendado.</p>
                ` : `
                <div style="display: grid; gap: 16px;">
                    ${eventsData.map(event => `
                        <div style="padding: 20px; background: var(--gray-dark); border-radius: 12px; border: 1px solid var(--gray-border);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div>
                                    <h3 style="color: var(--white-soft); margin-bottom: 8px;">${event.title}</h3>
                                    <div style="display: flex; gap: 16px; font-size: 14px; color: var(--gray-light);">
                                        <span><i class="fas fa-calendar"></i> ${new Date(event.datetime).toLocaleString('pt-BR')}</span>
                                        <span><i class="fas fa-tag"></i> ${event.type}</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    ${canEdit ? `
                                    <button class="btn-modal" style="padding: 6px 12px; font-size: 12px;" onclick="openEditEvent(${event.id})" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    ` : ''}
                                    ${canDelete ? `
                                    <button class="btn-modal btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteEvent(${event.id})" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                            ${event.description ? `<p style="color: var(--gray-light); margin-top: 12px;">${event.description}</p>` : ''}
                        </div>
                    `).join('')}
                </div>
                `}
            `;
            document.querySelector('.content-card').innerHTML = content;
        }

        function loadForms() {
            const content = `
                <h1 id="sectionTitle">Formulários Recebidos</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Formulários pendentes de análise</p>
                <p style="color: var(--gray-text);">Nenhum formulário pendente.</p>
            `;
            document.querySelector('.content-card').innerHTML = content;
        }

        function loadReports() {
            const content = `
                <h1 id="sectionTitle">Relatórios de Reunião</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Histórico de relatórios</p>
                <p style="color: var(--gray-text);">Nenhum relatório disponível.</p>
            `;
            document.querySelector('.content-card').innerHTML = content;
        }

        function loadWarnings() {
            const content = `
                <h1 id="sectionTitle">Gestão de Advertências</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Sistema de advertências</p>
                <p style="color: var(--gray-text);">Funcionalidade em desenvolvimento...</p>
            `;
            document.querySelector('.content-card').innerHTML = content;
        }

        async function loadAreas() {
            // Forçar refresh dos dados do Supabase antes de renderizar
            const areasHtml = await renderAreas(true);
            
            const content = `
                <h1 id="sectionTitle">Áreas de Responsabilidade</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Gestão de áreas e responsáveis</p>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <p style="color: var(--gray-text); font-size: 14px;">
                            Organize a equipe por áreas de atuação e defina líderes e equipes
                        </p>
                    </div>
                    ${hasPermission('staff.manage_roles') ? `
                    <button class="btn-modal" onclick="openAreaModal()">
                        <i class="fas fa-plus"></i> Adicionar Área
                    </button>
                    ` : ''}
                </div>
                
                <div id="areasContainer" style="display: grid; gap: 20px;">
                    ${areasHtml}
                </div>
            `;
            document.querySelector('.content-card').innerHTML = content;
        }
        
        async function renderAreas(forceRefresh = false) {
            const areas = await getAreasData(forceRefresh);
            // Garantir que areas é um array antes de usar map
            if (!Array.isArray(areas)) {
                console.error('getAreasData() não retornou um array:', areas);
                return '<p style="color: var(--gray-text);">Erro ao carregar áreas. Recarregue a página.</p>';
            }
            return areas.map(area => {
                if (!area || !area.id) return '';
                return `
                <div class="area-card" style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                        <div>
                            <h3 style="color: var(--white-soft); font-size: 18px; margin-bottom: 4px;">
                                ${area.icon || '📋'} ${area.name}
                            </h3>
                            ${area.description ? `<p style="color: var(--gray-text); font-size: 13px;">${area.description}</p>` : ''}
                        </div>
                        ${hasPermission('staff.manage_roles') ? `
                        <button class="btn-icon" onclick="editArea('${area.id}')" style="padding: 8px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 6px; color: var(--gray-light); cursor: pointer;">
                            <i class="fas fa-edit"></i>
                        </button>
                        ` : ''}
                    </div>
                    
                    ${area.hasLeader ? `
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i class="fas fa-crown" style="color: var(--warning);"></i>
                            <span style="color: var(--gray-light); font-weight: 600; font-size: 14px;">Líder:</span>
                        </div>
                        <div id="leader-${area.id}" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${area.leader ? `
                                <div class="staff-badge" style="background: var(--black-dark); padding: 8px 12px; border-radius: 6px; display: flex; align-items: center; gap: 8px; border: 1px solid var(--gray-border);">
                                    <span style="color: var(--white-soft); font-size: 13px;">${area.leader}</span>
                                    ${hasPermission('staff.manage_roles') ? `
                                    <button onclick="removeLeader('${area.id}')" style="background: none; border: none; color: var(--danger); cursor: pointer; padding: 0; font-size: 12px;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    ` : ''}
                                </div>
                            ` : `
                                ${hasPermission('staff.manage_roles') ? `
                                <select id="leaderSelect-${area.id}" onchange="assignLeader('${area.id}', this.value)" style="padding: 8px 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 6px; color: var(--white-soft); font-size: 13px; cursor: pointer;">
                                    <option value="">Selecione um líder...</option>
                                    ${getAvailableStaff().map(staff => `
                                        <option value="${staff.name}">${staff.name} (${staff.role})</option>
                                    `).join('')}
                                </select>
                                ` : '<span style="color: var(--gray-text); font-size: 13px;">Nenhum líder atribuído</span>'}
                            `}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i class="fas fa-users" style="color: var(--success);"></i>
                            <span style="color: var(--gray-light); font-weight: 600; font-size: 14px;">Equipe:</span>
                            <span style="color: var(--gray-text); font-size: 12px;">(${area.team.length} membros)</span>
                        </div>
                        <div id="team-${area.id}" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">
                            ${area.team.length > 0 ? area.team.map(member => `
                                <div class="staff-badge" style="background: var(--black-dark); padding: 8px 12px; border-radius: 6px; display: flex; align-items: center; gap: 8px; border: 1px solid var(--gray-border);">
                                    <span style="color: var(--white-soft); font-size: 13px;">${member}</span>
                                    ${hasPermission('staff.manage_roles') ? `
                                    <button onclick="removeTeamMember('${area.id}', '${member}')" style="background: none; border: none; color: var(--danger); cursor: pointer; padding: 0; font-size: 12px;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    ` : ''}
                                </div>
                            `).join('') : `
                                <span style="color: var(--gray-text); font-size: 13px;">Nenhum membro na equipe</span>
                            `}
                        </div>
                        ${hasPermission('staff.manage_roles') ? `
                        <select id="teamSelect-${area.id}" onchange="assignTeamMember('${area.id}', this.value)" style="padding: 8px 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 6px; color: var(--white-soft); font-size: 13px; cursor: pointer; width: 100%; max-width: 300px;">
                            <option value="">Adicionar membro à equipe...</option>
                            ${getAvailableStaffForTeam(area).map(staff => `
                                <option value="${staff.name}">${staff.name} (${staff.role})</option>
                            `).join('')}
                        </select>
                        ` : ''}
                    </div>
                </div>
            `;
            }).filter(html => html !== '').join('');
        }
        
        async function getAreasData(forceRefresh = false) {
            const areasRaw = await getData('txd_areas', forceRefresh);
            // Garantir que areas é sempre um array
            let areas = Array.isArray(areasRaw) ? areasRaw : [];
            
            // Áreas atualizadas conforme solicitado
            const defaultAreas = [
                { id: 'staff', name: 'Responsável Staff', icon: '👥', hasLeader: false, leader: null, team: [], description: 'Gestão geral da equipe' },
                { id: 'marketing', name: 'Marketing', icon: '📢', hasLeader: true, leader: null, team: [], description: 'Marketing e divulgação' },
                { id: 'creator', name: 'Creator', icon: '🎨', hasLeader: true, leader: null, team: [], description: 'Criação de conteúdo' },
                { id: 'eventos', name: 'Eventos', icon: '🎉', hasLeader: true, leader: null, team: [], description: 'Organização de eventos' },
                { id: 'peds', name: 'Peds', icon: '👤', hasLeader: true, leader: null, team: [], description: 'Gestão de PEDs' },
                { id: 'policia', name: 'Polícia', icon: '🚔', hasLeader: true, leader: null, team: [], description: 'Departamento de polícia' },
                { id: 'ilegal', name: 'Ilegal', icon: '⚫', hasLeader: true, leader: null, team: [], description: 'Atividades ilegais' },
                { id: 'mecanica', name: 'Mecânica', icon: '🔧', hasLeader: true, leader: null, team: [], description: 'Oficina mecânica' },
                { id: 'legal', name: 'Legal', icon: '⚖️', hasLeader: true, leader: null, team: [], description: 'Atividades legais' },
                { id: 'hospital', name: 'Hospital', icon: '🏥', hasLeader: true, leader: null, team: [], description: 'Sistema de saúde' },
                { id: 'restaurante', name: 'Restaurante', icon: '🍽️', hasLeader: true, leader: null, team: [], description: 'Restaurantes e bares' },
                { id: 'var', name: 'Var', icon: '🎥', hasLeader: true, leader: null, team: [], description: 'VAR e moderação' }
            ];
            
            // Se não existem áreas, criar padrão (mas não salvar automaticamente)
            if (!Array.isArray(areas) || areas.length === 0) {
                areas = defaultAreas;
                // Não salvar automaticamente aqui - deixar o usuário salvar manualmente se necessário
            } else {
                // Atualizar áreas existentes com novos nomes (mantendo dados existentes)
                const areaMap = {};
                // Garantir que areas é um array antes de usar forEach
                if (Array.isArray(areas)) {
                    areas.forEach(area => {
                        if (area && area.id) {
                            areaMap[area.id] = area;
                        }
                    });
                }
                
                // Atualizar ou adicionar áreas padrão
                defaultAreas.forEach(defaultArea => {
                    if (areaMap[defaultArea.id]) {
                        // Atualizar nome se mudou (mas manter leader e team existentes)
                        areaMap[defaultArea.id].name = defaultArea.name;
                        if (defaultArea.icon) areaMap[defaultArea.id].icon = defaultArea.icon;
                        if (defaultArea.description) areaMap[defaultArea.id].description = defaultArea.description;
                        if (defaultArea.hasLeader !== undefined) areaMap[defaultArea.id].hasLeader = defaultArea.hasLeader;
                    } else {
                        // Adicionar nova área
                        areaMap[defaultArea.id] = defaultArea;
                    }
                });
                
                // Remover áreas que não estão mais na lista padrão (exceto staff)
                const validIds = defaultAreas.map(a => a.id);
                areas = Object.values(areaMap).filter(area => area && (validIds.includes(area.id) || area.id === 'staff'));
                
                // Garantir que todas as áreas padrão existam
                defaultAreas.forEach(defaultArea => {
                    const exists = areas.find(a => a && a.id === defaultArea.id);
                    if (!exists) {
                        areas.push(defaultArea);
                    }
                });
                
                // NÃO salvar automaticamente - apenas retornar os dados atualizados
            }
            
            // Garantir que retorna um array válido
            return Array.isArray(areas) ? areas : defaultAreas;
        }
        
        function getAvailableStaff() {
            // Garantir que staffData é um array
            if (!Array.isArray(staffData)) staffData = [];
            return staffData.filter(s => s.status === 'Ativo');
        }
        
        function getAvailableStaffForTeam(area) {
            // Retornar staff que não está na equipe e não é o líder
            return getAvailableStaff().filter(staff => {
                return staff.name !== area.leader && !area.team.includes(staff.name);
            });
        }
        
        async function assignLeader(areaId, leaderName) {
            if (!leaderName) return;
            
            try {
                const areas = await getAreasData();
                const area = areas.find(a => a.id === areaId);
                
                if (!area) {
                    alert('Área não encontrada.');
                    return;
                }
                
                // Garantir que team é um array
                if (!Array.isArray(area.team)) {
                    area.team = [];
                }
                
                // Se já tinha líder, mover para equipe
                if (area.leader && !area.team.includes(area.leader)) {
                    area.team.push(area.leader);
                }
                
                // Remover da equipe se estiver lá
                area.team = area.team.filter(m => m !== leaderName);
                
                // Atribuir novo líder
                area.leader = leaderName;
                area.hasLeader = true;
                
                // Salvar no Supabase
                await saveData('txd_areas', areas);
                
                // Notificar Discord
                sendDiscordNotification('staff', '👑 Líder Atribuído', 
                    `${currentUser?.name || currentUser?.displayName || 'Sistema'} atribuiu um líder à área ${area.name}`,
                    [
                        { name: '📋 Área', value: area.name, inline: true },
                        { name: '👑 Líder', value: leaderName, inline: true },
                        { name: '👨‍💼 Atribuído por', value: currentUser?.name || currentUser?.displayName || 'Sistema', inline: true }
                    ]
                );
                
                // Aguardar um pouco para garantir que o Supabase processou
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Recarregar áreas com refresh forçado
                await loadAreas();
            } catch (error) {
                console.error('Erro ao atribuir líder:', error);
                alert('Erro ao atribuir líder. Verifique o console para mais detalhes.');
            }
        }
        
        async function removeLeader(areaId) {
            if (!confirm('Deseja remover o líder desta área?')) return;
            
            try {
                const areas = await getAreasData();
                const area = areas.find(a => a.id === areaId);
                
                if (!area || !area.leader) {
                    alert('Área não encontrada ou não possui líder.');
                    return;
                }
                
                const oldLeader = area.leader;
                area.leader = null;
                area.hasLeader = false;
                
                // Salvar no Supabase
                await saveData('txd_areas', areas);
                
                // Notificar Discord
                sendDiscordNotification('staff', '👑 Líder Removido', 
                    `${currentUser?.name || currentUser?.displayName || 'Sistema'} removeu o líder da área ${area.name}`,
                    [
                        { name: '📋 Área', value: area.name, inline: true },
                        { name: '👑 Líder Removido', value: oldLeader, inline: true },
                        { name: '👨‍💼 Removido por', value: currentUser?.name || currentUser?.displayName || 'Sistema', inline: true }
                    ]
                );
                
                // Aguardar um pouco para garantir que o Supabase processou
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Recarregar áreas com refresh forçado
                await loadAreas();
            } catch (error) {
                console.error('Erro ao remover líder:', error);
                alert('Erro ao remover líder. Verifique o console para mais detalhes.');
            }
        }
        
        async function assignTeamMember(areaId, memberName) {
            if (!memberName) return;
            
            try {
                const areas = await getAreasData();
                const area = areas.find(a => a.id === areaId);
                
                if (!area) {
                    alert('Área não encontrada.');
                    return;
                }
                
                // Garantir que team é um array
                if (!Array.isArray(area.team)) {
                    area.team = [];
                }
                
                if (area.team.includes(memberName)) {
                    alert('Este membro já está na equipe!');
                    return;
                }
                
                area.team.push(memberName);
                
                // Salvar no Supabase
                await saveData('txd_areas', areas);
                
                // Notificar Discord
                sendDiscordNotification('staff', '👥 Membro Adicionado à Equipe', 
                    `${currentUser?.name || currentUser?.displayName || 'Sistema'} adicionou um membro à equipe de ${area.name}`,
                    [
                        { name: '📋 Área', value: area.name, inline: true },
                        { name: '👤 Membro', value: memberName, inline: true },
                        { name: '👥 Total na Equipe', value: area.team.length.toString(), inline: true },
                        { name: '👨‍💼 Adicionado por', value: currentUser?.name || currentUser?.displayName || 'Sistema', inline: true }
                    ]
                );
                
                // Aguardar um pouco para garantir que o Supabase processou
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Recarregar áreas com refresh forçado
                await loadAreas();
            } catch (error) {
                console.error('Erro ao adicionar membro à equipe:', error);
                alert('Erro ao adicionar membro. Verifique o console para mais detalhes.');
            }
        }
        
        async function removeTeamMember(areaId, memberName) {
            if (!confirm(`Deseja remover ${memberName} da equipe?`)) return;
            
            try {
                const areas = await getAreasData();
                const area = areas.find(a => a.id === areaId);
                
                if (!area) {
                    alert('Área não encontrada.');
                    return;
                }
                
                // Garantir que team é um array
                if (!Array.isArray(area.team)) {
                    area.team = [];
                }
                
                area.team = area.team.filter(m => m !== memberName);
                
                // Salvar no Supabase
                await saveData('txd_areas', areas);
                
                // Notificar Discord
                sendDiscordNotification('staff', '👥 Membro Removido da Equipe', 
                    `${currentUser?.name || currentUser?.displayName || 'Sistema'} removeu um membro da equipe de ${area.name}`,
                    [
                        { name: '📋 Área', value: area.name, inline: true },
                        { name: '👤 Membro Removido', value: memberName, inline: true },
                        { name: '👨‍💼 Removido por', value: currentUser?.name || currentUser?.displayName || 'Sistema', inline: true }
                    ]
                );
                
                // Aguardar um pouco para garantir que o Supabase processou
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Recarregar áreas com refresh forçado
                await loadAreas();
            } catch (error) {
                console.error('Erro ao remover membro da equipe:', error);
                alert('Erro ao remover membro. Verifique o console para mais detalhes.');
            }
        }
        
        function openAreaModal() {
            // Modal para adicionar nova área (opcional)
            alert('Funcionalidade de adicionar novas áreas será implementada em breve. Por enquanto, use as áreas padrão.');
        }
        
        async function editArea(areaId) {
            try {
                const areas = await getAreasData();
                const area = areas.find(a => a.id === areaId);
                
                if (!area) {
                    alert('Área não encontrada.');
                    return;
                }
                
                const newDescription = prompt('Editar descrição da área:', area.description || '');
                if (newDescription === null) return;
                
                area.description = newDescription;
                
                // Salvar no Supabase
                await saveData('txd_areas', areas);
                
                // Aguardar um pouco para garantir que o Supabase processou
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Recarregar áreas com refresh forçado
                await loadAreas();
            } catch (error) {
                console.error('Erro ao editar área:', error);
                alert('Erro ao editar área. Verifique o console para mais detalhes.');
            }
        }

        // ========== PERFIL DO USUÁRIO ==========
        
        function loadPerfil() {
            if (!currentUser || !currentUser.id) {
                alert('Erro: Usuário não identificado. Faça login novamente.');
                showSection('inicio');
                return;
            }
            
            // Buscar dados completos do usuário com comparação flexível
            const staffDataRaw = getData('txd_staff');
            const staffDataArray = Array.isArray(staffDataRaw) ? staffDataRaw : [];
            const userData = staffDataArray.find(s => {
                if (!s) return false;
                // Comparar IDs como string e number, ou por login/name
                return String(s.id) === String(currentUser.id) || 
                       s.id === currentUser.id ||
                       (s.login && s.login === currentUser.login) ||
                       (s.name && s.name === currentUser.name);
            }) || currentUser;
            
            const content = `
                <h1 id="sectionTitle">👤 Meu Perfil</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Gerencie suas informações pessoais e credenciais de acesso</p>
                
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border); margin-bottom: 24px;">
                    <div style="display: grid; gap: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 16px; border-bottom: 1px solid var(--gray-border);">
                            <div>
                                <h3 style="color: var(--white-soft); font-size: 20px; margin-bottom: 4px;">
                                    ${userData.displayName || userData.name || 'Usuário'}
                                </h3>
                                <p style="color: var(--gray-light); font-size: 14px;">
                                    <i class="fas fa-user-tag"></i> ${userData.role || 'N/A'}
                                </p>
                            </div>
                            <span class="badge badge-success">${userData.status || 'Ativo'}</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div>
                                <p style="color: var(--gray-text); font-size: 12px; margin-bottom: 4px;">Login</p>
                                <p style="color: var(--white-soft); font-size: 14px; font-weight: 600;">${userData.login || userData.name || 'N/A'}</p>
                            </div>
                            <div>
                                <p style="color: var(--gray-text); font-size: 12px; margin-bottom: 4px;">Email</p>
                                <p style="color: var(--white-soft); font-size: 14px; font-weight: 600;">${userData.email || 'Não informado'}</p>
                            </div>
                            <div>
                                <p style="color: var(--gray-text); font-size: 12px; margin-bottom: 4px;">Área</p>
                                <p style="color: var(--white-soft); font-size: 14px; font-weight: 600;">${userData.area || 'Não definida'}</p>
                            </div>
                            <div>
                                <p style="color: var(--gray-text); font-size: 12px; margin-bottom: 4px;">ID Game</p>
                                <p style="color: var(--white-soft); font-size: 14px; font-weight: 600;">${userData.gameId || 'Não informado'}</p>
                            </div>
                            <div>
                                <p style="color: var(--gray-text); font-size: 12px; margin-bottom: 4px;">ID Discord</p>
                                <p style="color: var(--white-soft); font-size: 14px; font-weight: 600;">${userData.discordId || 'Não informado'}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn-modal" onclick="openProfileModal()">
                        <i class="fas fa-edit"></i> Editar Perfil
                    </button>
                </div>
            `;
            
            document.querySelector('.content-card').innerHTML = content;
        }
        
        function openProfileModal() {
            if (!currentUser || !currentUser.id) {
                alert('Erro: Usuário não identificado.');
                return;
            }
            
            // Buscar dados completos do usuário com comparação flexível
            const staffDataRaw = getData('txd_staff');
            const staffDataArray = Array.isArray(staffDataRaw) ? staffDataRaw : [];
            const userData = staffDataArray.find(s => {
                if (!s) return false;
                // Comparar IDs como string e number, ou por login/name
                return String(s.id) === String(currentUser.id) || 
                       s.id === currentUser.id ||
                       (s.login && s.login === currentUser.login) ||
                       (s.name && s.name === currentUser.name);
            }) || currentUser;
            
            // Preencher formulário
            document.getElementById('profileName').value = userData.displayName || userData.name || '';
            document.getElementById('profileLogin').value = userData.login || userData.name || '';
            document.getElementById('profilePassword').value = userData.password || '';
            document.getElementById('profileGameId').value = userData.gameId || '';
            document.getElementById('profileDiscordId').value = userData.discordId || '';
            document.getElementById('profileArea').value = userData.area || '';
            
            document.getElementById('profileModal').classList.add('active');
        }
        
        async function saveProfile(event) {
            event.preventDefault();
            
            if (!currentUser || !currentUser.id) {
                alert('Erro: Usuário não identificado.');
                return;
            }
            
            const name = document.getElementById('profileName').value.trim();
            const login = document.getElementById('profileLogin').value.trim();
            const password = document.getElementById('profilePassword').value;
            const gameId = document.getElementById('profileGameId').value.trim();
            const discordId = document.getElementById('profileDiscordId').value.trim();
            const area = document.getElementById('profileArea').value;
            
            // Validações
            if (!name || !login) {
                alert('Nome e Login são obrigatórios.');
                return;
            }
            
            if (password && password.length < 4) {
                alert('A senha deve ter pelo menos 4 caracteres.');
                return;
            }
            
            // Verificar se o login já está em uso por outro usuário
            const staffDataRaw = getData('txd_staff');
            const staffDataArray = Array.isArray(staffDataRaw) ? staffDataRaw : [];
            const loginExists = staffDataArray.some(s => s && s.id !== currentUser.id && (s.login === login || s.name === login));
            
            if (loginExists) {
                alert('Este login já está em uso por outro usuário. Escolha outro.');
                return;
            }
            
            try {
                // Buscar usuário com comparação flexível de ID (string ou number)
                let userIndex = staffDataArray.findIndex(s => {
                    if (!s) return false;
                    // Comparar IDs como string e number
                    return String(s.id) === String(currentUser.id) || 
                           s.id === currentUser.id ||
                           (s.login && s.login === currentUser.login) ||
                           (s.name && s.name === currentUser.name);
                });
                
                let userRecord;
                
                if (userIndex === -1) {
                    // Usuário não encontrado - criar novo registro
                    console.log('Usuário não encontrado no array, criando novo registro...');
                    userRecord = {
                        id: currentUser.id || Date.now(),
                        name: name,
                        displayName: name,
                        login: login,
                        password: password || currentUser.password || null,
                        role: currentUser.role || 'Helper',
                        area: area || currentUser.area || null,
                        status: currentUser.status || 'Ativo',
                        email: currentUser.email || null,
                        gameId: gameId || currentUser.gameId || null,
                        discordId: discordId || currentUser.discordId || null,
                        createdAt: currentUser.createdAt || new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    staffDataArray.push(userRecord);
                    userIndex = staffDataArray.length - 1;
                } else {
                    // Atualizar registro existente
                    userRecord = staffDataArray[userIndex];
                }
                
                // Atualizar dados
                userRecord.name = name;
                userRecord.displayName = name;
                userRecord.login = login;
                if (password) {
                    userRecord.password = password;
                }
                userRecord.gameId = gameId || null;
                userRecord.discordId = discordId || null;
                userRecord.area = area || null;
                userRecord.updatedAt = new Date().toISOString();
                
                // Garantir que campos obrigatórios existam
                if (!userRecord.role) userRecord.role = currentUser.role || 'Helper';
                if (!userRecord.status) userRecord.status = currentUser.status || 'Ativo';
                if (!userRecord.id) userRecord.id = currentUser.id || Date.now();
                
                // Garantir que ID seja um número
                userRecord.id = parseInt(userRecord.id) || Date.now();
                
                // Atualizar cache local primeiro
                dataCache['txd_staff'] = staffDataArray;
                
                // Salvar no Supabase
                console.log('Salvando perfil no Supabase...', userRecord);
                const saveResult = await saveData('txd_staff', staffDataArray);
                
                // Verificar se houve erro no saveData
                if (saveResult && saveResult.error) {
                    throw new Error(saveResult.error.message || 'Erro ao salvar no banco de dados');
                }
                
                // Atualizar currentUser
                currentUser.name = name;
                currentUser.displayName = name;
                currentUser.login = login;
                currentUser.gameId = gameId || null;
                currentUser.discordId = discordId || null;
                currentUser.area = area || null;
                
                // Log da ação
                logSystemAction('Perfil atualizado', 'Perfil', {
                    userId: currentUser.id,
                    updatedFields: ['name', 'login', 'gameId', 'discordId', 'area']
                });
                
                alert('✅ Perfil atualizado com sucesso!');
                closeModal('profileModal');
                loadPerfil();
                
            } catch (error) {
                console.error('Erro ao salvar perfil:', error);
                alert(`Erro ao salvar perfil: ${error.message || 'Erro desconhecido'}\n\nTente novamente ou verifique o console para mais detalhes.`);
            }
        }

        // ========== CHAT INTERNO ==========
        let chatMessages = dataCache['txd_chat_messages'] || [];
        let chatGroups = dataCache['txd_chat_groups'] || [];
        let activeChatUser = null;
        let activeChatGroup = null;
        let pendingAttachment = null;
        
        // Inicializar mensagens de exemplo (apenas na primeira vez)
        if ((!Array.isArray(chatMessages) || chatMessages.length === 0) && Array.isArray(staffData) && staffData.length > 1) {
            const exampleMessages = [
                {
                    id: Date.now() - 3600000,
                    senderId: 2,
                    senderName: 'Maria Santos',
                    receiverId: 1,
                    text: 'Olá! Tudo bem? Conseguiu revisar o relatório que enviei?',
                    timestamp: new Date(Date.now() - 3600000).toISOString(),
                    read: true
                },
                {
                    id: Date.now() - 1800000,
                    senderId: 3,
                    senderName: 'Pedro Costa',
                    receiverId: 1,
                    text: 'Bom dia! Precisamos marcar uma reunião para discutir as novas diretrizes.',
                    timestamp: new Date(Date.now() - 1800000).toISOString(),
                    read: false
                }
            ];
            chatMessages = exampleMessages;
            saveData('txd_chat_messages', chatMessages);
        }
        
        // Inicializar grupo de exemplo (apenas na primeira vez)
        if ((!Array.isArray(chatGroups) || chatGroups.length === 0) && Array.isArray(staffData) && staffData.length >= 3) {
            const exampleGroup = {
                id: Date.now(),
                name: 'Equipe de Moderação',
                description: 'Grupo principal da equipe de moderação',
                members: [
                    { id: 1, name: 'João Silva', role: 'Owner' },
                    { id: 2, name: 'Maria Santos', role: 'CEO' },
                    { id: 3, name: 'Pedro Costa', role: 'Head Staff' }
                ],
                createdBy: 1,
                createdAt: new Date(Date.now() - 86400000).toISOString()
            };
            chatGroups = [exampleGroup];
            saveData('txd_chat_groups', chatGroups);
            
            // Adicionar mensagem de exemplo no grupo
            const groupMessage = {
                id: Date.now() - 7200000,
                senderId: 2,
                senderName: 'Maria Santos',
                groupId: exampleGroup.id,
                text: 'Bem-vindos ao grupo! Vamos usar este espaço para coordenar as atividades da equipe.',
                timestamp: new Date(Date.now() - 7200000).toISOString(),
                read: false
            };
            chatMessages.push(groupMessage);
            saveData('txd_chat_messages', chatMessages);
        }

        function loadChat() {
            // Garantir que as variáveis são arrays
            if (!Array.isArray(staffData)) staffData = [];
            if (!Array.isArray(chatMessages)) chatMessages = [];
            if (!Array.isArray(chatGroups)) chatGroups = [];
            
            const chatUsers = staffData.filter(staff => staff.id !== currentUser.id);
            
            const content = `
                <h1 id="sectionTitle">💬 Chat Interno</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Comunicação em tempo real com a equipe</p>
                
                <div class="chat-container">
                    <div class="chat-sidebar">
                        <button class="btn btn-primary" onclick="openCreateGroupModal()" style="width: 100%; margin-bottom: 12px; font-size: 13px;">
                            <i class="fas fa-users"></i> Criar Grupo
                        </button>
                        <div style="margin-bottom: 16px;">
                            <input type="text" id="chatSearch" placeholder="Buscar conversa..." 
                                style="width: 100%; padding: 10px 14px; background: var(--gray-medium); border: 1px solid var(--gray-border); 
                                border-radius: 10px; color: var(--white-soft); font-size: 14px;">
                        </div>
                        <div id="chatUserList">
                            ${chatGroups.map(group => {
                                const unreadCountGroup = getGroupUnreadCount(group.id);
                                const lastMessageGroup = getGroupLastMessage(group.id);
                                return `
                                    <div class="chat-list-item ${activeChatGroup?.id === group.id ? 'active' : ''}" 
                                        onclick="selectChatGroup(${group.id})">
                                        <div class="chat-avatar" style="background: linear-gradient(135deg, var(--success), var(--gray-border));">👥</div>
                                        <div class="chat-info">
                                            <div class="chat-name">
                                                ${group.name}
                                                <span class="group-indicator">GRUPO</span>
                                            </div>
                                            <div class="chat-last-message">${lastMessageGroup || 'Sem mensagens'}</div>
                                        </div>
                                        ${unreadCountGroup > 0 ? `<div class="chat-badge">${unreadCountGroup}</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                            ${chatUsers.map(user => {
                                const unreadCount = getUnreadCount(user.id);
                                const lastMessage = getLastMessage(user.id);
                                return `
                                    <div class="chat-list-item ${activeChatUser?.id === user.id && !activeChatGroup ? 'active' : ''}" 
                                        onclick="selectChatUser(${user.id})">
                                        <div class="chat-avatar">${user.name.charAt(0)}</div>
                                        <div class="chat-info">
                                            <div class="chat-name">${user.name}</div>
                                            <div class="chat-last-message">${lastMessage || 'Sem mensagens'}</div>
                                        </div>
                                        ${unreadCount > 0 ? `<div class="chat-badge">${unreadCount}</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <div class="chat-main">
                        <div id="chatContent">
                            ${activeChatGroup ? renderGroupChatContent(activeChatGroup) : 
                              activeChatUser ? renderChatContent(activeChatUser) : `
                                <div style="display: flex; align-items: center; justify-content: center; height: 100%; 
                                    color: var(--gray-text); flex-direction: column; gap: 12px;">
                                    <i class="fas fa-comments" style="font-size: 48px; opacity: 0.5;"></i>
                                    <p>Selecione uma conversa para começar</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
            
            document.querySelector('.content-card').innerHTML = content;
            
            // Auto-scroll para última mensagem se houver chat ativo
            if (activeChatUser || activeChatGroup) {
                setTimeout(() => {
                    const messagesDiv = document.getElementById('chatMessages');
                    if (messagesDiv) {
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }
                }, 100);
            }
        }

        function renderChatContent(user) {
            const messages = getChatMessages(user.id);
            
            return `
                <div class="chat-header">
                    <div class="chat-avatar">${user.name.charAt(0)}</div>
                    <div class="chat-header-info">
                        <h3>${user.name}</h3>
                        <div class="chat-header-status">● Online</div>
                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    ${messages.length === 0 ? `
                        <div style="text-align: center; color: var(--gray-text); padding: 40px;">
                            <i class="fas fa-comment-dots" style="font-size: 36px; opacity: 0.5; margin-bottom: 12px;"></i>
                            <p>Nenhuma mensagem ainda. Inicie a conversa!</p>
                        </div>
                    ` : messages.map(msg => `
                        <div class="chat-message ${msg.senderId === currentUser.id ? 'sent' : ''}">
                            <div class="chat-message-avatar">${msg.senderName.charAt(0)}</div>
                            <div class="chat-message-content">
                                <div class="chat-message-bubble">
                                    ${msg.text}
                                    ${msg.attachment ? renderAttachment(msg.attachment) : ''}
                                </div>
                                <div class="chat-message-time">${formatChatTime(msg.timestamp)}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                ${renderAttachmentPreview()}
                
                <div class="chat-input-area">
                    <input type="file" id="attachmentInput" accept="image/*,.pdf,.doc,.docx,.txt" style="display: none;" onchange="handleAttachmentSelect(event)">
                    <button class="attachment-btn" onclick="document.getElementById('attachmentInput').click()">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <textarea id="chatInput" class="chat-input" placeholder="Digite sua mensagem..." 
                        rows="1" onkeypress="handleChatKeyPress(event)"></textarea>
                    <button class="chat-send-btn" onclick="sendChatMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            `;
        }

        function renderGroupChatContent(group) {
            const messages = getGroupChatMessages(group.id);
            
            return `
                <div class="chat-header">
                    <div class="chat-avatar" style="background: linear-gradient(135deg, var(--success), var(--gray-border));">👥</div>
                    <div class="chat-header-info">
                        <h3>${group.name}</h3>
                        <div class="chat-header-status">${group.members.length} membros</div>
                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    ${messages.length === 0 ? `
                        <div style="text-align: center; color: var(--gray-text); padding: 40px;">
                            <i class="fas fa-users" style="font-size: 36px; opacity: 0.5; margin-bottom: 12px;"></i>
                            <p>Nenhuma mensagem no grupo ainda. Seja o primeiro!</p>
                        </div>
                    ` : messages.map(msg => `
                        <div class="chat-message ${msg.senderId === currentUser.id ? 'sent' : ''}">
                            <div class="chat-message-avatar">${msg.senderName.charAt(0)}</div>
                            <div class="chat-message-content">
                                ${msg.senderId !== currentUser.id ? `<div style="font-size: 11px; color: var(--gray-text); margin-bottom: 4px; font-weight: 600;">${msg.senderName}</div>` : ''}
                                <div class="chat-message-bubble">
                                    ${msg.text}
                                    ${msg.attachment ? renderAttachment(msg.attachment) : ''}
                                </div>
                                <div class="chat-message-time">${formatChatTime(msg.timestamp)}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                ${renderAttachmentPreview()}
                
                <div class="chat-input-area">
                    <input type="file" id="attachmentInput" accept="image/*,.pdf,.doc,.docx,.txt" style="display: none;" onchange="handleAttachmentSelect(event)">
                    <button class="attachment-btn" onclick="document.getElementById('attachmentInput').click()">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <textarea id="chatInput" class="chat-input" placeholder="Digite sua mensagem..." 
                        rows="1" onkeypress="handleChatKeyPress(event)"></textarea>
                    <button class="chat-send-btn" onclick="sendChatMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            `;
        }

        function renderAttachment(attachment) {
            if (attachment.type === 'image') {
                return `<img src="${attachment.data}" class="chat-attachment-preview" alt="${attachment.name}" onclick="window.open('${attachment.data}', '_blank')">`;
            } else {
                return `
                    <div class="chat-attachment">
                        <div class="attachment-icon">
                            <i class="fas fa-file"></i>
                        </div>
                        <div class="attachment-info">
                            <div class="attachment-name">${attachment.name}</div>
                            <div class="attachment-size">${attachment.size}</div>
                        </div>
                    </div>
                `;
            }
        }

        function renderAttachmentPreview() {
            if (!pendingAttachment) return '';
            
            return `
                <div class="attachment-preview-container">
                    ${pendingAttachment.type === 'image' ? 
                        `<img src="${pendingAttachment.data}" class="attachment-preview-thumb" alt="${pendingAttachment.name}">` :
                        `<div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-file" style="font-size: 24px; color: var(--gray-light);"></i>
                            <span style="color: var(--white-soft);">${pendingAttachment.name}</span>
                        </div>`
                    }
                    <button class="remove-attachment-btn" onclick="removeAttachment()">×</button>
                </div>
            `;
        }

        function selectChatUser(userId) {
            // Garantir que staffData é um array
            if (!Array.isArray(staffData)) staffData = [];
            activeChatUser = staffData.find(s => s.id === userId);
            activeChatGroup = null; // Desselecionar grupo
            markMessagesAsRead(userId);
            
            // Atualizar badge após marcar como lido
            setTimeout(() => {
                updateChatNotificationBadge();
            }, 100);
            
            loadChat();
        }

        function selectChatGroup(groupId) {
            // Garantir que chatGroups é um array
            if (!Array.isArray(chatGroups)) chatGroups = [];
            activeChatGroup = chatGroups.find(g => g.id === groupId);
            activeChatUser = null; // Desselecionar usuário individual
            markGroupMessagesAsRead(groupId);
            
            setTimeout(() => {
                updateChatNotificationBadge();
            }, 100);
            
            loadChat();
        }

        function getChatMessages(userId) {
            const messages = Array.isArray(chatMessages) ? chatMessages : [];
            return messages.filter(msg => 
                (msg.senderId === currentUser.id && msg.receiverId === userId) ||
                (msg.senderId === userId && msg.receiverId === currentUser.id)
            ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        }

        function getLastMessage(userId) {
            const messages = getChatMessages(userId);
            if (messages.length === 0) return null;
            const last = messages[messages.length - 1];
            return last.text.length > 30 ? last.text.substring(0, 30) + '...' : last.text;
        }

        function getUnreadCount(userId) {
            const messages = Array.isArray(chatMessages) ? chatMessages : [];
            return messages.filter(msg => 
                msg.senderId === userId && 
                msg.receiverId === currentUser.id && 
                !msg.read
            ).length;
        }

        function markMessagesAsRead(userId) {
            const messages = Array.isArray(chatMessages) ? chatMessages : [];
            messages.forEach(msg => {
                if (msg.senderId === userId && msg.receiverId === currentUser.id) {
                    msg.read = true;
                }
            });
            chatMessages = messages;
            saveData('txd_chat_messages', chatMessages);
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text && !pendingAttachment) return;
            if (!activeChatUser && !activeChatGroup) return;
            
            const message = {
                id: Date.now(),
                senderId: currentUser.id,
                senderName: currentUser.displayName,
                text: text || '',
                timestamp: new Date().toISOString(),
                read: false
            };
            
            // Adicionar anexo se houver
            if (pendingAttachment) {
                message.attachment = pendingAttachment;
                pendingAttachment = null;
            }
            
            // Enviar para grupo ou usuário individual
            if (activeChatGroup) {
                message.groupId = activeChatGroup.id;
                checkAndUnlockAchievement('group_message');
            } else {
                message.receiverId = activeChatUser.id;
            }
            
            chatMessages.push(message);
            saveData('txd_chat_messages', chatMessages);
            
            // Desbloquear conquista de primeira mensagem
            checkAndUnlockAchievement('first_message');
            
            // Notificar Discord (apenas para grupos)
            if (activeChatGroup) {
                sendDiscordNotification('chat', '💬 Nova Mensagem no Grupo', `${message.senderName} enviou uma mensagem em "${activeChatGroup.name}"`, [
                    { name: '📝 Mensagem', value: message.text.substring(0, 100) + (message.text.length > 100 ? '...' : ''), inline: false },
                    { name: '👥 Grupo', value: activeChatGroup.name, inline: true },
                    { name: '👤 Enviado por', value: message.senderName, inline: true }
                ]);
            }
            
            input.value = '';
            loadChat();
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        function formatChatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Agora';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm atrás';
            if (diff < 86400000) return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        }

        // ========== FUNÇÕES DE GRUPOS ==========
        function getGroupChatMessages(groupId) {
            const messages = Array.isArray(chatMessages) ? chatMessages : [];
            return messages.filter(msg => msg && msg.groupId === groupId)
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        }

        function getGroupLastMessage(groupId) {
            const messages = getGroupChatMessages(groupId);
            if (messages.length === 0) return null;
            const last = messages[messages.length - 1];
            return last.text.length > 30 ? last.text.substring(0, 30) + '...' : last.text;
        }

        function getGroupUnreadCount(groupId) {
            const messages = Array.isArray(chatMessages) ? chatMessages : [];
            return messages.filter(msg => 
                msg && msg.groupId === groupId && 
                msg.senderId !== currentUser.id && 
                !msg.read
            ).length;
        }

        function markGroupMessagesAsRead(groupId) {
            chatMessages.forEach(msg => {
                if (msg.groupId === groupId && msg.senderId !== currentUser.id) {
                    msg.read = true;
                }
            });
            saveData('txd_chat_messages', chatMessages);
        }

        function openCreateGroupModal() {
            // Garantir que staffData é um array
            if (!Array.isArray(staffData)) staffData = [];
            
            const modal = document.getElementById('createGroupModal');
            const memberSelection = document.getElementById('groupMembersSelection');
            
            // Preencher lista de membros
            const otherStaff = staffData.filter(staff => staff.id !== currentUser.id);
            memberSelection.innerHTML = otherStaff.map(staff => `
                <div style="display: flex; align-items: center; gap: 12px; padding: 8px; border-radius: 8px; 
                    background: var(--gray-dark); margin-bottom: 8px; border: 1px solid var(--gray-border);">
                    <input type="checkbox" id="member_${staff.id}" value="${staff.id}" 
                        style="width: 18px; height: 18px; cursor: pointer;">
                    <label for="member_${staff.id}" style="flex: 1; cursor: pointer; color: var(--white-soft); font-size: 14px;">
                        <strong>${staff.name}</strong> - ${staff.role}
                    </label>
                </div>
            `).join('');
            
            modal.classList.add('active');
        }

        function saveGroup(event) {
            event.preventDefault();
            
            const groupName = document.getElementById('groupName').value;
            const groupDescription = document.getElementById('groupDescription').value;
            
            // Obter membros selecionados
            const selectedMembers = [];
            staffData.forEach(staff => {
                const checkbox = document.getElementById(`member_${staff.id}`);
                if (checkbox && checkbox.checked) {
                    selectedMembers.push({
                        id: staff.id,
                        name: staff.name,
                        role: staff.role
                    });
                }
            });
            
            if (selectedMembers.length === 0) {
                alert('Selecione pelo menos um membro para o grupo!');
                return;
            }
            
            // Adicionar o criador ao grupo
            selectedMembers.push({
                id: currentUser.id,
                name: currentUser.displayName,
                role: currentUser.role
            });
            
            const newGroup = {
                id: Date.now(),
                name: groupName,
                description: groupDescription,
                members: selectedMembers,
                createdBy: currentUser.id,
                createdAt: new Date().toISOString()
            };
            
            chatGroups.push(newGroup);
            saveData('txd_chat_groups', chatGroups);
            
            // Notificar Discord sobre criação de grupo
            sendDiscordNotification('chat', '👥 Novo Grupo Criado', 
                `${currentUser.name} criou um novo grupo de chat`,
                [
                    { name: '📛 Nome do Grupo', value: groupName, inline: true },
                    { name: '👥 Membros', value: selectedMembers.length.toString(), inline: true },
                    { name: '📝 Descrição', value: groupDescription || 'Sem descrição', inline: false },
                    { name: '👤 Participantes', value: selectedMembers.map(m => m.name).join(', '), inline: false },
                    { name: '👨‍💼 Criado por', value: currentUser.name, inline: true }
                ]
            );
            
            // Desbloquear conquista
            checkAndUnlockAchievement('create_group');
            
            closeModal('createGroupModal');
            document.getElementById('createGroupForm').reset();
            
            alert('Grupo criado com sucesso!');
            loadChat();
        }

        // ========== FUNÇÕES DE ANEXOS ==========
        function handleAttachmentSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const fileData = {
                    name: file.name,
                    size: formatFileSize(file.size),
                    type: file.type.startsWith('image/') ? 'image' : 'file',
                    data: e.target.result
                };
                
                pendingAttachment = fileData;
                
                // Desbloquear conquista
                checkAndUnlockAchievement('first_attachment');
                
                loadChat();
            };
            
            reader.readAsDataURL(file);
        }

        function removeAttachment() {
            pendingAttachment = null;
            loadChat();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // ========== SISTEMA DE RANKING E ESTATÍSTICAS ==========
        async function loadRanking() {
            // Calcular estatísticas para cada staff
            const staffStatsPromises = staffData.map(async (staff) => {
                const tasksCompleted = await getCompletedTasksByStaff(staff.id);
                const ticketsResolved = getResolvedTicketsByStaff(staff.id);
                const messagesCount = getMessagesByStaff(staff.id);
                const score = (tasksCompleted * 10) + (ticketsResolved * 15) + (messagesCount * 2);
                
                return {
                    ...staff,
                    tasksCompleted,
                    ticketsResolved,
                    messagesCount,
                    score
                };
            });
            
            // Aguardar todas as promessas
            const staffStats = await Promise.all(staffStatsPromises);
            
            // Ordenar por pontuação
            staffStats.sort((a, b) => b.score - a.score);
            
            const content = `
                <h1 id="sectionTitle">📊 Ranking e Estatísticas</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Desempenho e métricas da equipe</p>
                
                <!-- Cards de Estatísticas Gerais -->
                <div class="ranking-grid">
                    <div class="ranking-card">
                        <div class="ranking-card-header">
                            <div class="ranking-card-title">Total de Tarefas</div>
                            <div class="ranking-card-icon">✅</div>
                        </div>
                        <div style="font-size: 36px; font-weight: 800; color: var(--success); margin: 12px 0;">
                            ${staffStats.reduce((sum, s) => sum + s.tasksCompleted, 0)}
                        </div>
                        <div style="color: var(--gray-text); font-size: 13px;">Concluídas este mês</div>
                    </div>
                    
                    <div class="ranking-card">
                        <div class="ranking-card-header">
                            <div class="ranking-card-title">Tickets Resolvidos</div>
                            <div class="ranking-card-icon">🎫</div>
                        </div>
                        <div style="font-size: 36px; font-weight: 800; color: var(--warning); margin: 12px 0;">
                            ${staffStats.reduce((sum, s) => sum + s.ticketsResolved, 0)}
                        </div>
                        <div style="color: var(--gray-text); font-size: 13px;">Total resolvidos</div>
                    </div>
                    
                    <div class="ranking-card">
                        <div class="ranking-card-header">
                            <div class="ranking-card-title">Taxa de Atividade</div>
                            <div class="ranking-card-icon">📈</div>
                        </div>
                        <div style="font-size: 36px; font-weight: 800; color: var(--gray-very-light); margin: 12px 0;">
                            ${Math.round(staffStats.reduce((sum, s) => sum + s.score, 0) / staffStats.length)}
                        </div>
                        <div style="color: var(--gray-text); font-size: 13px;">Pontuação média</div>
                    </div>
                </div>
                
                <!-- Ranking de Desempenho -->
                <div class="stats-chart">
                    <div class="stats-chart-title">🏆 Top Performers - Ranking Geral</div>
                    ${staffStats.slice(0, 10).map((staff, index) => `
                        <div class="ranking-item">
                            <div class="ranking-position ${index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : ''}">
                                ${index + 1}
                            </div>
                            <div class="ranking-avatar">${staff.name.charAt(0)}</div>
                            <div class="ranking-info">
                                <div class="ranking-name">${staff.name}</div>
                                <div class="ranking-role">${staff.role}</div>
                            </div>
                            <div class="ranking-value">${staff.score} pts</div>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Gráfico de Tarefas Concluídas -->
                <div class="stats-chart">
                    <div class="stats-chart-title">✅ Tarefas Concluídas por Staff</div>
                    ${staffStats.slice(0, 8).map(staff => {
                        const maxTasks = Math.max(...staffStats.map(s => s.tasksCompleted));
                        const percentage = maxTasks > 0 ? (staff.tasksCompleted / maxTasks) * 100 : 0;
                        return `
                            <div class="chart-bar">
                                <div class="chart-bar-label">
                                    <span class="chart-bar-name">${staff.name}</span>
                                    <span class="chart-bar-value">${staff.tasksCompleted} tarefas</span>
                                </div>
                                <div class="chart-bar-bg">
                                    <div class="chart-bar-fill" style="width: ${percentage}%;"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <!-- Gráfico de Tickets Resolvidos -->
                <div class="stats-chart">
                    <div class="stats-chart-title">🎫 Tickets Resolvidos por Staff</div>
                    ${staffStats.slice(0, 8).map(staff => {
                        const maxTickets = Math.max(...staffStats.map(s => s.ticketsResolved));
                        const percentage = maxTickets > 0 ? (staff.ticketsResolved / maxTickets) * 100 : 0;
                        return `
                            <div class="chart-bar">
                                <div class="chart-bar-label">
                                    <span class="chart-bar-name">${staff.name}</span>
                                    <span class="chart-bar-value">${staff.ticketsResolved} tickets</span>
                                </div>
                                <div class="chart-bar-bg">
                                    <div class="chart-bar-fill" style="width: ${percentage}%; background: linear-gradient(90deg, var(--warning), var(--gray-very-light));"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <!-- Distribuição por Cargo -->
                <div class="stats-chart">
                    <div class="stats-chart-title">👥 Distribuição por Cargo</div>
                    ${getStaffByRole().map(roleData => {
                        const percentage = (roleData.count / staffData.length) * 100;
                        return `
                            <div class="chart-bar">
                                <div class="chart-bar-label">
                                    <span class="chart-bar-name">${roleData.role}</span>
                                    <span class="chart-bar-value">${roleData.count} membros</span>
                                </div>
                                <div class="chart-bar-bg">
                                    <div class="chart-bar-fill" style="width: ${percentage}%; background: linear-gradient(90deg, var(--gray-very-light), var(--success));"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            document.querySelector('.content-card').innerHTML = content;
        }

        // Funções auxiliares para cálculo de estatísticas
        async function getCompletedTasksByStaff(staffId) {
            try {
                const kanbanData = await getKanbanData();
                const staff = staffData.find(s => s.id === staffId);
                if (!staff) return 0;
                
                // Garantir que cards é um array
                if (!kanbanData || !kanbanData.cards || !Array.isArray(kanbanData.cards)) {
                    return 0;
                }
                
                return kanbanData.cards.filter(card => {
                    if (!card) return false;
                    const columnId = card.columnId || card.column_id || '';
                    const assignees = card.assignees || [];
                    return columnId === 'done' && Array.isArray(assignees) && assignees.includes(staff.name);
                }).length;
            } catch (error) {
                console.error('Erro ao buscar tarefas completadas:', error);
                return 0;
            }
        }

        function getResolvedTicketsByStaff(staffId) {
            const staff = staffData.find(s => s.id === staffId);
            if (!staff) return 0;
            
            return ticketsData.filter(ticket => 
                ticket.status === 'Finalizado' && ticket.responsible === staff.name
            ).length;
        }

        function getMessagesByStaff(staffId) {
            const messages = Array.isArray(chatMessages) ? chatMessages : [];
            return messages.filter(msg => msg && msg.senderId === staffId).length;
        }

        function getStaffByRole() {
            const roleCount = {};
            staffData.forEach(staff => {
                roleCount[staff.role] = (roleCount[staff.role] || 0) + 1;
            });
            
            return Object.entries(roleCount).map(([role, count]) => ({
                role,
                count
            })).sort((a, b) => b.count - a.count);
        }

        // ========== SISTEMA DE CONQUISTAS ==========
        const ACHIEVEMENTS = [
            {
                id: 'first_message',
                title: '📨 Primeira Mensagem',
                description: 'Envie sua primeira mensagem no chat',
                icon: '💬',
                condition: () => {
                    const messages = Array.isArray(chatMessages) ? chatMessages : [];
                    return messages.filter(m => m && m.senderId === currentUser.id).length >= 1;
                },
                reward: '+10 pts'
            },
            {
                id: 'chat_master',
                title: '💯 Mestre do Chat',
                description: 'Envie 100 mensagens no chat',
                icon: '🗣️',
                condition: () => {
                    const messages = Array.isArray(chatMessages) ? chatMessages : [];
                    return messages.filter(m => m && m.senderId === currentUser.id).length >= 100;
                },
                reward: '+50 pts'
            },
            {
                id: 'first_task',
                title: '✅ Primeira Tarefa',
                description: 'Complete sua primeira tarefa',
                icon: '🎯',
                condition: async () => {
                    try {
                        const count = await getCompletedTasksByStaff(currentUser.id);
                        return count >= 1;
                    } catch (error) {
                        console.error('Erro ao verificar primeira tarefa:', error);
                        return false;
                    }
                },
                reward: '+15 pts'
            },
            {
                id: 'task_champion',
                title: '🏆 Campeão de Tarefas',
                description: 'Complete 50 tarefas',
                icon: '⭐',
                condition: async () => {
                    try {
                        const count = await getCompletedTasksByStaff(currentUser.id);
                        return count >= 50;
                    } catch (error) {
                        console.error('Erro ao verificar campeão de tarefas:', error);
                        return false;
                    }
                },
                reward: '+100 pts'
            },
            {
                id: 'first_ticket',
                title: '🎫 Primeiro Atendimento',
                description: 'Resolva seu primeiro ticket',
                icon: '🛎️',
                condition: () => getResolvedTicketsByStaff(currentUser.id) >= 1,
                reward: '+20 pts'
            },
            {
                id: 'support_hero',
                title: '🦸 Herói do Suporte',
                description: 'Resolva 30 tickets',
                icon: '💪',
                condition: () => getResolvedTicketsByStaff(currentUser.id) >= 30,
                reward: '+75 pts'
            },
            {
                id: 'create_group',
                title: '👥 Criador de Comunidade',
                description: 'Crie um grupo no chat',
                icon: '🌟',
                condition: () => chatGroups.some(g => g.createdBy === currentUser.id),
                reward: '+25 pts'
            },
            {
                id: 'group_message',
                title: '📢 Comunicador',
                description: 'Envie 10 mensagens em grupos',
                icon: '📣',
                condition: () => {
                    const messages = Array.isArray(chatMessages) ? chatMessages : [];
                    return messages.filter(m => m && m.senderId === currentUser.id && m.groupId).length >= 10;
                },
                reward: '+30 pts'
            },
            {
                id: 'first_attachment',
                title: '📎 Compartilhador',
                description: 'Envie seu primeiro anexo',
                icon: '📁',
                condition: () => {
                    const messages = Array.isArray(chatMessages) ? chatMessages : [];
                    return messages.filter(m => m && m.senderId === currentUser.id && m.attachment).length >= 1;
                },
                reward: '+15 pts'
            },
            {
                id: 'early_bird',
                title: '🌅 Madrugador',
                description: 'Faça login antes das 7h',
                icon: '☀️',
                condition: () => {
                    const now = new Date();
                    return now.getHours() < 7;
                },
                reward: '+10 pts'
            },
            {
                id: 'night_owl',
                title: '🦉 Coruja Noturna',
                description: 'Faça login depois das 23h',
                icon: '🌙',
                condition: () => {
                    const now = new Date();
                    return now.getHours() >= 23;
                },
                reward: '+10 pts'
            },
            {
                id: 'top_performer',
                title: '🥇 Top Performer',
                description: 'Fique em 1º lugar no ranking',
                icon: '👑',
                condition: async () => {
                    try {
                        const staffStatsPromises = staffData.map(async (staff) => {
                            const tasksCompleted = await getCompletedTasksByStaff(staff.id);
                            return {
                                id: staff.id,
                                score: (tasksCompleted * 10) + 
                                       (getResolvedTicketsByStaff(staff.id) * 15) + 
                                       (getMessagesByStaff(staff.id) * 2)
                            };
                        });
                        const staffStats = await Promise.all(staffStatsPromises);
                        staffStats.sort((a, b) => b.score - a.score);
                        return staffStats[0]?.id === currentUser.id;
                    } catch (error) {
                        console.error('Erro ao verificar top performer:', error);
                        return false;
                    }
                },
                reward: '+150 pts'
            }
        ];

        async function loadAchievements() {
            const userAchievements = getData('txd_user_achievements') || {};
            const currentUserAchievements = userAchievements[currentUser.id] || [];
            
            // Verificar todas as conquistas (aguardar condições assíncronas)
            for (const achievement of ACHIEVEMENTS) {
                if (!currentUserAchievements.includes(achievement.id)) {
                    try {
                        const conditionResult = typeof achievement.condition === 'function' 
                            ? await achievement.condition() 
                            : achievement.condition();
                        if (conditionResult) {
                            currentUserAchievements.push(achievement.id);
                        }
                    } catch (error) {
                        console.error(`Erro ao verificar conquista ${achievement.id}:`, error);
                    }
                }
            }
            
            // Salvar conquistas atualizadas
            userAchievements[currentUser.id] = currentUserAchievements;
            saveData('txd_user_achievements', userAchievements);
            
            const unlockedCount = currentUserAchievements.length;
            const totalCount = ACHIEVEMENTS.length;
            const completionPercentage = Math.round((unlockedCount / totalCount) * 100);
            
            const content = `
                <h1 id="sectionTitle">🏆 Conquistas</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Sistema de conquistas e recompensas</p>
                
                <!-- Resumo de Conquistas -->
                <div class="user-achievements-summary">
                    <div class="achievement-stat">
                        <div class="achievement-stat-value">${unlockedCount}/${totalCount}</div>
                        <div class="achievement-stat-label">Conquistas Desbloqueadas</div>
                    </div>
                    <div class="achievement-stat">
                        <div class="achievement-stat-value">${completionPercentage}%</div>
                        <div class="achievement-stat-label">Conclusão</div>
                    </div>
                    <div class="achievement-stat">
                        <div class="achievement-stat-value">${calculateAchievementPoints(currentUserAchievements)}</div>
                        <div class="achievement-stat-label">Pontos de Conquista</div>
                    </div>
                </div>
                
                <!-- Grid de Conquistas -->
                <div class="achievements-grid">
                    ${(await Promise.all(ACHIEVEMENTS.map(async (achievement) => {
                        const isUnlocked = currentUserAchievements.includes(achievement.id);
                        const progress = await getAchievementProgress(achievement);
                        
                        return `
                            <div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}">
                                <div class="achievement-icon">${achievement.icon}</div>
                                <div class="achievement-title">${achievement.title}</div>
                                <div class="achievement-description">${achievement.description}</div>
                                ${!isUnlocked && progress.current < progress.target ? `
                                    <div class="achievement-progress">
                                        <div class="achievement-progress-fill" style="width: ${(progress.current / progress.target) * 100}%"></div>
                                    </div>
                                    <div class="achievement-progress-text">${progress.current} / ${progress.target}</div>
                                ` : ''}
                                <div class="achievement-reward">${achievement.reward}</div>
                            </div>
                        `;
                    }))).join('')}
                </div>
            `;
            
            document.querySelector('.content-card').innerHTML = content;
        }

        function getAchievementProgress(achievement) {
            let current = 0;
            let target = 1;
            
            const messages = Array.isArray(chatMessages) ? chatMessages : [];
            
            switch(achievement.id) {
                case 'first_message':
                    current = Math.min(messages.filter(m => m && m.senderId === currentUser.id).length, 1);
                    target = 1;
                    break;
                case 'chat_master':
                    current = messages.filter(m => m && m.senderId === currentUser.id).length;
                    target = 100;
                    break;
                case 'first_task':
                    current = Math.min(getCompletedTasksByStaff(currentUser.id), 1);
                    target = 1;
                    break;
                case 'task_champion':
                    current = getCompletedTasksByStaff(currentUser.id);
                    target = 50;
                    break;
                case 'first_ticket':
                    current = Math.min(getResolvedTicketsByStaff(currentUser.id), 1);
                    target = 1;
                    break;
                case 'support_hero':
                    current = getResolvedTicketsByStaff(currentUser.id);
                    target = 30;
                    break;
                case 'group_message':
                    current = messages.filter(m => m && m.senderId === currentUser.id && m.groupId).length;
                    target = 10;
                    break;
                case 'first_attachment':
                    current = Math.min(messages.filter(m => m && m.senderId === currentUser.id && m.attachment).length, 1);
                    target = 1;
                    break;
            }
            
            return { current, target };
        }

        function calculateAchievementPoints(unlockedAchievements) {
            return unlockedAchievements.reduce((total, achievementId) => {
                const achievement = ACHIEVEMENTS.find(a => a.id === achievementId);
                if (achievement) {
                    const points = parseInt(achievement.reward.match(/\d+/)[0]);
                    return total + points;
                }
                return total;
            }, 0);
        }

        function checkAndUnlockAchievement(achievementId) {
            const userAchievements = getData('txd_user_achievements') || {};
            const currentUserAchievements = userAchievements[currentUser.id] || [];
            
            if (!currentUserAchievements.includes(achievementId)) {
                const achievement = ACHIEVEMENTS.find(a => a.id === achievementId);
                if (achievement && achievement.condition()) {
                    currentUserAchievements.push(achievementId);
                    userAchievements[currentUser.id] = currentUserAchievements;
                    saveData('txd_user_achievements', userAchievements);
                    
                    // Mostrar notificação
                    showAchievementNotification(achievement);
                    
                    // Notificar Discord
                    sendDiscordNotification('achievements', '🏆 Conquista Desbloqueada!', `${currentUser?.displayName || currentUser?.name || 'Usuário'} desbloqueou uma nova conquista!`, [
                        { name: '🎖️ Conquista', value: achievement.title || 'Conquista', inline: false },
                        { name: '📝 Descrição', value: achievement.description || 'Sem descrição', inline: false },
                        { name: '🎁 Recompensa', value: achievement.reward || 'N/A', inline: true },
                        { name: '👤 Staff', value: currentUser?.displayName || currentUser?.name || 'Usuário', inline: true }
                    ]);
                }
            }
        }

        function showAchievementNotification(achievement) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, var(--success), var(--gray-very-light));
                color: var(--black-deep);
                padding: 20px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0, 255, 136, 0.3);
                z-index: 10000;
                font-weight: 700;
                display: flex;
                align-items: center;
                gap: 12px;
                animation: slideInRight 0.5s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="font-size: 32px;">${achievement.icon}</div>
                <div>
                    <div style="font-size: 16px; margin-bottom: 4px;">Conquista Desbloqueada!</div>
                    <div style="font-size: 14px; opacity: 0.9;">${achievement.title}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.5s ease-out';
                setTimeout(() => notification.remove(), 500);
            }, 4000);
        }

        // ========== INTEGRAÇÃO DISCORD ==========
        function getDiscordConfig() {
            const stored = getData('txd_discord_config');
            const defaultConfig = {
                enabled: false,
                webhooks: {
                    main: '',
                    logs: '',
                    events: '',
                    tickets: ''
                },
                notifications: {
                    chat: true,
                    tasks: true,
                    tickets: true,
                    events: true,
                    achievements: true,
                    staff: true
                },
                commandsEnabled: false,
                commandsWebhook: ''
            };
            
            // Se não existe config salva OU é um array vazio, salvar padrão
            if (!stored || Array.isArray(stored) || Object.keys(stored).length === 0 || !stored.hasOwnProperty('enabled')) {
                // Criar config padrão silenciosamente (sem log)
                saveData('txd_discord_config', defaultConfig);
                return defaultConfig;
            }
            
            // Garantir que todas as propriedades existem
            return {
                enabled: stored.enabled === true, // Força boolean
                webhooks: stored.webhooks || defaultConfig.webhooks,
                notifications: stored.notifications || defaultConfig.notifications,
                commandsEnabled: stored.commandsEnabled === true || false,
                commandsWebhook: stored.commandsWebhook || ''
            };
        }

        let discordConfig = getDiscordConfig();

        // ========== PAINEL ADMINISTRATIVO CENTRAL - PASSO 3 ==========
        
        // Variável para controlar aba ativa
        let activeSettingsTab = 'geral';

        function loadSettings() {
            console.log('loadSettings() chamado');
            
            // Recarregar config do Discord
            discordConfig = getDiscordConfig();
            
            console.log('loadSettings() - discordConfig:', discordConfig);
            if (!hasPermission('system.config')) {
                const content = `
                    <h1 id="sectionTitle">Configurações do Sistema</h1>
                    <p style="color: var(--gray-light); margin-bottom: 24px;">Acesso negado</p>
                    <div style="padding: 20px; background: var(--gray-dark); border-radius: 12px; border: 1px solid var(--gray-border);">
                        <p style="color: var(--danger); margin-bottom: 12px;">
                            <i class="fas fa-lock"></i> Você não tem permissão para acessar as configurações do sistema.
                        </p>
                        <p style="color: var(--gray-light); font-size: 14px;">
                            Apenas cargos com permissão de administração podem acessar esta seção.
                        </p>
                    </div>
                `;
                document.querySelector('.content-card').innerHTML = content;
                return;
            }
            
            // Carregar aba padrão
            loadSettingsSection(activeSettingsTab);
        }
        
        // Função para carregar seção específica do painel de configurações
        function loadSettingsSection(tab) {
            activeSettingsTab = tab;
            
            const tabs = [
                { id: 'geral', name: 'Geral', icon: '⚙️' },
                { id: 'cargos', name: 'Cargos & Permissões', icon: '👥' },
                { id: 'seguranca', name: 'Acesso & Segurança', icon: '🔐' },
                { id: 'discord', name: 'Discord', icon: '🎮' },
                { id: 'logs', name: 'Logs & Auditoria', icon: '📋' },
                { id: 'sistema', name: 'Sistema', icon: '🖥️' }
            ];
            
            const tabsHTML = tabs.map(t => `
                <button class="settings-tab ${tab === t.id ? 'active' : ''}" 
                        onclick="loadSettingsSection('${t.id}')"
                        style="padding: 12px 20px; background: ${tab === t.id ? 'var(--gray-medium)' : 'transparent'}; 
                               border: none; border-bottom: 2px solid ${tab === t.id ? 'var(--success)' : 'transparent'}; 
                               color: ${tab === t.id ? 'var(--white-soft)' : 'var(--gray-light)'}; 
                               cursor: pointer; font-size: 14px; font-weight: ${tab === t.id ? '600' : '400'}; 
                               transition: all 0.3s ease;">
                    <i class="fas"></i> ${t.icon} ${t.name}
                </button>
            `).join('');
            
            let contentHTML = '';
            
            switch(tab) {
                case 'geral':
                    contentHTML = loadSettingsGeneral();
                    break;
                case 'cargos':
                    contentHTML = loadSettingsRoles();
                    break;
                case 'seguranca':
                    contentHTML = loadSettingsSecurity();
                    break;
                case 'discord':
                    contentHTML = loadSettingsDiscord();
                    break;
                case 'logs':
                    contentHTML = loadSettingsLogs();
                    break;
                case 'sistema':
                    contentHTML = loadSettingsSystem();
                    break;
                default:
                    contentHTML = loadSettingsGeneral();
            }

            const content = `
                <h1 id="sectionTitle">Configurações do Sistema</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Painel Administrativo Central</p>
                
                <!-- Tabs Navigation -->
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 8px; margin-bottom: 24px; border: 1px solid var(--gray-border); display: flex; gap: 4px; overflow-x: auto;">
                    ${tabsHTML}
                </div>
                
                <!-- Tab Content -->
                <div id="settingsTabContent">
                    ${contentHTML}
                </div>
            `;
            
            document.querySelector('.content-card').innerHTML = content;
        }
        
        // 1. CONFIGURAÇÕES GERAIS
        function loadSettingsGeneral() {
            const systemSettings = getData('txd_system_settings') || {
                systemName: 'TXD Staff System',
                maintenanceMode: false,
                globalMessage: '',
                logoUrl: ''
            };
            
            return `
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border); margin-bottom: 24px;">
                    <h2 style="color: var(--white-soft); margin-bottom: 20px; font-size: 18px;">
                        <i class="fas fa-cog"></i> Configurações Gerais
                    </h2>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- Nome do Sistema -->
                        <div>
                            <label style="color: var(--gray-light); font-size: 14px; margin-bottom: 8px; display: block;">
                                Nome do Sistema
                            </label>
                            <input type="text" 
                                   id="systemName"
                                   value="${systemSettings.systemName || 'TXD Staff System'}"
                                   placeholder="Nome do sistema"
                                   style="width: 100%; padding: 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 8px; color: var(--white-soft); font-size: 14px;"
                                   onchange="saveSystemSetting('systemName', this.value)">
                        </div>
                        
                        <!-- Logo (placeholder) -->
                        <div>
                            <label style="color: var(--gray-light); font-size: 14px; margin-bottom: 8px; display: block;">
                                URL do Logo
                            </label>
                            <input type="text" 
                                   id="logoUrl"
                                   value="${systemSettings.logoUrl || ''}"
                                   placeholder="https://exemplo.com/logo.png"
                                   style="width: 100%; padding: 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 8px; color: var(--white-soft); font-size: 14px;"
                                   onchange="saveSystemSetting('logoUrl', this.value)">
                            <p style="color: var(--gray-text); font-size: 12px; margin-top: 8px;">
                                Upload de imagem será implementado em breve
                            </p>
                        </div>
                        
                        <!-- Modo Manutenção -->
                        <div>
                            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                <div class="toggle-switch ${systemSettings.maintenanceMode ? 'active' : ''}" 
                                     onclick="toggleMaintenanceMode()"
                                     id="maintenanceToggle">
                                </div>
                                <span style="color: var(--gray-light); font-size: 14px;">
                                    Modo Manutenção
                                    <span style="margin-left: 8px; font-weight: 600; color: ${systemSettings.maintenanceMode ? 'var(--warning)' : 'var(--success)'};">
                                        (${systemSettings.maintenanceMode ? 'ATIVO' : 'INATIVO'})
                                    </span>
                                </span>
                            </label>
                            <p style="color: var(--gray-text); font-size: 12px; margin-top: 8px; margin-left: 48px;">
                                Quando ativo, apenas administradores podem acessar o sistema
                            </p>
                        </div>
                        
                        <!-- Mensagem Global -->
                        <div>
                            <label style="color: var(--gray-light); font-size: 14px; margin-bottom: 8px; display: block;">
                                Mensagem Global do Sistema
                            </label>
                            <textarea id="globalMessage"
                                      placeholder="Digite uma mensagem que será exibida para todos os usuários..."
                                      style="width: 100%; padding: 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 8px; color: var(--white-soft); font-size: 14px; min-height: 100px; resize: vertical; font-family: inherit;"
                                      onchange="saveSystemSetting('globalMessage', this.value)">${systemSettings.globalMessage || ''}</textarea>
                            <p style="color: var(--gray-text); font-size: 12px; margin-top: 8px;">
                                Esta mensagem aparecerá no topo do dashboard para todos os usuários
                            </p>
                        </div>
                        
                        <button class="btn btn-primary" onclick="saveAllGeneralSettings()" style="margin-top: 8px;">
                            <i class="fas fa-save"></i> Salvar Configurações Gerais
                        </button>
                    </div>
                </div>
            `;
        }
        
        // 2. CARGOS & PERMISSÕES (RBAC COMPLETO)
        function loadSettingsRoles() {
            if (!hasPermission('permission.manage') && currentUser.role !== 'Owner' && currentUser.role !== 'CEO') {
                return `
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border); text-align: center;">
                        <i class="fas fa-lock" style="font-size: 48px; color: var(--danger); margin-bottom: 16px;"></i>
                        <p style="color: var(--danger); font-size: 16px; margin-bottom: 8px;">Acesso Negado</p>
                        <p style="color: var(--gray-light); font-size: 14px;">
                            Apenas Owner e CEO podem gerenciar cargos e permissões.
                        </p>
                    </div>
                `;
            }
            
            const roles = Object.keys(ROLE_PERMISSIONS);
            
            return `
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border); margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: var(--white-soft); font-size: 18px; margin: 0;">
                            <i class="fas fa-users-cog"></i> Gestão de Cargos e Permissões
                        </h2>
                        <button class="btn btn-primary" onclick="openNewRoleModal()">
                            <i class="fas fa-plus"></i> Novo Cargo
                        </button>
                    </div>
                    
                        <div style="display: grid; gap: 16px;">
                        ${roles.map(role => {
                            const permissions = getUserPermissions(role);
                            const hasAll = permissions.includes('*');
                            const isCLevel = ['Owner', 'CEO', 'COO', 'CMO', 'CCO', 'CIO'].includes(role);
                            const isOperational = !isCLevel && role !== 'Dev';
                                
                                return `
                                    <div style="background: var(--black-dark); border-radius: 8px; padding: 16px; border: 1px solid var(--gray-border);">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                                <h3 style="color: var(--white-soft); font-size: 16px; font-weight: 600; margin: 0;">
                                                    ${role}
                                                </h3>
                                                <span style="background: ${isCLevel ? 'var(--success)' : 'var(--info)'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                                    ${isCLevel ? 'C-Level' : isOperational ? 'Operacional' : 'Técnico'}
                                            </span>
                                        </div>
                                            <p style="color: var(--gray-text); font-size: 12px; margin: 0;">
                                                ${hasAll ? 'Acesso total ao sistema' : `${permissions.length} permissões configuradas`}
                                            </p>
                                        </div>
                                        <div style="display: flex; gap: 8px;">
                                            <button class="btn btn-secondary" onclick="editRole('${role}')" style="padding: 8px 16px; font-size: 12px;">
                                                <i class="fas fa-edit"></i> Editar
                                            </button>
                                            ${role !== 'Owner' && role !== 'CEO' ? `
                                            <button class="btn btn-danger" onclick="deleteRole('${role}')" style="padding: 8px 16px; font-size: 12px;">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                    
                                        ${hasAll ? `
                                    <p style="color: var(--success); font-size: 12px; padding: 8px; background: rgba(0, 255, 136, 0.1); border-radius: 6px; margin: 0;">
                                            <i class="fas fa-check-circle"></i> Possui acesso total ao sistema
                                        </p>
                                        ` : `
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px;">
                                        ${permissions.slice(0, 8).map(perm => `
                                                <span style="background: var(--gray-medium); color: var(--gray-light); padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                                ${perm}
                                                </span>
                                            `).join('')}
                                        ${permissions.length > 8 ? `
                                                <span style="background: var(--gray-medium); color: var(--gray-light); padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                                +${permissions.length - 8} mais
                                                </span>
                                            ` : ''}
                                        </div>
                                        `}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                
                <!-- Preview de Permissões -->
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border);">
                    <h2 style="color: var(--white-soft); margin-bottom: 16px; font-size: 18px;">
                        <i class="fas fa-eye"></i> Preview: Suas Permissões
                    </h2>
                    <div style="background: var(--black-dark); border-radius: 8px; padding: 16px;">
                        <p style="color: var(--white-soft); font-weight: 600; margin-bottom: 8px;">Cargo: ${currentUser.role}</p>
                        <p style="color: var(--gray-light); font-size: 14px; margin-bottom: 16px;">
                            ${getUserPermissions(currentUser.role).includes('*') ? 'Acesso total ao sistema' : `${getUserPermissions(currentUser.role).length} permissões ativas`}
                        </p>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${getCurrentUserPermissions().map(perm => `
                                <span style="background: var(--success); color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500;">
                                    <i class="fas fa-check-circle"></i> ${perm}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 3. ACESSO & SEGURANÇA
        function loadSettingsSecurity() {
            const securitySettings = getData('txd_security_settings') || {
                sessionTimeout: 30, // minutos
                autoLogout: true,
                maxLoginAttempts: 5,
                requireTermsAcceptance: true,
                blockedIPs: []
            };
            
            return `
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border); margin-bottom: 24px;">
                    <h2 style="color: var(--white-soft); margin-bottom: 20px; font-size: 18px;">
                        <i class="fas fa-shield-alt"></i> Configurações de Segurança
                    </h2>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- Tempo de Sessão -->
                        <div>
                            <label style="color: var(--gray-light); font-size: 14px; margin-bottom: 8px; display: block;">
                                Tempo de Sessão (minutos)
                            </label>
                            <input type="number" 
                                   id="sessionTimeout"
                                   value="${securitySettings.sessionTimeout || 30}"
                                   min="5"
                                   max="480"
                                   style="width: 100%; padding: 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 8px; color: var(--white-soft); font-size: 14px;"
                                   onchange="saveSystemSetting('sessionTimeout', parseInt(this.value))">
                            <p style="color: var(--gray-text); font-size: 12px; margin-top: 8px;">
                                Tempo máximo de inatividade antes do logout automático
                            </p>
                        </div>
                        
                        <!-- Logout Automático -->
                        <div>
                            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                <div class="toggle-switch ${securitySettings.autoLogout ? 'active' : ''}" 
                                     onclick="toggleAutoLogout()"
                                     id="autoLogoutToggle">
                                </div>
                                <span style="color: var(--gray-light); font-size: 14px;">
                                    Logout Automático por Inatividade
                                    <span style="margin-left: 8px; font-weight: 600; color: ${securitySettings.autoLogout ? 'var(--success)' : 'var(--danger)'};">
                                        (${securitySettings.autoLogout ? 'ATIVO' : 'INATIVO'})
                                    </span>
                                </span>
                            </label>
                        </div>
                        
                        <!-- Tentativas de Login -->
                        <div>
                            <label style="color: var(--gray-light); font-size: 14px; margin-bottom: 8px; display: block;">
                                Máximo de Tentativas de Login
                            </label>
                            <input type="number" 
                                   id="maxLoginAttempts"
                                   value="${securitySettings.maxLoginAttempts || 5}"
                                   min="3"
                                   max="10"
                                   style="width: 100%; padding: 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 8px; color: var(--white-soft); font-size: 14px;"
                                   onchange="saveSystemSetting('maxLoginAttempts', parseInt(this.value))">
                            <p style="color: var(--gray-text); font-size: 12px; margin-top: 8px;">
                                Após exceder este limite, o IP será bloqueado temporariamente
                            </p>
                        </div>
                        
                        <!-- Aceite de Termos -->
                        <div>
                            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                <div class="toggle-switch ${securitySettings.requireTermsAcceptance ? 'active' : ''}" 
                                     onclick="toggleTermsRequirement()"
                                     id="termsToggle">
                                </div>
                                <span style="color: var(--gray-light); font-size: 14px;">
                                    Forçar Aceite de Termos
                                    <span style="margin-left: 8px; font-weight: 600; color: ${securitySettings.requireTermsAcceptance ? 'var(--success)' : 'var(--danger)'};">
                                        (${securitySettings.requireTermsAcceptance ? 'ATIVO' : 'INATIVO'})
                                    </span>
                                </span>
                            </label>
                            <p style="color: var(--gray-text); font-size: 12px; margin-top: 8px; margin-left: 48px;">
                                Usuários devem aceitar os termos antes de acessar o sistema
                            </p>
                        </div>
                        
                        <!-- IPs Bloqueados (preparar estrutura) -->
                        <div>
                            <label style="color: var(--gray-light); font-size: 14px; margin-bottom: 8px; display: block;">
                                IPs Bloqueados
                            </label>
                            <div style="background: var(--black-dark); border-radius: 8px; padding: 12px; border: 1px solid var(--gray-border); min-height: 100px;">
                                ${securitySettings.blockedIPs && securitySettings.blockedIPs.length > 0 ? `
                                    ${securitySettings.blockedIPs.map(ip => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--gray-dark); border-radius: 6px; margin-bottom: 8px;">
                                            <span style="color: var(--white-soft); font-family: monospace; font-size: 12px;">${ip}</span>
                                            <button class="btn btn-danger" onclick="unblockIP('${ip}')" style="padding: 4px 12px; font-size: 11px;">
                                                <i class="fas fa-unlock"></i> Desbloquear
                            </button>
                        </div>
                                    `).join('')}
                                ` : `
                                    <p style="color: var(--gray-text); font-size: 12px; text-align: center; margin: 0;">
                                        Nenhum IP bloqueado no momento
                                    </p>
                                `}
                    </div>
                            <p style="color: var(--gray-text); font-size: 12px; margin-top: 8px;">
                                IPs bloqueados automaticamente após múltiplas tentativas de login falhadas
                            </p>
                </div>
                        
                        <button class="btn btn-primary" onclick="saveAllSecuritySettings()" style="margin-top: 8px;">
                            <i class="fas fa-save"></i> Salvar Configurações de Segurança
                        </button>
                    </div>
                </div>
            `;
        }
        
        // 4. DISCORD (já existe, mas vamos adaptar para a aba)
        function loadSettingsDiscord() {
            discordConfig = getDiscordConfig();
            
            return `
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border);">
                    <div class="discord-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div class="discord-icon" style="width: 48px; height: 48px; background: #5865F2; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                            <i class="fab fa-discord"></i>
                        </div>
                            <div>
                                <h2 style="color: var(--white-soft); font-size: 18px; margin: 0;">
                                    Integração com Discord
                                </h2>
                                <p style="color: var(--gray-light); font-size: 14px; margin: 4px 0 0 0;">
                                    Envie notificações automáticas para o servidor Discord
                                </p>
                        </div>
                        </div>
                        <div class="discord-status ${discordConfig.enabled ? 'active' : 'inactive'}" 
                             style="background: ${discordConfig.enabled ? 'var(--success)' : 'var(--danger)'}; 
                                    color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                            <i class="fas fa-circle" style="font-size: 8px; margin-right: 6px;"></i>
                            ${discordConfig.enabled ? 'Ativo' : 'Inativo'}
                        </div>
                    </div>
                    
                    ${discordConfig.enabled ? `
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;" onclick="toggleDiscordIntegration()">
                                <div class="toggle-switch ${discordConfig.enabled ? 'active' : ''}" id="discordToggle"></div>
                            <span style="color: var(--gray-light); font-size: 14px;">
                                Ativar integração com Discord
                                <span style="margin-left: 8px; font-weight: 600; color: ${discordConfig.enabled ? 'var(--success)' : 'var(--danger)'};">
                                    (${discordConfig.enabled ? 'ATIVO' : 'INATIVO'})
                                </span>
                            </span>
                        </label>
                    </div>
                    
                        <!-- Webhook Principal -->
                        <div style="margin-bottom: 20px;">
                            <label style="color: var(--gray-light); font-size: 14px; margin-bottom: 8px; display: block;">
                                <i class="fas fa-link"></i> Webhook Principal (Obrigatório)
                            </label>
                        <input type="text" 
                               id="webhookMain"
                               placeholder="https://discord.com/api/webhooks/..."
                                   value="${discordConfig.webhooks?.main || ''}"
                                   style="width: 100%; padding: 12px; background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 8px; color: var(--white-soft); font-family: monospace; font-size: 12px;"
                               onchange="saveWebhook('main', this.value)">
                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <button class="btn btn-secondary" onclick="testWebhook('main')" style="padding: 8px 16px; font-size: 12px;">
                                <i class="fas fa-vial"></i> Testar
                            </button>
                                <button class="btn btn-secondary" onclick="diagnoseDiscordIntegration()" style="padding: 8px 16px; font-size: 12px;">
                                    <i class="fas fa-stethoscope"></i> Diagnóstico
                            </button>
                        </div>
                            <p style="color: var(--gray-text); font-size: 11px; margin-top: 8px;">
                                Este webhook receberá a maioria das notificações do sistema
                            </p>
                    </div>
                    
                        <!-- Tipos de Notificações -->
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: var(--white-soft); font-size: 16px; margin-bottom: 12px;">
                                <i class="fas fa-bell"></i> Tipos de Notificações
                            </h3>
                            <div style="display: grid; gap: 12px;">
                                ${['chat', 'tasks', 'tickets', 'events', 'achievements', 'staff'].map(type => {
                                    const typeNames = {
                                        chat: '💬 Chat',
                                        tasks: '📋 Tarefas',
                                        tickets: '🎫 Tickets',
                                        events: '📅 Eventos',
                                        achievements: '🏆 Conquistas',
                                        staff: '👥 Staff'
                                    };
                                    return `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--black-dark); border-radius: 8px; border: 1px solid var(--gray-border);">
                                            <span style="color: var(--white-soft); font-size: 14px;">${typeNames[type]}</span>
                                            <div class="toggle-switch ${discordConfig.notifications?.[type] ? 'active' : ''}" 
                                                 onclick="toggleNotification('${type}')"
                                                 style="cursor: pointer;">
                            </div>
                        </div>
                                    `;
                                }).join('')}
                        </div>
                    </div>
                    
                        <div style="background: var(--info); color: white; padding: 12px; border-radius: 8px; font-size: 13px; margin-top: 20px;">
                            <i class="fas fa-info-circle"></i> <strong>Dica:</strong> Use o botão "Diagnóstico" para verificar se tudo está configurado corretamente.
                            </div>
                    ` : `
                        <div style="text-align: center; padding: 40px; color: var(--gray-text);">
                            <i class="fab fa-discord" style="font-size: 64px; opacity: 0.3; margin-bottom: 16px;"></i>
                            <p style="margin-bottom: 20px;">Ative a integração para configurar webhooks e notificações</p>
                            <button class="btn btn-primary" onclick="toggleDiscordIntegration()">
                                <i class="fas fa-power-off"></i> Ativar Integração
                            </button>
                        </div>
                    `}
                    </div>
            `;
        }
        
        function loadDiscordConfigContent() {
            return `
                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;" onclick="toggleDiscordIntegration()">
                        <div class="toggle-switch ${discordConfig.enabled ? 'active' : ''}" id="discordToggle"></div>
                        <span style="color: var(--gray-light); font-size: 14px;">
                            Ativar integração com Discord
                            <span style="margin-left: 8px; font-weight: 600; color: ${discordConfig.enabled ? 'var(--success)' : 'var(--danger)'};">
                                (${discordConfig.enabled ? 'ATIVO' : 'INATIVO'})
                            </span>
                        </span>
                    </label>
                            </div>
                
                <!-- Webhooks e Notificações - conteúdo existente será mantido -->
                <div style="margin-top: 24px;">
                    <p style="color: var(--gray-light); font-size: 14px; margin-bottom: 16px;">
                        Configure os webhooks e tipos de notificações abaixo. O conteúdo completo será carregado aqui.
                    </p>
                    <button class="btn btn-secondary" onclick="loadSettingsSection('discord'); location.reload();">
                        <i class="fas fa-sync"></i> Recarregar Configurações Discord
                            </button>
                        </div>
            `;
        }
        
        // 5. LOGS & AUDITORIA
        function loadSettingsLogs() {
            if (!hasPermission('system.logs') && currentUser.role !== 'Owner' && currentUser.role !== 'CEO' && currentUser.role !== 'HeadStaff') {
                return `
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border); text-align: center;">
                        <i class="fas fa-lock" style="font-size: 48px; color: var(--danger); margin-bottom: 16px;"></i>
                        <p style="color: var(--danger); font-size: 16px; margin-bottom: 8px;">Acesso Negado</p>
                        <p style="color: var(--gray-light); font-size: 14px;">
                            Apenas C-Level e HeadStaff podem visualizar logs do sistema.
                        </p>
                    </div>
                `;
            }
            
            const logsRaw = getData('txd_system_logs');
            // Garantir que logs seja sempre um array
            const logs = Array.isArray(logsRaw) ? logsRaw : [];
            const recentLogs = logs.slice(-50).reverse(); // Últimos 50 logs
            
            return `
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border); margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: var(--white-soft); font-size: 18px; margin: 0;">
                            <i class="fas fa-file-alt"></i> Logs do Sistema
                        </h2>
                        <button class="btn btn-secondary" onclick="exportLogs()">
                            <i class="fas fa-download"></i> Exportar Logs
                        </button>
                        </div>
                        
                    <div style="background: var(--black-dark); border-radius: 8px; padding: 16px; max-height: 600px; overflow-y: auto;">
                        ${recentLogs.length > 0 ? `
                            <div style="display: grid; gap: 12px;">
                                ${recentLogs.map(log => `
                                    <div style="background: var(--gray-dark); border-radius: 6px; padding: 12px; border-left: 3px solid ${getLogColor(log.action)};">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div>
                                                <span style="color: var(--white-soft); font-weight: 600; font-size: 14px;">
                                                    ${log.action || 'Ação desconhecida'}
                                                </span>
                                                <span style="color: var(--gray-text); font-size: 12px; margin-left: 12px;">
                                                    ${log.module || 'Sistema'}
                                                </span>
                            </div>
                                            <span style="color: var(--gray-text); font-size: 11px;">
                                                ${new Date(log.timestamp).toLocaleString('pt-BR')}
                                            </span>
                            </div>
                                        ${log.metadata ? `
                                            <div style="color: var(--gray-light); font-size: 12px; margin-top: 8px;">
                                                ${JSON.stringify(log.metadata, null, 2)}
                        </div>
                                        ` : ''}
                                        <div style="color: var(--gray-text); font-size: 11px; margin-top: 8px;">
                                            Usuário: ${log.user_id || 'Sistema'} | IP: ${log.ip || 'N/A'}
                            </div>
                            </div>
                                `).join('')}
                        </div>
                        ` : `
                            <p style="color: var(--gray-text); font-size: 14px; text-align: center; padding: 40px;">
                                Nenhum log registrado ainda
                            </p>
                        `}
                            </div>
                            </div>
            `;
        }
        
        function getLogColor(action) {
            if (action.includes('login') || action.includes('Login')) return 'var(--success)';
            if (action.includes('delete') || action.includes('Delete') || action.includes('remove')) return 'var(--danger)';
            if (action.includes('create') || action.includes('Create') || action.includes('add')) return 'var(--info)';
            if (action.includes('update') || action.includes('Update') || action.includes('edit')) return 'var(--warning)';
            return 'var(--gray-text)';
        }
        
        // 6. CONFIGURAÇÕES DO SISTEMA
        function loadSettingsSystem() {
            return `
                <div style="background: var(--gray-dark); border-radius: 12px; padding: 24px; border: 1px solid var(--gray-border); margin-bottom: 24px;">
                    <h2 style="color: var(--white-soft); margin-bottom: 20px; font-size: 18px;">
                        <i class="fas fa-server"></i> Configurações do Sistema
                    </h2>
                    
                    <div style="display: grid; gap: 20px;">
                        <!-- Módulos do Sistema -->
                        <div>
                            <h3 style="color: var(--white-soft); font-size: 16px; margin-bottom: 12px;">
                                Módulos do Sistema
                            </h3>
                            <div style="display: grid; gap: 12px;">
                                ${['Chat', 'Tickets', 'Kanban', 'Agenda', 'Ranking', 'Conquistas'].map(module => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--black-dark); border-radius: 8px; border: 1px solid var(--gray-border);">
                                        <span style="color: var(--white-soft); font-size: 14px;">${module}</span>
                                        <div class="toggle-switch active" style="cursor: pointer;">
                            </div>
                            </div>
                                `).join('')}
                        </div>
                    </div>
                    
                        <!-- Ações do Sistema -->
                            <div>
                            <h3 style="color: var(--white-soft); font-size: 16px; margin-bottom: 12px;">
                                Ações do Sistema
                            </h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                                <button class="btn btn-secondary" onclick="clearCache()">
                                    <i class="fas fa-broom"></i> Limpar Cache Local
                                </button>
                                <button class="btn btn-secondary" onclick="exportSystemData()">
                                    <i class="fas fa-download"></i> Exportar Dados (JSON)
                                </button>
                                ${currentUser.role === 'Owner' ? `
                                <button class="btn btn-danger" onclick="resetSystemSettings()">
                                    <i class="fas fa-undo"></i> Resetar Configurações
                                </button>
                                ` : ''}
                            </div>
                        </div>
                        </div>
                    </div>
            `;
        }

        // ========== FUNÇÕES OBRIGATÓRIAS ==========
        
        // Salvar configuração do sistema
        async function saveSystemSetting(key, value) {
            try {
                const settings = getData('txd_system_settings') || {};
                settings[key] = value;
                await saveData('txd_system_settings', settings);
                
                // Log da ação
                logSystemAction('Configuração atualizada', 'Sistema', { key, value });
                
                return true;
            } catch (error) {
                console.error('Erro ao salvar configuração:', error);
                return false;
            }
        }
        
        // Criar novo cargo
        function createRole(roleName, permissions, level = 'operational') {
            if (!hasPermission('permission.manage') && currentUser.role !== 'Owner' && currentUser.role !== 'CEO') {
                alert('Você não tem permissão para criar cargos.');
                return false;
            }
            
            if (ROLE_PERMISSIONS[roleName]) {
                alert('Este cargo já existe.');
                return false;
            }
            
            ROLE_PERMISSIONS[roleName] = permissions;
            
            logSystemAction('Cargo criado', 'Permissões', { role: roleName, permissions, level });
            
            loadSettingsSection('cargos');
            return true;
        }
        
        // Atualizar permissões de um cargo
        function updateRolePermissions(role, permissions) {
            if (!hasPermission('permission.manage') && currentUser.role !== 'Owner' && currentUser.role !== 'CEO') {
                alert('Você não tem permissão para editar permissões.');
                return false;
            }
            
            if (role === 'Owner' || role === 'CEO') {
                alert('Não é possível alterar permissões de Owner ou CEO.');
                return false;
            }
            
            ROLE_PERMISSIONS[role] = permissions;
            
            logSystemAction('Permissões atualizadas', 'Permissões', { role, permissions });
            
            loadSettingsSection('cargos');
            return true;
        }
        
        // Registrar ação do sistema (logs)
        function logSystemAction(action, module, metadata = {}) {
            try {
                const logsRaw = getData('txd_system_logs');
                const logs = Array.isArray(logsRaw) ? logsRaw : [];
                const logEntry = {
                    id: Date.now(),
                    user_id: currentUser?.id || 'system',
                    user_name: currentUser?.name || 'Sistema',
                    action: action,
                    module: module,
                    timestamp: new Date().toISOString(),
                    metadata: metadata,
                    ip: 'N/A' // Será implementado quando houver backend
                };
                
                logs.push(logEntry);
                
                // Manter apenas últimos 1000 logs
                if (logs.length > 1000) {
                    logs.shift();
                }
                
                saveData('txd_system_logs', logs);
                
                return true;
            } catch (error) {
                console.error('Erro ao registrar log:', error);
                return false;
            }
        }
        
        // Funções auxiliares para as abas
        function saveAllGeneralSettings() {
            const systemName = document.getElementById('systemName')?.value;
            const logoUrl = document.getElementById('logoUrl')?.value;
            const globalMessage = document.getElementById('globalMessage')?.value;
            
            if (systemName) saveSystemSetting('systemName', systemName);
            if (logoUrl !== undefined) saveSystemSetting('logoUrl', logoUrl);
            if (globalMessage !== undefined) saveSystemSetting('globalMessage', globalMessage);
            
            alert('Configurações gerais salvas com sucesso!');
            logSystemAction('Configurações gerais atualizadas', 'Sistema', { systemName, logoUrl });
        }
        
        function toggleMaintenanceMode() {
            const settings = getData('txd_system_settings') || {};
            settings.maintenanceMode = !settings.maintenanceMode;
            saveData('txd_system_settings', settings);
            loadSettingsSection('geral');
            logSystemAction('Modo manutenção alterado', 'Sistema', { maintenanceMode: settings.maintenanceMode });
        }
        
        function saveAllSecuritySettings() {
            const sessionTimeout = parseInt(document.getElementById('sessionTimeout')?.value) || 30;
            const maxLoginAttempts = parseInt(document.getElementById('maxLoginAttempts')?.value) || 5;
            
            const settings = {
                sessionTimeout,
                maxLoginAttempts,
                autoLogout: document.getElementById('autoLogoutToggle')?.classList.contains('active'),
                requireTermsAcceptance: document.getElementById('termsToggle')?.classList.contains('active'),
                blockedIPs: getData('txd_security_settings')?.blockedIPs || []
            };
            
            saveData('txd_security_settings', settings);
            alert('Configurações de segurança salvas com sucesso!');
            logSystemAction('Configurações de segurança atualizadas', 'Segurança', settings);
        }
        
        function toggleAutoLogout() {
            const settings = getData('txd_security_settings') || {};
            settings.autoLogout = !settings.autoLogout;
            saveData('txd_security_settings', settings);
            loadSettingsSection('seguranca');
        }
        
        function toggleTermsRequirement() {
            const settings = getData('txd_security_settings') || {};
            settings.requireTermsAcceptance = !settings.requireTermsAcceptance;
            saveData('txd_security_settings', settings);
            loadSettingsSection('seguranca');
        }
        
        function unblockIP(ip) {
            const settings = getData('txd_security_settings') || {};
            if (settings.blockedIPs) {
                settings.blockedIPs = settings.blockedIPs.filter(blockedIP => blockedIP !== ip);
                saveData('txd_security_settings', settings);
                loadSettingsSection('seguranca');
                logSystemAction('IP desbloqueado', 'Segurança', { ip });
            }
        }
        
        function exportLogs() {
            const logsRaw = getData('txd_system_logs');
            const logs = Array.isArray(logsRaw) ? logsRaw : [];
            const dataStr = JSON.stringify(logs, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `txd_logs_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            logSystemAction('Logs exportados', 'Sistema', { count: logs.length });
        }
        
        function clearCache() {
            if (confirm('Tem certeza que deseja limpar o cache local? Isso não afetará os dados no Supabase.')) {
                localStorage.removeItem('txd_dataCache');
                dataCache = {};
                alert('Cache limpo com sucesso!');
                logSystemAction('Cache limpo', 'Sistema', {});
            }
        }
        
        function exportSystemData() {
            const allData = {
                staff: getData('txd_staff') || [],
                tickets: getData('txd_tickets') || [],
                events: getData('txd_events') || [],
                commands: getData('txd_commands') || [],
                settings: getData('txd_system_settings') || {},
                security: getData('txd_security_settings') || {},
                logs: getData('txd_system_logs') || []
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `txd_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            logSystemAction('Dados exportados', 'Sistema', {});
        }
        
        function resetSystemSettings() {
            if (currentUser.role !== 'Owner') {
                alert('Apenas o Owner pode resetar as configurações do sistema.');
                return;
            }
            
            if (confirm('ATENÇÃO: Esta ação irá resetar TODAS as configurações do sistema. Tem certeza?')) {
                if (confirm('Esta ação é IRREVERSÍVEL. Confirme novamente.')) {
                    localStorage.removeItem('txd_system_settings');
                    localStorage.removeItem('txd_security_settings');
                    localStorage.removeItem('txd_discord_config');
                    alert('Configurações resetadas. A página será recarregada.');
                    logSystemAction('Configurações resetadas', 'Sistema', {});
                    location.reload();
                }
            }
        }
        
        function editRole(role) {
            alert('Funcionalidade de edição de cargo será implementada em breve.');
        }
        
        function deleteRole(role) {
            if (confirm(`Tem certeza que deseja excluir o cargo "${role}"?`)) {
                delete ROLE_PERMISSIONS[role];
                loadSettingsSection('cargos');
                logSystemAction('Cargo excluído', 'Permissões', { role });
            }
        }
        
        function openNewRoleModal() {
            alert('Modal de criação de cargo será implementado em breve.');
        }

        // ========== FUNÇÕES DE INTEGRAÇÃO DISCORD ==========
        async function toggleDiscordIntegration() {
            try {
                console.log('Toggle Discord - Estado antes:', discordConfig.enabled);
                
                // Recarregar config para garantir sincronização
                discordConfig = getDiscordConfig();
                
                // Atualizar estado
                discordConfig.enabled = !discordConfig.enabled;
                
                console.log('Toggle Discord - Estado depois:', discordConfig.enabled);
                
                // Salvar no Supabase e aguardar conclusão
                const saved = await saveDiscordConfig();
                
                if (!saved) {
                    alert('Erro ao salvar configuração. Tente novamente.');
                    return;
                }
                
                console.log('Toggle Discord - Salvo no Supabase');
                console.log('Toggle Discord - Config completa:', discordConfig);
                
                // Atualizar toggle visual IMEDIATAMENTE
                const toggleElement = document.getElementById('discordToggle');
                if (toggleElement) {
                    if (discordConfig.enabled) {
                        toggleElement.classList.add('active');
                    } else {
                        toggleElement.classList.remove('active');
                    }
                    console.log('Toggle Discord - Elemento toggle atualizado:', toggleElement.className);
                }
                
                // Atualizar badge de status
                const statusBadge = document.getElementById('discordStatusBadge');
                if (statusBadge) {
                    statusBadge.className = `discord-status ${discordConfig.enabled ? 'active' : 'inactive'}`;
                    statusBadge.innerHTML = `
                        <i class="fas fa-circle"></i>
                        ${discordConfig.enabled ? 'Ativo' : 'Inativo'}
                    `;
                    console.log('Toggle Discord - Badge atualizado:', discordConfig.enabled ? 'Ativo' : 'Inativo');
                }
                
                // Mostrar feedback visual
                const statusText = discordConfig.enabled ? 'ativada' : 'desativada';
                const tempNotif = document.createElement('div');
                tempNotif.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${discordConfig.enabled ? '#10b981' : '#6b7280'};
                    color: white;
                    padding: 16px 24px;
                    border-radius: 8px;
                    font-weight: 600;
                    font-size: 15px;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    animation: slideInRight 0.3s ease-out;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                `;
                tempNotif.innerHTML = `
                    <i class="fas fa-${discordConfig.enabled ? 'check-circle' : 'times-circle'}" style="font-size: 18px;"></i>
                    <span>Integração Discord ${statusText}!</span>
                `;
                document.body.appendChild(tempNotif);
                
                setTimeout(() => {
                    tempNotif.style.animation = 'slideOutRight 0.3s ease-out';
                    setTimeout(() => tempNotif.remove(), 300);
                }, 2500);
                
                // Recarregar configurações DEPOIS para não perder o foco
                console.log('Toggle Discord - Recarregando configurações...');
                setTimeout(async () => {
                    // Aguardar um pouco para garantir que o saveData foi processado
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    // Recarregar config antes de recarregar a página
                    discordConfig = getDiscordConfig();
                    console.log('Toggle Discord - Config recarregada antes de atualizar UI:', discordConfig);
                    
                    // Atualizar apenas a aba Discord, não toda a página
                    if (activeSettingsTab === 'discord') {
                        loadSettingsSection('discord');
                    }
                    console.log('Toggle Discord - Configurações recarregadas!');
                }, 500);
                
            } catch (error) {
                console.error('Erro ao ativar/desativar Discord:', error);
                alert('❌ Erro ao ativar/desativar integração Discord: ' + error.message);
            }
        }

        async function toggleNotification(type) {
            // Buscar config mais recente
            discordConfig = getDiscordConfig();
            discordConfig.notifications[type] = !discordConfig.notifications[type];
            await saveDiscordConfig();
            loadSettingsSection('discord');
        }

        async function saveWebhook(type, value) {
            // Buscar config mais recente
            discordConfig = getDiscordConfig();
            discordConfig.webhooks[type] = value;
            await saveDiscordConfig();
            
            // Feedback visual
            const btn = event?.target?.closest('.webhook-btn');
            if (btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Salvo!';
                btn.style.background = 'var(--success)';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
            }
        }

        async function saveDiscordConfig() {
            try {
            console.log('saveDiscordConfig() - Salvando:', discordConfig);
                await saveData('txd_discord_config', discordConfig);
                
                // Aguardar um pouco para garantir que o cache foi atualizado
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Atualizar variável global para manter sincronização
                discordConfig = getDiscordConfig();
            
            // Verificar se salvou corretamente
            const saved = getData('txd_discord_config');
            console.log('saveDiscordConfig() - Verificação:', saved);
                console.log('saveDiscordConfig() - Variável global atualizada:', discordConfig);
                
                return true;
            } catch (error) {
                console.error('Erro ao salvar configuração Discord:', error);
                return false;
            }
        }

        function testWebhook(type) {
            // Buscar configuração mais recente
            const currentConfig = getDiscordConfig();
            const webhookUrl = currentConfig.webhooks[type];
            
            if (!webhookUrl || webhookUrl.trim() === '') {
                alert('⚠️ Configure o webhook antes de testar!\n\n1. Vá até o Discord\n2. Crie um webhook no canal desejado\n3. Cole a URL aqui');
                return;
            }
            
            // Validar formato da URL
            if (!webhookUrl.startsWith('https://discord.com/api/webhooks/')) {
                alert('❌ URL do webhook inválida!\n\nA URL deve começar com: https://discord.com/api/webhooks/');
                return;
            }
            
            console.log('🧪 Testando webhook:', type, webhookUrl.substring(0, 50) + '...');
            
            const embed = {
                title: '✅ Teste de Webhook',
                description: `Este é um teste do webhook ${type === 'main' ? 'principal' : `de ${type}`}. Se você está vendo esta mensagem, a integração está funcionando! 🎉`,
                color: 5814783, // Cor verde
                fields: [
                    {
                        name: '📅 Data',
                        value: new Date().toLocaleDateString('pt-BR'),
                        inline: true
                    },
                    {
                        name: '🕒 Hora',
                        value: new Date().toLocaleTimeString('pt-BR'),
                        inline: true
                    },
                    {
                        name: '👤 Testado por',
                        value: currentUser?.displayName || currentUser?.name || 'Usuário',
                        inline: true
                    },
                    {
                        name: '🔗 Tipo de Webhook',
                        value: type === 'main' ? 'Principal' : type.charAt(0).toUpperCase() + type.slice(1),
                        inline: false
                    }
                ],
                footer: {
                    text: 'TXD Staff System - Teste de Integração'
                },
                timestamp: new Date().toISOString()
            };
            
            sendDiscordWebhook(webhookUrl, {
                username: 'TXD Staff Bot',
                avatar_url: 'https://i.imgur.com/4M34hi2.png',
                embeds: [embed]
            });
            
            // Feedback visual
            setTimeout(() => {
                alert('✅ Mensagem de teste enviada!\n\nVerifique o canal do Discord para confirmar o recebimento.');
            }, 1000);
        }
        
        // Função de diagnóstico da integração Discord
        function diagnoseDiscordIntegration() {
            const config = getDiscordConfig();
            const diagnostics = {
                enabled: config.enabled,
                hasMainWebhook: !!(config.webhooks?.main && config.webhooks.main.trim() !== ''),
                hasTicketsWebhook: !!(config.webhooks?.tickets && config.webhooks.tickets.trim() !== ''),
                hasEventsWebhook: !!(config.webhooks?.events && config.webhooks.events.trim() !== ''),
                hasLogsWebhook: !!(config.webhooks?.logs && config.webhooks.logs.trim() !== ''),
                notificationsEnabled: {
                    chat: config.notifications?.chat || false,
                    tasks: config.notifications?.tasks || false,
                    tickets: config.notifications?.tickets || false,
                    events: config.notifications?.events || false,
                    achievements: config.notifications?.achievements || false,
                    staff: config.notifications?.staff || false
                }
            };
            
            console.log('🔍 Diagnóstico da Integração Discord:', diagnostics);
            
            let message = '🔍 DIAGNÓSTICO DA INTEGRAÇÃO DISCORD\n\n';
            message += `Status: ${diagnostics.enabled ? '✅ ATIVO' : '❌ INATIVO'}\n\n`;
            message += 'Webhooks Configurados:\n';
            message += `  • Principal: ${diagnostics.hasMainWebhook ? '✅' : '❌'}\n`;
            message += `  • Tickets: ${diagnostics.hasTicketsWebhook ? '✅' : '❌'}\n`;
            message += `  • Eventos: ${diagnostics.hasEventsWebhook ? '✅' : '❌'}\n`;
            message += `  • Logs: ${diagnostics.hasLogsWebhook ? '✅' : '❌'}\n\n`;
            message += 'Notificações Ativas:\n';
            Object.keys(diagnostics.notificationsEnabled).forEach(key => {
                const status = diagnostics.notificationsEnabled[key] ? '✅' : '❌';
                message += `  • ${key}: ${status}\n`;
            });
            
            if (!diagnostics.enabled) {
                message += '\n⚠️ A integração está DESATIVADA. Ative no painel de configurações.';
            } else if (!diagnostics.hasMainWebhook) {
                message += '\n⚠️ Webhook principal não configurado. Configure um webhook para receber notificações.';
            } else {
                message += '\n✅ Configuração parece correta!';
            }
            
            alert(message);
            return diagnostics;
        }

        function sendDiscordWebhook(webhookUrl, data) {
            // Validar e sanitizar dados antes de enviar
            try {
                // Validar webhook URL
                if (!webhookUrl || typeof webhookUrl !== 'string' || !webhookUrl.startsWith('https://discord.com/api/webhooks/')) {
                    console.error('Webhook URL inválida:', webhookUrl);
                    return;
                }
                
                // Sanitizar dados
                const sanitizedData = {
                    username: (data.username || 'TXD Staff Bot').substring(0, 80), // Max 80 chars
                    avatar_url: data.avatar_url || 'https://i.imgur.com/4M34hi2.png',
                    embeds: (data.embeds || []).map(embed => {
                        // Limites do Discord:
                        // title: 256 chars
                        // description: 4096 chars
                        // field name: 256 chars
                        // field value: 1024 chars
                        // total embed: 6000 chars
                        
                        const sanitizedEmbed = {
                            color: embed.color || 5814783,
                            fields: (embed.fields || []).slice(0, 25).map(field => ({
                                name: field.name ? String(field.name).substring(0, 256) : '\u200b', // Zero-width space se vazio
                                value: field.value ? String(field.value).substring(0, 1024) : '\u200b',
                                inline: field.inline === true || field.inline === false ? field.inline : false
                            })),
                            footer: {
                                text: String(embed.footer?.text || 'TXD Staff System').substring(0, 2048)
                            },
                            timestamp: embed.timestamp || new Date().toISOString()
                        };
                        
                        // Adicionar title apenas se existir e não for vazio
                        if (embed.title && String(embed.title).trim() !== '') {
                            sanitizedEmbed.title = String(embed.title).substring(0, 256);
                        }
                        
                        // Adicionar description apenas se existir e não for vazio
                        if (embed.description && String(embed.description).trim() !== '') {
                            sanitizedEmbed.description = String(embed.description).substring(0, 4096);
                        }
                        
                        // Garantir que pelo menos title OU description exista
                        if (!sanitizedEmbed.title && !sanitizedEmbed.description) {
                            sanitizedEmbed.title = 'Notificação do Sistema';
                        }
                        
                        return sanitizedEmbed;
                    })
                };
                
                // Remover campos vazios
                if (!sanitizedData.embeds || sanitizedData.embeds.length === 0) {
                    console.error('Nenhum embed válido para enviar');
                    return;
                }
                
                console.log('Enviando para Discord:', {
                    url: webhookUrl.substring(0, 50) + '...',
                    embedTitle: sanitizedData.embeds[0]?.title,
                    embedDescription: sanitizedData.embeds[0]?.description?.substring(0, 50) + '...'
                });
                
                fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(sanitizedData)
                })
                .then(response => {
                    if (response.ok) {
                        console.log('✅ Mensagem enviada com sucesso para o Discord!');
                        return response.json();
                    } else {
                        // Tentar ler resposta de erro
                        return response.text().then(text => {
                            console.error('❌ Erro ao enviar mensagem Discord:', {
                                status: response.status,
                                statusText: response.statusText,
                                body: text
                            });
                            throw new Error(`Discord retornou erro ${response.status}: ${text}`);
                        });
                    }
                })
                .then(data => {
                    if (data) {
                        console.log('✅ Resposta do Discord:', data);
                    }
                })
                .catch(error => {
                    console.error('❌ Erro ao conectar com Discord:', {
                        message: error.message,
                        stack: error.stack
                    });
                });
            } catch (error) {
                console.error('❌ Erro ao processar dados do Discord:', error);
            }
        }

        function sendDiscordNotification(type, title, description, fields = []) {
            try {
                // Sempre buscar a configuração mais recente
                const currentConfig = getDiscordConfig();
                
                if (!currentConfig || !currentConfig.enabled) {
                    // Discord desabilitado - não fazer nada, não logar
                    return;
                }
                
                if (!currentConfig.notifications || !currentConfig.notifications[type]) {
                    // Tipo de notificação desabilitado - não fazer nada, não logar
                    return;
                }
                
                let webhookUrl = currentConfig.webhooks.main;
                
                // Usar webhook específico se configurado
                if (type === 'tickets' && currentConfig.webhooks.tickets) {
                    webhookUrl = currentConfig.webhooks.tickets;
                } else if (type === 'events' && currentConfig.webhooks.events) {
                    webhookUrl = currentConfig.webhooks.events;
                } else if (type === 'logs' && currentConfig.webhooks.logs) {
                    webhookUrl = currentConfig.webhooks.logs;
                }
                
                if (!webhookUrl || webhookUrl.trim() === '') {
                    console.log('Webhook URL não configurada para o tipo:', type);
                    return;
                }
                
                console.log('Enviando notificação Discord:', { type, title, webhookUrl: webhookUrl.substring(0, 50) + '...' });
                
                const colors = {
                    chat: 5793266, // Azul
                    tasks: 5814783, // Verde
                    tickets: 16776960, // Amarelo
                    events: 10181046, // Roxo
                    achievements: 16763904, // Laranja
                    staff: 15277667 // Vermelho claro
                };
                
                // Sanitizar campos - garantir que não sejam undefined/null
                const sanitizedFields = (fields || []).map(field => ({
                    name: field.name ? String(field.name) : 'Campo',
                    value: field.value ? String(field.value) : 'N/A',
                    inline: field.inline === true || field.inline === false ? field.inline : false
                }));
                
                const embed = {
                    title: title ? String(title) : 'Notificação',
                    description: description ? String(description) : 'Ação realizada no sistema',
                    color: colors[type] || 5814783,
                    fields: sanitizedFields,
                    footer: {
                        text: 'TXD Staff System'
                    },
                    timestamp: new Date().toISOString()
                };
                
                sendDiscordWebhook(webhookUrl, {
                    username: 'TXD Staff Bot',
                    avatar_url: 'https://i.imgur.com/4M34hi2.png',
                    embeds: [embed]
                });
            } catch (error) {
                console.error('Erro ao enviar notificação Discord:', error);
            }
        }

        // ========== COMANDOS DO DISCORD PARA O SISTEMA ==========
        
        function toggleDiscordCommands() {
            discordConfig = getDiscordConfig();
            discordConfig.commandsEnabled = !discordConfig.commandsEnabled;
            saveDiscordConfig();
            loadSettings();
        }
        
        function saveDiscordCommandsWebhook(url) {
            discordConfig = getDiscordConfig();
            discordConfig.commandsWebhook = url;
            saveDiscordConfig();
        }
        
        function loadDiscordCommandsLog() {
            const logsRaw = getData('txd_discord_commands_log');
            const logs = Array.isArray(logsRaw) ? logsRaw : [];
            if (logs.length === 0) {
                return '<div style="color: var(--gray-text); font-style: italic;">Nenhum comando recebido ainda.</div>';
            }
            return logs.slice(-10).reverse().map(log => {
                const time = new Date(log.timestamp).toLocaleString('pt-BR');
                const status = log.success ? '✅' : '❌';
                return `<div style="margin-bottom: 8px; padding: 8px; background: var(--gray-dark); border-radius: 4px; border-left: 3px solid ${log.success ? 'var(--success)' : 'var(--danger)'};">
                    ${status} <strong>${log.command}</strong> - ${log.message}<br>
                    <span style="color: var(--gray-text); font-size: 10px;">${time}</span>
                </div>`;
            }).join('');
        }
        
        function clearDiscordCommandsLog() {
            if (confirm('Deseja limpar o log de comandos?')) {
                saveData('txd_discord_commands_log', []);
                loadSettings();
            }
        }
        
        function addDiscordCommandLog(command, message, success = true) {
            const logs = getData('txd_discord_commands_log') || [];
            logs.push({
                command: command,
                message: message,
                success: success,
                timestamp: new Date().toISOString()
            });
            // Manter apenas últimos 50 logs
            if (logs.length > 50) {
                logs.shift();
            }
            saveData('txd_discord_commands_log', logs);
        }
        
        function processDiscordCommand(commandText, authorName = 'Discord') {
            try {
                if (!discordConfig || !discordConfig.commandsEnabled) {
                    return { success: false, message: 'Comandos do Discord estão desativados' };
                }
                
                const parts = commandText.trim().split(/\s+/);
                const command = parts[0].toLowerCase();
                const args = parts.slice(1);
                
                console.log('Processando comando Discord:', command, args);
                
                switch (command) {
                    case '!tarefa':
                    case '!task':
                        return processTaskCommand(args, authorName);
                    
                    case '!evento':
                    case '!event':
                        return processEventCommand(args, authorName);
                    
                    case '!staff':
                        return processStaffCommand(args, authorName);
                    
                    case '!ticket':
                        return processTicketCommand(args, authorName);
                    
                    case '!status':
                        return processStatusCommand(args, authorName);
                    
                    default:
                        return { success: false, message: `Comando desconhecido: ${command}. Use !tarefa, !evento, !staff, !ticket ou !status` };
                }
            } catch (error) {
                console.error('Erro ao processar comando:', error);
                return { success: false, message: 'Erro ao processar comando: ' + error.message };
            }
        }
        
        function processTaskCommand(args, authorName) {
            if (args.length < 2 || args[0] !== 'criar') {
                return { success: false, message: 'Uso: !tarefa criar "Título" | descrição | prioridade | responsável' };
            }
            
            // Parse: criar "Título" | descrição | prioridade | responsável
            const text = args.slice(1).join(' ');
            const parts = text.split('|').map(p => p.trim());
            
            if (parts.length < 1) {
                return { success: false, message: 'Título é obrigatório' };
            }
            
            const title = parts[0].replace(/^"|"$/g, ''); // Remove aspas
            const description = parts[1] || '';
            const priority = parts[2] || 'medium';
            const assignee = parts[3] || authorName;
            
            // Criar tarefa
            let kanbanData = getKanbanData();
            const newCard = {
                id: Date.now(),
                columnId: 'todo',
                title: title,
                description: description,
                priority: priority.toLowerCase(),
                dueDate: '',
                assignee: assignee,
                tags: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            kanbanData.cards.push(newCard);
            saveKanbanData(kanbanData);
            
            // Recarregar Kanban se estiver na página
            if (document.getElementById('sectionTitle')?.textContent.includes('Tarefas')) {
                loadKanban();
            }
            
            addDiscordCommandLog('!tarefa', `Tarefa "${title}" criada com sucesso`, true);
            
            return { success: true, message: `Tarefa "${title}" criada com sucesso!` };
        }
        
        function processEventCommand(args, authorName) {
            if (args.length < 2 || args[0] !== 'criar') {
                return { success: false, message: 'Uso: !evento criar "Título" | data | hora | local' };
            }
            
            const text = args.slice(1).join(' ');
            const parts = text.split('|').map(p => p.trim());
            
            if (parts.length < 1) {
                return { success: false, message: 'Título é obrigatório' };
            }
            
            const title = parts[0].replace(/^"|"$/g, '');
            const date = parts[1] || new Date().toISOString().split('T')[0];
            const time = parts[2] || '18:00';
            const location = parts[3] || 'Discord';
            
            const newEvent = {
                id: Date.now(),
                title: title,
                description: `Evento criado via Discord por ${authorName}`,
                date: date,
                time: time,
                location: location,
                createdBy: authorName,
                createdAt: new Date().toISOString()
            };
            
            eventsData.push(newEvent);
            saveData('txd_events', eventsData);
            
            if (document.getElementById('sectionTitle')?.textContent.includes('Agenda')) {
                loadAgenda();
            }
            
            addDiscordCommandLog('!evento', `Evento "${title}" criado com sucesso`, true);
            
            return { success: true, message: `Evento "${title}" criado com sucesso!` };
        }
        
        function processStaffCommand(args, authorName) {
            if (args.length < 2 || args[0] !== 'adicionar') {
                return { success: false, message: 'Uso: !staff adicionar "Nome" | cargo | área' };
            }
            
            const text = args.slice(1).join(' ');
            const parts = text.split('|').map(p => p.trim());
            
            if (parts.length < 1) {
                return { success: false, message: 'Nome é obrigatório' };
            }
            
            const name = parts[0].replace(/^"|"$/g, '');
            const role = parts[1] || 'Staff';
            const area = parts[2] || 'Geral';
            
            const newStaff = {
                id: Date.now(),
                name: name,
                role: role,
                area: area,
                status: 'Ativo',
                email: ''
            };
            
            staffData.push(newStaff);
            saveData('txd_staff', staffData);
            
            if (document.getElementById('sectionTitle')?.textContent.includes('Staff')) {
                loadStaffControl();
            }
            
            addDiscordCommandLog('!staff', `Staff "${name}" adicionado com sucesso`, true);
            
            return { success: true, message: `Staff "${name}" adicionado com sucesso!` };
        }
        
        function processTicketCommand(args, authorName) {
            if (args.length < 2 || args[0] !== 'criar') {
                return { success: false, message: 'Uso: !ticket criar "Assunto" | descrição | prioridade' };
            }
            
            const text = args.slice(1).join(' ');
            const parts = text.split('|').map(p => p.trim());
            
            if (parts.length < 1) {
                return { success: false, message: 'Assunto é obrigatório' };
            }
            
            const subject = parts[0].replace(/^"|"$/g, '');
            const description = parts[1] || '';
            const priority = parts[2] || 'medium';
            
            // Criar ticket (assumindo que existe sistema de tickets)
            const newTicket = {
                id: Date.now(),
                subject: subject,
                description: description,
                priority: priority,
                status: 'Aberto',
                author: authorName,
                createdAt: new Date().toISOString()
            };
            
            // Salvar ticket (ajustar conforme estrutura real)
            let tickets = getData('txd_tickets') || [];
            tickets.push(newTicket);
            saveData('txd_tickets', tickets);
            
            addDiscordCommandLog('!ticket', `Ticket "${subject}" criado com sucesso`, true);
            
            return { success: true, message: `Ticket "${subject}" criado com sucesso!` };
        }
        
        function processStatusCommand(args, authorName) {
            if (args.length < 2) {
                return { success: false, message: 'Uso: !status tarefa ID | nova-coluna (ex: todo, inprogress, review, done)' };
            }
            
            const taskId = parseInt(args[0]);
            const newColumn = args[1];
            
            if (isNaN(taskId)) {
                return { success: false, message: 'ID da tarefa deve ser um número' };
            }
            
            const validColumns = ['todo', 'inprogress', 'review', 'done'];
            if (!validColumns.includes(newColumn)) {
                return { success: false, message: `Coluna inválida. Use: ${validColumns.join(', ')}` };
            }
            
            let kanbanData = getKanbanData();
            const card = kanbanData.cards.find(c => c.id === taskId);
            
            if (!card) {
                return { success: false, message: `Tarefa com ID ${taskId} não encontrada` };
            }
            
            card.columnId = newColumn;
            card.updatedAt = new Date().toISOString();
            saveKanbanData(kanbanData);
            
            if (document.getElementById('sectionTitle')?.textContent.includes('Tarefas')) {
                loadKanban();
            }
            
            addDiscordCommandLog('!status', `Tarefa ${taskId} movida para ${newColumn}`, true);
            
            return { success: true, message: `Tarefa ${taskId} movida para ${newColumn}!` };
        }
        
        function testDiscordCommand() {
            const testCommand = '!tarefa criar "Teste do Discord" | Descrição de teste | high | Sistema';
            const result = processDiscordCommand(testCommand, 'Sistema');
            
            if (result.success) {
                alert('✅ Comando testado com sucesso!\n\n' + result.message);
            } else {
                alert('❌ Erro ao testar comando:\n\n' + result.message);
            }
            
            loadSettings(); // Recarregar para atualizar log
        }
        
        function showDiscordCommandsHelp() {
            const helpText = `
📖 COMO CONFIGURAR COMANDOS DO DISCORD

OPÇÃO 1: Bot do Discord (Recomendado)
1. Crie um bot no Discord Developer Portal
2. Adicione o bot ao seu servidor
3. Configure o bot para escutar mensagens
4. Quando alguém digitar um comando, o bot deve:
   - Processar o comando
   - Chamar a função processDiscordCommand()
   - Ou enviar para um webhook reverso

OPÇÃO 2: Webhook Reverso
1. Configure um servidor que recebe webhooks do Discord
2. Quando receber mensagem com comando, processe
3. Envie resultado de volta para o Discord

COMANDOS DISPONÍVEIS:

!tarefa criar "Título" | descrição | prioridade | responsável
  Exemplo: !tarefa criar "Revisar código" | Revisar PR #123 | high | João

!evento criar "Título" | data | hora | local
  Exemplo: !evento criar "Reunião" | 2026-01-15 | 18:00 | Discord

!staff adicionar "Nome" | cargo | área
  Exemplo: !staff adicionar "Maria" | Moderador | Suporte

!ticket criar "Assunto" | descrição | prioridade
  Exemplo: !ticket criar "Bug no login" | Usuário não consegue fazer login | high

!status tarefa-ID | nova-coluna
  Exemplo: !status 1234567890 | inprogress
  Colunas: todo, inprogress, review, done

NOTA: Este sistema funciona localmente. Para usar com bot real,
você precisa de um servidor intermediário ou usar a função
processDiscordCommand() diretamente.
            `;
            
            alert(helpText);
        }
        
        // Verificar comandos periodicamente (simulação)
        // Em produção, isso seria feito por um bot do Discord
        setInterval(() => {
            if (discordConfig && discordConfig.commandsEnabled) {
                // Aqui você pode adicionar lógica para verificar comandos
                // Por exemplo, verificar um endpoint ou Supabase em tempo real
            }
        }, 5000); // Verifica a cada 5 segundos

        // ========== FUNÇÕES DE MODAIS ==========
        function openNewEvent() {
            if (!hasPermission('event.create')) {
                alert('Você não tem permissão para criar eventos.');
                return;
            }
            document.getElementById('eventId').value = '';
            document.getElementById('eventModalTitle').textContent = 'Novo Evento';
            document.getElementById('eventForm').reset();
            document.getElementById('eventModal').classList.add('active');
        }

        function openEditEvent(id) {
            if (!hasPermission('event.edit')) {
                alert('Você não tem permissão para editar eventos.');
                return;
            }
            // Garantir que eventsData é um array
            if (!Array.isArray(eventsData)) eventsData = [];
            const event = eventsData.find(e => e.id === id);
            if (event) {
                document.getElementById('eventId').value = event.id;
                document.getElementById('eventModalTitle').textContent = 'Editar Evento';
                document.getElementById('eventType').value = event.type;
                document.getElementById('eventTitle').value = event.title;
                document.getElementById('eventDateTime').value = event.datetime;
                document.getElementById('eventDescription').value = event.description || '';
                document.getElementById('eventModal').classList.add('active');
            }
        }

        function saveEvent(event) {
            event.preventDefault();
            if (!hasPermission('event.create') && !hasPermission('event.edit')) {
                alert('Você não tem permissão para esta ação.');
                return;
            }

            // Garantir que eventsData é um array
            if (!Array.isArray(eventsData)) eventsData = [];
            
            const eventData = {
                id: document.getElementById('eventId').value || Date.now(),
                type: document.getElementById('eventType').value,
                title: document.getElementById('eventTitle').value,
                datetime: document.getElementById('eventDateTime').value,
                description: document.getElementById('eventDescription').value,
                createdAt: new Date().toISOString()
            };

            if (eventData.id && eventsData.find(e => e.id == eventData.id)) {
                // Editar
                const index = eventsData.findIndex(e => e.id == eventData.id);
                eventsData[index] = eventData;
            } else {
                // Novo
                eventsData.push(eventData);
            }

            saveData('txd_events', eventsData);
            
            // Notificar Discord
            if (eventData.id && eventsData.find(e => e.id == eventData.id)) {
                // Evento editado
                sendDiscordNotification('events', '📝 Evento Atualizado', `O evento "${eventData.title}" foi atualizado`, [
                    { name: '📅 Data', value: new Date(eventData.datetime).toLocaleDateString('pt-BR'), inline: true },
                    { name: '🕒 Hora', value: new Date(eventData.datetime).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}), inline: true },
                    { name: '📝 Tipo', value: eventData.type === 'event' ? 'Evento' : eventData.type === 'meeting' ? 'Reunião' : 'Treinamento', inline: true }
                ]);
            } else {
                // Evento novo
                sendDiscordNotification('events', '🎉 Novo Evento Criado', `"${eventData.title}" foi agendado!`, [
                    { name: '📅 Data', value: new Date(eventData.datetime).toLocaleDateString('pt-BR'), inline: true },
                    { name: '🕒 Hora', value: new Date(eventData.datetime).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}), inline: true },
                    { name: '📝 Tipo', value: eventData.type === 'event' ? 'Evento' : eventData.type === 'meeting' ? 'Reunião' : 'Treinamento', inline: true },
                    { name: '👤 Criado por', value: currentUser.displayName, inline: true }
                ]);
            }
            
            closeModal('eventModal');
            loadAgenda();
            if (document.getElementById('sectionTitle').textContent === 'Dashboard') {
                loadDashboard();
            }
            alert('Evento salvo com sucesso!');
        }

        function openAnnouncement() {
            if (!hasPermission('announcement.create')) {
                alert('Você não tem permissão para enviar avisos.');
                return;
            }
            document.getElementById('announcementForm').reset();
            document.getElementById('announcementModal').classList.add('active');
        }

        function saveAnnouncement(event) {
            event.preventDefault();
            if (!hasPermission('announcement.create')) {
                alert('Você não tem permissão para esta ação.');
                return;
            }

            const announcement = {
                id: Date.now(),
                title: document.getElementById('announcementTitle').value,
                priority: document.getElementById('announcementPriority').value,
                message: document.getElementById('announcementMessage').value,
                author: currentUser.name,
                createdAt: new Date().toISOString()
            };

            announcementsData.push(announcement);
            saveData('txd_announcements', announcementsData);
            closeModal('announcementModal');
            alert('Aviso enviado com sucesso!');
        }

        function openNewStaff() {
            if (!hasPermission('staff.create')) {
                alert('Você não tem permissão para adicionar membros.');
                return;
            }
            document.getElementById('staffId').value = '';
            document.getElementById('staffModalTitle').textContent = 'Adicionar Membro';
            document.getElementById('staffForm').reset();
            // Mostrar campos de login e senha para novo cadastro
            document.getElementById('staffLoginGroup').style.display = 'block';
            document.getElementById('staffPasswordGroup').style.display = 'block';
            document.getElementById('staffLogin').required = true;
            document.getElementById('staffPassword').required = true;
            document.getElementById('staffModal').classList.add('active');
        }

        function editStaff(id) {
            if (!hasPermission('staff.edit')) {
                alert('Você não tem permissão para editar membros.');
                return;
            }
            const member = staffData.find(s => s.id === id);
            if (member) {
                document.getElementById('staffId').value = member.id;
                document.getElementById('staffModalTitle').textContent = 'Editar Membro';
                document.getElementById('staffName').value = member.name;
                document.getElementById('staffRole').value = member.role;
                document.getElementById('staffArea').value = member.area;
                document.getElementById('staffStatus').value = member.status;
                document.getElementById('staffEmail').value = member.email || '';
                // Esconder campos de login e senha na edição (mudar no perfil)
                document.getElementById('staffLoginGroup').style.display = 'none';
                document.getElementById('staffPasswordGroup').style.display = 'none';
                document.getElementById('staffLogin').required = false;
                document.getElementById('staffPassword').required = false;
                document.getElementById('staffModal').classList.add('active');
            }
        }

        function saveStaff(event) {
            event.preventDefault();
            const isEdit = document.getElementById('staffId').value;
            
            if (isEdit && !hasPermission('staff.edit')) {
                alert('Você não tem permissão para editar membros.');
                return;
            }
            if (!isEdit && !hasPermission('staff.create')) {
                alert('Você não tem permissão para adicionar membros.');
                return;
            }

            // Validar login e senha para novo cadastro
            if (!isEdit) {
                const login = document.getElementById('staffLogin').value.trim();
                const password = document.getElementById('staffPassword').value;
                
                if (!login || !password) {
                    alert('Login e senha são obrigatórios para novo cadastro.');
                    return;
                }
                
                if (password.length < 4) {
                    alert('A senha deve ter pelo menos 4 caracteres.');
                    return;
                }
                
                // Verificar se o login já existe
                const existingStaff = getData('txd_staff') || [];
                if (Array.isArray(existingStaff) && existingStaff.some(s => s && (s.name === login || s.login === login))) {
                    alert('Este login já está em uso. Escolha outro.');
                    return;
                }
            }
            
            const staffMember = {
                id: isEdit ? parseInt(isEdit) : Date.now(),
                name: document.getElementById('staffName').value,
                role: document.getElementById('staffRole').value,
                area: document.getElementById('staffArea').value,
                status: document.getElementById('staffStatus').value,
                email: document.getElementById('staffEmail').value
            };
            
            // Adicionar login e senha apenas para novo cadastro
            if (!isEdit) {
                staffMember.login = document.getElementById('staffLogin').value.trim();
                staffMember.password = document.getElementById('staffPassword').value;
                staffMember.displayName = staffMember.name;
                staffMember.createdAt = new Date().toISOString();
                staffMember.status = 'Ativo';
            }

            if (isEdit) {
                const index = staffData.findIndex(s => s.id === staffMember.id);
                if (index !== -1) {
                    staffData[index] = staffMember;
                }
                
                // Notificar Discord sobre edição
                sendDiscordNotification('staff', '✏️ Staff Editado', 
                    `${currentUser.name} editou informações de um membro`,
                    [
                        { name: '👤 Membro', value: staffMember.name, inline: true },
                        { name: '🎖️ Cargo', value: staffMember.role, inline: true },
                        { name: '📊 Status', value: staffMember.status, inline: true },
                        { name: '🏢 Área', value: staffMember.area, inline: false },
                        { name: '👨‍💼 Editado por', value: currentUser.name, inline: false }
                    ]
                );
            } else {
                staffData.push(staffMember);
                
                // Notificar Discord sobre novo membro
                sendDiscordNotification('staff', '✨ Novo Membro Adicionado', 
                    `${currentUser.name} adicionou um novo membro à equipe`,
                    [
                        { name: '👤 Nome', value: staffMember.name, inline: true },
                        { name: '🎖️ Cargo', value: staffMember.role, inline: true },
                        { name: '📊 Status', value: staffMember.status, inline: true },
                        { name: '🏢 Área', value: staffMember.area, inline: false },
                        { name: '📧 E-mail', value: staffMember.email, inline: false },
                        { name: '👨‍💼 Adicionado por', value: currentUser.name, inline: false }
                    ]
                );
            }

            saveData('txd_staff', staffData);
            closeModal('staffModal');
            loadStaffControl();
            if (document.getElementById('sectionTitle').textContent === 'Dashboard') {
                loadDashboard();
            }
            alert('Membro salvo com sucesso!');
        }

        let deleteItemId = null;
        let deleteItemType = null;

        function deleteStaff(id) {
            if (!hasPermission('staff.delete')) {
                alert('Você não tem permissão para excluir membros.');
                return;
            }
            const member = staffData.find(s => s.id === id);
            if (member) {
                deleteItemId = id;
                deleteItemType = 'staff';
                document.getElementById('deleteMessage').textContent = `Tem certeza que deseja excluir ${member.name}? Esta ação não pode ser desfeita.`;
                document.getElementById('deleteModal').classList.add('active');
            }
        }

        function deleteEvent(id) {
            if (!hasPermission('event.delete')) {
                alert('Você não tem permissão para excluir eventos.');
                return;
            }
            // Garantir que eventsData é um array
            if (!Array.isArray(eventsData)) eventsData = [];
            const event = eventsData.find(e => e.id === id);
            if (event) {
                deleteItemId = id;
                deleteItemType = 'event';
                document.getElementById('deleteMessage').textContent = `Tem certeza que deseja excluir o evento "${event.title}"? Esta ação não pode ser desfeita.`;
                document.getElementById('deleteModal').classList.add('active');
            }
        }

        function confirmDelete() {
            if (deleteItemType === 'staff') {
                const deletedMember = staffData.find(s => s.id === deleteItemId);
                staffData = staffData.filter(s => s.id !== deleteItemId);
                saveData('txd_staff', staffData);
                loadStaffControl();
                
                // Notificar Discord sobre exclusão
                if (deletedMember) {
                    sendDiscordNotification('staff', '❌ Staff Removido', 
                        `${currentUser.name} removeu um membro da equipe`,
                        [
                            { name: '👤 Membro Removido', value: deletedMember.name, inline: true },
                            { name: '🎖️ Cargo', value: deletedMember.role, inline: true },
                            { name: '👨‍💼 Removido por', value: currentUser.name, inline: false },
                            { name: '🕐 Horário', value: new Date().toLocaleString('pt-BR'), inline: false }
                        ]
                    );
                }
            } else if (deleteItemType === 'event') {
                // Garantir que eventsData é um array
                if (!Array.isArray(eventsData)) eventsData = [];
                const deletedEvent = eventsData.find(e => e.id === deleteItemId);
                eventsData = eventsData.filter(e => e.id !== deleteItemId);
                saveData('txd_events', eventsData);
                loadAgenda();
                
                // Notificar Discord sobre exclusão de evento
                if (deletedEvent) {
                    sendDiscordNotification('events', '❌ Evento Cancelado', 
                        `${currentUser.name} cancelou um evento`,
                        [
                            { name: '📅 Evento', value: deletedEvent.title, inline: false },
                            { name: '📝 Descrição', value: deletedEvent.description || 'Sem descrição', inline: false },
                            { name: '👨‍💼 Cancelado por', value: currentUser.name, inline: false },
                            { name: '🕐 Horário', value: new Date().toLocaleString('pt-BR'), inline: false }
                        ]
                    );
                }
            }
            closeModal('deleteModal');
            deleteItemId = null;
            deleteItemType = null;
            alert('Item excluído com sucesso!');
        }

        function openAssignFunctions() {
            alert('Funcionalidade de atribuir funções será implementada em breve.');
        }

        function syncSystem() {
            if (!hasPermission('all')) {
                alert('Apenas administradores podem sincronizar o sistema.');
                return;
            }
            if (confirm('Deseja sincronizar o sistema agora?')) {
                // Simular sincronização
                setTimeout(() => {
                    alert('Sistema sincronizado com sucesso!');
                }, 1000);
            }
        }

        // ========== SISTEMA KANBAN ==========
        // Variáveis globais para drag and drop (declaradas mais abaixo)
        // let draggedCard = null;
        // let draggedCardElement = null;

        async function getKanbanData() {
            // Buscar dados do Supabase (forçar refresh)
            let data = await getData('txd_kanban', true);
            
            // Garantir estrutura correta
            if (!data || typeof data !== 'object' || !data.columns || !data.cards) {
                data = {
                    columns: [
                        { id: 'todo', name: 'Para Fazer', color: '#6F7276' },
                        { id: 'inprogress', name: 'Em Progresso', color: '#ffaa00' },
                        { id: 'review', name: 'Em Revisão', color: '#3b82f6' },
                        { id: 'done', name: 'Concluído', color: '#00ff88' }
                    ],
                    cards: [
                        {
                            id: 1,
                            columnId: 'done',
                            title: 'Implementar sistema de login',
                            description: 'Sistema completo com autenticação',
                            priority: 'high',
                            dueDate: new Date(Date.now() - 86400000).toISOString().split('T')[0],
                            assignee: '',
                            assignees: ['João Silva', 'Maria Santos'],
                            tags: ['desenvolvimento', 'backend'],
                            createdAt: new Date(Date.now() - 172800000).toISOString(),
                            updatedAt: new Date(Date.now() - 86400000).toISOString()
                        },
                        {
                            id: 2,
                            columnId: 'done',
                            title: 'Revisar documentação',
                            description: 'Atualizar docs do sistema',
                            priority: 'medium',
                            dueDate: new Date(Date.now() - 43200000).toISOString().split('T')[0],
                            assignee: '',
                            assignees: ['Pedro Costa'],
                            tags: ['documentação'],
                            createdAt: new Date(Date.now() - 259200000).toISOString(),
                            updatedAt: new Date(Date.now() - 43200000).toISOString()
                        },
                        {
                            id: 3,
                            columnId: 'done',
                            title: 'Configurar banco de dados',
                            description: 'Setup inicial do BD',
                            priority: 'high',
                            dueDate: new Date(Date.now() - 129600000).toISOString().split('T')[0],
                            assignee: '',
                            assignees: ['João Silva'],
                            tags: ['infraestrutura'],
                            createdAt: new Date(Date.now() - 345600000).toISOString(),
                            updatedAt: new Date(Date.now() - 129600000).toISOString()
                        },
                        {
                            id: 4,
                            columnId: 'inprogress',
                            title: 'Desenvolver módulo de chat',
                            description: 'Sistema de mensagens em tempo real',
                            priority: 'high',
                            dueDate: new Date(Date.now() + 86400000).toISOString().split('T')[0],
                            assignee: '',
                            assignees: ['Maria Santos'],
                            tags: ['desenvolvimento', 'frontend'],
                            createdAt: new Date(Date.now() - 86400000).toISOString(),
                            updatedAt: new Date().toISOString()
                        },
                        {
                            id: 5,
                            columnId: 'todo',
                            title: 'Implementar notificações',
                            description: 'Sistema de notificações push',
                            priority: 'medium',
                            dueDate: new Date(Date.now() + 172800000).toISOString().split('T')[0],
                            assignee: '',
                            assignees: ['Pedro Costa'],
                            tags: ['desenvolvimento'],
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        }
                    ]
                };
            }
            
            // Garantir que cards é sempre um array
            if (!Array.isArray(data.cards)) {
                data.cards = [];
            }
            
            // Garantir que columns é sempre um array
            if (!Array.isArray(data.columns)) {
                data.columns = [
                    { id: 'todo', name: 'Para Fazer', color: '#6F7276' },
                    { id: 'inprogress', name: 'Em Progresso', color: '#ffaa00' },
                    { id: 'review', name: 'Em Revisão', color: '#3b82f6' },
                    { id: 'done', name: 'Concluído', color: '#00ff88' }
                ];
            }
            
            return data;
        }

        async function saveKanbanData(data) {
            await saveData('txd_kanban', data);
        }

        function openNewCard(columnId = null) {
            // Permitir criação para qualquer usuário logado (Kanban deve ser acessível)
            // Se não tiver permissão específica, ainda permite criar
            const canCreate = hasPermission('task.create') || hasPermission('dashboard') || currentUser?.role;
            if (!canCreate) {
                alert('Você precisa estar logado para criar tarefas.');
                return;
            }
            
            // Garantir que os elementos existem
            const cardIdInput = document.getElementById('cardId');
            const cardModalTitle = document.getElementById('cardModalTitle');
            const cardColumnIdInput = document.getElementById('cardColumnId');
            const cardForm = document.getElementById('cardForm');
            const cardModal = document.getElementById('cardModal');
            
            if (!cardIdInput || !cardModalTitle || !cardColumnIdInput || !cardForm || !cardModal) {
                console.error('Elementos do modal de tarefa não encontrados');
                alert('Erro ao abrir modal de tarefa. Recarregue a página.');
                return;
            }
            
            cardIdInput.value = '';
            cardModalTitle.textContent = 'Nova Tarefa';
            cardColumnIdInput.value = columnId || 'todo';
            cardForm.reset();
            
            // Atualizar lista de responsáveis
            refreshData();
            const assigneeSelect = document.getElementById('cardAssignee');
            if (assigneeSelect) {
                // Garantir que staffData existe e é um array
                const staff = getData('txd_staff') || [];
                const staffArray = Array.isArray(staff) ? staff : [];
                
                assigneeSelect.innerHTML = '<option value="">Sem responsável</option>' + 
                    staffArray.map(m => {
                        if (m && m.name) {
                            return `<option value="${m.name}">${m.name}${m.role ? ' (' + m.role + ')' : ''}</option>`;
                        }
                        return '';
                    }).filter(opt => opt !== '').join('');
            }
            
            cardModal.classList.add('active');
        }

        function addCardToColumn(columnId) {
            openNewCard(columnId);
        }

        async function openEditCard(cardId) {
            // Permitir edição para qualquer usuário logado
            const canEdit = hasPermission('task.edit') || hasPermission('dashboard') || currentUser?.role;
            if (!canEdit) {
                alert('Você precisa estar logado para editar tarefas.');
                return;
            }
            const kanbanData = await getKanbanData();
            if (!kanbanData || !Array.isArray(kanbanData.cards)) {
                alert('Erro ao carregar dados do Kanban.');
                return;
            }
            
            const card = kanbanData.cards.find(c => c && c.id == cardId);
            if (!card) {
                alert('Tarefa não encontrada.');
                return;
            }
            
            // Garantir que os elementos existem
            const cardIdInput = document.getElementById('cardId');
            const cardModalTitle = document.getElementById('cardModalTitle');
            const cardColumnIdInput = document.getElementById('cardColumnId');
            const cardTitleInput = document.getElementById('cardTitle');
            const cardDescriptionInput = document.getElementById('cardDescription');
            const cardPriorityInput = document.getElementById('cardPriority');
            const cardDueDateInput = document.getElementById('cardDueDate');
            const cardAssigneeInput = document.getElementById('cardAssignee');
            const cardTagsInput = document.getElementById('cardTags');
            const cardModal = document.getElementById('cardModal');
            
            if (!cardIdInput || !cardModalTitle || !cardColumnIdInput || !cardTitleInput || !cardModal) {
                console.error('Elementos do modal de tarefa não encontrados');
                alert('Erro ao abrir modal de tarefa. Recarregue a página.');
                return;
            }
            
            cardIdInput.value = card.id;
            cardModalTitle.textContent = 'Editar Tarefa';
            cardColumnIdInput.value = card.columnId || 'todo';
            cardTitleInput.value = card.title || '';
            if (cardDescriptionInput) cardDescriptionInput.value = card.description || '';
            if (cardPriorityInput) cardPriorityInput.value = card.priority || '';
            if (cardDueDateInput) cardDueDateInput.value = card.dueDate || '';
            if (cardTagsInput) cardTagsInput.value = (card.tags && Array.isArray(card.tags)) ? card.tags.join(', ') : '';
            
            // Atualizar lista de responsáveis
            refreshData();
            const assigneeSelect = document.getElementById('cardAssignee');
            if (assigneeSelect) {
                // Garantir que staffData existe e é um array
                const staff = getData('txd_staff') || [];
                const staffArray = Array.isArray(staff) ? staff : [];
                
                assigneeSelect.innerHTML = '<option value="">Sem responsável</option>' + 
                    staffArray.map(m => {
                        if (m && m.name) {
                            return `<option value="${m.name}">${m.name}${m.role ? ' (' + m.role + ')' : ''}</option>`;
                        }
                        return '';
                    }).filter(opt => opt !== '').join('');
                assigneeSelect.value = card.assignee || '';
            }
            
            cardModal.classList.add('active');
        }

        async function saveCard(event) {
            event.preventDefault();
            
            try {
                const cardIdInput = document.getElementById('cardId');
                const cardColumnIdInput = document.getElementById('cardColumnId');
                const cardTitleInput = document.getElementById('cardTitle');
                const cardDescriptionInput = document.getElementById('cardDescription');
                const cardPriorityInput = document.getElementById('cardPriority');
                const cardDueDateInput = document.getElementById('cardDueDate');
                const cardAssigneeInput = document.getElementById('cardAssignee');
                const cardTagsInput = document.getElementById('cardTags');
                
                if (!cardIdInput || !cardColumnIdInput || !cardTitleInput) {
                    alert('Erro: Elementos do formulário não encontrados. Recarregue a página.');
                    return;
                }
                
                const cardId = cardIdInput.value;
                const isEdit = cardId && cardId !== '';
                
                // Verificar permissões (permitir para usuários logados)
                const canEdit = hasPermission('task.edit') || hasPermission('dashboard') || currentUser?.role;
                const canCreate = hasPermission('task.create') || hasPermission('dashboard') || currentUser?.role;
                
                if (isEdit && !canEdit) {
                    alert('Você não tem permissão para editar tarefas.');
                    return;
                }
                if (!isEdit && !canCreate) {
                    alert('Você não tem permissão para criar tarefas.');
                    return;
                }
                
                // Validar título (obrigatório)
                const title = cardTitleInput.value.trim();
                if (!title) {
                    alert('Por favor, preencha o título da tarefa.');
                    cardTitleInput.focus();
                    return;
                }
                
                let kanbanData = await getKanbanData();
                
                // Garantir estrutura correta
                if (!kanbanData) {
                    kanbanData = { columns: [], cards: [] };
                }
                if (!Array.isArray(kanbanData.cards)) {
                    kanbanData.cards = [];
                }
                if (!Array.isArray(kanbanData.columns)) {
                    kanbanData.columns = [
                        { id: 'todo', name: 'Para Fazer', color: '#6F7276' },
                        { id: 'inprogress', name: 'Em Progresso', color: '#ffaa00' },
                        { id: 'review', name: 'Em Revisão', color: '#3b82f6' },
                        { id: 'done', name: 'Concluído', color: '#00ff88' }
                    ];
                }
                
                const cardData = {
                    id: parseInt(cardId) || Date.now(),
                    columnId: cardColumnIdInput.value || 'todo',
                    title: title,
                    description: cardDescriptionInput ? cardDescriptionInput.value : '',
                    priority: cardPriorityInput ? cardPriorityInput.value : '',
                    assignee: cardAssigneeInput ? cardAssigneeInput.value : '',
                    tags: cardTagsInput ? cardTagsInput.value.split(',').map(t => t.trim()).filter(t => t) : [],
                    createdAt: isEdit ? (kanbanData.cards.find(c => c && c.id == cardId)?.createdAt || new Date().toISOString()) : new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // Adicionar dueDate apenas se tiver valor (campo opcional)
                if (cardDueDateInput && cardDueDateInput.value && cardDueDateInput.value.trim() !== '') {
                    cardData.dueDate = cardDueDateInput.value;
                }

            const existingIndex = kanbanData.cards.findIndex(c => c.id == cardData.id);
            if (existingIndex !== -1) {
                kanbanData.cards[existingIndex] = { ...kanbanData.cards[existingIndex], ...cardData };
                
                // Notificar Discord sobre edição de tarefa (apenas se Discord estiver habilitado)
                const discordConfig = getDiscordConfig();
                if (discordConfig && discordConfig.enabled && discordConfig.notifications && discordConfig.notifications.tasks) {
                const columnName = kanbanData.columns.find(col => col.id === cardData.columnId)?.name || cardData.columnId;
                sendDiscordNotification('tasks', '✏️ Tarefa Editada', 
                    `${currentUser.name} editou uma tarefa`,
                    [
                        { name: '📋 Tarefa', value: cardData.title, inline: false },
                        { name: '📝 Descrição', value: cardData.description || 'Sem descrição', inline: false },
                        { name: '📊 Coluna', value: columnName, inline: true },
                        { name: '⚡ Prioridade', value: cardData.priority === 'high' ? '🔴 Alta' : cardData.priority === 'medium' ? '🟡 Média' : '🟢 Baixa', inline: true },
                        { name: '📅 Prazo', value: cardData.dueDate || 'Sem prazo', inline: true },
                        { name: '👤 Responsável', value: cardData.assignee || 'Não atribuído', inline: true },
                        { name: '👨‍💼 Editado por', value: currentUser.name, inline: true }
                    ]
                );
                }
            } else {
                kanbanData.cards.push(cardData);
                
                // Notificar Discord sobre nova tarefa (apenas se Discord estiver habilitado)
                const discordConfig = getDiscordConfig();
                if (discordConfig && discordConfig.enabled && discordConfig.notifications && discordConfig.notifications.tasks) {
                    const columnName = kanbanData.columns.find(col => col.id === cardData.columnId)?.name || cardData.columnId;
                    sendDiscordNotification('tasks', '✨ Nova Tarefa Criada', 
                        `${currentUser.name} criou uma nova tarefa`,
                        [
                            { name: '📋 Tarefa', value: cardData.title, inline: false },
                            { name: '📝 Descrição', value: cardData.description || 'Sem descrição', inline: false },
                            { name: '📊 Coluna', value: columnName, inline: true },
                            { name: '⚡ Prioridade', value: cardData.priority === 'high' ? '🔴 Alta' : cardData.priority === 'medium' ? '🟡 Média' : '🟢 Baixa', inline: true },
                            { name: '📅 Prazo', value: cardData.dueDate || 'Sem prazo', inline: true },
                            { name: '👤 Responsável', value: cardData.assignee || 'Não atribuído', inline: true },
                            { name: '🏷️ Tags', value: cardData.tags.length > 0 ? cardData.tags.join(', ') : 'Sem tags', inline: false },
                            { name: '👨‍💼 Criado por', value: currentUser.name, inline: true }
                        ]
                    );
                }
            }

                await saveKanbanData(kanbanData);
                closeModal('cardModal');
                // NÃO recarregar imediatamente - deixar o real-time fazer isso
                // loadKanban();
                alert('Tarefa salva com sucesso!');
                
            } catch (error) {
                console.error('Erro ao salvar tarefa:', error);
                alert('Erro ao salvar tarefa: ' + (error.message || 'Erro desconhecido'));
            }
        }

        async function deleteCard(cardId) {
            // Permitir exclusão para usuários com permissão ou Owner/CEO
            const canDelete = hasPermission('task.delete') || currentUser?.role === 'Owner' || currentUser?.role === 'CEO';
            if (!canDelete) {
                alert('Você não tem permissão para excluir tarefas.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir esta tarefa?')) return;
            
            try {
                // Buscar dados da tarefa antes de deletar (para notificação)
                let kanbanData = await getKanbanData();
                const deletedCard = kanbanData.cards?.find(c => c && (c.id == cardId || c.id === cardId));
                
                // Deletar assignees primeiro (cascade)
                if (supabaseClient) {
                    const { error: deleteAssigneesError } = await supabaseClient
                        .from('kanban_card_assignees')
                        .delete()
                        .eq('card_id', cardId);
                    
                    if (deleteAssigneesError) {
                        console.warn('Aviso ao deletar assignees (pode ser normal):', deleteAssigneesError.message);
                    }
                }
                
                // Deletar o card diretamente do Supabase
                if (supabaseClient) {
                    const { error: deleteError } = await supabaseClient
                        .from('kanban_cards')
                        .delete()
                        .eq('id', cardId);
                    
                    if (deleteError) {
                        console.error('Erro ao deletar card do Supabase:', deleteError);
                        alert('Erro ao excluir tarefa: ' + (deleteError.message || 'Erro desconhecido'));
                        return;
                    }
                }
                
                // Limpar cache para forçar reload
                delete dataCache['txd_kanban'];
                
                // Remover visualmente o card com animação
                const cardElement = document.querySelector(`[data-card-id="${cardId}"]`);
                if (cardElement) {
                    cardElement.style.transition = 'all 0.3s ease';
                    cardElement.style.opacity = '0';
                    cardElement.style.transform = 'scale(0.8)';
                    setTimeout(() => {
                        if (cardElement.parentNode) {
                            cardElement.remove();
                        }
                    }, 300);
                }
                
                // Recarregar após um delay para garantir que o Supabase processou
                setTimeout(() => {
                    loadKanban();
                }, 500);
                
                // Notificar Discord sobre exclusão (apenas se Discord estiver habilitado)
                if (deletedCard) {
                    const discordConfig = getDiscordConfig();
                    if (discordConfig && discordConfig.enabled && discordConfig.notifications && discordConfig.notifications.tasks) {
                        sendDiscordNotification('tasks', '❌ Tarefa Excluída', 
                            `${currentUser?.name || 'Usuário'} excluiu uma tarefa`,
                            [
                                { name: '📋 Tarefa', value: deletedCard.title || 'Sem título', inline: false },
                                { name: '👨‍💼 Excluído por', value: currentUser?.name || 'Usuário', inline: true }
                            ]
                        );
                    }
                }
            } catch (error) {
                console.error('Erro ao excluir tarefa:', error);
                alert('Erro ao excluir tarefa: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Drag and Drop
        let draggedCard = null;
        let draggedCardElement = null;
        
        function handleDragStart(event) {
            // Encontrar o card correto (pode ser clicado em um elemento filho)
            const cardElement = event.target.closest('.kanban-card');
            if (!cardElement) {
                event.preventDefault();
                return;
            }
            
            draggedCard = cardElement;
            draggedCardElement = cardElement;
            cardElement.style.opacity = '0.5';
            cardElement.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', cardElement.outerHTML);
        }

        function handleDragEnd(event) {
            // Encontrar o card correto
            const cardElement = event.target.closest('.kanban-card') || event.target;
            if (cardElement) {
                cardElement.style.opacity = '1';
                cardElement.classList.remove('dragging');
            }
        }

        function initializeKanbanDragDrop() {
            // Limpar event listeners anteriores se existirem
            const existingColumns = document.querySelectorAll('.kanban-cards');
            existingColumns.forEach(column => {
                // Clonar elementos para remover event listeners antigos
                const newColumn = column.cloneNode(true);
                column.parentNode.replaceChild(newColumn, column);
            });
            
            // Buscar colunas novamente após clonar
            const columns = document.querySelectorAll('.kanban-cards');
            
            if (columns.length === 0) {
                console.warn('Nenhuma coluna Kanban encontrada para inicializar drag and drop');
                return;
            }
            
            columns.forEach(column => {
                column.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    column.classList.add('drag-over');
                    
                    const afterElement = getDragAfterElement(column, e.clientY);
                    const dragging = document.querySelector('.kanban-card.dragging');
                    if (dragging) {
                        if (afterElement == null) {
                            column.appendChild(dragging);
                        } else {
                            column.insertBefore(dragging, afterElement);
                        }
                    }
                });

                column.addEventListener('dragleave', () => {
                    column.classList.remove('drag-over');
                });

                column.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    column.classList.remove('drag-over');
                    
                    if (draggedCard) {
                        const cardId = parseInt(draggedCard.getAttribute('data-card-id'));
                        const newColumnId = column.getAttribute('data-column');
                        
                        const kanbanData = await getKanbanData();
                        if (!kanbanData || !Array.isArray(kanbanData.cards)) {
                            draggedCard = null;
                            draggedCardElement = null;
                            return;
                        }
                        const card = kanbanData.cards.find(c => c.id === cardId);
                        if (card) {
                            const oldColumnId = card.columnId;
                            const oldColumnName = kanbanData.columns.find(col => col.id === oldColumnId)?.name || oldColumnId;
                            const newColumnName = kanbanData.columns.find(col => col.id === newColumnId)?.name || newColumnId;
                            
                            card.columnId = newColumnId;
                            card.updatedAt = new Date().toISOString();
                            await saveKanbanData(kanbanData);
                            // NÃO recarregar imediatamente - deixar o real-time fazer isso
                            // loadKanban();
                            
                            // Notificar Discord sobre movimentação de tarefa (apenas se Discord estiver habilitado)
                            // Verificar ANTES de chamar getDiscordConfig para evitar logs desnecessários
                            if (oldColumnId !== newColumnId) {
                                // Verificar se Discord está habilitado sem chamar getDiscordConfig (que loga)
                                const storedConfig = getData('txd_discord_config');
                                if (storedConfig && storedConfig.enabled === true && storedConfig.notifications && storedConfig.notifications.tasks === true) {
                                    // Só chamar getDiscordConfig se realmente precisar enviar notificação
                                    const discordConfig = getDiscordConfig();
                                    if (discordConfig && discordConfig.enabled && discordConfig.notifications && discordConfig.notifications.tasks) {
                                        sendDiscordNotification('tasks', '🔄 Tarefa Movida', 
                                            `${currentUser.name} moveu uma tarefa`,
                                            [
                                                { name: '📋 Tarefa', value: card.title, inline: false },
                                                { name: '📤 De', value: oldColumnName, inline: true },
                                                { name: '📥 Para', value: newColumnName, inline: true },
                                                { name: '👤 Responsável', value: card.assignee || 'Não atribuído', inline: true },
                                                { name: '👨‍💼 Movido por', value: currentUser.name, inline: true },
                                                { name: '🕐 Horário', value: new Date().toLocaleString('pt-BR'), inline: true }
                                            ]
                                        );
                                    }
                                }
                            }
                        }
                        
                        draggedCard = null;
                        draggedCardElement = null;
                    }
                });
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.kanban-card:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // Fechar modal com ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });

        // Variável global para rastrear seção atual
        let currentSection = 'inicio';
        
        // Carregar dados do localStorage ao iniciar
        async function refreshData() {
            try {
                // Carregar todos os dados do Supabase (forçar refresh)
                const [staff, events, announcements, tickets, messages, groups, commands, favorites, usage, discord, requests, kanban] = await Promise.all([
                    getData('txd_staff', true),
                    getData('txd_events', true),
                    getData('txd_announcements', true),
                    getData('txd_tickets', true),
                    getData('txd_chat_messages', true),
                    getData('txd_chat_groups', true),
                    getData('txd_commands', true),
                    getData('txd_favorite_commands', true),
                    getData('txd_command_usage', true),
                    getData('txd_discord_config', true),
                    getData('txd_registration_requests', true),
                    getData('txd_kanban', true)
                ]);
                
                // Atualizar variáveis globais
                staffData = staff || staffData || [];
                eventsData = events || [];
                announcementsData = announcements || [];
                ticketsData = tickets || ticketsData || [];
                chatMessages = messages || [];
                chatGroups = groups || [];
                commandsData = commands || [];
                favoriteCommands = favorites || [];
                commandUsageStats = usage || {};
                discordConfig = discord || getDiscordConfig();
                
                updateChatNotificationBadge();
                
                // Inicializar real-time após primeiro carregamento
                if (!cacheInitialized && supabaseClient) {
                    initializeRealtime();
                    cacheInitialized = true;
                }
            } catch (error) {
                console.error('Erro ao atualizar dados:', error);
            }
        }

        function updateChatNotificationBadge() {
            if (!currentUser) return;
            
            // Garantir que chatMessages é um array
            const messages = Array.isArray(chatMessages) ? chatMessages : [];
            
            const totalUnread = messages.filter(msg => 
                msg.receiverId === currentUser.id && !msg.read
            ).length;
            
            const chatLink = document.querySelector('.nav-menu li a[onclick*="chat"]');
            if (chatLink) {
                // Remover badge anterior se existir
                const existingBadge = chatLink.querySelector('.notification-badge');
                if (existingBadge) {
                    existingBadge.remove();
                }
                
                // Adicionar novo badge se houver mensagens não lidas
                if (totalUnread > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'notification-badge';
                    badge.textContent = totalUnread > 99 ? '99+' : totalUnread;
                    chatLink.style.position = 'relative';
                    chatLink.appendChild(badge);
                }
            }
        }

        // Atualizar showSection para carregar conteúdo
        const originalShowSectionFunc = showSection;
        showSection = function(section) {
            if (originalShowSectionFunc) originalShowSectionFunc(section);
            refreshData();
            loadSectionContent(section);
        };

        // Inicializar
        refreshData();
        if (document.getElementById('dashboard').classList.contains('active')) {
            loadDashboard();
        } else {
            // Carregar conteúdo inicial se não estiver no dashboard
            const content = `
                <h1 id="sectionTitle">Bem-vindo ao Painel TXD Staff</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Selecione uma opção no menu para começar.</p>
            `;
            document.getElementById('mainContent').innerHTML = content;
        }
    </script>

</body>
</html>

