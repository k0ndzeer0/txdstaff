<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TXD Staff System - Painel Completo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Paleta de cores TXD */
            --black-deep: #0B0B0C;
            --black-dark: #1A1B1D;
            --gray-dark: #2A2C2F;
            --gray-medium: #3A3D41;
            --gray-border: #55585C;
            --gray-text: #6F7276;
            --gray-light: #9A9A9A;
            --gray-very-light: #CFCFCF;
            --white-soft: #F2F2F2;
            
            /* Cores de destaque - usando tons da paleta */
            --accent-primary: var(--gray-very-light);
            --accent-hover: var(--white-soft);
            --success: #00ff88;
            --danger: #ff3366;
            --warning: #ffaa00;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--black-deep);
            color: var(--white-soft);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Background com textura */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(135deg, var(--black-deep) 0%, var(--black-dark) 100%);
            z-index: -2;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(111, 114, 118, 0.03) 2px, rgba(111, 114, 118, 0.03) 4px);
            z-index: -1;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: var(--black-dark);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--gray-border);
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-text);
        }

        .hidden {
            display: none !important;
        }

        /* ========== LOGIN SCREEN ========== */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: rgba(26, 27, 29, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid var(--gray-border);
            border-radius: 24px;
            padding: 48px;
            max-width: 420px;
            width: 100%;
            text-align: center;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(122, 44, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-text {
            font-size: 42px;
            font-weight: 800;
            color: var(--white-soft);
            letter-spacing: -1px;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--gray-light);
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 40px;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--gray-medium);
            color: var(--white-soft);
            border: 1px solid var(--gray-border);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            background: var(--gray-border);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.4);
        }

        .btn-secondary {
            background: transparent;
            color: var(--gray-very-light);
            border: 1px solid var(--gray-border);
            margin-top: 12px;
        }

        .btn-secondary:hover {
            background: var(--gray-dark);
            border-color: var(--gray-text);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        }

        /* ========== MODALS ========== */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: rgba(26, 27, 29, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid var(--gray-border);
            border-radius: 24px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-lg {
            max-width: 900px;
        }

        .close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: var(--gray-text);
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            transition: all 0.3s ease;
        }

        .close:hover {
            background: var(--gray-medium);
            border-color: var(--gray-text);
            color: var(--white-soft);
        }

        .modal-header {
            margin-bottom: 24px;
            padding-right: 40px;
        }

        .modal-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--white-soft);
            margin-bottom: 8px;
        }

        .confidential-badge {
            background: rgba(255, 51, 102, 0.2);
            color: var(--danger);
            padding: 8px 16px;
            border-radius: 8px;
            display: inline-block;
            margin-bottom: 20px;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid rgba(255, 51, 102, 0.3);
        }

        .term-section {
            text-align: left;
            margin: 20px 0;
        }

        .term-section h4 {
            color: var(--gray-very-light);
            margin: 20px 0 12px;
            font-size: 16px;
            font-weight: 700;
        }

        .term-section p {
            line-height: 1.8;
            color: var(--gray-light);
            margin-bottom: 16px;
        }

        .term-section strong {
            color: var(--white-soft);
        }

        .highlight-danger {
            color: var(--danger);
            font-weight: 700;
        }

        /* ========== INPUTS ========== */
        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--white-soft);
            font-weight: 600;
            font-size: 14px;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 12px 16px;
            background: var(--gray-dark);
            border: 1px solid var(--gray-border);
            border-radius: 12px;
            color: var(--white-soft);
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .input-group input:focus,
        .input-group textarea:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--gray-text);
            background: var(--gray-medium);
            box-shadow: 0 0 0 3px rgba(111, 114, 118, 0.1);
        }

        .input-group input::placeholder,
        .input-group textarea::placeholder {
            color: var(--gray-text);
        }

        .input-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* ========== DASHBOARD ========== */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .navbar {
            background: rgba(26, 27, 29, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--gray-border);
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar-logo {
            font-size: 24px;
            font-weight: 800;
            color: var(--white-soft);
        }

        .nav-menu {
            display: flex;
            gap: 8px;
            list-style: none;
            flex-wrap: wrap;
        }

        .nav-menu li a {
            color: var(--gray-light);
            text-decoration: none;
            font-weight: 500;
            padding: 10px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .nav-menu li a:hover {
            color: var(--white-soft);
            background: var(--gray-dark);
        }

        .nav-menu li a.active {
            color: var(--white-soft);
            background: var(--gray-medium);
            border-bottom: 2px solid var(--gray-very-light);
        }

        .content-card {
            background: rgba(26, 27, 29, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid var(--gray-border);
            border-radius: 16px;
            padding: 32px;
            margin: 24px;
            transition: all 0.3s ease;
        }

        .content-card:hover {
            border-color: var(--gray-text);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .content-card h1 {
            color: var(--white-soft);
            margin-bottom: 12px;
            font-size: 32px;
            font-weight: 700;
        }

        .content-card p {
            color: var(--gray-light);
            margin-bottom: 24px;
        }

        .btn-modal {
            background: var(--gray-medium);
            color: var(--white-soft);
            border: 1px solid var(--gray-border);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .btn-modal:hover {
            transform: translateY(-2px);
            background: var(--gray-border);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #cc0000 100%);
        }

        .btn-danger:hover {
            box-shadow: 0 4px 16px rgba(255, 51, 102, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #00cc66 100%);
        }

        .btn-success:hover {
            box-shadow: 0 4px 16px rgba(0, 255, 136, 0.4);
        }

        /* Checkbox customizado */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--gray-dark);
            border: 1px dashed var(--gray-border);
            border-radius: 8px;
            margin: 20px 0;
        }

        .checkbox-container input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: var(--gray-text);
        }

        .checkbox-container label {
            color: var(--white-soft);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 0;
        }

        /* Kanban Styles */
        .kanban-column {
            transition: all 0.3s ease;
        }

        .kanban-column:hover {
            border-color: var(--gray-text);
        }

        .kanban-card {
            user-select: none;
        }

        .kanban-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .kanban-cards {
            transition: background-color 0.2s ease;
        }

        .kanban-cards.drag-over {
            background: rgba(111, 114, 118, 0.1);
            border-radius: 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-menu {
                display: none;
            }

            .content-card {
                margin: 16px;
                padding: 24px;
            }

            .modal-content {
                padding: 24px;
                width: 95%;
            }
        }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <div class="logo-text">TXD</div>
            <p class="subtitle">Staff System</p>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="input-group" style="margin-top: 0;">
                    <label>Usuário</label>
                    <input type="text" id="loginUsername" placeholder="Digite seu usuário" required>
                </div>
                <div class="input-group">
                    <label>Senha</label>
                    <input type="password" id="loginPassword" placeholder="Digite sua senha" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i>
                    Conectar
                </button>
            </form>
            <button class="btn btn-secondary" onclick="showRegister()">
                <i class="fas fa-user-plus"></i>
                Registre-se
            </button>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('registerModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> Criar Conta</h2>
            </div>
            <form id="registerForm">
                <div class="input-group">
                    <label>Usuário de Login</label>
                    <input type="text" placeholder="Ex: zayon.dev" required>
                </div>
                <div class="input-group">
                    <label>Nome de Exibição</label>
                    <input type="text" placeholder="Ex: Zayon" required>
                </div>
                <div class="input-group">
                    <label>Senha</label>
                    <input type="password" placeholder="••••••••" required>
                </div>
                <div class="input-group">
                    <label>Repetir Senha</label>
                    <input type="password" placeholder="••••••••" required>
                </div>
                <button type="button" class="btn btn-primary" onclick="showTerms()">Prosseguir</button>
            </form>
        </div>
    </div>

    <!-- Terms Modal -->
    <div id="termsModal" class="modal">
        <div class="modal-content modal-lg">
            <span class="close" onclick="closeModal('termsModal')">&times;</span>
            <div style="text-align: center; margin-bottom: 30px;">
                <span class="confidential-badge">CONFIDENCIAL</span>
                <h2 style="color: var(--white-soft); margin: 20px 0 10px;">TERMO DE CONFIDENCIALIDADE E SIGILO</h2>
                <p style="color: var(--gray-light); font-size: 14px; letter-spacing: 2px;">STAFF ACCESS</p>
            </div>

            <div class="term-section">
                <p>Este documento formaliza o acordo entre a <strong>SEEVEEN RP</strong> e o solicitante <strong>CANDIDATO</strong>. Ao prosseguir, você assume responsabilidade legal e administrativa sobre os dados acessados.</p>

                <h4>1. NATUREZA DAS INFORMAÇÕES</h4>
                <p>Todas as informações, logs, ferramentas, estratégias, dados de usuários (IP, IDs, Histórico) e discussões internas visualizadas neste painel são classificadas como <strong>ESTRITAMENTE CONFIDENCIAIS</strong>.</p>

                <h4>2. VEDAÇÃO TOTAL DE COMPARTILHAMENTO</h4>
                <p>É terminantemente proibido capturar tela (print), gravar, transmitir (stream) ou compartilhar verbalmente qualquer informação interna com jogadores, outras staffs ou terceiros. <span class="highlight-danger">A violação desta cláusula resultará em BANIMENTO PERMANENTE (Blacklist) e remoção imediata de todos os cargos.</span></p>

                <h4>3. SEGURANÇA DA CONTA</h4>
                <p>O acesso é <strong>INTRANSFERÍVEL</strong>. O titular da conta é o único responsável por qualquer ação realizada através de suas credenciais. O compartilhamento de senha caracteriza quebra de segurança grave.</p>

                <h4>4. DECLARAÇÃO DE CIÊNCIA</h4>
                <p>Declaro estar ciente de que minhas ações no painel são monitoradas e registradas (LOGS). O uso das ferramentas administrativas para benefício próprio ou de terceiros (Abuso de Poder) acarretará nas sanções máximas previstas nas regras da cidade.</p>

                <div class="checkbox-container">
                    <input type="checkbox" id="termAgree" onchange="toggleConfirmButton()">
                    <label for="termAgree">Li, compreendi e concordo integralmente com os termos deste documento oficial.</label>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button class="btn btn-secondary" onclick="closeModal('termsModal')" style="flex: 1;">RECUSAR</button>
                <button class="btn btn-primary" id="confirmTermBtn" onclick="acceptTerms()" disabled style="flex: 1;">CONFIRMAR REGISTRO</button>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <nav class="navbar">
            <div class="navbar-logo">TXD Staff</div>
            <ul class="nav-menu">
                <li><a href="#" onclick="showSection('inicio'); return false;" class="active">Início</a></li>
                <li><a href="#" onclick="showSection('tarefas'); return false;">Tarefas</a></li>
                <li><a href="#" onclick="showSection('comandos'); return false;">Comandos</a></li>
                <li><a href="#" onclick="showSection('controle'); return false;">Controle</a></li>
                <li><a href="#" onclick="showSection('areas'); return false;">Áreas</a></li>
                <li><a href="#" onclick="showSection('advertencias'); return false;">Advertências</a></li>
                <li><a href="#" onclick="showSection('agenda'); return false;">Agenda</a></li>
                <li><a href="#" onclick="showSection('formularios'); return false;">Formulários</a></li>
                <li><a href="#" onclick="showSection('relatorios'); return false;">Relatórios</a></li>
                <li><a href="#" onclick="showSection('config'); return false;">Configurações</a></li>
            </ul>
            <button class="btn btn-secondary" onclick="logout()" style="width: auto; padding: 10px 20px;">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </nav>

        <div class="content-card" id="mainContent">
            <h1 id="sectionTitle">Bem-vindo ao Painel TXD Staff</h1>
            <p style="color: var(--gray-light);">Selecione uma opção no menu para começar.</p>
        </div>
    </div>

    <!-- Modal: Novo Evento -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('eventModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-calendar-plus"></i> <span id="eventModalTitle">Novo Evento</span></h2>
            </div>
            <form id="eventForm" onsubmit="saveEvent(event)">
                <input type="hidden" id="eventId">
                <div class="input-group">
                    <label>Tipo</label>
                    <select id="eventType" required>
                        <option value="">Selecione...</option>
                        <option value="event">Evento</option>
                        <option value="meeting">Reunião</option>
                        <option value="training">Treinamento</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Título</label>
                    <input type="text" id="eventTitle" placeholder="Ex: Reunião Geral Mensal" required>
                </div>
                <div class="input-group">
                    <label>Data e Hora</label>
                    <input type="datetime-local" id="eventDateTime" required>
                </div>
                <div class="input-group">
                    <label>Descrição</label>
                    <textarea id="eventDescription" rows="4" placeholder="Descrição do evento..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('eventModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Enviar Aviso -->
    <div id="announcementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('announcementModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-bullhorn"></i> Enviar Aviso</h2>
            </div>
            <form id="announcementForm" onsubmit="saveAnnouncement(event)">
                <div class="input-group">
                    <label>Título do Aviso</label>
                    <input type="text" id="announcementTitle" placeholder="Ex: Reunião Geral Obrigatória" required>
                </div>
                <div class="input-group">
                    <label>Prioridade</label>
                    <select id="announcementPriority" required>
                        <option value="normal">Normal</option>
                        <option value="high">Alta</option>
                        <option value="urgent">Urgente</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Mensagem</label>
                    <textarea id="announcementMessage" rows="6" placeholder="Digite o conteúdo do aviso..." required></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('announcementModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Enviar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Adicionar/Editar Membro -->
    <div id="staffModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('staffModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> <span id="staffModalTitle">Adicionar Membro</span></h2>
            </div>
            <form id="staffForm" onsubmit="saveStaff(event)">
                <input type="hidden" id="staffId">
                <div class="input-group">
                    <label>Nome Completo</label>
                    <input type="text" id="staffName" placeholder="Ex: João Silva" required>
                </div>
                <div class="input-group">
                    <label>Cargo</label>
                    <select id="staffRole" required onchange="checkPermissions()">
                        <option value="">Selecione...</option>
                        <option value="Owner">Owner</option>
                        <option value="CEO">CEO</option>
                        <option value="COO">COO</option>
                        <option value="CMO">CMO</option>
                        <option value="CCO">CCO</option>
                        <option value="CIO">CIO</option>
                        <option value="Diretor">Diretor</option>
                        <option value="Head Staff">Head Staff</option>
                        <option value="Coordenador">Coordenador</option>
                        <option value="Admin">Admin</option>
                        <option value="Moderador">Moderador</option>
                        <option value="Suporte">Suporte</option>
                        <option value="Helper">Helper</option>
                        <option value="Dev">Dev</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Área de Responsabilidade</label>
                    <select id="staffArea" required>
                        <option value="">Selecione...</option>
                        <option value="Administração">Administração</option>
                        <option value="Atendimento">Atendimento</option>
                        <option value="Comunidade">Comunidade</option>
                        <option value="Desenvolvimento">Desenvolvimento</option>
                        <option value="Eventos">Eventos</option>
                        <option value="Financeiro">Financeiro</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Moderação">Moderação</option>
                        <option value="Recursos Humanos">Recursos Humanos</option>
                        <option value="Tecnologia">Tecnologia</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Status</label>
                    <select id="staffStatus" required>
                        <option value="Ativo">Ativo</option>
                        <option value="Ausente">Ausente</option>
                        <option value="Inativo">Inativo</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="staffEmail" placeholder="exemplo@email.com">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('staffModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Confirmar Exclusão -->
    <div id="deleteModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-triangle"></i> Confirmar Exclusão</h2>
            </div>
            <p style="color: var(--gray-light); margin-bottom: 24px;" id="deleteMessage"></p>
            <div style="display: flex; gap: 10px;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('deleteModal')" style="flex: 1;">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()" style="flex: 1;">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal: Nova/Editar Card Kanban -->
    <div id="cardModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('cardModal')">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-sticky-note"></i> <span id="cardModalTitle">Nova Tarefa</span></h2>
            </div>
            <form id="cardForm" onsubmit="saveCard(event)">
                <input type="hidden" id="cardId">
                <input type="hidden" id="cardColumnId">
                <div class="input-group">
                    <label>Título da Tarefa</label>
                    <input type="text" id="cardTitle" placeholder="Ex: Implementar sistema de login" required>
                </div>
                <div class="input-group">
                    <label>Descrição</label>
                    <textarea id="cardDescription" rows="4" placeholder="Descreva os detalhes da tarefa..."></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="input-group">
                        <label>Prioridade</label>
                        <select id="cardPriority">
                            <option value="">Sem prioridade</option>
                            <option value="low">Baixa</option>
                            <option value="medium">Média</option>
                            <option value="high">Alta</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Data de Vencimento</label>
                        <input type="date" id="cardDueDate">
                    </div>
                </div>
                <div class="input-group">
                    <label>Responsável</label>
                    <select id="cardAssignee">
                        <option value="">Sem responsável</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Tags (separadas por vírgula)</label>
                    <input type="text" id="cardTags" placeholder="Ex: urgente, frontend, bug">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('cardModal')" style="flex: 1;">Cancelar</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========== SISTEMA DE LOGIN ==========
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (username && password) {
                // Simular login (sem validação real por enquanto)
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                showSection('inicio');
            }
        }

        function showRegister() {
            document.getElementById('registerModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showTerms() {
            closeModal('registerModal');
            document.getElementById('termsModal').classList.add('active');
        }

        function toggleConfirmButton() {
            const checkbox = document.getElementById('termAgree');
            const confirmBtn = document.getElementById('confirmTermBtn');
            confirmBtn.disabled = !checkbox.checked;
        }

        function acceptTerms() {
            closeModal('termsModal');
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            showSection('inicio');
        }

        function logout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                document.getElementById('dashboard').classList.remove('active');
                document.getElementById('loginScreen').style.display = 'flex';
                // Limpar formulário
                document.getElementById('loginForm').reset();
            }
        }

        // ========== NAVEGAÇÃO ==========
        function showSection(section) {
            const titles = {
                'inicio': 'Início',
                'tarefas': 'Tarefas - Kanban',
                'comandos': 'Comandos',
                'controle': 'Controle de Staff',
                'areas': 'Áreas de Responsabilidade',
                'advertencias': 'Gestão de Advertências',
                'agenda': 'Agenda da Equipe',
                'formularios': 'Formulários Recebidos',
                'relatorios': 'Relatórios de Reunião',
                'config': 'Configurações do Sistema'
            };
            document.getElementById('sectionTitle').textContent = titles[section] || 'Painel TXD Staff';
            
            // Atualizar menu ativo
            document.querySelectorAll('.nav-menu a').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(section)) {
                    link.classList.add('active');
                }
            });
        }

        // ========== FUNCIONALIDADES ==========
        
        // ========== SISTEMA COMPLETO DE PERMISSÕES POR CARGO ==========
        
        // Definição de todas as permissões disponíveis no sistema
        const ALL_PERMISSIONS = {
            // Staff Management
            'staff.view': 'Visualizar membros da staff',
            'staff.create': 'Adicionar novos membros',
            'staff.edit': 'Editar membros existentes',
            'staff.delete': 'Remover membros',
            'staff.manage_roles': 'Gerenciar cargos e hierarquia',
            
            // Tasks (Kanban)
            'task.view': 'Visualizar tarefas',
            'task.create': 'Criar novas tarefas',
            'task.edit': 'Editar tarefas existentes',
            'task.delete': 'Excluir tarefas',
            'task.assign': 'Atribuir tarefas a membros',
            
            // Events (Agenda)
            'event.view': 'Visualizar eventos',
            'event.create': 'Criar novos eventos',
            'event.edit': 'Editar eventos existentes',
            'event.delete': 'Excluir eventos',
            
            // Announcements
            'announcement.view': 'Visualizar avisos',
            'announcement.create': 'Criar avisos',
            'announcement.edit': 'Editar avisos',
            'announcement.delete': 'Excluir avisos',
            
            // Tickets & Support
            'ticket.view': 'Visualizar tickets',
            'ticket.create': 'Criar tickets',
            'ticket.edit': 'Editar tickets',
            'ticket.delete': 'Excluir tickets',
            'ticket.assign': 'Atribuir tickets',
            'ticket.resolve': 'Resolver tickets',
            
            // Warnings
            'warning.view': 'Visualizar advertências',
            'warning.create': 'Criar advertências',
            'warning.edit': 'Editar advertências',
            'warning.delete': 'Excluir advertências',
            
            // Reports
            'report.view': 'Visualizar relatórios',
            'report.create': 'Criar relatórios',
            'report.edit': 'Editar relatórios',
            'report.delete': 'Excluir relatórios',
            
            // Forms
            'form.view': 'Visualizar formulários',
            'form.review': 'Revisar formulários',
            'form.approve': 'Aprovar formulários',
            'form.reject': 'Rejeitar formulários',
            
            // Areas
            'area.view': 'Visualizar áreas',
            'area.create': 'Criar áreas',
            'area.edit': 'Editar áreas',
            'area.delete': 'Excluir áreas',
            
            // System
            'system.config': 'Acessar configurações do sistema',
            'system.sync': 'Sincronizar sistema',
            'system.logs': 'Visualizar logs do sistema',
            'system.backup': 'Fazer backup do sistema',
            
            // Permissions
            'permission.view': 'Visualizar permissões',
            'permission.manage': 'Gerenciar permissões de cargos',
            
            // Special
            'all': 'Acesso total ao sistema'
        };

        // Matriz de permissões por cargo
        const ROLE_PERMISSIONS = {
            'Owner': {
                permissions: ['all'],
                description: 'Acesso total ao sistema'
            },
            'CEO': {
                permissions: ['all'],
                description: 'Acesso total ao sistema'
            },
            'COO': {
                permissions: [
                    'staff.view', 'staff.create', 'staff.edit', 'staff.delete',
                    'task.view', 'task.create', 'task.edit', 'task.delete', 'task.assign',
                    'event.view', 'event.create', 'event.edit', 'event.delete',
                    'announcement.view', 'announcement.create', 'announcement.edit', 'announcement.delete',
                    'ticket.view', 'ticket.create', 'ticket.edit', 'ticket.assign', 'ticket.resolve',
                    'warning.view', 'warning.create', 'warning.edit',
                    'report.view', 'report.create', 'report.edit',
                    'form.view', 'form.review', 'form.approve', 'form.reject',
                    'area.view', 'area.create', 'area.edit',
                    'system.config', 'system.sync', 'permission.view'
                ],
                description: 'Acesso administrativo completo, exceto logs e backup'
            },
            'CMO': {
                permissions: [
                    'staff.view',
                    'task.view', 'task.create',
                    'event.view', 'event.create',
                    'announcement.view', 'announcement.create',
                    'ticket.view', 'ticket.create',
                    'report.view', 'report.create',
                    'form.view', 'form.review',
                    'area.view'
                ],
                description: 'Foco em comunicação e marketing'
            },
            'CCO': {
                permissions: [
                    'staff.view',
                    'task.view', 'task.create',
                    'event.view', 'event.create',
                    'announcement.view', 'announcement.create',
                    'ticket.view', 'ticket.create',
                    'report.view', 'report.create',
                    'form.view', 'form.review',
                    'area.view'
                ],
                description: 'Foco em comunidade e atendimento'
            },
            'CIO': {
                permissions: [
                    'staff.view',
                    'task.view', 'task.create',
                    'event.view', 'event.create',
                    'ticket.view', 'ticket.create',
                    'report.view',
                    'system.config', 'system.logs'
                ],
                description: 'Foco em tecnologia e sistemas'
            },
            'Diretor': {
                permissions: [
                    'staff.view', 'staff.edit',
                    'task.view', 'task.create', 'task.edit', 'task.delete', 'task.assign',
                    'event.view', 'event.create', 'event.edit', 'event.delete',
                    'announcement.view', 'announcement.create', 'announcement.edit',
                    'ticket.view', 'ticket.create', 'ticket.edit', 'ticket.assign', 'ticket.resolve',
                    'warning.view', 'warning.create', 'warning.edit',
                    'report.view', 'report.create', 'report.edit',
                    'form.view', 'form.review', 'form.approve', 'form.reject',
                    'area.view', 'area.create', 'area.edit'
                ],
                description: 'Acesso gerencial completo em sua área'
            },
            'Head Staff': {
                permissions: [
                    'staff.view', 'staff.edit',
                    'task.view', 'task.create', 'task.edit', 'task.delete', 'task.assign',
                    'event.view', 'event.create', 'event.edit',
                    'announcement.view', 'announcement.create',
                    'ticket.view', 'ticket.create', 'ticket.edit', 'ticket.assign', 'ticket.resolve',
                    'warning.view', 'warning.create', 'warning.edit',
                    'report.view', 'report.create',
                    'form.view', 'form.review',
                    'area.view'
                ],
                description: 'Liderança operacional da staff'
            },
            'Coordenador': {
                permissions: [
                    'staff.view',
                    'task.view', 'task.create',
                    'event.view', 'event.create',
                    'announcement.view', 'announcement.create',
                    'ticket.view', 'ticket.create', 'ticket.edit', 'ticket.resolve',
                    'warning.view', 'warning.create',
                    'report.view', 'report.create',
                    'form.view', 'form.review',
                    'area.view'
                ],
                description: 'Coordenação de equipes e processos'
            },
            'Admin': {
                permissions: [
                    'staff.view',
                    'task.view',
                    'event.view',
                    'announcement.view',
                    'ticket.view', 'ticket.create', 'ticket.edit', 'ticket.resolve',
                    'warning.view',
                    'report.view',
                    'form.view',
                    'area.view'
                ],
                description: 'Acesso administrativo básico'
            },
            'Moderador': {
                permissions: [
                    'staff.view',
                    'task.view',
                    'ticket.view', 'ticket.create', 'ticket.edit', 'ticket.resolve',
                    'warning.view', 'warning.create',
                    'form.view',
                    'area.view'
                ],
                description: 'Moderação e atendimento'
            },
            'Suporte': {
                permissions: [
                    'staff.view',
                    'task.view',
                    'ticket.view', 'ticket.create', 'ticket.edit', 'ticket.resolve',
                    'form.view',
                    'area.view'
                ],
                description: 'Atendimento e suporte'
            },
            'Helper': {
                permissions: [
                    'staff.view',
                    'task.view',
                    'ticket.view', 'ticket.create',
                    'form.view',
                    'area.view'
                ],
                description: 'Auxílio e suporte básico'
            },
            'Dev': {
                permissions: [
                    'staff.view',
                    'task.view', 'task.create',
                    'event.view',
                    'ticket.view', 'ticket.create',
                    'system.config', 'system.logs'
                ],
                description: 'Desenvolvimento e manutenção técnica'
            }
        };

        // Usuário atual (será definido no login)
        let currentUser = { role: 'Owner', name: 'Admin', id: 1 };

        // Função principal para verificar permissões
        function hasPermission(action) {
            if (!currentUser || !currentUser.role) {
                return false;
            }
            
            const roleData = ROLE_PERMISSIONS[currentUser.role];
            if (!roleData) {
                return false;
            }
            
            const userPermissions = roleData.permissions || [];
            
            // Se tem 'all', tem todas as permissões
            if (userPermissions.includes('all')) {
                return true;
            }
            
            return userPermissions.includes(action);
        }

        // Verificar múltiplas permissões (todas devem ser verdadeiras)
        function hasAllPermissions(...actions) {
            return actions.every(action => hasPermission(action));
        }

        // Verificar se tem pelo menos uma das permissões
        function hasAnyPermission(...actions) {
            return actions.some(action => hasPermission(action));
        }

        // Obter todas as permissões do cargo atual
        function getCurrentUserPermissions() {
            if (!currentUser || !currentUser.role) {
                return [];
            }
            
            const roleData = ROLE_PERMISSIONS[currentUser.role];
            return roleData ? roleData.permissions : [];
        }

        // Obter permissões de um cargo específico
        function getRolePermissions(role) {
            const roleData = ROLE_PERMISSIONS[role];
            return roleData ? roleData.permissions : [];
        }

        // Obter descrição de um cargo
        function getRoleDescription(role) {
            const roleData = ROLE_PERMISSIONS[role];
            return roleData ? roleData.description : 'Sem descrição';
        }

        // Verificar se pode executar ação e mostrar erro se não puder
        function requirePermission(action, errorMessage = 'Você não tem permissão para realizar esta ação.') {
            if (!hasPermission(action)) {
                alert(errorMessage);
                return false;
            }
            return true;
        }

        // Função para verificar permissões quando cargo muda
        function checkPermissions() {
            const role = document.getElementById('staffRole')?.value;
            if (role) {
                const rolePerms = getRolePermissions(role);
                const roleDesc = getRoleDescription(role);
                console.log(`Permissões do cargo ${role}:`, rolePerms);
                console.log(`Descrição: ${roleDesc}`);
            }
        }

        // ========== GERENCIAMENTO DE DADOS (LocalStorage) ==========
        function getData(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        }

        function saveData(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        // Inicializar dados
        let staffData = getData('txd_staff') || [
            { id: 1, name: 'João Silva', role: 'Owner', area: 'Administração', status: 'Ativo', email: 'joao@txd.com' },
            { id: 2, name: 'Maria Santos', role: 'CEO', area: 'Administração', status: 'Ativo', email: 'maria@txd.com' },
            { id: 3, name: 'Pedro Costa', role: 'Head Staff', area: 'Moderação', status: 'Ativo', email: 'pedro@txd.com' }
        ];

        let eventsData = getData('txd_events') || [];
        let announcementsData = getData('txd_announcements') || [];
        let ticketsData = getData('txd_tickets') || [
            { id: 1, title: 'Problema com banimento', type: 'Ticket', status: 'Em andamento', responsible: 'Ana Oliveira' },
            { id: 2, title: 'Dúvida sobre regras', type: 'Call', status: 'Aberto', responsible: 'Lucas Alves' }
        ];

        // Salvar dados iniciais se não existirem
        if (!localStorage.getItem('txd_staff')) {
            saveData('txd_staff', staffData);
        }

        // Função para carregar conteúdo das seções
        function loadSectionContent(section) {
            const contentCard = document.querySelector('.content-card');
            
            switch(section) {
                case 'inicio':
                    loadDashboard();
                    break;
                case 'tarefas':
                    loadKanban();
                    break;
                case 'controle':
                    loadStaffControl();
                    break;
                case 'comandos':
                    loadCommands();
                    break;
                case 'agenda':
                    loadAgenda();
                    break;
                case 'formularios':
                    loadForms();
                    break;
                case 'relatorios':
                    loadReports();
                    break;
                case 'advertencias':
                    loadWarnings();
                    break;
                case 'areas':
                    loadAreas();
                    break;
                case 'config':
                    loadSettings();
                    break;
            }
        }

        function loadDashboard() {
            refreshData();
            const content = `
                <h1 id="sectionTitle">Dashboard</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Visão geral do sistema</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Total de Staff</div>
                            <div class="stat-card-icon">👥</div>
                        </div>
                        <div class="stat-card-value">${staffData.length}</div>
                        <div class="stat-card-subtitle">Membros ativos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Tickets Abertos</div>
                            <div class="stat-card-icon">🎫</div>
                        </div>
                        <div class="stat-card-value">${ticketsData.filter(t => t.status === 'Aberto').length}</div>
                        <div class="stat-card-subtitle">Pendentes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Tickets Finalizados</div>
                            <div class="stat-card-icon">✅</div>
                        </div>
                        <div class="stat-card-value">${ticketsData.filter(t => t.status === 'Finalizado').length}</div>
                        <div class="stat-card-subtitle">Este mês</div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; display: flex; flex-wrap: wrap; gap: 12px;">
                    ${hasPermission('event.create') ? `
                    <button class="btn-modal btn-success" onclick="openNewEvent()">
                        <i class="fas fa-calendar-plus"></i> Novo Evento
                    </button>
                    ` : ''}
                    ${hasPermission('announcement.create') ? `
                    <button class="btn-modal" onclick="openAnnouncement()">
                        <i class="fas fa-bullhorn"></i> Enviar Aviso
                    </button>
                    ` : ''}
                    <button class="btn-modal" onclick="openAssignFunctions()">
                        <i class="fas fa-user-tag"></i> Atribuir Funções
                    </button>
                    ${hasPermission('all') ? `
                    <button class="btn-modal btn-danger" onclick="syncSystem()">
                        <i class="fas fa-sync"></i> Sincronizar Sistema
                    </button>
                    ` : ''}
                </div>
            `;
            document.querySelector('.content-card').innerHTML = content;
        }

        function loadKanban() {
            refreshData();
            let kanbanData = getKanbanData();
            
            const canCreate = hasPermission('task.create');
            const canEdit = hasPermission('task.edit');
            const canDelete = hasPermission('task.delete');
            
            const content = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h1 id="sectionTitle" style="margin-bottom: 8px;">Tarefas - Kanban</h1>
                        <p style="color: var(--gray-light);">Organize suas tarefas e projetos</p>
                    </div>
                    ${canCreate ? `
                    <button class="btn-modal btn-success" onclick="openNewCard()">
                        <i class="fas fa-plus"></i> Nova Tarefa
                    </button>
                    ` : ''}
                </div>
                
                <!-- Estatísticas Rápidas -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Total de Tarefas</div>
                            <div class="stat-card-icon">📋</div>
                        </div>
                        <div class="stat-card-value">${kanbanData.cards.length}</div>
                        <div class="stat-card-subtitle">Todas as tarefas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Para Fazer</div>
                            <div class="stat-card-icon">📝</div>
                        </div>
                        <div class="stat-card-value">${kanbanData.cards.filter(c => c.columnId === 'todo').length}</div>
                        <div class="stat-card-subtitle">Pendentes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Em Progresso</div>
                            <div class="stat-card-icon">⚙️</div>
                        </div>
                        <div class="stat-card-value">${kanbanData.cards.filter(c => c.columnId === 'inprogress').length}</div>
                        <div class="stat-card-subtitle">Em andamento</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Concluído</div>
                            <div class="stat-card-icon">✅</div>
                        </div>
                        <div class="stat-card-value">${kanbanData.cards.filter(c => c.columnId === 'done').length}</div>
                        <div class="stat-card-subtitle">Finalizadas</div>
                    </div>
                </div>
                
                <!-- Board Kanban -->
                <div id="kanbanBoard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 32px;">
                    ${kanbanData.columns.map(column => `
                        <div class="kanban-column" data-column-id="${column.id}" style="background: var(--gray-dark); border-radius: 12px; padding: 16px; min-height: 500px; border: 1px solid var(--gray-border);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid ${column.color};">
                                <h3 style="color: var(--white-soft); font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 12px; height: 12px; border-radius: 50%; background: ${column.color};"></span>
                                    ${column.name}
                                </h3>
                                <span style="background: ${column.color}20; color: ${column.color}; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                    ${kanbanData.cards.filter(c => c.columnId === column.id).length}
                                </span>
                            </div>
                            <div class="kanban-cards" data-column="${column.id}" style="min-height: 400px;">
                                ${kanbanData.cards.filter(c => c.columnId === column.id).map(card => `
                                    <div class="kanban-card" draggable="true" data-card-id="${card.id}" style="background: var(--black-dark); border: 1px solid var(--gray-border); border-radius: 8px; padding: 16px; margin-bottom: 12px; cursor: ${canEdit ? 'pointer' : 'default'}; transition: all 0.3s ease;" 
                                         onmouseenter="this.style.borderColor='var(--gray-text)'; this.style.transform='translateY(-2px)';" 
                                         onmouseleave="this.style.borderColor='var(--gray-border)'; this.style.transform='translateY(0)';"
                                         ondragstart="handleDragStart(event)" 
                                         ondragend="handleDragEnd(event)"
                                         onclick="${canEdit ? `openEditCard(${card.id})` : ''}">
                                        ${card.priority ? `
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <span class="badge ${card.priority === 'high' ? 'badge-danger' : card.priority === 'medium' ? 'badge-warning' : 'badge-info'}" style="font-size: 10px;">
                                                ${card.priority === 'high' ? 'Alta' : card.priority === 'medium' ? 'Média' : 'Baixa'}
                                            </span>
                                            ${canDelete ? `
                                            <button onclick="event.stopPropagation(); deleteCard(${card.id})" style="background: transparent; border: none; color: var(--gray-text); cursor: pointer; padding: 4px; font-size: 12px;" title="Excluir">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            ` : ''}
                                        </div>
                                        ` : canDelete ? `
                                        <div style="display: flex; justify-content: flex-end; margin-bottom: 8px;">
                                            <button onclick="event.stopPropagation(); deleteCard(${card.id})" style="background: transparent; border: none; color: var(--gray-text); cursor: pointer; padding: 4px; font-size: 12px;" title="Excluir">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        ` : ''}
                                        <h4 style="color: var(--white-soft); font-size: 14px; font-weight: 600; margin-bottom: 8px;">${card.title}</h4>
                                        ${card.description ? `
                                        <p style="color: var(--gray-light); font-size: 12px; margin-bottom: 12px; line-height: 1.4;">${card.description.substring(0, 100)}${card.description.length > 100 ? '...' : ''}</p>
                                        ` : ''}
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--gray-border);">
                                            ${card.assignee ? `
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <div style="width: 24px; height: 24px; border-radius: 50%; background: ${column.color}; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: 600;">
                                                    ${card.assignee.charAt(0).toUpperCase()}
                                                </div>
                                                <span style="color: var(--gray-light); font-size: 11px;">${card.assignee}</span>
                                            </div>
                                            ` : '<div></div>'}
                                            ${card.dueDate ? `
                                            <span style="color: var(--gray-text); font-size: 11px;">
                                                <i class="fas fa-calendar"></i> ${new Date(card.dueDate).toLocaleDateString('pt-BR')}
                                            </span>
                                            ` : ''}
                                        </div>
                                        ${card.tags && card.tags.length > 0 ? `
                                        <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px;">
                                            ${card.tags.map(tag => `
                                                <span style="background: var(--gray-medium); color: var(--gray-light); padding: 2px 8px; border-radius: 4px; font-size: 10px;">${tag}</span>
                                            `).join('')}
                                        </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            ${canCreate ? `
                            <button onclick="addCardToColumn('${column.id}')" style="width: 100%; padding: 12px; background: transparent; border: 2px dashed var(--gray-border); border-radius: 8px; color: var(--gray-text); cursor: pointer; margin-top: 12px; transition: all 0.3s ease;"
                                    onmouseenter="this.style.borderColor='var(--gray-text)'; this.style.color='var(--white-soft)';"
                                    onmouseleave="this.style.borderColor='var(--gray-border)'; this.style.color='var(--gray-text)';">
                                <i class="fas fa-plus"></i> Adicionar Card
                            </button>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            document.querySelector('.content-card').innerHTML = content;
            initializeKanbanDragDrop();
        }

        function loadStaffControl() {
            const content = `
                <h1 id="sectionTitle">Controle de Staff</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Gestão de membros da equipe</p>
                
                ${hasPermission('staff.create') ? `
                <div style="margin-bottom: 20px;">
                    <button class="btn-modal" onclick="openNewStaff()">
                        <i class="fas fa-user-plus"></i> Adicionar Membro
                    </button>
                </div>
                ` : ''}
                
                <div class="table-container" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--gray-dark);">
                                <th style="padding: 12px; text-align: left; color: var(--gray-light); font-size: 13px; font-weight: 600;">Nome</th>
                                <th style="padding: 12px; text-align: left; color: var(--gray-light); font-size: 13px; font-weight: 600;">Cargo</th>
                                <th style="padding: 12px; text-align: left; color: var(--gray-light); font-size: 13px; font-weight: 600;">Área</th>
                                <th style="padding: 12px; text-align: left; color: var(--gray-light); font-size: 13px; font-weight: 600;">Status</th>
                                <th style="padding: 12px; text-align: left; color: var(--gray-light); font-size: 13px; font-weight: 600;">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${staffData.map(member => `
                                <tr style="border-top: 1px solid var(--gray-border);">
                                    <td style="padding: 12px; color: var(--white-soft);">${member.name}</td>
                                    <td style="padding: 12px; color: var(--gray-light);">${member.role}</td>
                                    <td style="padding: 12px; color: var(--gray-light);">${member.area}</td>
                                    <td style="padding: 12px;">
                                        <span class="badge badge-success">${member.status}</span>
                                    </td>
                                    <td style="padding: 12px;">
                                        <div style="display: flex; gap: 8px;">
                                            <button class="btn-modal" style="padding: 6px 12px; font-size: 12px;" onclick="editStaff(${member.id})" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            ${hasPermission('staff.delete') ? `
                                            <button class="btn-modal btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteStaff(${member.id})" title="Excluir">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            ` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.querySelector('.content-card').innerHTML = content;
        }

        function loadCommands() {
            const content = `
                <h1 id="sectionTitle">Comandos</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Gestão de comandos do sistema</p>
                <p style="color: var(--gray-text);">Funcionalidade em desenvolvimento...</p>
            `;
            document.querySelector('.content-card').innerHTML = content;
        }

        function loadAgenda() {
            const canCreate = hasPermission('event.create');
            const canEdit = hasPermission('event.edit');
            const canDelete = hasPermission('event.delete');
            
            const content = `
                <h1 id="sectionTitle">Agenda da Equipe</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Eventos e reuniões</p>
                ${canCreate ? `
                <div style="margin-bottom: 20px;">
                    <button class="btn-modal btn-success" onclick="openNewEvent()">
                        <i class="fas fa-calendar-plus"></i> Novo Evento
                    </button>
                </div>
                ` : ''}
                ${eventsData.length === 0 ? `
                <p style="color: var(--gray-text);">Nenhum evento agendado.</p>
                ` : `
                <div style="display: grid; gap: 16px;">
                    ${eventsData.map(event => `
                        <div style="padding: 20px; background: var(--gray-dark); border-radius: 12px; border: 1px solid var(--gray-border);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div>
                                    <h3 style="color: var(--white-soft); margin-bottom: 8px;">${event.title}</h3>
                                    <div style="display: flex; gap: 16px; font-size: 14px; color: var(--gray-light);">
                                        <span><i class="fas fa-calendar"></i> ${new Date(event.datetime).toLocaleString('pt-BR')}</span>
                                        <span><i class="fas fa-tag"></i> ${event.type}</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    ${canEdit ? `
                                    <button class="btn-modal" style="padding: 6px 12px; font-size: 12px;" onclick="openEditEvent(${event.id})" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    ` : ''}
                                    ${canDelete ? `
                                    <button class="btn-modal btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteEvent(${event.id})" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                            ${event.description ? `<p style="color: var(--gray-light); margin-top: 12px;">${event.description}</p>` : ''}
                        </div>
                    `).join('')}
                </div>
                `}
            `;
            document.querySelector('.content-card').innerHTML = content;
        }

        function loadForms() {
            const content = `
                <h1 id="sectionTitle">Formulários Recebidos</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Formulários pendentes de análise</p>
                <p style="color: var(--gray-text);">Nenhum formulário pendente.</p>
            `;
            document.querySelector('.content-card').innerHTML = content;
        }

        function loadReports() {
            const content = `
                <h1 id="sectionTitle">Relatórios de Reunião</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Histórico de relatórios</p>
                <p style="color: var(--gray-text);">Nenhum relatório disponível.</p>
            `;
            document.querySelector('.content-card').innerHTML = content;
        }

        function loadWarnings() {
            const content = `
                <h1 id="sectionTitle">Gestão de Advertências</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Sistema de advertências</p>
                <p style="color: var(--gray-text);">Funcionalidade em desenvolvimento...</p>
            `;
            document.querySelector('.content-card').innerHTML = content;
        }

        function loadAreas() {
            const content = `
                <h1 id="sectionTitle">Áreas de Responsabilidade</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Gestão de áreas</p>
                <p style="color: var(--gray-text);">Funcionalidade em desenvolvimento...</p>
            `;
            document.querySelector('.content-card').innerHTML = content;
        }

        function loadSettings() {
            if (!hasPermission('system.config')) {
                const content = `
                    <h1 id="sectionTitle">Configurações do Sistema</h1>
                    <p style="color: var(--gray-light); margin-bottom: 24px;">Acesso negado</p>
                    <div style="padding: 20px; background: var(--gray-dark); border-radius: 12px; border: 1px solid var(--gray-border);">
                        <p style="color: var(--danger); margin-bottom: 12px;">
                            <i class="fas fa-lock"></i> Você não tem permissão para acessar as configurações do sistema.
                        </p>
                        <p style="color: var(--gray-light); font-size: 14px;">
                            Apenas cargos com permissão de administração podem acessar esta seção.
                        </p>
                    </div>
                `;
                document.querySelector('.content-card').innerHTML = content;
                return;
            }

            const content = `
                <h1 id="sectionTitle">Configurações do Sistema</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Gerenciamento de permissões e configurações</p>
                
                ${hasPermission('permission.view') ? `
                <div style="margin-bottom: 32px;">
                    <h2 style="color: var(--white-soft); margin-bottom: 16px; font-size: 18px;">
                        <i class="fas fa-shield-alt"></i> Sistema de Permissões
                    </h2>
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        <p style="color: var(--gray-light); margin-bottom: 16px;">
                            Visualize as permissões de cada cargo no sistema. Apenas Owner e CEO podem gerenciar permissões.
                        </p>
                        <div style="display: grid; gap: 16px;">
                            ${Object.keys(ROLE_PERMISSIONS).map(role => {
                                const roleData = ROLE_PERMISSIONS[role];
                                const permissions = roleData.permissions;
                                const hasAll = permissions.includes('all');
                                
                                return `
                                    <div style="background: var(--black-dark); border-radius: 8px; padding: 16px; border: 1px solid var(--gray-border);">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                            <div>
                                                <h3 style="color: var(--white-soft); font-size: 16px; font-weight: 600; margin-bottom: 4px;">
                                                    ${role}
                                                </h3>
                                                <p style="color: var(--gray-text); font-size: 12px;">${roleData.description}</p>
                                            </div>
                                            <span style="background: ${hasAll ? 'var(--success)' : 'var(--gray-medium)'}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                                ${hasAll ? 'Acesso Total' : `${permissions.length} permissões`}
                                            </span>
                                        </div>
                                        ${hasAll ? `
                                        <p style="color: var(--success); font-size: 12px; padding: 8px; background: rgba(0, 255, 136, 0.1); border-radius: 6px;">
                                            <i class="fas fa-check-circle"></i> Possui acesso total ao sistema
                                        </p>
                                        ` : `
                                        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                                            ${permissions.slice(0, 10).map(perm => `
                                                <span style="background: var(--gray-medium); color: var(--gray-light); padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                                    ${ALL_PERMISSIONS[perm] || perm}
                                                </span>
                                            `).join('')}
                                            ${permissions.length > 10 ? `
                                                <span style="background: var(--gray-medium); color: var(--gray-light); padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                                    +${permissions.length - 10} mais
                                                </span>
                                            ` : ''}
                                        </div>
                                        `}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
                ` : ''}
                
                <div style="margin-bottom: 32px;">
                    <h2 style="color: var(--white-soft); margin-bottom: 16px; font-size: 18px;">
                        <i class="fas fa-user-shield"></i> Suas Permissões Atuais
                    </h2>
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        <div style="margin-bottom: 16px;">
                            <p style="color: var(--white-soft); font-weight: 600; margin-bottom: 4px;">Cargo: ${currentUser.role}</p>
                            <p style="color: var(--gray-light); font-size: 14px;">${getRoleDescription(currentUser.role)}</p>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 12px;">
                            ${getCurrentUserPermissions().map(perm => `
                                <div style="background: var(--black-dark); padding: 10px; border-radius: 6px; border-left: 3px solid var(--success);">
                                    <p style="color: var(--white-soft); font-size: 13px; margin: 0;">
                                        <i class="fas fa-check-circle" style="color: var(--success); margin-right: 6px;"></i>
                                        ${ALL_PERMISSIONS[perm] || perm}
                                    </p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                ${hasPermission('system.sync') ? `
                <div style="margin-bottom: 32px;">
                    <h2 style="color: var(--white-soft); margin-bottom: 16px; font-size: 18px;">
                        <i class="fas fa-cog"></i> Ações do Sistema
                    </h2>
                    <div style="background: var(--gray-dark); border-radius: 12px; padding: 20px; border: 1px solid var(--gray-border);">
                        <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                            <button class="btn-modal" onclick="syncSystem()">
                                <i class="fas fa-sync"></i> Sincronizar Sistema
                            </button>
                            ${hasPermission('system.backup') ? `
                            <button class="btn-modal" onclick="alert('Funcionalidade de backup será implementada em breve.')">
                                <i class="fas fa-database"></i> Fazer Backup
                            </button>
                            ` : ''}
                            ${hasPermission('system.logs') ? `
                            <button class="btn-modal" onclick="alert('Visualização de logs será implementada em breve.')">
                                <i class="fas fa-file-alt"></i> Ver Logs
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
            document.querySelector('.content-card').innerHTML = content;
        }

        // ========== FUNÇÕES DE MODAIS ==========
        function openNewEvent() {
            if (!hasPermission('event.create')) {
                alert('Você não tem permissão para criar eventos.');
                return;
            }
            document.getElementById('eventId').value = '';
            document.getElementById('eventModalTitle').textContent = 'Novo Evento';
            document.getElementById('eventForm').reset();
            document.getElementById('eventModal').classList.add('active');
        }

        function openEditEvent(id) {
            if (!hasPermission('event.edit')) {
                alert('Você não tem permissão para editar eventos.');
                return;
            }
            const event = eventsData.find(e => e.id === id);
            if (event) {
                document.getElementById('eventId').value = event.id;
                document.getElementById('eventModalTitle').textContent = 'Editar Evento';
                document.getElementById('eventType').value = event.type;
                document.getElementById('eventTitle').value = event.title;
                document.getElementById('eventDateTime').value = event.datetime;
                document.getElementById('eventDescription').value = event.description || '';
                document.getElementById('eventModal').classList.add('active');
            }
        }

        function saveEvent(event) {
            event.preventDefault();
            if (!hasPermission('event.create') && !hasPermission('event.edit')) {
                alert('Você não tem permissão para esta ação.');
                return;
            }

            const eventData = {
                id: document.getElementById('eventId').value || Date.now(),
                type: document.getElementById('eventType').value,
                title: document.getElementById('eventTitle').value,
                datetime: document.getElementById('eventDateTime').value,
                description: document.getElementById('eventDescription').value,
                createdAt: new Date().toISOString()
            };

            if (eventData.id && eventsData.find(e => e.id == eventData.id)) {
                // Editar
                const index = eventsData.findIndex(e => e.id == eventData.id);
                eventsData[index] = eventData;
            } else {
                // Novo
                eventsData.push(eventData);
            }

            saveData('txd_events', eventsData);
            closeModal('eventModal');
            loadAgenda();
            if (document.getElementById('sectionTitle').textContent === 'Dashboard') {
                loadDashboard();
            }
            alert('Evento salvo com sucesso!');
        }

        function openAnnouncement() {
            if (!hasPermission('announcement.create')) {
                alert('Você não tem permissão para enviar avisos.');
                return;
            }
            document.getElementById('announcementForm').reset();
            document.getElementById('announcementModal').classList.add('active');
        }

        function saveAnnouncement(event) {
            event.preventDefault();
            if (!hasPermission('announcement.create')) {
                alert('Você não tem permissão para esta ação.');
                return;
            }

            const announcement = {
                id: Date.now(),
                title: document.getElementById('announcementTitle').value,
                priority: document.getElementById('announcementPriority').value,
                message: document.getElementById('announcementMessage').value,
                author: currentUser.name,
                createdAt: new Date().toISOString()
            };

            announcementsData.push(announcement);
            saveData('txd_announcements', announcementsData);
            closeModal('announcementModal');
            alert('Aviso enviado com sucesso!');
        }

        function openNewStaff() {
            if (!hasPermission('staff.create')) {
                alert('Você não tem permissão para adicionar membros.');
                return;
            }
            document.getElementById('staffId').value = '';
            document.getElementById('staffModalTitle').textContent = 'Adicionar Membro';
            document.getElementById('staffForm').reset();
            document.getElementById('staffModal').classList.add('active');
        }

        function editStaff(id) {
            if (!hasPermission('staff.edit')) {
                alert('Você não tem permissão para editar membros.');
                return;
            }
            const member = staffData.find(s => s.id === id);
            if (member) {
                document.getElementById('staffId').value = member.id;
                document.getElementById('staffModalTitle').textContent = 'Editar Membro';
                document.getElementById('staffName').value = member.name;
                document.getElementById('staffRole').value = member.role;
                document.getElementById('staffArea').value = member.area;
                document.getElementById('staffStatus').value = member.status;
                document.getElementById('staffEmail').value = member.email || '';
                document.getElementById('staffModal').classList.add('active');
            }
        }

        function saveStaff(event) {
            event.preventDefault();
            const isEdit = document.getElementById('staffId').value;
            
            if (isEdit && !hasPermission('staff.edit')) {
                alert('Você não tem permissão para editar membros.');
                return;
            }
            if (!isEdit && !hasPermission('staff.create')) {
                alert('Você não tem permissão para adicionar membros.');
                return;
            }

            const staffMember = {
                id: isEdit ? parseInt(isEdit) : Date.now(),
                name: document.getElementById('staffName').value,
                role: document.getElementById('staffRole').value,
                area: document.getElementById('staffArea').value,
                status: document.getElementById('staffStatus').value,
                email: document.getElementById('staffEmail').value
            };

            if (isEdit) {
                const index = staffData.findIndex(s => s.id === staffMember.id);
                if (index !== -1) {
                    staffData[index] = staffMember;
                }
            } else {
                staffData.push(staffMember);
            }

            saveData('txd_staff', staffData);
            closeModal('staffModal');
            loadStaffControl();
            if (document.getElementById('sectionTitle').textContent === 'Dashboard') {
                loadDashboard();
            }
            alert('Membro salvo com sucesso!');
        }

        let deleteItemId = null;
        let deleteItemType = null;

        function deleteStaff(id) {
            if (!hasPermission('staff.delete')) {
                alert('Você não tem permissão para excluir membros.');
                return;
            }
            const member = staffData.find(s => s.id === id);
            if (member) {
                deleteItemId = id;
                deleteItemType = 'staff';
                document.getElementById('deleteMessage').textContent = `Tem certeza que deseja excluir ${member.name}? Esta ação não pode ser desfeita.`;
                document.getElementById('deleteModal').classList.add('active');
            }
        }

        function deleteEvent(id) {
            if (!hasPermission('event.delete')) {
                alert('Você não tem permissão para excluir eventos.');
                return;
            }
            const event = eventsData.find(e => e.id === id);
            if (event) {
                deleteItemId = id;
                deleteItemType = 'event';
                document.getElementById('deleteMessage').textContent = `Tem certeza que deseja excluir o evento "${event.title}"? Esta ação não pode ser desfeita.`;
                document.getElementById('deleteModal').classList.add('active');
            }
        }

        function confirmDelete() {
            if (deleteItemType === 'staff') {
                staffData = staffData.filter(s => s.id !== deleteItemId);
                saveData('txd_staff', staffData);
                loadStaffControl();
            } else if (deleteItemType === 'event') {
                eventsData = eventsData.filter(e => e.id !== deleteItemId);
                saveData('txd_events', eventsData);
                loadAgenda();
            }
            closeModal('deleteModal');
            deleteItemId = null;
            deleteItemType = null;
            alert('Item excluído com sucesso!');
        }

        function openAssignFunctions() {
            alert('Funcionalidade de atribuir funções será implementada em breve.');
        }

        function syncSystem() {
            if (!hasPermission('all')) {
                alert('Apenas administradores podem sincronizar o sistema.');
                return;
            }
            if (confirm('Deseja sincronizar o sistema agora?')) {
                // Simular sincronização
                setTimeout(() => {
                    alert('Sistema sincronizado com sucesso!');
                }, 1000);
            }
        }

        // ========== SISTEMA KANBAN ==========
        let draggedCard = null;
        let draggedCardElement = null;

        function getKanbanData() {
            let data = getData('txd_kanban');
            
            // Garantir estrutura correta
            if (!data || !data.columns || !data.cards) {
                data = {
                    columns: [
                        { id: 'todo', name: 'Para Fazer', color: '#6F7276' },
                        { id: 'inprogress', name: 'Em Progresso', color: '#ffaa00' },
                        { id: 'review', name: 'Em Revisão', color: '#3b82f6' },
                        { id: 'done', name: 'Concluído', color: '#00ff88' }
                    ],
                    cards: []
                };
            }
            
            // Garantir que cards é sempre um array
            if (!Array.isArray(data.cards)) {
                data.cards = [];
            }
            
            // Garantir que columns é sempre um array
            if (!Array.isArray(data.columns)) {
                data.columns = [
                    { id: 'todo', name: 'Para Fazer', color: '#6F7276' },
                    { id: 'inprogress', name: 'Em Progresso', color: '#ffaa00' },
                    { id: 'review', name: 'Em Revisão', color: '#3b82f6' },
                    { id: 'done', name: 'Concluído', color: '#00ff88' }
                ];
            }
            
            return data;
        }

        function saveKanbanData(data) {
            saveData('txd_kanban', data);
        }

        function openNewCard(columnId = null) {
            if (!hasPermission('task.create')) {
                alert('Você não tem permissão para criar tarefas.');
                return;
            }
            document.getElementById('cardId').value = '';
            document.getElementById('cardModalTitle').textContent = 'Nova Tarefa';
            document.getElementById('cardColumnId').value = columnId || 'todo';
            document.getElementById('cardForm').reset();
            // Atualizar lista de responsáveis
            refreshData();
            const assigneeSelect = document.getElementById('cardAssignee');
            if (assigneeSelect) {
                assigneeSelect.innerHTML = '<option value="">Sem responsável</option>' + 
                    staffData.map(m => `<option value="${m.name}">${m.name} (${m.role})</option>`).join('');
            }
            document.getElementById('cardModal').classList.add('active');
        }

        function addCardToColumn(columnId) {
            openNewCard(columnId);
        }

        function openEditCard(cardId) {
            if (!hasPermission('task.edit')) {
                alert('Você não tem permissão para editar tarefas. Apenas Owner, CEO, COO, Diretor e Head Staff podem editar.');
                return;
            }
            const kanbanData = getKanbanData();
            const card = kanbanData.cards.find(c => c.id == cardId);
            if (card) {
                document.getElementById('cardId').value = card.id;
                document.getElementById('cardModalTitle').textContent = 'Editar Tarefa';
                document.getElementById('cardColumnId').value = card.columnId;
                document.getElementById('cardTitle').value = card.title;
                document.getElementById('cardDescription').value = card.description || '';
                document.getElementById('cardPriority').value = card.priority || '';
                document.getElementById('cardDueDate').value = card.dueDate || '';
                document.getElementById('cardAssignee').value = card.assignee || '';
                document.getElementById('cardTags').value = card.tags ? card.tags.join(', ') : '';
                // Atualizar lista de responsáveis
                refreshData();
                const assigneeSelect = document.getElementById('cardAssignee');
                if (assigneeSelect) {
                    assigneeSelect.innerHTML = '<option value="">Sem responsável</option>' + 
                        staffData.map(m => `<option value="${m.name}">${m.name} (${m.role})</option>`).join('');
                    assigneeSelect.value = card.assignee || '';
                }
                document.getElementById('cardModal').classList.add('active');
            }
        }

        function saveCard(event) {
            event.preventDefault();
            
            const cardId = document.getElementById('cardId').value;
            const isEdit = cardId && cardId !== '';
            
            // Verificar permissões
            if (isEdit && !hasPermission('task.edit')) {
                alert('Você não tem permissão para editar tarefas. Apenas Owner, CEO, COO, Diretor e Head Staff podem editar.');
                return;
            }
            if (!isEdit && !hasPermission('task.create')) {
                alert('Você não tem permissão para criar tarefas.');
                return;
            }
            
            let kanbanData = getKanbanData();
            
            // Garantir que cards é um array
            if (!Array.isArray(kanbanData.cards)) {
                kanbanData.cards = [];
            }
            
            const cardData = {
                id: parseInt(cardId) || Date.now(),
                columnId: document.getElementById('cardColumnId').value,
                title: document.getElementById('cardTitle').value,
                description: document.getElementById('cardDescription').value,
                priority: document.getElementById('cardPriority').value,
                dueDate: document.getElementById('cardDueDate').value,
                assignee: document.getElementById('cardAssignee').value,
                tags: document.getElementById('cardTags').value.split(',').map(t => t.trim()).filter(t => t),
                createdAt: isEdit ? (kanbanData.cards.find(c => c.id == cardId)?.createdAt || new Date().toISOString()) : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            const existingIndex = kanbanData.cards.findIndex(c => c.id == cardData.id);
            if (existingIndex !== -1) {
                kanbanData.cards[existingIndex] = { ...kanbanData.cards[existingIndex], ...cardData };
            } else {
                kanbanData.cards.push(cardData);
            }

            saveKanbanData(kanbanData);
            closeModal('cardModal');
            loadKanban();
            alert('Tarefa salva com sucesso!');
        }

        function deleteCard(cardId) {
            if (!hasPermission('task.delete')) {
                alert('Você não tem permissão para excluir tarefas. Apenas Owner, CEO, COO, Diretor e Head Staff podem excluir.');
                return;
            }
            if (!confirm('Tem certeza que deseja excluir esta tarefa?')) return;
            
            let kanbanData = getKanbanData();
            // Garantir que cards é um array
            if (!Array.isArray(kanbanData.cards)) {
                kanbanData.cards = [];
            }
            kanbanData.cards = kanbanData.cards.filter(c => c.id !== cardId);
            saveKanbanData(kanbanData);
            loadKanban();
            alert('Tarefa excluída com sucesso!');
        }

        // Drag and Drop
        function handleDragStart(event) {
            draggedCard = event.target;
            draggedCardElement = event.target;
            event.target.style.opacity = '0.5';
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.outerHTML);
        }

        function handleDragEnd(event) {
            event.target.style.opacity = '1';
            event.target.classList.remove('dragging');
        }

        function initializeKanbanDragDrop() {
            const columns = document.querySelectorAll('.kanban-cards');
            columns.forEach(column => {
                column.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    column.classList.add('drag-over');
                    
                    const afterElement = getDragAfterElement(column, e.clientY);
                    const dragging = document.querySelector('.kanban-card.dragging');
                    if (dragging) {
                        if (afterElement == null) {
                            column.appendChild(dragging);
                        } else {
                            column.insertBefore(dragging, afterElement);
                        }
                    }
                });

                column.addEventListener('dragleave', () => {
                    column.classList.remove('drag-over');
                });

                column.addEventListener('drop', (e) => {
                    e.preventDefault();
                    column.classList.remove('drag-over');
                    
                    if (draggedCard) {
                        const cardId = parseInt(draggedCard.getAttribute('data-card-id'));
                        const newColumnId = column.getAttribute('data-column');
                        
                        const kanbanData = getKanbanData();
                        const card = kanbanData.cards.find(c => c.id === cardId);
                        if (card) {
                            card.columnId = newColumnId;
                            card.updatedAt = new Date().toISOString();
                            saveKanbanData(kanbanData);
                            loadKanban();
                        }
                        
                        draggedCard = null;
                        draggedCardElement = null;
                    }
                });
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.kanban-card:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // Fechar modal com ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });

        // Carregar dados do localStorage ao iniciar
        function refreshData() {
            staffData = getData('txd_staff') || staffData;
            eventsData = getData('txd_events') || [];
            announcementsData = getData('txd_announcements') || [];
            ticketsData = getData('txd_tickets') || ticketsData;
        }

        // Atualizar showSection para carregar conteúdo
        const originalShowSectionFunc = showSection;
        showSection = function(section) {
            if (originalShowSectionFunc) originalShowSectionFunc(section);
            refreshData();
            loadSectionContent(section);
        };

        // Inicializar
        refreshData();
        if (document.getElementById('dashboard').classList.contains('active')) {
            loadDashboard();
        } else {
            // Carregar conteúdo inicial se não estiver no dashboard
            const content = `
                <h1 id="sectionTitle">Bem-vindo ao Painel TXD Staff</h1>
                <p style="color: var(--gray-light); margin-bottom: 24px;">Selecione uma opção no menu para começar.</p>
            `;
            document.getElementById('mainContent').innerHTML = content;
        }
    </script>

</body>
</html>
